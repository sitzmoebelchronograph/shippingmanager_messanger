<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>server/websocket.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Dark theme matching app style - carefully scoped to not break layout */
        html, body {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
            overflow-x: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Custom scrollbar styling for all browsers */
        * {
            scrollbar-width: thin !important;
            scrollbar-color: #404040 #1a1a1a !important;
        }

        /* Webkit browsers (Chrome, Safari, Edge) */
        *::-webkit-scrollbar {
            width: 6px !important;
            height: 6px !important;
        }

        *::-webkit-scrollbar-track {
            background: #1a1a1a !important;
        }

        *::-webkit-scrollbar-thumb {
            background-color: #404040 !important;
            border-radius: 3px !important;
        }

        *::-webkit-scrollbar-thumb:hover {
            background-color: #505050 !important;
        }

        /* Navigation sidebar - remove padding and white borders */
        nav {
            background-color: #242424 !important;
            border-right: 1px solid #404040 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow-x: hidden !important;
        }
        nav h2, nav h3 {
            color: #e0e0e0 !important;
            border-bottom: 1px solid #404040 !important;
            padding: 10px 15px !important;
            margin: 0 !important;
            background-color: #242424 !important;
            font-size: 14px !important;
            font-weight: 600 !important;
        }
        nav h3 {
            font-size: 13px !important;
        }
        nav ul {
            padding: 0 !important;
            margin: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li {
            list-style: none !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li a {
            color: #c9d1d9 !important;
            display: block !important;
            padding: 8px 15px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            background-color: #242424 !important;
            margin: 0 !important;
            border: none !important;
            font-size: 14px !important;
        }
        nav ul li a:hover {
            color: #60a5fa !important;
            background-color: rgba(96, 165, 250, 0.1) !important;
        }
        /* Module links (direct children of nav > ul > li) */
        nav > ul > li > a {
            color: #60a5fa !important;
            font-weight: 600 !important;
            padding: 10px 15px !important;
            font-size: 14px !important;
            border-left: 3px solid #60a5fa !important;
            padding-left: 12px !important;
        }
        nav > ul > li > a:hover {
            background-color: rgba(96, 165, 250, 0.15) !important;
        }
        /* Sub-items (methods/functions) indented */
        nav ul.methods {
            padding-left: 15px !important;
        }
        nav ul.methods li a {
            color: #9ca3af !important;
            font-size: 13px !important;
            padding: 6px 15px !important;
            font-weight: 400 !important;
        }
        nav ul.methods li a:hover {
            color: #c9d1d9 !important;
        }
        nav > h2:first-child {
            font-size: 16px !important;
            font-weight: 700 !important;
            padding: 12px 15px !important;
        }

        /* Main content area - dark background */
        #main {
            background-color: #1a1a1a !important;
            padding: 20px !important;
        }

        /* Article and sections - ensure dark background */
        article, section, .container-overview, .description {
            background-color: #1a1a1a !important;
        }

        /* Images - style demo images */
        img {
            max-width: 100% !important;
            height: auto !important;
            border: 1px solid #404040 !important;
            border-radius: 8px !important;
            margin: 20px 0 !important;
        }

        /* Links */
        a {
            color: #60a5fa !important;
            text-decoration: none !important;
        }
        a:hover {
            color: #93c5fd !important;
            text-decoration: underline !important;
        }

        /* Headings */
        h1, h2, h3, h4, h5, h6 {
            color: #e0e0e0 !important;
            border-bottom-color: #404040 !important;
            background-color: transparent !important;
        }
        h4.name {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
        }

        /* Code blocks */
        pre {
            background-color: #0d1117 !important;
            border: 1px solid #404040 !important;
        }
        pre code {
            background-color: transparent !important;
        }
        code {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
        }

        /* Tables */
        table {
            border-color: #404040 !important;
            background-color: #1a1a1a !important;
        }
        table thead tr {
            background-color: #242424 !important;
        }
        table tbody tr {
            background-color: #1a1a1a !important;
        }
        table tbody tr:nth-child(even) {
            background-color: #1f1f1f !important;
        }
        table td, table th {
            border-color: #404040 !important;
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }
        .params .name, .props .name {
            color: #10b981 !important;
            font-family: 'Courier New', monospace !important;
        }

        /* Descriptions and details */
        .description, .details, dt, dd, p, ul, ol, dl {
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }

        /* Types */
        .type-signature {
            color: #a78bfa !important;
        }

        /* Source links */
        .details .details-item-container {
            border-left-color: #404040 !important;
        }

        /* Breadcrumbs */
        .page-title {
            color: #e0e0e0 !important;
        }

        /* Search */
        #nav-search {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
            color: #e0e0e0 !important;
        }

        /* Mobile nav trigger */
        .navicon-button {
            background-color: #2a2a2a !important;
        }

        /* Footer */
        footer {
            background-color: #1a1a1a !important;
            color: #9ca3af !important;
            border-top: 1px solid #404040 !important;
            text-align: center !important;
            padding: 20px !important;
        }

        /* Remove horizontal scrollbar and white borders */
        * {
            box-sizing: border-box !important;
        }
    </style>
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">README</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-build-guide.html">Build Guide</a></li><li><a href="tutorial-installation-guide.html">Installation Guide</a></li></ul><h3>Classes</h3><ul><li><a href="module-server_chatbot-ChatBot.html">ChatBot</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot-ChatBot.html#executeCommand">executeCommand</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#findCustomCommand">findCustomCommand</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#generateForecastText">generateForecastText</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#getDefaultChatBotObject">getDefaultChatBotObject</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#handleForecastCommand">handleForecastCommand</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#handleHelpCommand">handleHelpCommand</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#initialize">initialize</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#isCommandAllowedInChannel">isCommandAllowedInChannel</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#isOnCooldown">isOnCooldown</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#mapChatBotObjectToFlatSettings">mapChatBotObjectToFlatSettings</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#mapSettingsToChatBotObject">mapSettingsToChatBotObject</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#processAllianceMessage">processAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#processPrivateMessage">processPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#resolveCommandName">resolveCommandName</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#scheduleDailyForecast">scheduleDailyForecast</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#sendAllianceMessage">sendAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#sendDailyForecast">sendDailyForecast</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#sendErrorMessage">sendErrorMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#sendPrivateMessage">sendPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#sendResponse">sendResponse</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#setupScheduledTasks">setupScheduledTasks</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#updateCooldown">updateCooldown</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#updateSettings">updateSettings</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#validateCommandArguments">validateCommandArguments</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#validateForecastArguments">validateForecastArguments</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-api.html">api</a><ul class='methods'><li data-type='method'><a href="module-api.html#.activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-api.html#.deleteAllLogs">deleteAllLogs</a></li><li data-type='method'><a href="module-api.html#.deleteChat">deleteChat</a></li><li data-type='method'><a href="module-api.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-api.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-api.html#.departVessels">departVessels</a></li><li data-type='method'><a href="module-api.html#.doWearMaintenanceBulk">doWearMaintenanceBulk</a></li><li data-type='method'><a href="module-api.html#.downloadLogbookExport">downloadLogbookExport</a></li><li data-type='method'><a href="module-api.html#.fetchAcquirableVessels">fetchAcquirableVessels</a></li><li data-type='method'><a href="module-api.html#.fetchAllianceMembers">fetchAllianceMembers</a></li><li data-type='method'><a href="module-api.html#.fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-api.html#.fetchBunkerPrices">fetchBunkerPrices</a></li><li data-type='method'><a href="module-api.html#.fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-api.html#.fetchChat">fetchChat</a></li><li data-type='method'><a href="module-api.html#.fetchContacts">fetchContacts</a></li><li data-type='method'><a href="module-api.html#.fetchLogbookEntries">fetchLogbookEntries</a></li><li data-type='method'><a href="module-api.html#.fetchLogbookFileSize">fetchLogbookFileSize</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerChats">fetchMessengerChats</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerMessages">fetchMessengerMessages</a></li><li data-type='method'><a href="module-api.html#.fetchUserCompany">fetchUserCompany</a></li><li data-type='method'><a href="module-api.html#.fetchUserSettings">fetchUserSettings</a></li><li data-type='method'><a href="module-api.html#.fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-api.html#.getCompanyNameCached">getCompanyNameCached</a></li><li data-type='method'><a href="module-api.html#.getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-api.html#.markChatAsRead">markChatAsRead</a></li><li data-type='method'><a href="module-api.html#.purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-api.html#.purchaseFuel">purchaseFuel</a></li><li data-type='method'><a href="module-api.html#.purchaseVessel">purchaseVessel</a></li><li data-type='method'><a href="module-api.html#.searchUsers">searchUsers</a></li><li data-type='method'><a href="module-api.html#.sendChatMessage">sendChatMessage</a></li><li data-type='method'><a href="module-api.html#.sendPrivateMessage">sendPrivateMessage</a></li></ul></li><li><a href="module-app.html">app</a></li><li><a href="module-automation.html">automation</a><ul class='methods'><li data-type='method'><a href="module-automation.html#.initAutomation">initAutomation</a></li><li data-type='method'><a href="module-automation.html#.runAutomationChecks">runAutomationChecks</a></li><li data-type='method'><a href="module-automation.html#.triggerAutoRebuyChecks">triggerAutoRebuyChecks</a></li><li data-type='method'><a href="module-automation.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-automation.html#~checkAutoCampaignRenewal">checkAutoCampaignRenewal</a></li><li data-type='method'><a href="module-automation.html#~checkAutoDepartAll">checkAutoDepartAll</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyCO2">checkAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyFuel">checkAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~getTotalCapacity">getTotalCapacity</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyCO2">performAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyFuel">performAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~sendAutoPilotFeedback">sendAutoPilotFeedback</a></li><li data-type='method'><a href="module-automation.html#~showCenterAlert">showCenterAlert</a></li><li data-type='method'><a href="module-automation.html#~updateAutoDepartLabel">updateAutoDepartLabel</a></li></ul></li><li><a href="module-bunker-management.html">bunker-management</a><ul class='methods'><li data-type='method'><a href="module-bunker-management.html#.buyMaxCO2">buyMaxCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.buyMaxFuel">buyMaxFuel</a></li><li data-type='method'><a href="module-bunker-management.html#.getCurrentBunkerState">getCurrentBunkerState</a></li><li data-type='method'><a href="module-bunker-management.html#.setCapacityFromBunkerUpdate">setCapacityFromBunkerUpdate</a></li><li data-type='method'><a href="module-bunker-management.html#.updateBunkerStatus">updateBunkerStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCampaignsStatus">updateCampaignsStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCO2">updateCurrentCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCash">updateCurrentCash</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentFuel">updateCurrentFuel</a></li><li data-type='method'><a href="module-bunker-management.html#~retryFetchPrices">retryFetchPrices</a></li></ul></li><li><a href="module-chat.html">chat</a><ul class='methods'><li data-type='method'><a href="module-chat.html#.displayMessages">displayMessages</a></li><li data-type='method'><a href="module-chat.html#.handleMessageInput">handleMessageInput</a></li><li data-type='method'><a href="module-chat.html#.initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-chat.html#.loadAllianceMembers">loadAllianceMembers</a></li><li data-type='method'><a href="module-chat.html#.loadMessages">loadMessages</a></li><li data-type='method'><a href="module-chat.html#.parseMessageWithMentions">parseMessageWithMentions</a></li><li data-type='method'><a href="module-chat.html#.sendMessage">sendMessage</a></li><li data-type='method'><a href="module-chat.html#.setChatScrollListener">setChatScrollListener</a></li><li data-type='method'><a href="module-chat.html#~attemptReconnect">attemptReconnect</a></li><li data-type='method'><a href="module-chat.html#~displaySuggestions">displaySuggestions</a></li><li data-type='method'><a href="module-chat.html#~formatLocalTime">formatLocalTime</a></li><li data-type='method'><a href="module-chat.html#~handleAutoCoopComplete">handleAutoCoopComplete</a></li><li data-type='method'><a href="module-chat.html#~handleAutoCoopNoTargets">handleAutoCoopNoTargets</a></li><li data-type='method'><a href="module-chat.html#~handleAutopilotDepartStart">handleAutopilotDepartStart</a></li><li data-type='method'><a href="module-chat.html#~handleBackendAutoRepairComplete">handleBackendAutoRepairComplete</a></li><li data-type='method'><a href="module-chat.html#~handleBunkerUpdate">handleBunkerUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleCO2Purchased">handleCO2Purchased</a></li><li data-type='method'><a href="module-chat.html#~handleCampaignStatusUpdate">handleCampaignStatusUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleCampaignsRenewed">handleCampaignsRenewed</a></li><li data-type='method'><a href="module-chat.html#~handleCompanyTypeUpdate">handleCompanyTypeUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleCoopUpdate">handleCoopUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleFuelPurchased">handleFuelPurchased</a></li><li data-type='method'><a href="module-chat.html#~handleGenericNotification">handleGenericNotification</a></li><li data-type='method'><a href="module-chat.html#~handleHeaderDataUpdate">handleHeaderDataUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleHijackingUpdate">handleHijackingUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleMentionAutocomplete">handleMentionAutocomplete</a></li><li data-type='method'><a href="module-chat.html#~handleMessengerUpdate">handleMessengerUpdate</a></li><li data-type='method'><a href="module-chat.html#~handlePriceAlert">handlePriceAlert</a></li><li data-type='method'><a href="module-chat.html#~handlePriceUpdate">handlePriceUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleRepairCountUpdate">handleRepairCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleUnreadMessagesUpdate">handleUnreadMessagesUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleUserActionNotification">handleUserActionNotification</a></li><li data-type='method'><a href="module-chat.html#~handleVesselCountUpdate">handleVesselCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDepartComplete">handleVesselsDepartComplete</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDeparted">handleVesselsDeparted</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsFailed">handleVesselsFailed</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsRepaired">handleVesselsRepaired</a></li><li data-type='method'><a href="module-chat.html#~hideMemberSuggestions">hideMemberSuggestions</a></li><li data-type='method'><a href="module-chat.html#~insertMention">insertMention</a></li><li data-type='method'><a href="module-chat.html#~registerUsernameClickEvents">registerUsernameClickEvents</a></li><li data-type='method'><a href="module-chat.html#~updateAllianceChatBadge">updateAllianceChatBadge</a></li></ul></li><li><a href="module-coop.html">coop</a><ul class='methods'><li data-type='method'><a href="module-coop.html#.closeCoopOverlay">closeCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.fetchCoopData">fetchCoopData</a></li><li data-type='method'><a href="module-coop.html#.sendCoopMax">sendCoopMax</a></li><li data-type='method'><a href="module-coop.html#.showCoopOverlay">showCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.updateCoopBadge">updateCoopBadge</a></li><li data-type='method'><a href="module-coop.html#~renderMemberCard">renderMemberCard</a></li></ul></li><li><a href="module-desktop-notification-templates.html">desktop-notification-templates</a><ul class='methods'><li data-type='method'><a href="module-desktop-notification-templates.html#.createDesktopNotification">createDesktopNotification</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.getDefaultEmoji">getDefaultEmoji</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.getNotificationTypes">getNotificationTypes</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.isValidNotificationType">isValidNotificationType</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyAlert">notifyAlert</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyError">notifyError</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifySuccess">notifySuccess</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyWarning">notifyWarning</a></li></ul></li><li><a href="module-event-info.html">event-info</a><ul class='methods'><li data-type='method'><a href="module-event-info.html#.initEventInfo">initEventInfo</a></li><li data-type='method'><a href="module-event-info.html#.openEventModal">openEventModal</a></li><li data-type='method'><a href="module-event-info.html#.updateEventData">updateEventData</a></li><li data-type='method'><a href="module-event-info.html#~startEventTimer">startEventTimer</a></li></ul></li><li><a href="module-forecast-calendar.html">forecast-calendar</a><ul class='methods'><li data-type='method'><a href="module-forecast-calendar.html#.initForecastCalendar">initForecastCalendar</a></li><li data-type='method'><a href="module-forecast-calendar.html#.updateEventDiscount">updateEventDiscount</a></li><li data-type='method'><a href="module-forecast-calendar.html#~createTableHTML">createTableHTML</a></li><li data-type='method'><a href="module-forecast-calendar.html#~formatDate">formatDate</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getBrowserTimezone">getBrowserTimezone</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getCo2Class">getCo2Class</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getCurrentVisibleDay">getCurrentVisibleDay</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getFuelClass">getFuelClass</a></li><li data-type='method'><a href="module-forecast-calendar.html#~isEventActiveAtTime">isEventActiveAtTime</a></li><li data-type='method'><a href="module-forecast-calendar.html#~isEventActiveOnDay">isEventActiveOnDay</a></li><li data-type='method'><a href="module-forecast-calendar.html#~loadForecastData">loadForecastData</a></li><li data-type='method'><a href="module-forecast-calendar.html#~preloadMonth">preloadMonth</a></li><li data-type='method'><a href="module-forecast-calendar.html#~renderBook">renderBook</a></li><li data-type='method'><a href="module-forecast-calendar.html#~updateEventBadge">updateEventBadge</a></li></ul></li><li><a href="module-harbor-map-aggregator.html">harbor-map-aggregator</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-aggregator.html#~aggregateReachablePorts">aggregateReachablePorts</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~aggregateVesselData">aggregateVesselData</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~categorizeVesselsByPort">categorizeVesselsByPort</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~extractPortsFromGameIndex">extractPortsFromGameIndex</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~extractVesselsFromGameIndex">extractVesselsFromGameIndex</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~filterAssignedPorts">filterAssignedPorts</a></li></ul></li><li><a href="module-harbor-map-calculator.html">harbor-map-calculator</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateCargoUtilization">calculateCargoUtilization</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateDemandLevel">calculateDemandLevel</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateETA">calculateETA</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateVesselPosition">calculateVesselPosition</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~formatCargoCapacity">formatCargoCapacity</a></li></ul></li><li><a href="module-harbor-map-init.html">harbor-map-init</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-init.html#.closeHarborMap">closeHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.initHarborMap">initHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.openHarborMap">openHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.preloadHarborMapData">preloadHarborMapData</a></li><li data-type='method'><a href="module-harbor-map-init.html#.refreshHarborMapIfOpen">refreshHarborMapIfOpen</a></li><li data-type='method'><a href="module-harbor-map-init.html#.reloadMap">reloadMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.startHarborMapAutoUpdate">startHarborMapAutoUpdate</a></li><li data-type='method'><a href="module-harbor-map-init.html#.stopHarborMapAutoUpdate">stopHarborMapAutoUpdate</a></li><li data-type='method'><a href="module-harbor-map-init.html#~departVesselWrapper">departVesselWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~getVesselByIdWrapper">getVesselByIdWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~selectVesselFromMap">selectVesselFromMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#~sellVesselFromPanelWrapper">sellVesselFromPanelWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~updateVesselMarkerWrapper">updateVesselMarkerWrapper</a></li></ul></li><li><a href="module-harbor-map_api-client.html">harbor-map/api-client</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_api-client.html#.clearHarborMapCache">clearHarborMapCache</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.exportVesselHistory">exportVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchHarborMapOverview">fetchHarborMapOverview</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchPortDetails">fetchPortDetails</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchVesselHistory">fetchVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchVesselReachablePorts">fetchVesselReachablePorts</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.getCachedOverview">getCachedOverview</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.prefetchHarborMapData">prefetchHarborMapData</a></li></ul></li><li><a href="module-harbor-map_map-controller.html">harbor-map/map-controller</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_map-controller.html#.clearRoute">clearRoute</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.deselectAll">deselectAll</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.drawRoute">drawRoute</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getSelectedPortCode">getSelectedPortCode</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getVesselById">getVesselById</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.initMap">initMap</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.loadOverview">loadOverview</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.renderPorts">renderPorts</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.renderVessels">renderVessels</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.selectPort">selectPort</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.selectVessel">selectVessel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.setPortFilter">setPortFilter</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.updateVesselMarker">updateVesselMarker</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.updateWeatherDataSetting">updateWeatherDataSetting</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~addCustomControls">addCustomControls</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~applyMapTheme">applyMapTheme</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~calculateHeading">calculateHeading</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~changeTileLayer">changeTileLayer</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~createVesselIcon">createVesselIcon</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~getVesselType">getVesselType</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~hideRouteVesselsPanel">hideRouteVesselsPanel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~setRouteFilter">setRouteFilter</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~showRouteVesselsPanel">showRouteVesselsPanel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~showWeatherInfo">showWeatherInfo</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~toggleWeatherLayer">toggleWeatherLayer</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~updateRouteDropdown">updateRouteDropdown</a></li></ul></li><li><a href="module-harbor-map_panel-drag.html">harbor-map/panel-drag</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_panel-drag.html#.initializePanelDrag">initializePanelDrag</a></li></ul></li><li><a href="module-harbor-map_port-panel.html">harbor-map/port-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_port-panel.html#.closePortPanel">closePortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.hidePortPanel">hidePortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.selectVesselFromPort">selectVesselFromPort</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.showPortPanel">showPortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#~renderDemandSection">renderDemandSection</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#~renderVesselList">renderVesselList</a></li></ul></li><li><a href="module-harbor-map_route-vessels-panel.html">harbor-map/route-vessels-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.closeRoutePanel">closeRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.hideRoutePanel">hideRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.selectRouteVessel">selectRouteVessel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.showRoutePanel">showRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#~storeVessels">storeVessels</a></li></ul></li><li><a href="module-harbor-map_vessel-panel.html">harbor-map/vessel-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.closeVesselPanel">closeVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.exportHistoryFormat">exportHistoryFormat</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.hideVesselPanel">hideVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.sellVesselFromPanel">sellVesselFromPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.showVesselPanel">showVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.toggleExportMenu">toggleExportMenu</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~closeExportMenuOnClickOutside">closeExportMenuOnClickOutside</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~loadVesselHistory">loadVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~renderHistoryPage">renderHistoryPage</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~setupInfiniteScroll">setupInfiniteScroll</a></li></ul></li><li><a href="module-logbook.html">logbook</a><ul class='methods'><li data-type='method'><a href="module-logbook.html#.deleteAllLogsConfirmed">deleteAllLogsConfirmed</a></li><li data-type='method'><a href="module-logbook.html#.getLogFileSize">getLogFileSize</a></li><li data-type='method'><a href="module-logbook.html#.initLogbook">initLogbook</a></li><li data-type='method'><a href="module-logbook.html#.prependLogEntry">prependLogEntry</a></li><li data-type='method'><a href="module-logbook.html#~exportLogs">exportLogs</a></li><li data-type='method'><a href="module-logbook.html#~formatDetails">formatDetails</a></li><li data-type='method'><a href="module-logbook.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-logbook.html#~loadLogs">loadLogs</a></li><li data-type='method'><a href="module-logbook.html#~renderDetailsRow">renderDetailsRow</a></li><li data-type='method'><a href="module-logbook.html#~renderLogTable">renderLogTable</a></li><li data-type='method'><a href="module-logbook.html#~searchInObject">searchInObject</a></li><li data-type='method'><a href="module-logbook.html#~toggleExpanded">toggleExpanded</a></li><li data-type='method'><a href="module-logbook.html#~updateAutopilotFilter">updateAutopilotFilter</a></li></ul></li><li><a href="module-messenger.html">messenger</a><ul class='methods'><li data-type='method'><a href="module-messenger.html#.closeAllChats">closeAllChats</a></li><li data-type='method'><a href="module-messenger.html#.closeChatSelection">closeChatSelection</a></li><li data-type='method'><a href="module-messenger.html#.openMessenger">openMessenger</a></li><li data-type='method'><a href="module-messenger.html#.openNewChat">openNewChat</a></li><li data-type='method'><a href="module-messenger.html#.showAllChats">showAllChats</a></li><li data-type='method'><a href="module-messenger.html#.updateUnreadBadge">updateUnreadBadge</a></li><li data-type='method'><a href="module-messenger.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-messenger.html#~loadPrivateMessages">loadPrivateMessages</a></li><li data-type='method'><a href="module-messenger.html#~startHijackingPolling">startHijackingPolling</a></li><li data-type='method'><a href="module-messenger.html#~stopHijackingPolling">stopHijackingPolling</a></li></ul></li><li><a href="module-public_js_modules_hijacking.html">public/js/modules/hijacking</a><ul class='methods'><li data-type='method'><a href="module-public_js_modules_hijacking.html#.closeHijackingInbox">closeHijackingInbox</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.openHijackingInbox">openHijackingInbox</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.updateHijackedVesselsDisplay">updateHijackedVesselsDisplay</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.updateHijackingBadge">updateHijackingBadge</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~deleteCase">deleteCase</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~openCaseDetails">openCaseDetails</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~refreshHijackingBadge">refreshHijackingBadge</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~renderCaseList">renderCaseList</a></li></ul></li><li><a href="module-server_automation.html">server/automation</a><ul class='methods'><li data-type='method'><a href="module-server_automation.html#~getRandomInterval">getRandomInterval</a></li><li data-type='method'><a href="module-server_automation.html#~initialize">initialize</a></li><li data-type='method'><a href="module-server_automation.html#~loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_automation.html#~parseInterval">parseInterval</a></li><li data-type='method'><a href="module-server_automation.html#~restartAutoRepair">restartAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~runAutoRepair">runAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~scheduleAutoRepair">scheduleAutoRepair</a></li></ul></li><li><a href="module-server_autopilot.html">server/autopilot</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot.html#~analyzeVesselDepartures">analyzeVesselDepartures</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoRebuyAll">autoRebuyAll</a></li><li data-type='method'><a href="module-server_autopilot.html#~checkPriceAlerts">checkPriceAlerts</a></li><li data-type='method'><a href="module-server_autopilot.html#~countActiveCampaignTypes">countActiveCampaignTypes</a></li><li data-type='method'><a href="module-server_autopilot.html#~initializeAutopilotState">initializeAutopilotState</a></li><li data-type='method'><a href="module-server_autopilot.html#~isAutopilotPaused">isAutopilotPaused</a></li><li data-type='method'><a href="module-server_autopilot.html#~mainEventLoop">mainEventLoop</a></li><li data-type='method'><a href="module-server_autopilot.html#~pauseAutopilot">pauseAutopilot</a></li><li data-type='method'><a href="module-server_autopilot.html#~resumeAutopilot">resumeAutopilot</a></li><li data-type='method'><a href="module-server_autopilot.html#~setBroadcastFunction">setBroadcastFunction</a></li><li data-type='method'><a href="module-server_autopilot.html#~startMainEventLoop">startMainEventLoop</a></li><li data-type='method'><a href="module-server_autopilot.html#~tryUpdateAllData">tryUpdateAllData</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateAllData">updateAllData</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateCampaigns">updateCampaigns</a></li><li data-type='method'><a href="module-server_autopilot.html#~updatePrices">updatePrices</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateRepairCount">updateRepairCount</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateUnreadMessages">updateUnreadMessages</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateVesselCount">updateVesselCount</a></li></ul></li><li><a href="module-server_autopilot_pilot_atmosphere_broker.html">server/autopilot/pilot_atmosphere_broker</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_atmosphere_broker.html#~autoRebuyCO2">autoRebuyCO2</a></li></ul></li><li><a href="module-server_autopilot_pilot_barrel_boss.html">server/autopilot/pilot_barrel_boss</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_barrel_boss.html#~autoRebuyFuel">autoRebuyFuel</a></li></ul></li><li><a href="module-server_autopilot_pilot_captain_blackbeard.html">server/autopilot/pilot_captain_blackbeard</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~acceptRansomWithRetry">acceptRansomWithRetry</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~autoNegotiateHijacking">autoNegotiateHijacking</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~getCaseWithRetry">getCaseWithRetry</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~processHijackingCase">processHijackingCase</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~submitOfferWithRetry">submitOfferWithRetry</a></li></ul></li><li><a href="module-server_autopilot_pilot_cargo_marshal.html">server/autopilot/pilot_cargo_marshal</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~autoDepartVessels">autoDepartVessels</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~departVessels">departVessels</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~getTotalCapacity">getTotalCapacity</a></li></ul></li><li><a href="module-server_autopilot_pilot_fair_hand.html">server/autopilot/pilot_fair_hand</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_fair_hand.html#~autoCoop">autoCoop</a></li></ul></li><li><a href="module-server_autopilot_pilot_harbormaster.html">server/autopilot/pilot_harbormaster</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_harbormaster.html#~autoAnchorPointPurchase">autoAnchorPointPurchase</a></li></ul></li><li><a href="module-server_autopilot_pilot_reputation_chief.html">server/autopilot/pilot_reputation_chief</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_reputation_chief.html#~autoCampaignRenewal">autoCampaignRenewal</a></li></ul></li><li><a href="module-server_autopilot_pilot_yard_foreman.html">server/autopilot/pilot_yard_foreman</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_yard_foreman.html#~autoRepairVessels">autoRepairVessels</a></li></ul></li><li><a href="module-server_cache.html">server/cache</a><ul class='methods'><li data-type='method'><a href="module-server_cache.html#~clearAllCaches">clearAllCaches</a></li><li data-type='method'><a href="module-server_cache.html#~getAllianceCache">getAllianceCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCampaignCache">getCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCompanyCache">getCompanyCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCoopCache">getCoopCache</a></li><li data-type='method'><a href="module-server_cache.html#~invalidateCampaignCache">invalidateCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~invalidateCoopCache">invalidateCoopCache</a></li><li data-type='method'><a href="module-server_cache.html#~isCacheValid">isCacheValid</a></li><li data-type='method'><a href="module-server_cache.html#~setAllianceCache">setAllianceCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCampaignCache">setCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCompanyCache">setCompanyCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCoopCache">setCoopCache</a></li></ul></li><li><a href="module-server_certificate.html">server/certificate</a><ul class='methods'><li data-type='method'><a href="module-server_certificate.html#~createHttpsServer">createHttpsServer</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCA">generateCA</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCertificate">generateCertificate</a></li><li data-type='method'><a href="module-server_certificate.html#~getNetworkIPs">getNetworkIPs</a></li><li data-type='method'><a href="module-server_certificate.html#~isCertificateInstalled">isCertificateInstalled</a></li><li data-type='method'><a href="module-server_certificate.html#~loadCertificate">loadCertificate</a></li></ul></li><li><a href="module-server_chatbot.html">server/chatbot</a></li><li><a href="module-server_config.html">server/config</a><ul class='methods'><li data-type='method'><a href="module-server_config.html#~getAppDataDir">getAppDataDir</a></li><li data-type='method'><a href="module-server_config.html#~getLocalAppDataDir">getLocalAppDataDir</a></li><li data-type='method'><a href="module-server_config.html#~getLogDir">getLogDir</a></li><li data-type='method'><a href="module-server_config.html#~getSessionCookie">getSessionCookie</a></li><li data-type='method'><a href="module-server_config.html#~getSettingsDir">getSettingsDir</a></li><li data-type='method'><a href="module-server_config.html#~loadStartupSettings">loadStartupSettings</a></li><li data-type='method'><a href="module-server_config.html#~setSessionCookie">setSessionCookie</a></li></ul></li><li><a href="module-server_gameapi.html">server/gameapi</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi.html#~activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-server_gameapi.html#~bulkRepairVessels">bulkRepairVessels</a></li><li data-type='method'><a href="module-server_gameapi.html#~departVessel">departVessel</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchAutoPrice">fetchAutoPrice</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchBunkerState">fetchBunkerState</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchEventData">fetchEventData</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchPrices">fetchPrices</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchRepairCount">fetchRepairCount</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchUnreadMessages">fetchUnreadMessages</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-server_gameapi.html#~getAllUserVessels">getAllUserVessels</a></li><li data-type='method'><a href="module-server_gameapi.html#~getAssignedPorts">getAssignedPorts</a></li><li data-type='method'><a href="module-server_gameapi.html#~getGameIndex">getGameIndex</a></li><li data-type='method'><a href="module-server_gameapi.html#~getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-server_gameapi.html#~getVesselHistory">getVesselHistory</a></li><li data-type='method'><a href="module-server_gameapi.html#~getVesselPorts">getVesselPorts</a></li><li data-type='method'><a href="module-server_gameapi.html#~purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-server_gameapi.html#~purchaseFuel">purchaseFuel</a></li></ul></li><li><a href="module-server_middleware_index.html">server/middleware/index</a><ul class='methods'><li data-type='method'><a href="module-server_middleware_index.html#~setupMiddleware">setupMiddleware</a></li></ul></li><li><a href="module-server_routes_alliance.html">server/routes/alliance</a><ul class='methods'><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-members">GET /api/alliance-members</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/chat">GET /api/chat</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/company-name">POST /api/company-name</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/send-message">POST /api/send-message</a></li></ul></li><li><a href="module-server_routes_anchor.html">server/routes/anchor</a></li><li><a href="module-server_routes_coop.html">server/routes/coop</a><ul class='methods'><li data-type='method'><a href="module-server_routes_coop.html#.GET/api/coop/data">GET /api/coop/data</a></li><li data-type='method'><a href="module-server_routes_coop.html#.POST/api/coop/send-max">POST /api/coop/send-max</a></li></ul></li><li><a href="module-server_routes_forecast.html">server/routes/forecast</a><ul class='methods'><li data-type='method'><a href="module-server_routes_forecast.html#~convertCESTToTimezone">convertCESTToTimezone</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~generateChatbotText">generateChatbotText</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~generateMetadata">generateMetadata</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getForecastDataPath">getForecastDataPath</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getNextDayData">getNextDayData</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getPreviousDayData">getPreviousDayData</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getServerLocalTimezone">getServerLocalTimezone</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getTimezoneOffsetHours">getTimezoneOffsetHours</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getValidTimezones">getValidTimezones</a></li></ul></li><li><a href="module-server_routes_game.html">server/routes/game</a></li><li><a href="module-server_routes_harbor-map.html">server/routes/harbor-map</a><ul class='methods'><li data-type='method'><a href="module-server_routes_harbor-map.html#~formatHistoryAsCSV">formatHistoryAsCSV</a></li><li data-type='method'><a href="module-server_routes_harbor-map.html#~formatHistoryAsTXT">formatHistoryAsTXT</a></li><li data-type='method'><a href="module-server_routes_harbor-map.html#~getGameIndexCached">getGameIndexCached</a></li></ul></li><li><a href="module-server_routes_health.html">server/routes/health</a></li><li><a href="module-server_routes_messenger.html">server/routes/messenger</a><ul class='methods'><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/contact/get-contacts">GET /api/contact/get-contacts</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/hijacking/get-cases">GET /api/hijacking/get-cases</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/messenger/get-chats">GET /api/messenger/get-chats</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/delete-chat">POST /api/messenger/delete-chat</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/get-messages">POST /api/messenger/get-messages</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/send-private">POST /api/messenger/send-private</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/user/search">POST /api/user/search</a></li><li data-type='method'><a href="module-server_routes_messenger.html#~migrateHijackHistory">migrateHijackHistory</a></li></ul></li><li><a href="module-server_routes_settings.html">server/routes/settings</a><ul class='methods'><li data-type='method'><a href="module-server_routes_settings.html#.GET/api/settings">GET /api/settings</a></li><li data-type='method'><a href="module-server_routes_settings.html#.POST/api/settings">POST /api/settings</a></li></ul></li><li><a href="module-server_scheduler.html">server/scheduler</a><ul class='methods'><li data-type='method'><a href="module-server_scheduler.html#~initScheduler">initScheduler</a></li><li data-type='method'><a href="module-server_scheduler.html#~isServerReady">isServerReady</a></li></ul></li><li><a href="module-server_settings-schema.html">server/settings-schema</a><ul class='methods'><li data-type='method'><a href="module-server_settings-schema.html#~getDefault">getDefault</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getDefaults">getDefaults</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getRequiredKeys">getRequiredKeys</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getSettingsFilePath">getSettingsFilePath</a></li><li data-type='method'><a href="module-server_settings-schema.html#~initializeSettings">initializeSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~saveSettings">saveSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~validateSettings">validateSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~validateValue">validateValue</a></li></ul></li><li><a href="module-server_state.html">server/state</a><ul class='methods'><li data-type='method'><a href="module-server_state.html#~getAutopilotState">getAutopilotState</a></li><li data-type='method'><a href="module-server_state.html#~getBunkerState">getBunkerState</a></li><li data-type='method'><a href="module-server_state.html#~getCampaignStatus">getCampaignStatus</a></li><li data-type='method'><a href="module-server_state.html#~getCoopData">getCoopData</a></li><li data-type='method'><a href="module-server_state.html#~getEventData">getEventData</a></li><li data-type='method'><a href="module-server_state.html#~getHeaderData">getHeaderData</a></li><li data-type='method'><a href="module-server_state.html#~getLastCO2Alert">getLastCO2Alert</a></li><li data-type='method'><a href="module-server_state.html#~getLastFuelAlert">getLastFuelAlert</a></li><li data-type='method'><a href="module-server_state.html#~getPrices">getPrices</a></li><li data-type='method'><a href="module-server_state.html#~getRepairCount">getRepairCount</a></li><li data-type='method'><a href="module-server_state.html#~getSettings">getSettings</a></li><li data-type='method'><a href="module-server_state.html#~getUserState">getUserState</a></li><li data-type='method'><a href="module-server_state.html#~getVesselCounts">getVesselCounts</a></li><li data-type='method'><a href="module-server_state.html#~isAutopilotPaused">isAutopilotPaused</a></li><li data-type='method'><a href="module-server_state.html#~setAutopilotPaused">setAutopilotPaused</a></li><li data-type='method'><a href="module-server_state.html#~setAutopilotState">setAutopilotState</a></li><li data-type='method'><a href="module-server_state.html#~setLastCO2Alert">setLastCO2Alert</a></li><li data-type='method'><a href="module-server_state.html#~setLastFuelAlert">setLastFuelAlert</a></li><li data-type='method'><a href="module-server_state.html#~updateBunkerState">updateBunkerState</a></li><li data-type='method'><a href="module-server_state.html#~updateCampaignStatus">updateCampaignStatus</a></li><li data-type='method'><a href="module-server_state.html#~updateCoopData">updateCoopData</a></li><li data-type='method'><a href="module-server_state.html#~updateEventData">updateEventData</a></li><li data-type='method'><a href="module-server_state.html#~updateHeaderData">updateHeaderData</a></li><li data-type='method'><a href="module-server_state.html#~updatePrices">updatePrices</a></li><li data-type='method'><a href="module-server_state.html#~updateRepairCount">updateRepairCount</a></li><li data-type='method'><a href="module-server_state.html#~updateSettings">updateSettings</a></li><li data-type='method'><a href="module-server_state.html#~updateVesselCounts">updateVesselCounts</a></li></ul></li><li><a href="module-server_utils_api.html">server/utils/api</a><ul class='methods'><li data-type='method'><a href="module-server_utils_api.html#~apiCall">apiCall</a></li><li data-type='method'><a href="module-server_utils_api.html#~apiCallWithRetry">apiCallWithRetry</a></li><li data-type='method'><a href="module-server_utils_api.html#~getAllianceId">getAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~getChatFeed">getChatFeed</a></li><li data-type='method'><a href="module-server_utils_api.html#~getCompanyName">getCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserCompanyName">getUserCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserId">getUserId</a></li><li data-type='method'><a href="module-server_utils_api.html#~initializeAlliance">initializeAlliance</a></li><li data-type='method'><a href="module-server_utils_api.html#~sleep">sleep</a></li></ul></li><li><a href="module-server_utils_encryption.html">server/utils/encryption</a><ul class='methods'><li data-type='method'><a href="module-server_utils_encryption.html#~decryptData">decryptData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~deleteEncryptedData">deleteEncryptedData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~encryptData">encryptData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~getEncryptionInfo">getEncryptionInfo</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~getMachineKey">getMachineKey</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~isEncrypted">isEncrypted</a></li></ul></li><li><a href="module-server_utils_logger.html">server/utils/logger</a><ul class='methods'><li data-type='method'><a href="module-server_utils_logger.html#~debug">debug</a></li><li data-type='method'><a href="module-server_utils_logger.html#~error">error</a></li><li data-type='method'><a href="module-server_utils_logger.html#~isDebugMode">isDebugMode</a></li><li data-type='method'><a href="module-server_utils_logger.html#~loadLogLevel">loadLogLevel</a></li><li data-type='method'><a href="module-server_utils_logger.html#~log">log</a></li><li data-type='method'><a href="module-server_utils_logger.html#~warn">warn</a></li></ul></li><li><a href="module-server_utils_session-manager.html">server/utils/session-manager</a><ul class='methods'><li data-type='method'><a href="module-server_utils_session-manager.html#~deleteSession">deleteSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getAllUserIds">getAllUserIds</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getAvailableSessions">getAvailableSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getSession">getSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getSessionsPath">getSessionsPath</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~hasSession">hasSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~loadAllSessions">loadAllSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~loadSessions">loadSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~migrateToEncrypted">migrateToEncrypted</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~saveSession">saveSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~saveSessions">saveSessions</a></li></ul></li><li><a href="module-server_websocket.html">server/websocket</a><ul class='methods'><li data-type='method'><a href="module-server_websocket.html#~broadcast">broadcast</a></li><li data-type='method'><a href="module-server_websocket.html#~broadcastBunkerUpdate">broadcastBunkerUpdate</a></li><li data-type='method'><a href="module-server_websocket.html#~broadcastToUser">broadcastToUser</a></li><li data-type='method'><a href="module-server_websocket.html#~getCachedHijackingCase">getCachedHijackingCase</a></li><li data-type='method'><a href="module-server_websocket.html#~getCachedMessengerChats">getCachedMessengerChats</a></li><li data-type='method'><a href="module-server_websocket.html#~getProcessedMessageIds">getProcessedMessageIds</a></li><li data-type='method'><a href="module-server_websocket.html#~getProcessedMessagesCachePath">getProcessedMessagesCachePath</a></li><li data-type='method'><a href="module-server_websocket.html#~initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-server_websocket.html#~loadProcessedMessageCache">loadProcessedMessageCache</a></li><li data-type='method'><a href="module-server_websocket.html#~performChatRefresh">performChatRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~performHijackingRefresh">performHijackingRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~performMessengerRefresh">performMessengerRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~saveProcessedMessageCache">saveProcessedMessageCache</a></li><li data-type='method'><a href="module-server_websocket.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~startHijackingAutoRefresh">startHijackingAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~startMessengerAutoRefresh">startMessengerAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopChatAutoRefresh">stopChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopHijackingAutoRefresh">stopHijackingAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopMessengerAutoRefresh">stopMessengerAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~triggerImmediateChatRefresh">triggerImmediateChatRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~triggerImmediateHijackingRefresh">triggerImmediateHijackingRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~triggerImmediateMessengerRefresh">triggerImmediateMessengerRefresh</a></li></ul></li><li><a href="module-ui-dialogs.html">ui-dialogs</a><ul class='methods'><li data-type='method'><a href="module-ui-dialogs.html#.buyCampaign">buyCampaign</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeCampaignsOverlay">closeCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeSettings">closeSettings</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showCampaignsOverlay">showCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showConfirmDialog">showConfirmDialog</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showContactList">showContactList</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showSettings">showSettings</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#.escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-utils.html#.formatNumber">formatNumber</a></li><li data-type='method'><a href="module-utils.html#.registerServiceWorker">registerServiceWorker</a></li><li data-type='method'><a href="module-utils.html#.renderStars">renderStars</a></li><li data-type='method'><a href="module-utils.html#.requestNotificationPermission">requestNotificationPermission</a></li><li data-type='method'><a href="module-utils.html#.showNotification">showNotification</a></li><li data-type='method'><a href="module-utils.html#.showSideNotification">showSideNotification</a></li></ul></li><li><a href="module-vessel-management.html">vessel-management</a><ul class='methods'><li data-type='method'><a href="module-vessel-management.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.purchaseSingleVessel">purchaseSingleVessel</a></li><li data-type='method'><a href="module-vessel-management.html#.updateVesselCount">updateVesselCount</a></li><li data-type='method'><a href="module-vessel-management.html#~createVesselCard">createVesselCard</a></li><li data-type='method'><a href="module-vessel-management.html#~displayFilteredVessels">displayFilteredVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~getAvailableAnchorSlots">getAvailableAnchorSlots</a></li><li data-type='method'><a href="module-vessel-management.html#~getCO2EfficiencyClass">getCO2EfficiencyClass</a></li><li data-type='method'><a href="module-vessel-management.html#~getCapacityDisplay">getCapacityDisplay</a></li><li data-type='method'><a href="module-vessel-management.html#~getFuelEfficiencyClass">getFuelEfficiencyClass</a></li><li data-type='method'><a href="module-vessel-management.html#~loadCartFromStorage">loadCartFromStorage</a></li><li data-type='method'><a href="module-vessel-management.html#~loadMorePendingVessels">loadMorePendingVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~loadMoreVessels">loadMoreVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~populateDynamicFilters">populateDynamicFilters</a></li><li data-type='method'><a href="module-vessel-management.html#~preloadCommonVesselImages">preloadCommonVesselImages</a></li><li data-type='method'><a href="module-vessel-management.html#~preloadVesselImage">preloadVesselImage</a></li><li data-type='method'><a href="module-vessel-management.html#~refreshVesselCardsIfVisible">refreshVesselCardsIfVisible</a></li><li data-type='method'><a href="module-vessel-management.html#~saveCartToStorage">saveCartToStorage</a></li><li data-type='method'><a href="module-vessel-management.html#~showBulkRepairDialog">showBulkRepairDialog</a></li><li data-type='method'><a href="module-vessel-management.html#~updateCapacityDropdowns">updateCapacityDropdowns</a></li><li data-type='method'><a href="module-vessel-management.html#~vesselPassesFilters">vesselPassesFilters</a></li></ul></li><li><a href="module-vessel-selling.html">vessel-selling</a><ul class='methods'><li data-type='method'><a href="module-vessel-selling.html#.bulkSellVessels">bulkSellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#.closeSellVesselsOverlay">closeSellVesselsOverlay</a></li><li data-type='method'><a href="module-vessel-selling.html#.openSellVesselsOverlay">openSellVesselsOverlay</a></li><li data-type='method'><a href="module-vessel-selling.html#.refreshVesselsForSale">refreshVesselsForSale</a></li><li data-type='method'><a href="module-vessel-selling.html#.setSellFilter">setSellFilter</a></li><li data-type='method'><a href="module-vessel-selling.html#.showSellCart">showSellCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~addVesselsToCart">addVesselsToCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~displaySellVessels">displaySellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#~getCO2EfficiencyClass">getCO2EfficiencyClass</a></li><li data-type='method'><a href="module-vessel-selling.html#~getCapacityDisplay">getCapacityDisplay</a></li><li data-type='method'><a href="module-vessel-selling.html#~getFuelEfficiencyClass">getFuelEfficiencyClass</a></li><li data-type='method'><a href="module-vessel-selling.html#~groupVesselsByModel">groupVesselsByModel</a></li><li data-type='method'><a href="module-vessel-selling.html#~loadUserVesselsForSale">loadUserVesselsForSale</a></li><li data-type='method'><a href="module-vessel-selling.html#~removeVesselSelectionFromCart">removeVesselSelectionFromCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~sellVessels">sellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#~toggleVesselSelection">toggleVesselSelection</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateBulkSellButton">updateBulkSellButton</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateSelectButtonState">updateSelectButtonState</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateVesselSelectionInCart">updateVesselSelectionInCart</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#buildNav">buildNav</a></li><li><a href="global.html#deleteAllLogs">deleteAllLogs</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#flushAllToDisk">flushAllToDisk</a></li><li><a href="global.html#formatDetailsAsTXT">formatDetailsAsTXT</a></li><li><a href="global.html#formatFileSize">formatFileSize</a></li><li><a href="global.html#formatLogsAsCSV">formatLogsAsCSV</a></li><li><a href="global.html#formatLogsAsTXT">formatLogsAsTXT</a></li><li><a href="global.html#fs">fs</a></li><li><a href="global.html#getLogEntries">getLogEntries</a></li><li><a href="global.html#getLogFilePath">getLogFilePath</a></li><li><a href="global.html#getLogFileSize">getLogFileSize</a></li><li><a href="global.html#getLogsFromCache">getLogsFromCache</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#loadLogsFromDisk">loadLogsFromDisk</a></li><li><a href="global.html#lockBulkBuyButton">lockBulkBuyButton</a></li><li><a href="global.html#lockCo2Button">lockCo2Button</a></li><li><a href="global.html#lockCoopButtons">lockCoopButtons</a></li><li><a href="global.html#lockDepartButton">lockDepartButton</a></li><li><a href="global.html#lockFuelButton">lockFuelButton</a></li><li><a href="global.html#lockRepairButton">lockRepairButton</a></li><li><a href="global.html#logAutopilotAction">logAutopilotAction</a></li><li><a href="global.html#publish">publish</a></li><li><a href="global.html#searchInObject">searchInObject</a></li><li><a href="global.html#showAnchorTimer">showAnchorTimer</a></li><li><a href="global.html#shutdown">shutdown</a></li><li><a href="global.html#unlockBulkBuyButton">unlockBulkBuyButton</a></li><li><a href="global.html#unlockCo2Button">unlockCo2Button</a></li><li><a href="global.html#unlockCoopButtons">unlockCoopButtons</a></li><li><a href="global.html#unlockDepartButton">unlockDepartButton</a></li><li><a href="global.html#unlockFuelButton">unlockFuelButton</a></li><li><a href="global.html#unlockRepairButton">unlockRepairButton</a></li><li><a href="global.html#writeLogsToDisk">writeLogsToDisk</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">server/websocket.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview WebSocket Server and Real-Time Chat Update Management
 *
 * This module manages bidirectional real-time communication between the server and connected
 * browser clients using WebSocket protocol. It implements automatic chat feed broadcasting
 * at regular intervals to keep all connected clients synchronized with alliance chat updates.
 *
 * Key Features:
 * - WebSocket server initialization and connection lifecycle management
 * - Automatic chat feed polling every 25 seconds (configurable in config.js)
 * - Broadcast system pushing updates to all connected clients simultaneously
 * - Message transformation (converting API format to client-ready format)
 * - Company name caching to reduce API calls during message processing
 * - Graceful handling of users not in alliance (skips polling)
 *
 * Why This Architecture:
 * - HTTP polling from frontend would be inefficient and waste bandwidth
 * - Server-side polling centralizes API calls (1 API call  N clients)
 * - WebSocket enables instant push updates without client polling
 * - Automatic refresh ensures clients stay synchronized even if inactive
 * - 25-second interval balances freshness with rate limit compliance
 *
 * Message Flow:
 *   API (25s interval)  getChatFeed()  Transform Messages  Broadcast  All Clients
 *
 * WebSocket Protocol:
 * - Messages sent as JSON strings: { type: 'chat_update', data: [...messages] }
 * - Client connects via wss://localhost:12345 (secure WebSocket)
 * - Server broadcasts to all OPEN connections only (skips CONNECTING/CLOSING states)
 *
 * Rate Limiting Consideration:
 * - One server-side API call every 25 seconds for all clients
 * - Without WebSocket, 10 clients would make 10 API calls every 25 seconds
 * - Centralized polling reduces API load by factor of N (number of clients)
 *
 * @requires ws - WebSocket server implementation
 * @requires ./utils/api - API helper functions (getChatFeed, getCompanyName, getAllianceId)
 * @requires ./config - Configuration constants (CHAT_REFRESH_INTERVAL)
 * @module server/websocket
 */

const WebSocket = require('ws');
const { getChatFeed, getCompanyName, getAllianceId, apiCall } = require('./utils/api');
const config = require('./config');
const { getAppDataDir } = require('./config');
const logger = require('./utils/logger');
// chatBot is lazy-loaded to avoid circular dependency (chatbot requires websocket)
const fs = require('fs');
const path = require('path');

// Debug mode - controlled by server/config.js
const DEBUG_MODE = config.DEBUG_MODE;

/**
 * Get cache file path for processed DM message IDs for a specific user
 * @param {string|number} userId - User ID
 * @returns {string} Path to user-specific processed messages cache file
 */
function getProcessedMessagesCachePath(userId) {
  return process.pkg
    ? path.join(getAppDataDir(), 'ShippingManagerCoPilot', 'userdata', 'chatbot', `processed_dm_messages-${userId}.json`)
    : path.join(__dirname, '..', 'userdata', 'chatbot', `processed_dm_messages-${userId}.json`);
}

/**
 * In-memory map of processed message IDs per user (loaded from cache files)
 * @type {Map&lt;string, Set&lt;string>>}
 */
const processedMessageIds = new Map();

/**
 * Get processed message IDs set for a specific user
 * @param {string|number} userId - User ID
 * @returns {Set&lt;string>} Set of processed message identifiers
 */
function getProcessedMessageIds(userId) {
  const userIdString = String(userId);
  if (!processedMessageIds.has(userIdString)) {
    processedMessageIds.set(userIdString, new Set());
  }
  return processedMessageIds.get(userIdString);
}

/**
 * Load processed message IDs from cache file for a specific user
 * @param {string|number} userId - User ID
 */
function loadProcessedMessageCache(userId) {
  try {
    const cachePath = getProcessedMessagesCachePath(userId);
    if (fs.existsSync(cachePath)) {
      const data = fs.readFileSync(cachePath, 'utf8');
      const ids = JSON.parse(data);
      const userSet = getProcessedMessageIds(userId);
      ids.forEach(id => userSet.add(id));
      logger.log(`[Messenger] Loaded ${userSet.size} processed message IDs from cache for user ${userId}`);
    } else {
      logger.log(`[Messenger] No cache file found for user ${userId}, starting with empty processed messages cache`);
    }
  } catch (error) {
    logger.error(`[Messenger] Error loading processed messages cache for user ${userId}:`, error.message);
    // Ensure empty set exists even on error
    getProcessedMessageIds(userId);
  }
}

/**
 * Save processed message IDs to cache file for a specific user
 * @param {string|number} userId - User ID
 */
function saveProcessedMessageCache(userId) {
  try {
    const cachePath = getProcessedMessagesCachePath(userId);
    const dataDir = path.dirname(cachePath);
    if (!fs.existsSync(dataDir)) {
      fs.mkdirSync(dataDir, { recursive: true });
    }
    const userSet = getProcessedMessageIds(userId);
    fs.writeFileSync(cachePath, JSON.stringify([...userSet], null, 2));
  } catch (error) {
    logger.error(`[Messenger] Error saving processed messages cache for user ${userId}:`, error.message);
  }
}

/**
 * WebSocket server instance (shared across all connections)
 * @type {WebSocket.Server|null}
 */
let wss = null;

/**
 * Interval timer for automatic chat refresh (25-second polling)
 * @type {NodeJS.Timeout|null}
 */
let chatRefreshInterval = null;

/**
 * Flag to prevent overlapping chat refresh requests.
 * @type {boolean}
 */
let isChatRefreshing = false;

/**
 * Timestamp of last processed message (Unix timestamp in seconds).
 * Used to detect new messages for ChatBot processing.
 * @type {number}
 */
let lastProcessedMessageTime = Date.now() / 1000;

/**
 * Interval timer for automatic messenger refresh (15-second polling)
 * @type {NodeJS.Timeout|null}
 */
let messengerRefreshInterval = null;

/**
 * Flag to prevent overlapping messenger refresh requests.
 * @type {boolean}
 */
let isMessengerRefreshing = false;

/**
 * Interval timer for automatic hijacking refresh (30-second polling)
 * @type {NodeJS.Timeout|null}
 */
let hijackingRefreshInterval = null;

/**
 * Flag to prevent overlapping hijacking refresh requests.
 * @type {boolean}
 */
let isHijackingRefreshing = false;

/**
 * Cache for solved/paid hijacking cases to reduce API calls.
 * Cases in this set will not trigger /hijacking/get-case API calls.
 * @type {Set&lt;number>}
 */
const solvedHijackingCases = new Set();

/**
 * Shared cache for hijacking case details.
 * Maps case_id -> { details, timestamp, isOpen }
 * Reduces duplicate /hijacking/get-case API calls.
 * @type {Map&lt;number, {details: Object, timestamp: number, isOpen: boolean}>}
 */
const hijackingCaseDetailsCache = new Map();

/**
 * Cache TTL for hijacking case details.
 * Open cases: 5 minutes (prices can change)
 * Solved cases: Permanent (never changes)
 * @constant {number}
 */
const HIJACKING_CASE_CACHE_TTL = 5 * 60 * 1000; // 5 minutes

/**
 * Shared cache for /messenger/get-chats API responses.
 * Reduces duplicate API calls from messenger refresh, hijacking refresh, and badge updates.
 * @type {{ data: Array|null, timestamp: number }}
 */
let messengerChatsCache = {
  data: null,
  timestamp: 0
};

/**
 * Cache TTL for /messenger/get-chats in milliseconds (15 seconds).
 * @constant {number}
 */
const MESSENGER_CHATS_CACHE_TTL = 15000;

/**
 * Fetches messenger chats with shared caching to reduce duplicate API calls.
 *
 * Multiple systems need chat data (messenger refresh, hijacking refresh, badge updates).
 * Without caching, each would make separate API calls to /messenger/get-chats.
 * This function implements a 15-second cache that all systems share.
 *
 * Cache Logic:
 * - If cache is fresh (&lt; 15 seconds old), return cached data immediately
 * - If cache is stale (>= 15 seconds old), fetch fresh data and update cache
 * - Cache is shared across all callers (messenger, hijacking, badges)
 *
 * Impact:
 * - Reduces ~3 duplicate API calls per 15-second window to just 1 call
 * - Saves ~12 API calls/minute during typical usage
 * - All callers get synchronized data from same fetch
 *
 * @async
 * @function getCachedMessengerChats
 * @returns {Promise&lt;Array>} Array of chat objects from /messenger/get-chats
 *
 * @example
 * // Called by messenger refresh, hijacking refresh, and badge updates
 * const chats = await getCachedMessengerChats();
 * const unreadCount = chats.filter(c => c.new).length;
 */
async function getCachedMessengerChats() {
  const now = Date.now();
  const cacheAge = now - messengerChatsCache.timestamp;

  // Return cached data if still fresh
  if (messengerChatsCache.data &amp;&amp; cacheAge &lt; MESSENGER_CHATS_CACHE_TTL) {
    if (DEBUG_MODE) {
      logger.log(`[Messenger Cache] Using cached data (age: ${Math.round(cacheAge / 1000)}s)`);
    }
    return messengerChatsCache.data;
  }

  // Cache stale or empty - fetch fresh data
  try {
    const { apiCall } = require('./utils/api');
    const data = await apiCall('/messenger/get-chats', 'POST', {});
    const chats = data?.data;

    // Update cache
    messengerChatsCache = {
      data: chats,
      timestamp: now
    };

    if (DEBUG_MODE) {
      logger.log(`[Messenger Cache] Fetched fresh data (${chats.length} chats)`);
    }

    return chats;
  } catch (error) {
    logger.error('[Messenger Cache] Error fetching chats:', error.message);

    // Return stale cache if available (better than nothing)
    if (messengerChatsCache.data) {
      logger.log('[Messenger Cache] Returning stale cache due to error');
      return messengerChatsCache.data;
    }

    return [];
  }
}

/**
 * Fetches hijacking case details with shared caching to reduce duplicate API calls.
 *
 * Caching strategy:
 * - Solved cases: Cached permanently (never changes)
 * - Open cases: Cached for 5 minutes (prices can change)
 *
 * This eliminates duplicate /hijacking/get-case calls from:
 * - performHijackingRefresh() (60s interval)
 * - autoNegotiateHijacking() (via autopilot)
 *
 * @param {number} caseId - Hijacking case ID
 * @returns {Promise&lt;{isOpen: boolean, details: Object, cached: boolean}|null>}
 */
async function getCachedHijackingCase(caseId) {
  try {
    const now = Date.now();

    // Check if already in cache
    if (hijackingCaseDetailsCache.has(caseId)) {
      const cached = hijackingCaseDetailsCache.get(caseId);
      const age = now - cached.timestamp;

      // Solved cases: Cache forever
      if (!cached.isOpen) {
        if (DEBUG_MODE) {
          logger.log(`[Hijacking Cache] Case ${caseId} (solved) from cache`);
        }
        return { ...cached, cached: true };
      }

      // Open cases: Cache for 5 minutes
      if (age &lt; HIJACKING_CASE_CACHE_TTL) {
        if (DEBUG_MODE) {
          logger.log(`[Hijacking Cache] Case ${caseId} (open) from cache (age: ${Math.round(age / 1000)}s)`);
        }
        return { ...cached, cached: true };
      }

      // Cache expired for open case
      if (DEBUG_MODE) {
        logger.log(`[Hijacking Cache] Case ${caseId} cache expired (age: ${Math.round(age / 1000)}s), refreshing`);
      }
    }

    // Fetch fresh data from API
    const caseData = await apiCall('/hijacking/get-case', 'POST', { case_id: caseId });
    const details = caseData?.data;
    if (!details) return null;

    const isOpen = details.paid_amount === null &amp;&amp; details.status !== 'solved';

    // Store in cache
    hijackingCaseDetailsCache.set(caseId, {
      details,
      timestamp: now,
      isOpen
    });

    // Also add to solvedHijackingCases Set if solved (legacy compatibility)
    if (!isOpen) {
      solvedHijackingCases.add(caseId);
      logger.debug(`[Hijacking] Case ${caseId} solved, added to cache`);
    }

    if (DEBUG_MODE) {
      logger.log(`[Hijacking Cache] Case ${caseId} fetched from API (status: ${isOpen ? 'open' : 'solved'})`);
    }

    return { isOpen, details, cached: false };
  } catch (error) {
    logger.error(`[Hijacking Cache] Error fetching case ${caseId}:`, error.message);
    return null;
  }
}

/**
 * Initializes the WebSocket server and sets up connection event handlers.
 *
 * This function creates a WebSocket server that operates in "noServer" mode, meaning
 * it shares the HTTPS server's port rather than opening a separate port. The upgrade
 * from HTTP to WebSocket happens via the HTTP server's 'upgrade' event (handled in app.js).
 *
 * Why noServer Mode:
 * - Shares HTTPS port 12345 instead of requiring separate WebSocket port
 * - Simplifies firewall configuration (one port instead of two)
 * - Works seamlessly with HTTPS and self-signed certificates
 * - Standard pattern for integrating WebSocket with Express
 *
 * Connection Lifecycle:
 * 1. Client sends HTTP Upgrade request to wss://localhost:12345
 * 2. Server upgrades connection to WebSocket protocol
 * 3. 'connection' event fires, logging "Client connected"
 * 4. Client remains connected until page close or network interruption
 * 5. 'close' event fires, logging "Client disconnected"
 *
 * Error Handling:
 * - Errors logged to console but don't crash server
 * - Clients can reconnect automatically after errors
 *
 * Side Effects:
 * - Sets module-level `wss` variable for use in broadcast()
 * - Logs connection/disconnection events to console
 *
 * @function initWebSocket
 * @param {https.Server} server - HTTPS server instance (from app.js)
 * @returns {WebSocket.Server} WebSocket server instance
 *
 * @example
 * const server = createHttpsServer(app);
 * const wss = initWebSocket(server);
 * // WebSocket server now listening for upgrade requests
 */
function initWebSocket(server) {
  wss = new WebSocket.Server({ noServer: true });

  wss.on('connection', async (ws) => {
    logger.log('[WebSocket] Client connected');

    // Send ALL cached data immediately on connect
    try {
      const autopilot = require('./autopilot');
      const { getUserId } = require('./utils/api');
      const state = require('./state');

      const userId = getUserId();
      if (userId) {
        // Load processed message IDs cache for this user (if not already loaded)
        if (!processedMessageIds.has(String(userId))) {
          loadProcessedMessageCache(userId);
        }

        logger.log('[WebSocket] Sending all cached data to client...');

        // Send current autopilot pause status FIRST
        ws.send(JSON.stringify({
          type: 'autopilot_status',
          data: { paused: autopilot.isAutopilotPaused() }
        }));

        // Send ALL cached data from state
        try {
          // Prices
          const prices = state.getPrices(userId);
          // CRITICAL: Only send prices if BOTH fuel AND co2 are valid (> 0)
          // DO NOT send if either is 0, undefined, or null - frontend will keep cached value
          if (prices &amp;&amp; prices.fuel > 0 &amp;&amp; prices.co2 > 0) {
            ws.send(JSON.stringify({
              type: 'price_update',
              data: {
                fuel: prices.fuel,
                co2: prices.co2,
                eventDiscount: prices.eventDiscount,
                regularFuel: prices.regularFuel,
                regularCO2: prices.regularCO2
              }
            }));
            logger.log('[WebSocket]  Prices sent');
          } else if (prices) {
            logger.warn(`[WebSocket]  Prices NOT sent - invalid values: fuel=${prices.fuel}, co2=${prices.co2}`);
          }

          // Bunker state (fuel, CO2, cash, points)
          const bunker = state.getBunkerState(userId);
          if (bunker) {
            ws.send(JSON.stringify({
              type: 'bunker_update',
              data: bunker
            }));
            logger.log('[WebSocket]  Bunker state sent');
          }

          // Vessel counts
          const vesselCounts = state.getVesselCounts(userId);
          if (vesselCounts) {
            ws.send(JSON.stringify({
              type: 'vessel_count_update',
              data: vesselCounts
            }));
            logger.log('[WebSocket]  Vessel counts sent');
          }

          // Repair count
          const repairCount = state.getRepairCount(userId);
          if (repairCount !== undefined) {
            ws.send(JSON.stringify({
              type: 'repair_count_update',
              data: { count: repairCount }
            }));
            logger.log('[WebSocket]  Repair count sent');
          }

          // Campaign status
          const campaignStatus = state.getCampaignStatus(userId);
          if (campaignStatus) {
            ws.send(JSON.stringify({
              type: 'campaign_status_update',
              data: campaignStatus
            }));
            logger.log('[WebSocket]  Campaign status sent');
          }

          // COOP data - alliance-dependent
          const { getAllianceId } = require('./utils/api');
          const allianceId = getAllianceId();

          if (!allianceId) {
            // User NOT in alliance - send explicit clear signal
            ws.send(JSON.stringify({
              type: 'coop_update',
              data: { available: 0, cap: 0, coop_boost: 0 }
            }));
            logger.log('[WebSocket]  COOP cleared (no alliance)');
          } else {
            // User in alliance - fetch/send COOP data
            let coopData = state.getCoopData(userId);
            if (!coopData) {
              // No cached data - fetch fresh from game API
              try {
                const coopResponse = await apiCall('/coop/get-coop-data', 'POST', {});
                if (coopResponse?.data?.coop) {
                  const coop = coopResponse.data.coop;
                  coopData = {
                    available: coop.available,
                    cap: coop.cap,
                    coop_boost: coop.coop_boost
                  };
                  // Cache for future use
                  state.updateCoopData(userId, coopData);
                  logger.log('[WebSocket]  COOP data fetched from API (cache was empty)');
                }
              } catch (coopError) {
                logger.error('[WebSocket] Failed to fetch COOP data:', coopError.message);
              }
            }

            // Always send COOP data (even if null - will be loaded later by updateAllData)
            // This ensures the COOP button becomes visible immediately for alliance members
            if (coopData) {
              ws.send(JSON.stringify({
                type: 'coop_update',
                data: coopData
              }));
              logger.log('[WebSocket]  COOP data sent');
            } else {
              // Send placeholder to make button visible (data will be updated later)
              ws.send(JSON.stringify({
                type: 'coop_update',
                data: { available: 0, cap: 1, coop_boost: 0 }  // cap: 1 to show button
              }));
              logger.log('[WebSocket]  COOP placeholder sent (data will load later)');
            }
          }

          // Header data (stock, anchor) - alliance-dependent
          // Send header data (stock + anchor)
          const headerData = state.getHeaderData(userId);
          if (headerData) {
            // If user NOT in alliance, clear stock but keep anchor (anchor is NOT alliance-dependent)
            if (!allianceId) {
              ws.send(JSON.stringify({
                type: 'header_data_update',
                data: {
                  stock: { value: 0, trend: 'none', ipo: 0 },
                  anchor: headerData.anchor || { available: 0, max: 0 }
                }
              }));
              logger.log('[WebSocket]  Header data sent (stock cleared, anchor kept - no alliance)');
            } else {
              // User in alliance - send full header data
              ws.send(JSON.stringify({
                type: 'header_data_update',
                data: headerData
              }));
              logger.log('[WebSocket]  Header data sent');
            }
          }

          // Event data
          const eventData = state.getEventData(userId);
          if (eventData) {
            ws.send(JSON.stringify({
              type: 'event_data_update',
              data: eventData
            }));
            logger.log('[WebSocket]  Event data sent');
          }

        } catch (cacheError) {
          logger.error('[WebSocket] Failed to send cached data:', cacheError.message);
        }

        // Send initial chat data
        try {
          const allianceId = getAllianceId();
          if (allianceId) {
            const chatData = await getChatFeed();
            if (chatData &amp;&amp; chatData.messages &amp;&amp; chatData.messages.length > 0) {
              const messages = await Promise.all(
                chatData.messages.map(async (msg) => {
                  let companyName = msg.user_company_name || 'Unknown';
                  if (!msg.user_company_name &amp;&amp; msg.user_id) {
                    companyName = await getCompanyName(msg.user_id);
                  }
                  return {
                    type: msg.type || 'chat',
                    userId: msg.user_id,
                    companyName: companyName,
                    message: msg.message,
                    timestamp: msg.timestamp
                  };
                })
              );
              ws.send(JSON.stringify({
                type: 'chat_update',
                data: messages
              }));
              logger.log('[WebSocket]  Chat data sent');
            }
          }
        } catch (chatError) {
          logger.error('[WebSocket] Failed to send chat data:', chatError.message);
        }

        // Send messenger/hijacking counts
        try {
          const chats = await getCachedMessengerChats();
          const unreadCount = chats.filter(chat => {
            if (!chat.new) return false;
            if (chat.system_chat &amp;&amp; chat.body === 'vessel_got_hijacked') return false;
            return true;
          }).length;

          ws.send(JSON.stringify({
            type: 'messenger_update',
            data: { messages: unreadCount, chats: chats.length }
          }));
          logger.log('[WebSocket]  Messenger counts sent');

          // Hijacking counts
          const hijackingChats = chats.filter(chat =>
            chat.system_chat &amp;&amp; chat.body === 'vessel_got_hijacked'
          );
          const casesWithDetails = await Promise.all(
            hijackingChats.map(async (chat) => {
              const caseId = chat.values?.case_id;
              if (!caseId) return null;
              return await getCachedHijackingCase(caseId);
            })
          );
          const cases = casesWithDetails.filter(c => c !== null);
          const openCases = cases.filter(c => c.isOpen).length;
          const hijackedCount = cases.filter(c => {
            const status = c.details?.status;
            return status === 'in_progress' || (c.isOpen &amp;&amp; status !== 'solved');
          }).length;

          ws.send(JSON.stringify({
            type: 'hijacking_update',
            data: { openCases, totalCases: cases.length, hijackedCount }
          }));
          logger.log('[WebSocket]  Hijacking counts sent');

        } catch (messengerError) {
          logger.error('[WebSocket] Failed to send messenger/hijacking data:', messengerError.message);
        }

        logger.log('[WebSocket] All cached data sent to client');
      }
    } catch (error) {
      logger.error('[WebSocket] Failed to send initial data:', error.message);
    }

    ws.on('close', () => {
      logger.log('[WebSocket] Client disconnected');
    });

    ws.on('error', (error) => {
      logger.error('[WebSocket] Error:', error.message);
    });
  });

  return wss;
}

/**
 * Broadcasts a message to all connected WebSocket clients.
 *
 * This function sends data to every client currently connected to the WebSocket server.
 * It only sends to clients in OPEN state (connected and ready), skipping clients that
 * are CONNECTING, CLOSING, or CLOSED.
 *
 * Why This Pattern:
 * - Centralized broadcast logic used by multiple features (chat updates, system notifications)
 * - Automatically skips clients in transitional states to prevent errors
 * - Type-based routing allows frontend to handle different message types appropriately
 * - JSON serialization ensures structured data transmission
 *
 * Message Format:
 * {
 *   type: 'chat_update' | 'system_notification' | ...,
 *   data: &lt;any>
 * }
 *
 * Safety Features:
 * - Early return if WebSocket server not initialized
 * - readyState check prevents sending to disconnecting clients
 * - JSON.stringify errors won't crash server (client.send handles errors)
 *
 * Use Cases:
 * - Chat feed updates every 25 seconds
 * - New message notifications
 * - System status updates
 * - Real-time game state changes
 *
 * @function broadcast
 * @param {string} type - Message type for client-side routing (e.g., 'chat_update')
 * @param {*} data - Payload data (will be JSON serialized)
 * @returns {void}
 *
 * @example
 * broadcast('chat_update', [
 *   { type: 'chat', company: 'ABC Corp', message: 'Hello!' }
 * ]);
 * // Sends to all connected clients:
 * // {"type":"chat_update","data":[{"type":"chat",...}]}
 *
 * @example
 * broadcast('system_notification', { message: 'Server restarting in 5 minutes' });
 */
function broadcast(type, data) {
  if (!wss) {
    logger.error('[WebSocket] Cannot broadcast, wss is NULL');
    return;
  }

  const openClients = Array.from(wss.clients).filter(c => c.readyState === WebSocket.OPEN);

  if (DEBUG_MODE) {
    logger.log(`[WebSocket] Broadcasting '${type}' to ${openClients.length} client(s)`);
  }

  wss.clients.forEach(client => {
    if (client.readyState === WebSocket.OPEN) {
      client.send(JSON.stringify({ type, data }));
    }
  });
}

/**
 * Helper function to broadcast bunker updates with current prices.
 * ALWAYS includes prices to prevent race condition where prices get overwritten with undefined.
 *
 * @param {number} userId - User ID
 * @param {Object} bunkerData - Bunker state (fuel, co2, cash, maxFuel, maxCO2)
 * @returns {void}
 */
function broadcastBunkerUpdate(userId, bunkerData) {
  const state = require('./state');
  const currentPrices = state.getPrices(userId);

  const fullBunkerData = {
    ...bunkerData,
    prices: {
      fuelPrice: currentPrices.fuel,
      co2Price: currentPrices.co2,
      eventDiscount: currentPrices.eventDiscount,
      regularFuel: currentPrices.regularFuel,
      regularCO2: currentPrices.regularCO2
    }
  };

  broadcast('bunker_update', fullBunkerData);
}

/**
 * Broadcasts a message to all WebSocket clients belonging to a specific user.
 *
 * In this single-user application, all connected clients belong to the same user,
 * so this function simply wraps broadcast(). The userId parameter is accepted for
 * future scalability (multi-user support).
 *
 * Used by autopilot features to send events to user's connected clients:
 * - price_update: Price changes (fuel/CO2)
 * - price_alert: Price threshold alerts
 * - fuel_purchased: Auto-rebuy fuel success
 * - co2_purchased: Auto-rebuy CO2 success
 * - vessels_departed: Auto-depart success
 * - vessels_failed: Auto-depart failures
 * - vessels_repaired: Auto-repair success
 * - campaigns_renewed: Auto-campaign renewal success
 *
 * @function broadcastToUser
 * @param {number} userId - User ID (currently unused, for future multi-user support)
 * @param {string} type - Message type for client-side routing
 * @param {*} data - Payload data (will be JSON serialized)
 * @returns {void}
 *
 * @example
 * broadcastToUser(12345, 'fuel_purchased', {
 *   amount: 100,
 *   price: 380,
 *   newTotal: 500,
 *   cost: 38000
 * });
 */
function broadcastToUser(userId, type, data) {
  // Special handling for bunker_update: ALWAYS include current prices to prevent race condition
  if (type === 'bunker_update' &amp;&amp; data &amp;&amp; !data.prices) {
    const state = require('./state');
    const currentPrices = state.getPrices(userId);

    // ONLY add prices if they are valid (not 0) - prevents broadcasting fake default values
    if (currentPrices.fuel > 0 &amp;&amp; currentPrices.co2 > 0) {
      data.prices = {
        fuelPrice: currentPrices.fuel,
        co2Price: currentPrices.co2,
        eventDiscount: currentPrices.eventDiscount,
        regularFuel: currentPrices.regularFuel,
        regularCO2: currentPrices.regularCO2
      };
    }
  }

  // In single-user mode, broadcast to all clients
  // userId parameter reserved for future multi-user support
  broadcast(type, data);
}

/**
 * Starts automatic chat feed polling and broadcasting to all connected clients.
 *
 * This function implements server-side polling of the alliance chat feed at regular intervals
 * (25 seconds by default). It fetches chat messages from the game API, transforms them into
 * a client-friendly format, and broadcasts updates to all connected WebSocket clients.
 *
 * Why Server-Side Polling:
 * - Centralizes API calls (one call serves all clients)
 * - Reduces game API load compared to per-client polling
 * - Ensures all clients stay synchronized with same data
 * - Complies with rate limiting (30 req/min across all clients)
 * - Clients receive updates even when browser tab is inactive
 *
 * Polling Interval:
 * - Default: 25 seconds (config.CHAT_REFRESH_INTERVAL)
 * - Balances freshness with API rate limits
 * - 25s = 2.4 calls/minute, well below 30 req/min limit
 * - Leaves headroom for manual chat sends and other API operations
 *
 * Message Types Handled:
 * 1. Chat Messages (type: 'chat')
 *    - Fetches company name via getCompanyName() with caching
 *    - Converts Unix timestamp to UTC string
 *    - Includes user_id for sender identification
 *
 * 2. Feed Events (type: 'feed')
 *    - Alliance member joins, route completions, etc.
 *    - Already includes company name in replacements
 *    - No additional API call needed
 *
 * No Alliance Handling:
 * - Checks getAllianceId() every interval
 * - If null (user not in alliance), skips API call
 * - Prevents 404 errors from alliance-specific endpoints
 * - Allows app to work for non-alliance users
 *
 * Error Handling:
 * - API errors logged but don't stop polling
 * - Interval continues running even if one fetch fails
 * - Prevents cascading failures from transient network issues
 *
 * Side Effects:
 * - Makes API call to /alliance/get-feed every 25 seconds
 * - May make multiple API calls to /user/get-user-settings for uncached company names
 * - Broadcasts to all connected WebSocket clients
 * - Sets module-level chatRefreshInterval variable
 *
 * @function startChatAutoRefresh
 * @returns {void}
 *
 * @example
 * // Called from app.js during server initialization
 * startChatAutoRefresh();
 * // Begins polling every 25 seconds
 * // Broadcasts chat_update messages to all connected clients
 *
 * @example
 * // Typical broadcast message structure:
 * {
 *   type: 'chat_update',
 *   data: [
 *     {
 *       type: 'chat',
 *       company: 'ABC Shipping',
 *       message: 'Hello everyone!',
 *       timestamp: 'Mon, 23 Oct 2025 14:30:00 GMT',
 *       user_id: 12345
 *     },
 *     {
 *       type: 'feed',
 *       feedType: 'alliance_member_joined',
 *       company: 'XYZ Corp',
 *       timestamp: 'Mon, 23 Oct 2025 14:25:00 GMT'
 *     }
 *   ]
 * }
 */
/**
 * Performs a single chat refresh cycle.
 * Fetches latest chat messages, broadcasts to clients, and processes with ChatBot.
 * Uses module-level isChatRefreshing flag to prevent overlapping requests.
 *
 * @async
 * @function performChatRefresh
 * @returns {Promise&lt;void>}
 */
async function performChatRefresh() {
  if (!getAllianceId()) {
    return;
  }

  // Skip if previous refresh is still running
  if (isChatRefreshing) {
    logger.log('[Chat Refresh] Skipping - previous request still running');
    return;
  }

  isChatRefreshing = true;

  try {
    const feed = await getChatFeed();
    const messages = [];
    let hasNewMessages = false;

    for (const msg of feed) {
      if (msg.type === 'chat') {
        const companyName = await getCompanyName(msg.user_id);
        const timestamp = new Date(msg.time_created * 1000).toUTCString();
        messages.push({
          type: 'chat',
          company: companyName,
          message: msg.message,
          timestamp: timestamp,
          user_id: msg.user_id
        });

        // Check if this is a new message for ChatBot processing
        if (msg.time_created > lastProcessedMessageTime) {
          hasNewMessages = true;
          // Process with ChatBot (async, don't await) - lazy-loaded to avoid circular dependency
          const chatBot = require('./chatbot');
          chatBot.processAllianceMessage(msg.message, msg.user_id, companyName)
            .catch(err => logger.error('[ChatBot] Error processing alliance message:', err));
        }
      } else if (msg.type === 'feed') {
        const timestamp = new Date(msg.time_created * 1000).toUTCString();
        messages.push({
          type: 'feed',
          feedType: msg.feed_type,
          company: msg.replacements.company_name,
          timestamp: timestamp
        });
      }
    }

    // Update last processed time if we had new messages
    if (hasNewMessages) {
      lastProcessedMessageTime = Date.now() / 1000;
    }

    if (messages.length > 0 || wss.clients.size > 0) {
      broadcast('chat_update', messages);
    }
  } catch (error) {
    // Only log non-timeout errors
    if (!error.message.includes('socket hang up') &amp;&amp; !error.message.includes('ECONNRESET')) {
      logger.error('[Chat Refresh] Error:', error.message);
    }
  } finally {
    isChatRefreshing = false; // Always release the lock
  }
}

/**
 * Starts automatic chat refresh polling at configured interval (default: 20 seconds).
 * Calls performChatRefresh() on each cycle.
 * Chat and messenger polls run simultaneously in the same interval to reduce API load.
 *
 * @function startChatAutoRefresh
 * @returns {void}
 */
function startChatAutoRefresh() {
  chatRefreshInterval = setInterval(async () => {
    // Run chat and messenger refresh in parallel
    await Promise.all([
      performChatRefresh(),
      performMessengerRefresh()
    ]);
  }, config.CHAT_REFRESH_INTERVAL);
}

/**
 * Triggers an immediate chat refresh after a short delay.
 * Used by ChatBot to immediately broadcast bot responses without waiting for next polling cycle.
 *
 * The 3-second delay ensures the Game API has time to persist the message before we fetch it.
 * This prevents race conditions where we fetch before the message is saved.
 *
 * Safe to call multiple times - the isChatRefreshing flag prevents overlapping requests.
 *
 * @function triggerImmediateChatRefresh
 * @returns {void}
 *
 * @example
 * // After sending a bot response
 * await sendAllianceMessage(response);
 * triggerImmediateChatRefresh(); // Clients will see response in ~3 seconds instead of up to 25s
 */
function triggerImmediateChatRefresh() {
  logger.log('[Chat Refresh] Immediate refresh triggered - will execute in 3 seconds');
  setTimeout(async () => {
    await performChatRefresh();
  }, 3000); // 3-second delay to allow Game API to persist the message
}

/**
 * Performs a single messenger refresh cycle.
 * Fetches unread messages, broadcasts to clients, and processes DM commands with ChatBot.
 * Uses module-level isMessengerRefreshing flag to prevent overlapping requests.
 *
 * @async
 * @function performMessengerRefresh
 * @returns {Promise&lt;void>}
 */
async function performMessengerRefresh() {
  // Skip if previous refresh is still running
  if (isMessengerRefreshing) {
    logger.log('[Messenger Refresh] Skipping - previous request still running');
    return;
  }

  isMessengerRefreshing = true;

  try {
    const { apiCall, getUserId } = require('./utils/api');
    const userId = getUserId();
    if (!userId) {
      logger.error('[Messenger Refresh] No user ID available');
      isMessengerRefreshing = false;
      return;
    }

    // Load processed messages cache for this user if not already loaded
    if (!processedMessageIds.has(String(userId))) {
      loadProcessedMessageCache(userId);
    }

    // Fetch messenger chats (using shared cache to reduce API calls)
    const chats = await getCachedMessengerChats();

    // Count unread messages (messages with 'new' flag)
    // Exclude hijacking messages - they go to Blackbeard's Phone Booth
    const unreadCount = chats.filter(chat => {
      if (!chat.new) return false;
      // Exclude hijacking system messages
      if (chat.system_chat &amp;&amp; chat.body === 'vessel_got_hijacked') {
        return false;
      }
      return true;
    }).length;

    // Broadcast unread count to all clients
    broadcast('messenger_update', {
      messages: unreadCount,
      chats: chats.length
    });

    // Process chats with ChatBot - Check ONLY UNREAD chats to reduce API spam
    // The processedMessageIds cache ensures we don't reply twice to the same message
    for (const chat of chats) {
      // Skip system chats
      if (chat.system_chat) continue;

      // CRITICAL: Only check unread chats to reduce API calls
      // Without this check, we'd fetch /messenger/get-chat for EVERY chat (10+ chats = 10+ API calls every 15 seconds!)
      if (!chat.new) continue;

      try {
        // Fetch messages for this chat
        const messagesData = await apiCall('/messenger/get-chat', 'POST', {
          chat_id: chat.id
        });

        const messages = messagesData?.data?.chat?.messages || messagesData?.data?.messages;

        // Find the latest message from the sender (not from us)
        const senderMessages = messages.filter(msg => msg.is_mine === false).reverse();

        if (senderMessages.length === 0) {
          continue; // No messages from sender
        }

        // IMPORTANT: Only process the LATEST message, even if multiple are unread
        // This prevents duplicate replies if user sends same command multiple times
        const latestMessage = senderMessages[0];

        // Create unique identifier
        const messageIdentifier = `${chat.id}_${latestMessage.created_at}`;

        // Check if we've already processed this message
        const userProcessedIds = getProcessedMessageIds(userId);
        if (userProcessedIds.has(messageIdentifier)) {
          continue; // Already replied to this message
        }

        // Only log if chat is unread (to reduce spam in logs)
        if (chat.new) {
          logger.log(`[Messenger] New DM from ${chat.participants_string}: "${latestMessage.body || chat.subject}"`);
        }

        // Process with ChatBot - lazy-loaded to avoid circular dependency
        const chatBot = require('./chatbot');
        const wasProcessed = await chatBot.processPrivateMessage(
          messageIdentifier,
          latestMessage.body || '',
          latestMessage.user_id,
          chat.participants_string
        );

        // Only add to processed cache if bot actually handled the message
        if (wasProcessed) {
          userProcessedIds.add(messageIdentifier);
          saveProcessedMessageCache(userId);
          logger.log(`[Messenger] Bot replied and cached: ${messageIdentifier}`);
        } else {
          // Add to cache even if not processed, so we don't spam logs every polling cycle
          userProcessedIds.add(messageIdentifier);
          saveProcessedMessageCache(userId);
          logger.debug(`[Messenger] Message ignored (not a valid command): ${messageIdentifier}`);
        }

      } catch (error) {
        logger.error(`[Messenger] Error processing chat ${chat.id}:`, error.message);
      }
    }

    // Log only in debug mode
    if (DEBUG_MODE) {
      if (unreadCount > 0) {
        logger.log(`[Messenger] ${unreadCount} unread messages detected`);
      } else {
        logger.log(`[Messenger] Poll complete: 0 unread messages`);
      }
    }
  } catch (error) {
    // Only log non-timeout errors
    if (!error.message.includes('socket hang up') &amp;&amp; !error.message.includes('ECONNRESET')) {
      logger.error('[Messenger] Error:', error.message);
    }
  } finally {
    isMessengerRefreshing = false; // Always release the lock
  }
}

/**
 * Messenger polling is now handled by startChatAutoRefresh() to run simultaneously.
 * This function is kept for backwards compatibility but does nothing.
 * Both chat and messenger refresh happen together in the same 20-second interval.
 *
 * @function startMessengerAutoRefresh
 * @returns {void}
 */
function startMessengerAutoRefresh() {
  // Messenger refresh now runs together with chat refresh in startChatAutoRefresh()
  // No separate interval needed - both APIs are called simultaneously
  logger.log('[Messenger] Messenger polling synchronized with chat polling (20s interval)');
}

/**
 * Triggers an immediate messenger refresh after a short delay.
 * Used by ChatBot to immediately broadcast DM responses without waiting for next polling cycle.
 *
 * The 3-second delay ensures the Game API has time to persist the message before we fetch it.
 * This prevents race conditions where we fetch before the message is saved.
 *
 * Safe to call multiple times - the isMessengerRefreshing flag prevents overlapping requests.
 *
 * @function triggerImmediateMessengerRefresh
 * @returns {void}
 *
 * @example
 * // After sending a DM response
 * await sendPrivateMessage(userId, subject, response);
 * triggerImmediateMessengerRefresh(); // Client will see response in ~3 seconds instead of up to 10s
 */
function triggerImmediateMessengerRefresh() {
  logger.log('[Messenger Refresh] Immediate refresh triggered - will execute in 3 seconds');
  setTimeout(async () => {
    await performMessengerRefresh();
  }, 3000); // 3-second delay to allow Game API to persist the message
}

/**
 * Stops the automatic messenger polling and clears the interval timer.
 *
 * @function stopMessengerAutoRefresh
 * @returns {void}
 */
function stopMessengerAutoRefresh() {
  if (messengerRefreshInterval) {
    clearInterval(messengerRefreshInterval);
    messengerRefreshInterval = null;
  }
}

/**
 * Stops the automatic chat feed polling and clears the interval timer.
 *
 * This function provides a clean shutdown mechanism for the chat auto-refresh feature.
 * It's primarily used during server shutdown or when temporarily disabling automatic updates.
 *
 * Why This Matters:
 * - Prevents interval from continuing after server shutdown
 * - Cleans up resources properly to avoid memory leaks
 * - Allows pausing auto-refresh without restarting server
 * - Sets interval reference to null for garbage collection
 *
 * Use Cases:
 * - Server graceful shutdown (SIGTERM/SIGINT handlers)
 * - Temporarily disabling auto-refresh for maintenance
 * - Reconfiguring refresh interval (stop, then restart with new interval)
 *
 * Side Effects:
 * - Clears the setInterval timer
 * - Sets chatRefreshInterval to null
 * - No more automatic broadcasts until startChatAutoRefresh() called again
 *
 * @function stopChatAutoRefresh
 * @returns {void}
 *
 * @example
 * // During server shutdown
 * process.on('SIGTERM', () => {
 *   console.log('Shutting down server...');
 *   stopChatAutoRefresh();
 *   server.close();
 * });
 *
 * @example
 * // Reconfiguring refresh interval
 * stopChatAutoRefresh();
 * config.CHAT_REFRESH_INTERVAL = 30000; // Change to 30 seconds
 * startChatAutoRefresh();
 */
function stopChatAutoRefresh() {
  if (chatRefreshInterval) {
    clearInterval(chatRefreshInterval);
    chatRefreshInterval = null;
  }
}

/**
 * Performs a single hijacking refresh cycle.
 * Fetches hijacking cases and broadcasts badge/header counts to all clients.
 * Uses module-level isHijackingRefreshing flag to prevent overlapping requests.
 *
 * What This Does:
 * - Fetches all hijacking cases via /api/hijacking/get-cases
 * - Counts OPEN cases (paid_amount === null &amp;&amp; status !== 'solved')
 * - Counts total cases (open + closed)
 * - Counts hijacked vessels (vessels with status 'in_progress')
 * - Broadcasts to all clients for badge and header updates
 *
 * Why This Exists:
 * - Keeps hijacking inbox badge count up-to-date
 * - Updates header pirate emoji count (hijacked vessels)
 * - Separates hijacking from messenger badge logic
 * - Enables real-time tracking of hijacking status changes
 *
 * Broadcast Data:
 * {
 *   openCases: number,      // Open hijacking cases (for badge)
 *   totalCases: number,     // Total cases (open + closed)
 *   hijackedCount: number   // Currently hijacked vessels (for header emoji)
 * }
 *
 * @async
 * @function performHijackingRefresh
 * @returns {Promise&lt;void>}
 */
async function performHijackingRefresh() {
  // Skip if previous refresh is still running
  if (isHijackingRefreshing) {
    if (DEBUG_MODE) {
      logger.log('[Hijacking Refresh] Skipping - previous request still running');
    }
    return;
  }

  isHijackingRefreshing = true;

  try {
    const { apiCall } = require('./utils/api');

    // Fetch messenger chats (using shared cache to reduce API calls)
    const allChats = await getCachedMessengerChats();

    // Filter for hijacking cases
    const hijackingChats = allChats.filter(chat =>
      chat.system_chat &amp;&amp; chat.body === 'vessel_got_hijacked'
    );

    // Fetch details for each case (using shared cache)
    const casesWithDetails = await Promise.all(
      hijackingChats.map(async (chat) => {
        const caseId = chat.values?.case_id;
        if (!caseId) return null;

        // Use shared cache function to get case details
        return await getCachedHijackingCase(caseId);
      })
    );

    const cases = casesWithDetails.filter(c => c !== null);

    // Count cached vs fetched for logging
    const cachedCount = cases.filter(c => c.cached).length;
    const fetchedCount = cases.length - cachedCount;

    // Count open cases (for badge)
    const openCases = cases.filter(c => c.isOpen).length;

    // Count hijacked vessels (status = 'in_progress')
    const hijackedCount = cases.filter(c => {
      const status = c.details?.status;
      return status === 'in_progress' || (c.isOpen &amp;&amp; status !== 'solved');
    }).length;

    // Broadcast to all clients
    const hijackingData = {
      openCases: openCases,
      totalCases: cases.length,
      hijackedCount: hijackedCount
    };
    logger.log(`[Hijacking Refresh] Broadcasting update: ${openCases} open, ${hijackedCount} hijacked (${fetchedCount} API calls, ${cachedCount} cached)`);
    broadcast('hijacking_update', hijackingData);

    if (DEBUG_MODE) {
      logger.log(`[Hijacking] ${openCases} open cases, ${hijackedCount} hijacked vessels`);
    }
  } catch (error) {
    // Only log non-timeout and non-connection errors
    if (!error.message.includes('socket hang up') &amp;&amp;
        !error.message.includes('ECONNRESET') &amp;&amp;
        !error.message.includes('ECONNREFUSED')) {
      logger.error('[Hijacking Refresh] Error:', error.message);
    }
  } finally {
    isHijackingRefreshing = false; // Always release the lock
  }
}

/**
 * Starts automatic hijacking refresh polling at 60-second interval.
 * Calls performHijackingRefresh() on each cycle.
 *
 * Why 60 Seconds:
 * - Hijacking status changes infrequently
 * - Longer interval reduces API load significantly
 * - Still provides reasonably real-time updates
 * - Balances freshness with performance (reduces ~2 calls/min)
 *
 * @function startHijackingAutoRefresh
 * @returns {void}
 */
function startHijackingAutoRefresh() {
  hijackingRefreshInterval = setInterval(async () => {
    await performHijackingRefresh();
  }, 60000); // 60 seconds
}

/**
 * Stops the automatic hijacking polling and clears the interval timer.
 *
 * @function stopHijackingAutoRefresh
 * @returns {void}
 */
function stopHijackingAutoRefresh() {
  if (hijackingRefreshInterval) {
    clearInterval(hijackingRefreshInterval);
    hijackingRefreshInterval = null;
  }
}

/**
 * Triggers an immediate hijacking refresh after a short delay.
 * Used after auto-negotiate completes or when case status changes.
 *
 * @function triggerImmediateHijackingRefresh
 * @returns {void}
 */
function triggerImmediateHijackingRefresh() {
  if (DEBUG_MODE) {
    logger.log('[Hijacking Refresh] Immediate refresh triggered - will execute in 2 seconds');
  }
  setTimeout(async () => {
    await performHijackingRefresh();
  }, 2000); // 2-second delay to allow API to update
}

module.exports = {
  initWebSocket,
  broadcast,
  broadcastToUser,
  broadcastBunkerUpdate,
  startChatAutoRefresh,
  stopChatAutoRefresh,
  triggerImmediateChatRefresh,
  startMessengerAutoRefresh,
  stopMessengerAutoRefresh,
  triggerImmediateMessengerRefresh,
  startHijackingAutoRefresh,
  stopHijackingAutoRefresh,
  triggerImmediateHijackingRefresh,
  getCachedMessengerChats,  // Export shared cache function for use by other modules
  getCachedHijackingCase    // Export shared cache function for hijacking cases
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation Version: 0.0.7 - ShippingManager CoPilot
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
