<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>public/js/modules/messenger.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Dark theme matching app style - carefully scoped to not break layout */
        html, body {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
            overflow-x: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Custom scrollbar styling for all browsers */
        * {
            scrollbar-width: thin !important;
            scrollbar-color: #404040 #1a1a1a !important;
        }

        /* Webkit browsers (Chrome, Safari, Edge) */
        *::-webkit-scrollbar {
            width: 6px !important;
            height: 6px !important;
        }

        *::-webkit-scrollbar-track {
            background: #1a1a1a !important;
        }

        *::-webkit-scrollbar-thumb {
            background-color: #404040 !important;
            border-radius: 3px !important;
        }

        *::-webkit-scrollbar-thumb:hover {
            background-color: #505050 !important;
        }

        /* Navigation sidebar - remove padding and white borders */
        nav {
            background-color: #242424 !important;
            border-right: 1px solid #404040 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow-x: hidden !important;
        }
        nav h2, nav h3 {
            color: #e0e0e0 !important;
            border-bottom: 1px solid #404040 !important;
            padding: 10px 15px !important;
            margin: 0 !important;
            background-color: #242424 !important;
            font-size: 14px !important;
            font-weight: 600 !important;
        }
        nav h3 {
            font-size: 13px !important;
        }
        nav ul {
            padding: 0 !important;
            margin: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li {
            list-style: none !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li a {
            color: #c9d1d9 !important;
            display: block !important;
            padding: 8px 15px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            background-color: #242424 !important;
            margin: 0 !important;
            border: none !important;
            font-size: 14px !important;
        }
        nav ul li a:hover {
            color: #60a5fa !important;
            background-color: rgba(96, 165, 250, 0.1) !important;
        }
        /* Module links (direct children of nav > ul > li) */
        nav > ul > li > a {
            color: #60a5fa !important;
            font-weight: 600 !important;
            padding: 10px 15px !important;
            font-size: 14px !important;
            border-left: 3px solid #60a5fa !important;
            padding-left: 12px !important;
        }
        nav > ul > li > a:hover {
            background-color: rgba(96, 165, 250, 0.15) !important;
        }
        /* Sub-items (methods/functions) indented */
        nav ul.methods {
            padding-left: 15px !important;
        }
        nav ul.methods li a {
            color: #9ca3af !important;
            font-size: 13px !important;
            padding: 6px 15px !important;
            font-weight: 400 !important;
        }
        nav ul.methods li a:hover {
            color: #c9d1d9 !important;
        }
        nav > h2:first-child {
            font-size: 16px !important;
            font-weight: 700 !important;
            padding: 12px 15px !important;
        }

        /* Main content area - dark background */
        #main {
            background-color: #1a1a1a !important;
            padding: 20px !important;
        }

        /* Article and sections - ensure dark background */
        article, section, .container-overview, .description {
            background-color: #1a1a1a !important;
        }

        /* Images - style demo images */
        img {
            max-width: 100% !important;
            height: auto !important;
            border: 1px solid #404040 !important;
            border-radius: 8px !important;
            margin: 20px 0 !important;
        }

        /* Links */
        a {
            color: #60a5fa !important;
            text-decoration: none !important;
        }
        a:hover {
            color: #93c5fd !important;
            text-decoration: underline !important;
        }

        /* Headings */
        h1, h2, h3, h4, h5, h6 {
            color: #e0e0e0 !important;
            border-bottom-color: #404040 !important;
            background-color: transparent !important;
        }
        h4.name {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
        }

        /* Code blocks */
        pre {
            background-color: #0d1117 !important;
            border: 1px solid #404040 !important;
        }
        pre code {
            background-color: transparent !important;
        }
        code {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
        }

        /* Tables */
        table {
            border-color: #404040 !important;
            background-color: #1a1a1a !important;
        }
        table thead tr {
            background-color: #242424 !important;
        }
        table tbody tr {
            background-color: #1a1a1a !important;
        }
        table tbody tr:nth-child(even) {
            background-color: #1f1f1f !important;
        }
        table td, table th {
            border-color: #404040 !important;
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }
        .params .name, .props .name {
            color: #10b981 !important;
            font-family: 'Courier New', monospace !important;
        }

        /* Descriptions and details */
        .description, .details, dt, dd, p, ul, ol, dl {
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }

        /* Types */
        .type-signature {
            color: #a78bfa !important;
        }

        /* Source links */
        .details .details-item-container {
            border-left-color: #404040 !important;
        }

        /* Breadcrumbs */
        .page-title {
            color: #e0e0e0 !important;
        }

        /* Search */
        #nav-search {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
            color: #e0e0e0 !important;
        }

        /* Mobile nav trigger */
        .navicon-button {
            background-color: #2a2a2a !important;
        }

        /* Footer */
        footer {
            background-color: #1a1a1a !important;
            color: #9ca3af !important;
            border-top: 1px solid #404040 !important;
            text-align: center !important;
            padding: 20px !important;
        }

        /* Remove horizontal scrollbar and white borders */
        * {
            box-sizing: border-box !important;
        }
    </style>
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">README</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-build-guide.html">Build Guide</a></li><li><a href="tutorial-installation-guide.html">Installation Guide</a></li></ul><h3>Classes</h3><ul><li><a href="module-core_debounced-api.DebouncedAPIManager.html">DebouncedAPIManager</a><ul class='methods'><li data-type='method'><a href="module-core_debounced-api.DebouncedAPIManager.html#call">call</a></li><li data-type='method'><a href="module-core_debounced-api.DebouncedAPIManager.html#cancelAll">cancelAll</a></li><li data-type='method'><a href="module-core_debounced-api.DebouncedAPIManager.html#get">get</a></li><li data-type='method'><a href="module-core_debounced-api.DebouncedAPIManager.html#register">register</a></li></ul></li><li><a href="module-server_chatbot-ChatBot.html">ChatBot</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot-ChatBot.html#initialize">initialize</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#processAllianceMessage">processAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#processPrivateMessage">processPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#setupScheduledTasks">setupScheduledTasks</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#updateSettings">updateSettings</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-alliance-tabs.html">alliance-tabs</a><ul class='methods'><li data-type='method'><a href="module-alliance-tabs.html#.clearAllianceTabCache">clearAllianceTabCache</a></li><li data-type='method'><a href="module-alliance-tabs.html#.closeAllianceCoopOverlay">closeAllianceCoopOverlay</a></li><li data-type='method'><a href="module-alliance-tabs.html#.getCurrentTab">getCurrentTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#.hideAllAllianceUI">hideAllAllianceUI</a></li><li data-type='method'><a href="module-alliance-tabs.html#.initAllianceTabs">initAllianceTabs</a></li><li data-type='method'><a href="module-alliance-tabs.html#.refreshCurrentTab">refreshCurrentTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#.showAllAllianceUI">showAllAllianceUI</a></li><li data-type='method'><a href="module-alliance-tabs.html#.showAllianceCoopOverlay">showAllianceCoopOverlay</a></li><li data-type='method'><a href="module-alliance-tabs.html#.switchTab">switchTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#.updateCoopTabBadge">updateCoopTabBadge</a></li><li data-type='method'><a href="module-alliance-tabs.html#~acceptUserToAlliance">acceptUserToAlliance</a></li><li data-type='method'><a href="module-alliance-tabs.html#~appendSearchResults">appendSearchResults</a></li><li data-type='method'><a href="module-alliance-tabs.html#~attachAllianceClickHandlers">attachAllianceClickHandlers</a></li><li data-type='method'><a href="module-alliance-tabs.html#~attachSearchEventListeners">attachSearchEventListeners</a></li><li data-type='method'><a href="module-alliance-tabs.html#~createAllianceRow">createAllianceRow</a></li><li data-type='method'><a href="module-alliance-tabs.html#~declineUserFromAlliance">declineUserFromAlliance</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchAllianceInfo">fetchAllianceInfo</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchAllianceInfoById">fetchAllianceInfoById</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchAllianceMembers">fetchAllianceMembers</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchAllianceMembersById">fetchAllianceMembersById</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchAllianceSettings">fetchAllianceSettings</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchHighScores">fetchHighScores</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchLeagueInfo">fetchLeagueInfo</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchQueuePool">fetchQueuePool</a></li><li data-type='method'><a href="module-alliance-tabs.html#~generateAllianceInfoHTML">generateAllianceInfoHTML</a></li><li data-type='method'><a href="module-alliance-tabs.html#~handleJoinAllianceClick">handleJoinAllianceClick</a></li><li data-type='method'><a href="module-alliance-tabs.html#~leaveAlliance">leaveAlliance</a></li><li data-type='method'><a href="module-alliance-tabs.html#~loadTabContent">loadTabContent</a></li><li data-type='method'><a href="module-alliance-tabs.html#~loadWelcomeMessage">loadWelcomeMessage</a></li><li data-type='method'><a href="module-alliance-tabs.html#~normalizeColor">normalizeColor</a></li><li data-type='method'><a href="module-alliance-tabs.html#~performSearch">performSearch</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderAllianzTab">renderAllianzTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderCoopTab">renderCoopTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderHighScoreTab">renderHighScoreTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderLigaTab">renderLigaTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderManagementTab">renderManagementTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderMemberCard">renderMemberCard</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderSearchResults">renderSearchResults</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderSearchTab">renderSearchTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderSettingsTab">renderSettingsTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~saveWelcomeMessage">saveWelcomeMessage</a></li><li data-type='method'><a href="module-alliance-tabs.html#~sendWelcomeMessageToUser">sendWelcomeMessageToUser</a></li><li data-type='method'><a href="module-alliance-tabs.html#~showAllianceDetailsModal">showAllianceDetailsModal</a></li><li data-type='method'><a href="module-alliance-tabs.html#~showDonateDialog">showDonateDialog</a></li><li data-type='method'><a href="module-alliance-tabs.html#~showTextInputDialog">showTextInputDialog</a></li><li data-type='method'><a href="module-alliance-tabs.html#~updateAllianceSettings">updateAllianceSettings</a></li><li data-type='method'><a href="module-alliance-tabs.html#~updateManagementTabVisibility">updateManagementTabVisibility</a></li><li data-type='method'><a href="module-alliance-tabs.html#~updateTabVisibilityForAllianceMembers">updateTabVisibilityForAllianceMembers</a></li><li data-type='method'><a href="module-alliance-tabs.html#~updateTabVisibilityForNonMembers">updateTabVisibilityForNonMembers</a></li><li data-type='method'><a href="module-alliance-tabs.html#~updateUserRole">updateUserRole</a></li><li data-type='method'><a href="module-alliance-tabs.html#~updateWelcomeMessageCharCount">updateWelcomeMessageCharCount</a></li></ul></li><li><a href="module-api.html">api</a><ul class='methods'><li data-type='method'><a href="module-api.html#.activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-api.html#.deleteAllLogs">deleteAllLogs</a></li><li data-type='method'><a href="module-api.html#.deleteChat">deleteChat</a></li><li data-type='method'><a href="module-api.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-api.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-api.html#.departVessels">departVessels</a></li><li data-type='method'><a href="module-api.html#.doWearMaintenanceBulk">doWearMaintenanceBulk</a></li><li data-type='method'><a href="module-api.html#.downloadLogbookExport">downloadLogbookExport</a></li><li data-type='method'><a href="module-api.html#.fetchAcquirableVessels">fetchAcquirableVessels</a></li><li data-type='method'><a href="module-api.html#.fetchAllianceMembers">fetchAllianceMembers</a></li><li data-type='method'><a href="module-api.html#.fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-api.html#.fetchBunkerPrices">fetchBunkerPrices</a></li><li data-type='method'><a href="module-api.html#.fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-api.html#.fetchChat">fetchChat</a></li><li data-type='method'><a href="module-api.html#.fetchContacts">fetchContacts</a></li><li data-type='method'><a href="module-api.html#.fetchLogbookEntries">fetchLogbookEntries</a></li><li data-type='method'><a href="module-api.html#.fetchLogbookFileSize">fetchLogbookFileSize</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerChats">fetchMessengerChats</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerMessages">fetchMessengerMessages</a></li><li data-type='method'><a href="module-api.html#.fetchUserCompany">fetchUserCompany</a></li><li data-type='method'><a href="module-api.html#.fetchUserSettings">fetchUserSettings</a></li><li data-type='method'><a href="module-api.html#.fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-api.html#.getCompanyNameCached">getCompanyNameCached</a></li><li data-type='method'><a href="module-api.html#.getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-api.html#.markChatAsRead">markChatAsRead</a></li><li data-type='method'><a href="module-api.html#.purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-api.html#.purchaseFuel">purchaseFuel</a></li><li data-type='method'><a href="module-api.html#.purchaseVessel">purchaseVessel</a></li><li data-type='method'><a href="module-api.html#.searchUsers">searchUsers</a></li><li data-type='method'><a href="module-api.html#.sendChatMessage">sendChatMessage</a></li><li data-type='method'><a href="module-api.html#.sendPrivateMessage">sendPrivateMessage</a></li></ul></li><li><a href="module-app.html">app</a></li><li><a href="module-automation.html">automation</a><ul class='methods'><li data-type='method'><a href="module-automation.html#.initAutomation">initAutomation</a></li><li data-type='method'><a href="module-automation.html#.runAutomationChecks">runAutomationChecks</a></li><li data-type='method'><a href="module-automation.html#.triggerAutoRebuyChecks">triggerAutoRebuyChecks</a></li><li data-type='method'><a href="module-automation.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-automation.html#~checkAutoCampaignRenewal">checkAutoCampaignRenewal</a></li><li data-type='method'><a href="module-automation.html#~checkAutoDepartAll">checkAutoDepartAll</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyCO2">checkAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyFuel">checkAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~getTotalCapacity">getTotalCapacity</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyCO2">performAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyFuel">performAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~updateAutoDepartLabel">updateAutoDepartLabel</a></li></ul></li><li><a href="module-badge-manager.html">badge-manager</a><ul class='methods'><li data-type='method'><a href="module-badge-manager.html#.getBadgeCount">getBadgeCount</a></li><li data-type='method'><a href="module-badge-manager.html#.hideBadge">hideBadge</a></li><li data-type='method'><a href="module-badge-manager.html#.showBadge">showBadge</a></li><li data-type='method'><a href="module-badge-manager.html#.updateBadge">updateBadge</a></li><li data-type='method'><a href="module-badge-manager.html#.updateButtonState">updateButtonState</a></li><li data-type='method'><a href="module-badge-manager.html#.updateButtonTooltip">updateButtonTooltip</a></li><li data-type='method'><a href="module-badge-manager.html#.updateButtonVisibility">updateButtonVisibility</a></li></ul></li><li><a href="module-bunker-management.html">bunker-management</a><ul class='methods'><li data-type='method'><a href="module-bunker-management.html#.buyMaxCO2">buyMaxCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.buyMaxFuel">buyMaxFuel</a></li><li data-type='method'><a href="module-bunker-management.html#.getCurrentBunkerState">getCurrentBunkerState</a></li><li data-type='method'><a href="module-bunker-management.html#.setCapacityFromBunkerUpdate">setCapacityFromBunkerUpdate</a></li><li data-type='method'><a href="module-bunker-management.html#.updateBunkerStatus">updateBunkerStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCO2">updateCurrentCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCash">updateCurrentCash</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentFuel">updateCurrentFuel</a></li></ul></li><li><a href="module-chat.html">chat</a><ul class='methods'><li data-type='method'><a href="module-chat.html#.displayMessages">displayMessages</a></li><li data-type='method'><a href="module-chat.html#.handleMessageInput">handleMessageInput</a></li><li data-type='method'><a href="module-chat.html#.initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-chat.html#.loadAllianceMembers">loadAllianceMembers</a></li><li data-type='method'><a href="module-chat.html#.loadMessages">loadMessages</a></li><li data-type='method'><a href="module-chat.html#.markAllianceChatAsRead">markAllianceChatAsRead</a></li><li data-type='method'><a href="module-chat.html#.parseMessageWithMentions">parseMessageWithMentions</a></li><li data-type='method'><a href="module-chat.html#.sendMessage">sendMessage</a></li><li data-type='method'><a href="module-chat.html#.setChatScrollListener">setChatScrollListener</a></li><li data-type='method'><a href="module-chat.html#~attemptReconnect">attemptReconnect</a></li><li data-type='method'><a href="module-chat.html#~displaySuggestions">displaySuggestions</a></li><li data-type='method'><a href="module-chat.html#~formatLocalTime">formatLocalTime</a></li><li data-type='method'><a href="module-chat.html#~handleAllianceChanged">handleAllianceChanged</a></li><li data-type='method'><a href="module-chat.html#~handleAllianceIndexReady">handleAllianceIndexReady</a></li><li data-type='method'><a href="module-chat.html#~handleAutoCoopComplete">handleAutoCoopComplete</a></li><li data-type='method'><a href="module-chat.html#~handleAutoCoopNoTargets">handleAutoCoopNoTargets</a></li><li data-type='method'><a href="module-chat.html#~handleAutopilotDepartStart">handleAutopilotDepartStart</a></li><li data-type='method'><a href="module-chat.html#~handleBackendAutoRepairComplete">handleBackendAutoRepairComplete</a></li><li data-type='method'><a href="module-chat.html#~handleBunkerUpdate">handleBunkerUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleCO2Purchased">handleCO2Purchased</a></li><li data-type='method'><a href="module-chat.html#~handleCampaignsRenewed">handleCampaignsRenewed</a></li><li data-type='method'><a href="module-chat.html#~handleCompanyTypeUpdate">handleCompanyTypeUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleCoopUpdate">handleCoopUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleDrydockCountUpdate">handleDrydockCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleFuelPurchased">handleFuelPurchased</a></li><li data-type='method'><a href="module-chat.html#~handleGenericNotification">handleGenericNotification</a></li><li data-type='method'><a href="module-chat.html#~handleHarborMapRefreshRequired">handleHarborMapRefreshRequired</a></li><li data-type='method'><a href="module-chat.html#~handleHeaderDataUpdate">handleHeaderDataUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleHijackingUpdate">handleHijackingUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleMentionAutocomplete">handleMentionAutocomplete</a></li><li data-type='method'><a href="module-chat.html#~handleMessengerUpdate">handleMessengerUpdate</a></li><li data-type='method'><a href="module-chat.html#~handlePriceAlert">handlePriceAlert</a></li><li data-type='method'><a href="module-chat.html#~handlePriceUpdate">handlePriceUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleRepairCountUpdate">handleRepairCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleStaffTrainingPointsUpdate">handleStaffTrainingPointsUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleStaffUpdate">handleStaffUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleUnreadMessagesUpdate">handleUnreadMessagesUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleUserActionNotification">handleUserActionNotification</a></li><li data-type='method'><a href="module-chat.html#~handleVesselCountUpdate">handleVesselCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDepartBatch">handleVesselsDepartBatch</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDepartComplete">handleVesselsDepartComplete</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDeparted">handleVesselsDeparted</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDrydocked">handleVesselsDrydocked</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsFailed">handleVesselsFailed</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsRepaired">handleVesselsRepaired</a></li><li data-type='method'><a href="module-chat.html#~hideMemberSuggestions">hideMemberSuggestions</a></li><li data-type='method'><a href="module-chat.html#~insertMention">insertMention</a></li><li data-type='method'><a href="module-chat.html#~registerUsernameClickEvents">registerUsernameClickEvents</a></li><li data-type='method'><a href="module-chat.html#~updateAllianceChatBadge">updateAllianceChatBadge</a></li></ul></li><li><a href="module-company-profile.html">company-profile</a><ul class='methods'><li data-type='method'><a href="module-company-profile.html#.closeCompanyProfile">closeCompanyProfile</a></li><li data-type='method'><a href="module-company-profile.html#.initCompanyProfile">initCompanyProfile</a></li><li data-type='method'><a href="module-company-profile.html#.openCompanyProfile">openCompanyProfile</a></li><li data-type='method'><a href="module-company-profile.html#.openPlayerProfile">openPlayerProfile</a></li><li data-type='method'><a href="module-company-profile.html#~adjustSalary">adjustSalary</a></li><li data-type='method'><a href="module-company-profile.html#~attachAllianceClickListener">attachAllianceClickListener</a></li><li data-type='method'><a href="module-company-profile.html#~attachSalaryButtonListeners">attachSalaryButtonListeners</a></li><li data-type='method'><a href="module-company-profile.html#~buildAchievementsSection">buildAchievementsSection</a></li><li data-type='method'><a href="module-company-profile.html#~buildSection">buildSection</a></li><li data-type='method'><a href="module-company-profile.html#~buildStaffSection">buildStaffSection</a></li><li data-type='method'><a href="module-company-profile.html#~formatLabel">formatLabel</a></li><li data-type='method'><a href="module-company-profile.html#~formatMoraleLabel">formatMoraleLabel</a></li><li data-type='method'><a href="module-company-profile.html#~formatPerkName">formatPerkName</a></li><li data-type='method'><a href="module-company-profile.html#~formatValue">formatValue</a></li><li data-type='method'><a href="module-company-profile.html#~generateMoraleSmiley">generateMoraleSmiley</a></li><li data-type='method'><a href="module-company-profile.html#~loadCompanyProfile">loadCompanyProfile</a></li><li data-type='method'><a href="module-company-profile.html#~loadStaffData">loadStaffData</a></li><li data-type='method'><a href="module-company-profile.html#~renderCompanyProfile">renderCompanyProfile</a></li><li data-type='method'><a href="module-company-profile.html#~renderSearchResults">renderSearchResults</a></li><li data-type='method'><a href="module-company-profile.html#~searchPlayers">searchPlayers</a></li><li data-type='method'><a href="module-company-profile.html#~toggleAchievementsList">toggleAchievementsList</a></li><li data-type='method'><a href="module-company-profile.html#~toggleStaffDetails">toggleStaffDetails</a></li><li data-type='method'><a href="module-company-profile.html#~trainPerk">trainPerk</a></li></ul></li><li><a href="module-coop.html">coop</a><ul class='methods'><li data-type='method'><a href="module-coop.html#.closeCoopOverlay">closeCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.fetchCoopData">fetchCoopData</a></li><li data-type='method'><a href="module-coop.html#.sendCoopMax">sendCoopMax</a></li><li data-type='method'><a href="module-coop.html#.showCoopOverlay">showCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.updateCoopBadge">updateCoopBadge</a></li><li data-type='method'><a href="module-coop.html#~renderMemberCard">renderMemberCard</a></li></ul></li><li><a href="module-core_app-initializer.html">core/app-initializer</a><ul class='methods'><li data-type='method'><a href="module-core_app-initializer.html#.initializeApp">initializeApp</a></li><li data-type='method'><a href="module-core_app-initializer.html#~createAllianceChatHandler">createAllianceChatHandler</a></li><li data-type='method'><a href="module-core_app-initializer.html#~createBuyVesselsHandler">createBuyVesselsHandler</a></li><li data-type='method'><a href="module-core_app-initializer.html#~createDebouncedFunctions">createDebouncedFunctions</a></li><li data-type='method'><a href="module-core_app-initializer.html#~createForecastHandler">createForecastHandler</a></li><li data-type='method'><a href="module-core_app-initializer.html#~createTestBrowserNotification">createTestBrowserNotification</a></li><li data-type='method'><a href="module-core_app-initializer.html#~exposeGlobalFunctions">exposeGlobalFunctions</a></li><li data-type='method'><a href="module-core_app-initializer.html#~formatNumberWithSeparator">formatNumberWithSeparator</a></li><li data-type='method'><a href="module-core_app-initializer.html#~initializeSettingsUI">initializeSettingsUI</a></li><li data-type='method'><a href="module-core_app-initializer.html#~loadInitialData">loadInitialData</a></li><li data-type='method'><a href="module-core_app-initializer.html#~loadUserSettings">loadUserSettings</a></li><li data-type='method'><a href="module-core_app-initializer.html#~registerAllEventListeners">registerAllEventListeners</a></li><li data-type='method'><a href="module-core_app-initializer.html#~setCheckboxState">setCheckboxState</a></li><li data-type='method'><a href="module-core_app-initializer.html#~setCheckboxValue">setCheckboxValue</a></li><li data-type='method'><a href="module-core_app-initializer.html#~setFormattedInputValue">setFormattedInputValue</a></li><li data-type='method'><a href="module-core_app-initializer.html#~setInputValue">setInputValue</a></li><li data-type='method'><a href="module-core_app-initializer.html#~toggleElementVisibility">toggleElementVisibility</a></li></ul></li><li><a href="module-core_auto-refresh.html">core/auto-refresh</a><ul class='methods'><li data-type='method'><a href="module-core_auto-refresh.html#.getActiveIntervals">getActiveIntervals</a></li><li data-type='method'><a href="module-core_auto-refresh.html#.initNotificationButtonUpdater">initNotificationButtonUpdater</a></li><li data-type='method'><a href="module-core_auto-refresh.html#.initVersionChecker">initVersionChecker</a></li><li data-type='method'><a href="module-core_auto-refresh.html#.initVisibilityHandler">initVisibilityHandler</a></li><li data-type='method'><a href="module-core_auto-refresh.html#.preloadAllImages">preloadAllImages</a></li><li data-type='method'><a href="module-core_auto-refresh.html#.stopAllIntervals">stopAllIntervals</a></li><li data-type='method'><a href="module-core_auto-refresh.html#.stopInterval">stopInterval</a></li></ul></li><li><a href="module-core_badge-cache.html">core/badge-cache</a><ul class='methods'><li data-type='method'><a href="module-core_badge-cache.html#.loadCache">loadCache</a></li><li data-type='method'><a href="module-core_badge-cache.html#.saveBadgeCache">saveBadgeCache</a></li><li data-type='method'><a href="module-core_badge-cache.html#.updateCoopDisplay">updateCoopDisplay</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadBunkerStatus">loadBunkerStatus</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadCampaignsBadge">loadCampaignsBadge</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadCoopData">loadCoopData</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadHijackingBadge">loadHijackingBadge</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadPrices">loadPrices</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadRepairBadges">loadRepairBadges</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadStockAndAnchor">loadStockAndAnchor</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadVesselBadges">loadVesselBadges</a></li></ul></li><li><a href="module-core_debounced-api.html">core/debounced-api</a><ul class='methods'><li data-type='method'><a href="module-core_debounced-api.html#.cancelAllDebouncedFunctions">cancelAllDebouncedFunctions</a></li><li data-type='method'><a href="module-core_debounced-api.html#.cancelDebouncedFunction">cancelDebouncedFunction</a></li><li data-type='method'><a href="module-core_debounced-api.html#.createDebouncedFunction">createDebouncedFunction</a></li><li data-type='method'><a href="module-core_debounced-api.html#.isDebouncePending">isDebouncePending</a></li></ul></li><li><a href="module-core_event-registry.html">core/event-registry</a><ul class='methods'><li data-type='method'><a href="module-core_event-registry.html#.registerAutoDepartSettingsListeners">registerAutoDepartSettingsListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerAutoPilotFeatureListeners">registerAutoPilotFeatureListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerAutoPilotListeners">registerAutoPilotListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerAutoRebuyCO2Listeners">registerAutoRebuyCO2Listeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerAutoRebuyFuelListeners">registerAutoRebuyFuelListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerBunkerListeners">registerBunkerListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerChatBotSettingsListeners">registerChatBotSettingsListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerChatEventListeners">registerChatEventListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerCustomCommandsListeners">registerCustomCommandsListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerDialogEventListeners">registerDialogEventListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerMessengerEventListeners">registerMessengerEventListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerNotificationPermissionListener">registerNotificationPermissionListener</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerNumberFormatting">registerNumberFormatting</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerSectionToggle">registerSectionToggle</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerSettingsThresholdListeners">registerSettingsThresholdListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerVesselCatalogEventListeners">registerVesselCatalogEventListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#~createCustomCommandElement">createCustomCommandElement</a></li><li data-type='method'><a href="module-core_event-registry.html#~formatNumberWithSeparator">formatNumberWithSeparator</a></li></ul></li><li><a href="module-core_global-exports.html">core/global-exports</a><ul class='methods'><li data-type='method'><a href="module-core_global-exports.html#.exportApiUrl">exportApiUrl</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportAutopilotFunctions">exportAutopilotFunctions</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportCacheKeys">exportCacheKeys</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportDebouncedFunctions">exportDebouncedFunctions</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportDebugMode">exportDebugMode</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportGlobals">exportGlobals</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportLogbookHandler">exportLogbookHandler</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportOverlayFunctions">exportOverlayFunctions</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportSettingsHandler">exportSettingsHandler</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportStorageFunctions">exportStorageFunctions</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportVersionFunctions">exportVersionFunctions</a></li></ul></li><li><a href="module-core_settings-sync.html">core/settings-sync</a><ul class='methods'><li data-type='method'><a href="module-core_settings-sync.html#.handleSettingsUpdate">handleSettingsUpdate</a></li><li data-type='method'><a href="module-core_settings-sync.html#.toggleAutoPilotAgentCheckboxes">toggleAutoPilotAgentCheckboxes</a></li><li data-type='method'><a href="module-core_settings-sync.html#~formatNumberWithSeparator">formatNumberWithSeparator</a></li><li data-type='method'><a href="module-core_settings-sync.html#~updateAutoPilotToggles">updateAutoPilotToggles</a></li><li data-type='method'><a href="module-core_settings-sync.html#~updateAutoRebuyCO2UI">updateAutoRebuyCO2UI</a></li><li data-type='method'><a href="module-core_settings-sync.html#~updateAutoRebuyFuelUI">updateAutoRebuyFuelUI</a></li><li data-type='method'><a href="module-core_settings-sync.html#~updateChatBotSettings">updateChatBotSettings</a></li><li data-type='method'><a href="module-core_settings-sync.html#~updateNotificationSettings">updateNotificationSettings</a></li><li data-type='method'><a href="module-core_settings-sync.html#~updateThresholdInputs">updateThresholdInputs</a></li></ul></li><li><a href="module-core_storage-manager.html">core/storage-manager</a><ul class='methods'><li data-type='method'><a href="module-core_storage-manager.html#.clearUserStorage">clearUserStorage</a></li><li data-type='method'><a href="module-core_storage-manager.html#.getStorage">getStorage</a></li><li data-type='method'><a href="module-core_storage-manager.html#.getUserStorageKey">getUserStorageKey</a></li><li data-type='method'><a href="module-core_storage-manager.html#.getUserStoragePrefix">getUserStoragePrefix</a></li><li data-type='method'><a href="module-core_storage-manager.html#.removeStorage">removeStorage</a></li><li data-type='method'><a href="module-core_storage-manager.html#.setStorage">setStorage</a></li><li data-type='method'><a href="module-core_storage-manager.html#.setUserStoragePrefix">setUserStoragePrefix</a></li></ul></li><li><a href="module-core_websocket-client.html">core/websocket-client</a><ul class='methods'><li data-type='method'><a href="module-core_websocket-client.html#.getWebSocketState">getWebSocketState</a></li><li data-type='method'><a href="module-core_websocket-client.html#.incrementReconnectCounter">incrementReconnectCounter</a></li><li data-type='method'><a href="module-core_websocket-client.html#.initAutopilotControls">initAutopilotControls</a></li><li data-type='method'><a href="module-core_websocket-client.html#.loadAutopilotState">loadAutopilotState</a></li><li data-type='method'><a href="module-core_websocket-client.html#.resetReconnectCounter">resetReconnectCounter</a></li><li data-type='method'><a href="module-core_websocket-client.html#.triggerPriceAlertCheck">triggerPriceAlertCheck</a></li><li data-type='method'><a href="module-core_websocket-client.html#.updateWebSocketState">updateWebSocketState</a></li></ul></li><li><a href="module-depart-manager.html">depart-manager</a><ul class='methods'><li data-type='method'><a href="module-depart-manager.html#.closeDepartManager">closeDepartManager</a></li><li data-type='method'><a href="module-depart-manager.html#.initializeDepartManager">initializeDepartManager</a></li><li data-type='method'><a href="module-depart-manager.html#.openDepartManager">openDepartManager</a></li><li data-type='method'><a href="module-depart-manager.html#.toggleDepartManager">toggleDepartManager</a></li><li data-type='method'><a href="module-depart-manager.html#~departSelectedVessels">departSelectedVessels</a></li><li data-type='method'><a href="module-depart-manager.html#~drag">drag</a></li><li data-type='method'><a href="module-depart-manager.html#~loadDepartableVessels">loadDepartableVessels</a></li><li data-type='method'><a href="module-depart-manager.html#~locateVesselOnMap">locateVesselOnMap</a></li><li data-type='method'><a href="module-depart-manager.html#~selectAllVessels">selectAllVessels</a></li><li data-type='method'><a href="module-depart-manager.html#~selectRouteInMapFilter">selectRouteInMapFilter</a></li><li data-type='method'><a href="module-depart-manager.html#~startDrag">startDrag</a></li><li data-type='method'><a href="module-depart-manager.html#~stopDrag">stopDrag</a></li><li data-type='method'><a href="module-depart-manager.html#~unselectAllVessels">unselectAllVessels</a></li><li data-type='method'><a href="module-depart-manager.html#~updateDepartButtonCount">updateDepartButtonCount</a></li></ul></li><li><a href="module-desktop-notification-templates.html">desktop-notification-templates</a><ul class='methods'><li data-type='method'><a href="module-desktop-notification-templates.html#.createDesktopNotification">createDesktopNotification</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.getDefaultEmoji">getDefaultEmoji</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.getNotificationTypes">getNotificationTypes</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.isValidNotificationType">isValidNotificationType</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyAlert">notifyAlert</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyError">notifyError</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifySuccess">notifySuccess</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyWarning">notifyWarning</a></li></ul></li><li><a href="module-event-info.html">event-info</a><ul class='methods'><li data-type='method'><a href="module-event-info.html#.initEventInfo">initEventInfo</a></li><li data-type='method'><a href="module-event-info.html#.openEventModal">openEventModal</a></li><li data-type='method'><a href="module-event-info.html#.updateEventData">updateEventData</a></li><li data-type='method'><a href="module-event-info.html#~startEventTimer">startEventTimer</a></li></ul></li><li><a href="module-forecast-calendar.html">forecast-calendar</a><ul class='methods'><li data-type='method'><a href="module-forecast-calendar.html#.initForecastCalendar">initForecastCalendar</a></li><li data-type='method'><a href="module-forecast-calendar.html#.updateEventDiscount">updateEventDiscount</a></li><li data-type='method'><a href="module-forecast-calendar.html#~createTableHTML">createTableHTML</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getBrowserTimezone">getBrowserTimezone</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getCo2Class">getCo2Class</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getCurrentVisibleDay">getCurrentVisibleDay</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getFuelClass">getFuelClass</a></li><li data-type='method'><a href="module-forecast-calendar.html#~isEventActiveAtTime">isEventActiveAtTime</a></li><li data-type='method'><a href="module-forecast-calendar.html#~isEventActiveOnDay">isEventActiveOnDay</a></li><li data-type='method'><a href="module-forecast-calendar.html#~loadForecastData">loadForecastData</a></li><li data-type='method'><a href="module-forecast-calendar.html#~preloadMonth">preloadMonth</a></li><li data-type='method'><a href="module-forecast-calendar.html#~renderBook">renderBook</a></li><li data-type='method'><a href="module-forecast-calendar.html#~updateEventBadge">updateEventBadge</a></li></ul></li><li><a href="module-harbor-map-aggregator.html">harbor-map-aggregator</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-aggregator.html#~aggregateReachablePorts">aggregateReachablePorts</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~aggregateVesselData">aggregateVesselData</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~categorizeVesselsByPort">categorizeVesselsByPort</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~extractPortsFromGameIndex">extractPortsFromGameIndex</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~extractVesselsFromGameIndex">extractVesselsFromGameIndex</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~filterAssignedPorts">filterAssignedPorts</a></li></ul></li><li><a href="module-harbor-map-calculator.html">harbor-map-calculator</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateCargoUtilization">calculateCargoUtilization</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateDemandLevel">calculateDemandLevel</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateETA">calculateETA</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateVesselPosition">calculateVesselPosition</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~formatCargoCapacity">formatCargoCapacity</a></li></ul></li><li><a href="module-harbor-map-init.html">harbor-map-init</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-init.html#.closeHarborMap">closeHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.initHarborMap">initHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.openHarborMap">openHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.preloadHarborMapData">preloadHarborMapData</a></li><li data-type='method'><a href="module-harbor-map-init.html#.refreshHarborMapIfOpen">refreshHarborMapIfOpen</a></li><li data-type='method'><a href="module-harbor-map-init.html#.reloadMap">reloadMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.startHarborMapAutoUpdate">startHarborMapAutoUpdate</a></li><li data-type='method'><a href="module-harbor-map-init.html#.stopHarborMapAutoUpdate">stopHarborMapAutoUpdate</a></li><li data-type='method'><a href="module-harbor-map-init.html#~departVesselWrapper">departVesselWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~getVesselByIdWrapper">getVesselByIdWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~selectVesselFromMap">selectVesselFromMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#~sellVesselFromPanelWrapper">sellVesselFromPanelWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~updateVesselMarkerWrapper">updateVesselMarkerWrapper</a></li></ul></li><li><a href="module-harbor-map_api-client.html">harbor-map/api-client</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_api-client.html#.clearHarborMapCache">clearHarborMapCache</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.exportVesselHistory">exportVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchHarborMapOverview">fetchHarborMapOverview</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchPortDetails">fetchPortDetails</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchVesselHistory">fetchVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchVesselReachablePorts">fetchVesselReachablePorts</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.getCachedOverview">getCachedOverview</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.invalidateOverviewCache">invalidateOverviewCache</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.prefetchHarborMapData">prefetchHarborMapData</a></li></ul></li><li><a href="module-harbor-map_filters.html">harbor-map/filters</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_filters.html#.filterPorts">filterPorts</a></li><li data-type='method'><a href="module-harbor-map_filters.html#.filterVessels">filterVessels</a></li><li data-type='method'><a href="module-harbor-map_filters.html#.getPortFilterOptions">getPortFilterOptions</a></li><li data-type='method'><a href="module-harbor-map_filters.html#.getVesselFilterOptions">getVesselFilterOptions</a></li><li data-type='method'><a href="module-harbor-map_filters.html#~calculateVesselUtilization">calculateVesselUtilization</a></li></ul></li><li><a href="module-harbor-map_map-controller.html">harbor-map/map-controller</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_map-controller.html#.clearRoute">clearRoute</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.closeAllPanels">closeAllPanels</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.deselectAll">deselectAll</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.drawRoute">drawRoute</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getCurrentPorts">getCurrentPorts</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getMap">getMap</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getSelectedPortCode">getSelectedPortCode</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getVesselById">getVesselById</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.initMap">initMap</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.loadOverview">loadOverview</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.renderPorts">renderPorts</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.renderVessels">renderVessels</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.selectPort">selectPort</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.selectVessel">selectVessel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.setPortFilter">setPortFilter</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.setRouteFilter">setRouteFilter</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.setVesselFilter">setVesselFilter</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.updateVesselMarker">updateVesselMarker</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.updateWeatherDataSetting">updateWeatherDataSetting</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~addCustomControls">addCustomControls</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~applyFiltersAndRender">applyFiltersAndRender</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~applyMapTheme">applyMapTheme</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~calculateHeading">calculateHeading</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~categorizeVesselsByPortClientSide">categorizeVesselsByPortClientSide</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~changeTileLayer">changeTileLayer</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~createVesselIcon">createVesselIcon</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~getVesselType">getVesselType</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~hideRouteVesselsPanel">hideRouteVesselsPanel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~showRouteVesselsPanel">showRouteVesselsPanel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~showWeatherInfo">showWeatherInfo</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~toggleWeatherLayer">toggleWeatherLayer</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~updateRouteDropdown">updateRouteDropdown</a></li></ul></li><li><a href="module-harbor-map_panel-drag.html">harbor-map/panel-drag</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_panel-drag.html#.initializePanelDrag">initializePanelDrag</a></li></ul></li><li><a href="module-harbor-map_port-panel.html">harbor-map/port-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_port-panel.html#.closePortPanel">closePortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.hidePortPanel">hidePortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.selectVesselFromPort">selectVesselFromPort</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.showPortPanel">showPortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#~loadPortWeather">loadPortWeather</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#~renderDemandSection">renderDemandSection</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#~renderVesselList">renderVesselList</a></li></ul></li><li><a href="module-harbor-map_route-vessels-panel.html">harbor-map/route-vessels-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.closeRoutePanel">closeRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.hideRoutePanel">hideRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.selectRouteVessel">selectRouteVessel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.showRoutePanel">showRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#~storeVessels">storeVessels</a></li></ul></li><li><a href="module-harbor-map_vessel-panel.html">harbor-map/vessel-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.closeVesselPanel">closeVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.exportHistoryFormat">exportHistoryFormat</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.hideVesselPanel">hideVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.sellVesselFromPanel">sellVesselFromPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.showVesselPanel">showVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.startRenameVessel">startRenameVessel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.toggleExportMenu">toggleExportMenu</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~cancelVesselRename">cancelVesselRename</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~closeExportMenuOnClickOutside">closeExportMenuOnClickOutside</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~getCountryFlag">getCountryFlag</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~getPortCountryCode">getPortCountryCode</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~loadVesselHistory">loadVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~loadVesselWeather">loadVesselWeather</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~openRepairDialog">openRepairDialog</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~processDepartureQueue">processDepartureQueue</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~renderHistoryPage">renderHistoryPage</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~saveVesselRename">saveVesselRename</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~setupInfiniteScroll">setupInfiniteScroll</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~toggleParkVessel">toggleParkVessel</a></li></ul></li><li><a href="module-logbook.html">logbook</a><ul class='methods'><li data-type='method'><a href="module-logbook.html#.deleteAllLogsConfirmed">deleteAllLogsConfirmed</a></li><li data-type='method'><a href="module-logbook.html#.getLogFileSize">getLogFileSize</a></li><li data-type='method'><a href="module-logbook.html#.initLogbook">initLogbook</a></li><li data-type='method'><a href="module-logbook.html#.prependLogEntry">prependLogEntry</a></li><li data-type='method'><a href="module-logbook.html#~convertActionFilterToBackend">convertActionFilterToBackend</a></li><li data-type='method'><a href="module-logbook.html#~exportLogs">exportLogs</a></li><li data-type='method'><a href="module-logbook.html#~formatDetails">formatDetails</a></li><li data-type='method'><a href="module-logbook.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-logbook.html#~getTransactionType">getTransactionType</a></li><li data-type='method'><a href="module-logbook.html#~loadLogs">loadLogs</a></li><li data-type='method'><a href="module-logbook.html#~renderLogTable">renderLogTable</a></li><li data-type='method'><a href="module-logbook.html#~updateActionFilter">updateActionFilter</a></li></ul></li><li><a href="module-map-icon-bar.html">map-icon-bar</a><ul class='methods'><li data-type='method'><a href="module-map-icon-bar.html#.initializeMapIconBar">initializeMapIconBar</a></li><li data-type='method'><a href="module-map-icon-bar.html#~handleIconAction">handleIconAction</a></li></ul></li><li><a href="module-messenger.html">messenger</a><ul class='methods'><li data-type='method'><a href="module-messenger.html#.closeAllChats">closeAllChats</a></li><li data-type='method'><a href="module-messenger.html#.closeChatSelection">closeChatSelection</a></li><li data-type='method'><a href="module-messenger.html#.openMessenger">openMessenger</a></li><li data-type='method'><a href="module-messenger.html#.openNewChat">openNewChat</a></li><li data-type='method'><a href="module-messenger.html#.showAllChats">showAllChats</a></li><li data-type='method'><a href="module-messenger.html#.updateUnreadBadge">updateUnreadBadge</a></li><li data-type='method'><a href="module-messenger.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-messenger.html#~loadPrivateMessages">loadPrivateMessages</a></li><li data-type='method'><a href="module-messenger.html#~stopHijackingPolling">stopHijackingPolling</a></li></ul></li><li><a href="module-public_js_modules_hijacking.html">public/js/modules/hijacking</a><ul class='methods'><li data-type='method'><a href="module-public_js_modules_hijacking.html#.closeHijackingInbox">closeHijackingInbox</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.openHijackingInbox">openHijackingInbox</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.updateHijackedVesselsDisplay">updateHijackedVesselsDisplay</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.updateHijackingBadge">updateHijackingBadge</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~deleteCase">deleteCase</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~openCaseDetails">openCaseDetails</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~refreshHijackingBadge">refreshHijackingBadge</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~renderCaseList">renderCaseList</a></li></ul></li><li><a href="module-server_automation.html">server/automation</a><ul class='methods'><li data-type='method'><a href="module-server_automation.html#~getRandomInterval">getRandomInterval</a></li><li data-type='method'><a href="module-server_automation.html#~initialize">initialize</a></li><li data-type='method'><a href="module-server_automation.html#~loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_automation.html#~parseInterval">parseInterval</a></li><li data-type='method'><a href="module-server_automation.html#~restartAutoRepair">restartAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~runAutoRepair">runAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~scheduleAutoRepair">scheduleAutoRepair</a></li></ul></li><li><a href="module-server_autopilot.html">server/autopilot</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot.html#~analyzeVesselDepartures">analyzeVesselDepartures</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoRebuyAll">autoRebuyAll</a></li><li data-type='method'><a href="module-server_autopilot.html#~checkPriceAlerts">checkPriceAlerts</a></li><li data-type='method'><a href="module-server_autopilot.html#~countActiveCampaignTypes">countActiveCampaignTypes</a></li><li data-type='method'><a href="module-server_autopilot.html#~initializeAutopilotState">initializeAutopilotState</a></li><li data-type='method'><a href="module-server_autopilot.html#~isAutopilotPaused">isAutopilotPaused</a></li><li data-type='method'><a href="module-server_autopilot.html#~mainEventLoop">mainEventLoop</a></li><li data-type='method'><a href="module-server_autopilot.html#~pauseAutopilot">pauseAutopilot</a></li><li data-type='method'><a href="module-server_autopilot.html#~resumeAutopilot">resumeAutopilot</a></li><li data-type='method'><a href="module-server_autopilot.html#~setBroadcastFunction">setBroadcastFunction</a></li><li data-type='method'><a href="module-server_autopilot.html#~startMainEventLoop">startMainEventLoop</a></li><li data-type='method'><a href="module-server_autopilot.html#~tryUpdateAllData">tryUpdateAllData</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateAllData">updateAllData</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateCampaigns">updateCampaigns</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateDrydockCount">updateDrydockCount</a></li><li data-type='method'><a href="module-server_autopilot.html#~updatePrices">updatePrices</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateRepairCount">updateRepairCount</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateUnreadMessages">updateUnreadMessages</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateVesselCount">updateVesselCount</a></li></ul></li><li><a href="module-server_autopilot_pilot_atmosphere_broker.html">server/autopilot/pilot_atmosphere_broker</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_atmosphere_broker.html#~autoRebuyCO2">autoRebuyCO2</a></li></ul></li><li><a href="module-server_autopilot_pilot_barrel_boss.html">server/autopilot/pilot_barrel_boss</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_barrel_boss.html#~autoRebuyFuel">autoRebuyFuel</a></li></ul></li><li><a href="module-server_autopilot_pilot_captain_blackbeard.html">server/autopilot/pilot_captain_blackbeard</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~acceptRansomWithRetry">acceptRansomWithRetry</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~autoNegotiateHijacking">autoNegotiateHijacking</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~getCaseWithRetry">getCaseWithRetry</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~processHijackingCase">processHijackingCase</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~submitOfferWithRetry">submitOfferWithRetry</a></li></ul></li><li><a href="module-server_autopilot_pilot_cargo_marshal.html">server/autopilot/pilot_cargo_marshal</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~autoDepartVessels">autoDepartVessels</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~departVessels">departVessels</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~getTotalCapacity">getTotalCapacity</a></li></ul></li><li><a href="module-server_autopilot_pilot_drydock_master.html">server/autopilot/pilot_drydock_master</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_drydock_master.html#~autoDrydockVessels">autoDrydockVessels</a></li></ul></li><li><a href="module-server_autopilot_pilot_fair_hand.html">server/autopilot/pilot_fair_hand</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_fair_hand.html#~autoCoop">autoCoop</a></li></ul></li><li><a href="module-server_autopilot_pilot_harbormaster.html">server/autopilot/pilot_harbormaster</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_harbormaster.html#~autoAnchorPointPurchase">autoAnchorPointPurchase</a></li><li data-type='method'><a href="module-server_autopilot_pilot_harbormaster.html#~setBroadcastFunction">setBroadcastFunction</a></li></ul></li><li><a href="module-server_autopilot_pilot_reputation_chief.html">server/autopilot/pilot_reputation_chief</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_reputation_chief.html#~autoCampaignRenewal">autoCampaignRenewal</a></li></ul></li><li><a href="module-server_autopilot_pilot_yard_foreman.html">server/autopilot/pilot_yard_foreman</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_yard_foreman.html#~autoRepairVessels">autoRepairVessels</a></li></ul></li><li><a href="module-server_cache.html">server/cache</a><ul class='methods'><li data-type='method'><a href="module-server_cache.html#~clearAllCaches">clearAllCaches</a></li><li data-type='method'><a href="module-server_cache.html#~getAllianceCache">getAllianceCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCampaignCache">getCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCompanyCache">getCompanyCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCoopCache">getCoopCache</a></li><li data-type='method'><a href="module-server_cache.html#~invalidateCampaignCache">invalidateCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~invalidateCoopCache">invalidateCoopCache</a></li><li data-type='method'><a href="module-server_cache.html#~isCacheValid">isCacheValid</a></li><li data-type='method'><a href="module-server_cache.html#~setAllianceCache">setAllianceCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCampaignCache">setCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCompanyCache">setCompanyCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCoopCache">setCoopCache</a></li></ul></li><li><a href="module-server_certificate.html">server/certificate</a><ul class='methods'><li data-type='method'><a href="module-server_certificate.html#~createHttpsServer">createHttpsServer</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCA">generateCA</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCertificate">generateCertificate</a></li><li data-type='method'><a href="module-server_certificate.html#~getNetworkIPs">getNetworkIPs</a></li><li data-type='method'><a href="module-server_certificate.html#~isCertificateInstalled">isCertificateInstalled</a></li><li data-type='method'><a href="module-server_certificate.html#~loadCertificate">loadCertificate</a></li></ul></li><li><a href="module-server_chatbot.html">server/chatbot</a></li><li><a href="module-server_chatbot_commands.html">server/chatbot/commands</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_commands.html#~generateForecastText">generateForecastText</a></li><li data-type='method'><a href="module-server_chatbot_commands.html#~handleForecastCommand">handleForecastCommand</a></li><li data-type='method'><a href="module-server_chatbot_commands.html#~handleHelpCommand">handleHelpCommand</a></li><li data-type='method'><a href="module-server_chatbot_commands.html#~handleWelcomeCommand">handleWelcomeCommand</a></li></ul></li><li><a href="module-server_chatbot_executor.html">server/chatbot/executor</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_executor.html#~executeCommand">executeCommand</a></li></ul></li><li><a href="module-server_chatbot_parser.html">server/chatbot/parser</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_parser.html#~findCustomCommand">findCustomCommand</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~hasManagementRole">hasManagementRole</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~isCommandAllowedInChannel">isCommandAllowedInChannel</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~isOnCooldown">isOnCooldown</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~processAllianceMessage">processAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~processPrivateMessage">processPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~resolveCommandName">resolveCommandName</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~updateCooldown">updateCooldown</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~validateCommandArguments">validateCommandArguments</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~validateForecastArguments">validateForecastArguments</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~validateWelcomeArguments">validateWelcomeArguments</a></li></ul></li><li><a href="module-server_chatbot_scheduler.html">server/chatbot/scheduler</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_scheduler.html#~scheduleDailyForecast">scheduleDailyForecast</a></li><li data-type='method'><a href="module-server_chatbot_scheduler.html#~sendDailyForecast">sendDailyForecast</a></li><li data-type='method'><a href="module-server_chatbot_scheduler.html#~setupScheduledTasks">setupScheduledTasks</a></li></ul></li><li><a href="module-server_chatbot_sender.html">server/chatbot/sender</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_sender.html#~sendAllianceMessage">sendAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot_sender.html#~sendErrorMessage">sendErrorMessage</a></li><li data-type='method'><a href="module-server_chatbot_sender.html#~sendPrivateMessage">sendPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot_sender.html#~sendResponse">sendResponse</a></li></ul></li><li><a href="module-server_chatbot_settings.html">server/chatbot/settings</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_settings.html#~getDefaultChatBotObject">getDefaultChatBotObject</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~hasManagementRole">hasManagementRole</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~mapChatBotObjectToFlatSettings">mapChatBotObjectToFlatSettings</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~mapSettingsToChatBotObject">mapSettingsToChatBotObject</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~updateSettings">updateSettings</a></li></ul></li><li><a href="module-server_config.html">server/config</a><ul class='methods'><li data-type='method'><a href="module-server_config.html#~getAppDataDir">getAppDataDir</a></li><li data-type='method'><a href="module-server_config.html#~getAppPlatformCookie">getAppPlatformCookie</a></li><li data-type='method'><a href="module-server_config.html#~getAppVersionCookie">getAppVersionCookie</a></li><li data-type='method'><a href="module-server_config.html#~getLocalAppDataDir">getLocalAppDataDir</a></li><li data-type='method'><a href="module-server_config.html#~getLogDir">getLogDir</a></li><li data-type='method'><a href="module-server_config.html#~getSessionCookie">getSessionCookie</a></li><li data-type='method'><a href="module-server_config.html#~getSettingsDir">getSettingsDir</a></li><li data-type='method'><a href="module-server_config.html#~loadStartupSettings">loadStartupSettings</a></li><li data-type='method'><a href="module-server_config.html#~setSessionCookie">setSessionCookie</a></li></ul></li><li><a href="module-server_gameapi.html">server/gameapi</a></li><li><a href="module-server_gameapi_bunker.html">server/gameapi/bunker</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi_bunker.html#~fetchBunkerState">fetchBunkerState</a></li><li data-type='method'><a href="module-server_gameapi_bunker.html#~fetchPrices">fetchPrices</a></li><li data-type='method'><a href="module-server_gameapi_bunker.html#~purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-server_gameapi_bunker.html#~purchaseFuel">purchaseFuel</a></li></ul></li><li><a href="module-server_gameapi_campaign.html">server/gameapi/campaign</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi_campaign.html#~activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-server_gameapi_campaign.html#~fetchCampaigns">fetchCampaigns</a></li></ul></li><li><a href="module-server_gameapi_maintenance.html">server/gameapi/maintenance</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi_maintenance.html#~bulkRepairVessels">bulkRepairVessels</a></li><li data-type='method'><a href="module-server_gameapi_maintenance.html#~fetchRepairCount">fetchRepairCount</a></li><li data-type='method'><a href="module-server_gameapi_maintenance.html#~getMaintenanceCost">getMaintenanceCost</a></li></ul></li><li><a href="module-server_gameapi_port.html">server/gameapi/port</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi_port.html#~fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-server_gameapi_port.html#~fetchAutoPrice">fetchAutoPrice</a></li><li data-type='method'><a href="module-server_gameapi_port.html#~getAssignedPorts">getAssignedPorts</a></li><li data-type='method'><a href="module-server_gameapi_port.html#~getRoutesByPorts">getRoutesByPorts</a></li><li data-type='method'><a href="module-server_gameapi_port.html#~getVesselPorts">getVesselPorts</a></li></ul></li><li><a href="module-server_gameapi_util.html">server/gameapi/util</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi_util.html#~fetchEventData">fetchEventData</a></li><li data-type='method'><a href="module-server_gameapi_util.html#~fetchUnreadMessages">fetchUnreadMessages</a></li><li data-type='method'><a href="module-server_gameapi_util.html#~getGameIndex">getGameIndex</a></li></ul></li><li><a href="module-server_gameapi_vessel.html">server/gameapi/vessel</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi_vessel.html#~departVessel">departVessel</a></li><li data-type='method'><a href="module-server_gameapi_vessel.html#~fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-server_gameapi_vessel.html#~getAllUserVessels">getAllUserVessels</a></li><li data-type='method'><a href="module-server_gameapi_vessel.html#~getVesselHistory">getVesselHistory</a></li></ul></li><li><a href="module-server_middleware_index.html">server/middleware/index</a><ul class='methods'><li data-type='method'><a href="module-server_middleware_index.html#~setupMiddleware">setupMiddleware</a></li></ul></li><li><a href="module-server_routes_alliance.html">server/routes/alliance</a><ul class='methods'><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-high-scores">GET /api/alliance-high-scores</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-info">GET /api/alliance-info</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-info/:id">GET /api/alliance-info/:id</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-members">GET /api/alliance-members</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-members/:id">GET /api/alliance-members/:id</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-settings">GET /api/alliance-settings</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/chat">GET /api/chat</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/league-info">GET /api/league-info</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/alliance-accept-user">POST /api/alliance-accept-user</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/alliance-decline-user">POST /api/alliance-decline-user</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/alliance-leave">POST /api/alliance-leave</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/alliance-queue-pool">POST /api/alliance-queue-pool</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/alliance-update-user-role">POST /api/alliance-update-user-role</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/chat/mark-read">POST /api/chat/mark-read</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/company-name">POST /api/company-name</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/send-message">POST /api/send-message</a></li></ul></li><li><a href="module-server_routes_alliance-logo.html">server/routes/alliance-logo</a></li><li><a href="module-server_routes_alliances.html">server/routes/alliances</a></li><li><a href="module-server_routes_anchor.html">server/routes/anchor</a></li><li><a href="module-server_routes_coop.html">server/routes/coop</a><ul class='methods'><li data-type='method'><a href="module-server_routes_coop.html#.GET/api/coop/data">GET /api/coop/data</a></li><li data-type='method'><a href="module-server_routes_coop.html#.POST/api/coop/send-max">POST /api/coop/send-max</a></li></ul></li><li><a href="module-server_routes_forecast.html">server/routes/forecast</a><ul class='methods'><li data-type='method'><a href="module-server_routes_forecast.html#~convertCESTToTimezone">convertCESTToTimezone</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~generateChatbotText">generateChatbotText</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~generateMetadata">generateMetadata</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getForecastDataPath">getForecastDataPath</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getNextDayData">getNextDayData</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getPreviousDayData">getPreviousDayData</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getServerLocalTimezone">getServerLocalTimezone</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getTimezoneOffsetHours">getTimezoneOffsetHours</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getValidTimezones">getValidTimezones</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~parseNumericOffset">parseNumericOffset</a></li></ul></li><li><a href="module-server_routes_game.html">server/routes/game</a></li><li><a href="module-server_routes_game_autopilot.html">server/routes/game/autopilot</a></li><li><a href="module-server_routes_game_bunker.html">server/routes/game/bunker</a></li><li><a href="module-server_routes_game_depart.html">server/routes/game/depart</a></li><li><a href="module-server_routes_game_maintenance.html">server/routes/game/maintenance</a></li><li><a href="module-server_routes_game_marketing.html">server/routes/game/marketing</a></li><li><a href="module-server_routes_game_user.html">server/routes/game/user</a><ul class='methods'><li data-type='method'><a href="module-server_routes_game_user.html#~compareVersions">compareVersions</a></li></ul></li><li><a href="module-server_routes_game_vessel.html">server/routes/game/vessel</a></li><li><a href="module-server_routes_harbor-map.html">server/routes/harbor-map</a><ul class='methods'><li data-type='method'><a href="module-server_routes_harbor-map.html#~escapeCSVFormula">escapeCSVFormula</a></li><li data-type='method'><a href="module-server_routes_harbor-map.html#~formatHistoryAsTXT">formatHistoryAsTXT</a></li><li data-type='method'><a href="module-server_routes_harbor-map.html#~getGameIndexCached">getGameIndexCached</a></li></ul></li><li><a href="module-server_routes_health.html">server/routes/health</a></li><li><a href="module-server_routes_messenger.html">server/routes/messenger</a><ul class='methods'><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/contact/get-contacts">GET /api/contact/get-contacts</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/hijacking/get-cases">GET /api/hijacking/get-cases</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/messenger/get-chats">GET /api/messenger/get-chats</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/delete-chat">POST /api/messenger/delete-chat</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/get-messages">POST /api/messenger/get-messages</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/send-private">POST /api/messenger/send-private</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/user/search">POST /api/user/search</a></li><li data-type='method'><a href="module-server_routes_messenger.html#~ensureHijackHistoryDir">ensureHijackHistoryDir</a></li></ul></li><li><a href="module-server_routes_poi.html">server/routes/poi</a><ul class='methods'><li data-type='method'><a href="module-server_routes_poi.html#~ensureCacheDir">ensureCacheDir</a></li><li data-type='method'><a href="module-server_routes_poi.html#~fetchAllMuseumsFromAPI">fetchAllMuseumsFromAPI</a></li><li data-type='method'><a href="module-server_routes_poi.html#~fetchAllWrecksFromAPI">fetchAllWrecksFromAPI</a></li><li data-type='method'><a href="module-server_routes_poi.html#~filterPOIsByBbox">filterPOIsByBbox</a></li><li data-type='method'><a href="module-server_routes_poi.html#~initializePOICache">initializePOICache</a></li><li data-type='method'><a href="module-server_routes_poi.html#~isCacheValid">isCacheValid</a></li><li data-type='method'><a href="module-server_routes_poi.html#~loadFromCache">loadFromCache</a></li><li data-type='method'><a href="module-server_routes_poi.html#~reduceWreckData">reduceWreckData</a></li><li data-type='method'><a href="module-server_routes_poi.html#~saveToCache">saveToCache</a></li><li data-type='method'><a href="module-server_routes_poi.html#~startAutomaticCacheRefresh">startAutomaticCacheRefresh</a></li></ul></li><li><a href="module-server_routes_settings.html">server/routes/settings</a><ul class='methods'><li data-type='method'><a href="module-server_routes_settings.html#.GET/api/settings">GET /api/settings</a></li><li data-type='method'><a href="module-server_routes_settings.html#.POST/api/settings">POST /api/settings</a></li></ul></li><li><a href="module-server_routes_staff.html">server/routes/staff</a></li><li><a href="module-server_routes_vessel-image.html">server/routes/vessel-image</a></li><li><a href="module-server_scheduler.html">server/scheduler</a><ul class='methods'><li data-type='method'><a href="module-server_scheduler.html#~initScheduler">initScheduler</a></li><li data-type='method'><a href="module-server_scheduler.html#~isServerReady">isServerReady</a></li></ul></li><li><a href="module-server_services_alliance-indexer.html">server/services/alliance-indexer</a></li><li><a href="module-server_settings-schema.html">server/settings-schema</a><ul class='methods'><li data-type='method'><a href="module-server_settings-schema.html#~getDefault">getDefault</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getDefaults">getDefaults</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getRequiredKeys">getRequiredKeys</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getSettingsFilePath">getSettingsFilePath</a></li><li data-type='method'><a href="module-server_settings-schema.html#~initializeSettings">initializeSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~saveSettings">saveSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~validateSettings">validateSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~validateValue">validateValue</a></li></ul></li><li><a href="module-server_state.html">server/state</a><ul class='methods'><li data-type='method'><a href="module-server_state.html#~getAllLocks">getAllLocks</a></li><li data-type='method'><a href="module-server_state.html#~getAutopilotState">getAutopilotState</a></li><li data-type='method'><a href="module-server_state.html#~getBunkerState">getBunkerState</a></li><li data-type='method'><a href="module-server_state.html#~getCampaignStatus">getCampaignStatus</a></li><li data-type='method'><a href="module-server_state.html#~getCoopData">getCoopData</a></li><li data-type='method'><a href="module-server_state.html#~getDrydockCount">getDrydockCount</a></li><li data-type='method'><a href="module-server_state.html#~getEventData">getEventData</a></li><li data-type='method'><a href="module-server_state.html#~getHeaderData">getHeaderData</a></li><li data-type='method'><a href="module-server_state.html#~getLastCO2Alert">getLastCO2Alert</a></li><li data-type='method'><a href="module-server_state.html#~getLastFuelAlert">getLastFuelAlert</a></li><li data-type='method'><a href="module-server_state.html#~getLockStatus">getLockStatus</a></li><li data-type='method'><a href="module-server_state.html#~getPrices">getPrices</a></li><li data-type='method'><a href="module-server_state.html#~getRepairCount">getRepairCount</a></li><li data-type='method'><a href="module-server_state.html#~getSettings">getSettings</a></li><li data-type='method'><a href="module-server_state.html#~getUserState">getUserState</a></li><li data-type='method'><a href="module-server_state.html#~getVesselCounts">getVesselCounts</a></li><li data-type='method'><a href="module-server_state.html#~isAutopilotPaused">isAutopilotPaused</a></li><li data-type='method'><a href="module-server_state.html#~setAutopilotPaused">setAutopilotPaused</a></li><li data-type='method'><a href="module-server_state.html#~setAutopilotState">setAutopilotState</a></li><li data-type='method'><a href="module-server_state.html#~setLastCO2Alert">setLastCO2Alert</a></li><li data-type='method'><a href="module-server_state.html#~setLastFuelAlert">setLastFuelAlert</a></li><li data-type='method'><a href="module-server_state.html#~setLockStatus">setLockStatus</a></li><li data-type='method'><a href="module-server_state.html#~updateBunkerState">updateBunkerState</a></li><li data-type='method'><a href="module-server_state.html#~updateCampaignStatus">updateCampaignStatus</a></li><li data-type='method'><a href="module-server_state.html#~updateCoopData">updateCoopData</a></li><li data-type='method'><a href="module-server_state.html#~updateDrydockCount">updateDrydockCount</a></li><li data-type='method'><a href="module-server_state.html#~updateEventData">updateEventData</a></li><li data-type='method'><a href="module-server_state.html#~updateHeaderData">updateHeaderData</a></li><li data-type='method'><a href="module-server_state.html#~updatePrices">updatePrices</a></li><li data-type='method'><a href="module-server_state.html#~updateRepairCount">updateRepairCount</a></li><li data-type='method'><a href="module-server_state.html#~updateSettings">updateSettings</a></li><li data-type='method'><a href="module-server_state.html#~updateVesselCounts">updateVesselCounts</a></li></ul></li><li><a href="module-server_utils_api.html">server/utils/api</a><ul class='methods'><li data-type='method'><a href="module-server_utils_api.html#~apiCall">apiCall</a></li><li data-type='method'><a href="module-server_utils_api.html#~apiCallWithRetry">apiCallWithRetry</a></li><li data-type='method'><a href="module-server_utils_api.html#~checkAndUpdateAllianceId">checkAndUpdateAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~getAllianceId">getAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~getAllianceName">getAllianceName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getChatFeed">getChatFeed</a></li><li data-type='method'><a href="module-server_utils_api.html#~getCompanyName">getCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserCompanyName">getUserCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserId">getUserId</a></li><li data-type='method'><a href="module-server_utils_api.html#~initializeAlliance">initializeAlliance</a></li><li data-type='method'><a href="module-server_utils_api.html#~setAllianceId">setAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~sleep">sleep</a></li></ul></li><li><a href="module-server_utils_audit-logger.html">server/utils/audit-logger</a><ul class='methods'><li data-type='method'><a href="module-server_utils_audit-logger.html#~auditLog">auditLog</a></li><li data-type='method'><a href="module-server_utils_audit-logger.html#~formatCurrency">formatCurrency</a></li><li data-type='method'><a href="module-server_utils_audit-logger.html#~formatNumber">formatNumber</a></li></ul></li><li><a href="module-server_utils_contribution-store.html">server/utils/contribution-store</a><ul class='methods'><li data-type='method'><a href="module-server_utils_contribution-store.html#~enrichHistoryWithContributions">enrichHistoryWithContributions</a></li><li data-type='method'><a href="module-server_utils_contribution-store.html#~ensureDirectory">ensureDirectory</a></li><li data-type='method'><a href="module-server_utils_contribution-store.html#~getContributionGain">getContributionGain</a></li><li data-type='method'><a href="module-server_utils_contribution-store.html#~getFilePath">getFilePath</a></li><li data-type='method'><a href="module-server_utils_contribution-store.html#~loadContributionGains">loadContributionGains</a></li><li data-type='method'><a href="module-server_utils_contribution-store.html#~saveContributionGain">saveContributionGain</a></li></ul></li><li><a href="module-server_utils_encryption.html">server/utils/encryption</a><ul class='methods'><li data-type='method'><a href="module-server_utils_encryption.html#~decryptData">decryptData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~deleteEncryptedData">deleteEncryptedData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~encryptData">encryptData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~getEncryptionInfo">getEncryptionInfo</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~getMachineKey">getMachineKey</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~isEncrypted">isEncrypted</a></li></ul></li><li><a href="module-server_utils_harbor-fee-store.html">server/utils/harbor-fee-store</a><ul class='methods'><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~enrichHistoryWithFees">enrichHistoryWithFees</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~ensureDirectory">ensureDirectory</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~getFilePath">getFilePath</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~getHarborFee">getHarborFee</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~isMigrationCompleted">isMigrationCompleted</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~loadHarborFees">loadHarborFees</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~markMigrationCompleted">markMigrationCompleted</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~saveHarborFee">saveHarborFee</a></li></ul></li><li><a href="module-server_utils_logger.html">server/utils/logger</a><ul class='methods'><li data-type='method'><a href="module-server_utils_logger.html#~debug">debug</a></li><li data-type='method'><a href="module-server_utils_logger.html#~error">error</a></li><li data-type='method'><a href="module-server_utils_logger.html#~info">info</a></li><li data-type='method'><a href="module-server_utils_logger.html#~isDebugMode">isDebugMode</a></li><li data-type='method'><a href="module-server_utils_logger.html#~loadLogLevel">loadLogLevel</a></li><li data-type='method'><a href="module-server_utils_logger.html#~warn">warn</a></li></ul></li><li><a href="module-server_utils_migrate-harbor-fees.html">server/utils/migrate-harbor-fees</a><ul class='methods'><li data-type='method'><a href="module-server_utils_migrate-harbor-fees.html#~migrateAllHarborFees">migrateAllHarborFees</a></li><li data-type='method'><a href="module-server_utils_migrate-harbor-fees.html#~migrateHarborFeesForUser">migrateHarborFeesForUser</a></li><li data-type='method'><a href="module-server_utils_migrate-harbor-fees.html#~resolveVesselNameToId">resolveVesselNameToId</a></li><li data-type='method'><a href="module-server_utils_migrate-harbor-fees.html#~timestampToMySQLDatetime">timestampToMySQLDatetime</a></li></ul></li><li><a href="module-server_utils_read-tracker.html">server/utils/read-tracker</a><ul class='methods'><li data-type='method'><a href="module-server_utils_read-tracker.html#~ensureReadTrackingFile">ensureReadTrackingFile</a></li><li data-type='method'><a href="module-server_utils_read-tracker.html#~getLastReadTimestamp">getLastReadTimestamp</a></li><li data-type='method'><a href="module-server_utils_read-tracker.html#~saveReadTrackingFile">saveReadTrackingFile</a></li><li data-type='method'><a href="module-server_utils_read-tracker.html#~updateLastReadTimestamp">updateLastReadTimestamp</a></li></ul></li><li><a href="module-server_utils_session-manager.html">server/utils/session-manager</a><ul class='methods'><li data-type='method'><a href="module-server_utils_session-manager.html#~deleteSession">deleteSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getAllUserIds">getAllUserIds</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getAvailableSessions">getAvailableSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getSession">getSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getSessionsPath">getSessionsPath</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~hasSession">hasSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~loadAllSessions">loadAllSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~loadSessions">loadSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~migrateToEncrypted">migrateToEncrypted</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~saveSession">saveSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~saveSessions">saveSessions</a></li></ul></li><li><a href="module-server_websocket.html">server/websocket</a><ul class='methods'><li data-type='method'><a href="module-server_websocket.html#~initWebSocket">initWebSocket</a></li></ul></li><li><a href="module-server_websocket_broadcaster.html">server/websocket/broadcaster</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_broadcaster.html#~broadcast">broadcast</a></li><li data-type='method'><a href="module-server_websocket_broadcaster.html#~broadcastBunkerUpdate">broadcastBunkerUpdate</a></li><li data-type='method'><a href="module-server_websocket_broadcaster.html#~broadcastHarborMapRefresh">broadcastHarborMapRefresh</a></li><li data-type='method'><a href="module-server_websocket_broadcaster.html#~broadcastToUser">broadcastToUser</a></li><li data-type='method'><a href="module-server_websocket_broadcaster.html#~getWebSocketServer">getWebSocketServer</a></li><li data-type='method'><a href="module-server_websocket_broadcaster.html#~setWebSocketServer">setWebSocketServer</a></li></ul></li><li><a href="module-server_websocket_chat-refresh.html">server/websocket/chat-refresh</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_chat-refresh.html#~performChatRefresh">performChatRefresh</a></li><li data-type='method'><a href="module-server_websocket_chat-refresh.html#~setMessengerRefreshFn">setMessengerRefreshFn</a></li><li data-type='method'><a href="module-server_websocket_chat-refresh.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket_chat-refresh.html#~stopChatAutoRefresh">stopChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket_chat-refresh.html#~triggerImmediateChatRefresh">triggerImmediateChatRefresh</a></li></ul></li><li><a href="module-server_websocket_hijacking-cache.html">server/websocket/hijacking-cache</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_hijacking-cache.html#~getCachedHijackingCase">getCachedHijackingCase</a></li><li data-type='method'><a href="module-server_websocket_hijacking-cache.html#~invalidateHijackingCase">invalidateHijackingCase</a></li></ul></li><li><a href="module-server_websocket_hijacking-refresh.html">server/websocket/hijacking-refresh</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_hijacking-refresh.html#~performHijackingRefresh">performHijackingRefresh</a></li><li data-type='method'><a href="module-server_websocket_hijacking-refresh.html#~startHijackingAutoRefresh">startHijackingAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket_hijacking-refresh.html#~stopHijackingAutoRefresh">stopHijackingAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket_hijacking-refresh.html#~triggerImmediateHijackingRefresh">triggerImmediateHijackingRefresh</a></li></ul></li><li><a href="module-server_websocket_message-cache.html">server/websocket/message-cache</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_message-cache.html#~getProcessedMessageIds">getProcessedMessageIds</a></li><li data-type='method'><a href="module-server_websocket_message-cache.html#~getProcessedMessagesCachePath">getProcessedMessagesCachePath</a></li><li data-type='method'><a href="module-server_websocket_message-cache.html#~loadProcessedMessageCache">loadProcessedMessageCache</a></li><li data-type='method'><a href="module-server_websocket_message-cache.html#~saveProcessedMessageCache">saveProcessedMessageCache</a></li></ul></li><li><a href="module-server_websocket_messenger-cache.html">server/websocket/messenger-cache</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_messenger-cache.html#~getCachedMessengerChats">getCachedMessengerChats</a></li></ul></li><li><a href="module-server_websocket_messenger-refresh.html">server/websocket/messenger-refresh</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_messenger-refresh.html#~performMessengerRefresh">performMessengerRefresh</a></li><li data-type='method'><a href="module-server_websocket_messenger-refresh.html#~startMessengerAutoRefresh">startMessengerAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket_messenger-refresh.html#~stopMessengerAutoRefresh">stopMessengerAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket_messenger-refresh.html#~triggerImmediateMessengerRefresh">triggerImmediateMessengerRefresh</a></li></ul></li><li><a href="module-ui-dialogs.html">ui-dialogs</a><ul class='methods'><li data-type='method'><a href="module-ui-dialogs.html#.buyCampaign">buyCampaign</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeCampaignsOverlay">closeCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeSettings">closeSettings</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showCampaignsOverlay">showCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showConfirmDialog">showConfirmDialog</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showContactList">showContactList</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showSettings">showSettings</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#.escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-utils.html#.formatNumber">formatNumber</a></li><li data-type='method'><a href="module-utils.html#.getCO2PriceClass">getCO2PriceClass</a></li><li data-type='method'><a href="module-utils.html#.getFuelPriceClass">getFuelPriceClass</a></li><li data-type='method'><a href="module-utils.html#.isMobileDevice">isMobileDevice</a></li><li data-type='method'><a href="module-utils.html#.registerServiceWorker">registerServiceWorker</a></li><li data-type='method'><a href="module-utils.html#.renderStars">renderStars</a></li><li data-type='method'><a href="module-utils.html#.requestNotificationPermission">requestNotificationPermission</a></li><li data-type='method'><a href="module-utils.html#.showNotification">showNotification</a></li><li data-type='method'><a href="module-utils.html#.showSideNotification">showSideNotification</a></li></ul></li><li><a href="module-vessel-management.html">vessel-management</a><ul class='methods'><li data-type='method'><a href="module-vessel-management.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.openRepairAndDrydockDialog">openRepairAndDrydockDialog</a></li><li data-type='method'><a href="module-vessel-management.html#.purchaseSingleVessel">purchaseSingleVessel</a></li><li data-type='method'><a href="module-vessel-management.html#.updateLockStateFromServer">updateLockStateFromServer</a></li><li data-type='method'><a href="module-vessel-management.html#.updateVesselCount">updateVesselCount</a></li><li data-type='method'><a href="module-vessel-management.html#~createVesselCard">createVesselCard</a></li><li data-type='method'><a href="module-vessel-management.html#~displayFilteredVessels">displayFilteredVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~executeDrydock">executeDrydock</a></li><li data-type='method'><a href="module-vessel-management.html#~getAvailableAnchorSlots">getAvailableAnchorSlots</a></li><li data-type='method'><a href="module-vessel-management.html#~getCO2EfficiencyClass">getCO2EfficiencyClass</a></li><li data-type='method'><a href="module-vessel-management.html#~getCapacityDisplay">getCapacityDisplay</a></li><li data-type='method'><a href="module-vessel-management.html#~getFuelEfficiencyClass">getFuelEfficiencyClass</a></li><li data-type='method'><a href="module-vessel-management.html#~loadCartFromStorage">loadCartFromStorage</a></li><li data-type='method'><a href="module-vessel-management.html#~loadMorePendingVessels">loadMorePendingVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~loadMoreVessels">loadMoreVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~populateDynamicFilters">populateDynamicFilters</a></li><li data-type='method'><a href="module-vessel-management.html#~refreshVesselCardsIfVisible">refreshVesselCardsIfVisible</a></li><li data-type='method'><a href="module-vessel-management.html#~renderDrydockTab">renderDrydockTab</a></li><li data-type='method'><a href="module-vessel-management.html#~renderRepairTab">renderRepairTab</a></li><li data-type='method'><a href="module-vessel-management.html#~saveCartToStorage">saveCartToStorage</a></li><li data-type='method'><a href="module-vessel-management.html#~showRepairAndDrydockDialog">showRepairAndDrydockDialog</a></li><li data-type='method'><a href="module-vessel-management.html#~updateCapacityDropdowns">updateCapacityDropdowns</a></li><li data-type='method'><a href="module-vessel-management.html#~vesselPassesFilters">vesselPassesFilters</a></li></ul></li><li><a href="module-vessel-selling.html">vessel-selling</a><ul class='methods'><li data-type='method'><a href="module-vessel-selling.html#.bulkSellVessels">bulkSellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#.closeSellVesselsOverlay">closeSellVesselsOverlay</a></li><li data-type='method'><a href="module-vessel-selling.html#.openSellVesselsOverlay">openSellVesselsOverlay</a></li><li data-type='method'><a href="module-vessel-selling.html#.refreshVesselsForSale">refreshVesselsForSale</a></li><li data-type='method'><a href="module-vessel-selling.html#.setSellFilter">setSellFilter</a></li><li data-type='method'><a href="module-vessel-selling.html#.showSellCart">showSellCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~clearSellCartCache">clearSellCartCache</a></li><li data-type='method'><a href="module-vessel-selling.html#~displaySellVessels">displaySellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#~fetchAllSellPrices">fetchAllSellPrices</a></li><li data-type='method'><a href="module-vessel-selling.html#~getCO2EfficiencyClass">getCO2EfficiencyClass</a></li><li data-type='method'><a href="module-vessel-selling.html#~getCapacityDisplay">getCapacityDisplay</a></li><li data-type='method'><a href="module-vessel-selling.html#~getFuelEfficiencyClass">getFuelEfficiencyClass</a></li><li data-type='method'><a href="module-vessel-selling.html#~groupVesselsByModel">groupVesselsByModel</a></li><li data-type='method'><a href="module-vessel-selling.html#~loadSellCartFromCache">loadSellCartFromCache</a></li><li data-type='method'><a href="module-vessel-selling.html#~loadUserVesselsForSale">loadUserVesselsForSale</a></li><li data-type='method'><a href="module-vessel-selling.html#~removeVesselSelectionFromCart">removeVesselSelectionFromCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~saveSellCartToCache">saveSellCartToCache</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateBulkSellButton">updateBulkSellButton</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateSelectButtonState">updateSelectButtonState</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateVesselSelectionInCart">updateVesselSelectionInCart</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#buildNav">buildNav</a></li><li><a href="global.html#deleteAllLogs">deleteAllLogs</a></li><li><a href="global.html#escapeCSVFormula">escapeCSVFormula</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#flushAllToDisk">flushAllToDisk</a></li><li><a href="global.html#formatDetailsAsTXT">formatDetailsAsTXT</a></li><li><a href="global.html#formatFileSize">formatFileSize</a></li><li><a href="global.html#formatLogsAsCSV">formatLogsAsCSV</a></li><li><a href="global.html#formatLogsAsTXT">formatLogsAsTXT</a></li><li><a href="global.html#fs">fs</a></li><li><a href="global.html#getCategoryFromAction">getCategoryFromAction</a></li><li><a href="global.html#getLogEntries">getLogEntries</a></li><li><a href="global.html#getLogFilePath">getLogFilePath</a></li><li><a href="global.html#getLogFileSize">getLogFileSize</a></li><li><a href="global.html#getLogsFromCache">getLogsFromCache</a></li><li><a href="global.html#getSourceFromAction">getSourceFromAction</a></li><li><a href="global.html#getTransactionType">getTransactionType</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#isDepartInProgress">isDepartInProgress</a></li><li><a href="global.html#loadLogsFromDisk">loadLogsFromDisk</a></li><li><a href="global.html#lockBulkBuyButton">lockBulkBuyButton</a></li><li><a href="global.html#lockCo2Button">lockCo2Button</a></li><li><a href="global.html#lockCoopButtons">lockCoopButtons</a></li><li><a href="global.html#lockDepartButton">lockDepartButton</a></li><li><a href="global.html#lockDrydockButton">lockDrydockButton</a></li><li><a href="global.html#lockFuelButton">lockFuelButton</a></li><li><a href="global.html#lockRepairButton">lockRepairButton</a></li><li><a href="global.html#logAutopilotAction">logAutopilotAction</a></li><li><a href="global.html#publish">publish</a></li><li><a href="global.html#searchInObject">searchInObject</a></li><li><a href="global.html#showAnchorTimer">showAnchorTimer</a></li><li><a href="global.html#shutdown">shutdown</a></li><li><a href="global.html#unlockBulkBuyButton">unlockBulkBuyButton</a></li><li><a href="global.html#unlockCo2Button">unlockCo2Button</a></li><li><a href="global.html#unlockCoopButtons">unlockCoopButtons</a></li><li><a href="global.html#unlockDepartButton">unlockDepartButton</a></li><li><a href="global.html#unlockDrydockButton">unlockDrydockButton</a></li><li><a href="global.html#unlockFuelButton">unlockFuelButton</a></li><li><a href="global.html#unlockRepairButton">unlockRepairButton</a></li><li><a href="global.html#writeLogsToDisk">writeLogsToDisk</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">public/js/modules/messenger.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Private Messaging Module - Handles direct message conversations between players and system notifications.
 * Provides a WhatsApp-style messaging interface with conversation selection, message threading, and system message handling.
 *
 * Key Features:
 * - Multi-conversation management with subject-based threading
 * - System notification handling (vessel hijacking, stock transactions, alliance events)
 * - Chat selection overlay for choosing between multiple conversations with same user
 * - Message bubble UI with sender identification
 * - Unread badge tracking
 * - Chat deletion with confirmation
 * - Integration with contact list and alliance chat
 *
 * Conversation Flow:
 * 1. User clicks company name (from chat/contacts)
 * 2. System fetches all conversations with that user
 * 3. Conversation selection overlay displays (or creates new chat)
 * 4. Selected conversation opens with full message history
 * 5. User can send replies or delete conversation
 *
 * System Messages:
 * - Read-only notifications from game (vessel hijacked, stock trades, etc.)
 * - Formatted with specialized templates per message type
 * - Grouped under "Gameplay" participant
 * - Cannot reply (input hidden for system chats)
 *
 * @module messenger
 * @requires utils - HTML escaping functions
 * @requires api - Messenger API calls
 * @requires ui-dialogs - Confirmation dialogs
 */

import { escapeHtml, showSideNotification, showNotification } from './utils.js';
import { fetchMessengerChats, fetchMessengerMessages, sendPrivateMessage as apiSendPrivateMessage, deleteChat as apiDeleteChat, markChatAsRead as apiMarkChatAsRead, fetchContacts, searchUsers } from './api.js';
import { showConfirmDialog } from './ui-dialogs.js';
import { updateBadge } from './badge-manager.js';

/**
 * Formats timestamp using browser locale without timezone.
 * @param {number} unixTimestamp - Unix timestamp in seconds
 * @returns {string} Formatted date/time (e.g., "Oct 28, 2025, 18:00:23")
 */
function formatTimestamp(unixTimestamp) {
  const date = new Date(unixTimestamp * 1000);
  return date.toLocaleString(undefined, {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  });
}

/**
 * Current active private chat state.
 * Tracks the currently opened conversation with all its metadata.
 * @type {Object}
 * @property {number|null} chatId - Chat ID from API (null for new chats)
 * @property {string|null} subject - Conversation subject line
 * @property {string|null} targetCompanyName - Name of other participant
 * @property {number|null} targetUserId - User ID of other participant
 * @property {Array} messages - Array of message objects in this conversation
 * @property {boolean} isNewChat - True if creating new conversation
 * @property {boolean} isSystemChat - True if this is a system notification
 */
let currentPrivateChat = {
  chatId: null,
  subject: null,
  targetCompanyName: null,
  targetUserId: null,
  messages: [],
  isNewChat: false
};

/**
 * Array of all private chats fetched from API.
 * Includes both user conversations and system notifications.
 * @type {Array&lt;Object>}
 */
let allPrivateChats = [];

/**
 * Filtered chats for current selection overlay.
 * Subset of allPrivateChats relevant to current target user.
 * @type {Array&lt;Object>}
 */
let userChatsForSelection = [];

/**
 * Polling interval for active hijacking negotiations.
 * Checks for pirate responses every 5 seconds.
 * @type {number|null}
 */
let hijackingPollingInterval = null;

/**
 * Opens messenger interface for a specific user or system notifications.
 * Fetches all conversations and displays selection overlay or system message list.
 *
 * Special Handling:
 * - If targetCompanyName is "Gameplay", shows system notifications list
 * - Otherwise shows all conversations with the specified user
 * - Allows creating new conversation if none exist
 *
 * Side Effects:
 * - Fetches all messenger chats from API
 * - Updates allPrivateChats module variable
 * - Shows chat selection overlay
 *
 * @async
 * @param {string} targetCompanyName - Company name to message, or "Gameplay" for system notifications
 * @param {number|null} targetUserId - User ID of target (null for system messages)
 * @returns {Promise&lt;void>}
 *
 * @example
 * // From alliance chat - user clicks @CompanyName
 * openMessenger("Player Company", 456);
 *
 * // From toolbar - user clicks Gameplay notifications
 * openMessenger("Gameplay", null);
 */
export async function openMessenger(targetCompanyName, targetUserId) {
  // Reset hijacking inbox flag when opening messenger normally
  window.cameFromHijackingInbox = false;

  // Remove hijacking case view class when opening normally
  const messengerOverlay = document.getElementById('messengerOverlay');
  if (messengerOverlay) {
    messengerOverlay.classList.remove('hijacking-case-view');
  }

  try {
    const data = await fetchMessengerChats();
    allPrivateChats = data.chats;

    // Check if this is for system messages
    if (targetCompanyName === 'Gameplay') {
      showSystemMessagesSelection(data.chats, data.own_user_id);
      return;
    }

    const userChats = allPrivateChats.filter(chat => {
      if (chat.system_chat) return false;
      return chat.participants_string === targetCompanyName;
    });

    showChatSelection(targetCompanyName, targetUserId, userChats, data.own_user_id);

  } catch (error) {
    console.error('Error opening messenger:', error);
    alert(`Error: ${error.message}`);
  }
}

function showSystemMessagesSelection(allChats, ownUserId) {
  // Filter system chats but exclude hijacking messages (they go to Phone Booth)
  const systemChats = allChats.filter(chat =>
    chat.system_chat &amp;&amp; chat.body !== 'vessel_got_hijacked'
  );
  const sortedChats = systemChats.sort((a, b) => (b.time_last_message || 0) - (a.time_last_message || 0));
  userChatsForSelection = sortedChats;

  document.getElementById('chatSelectionTitle').textContent = 'Gameplay -  System Notifications';
  const listContainer = document.getElementById('chatSelectionList');

  if (sortedChats.length === 0) {
    listContainer.innerHTML = '&lt;div class="empty-message">No system notifications yet.&lt;/div>';
  } else {
    listContainer.innerHTML = sortedChats.map((chat, index) => {
      const title = getSystemMessageTitle(chat.body, chat.values);
      const timestamp = formatTimestamp(chat.time_last_message);
      const unreadIndicator = chat.new ? '&lt;span class="unread-indicator">&lt;/span>' : '';

      return `
        &lt;div class="chat-selection-item" data-chat-index="${index}" style="position: relative; padding-right: 40px;">
          &lt;div style="flex: 1;">
            &lt;h3>${title}${unreadIndicator}&lt;/h3>
            &lt;p>${timestamp}&lt;/p>
          &lt;/div>
          &lt;button class="delete-chat-btn" data-chat-index="${index}">&lt;/button>
        &lt;/div>
      `;
    }).join('');

    listContainer.querySelectorAll('.chat-selection-item').forEach(item => {
      const chatItem = item.querySelector('div[style*="flex: 1"]');
      if (chatItem) {
        chatItem.addEventListener('click', () => {
          const chatIndex = parseInt(item.dataset.chatIndex);
          const selectedChat = userChatsForSelection[chatIndex];
          document.getElementById('chatSelectionOverlay').classList.add('hidden');
          openExistingChat('Gameplay', null, selectedChat, ownUserId);
        });
      }
    });

    listContainer.querySelectorAll('.delete-chat-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const chatIndex = parseInt(btn.dataset.chatIndex);
        const chatToDelete = sortedChats[chatIndex];
        const chatItem = btn.closest('.chat-selection-item');

        const wasDeleted = await deleteChatWithConfirmation(chatToDelete);
        // Remove element immediately from DOM if deleted
        if (wasDeleted &amp;&amp; chatItem) {
          chatItem.remove();
        }
      });
    });
  }

  document.getElementById('chatSelectionOverlay').classList.remove('hidden');
}

function showChatSelection(targetCompanyName, targetUserId, chats, ownUserId) {
  const sortedChats = [...chats].sort((a, b) => (b.time_last_message || 0) - (a.time_last_message || 0));
  userChatsForSelection = sortedChats;

  currentPrivateChat.targetCompanyName = targetCompanyName;
  currentPrivateChat.targetUserId = targetUserId;

  document.getElementById('chatSelectionTitle').textContent = `Conversations with ${targetCompanyName}`;
  const listContainer = document.getElementById('chatSelectionList');

  let html = `
    &lt;div class="chat-selection-item" data-is-new="true" style="border-color: #4ade80;">
      &lt;div style="flex: 1;">
        &lt;h3 style="color: #4ade80;">+ Start New Conversation&lt;/h3>
        &lt;p>Create a new conversation with a custom subject&lt;/p>
      &lt;/div>
    &lt;/div>
  `;

  html += sortedChats.map((chat, index) => {
    const lastMsg = chat.last_message ? escapeHtml(chat.last_message.substring(0, 60)) + '...' : 'No messages';
    const subject = chat.subject || 'No subject';
    const unreadIndicator = chat.new ? '&lt;span class="unread-indicator">&lt;/span>' : '';

    // Format timestamp
    const timestamp = formatTimestamp(chat.time_last_message);

    return `
      &lt;div class="chat-selection-item" data-chat-index="${index}" style="position: relative; padding-right: 40px;">
        &lt;div style="flex: 1;">
          &lt;h3>${escapeHtml(targetCompanyName)} - ${escapeHtml(subject)}${unreadIndicator}&lt;/h3>
          &lt;p>${lastMsg}&lt;/p>
          &lt;p style="font-size: 11px; opacity: 0.7; margin-top: 4px;">${timestamp}&lt;/p>
        &lt;/div>
        &lt;button class="delete-chat-btn" data-chat-index="${index}">&lt;/button>
      &lt;/div>
    `;
  }).join('');

  listContainer.innerHTML = html;

  listContainer.querySelectorAll('.chat-selection-item').forEach(item => {
    const chatItem = item.querySelector('div[style*="flex: 1"]');
    if (chatItem) {
      chatItem.addEventListener('click', async () => {
        if (item.dataset.isNew === 'true') {
          document.getElementById('chatSelectionOverlay').classList.add('hidden');
          openNewChat(targetCompanyName, targetUserId);
        } else {
          const chatIndex = parseInt(item.dataset.chatIndex);
          const selectedChat = userChatsForSelection[chatIndex];
          document.getElementById('chatSelectionOverlay').classList.add('hidden');
          openExistingChat(targetCompanyName, targetUserId, selectedChat, ownUserId);
        }
      });
    }
  });

  // Add delete button handlers
  listContainer.querySelectorAll('.delete-chat-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const chatIndex = parseInt(btn.dataset.chatIndex);
      const chatToDelete = sortedChats[chatIndex];
      const chatItem = btn.closest('.chat-selection-item');

      const wasDeleted = await deleteChatWithConfirmation(chatToDelete);
      // Remove element immediately from DOM if deleted
      if (wasDeleted &amp;&amp; chatItem) {
        chatItem.remove();
      }
    });
  });

  document.getElementById('chatSelectionOverlay').classList.remove('hidden');
}

export async function openExistingChat(targetCompanyName, targetUserId, chat, ownUserId) {
  const isSystemChat = chat.system_chat || false;

  currentPrivateChat = {
    chatId: chat.id,
    subject: chat.subject || 'Message',
    targetCompanyName: targetCompanyName,
    targetUserId: targetUserId,
    messages: [],
    isNewChat: false,
    isSystemChat: isSystemChat,
    body: chat.body || null,
    values: chat.values || null
  };

  document.getElementById('messengerOverlay').classList.remove('hidden');

  // Set window size based on chat type
  const messengerWindow = document.querySelector('#messengerOverlay .messenger-window');
  messengerWindow.classList.remove('messenger-window-narrow', 'messenger-window-system');
  if (isSystemChat &amp;&amp; chat.body === 'vessel_got_hijacked') {
    // Pirate Demands = narrow template (400px)
    messengerWindow.classList.add('messenger-window-narrow');
  } else if (isSystemChat) {
    // System notifications = auto-size to content
    messengerWindow.classList.add('messenger-window-system');
  }

  // Set title based on chat type
  if (isSystemChat) {
    if (chat.body === 'vessel_got_hijacked') {
      document.getElementById('messengerTitle').textContent = ` Pirate Demands`;
    } else {
      document.getElementById('messengerTitle').textContent = ` ${targetCompanyName} - System Notification`;
    }
  } else {
    document.getElementById('messengerTitle').textContent = ` ${targetCompanyName} - ${chat.subject || 'Chat'}`;
  }

  document.getElementById('subjectInputWrapper').classList.add('hidden');
  document.getElementById('messengerFeed').innerHTML = '&lt;div class="empty-message">Loading...&lt;/div>';

  // System chats are single notifications, not conversations
  if (isSystemChat) {
    await displaySystemMessage(chat);
    // Hide input area for system messages
    document.getElementById('messengerInput').classList.add('hidden');
    document.getElementById('sendPrivateMessageBtn').classList.add('hidden');
  } else {
    await loadPrivateMessages(chat.id, ownUserId);
    // Show input area for regular chats
    document.getElementById('messengerInput').classList.remove('hidden');
    document.getElementById('sendPrivateMessageBtn').classList.remove('hidden');
    document.getElementById('messengerInput').focus();
  }

  // Mark as read after displaying the message (if it was unread)
  if (chat.new) {
    try {
      await apiMarkChatAsRead(chat.id, isSystemChat);
      console.log(`[Messenger] Marked chat ${chat.id} as read (system: ${isSystemChat})`);
    } catch (error) {
      console.error('[Messenger] Failed to mark chat as read:', error);
    }
  }

  if (window.debouncedUpdateUnreadBadge) {
    setTimeout(() => window.debouncedUpdateUnreadBadge(1000), 1000);
  }
}

/**
 * Opens interface for creating a new conversation with a user.
 * Displays messenger overlay with subject input and empty message feed.
 *
 * Side Effects:
 * - Updates currentPrivateChat state with new chat parameters
 * - Shows messenger overlay
 * - Displays subject input field
 * - Focuses subject input for user entry
 *
 * @param {string} targetCompanyName - Company name of message recipient
 * @param {number} targetUserId - User ID of message recipient
 *
 * @example
 * // User clicks "New Conversation" from chat selection
 * openNewChat("Player Company", 456);
 */
export function openNewChat(targetCompanyName, targetUserId) {
  currentPrivateChat = {
    chatId: null,
    subject: null,
    targetCompanyName: targetCompanyName,
    targetUserId: targetUserId,
    messages: [],
    isNewChat: true
  };

  document.getElementById('messengerOverlay').classList.remove('hidden');

  // New conversation = normal template (wide with min-height)
  const messengerWindow = document.querySelector('#messengerOverlay .messenger-window');
  messengerWindow.classList.remove('messenger-window-narrow', 'messenger-window-system');

  document.getElementById('messengerTitle').textContent = ` ${targetCompanyName} - New Conversation`;
  document.getElementById('subjectInputWrapper').classList.remove('hidden');
  document.getElementById('subjectInput').value = '';
  document.getElementById('messengerFeed').innerHTML =
    '&lt;div class="empty-message">New conversation. Enter a subject and send your first message.&lt;/div>';

  document.getElementById('subjectInput').focus();
}

/**
 * Loads and displays messages for a specific conversation.
 * Fetches message history from API and renders in bubble format.
 *
 * @async
 * @param {number} chatId - Chat ID to load messages for
 * @returns {Promise&lt;void>}
 */
async function loadPrivateMessages(chatId) {
  try {
    const { messages, user_id: ownUserId } = await fetchMessengerMessages(chatId);
    displayPrivateMessages(messages, ownUserId);
  } catch (error) {
    document.getElementById('messengerFeed').innerHTML =
      `&lt;div class="empty-message" style="color:#ef4444;">Error loading messages: ${error.message}&lt;/div>`;
  }
}

function displayPrivateMessages(messages, ownUserId) {
  const feed = document.getElementById('messengerFeed');
  feed.innerHTML = '';

  if (!messages || messages.length === 0) {
    feed.innerHTML = '&lt;div class="empty-message">No messages in this chat yet.&lt;/div>';
    return;
  }

  messages.forEach(msg => {
    const isOwn = msg.user_id === ownUserId;
    const bubble = document.createElement('div');

    const timestamp = formatTimestamp(msg.created_at);

    bubble.className = `message-bubble ${isOwn ? 'own' : 'other'}`;
    bubble.innerHTML = `
      ${escapeHtml(msg.body || '').replace(/\n/g, '&lt;br>')}
      &lt;div style="font-size:10px; opacity:0.7; margin-top:5px; text-align:${isOwn ? 'right' : 'left'};">${timestamp}&lt;/div>
    `;

    feed.appendChild(bubble);
  });

  feed.scrollTop = feed.scrollHeight;

  // Show input footer for private messages
  const inputContainer = document.querySelector('.messenger-input');
  if (inputContainer) {
    inputContainer.classList.remove('hidden');
  }
}

function getSystemMessageTitle(body) {
  if (!body) return 'System Notification';

  if (body === 'vessel_got_hijacked') return ' Vessel Hijacked';
  if (body === 'user_bought_stock') return ' Stock Purchase';
  if (body === 'user_sold_stock') return ' Stock Sale';
  if (body.includes('alliance') &amp;&amp; body.includes('donation')) return ' Alliance Donation';
  if (body.includes('accepted_to_join_alliance')) return ' Alliance Joined';
  if (body.startsWith('intro_pm_')) return ' Tutorial Message';

  // Fallback: format the body text (replace underscores, capitalize words)
  return body
    .replace(/_/g, ' ')
    .replace(/\//g, ' ')
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');
}

async function displaySystemMessage(chat) {
  const feed = document.getElementById('messengerFeed');
  feed.innerHTML = '';

  const bubble = document.createElement('div');
  if (chat.body === 'vessel_got_hijacked') {
    bubble.className = 'message-bubble hijacking';
  } else {
    bubble.className = 'message-bubble system message-bubble-system';
  }

  const timestamp = formatTimestamp(chat.time_last_message);

  // Check if this is a hijacking notification - fetch case details first
  let caseDetails = null;
  let autopilotResolved = false;

  if (chat.body === 'vessel_got_hijacked' &amp;&amp; chat.values?.case_id) {
    try {
      const response = await fetch('/api/hijacking/get-case', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ case_id: chat.values.case_id })
      });
      const data = await response.json();
      if (response.ok &amp;&amp; data.data) {
        caseDetails = data.data;
        console.log('[Hijacking] Case details loaded:', caseDetails);

        // Load negotiation history from server
        let negotiationHistory = [];
        let resolvedAt = null;
        let paymentVerification = null;
        try {
          const historyResponse = await fetch(`/api/hijacking/history/${chat.values.case_id}`);
          const historyData = await historyResponse.json();
          negotiationHistory = historyData.history || [];
          autopilotResolved = historyData.autopilot_resolved || false;
          resolvedAt = historyData.resolved_at || null;
          paymentVerification = historyData.payment_verification || null;
        } catch (error) {
          console.error('Error loading hijack history:', error);
        }

        // Add initial demand if not in history
        if (negotiationHistory.length === 0 &amp;&amp; chat.values.requested_amount) {
          negotiationHistory.push({
            type: 'pirate',
            amount: chat.values.requested_amount,
            timestamp: chat.time_last_message
          });
        }

        // Check if we need to add user proposal
        if (caseDetails.user_proposal &amp;&amp;
            !negotiationHistory.find(h => h.type === 'user' &amp;&amp; h.amount === caseDetails.user_proposal)) {
          negotiationHistory.push({
            type: 'user',
            amount: caseDetails.user_proposal,
            timestamp: Date.now() / 1000
          });
        }

        // Check if pirates counter-offered (requested amount changed)
        const lastPirateOffer = negotiationHistory.filter(h => h.type === 'pirate').pop();
        if (lastPirateOffer &amp;&amp; caseDetails.requested_amount !== lastPirateOffer.amount) {
          negotiationHistory.push({
            type: 'pirate',
            amount: caseDetails.requested_amount,
            timestamp: Date.now() / 1000
          });
        }

        // Save updated history to server
        try {
          // Preserve autopilot_resolved, resolved_at, and payment_verification if they exist
          const dataToSave = {
            history: negotiationHistory
          };

          // Always preserve these fields if they exist
          if (autopilotResolved) {
            dataToSave.autopilot_resolved = true;
          }
          if (resolvedAt) {
            dataToSave.resolved_at = resolvedAt;
          }
          if (paymentVerification) {
            dataToSave.payment_verification = paymentVerification;
          }

          await fetch(`/api/hijacking/history/${chat.values.case_id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dataToSave)
          });
        } catch (error) {
          console.error('Error saving hijack history:', error);
        }

        caseDetails.offers = negotiationHistory;
        caseDetails.payment_verification = paymentVerification;

        // Polling removed - we now use 2-minute verification system after each offer
        // No automatic polling to avoid unnecessary chat reloads
      }
    } catch (error) {
      console.error('Error fetching hijacking case:', error);
    }
  }

  // Store chat data for later use
  bubble.dataset.chatBody = chat.body;
  bubble.dataset.chatValues = JSON.stringify(chat.values);
  if (caseDetails) {
    bubble.dataset.caseDetails = JSON.stringify(caseDetails);
  }

  // Format the system message based on body type
  let messageContent = formatSystemMessage(chat.body, chat.values, chat.subject, caseDetails, chat.time_last_message, autopilotResolved);

  bubble.innerHTML = `
    ${messageContent}
    &lt;div style="font-size:10px; opacity:0.7; margin-top:10px;">${timestamp}&lt;/div>
  `;

  feed.appendChild(bubble);
  feed.scrollTop = feed.scrollHeight;

  // Add click handlers for hijacking offer buttons (if any)
  document.querySelectorAll('.hijacking-offer-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const caseId = this.dataset.caseId;
      // Deselect all buttons for this case
      document.querySelectorAll(`.hijacking-offer-btn[data-case-id="${caseId}"]`).forEach(b => {
        b.classList.remove('selected', 'hijacking-offer-btn-selected');
        b.classList.add('hijacking-offer-btn-unselected');
      });
      // Select this button
      this.classList.add('selected', 'hijacking-offer-btn-selected');
      this.classList.remove('hijacking-offer-btn-unselected');
    });
  });

  // Hide input footer for system messages
  const inputContainer = document.querySelector('.messenger-input');
  if (inputContainer) {
    inputContainer.classList.add('hidden');
  }
}

function formatSystemMessage(body, values, subject, caseDetails, messageTimestamp, autopilotResolved = false) {
  // Handle different system message types
  if (!body) return '&lt;div style="color: #94a3b8;">System notification (no details)&lt;/div>';

  const v = values || {};

  // Vessel hijacked
  if (body === 'vessel_got_hijacked' &amp;&amp; v.vessel_name) {
    const caseId = v.case_id;

    // Use case details if available, otherwise fall back to message values
    const requestedAmount = caseDetails?.requested_amount || v.requested_amount || 0;
    const userProposal = caseDetails?.user_proposal || null;
    const paidAmount = caseDetails?.paid_amount || null;
    const caseStatus = caseDetails?.status || null;
    const initialAmount = v.requested_amount || 0; // Original demand from message
    const registeredAt = caseDetails?.registered_at || messageTimestamp || null;

    let actionsHTML = '';
    let statusHTML = '';
    let negotiationHistoryHTML = '';

    // Use negotiation history from caseDetails if available (loaded from server)
    // Otherwise build it from current API data
    let negotiationHistory = caseDetails?.offers || [];

    // If no stored history, build from current data (first time)
    if (negotiationHistory.length === 0) {
      // Add initial pirate demand
      if (initialAmount > 0) {
        negotiationHistory.push({
          type: 'pirate',
          amount: initialAmount,
          timestamp: registeredAt
        });
      }

      // Add user proposal if exists
      if (userProposal &amp;&amp; userProposal > 0) {
        negotiationHistory.push({
          type: 'user',
          amount: userProposal,
          timestamp: null
        });
      }

      // Add pirate counter-offer if they changed the price
      if (requestedAmount !== initialAmount &amp;&amp; requestedAmount > 0) {
        negotiationHistory.push({
          type: 'pirate',
          amount: requestedAmount,
          timestamp: null
        });
      }
    }

    // Build negotiation history HTML
    if (negotiationHistory.length > 0) {
      negotiationHistoryHTML = `
        &lt;div class="hijacking-history-box">
          &lt;div class="hijacking-history-title"> Negotiation History:&lt;/div>
          &lt;div class="hijacking-history-content">
      `;

      negotiationHistory.forEach((offer) => {
        const isUserOffer = offer.type === 'user';
        const amount = offer.amount;
        const colorClass = isUserOffer ? 'hijacking-history-user' : 'hijacking-history-pirate';

        negotiationHistoryHTML += `
          &lt;div class="hijacking-history-item">
            &lt;span class="${colorClass}">
              ${isUserOffer ? ' You offered' : ' Pirates demanded'}:
            &lt;/span>
            &lt;strong class="${colorClass}">
              $${amount.toLocaleString()}
            &lt;/strong>
          &lt;/div>
        `;
      });

      negotiationHistoryHTML += `
          &lt;/div>
        &lt;/div>
      `;
    }

    // Check if case is actually resolved (paid OR status = 'solved')
    const isResolved = paidAmount !== null || caseStatus === 'solved';

    if (isResolved) {
      // Case is resolved (paid) - if paid_amount is null but status is 'solved', use requested_amount
      const finalAmount = paidAmount || requestedAmount;

      // Check payment verification
      const paymentVerification = caseDetails?.payment_verification;
      let verificationHTML = '';

      if (paymentVerification) {
        if (paymentVerification.verified) {
          // Payment verified - show Blackbeard signature ONLY if autopilot resolved
          if (autopilotResolved) {
            verificationHTML = `
              &lt;div style="position: absolute; right: -8px; top: calc(35% + 50px); transform: translateY(-50%); text-align: right;">
                &lt;div style="font-family: 'Segoe Script', 'Lucida Handwriting', 'Brush Script MT', cursive; font-size: 24px; font-weight: 900; color: #8b4513; opacity: 0.7; transform: rotate(-15deg); letter-spacing: 1px;">
                  Blackbeard
                &lt;/div>
              &lt;/div>
            `;
          } else {
            // User resolved manually - show verification details without Blackbeard signature
            verificationHTML = `
              &lt;div style="margin-top: 12px; padding: 10px; background: rgba(16, 185, 129, 0.1); border: 2px solid #10b981; border-radius: 4px;">
                &lt;div style="color: #10b981; font-weight: bold; font-size: 14px; text-align: center;"> Payment Verified&lt;/div>
                &lt;div style="margin-top: 8px; font-size: 12px; color: #9ca3af;">
                  Expected: &lt;strong>$${paymentVerification.expected_amount.toLocaleString()}&lt;/strong>&lt;br>
                  Paid: &lt;strong>$${paymentVerification.actual_paid.toLocaleString()}&lt;/strong>&lt;br>
                  Cash Before: $${paymentVerification.cash_before.toLocaleString()}&lt;br>
                  Cash After: $${paymentVerification.cash_after.toLocaleString()}
                &lt;/div>
              &lt;/div>
            `;
          }
        } else {
          // Payment NOT verified - show FAILED
          verificationHTML = `
            &lt;div style="margin-top: 12px; padding: 10px; background: rgba(239, 68, 68, 0.2); border: 2px solid #ef4444; border-radius: 4px;">
              &lt;div style="color: #ef4444; font-weight: bold; font-size: 18px; text-align: center;"> PAYMENT VERIFICATION FAILED &lt;/div>
              &lt;div style="margin-top: 8px; font-size: 12px; color: #fca5a5;">
                Expected: &lt;strong>$${paymentVerification.expected_amount.toLocaleString()}&lt;/strong>&lt;br>
                Actually Paid: &lt;strong>$${paymentVerification.actual_paid.toLocaleString()}&lt;/strong>&lt;br>
                Cash Before: $${paymentVerification.cash_before.toLocaleString()}&lt;br>
                Cash After: $${paymentVerification.cash_after.toLocaleString()}
              &lt;/div>
            &lt;/div>
          `;
        }
      } else {
        // No verification data - check autopilot_resolved flag
        if (autopilotResolved) {
          // Autopilot resolved without verification data (old case)
          verificationHTML = `
            &lt;div style="position: absolute; right: -8px; top: calc(35% + 50px); transform: translateY(-50%); text-align: right;">
              &lt;div style="font-family: 'Segoe Script', 'Lucida Handwriting', 'Brush Script MT', cursive; font-size: 24px; font-weight: 900; color: #8b4513; opacity: 0.7; transform: rotate(-15deg); letter-spacing: 1px;">
                Blackbeard
              &lt;/div>
            &lt;/div>
          `;
        } else {
          // Manual resolution without verification data
          verificationHTML = '';
        }
      }

      actionsHTML = `
        ${negotiationHistoryHTML}
        &lt;div class="hijacking-resolved-box">
          &lt;div class="hijacking-resolved-title"> Case Resolved&lt;/div>
          &lt;div class="hijacking-resolved-amount">
            Final Amount Paid: &lt;strong>$${finalAmount.toLocaleString()}&lt;/strong>
          &lt;/div>
          ${verificationHTML}
        &lt;/div>
      `;
    } else {
      // Case is still active - show negotiation status and buttons
      if (userProposal) {
        statusHTML = `
          &lt;div style="margin-top: 12px; padding: 10px; background: rgba(251, 146, 60, 0.1); border-left: 3px solid #fbbf24; border-radius: 4px;">
            &lt;div style="font-size: 12px; opacity: 0.9;">
              &lt;strong>Your Last Offer:&lt;/strong> $${userProposal.toLocaleString()}&lt;br>
              &lt;strong>Current Demand:&lt;/strong> $${requestedAmount.toLocaleString()}
            &lt;/div>
          &lt;/div>
        `;
      }

      // CRITICAL: Stop negotiating if price is under $20,000 OR if user has made 2+ offers
      // Below $20k threshold, accept the deal - you've reached a good price!
      // After 2 offers, must accept or risk game bug (pays full initial price on 3rd offer)
      const userOfferCount = negotiationHistory.filter(h => h.type === 'user').length;
      const canNegotiate = requestedAmount >= 20000 &amp;&amp; userOfferCount &lt; 2;

      if (canNegotiate) {
        actionsHTML = `
          ${statusHTML}
          ${negotiationHistoryHTML}
          &lt;div id="hijacking-actions-${caseId}" style="margin-top: 16px; display: flex; gap: 8px;">
            &lt;button class="btn-primary" onclick="window.acceptHijackingPrice(${caseId}, ${requestedAmount})" style="flex: 1; padding: 8px 16px; background: #4ade80; border: none; color: white; border-radius: 4px; cursor: pointer;">Accept Price ($${requestedAmount.toLocaleString()})&lt;/button>
            &lt;button class="btn-secondary" onclick="window.showNegotiateOptions(${caseId}, ${requestedAmount})" style="flex: 1; padding: 8px 16px; background: #3b82f6; border: none; color: white; border-radius: 4px; cursor: pointer;">Negotiate Price&lt;/button>
          &lt;/div>
          &lt;div id="hijacking-negotiate-${caseId}" style="display: none; margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 4px;">
            &lt;div style="margin-bottom: 12px; font-weight: bold; text-align: center;">Choose your counter-offer:&lt;/div>
            &lt;div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
              &lt;button class="hijacking-offer-btn" data-case-id="${caseId}" data-fixed-amount="1">
                &lt;div style="font-weight: bold; margin-bottom: 4px;">A Copper Pot&lt;/div>
                &lt;div style="font-size: 11px; opacity: 0.8;">$1&lt;/div>
              &lt;/button>
              &lt;button class="hijacking-offer-btn" data-case-id="${caseId}" data-percentage="0.25">
                &lt;div style="font-weight: bold; margin-bottom: 4px;">A Tattered Patch&lt;/div>
                &lt;div style="font-size: 11px; opacity: 0.8;">$${Math.floor(requestedAmount * 0.25).toLocaleString()}&lt;/div>
              &lt;/button>
            &lt;/div>
            &lt;hr style="border: none; border-top: 1px solid rgba(255, 255, 255, 0.1); margin: 12px 0;">
            &lt;div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
              &lt;button class="hijacking-offer-btn" data-case-id="${caseId}" data-percentage="0.50">
                &lt;div style="font-weight: bold; margin-bottom: 4px;">A Fair Trade&lt;/div>
                &lt;div style="font-size: 11px; opacity: 0.8;">$${Math.floor(requestedAmount * 0.50).toLocaleString()}&lt;/div>
              &lt;/button>
              &lt;button class="hijacking-offer-btn" data-case-id="${caseId}" data-percentage="0.75">
                &lt;div style="font-weight: bold; margin-bottom: 4px;">The Lion's Share&lt;/div>
                &lt;div style="font-size: 11px; opacity: 0.8;">$${Math.floor(requestedAmount * 0.75).toLocaleString()}&lt;/div>
              &lt;/button>
            &lt;/div>
            &lt;div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              &lt;button class="btn-primary" onclick="window.proposeHijackingPrice(${caseId}, ${requestedAmount})" style="padding: 8px 12px; background: #3b82f6; border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: 500;">Propose Price&lt;/button>
              &lt;button class="btn-secondary" onclick="window.cancelNegotiate(${caseId})" style="padding: 8px 12px; background: #6b7280; border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: 500;">Cancel&lt;/button>
            &lt;/div>
          &lt;/div>
        `;
      } else {
        // Price is under $20,000 OR user has made 3+ offers - only allow accept, no more negotiation
        const maxOffersReached = userOfferCount >= 2;

        if (maxOffersReached) {
          // After 3 offers: Show critical warning about game bug
          actionsHTML = `
            ${statusHTML}
            ${negotiationHistoryHTML}
            &lt;div style="margin-top: 12px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; text-align: center;">
              &lt;div style="font-size: 14px; font-weight: bold; color: #ef4444; margin-bottom: 4px;"> Maximum Offers Reached&lt;/div>
              &lt;div style="font-size: 12px; color: #9ca3af;">You must accept or risk paying the full initial ransom&lt;/div>
            &lt;/div>
            &lt;div id="hijacking-actions-${caseId}" style="margin-top: 16px;">
              &lt;button class="btn-primary" onclick="window.acceptHijackingPrice(${caseId}, ${requestedAmount})" style="width: 100%; padding: 12px; background: #10b981; border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: 500;">Accept Price ($${requestedAmount.toLocaleString()})&lt;/button>
            &lt;/div>
          `;
        } else {
          // Price is under $20,000 - show Blackbeard message
          actionsHTML = `
            ${statusHTML}
            ${negotiationHistoryHTML}
            &lt;div style="margin-top: 12px; padding: 12px; background: rgba(34, 197, 94, 0.1); border-left: 3px solid #4ade80; border-radius: 4px; position: relative;">
              &lt;div style="font-size: 13px; font-weight: bold; color: #4ade80; margin-bottom: 8px;">
                 Goal achieved, won't get cheaper. Give them the few bucks
              &lt;/div>
              &lt;div style="font-size: 12px; opacity: 0.8; font-style: italic; margin-top: 8px; color: #6b7280;">
                "If you were waiting for the opportune moment, that was it."&lt;br>
                 Captain Blackbeard
              &lt;/div>
              &lt;div style="position: absolute; right: -8px; top: calc(50% - 10px); transform: translateY(-50%); text-align: right;">
                &lt;div style="font-family: 'Segoe Script', 'Lucida Handwriting', 'Brush Script MT', cursive; font-size: 24px; font-weight: 900; color: #8b4513; opacity: 0.7; transform: rotate(-15deg); letter-spacing: 1px;">
                  Blackbeard
                &lt;/div>
              &lt;/div>
            &lt;/div>
            &lt;div id="hijacking-actions-${caseId}" style="margin-top: 16px;">
              &lt;button class="btn-primary" onclick="window.acceptHijackingPrice(${caseId}, ${requestedAmount})" style="padding: 12px 24px; background: #4ade80; border: none; color: white; border-radius: 4px; cursor: pointer; font-weight: bold;">Pay Ransom ($${requestedAmount.toLocaleString()})&lt;/button>
            &lt;/div>
          `;
        }
      }
    }

    // Get original ransom demand (first pirate offer)
    const originalDemand = negotiationHistory.find(h => h.type === 'pirate')?.amount || initialAmount || requestedAmount;

    // Format location: remove underscores and capitalize first letters
    const formattedLocation = (v.tr_danger_zone || 'Unknown')
      .split('_')
      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
      .join(' ');

    return `
      &lt;div class="hijacking-info-box">
        &lt;div class="hijacking-info-title"> Vessel Hijacked!&lt;/div>
        &lt;div class="hijacking-info-details">
          &lt;strong>Vessel:&lt;/strong> ${escapeHtml(v.vessel_name)}&lt;br>
          &lt;strong>Location:&lt;/strong> ${escapeHtml(formattedLocation)}&lt;br>
          &lt;strong>Ransom Demand:&lt;/strong> $${originalDemand.toLocaleString()}&lt;br>
          &lt;strong>Case ID:&lt;/strong> ${caseId || 'N/A'}
        &lt;/div>
      &lt;/div>
      ${actionsHTML}
    `;
  }

  // Stock transactions
  if (body === 'user_bought_stock' &amp;&amp; v.stockOwner) {
    return `
      &lt;div style="color: #4ade80;"> Stock Purchase&lt;/div>
      &lt;div style="margin-top: 8px;">
        &lt;strong>Company:&lt;/strong> ${escapeHtml(v.stockOwner)}&lt;br>
        &lt;strong>Shares:&lt;/strong> ${(v.stockAmount || 0).toLocaleString()}&lt;br>
        &lt;strong>Total Value:&lt;/strong> $${(v.totalAmount || 0).toLocaleString()}
      &lt;/div>
    `;
  }

  if (body === 'user_sold_stock' &amp;&amp; v.stockOwner) {
    return `
      &lt;div style="color: #fbbf24;"> Stock Sale&lt;/div>
      &lt;div style="margin-top: 8px;">
        &lt;strong>Company:&lt;/strong> ${escapeHtml(v.stockOwner)}&lt;br>
        &lt;strong>Shares:&lt;/strong> ${(v.stockAmount || 0).toLocaleString()}&lt;br>
        &lt;strong>Total Value:&lt;/strong> $${(v.totalAmount || 0).toLocaleString()}
      &lt;/div>
    `;
  }

  // Alliance donation
  if (body.includes('alliance') &amp;&amp; body.includes('donation') &amp;&amp; v.amount) {
    return `
      &lt;div style="color: #a78bfa;"> Alliance Donation&lt;/div>
      &lt;div style="margin-top: 8px;">
        &lt;strong>Amount:&lt;/strong> ${v.amount}&lt;br>
        ${v.comment ? `&lt;strong>Message:&lt;/strong> "${escapeHtml(v.comment)}"` : ''}
      &lt;/div>
    `;
  }

  // Alliance accepted
  if (body.includes('accepted_to_join_alliance') &amp;&amp; v.alliance_name) {
    return `
      &lt;div style="color: #4ade80;"> Alliance Joined&lt;/div>
      &lt;div style="margin-top: 8px;">
        You have joined &lt;strong>${escapeHtml(v.alliance_name)}&lt;/strong>!
      &lt;/div>
    `;
  }

  // User applied to join alliance
  if (body === 'user_applied_to_join_alliance_message' &amp;&amp; v.company_name) {
    return `
      &lt;div style="color: #fbbf24; font-size: 16px; font-weight: bold;">Ahoy Captain!&lt;/div>
      &lt;div style="margin-top: 12px; line-height: 1.6;">
        &lt;strong>${escapeHtml(v.company_name)}&lt;/strong> has applied to join your alliance.&lt;br>&lt;br>
        Respond to him in the recruitment section in the alliance menu.
      &lt;/div>
    `;
  }

  // Alliance interim CEO notification
  if (body === 'alliance_interrim_ceo' &amp;&amp; v.allianceName) {
    const allianceName = escapeHtml(v.allianceName);
    const ceoName = escapeHtml(v.currentCeo || 'the CEO');
    const buttonId = `interimCeoThankBtn_${Date.now()}`;

    // Attach event listener after render
    setTimeout(() => {
      const btn = document.getElementById(buttonId);
      if (btn) {
        btn.addEventListener('click', async () => {
          btn.disabled = true;
          btn.textContent = 'Sending...';

          try {
            // Fetch alliance members to get CEO user ID
            const membersResponse = await fetch('/api/alliance/members');
            const membersData = await membersResponse.json();

            if (!membersResponse.ok) {
              throw new Error('Failed to fetch alliance members');
            }

            // Find CEO in members list
            const ceoMember = membersData.members?.find(m =>
              m.company_name === v.currentCeo || m.role === 'ceo'
            );

            if (!ceoMember) {
              throw new Error('CEO not found in alliance members');
            }

            // Send thank you message to alliance chat with CEO mention
            const thankYouMessage = `[${ceoMember.user_id}] Thank you for your trust!`;

            const sendResponse = await fetch('/api/alliance/send-message', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message: thankYouMessage })
            });

            if (!sendResponse.ok) {
              throw new Error('Failed to send message');
            }

            btn.textContent = 'Message Sent!';
            btn.style.background = 'var(--color-success-20)';
            btn.style.borderColor = 'var(--color-success-30)';
          } catch (error) {
            console.error('[Interim CEO] Error sending thank you:', error);
            btn.textContent = 'Failed to send';
            btn.style.background = 'var(--color-danger-20)';
            btn.disabled = false;
          }
        });
      }
    }, 100);

    return `
      &lt;div style="color: #fbbf24; font-size: 18px; font-weight: bold;"> Congratulations!&lt;/div>
      &lt;div style="margin-top: 12px; line-height: 1.6;">
        You have been made &lt;strong>Interim CEO&lt;/strong> in your alliance &lt;strong>${allianceName}&lt;/strong>
        as the current CEO &lt;strong>${ceoName}&lt;/strong> has been inactive.&lt;br>&lt;br>
        Once he is active again he will resume his role, but until then you're in charge!
      &lt;/div>
      &lt;div style="margin-top: 16px;">
        &lt;button id="${buttonId}" style="background: var(--color-info-20); border: 1px solid var(--color-info-30); color: var(--color-info-lighter); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
          Say Thank You
        &lt;/button>
      &lt;/div>
    `;
  }

  // Tutorial/intro messages
  if (body.startsWith('intro_pm_')) {
    return `
      &lt;div style="color: #60a5fa;"> Tutorial Message&lt;/div>
      ${subject ? `&lt;div style="margin-top: 8px;">${escapeHtml(subject)}&lt;/div>` : ''}
    `;
  }

  // Fallback: show raw data
  return `
    &lt;div style="color: #94a3b8;">&lt;strong>Type:&lt;/strong> ${escapeHtml(body)}&lt;/div>
    ${subject ? `&lt;div style="margin-top: 5px;">&lt;strong>Subject:&lt;/strong> ${escapeHtml(subject)}&lt;/div>` : ''}
    ${values ? `&lt;div style="margin-top: 5px; font-size: 11px; opacity: 0.8;">&lt;strong>Data:&lt;/strong> ${escapeHtml(JSON.stringify(values, null, 2))}&lt;/div>` : ''}
  `;
}

export function closeMessenger() {
  // Reset hijacking inbox flag
  window.cameFromHijackingInbox = false;

  // Stop hijacking polling when closing messenger
  stopHijackingPolling();

  // Clear any active hijacking timers
  Object.keys(window).forEach(key => {
    if (key.startsWith('hijackTimer_')) {
      clearInterval(window[key]);
      delete window[key];
    }
  });

  const messengerOverlay = document.getElementById('messengerOverlay');
  messengerOverlay.classList.add('hidden');
  // Remove hijacking case view class
  messengerOverlay.classList.remove('hijacking-case-view');
  currentPrivateChat = { chatId: null, subject: null, targetCompanyName: null, targetUserId: null, messages: [], isNewChat: false, isSystemChat: false };
  document.getElementById('messengerFeed').innerHTML = '';
  document.getElementById('messengerInput').value = '';
  document.getElementById('subjectInput').value = '';
  document.getElementById('subjectInputWrapper').classList.add('hidden');
  // Restore input area visibility
  document.getElementById('messengerInput').classList.remove('hidden');
  document.getElementById('sendPrivateMessageBtn').classList.remove('hidden');
}

/**
 * Closes chat selection overlay and clears selection state.
 */
export function closeChatSelection() {
  document.getElementById('chatSelectionOverlay').classList.add('hidden');
  userChatsForSelection = [];
}

/**
 * Displays overlay showing all private conversations sorted by recent activity.
 * Provides unified view of all chats with delete functionality per conversation.
 *
 * Features:
 * - Sorted by most recent message timestamp
 * - Shows message preview and timestamp
 * - Displays unread indicator badge
 * - Trash icon per chat for deletion
 * - Clicking chat opens full conversation
 *
 * Side Effects:
 * - Fetches all chats from API
 * - Shows all chats overlay
 * - Registers click handlers for each chat and delete button
 *
 * @async
 * @returns {Promise&lt;void>}
 *
 * @example
 * // User clicks mailbox icon in toolbar
 * showAllChats();
 */
export async function showAllChats() {
  try {
    const data = await fetchMessengerChats();
    // Exclude hijacking messages (they go to Phone Booth)
    const chats = data.chats.filter(chat =>
      !(chat.system_chat &amp;&amp; chat.body === 'vessel_got_hijacked')
    );

    // Fetch contacts to build name-to-ID mapping
    const contactsData = await fetchContacts();
    const nameToIdMap = new Map();

    // Add all contacts to the map
    if (contactsData.contacts) {
      contactsData.contacts.forEach(contact => {
        if (contact.company_name &amp;&amp; contact.id) {
          nameToIdMap.set(contact.company_name, contact.id);
        }
      });
    }

    // Add all alliance contacts to the map
    if (contactsData.alliance_contacts) {
      contactsData.alliance_contacts.forEach(contact => {
        if (contact.company_name &amp;&amp; contact.id) {
          nameToIdMap.set(contact.company_name, contact.id);
        }
      });
    }

    if (window.DEBUG_MODE) {
      console.log('[MESSENGER DEBUG] Built name-to-ID map with', nameToIdMap.size, 'entries');
    }

    const sortedChats = chats.sort((a, b) => (b.time_last_message || 0) - (a.time_last_message || 0));

    const listContainer = document.getElementById('allChatsList');

    if (sortedChats.length === 0) {
      listContainer.innerHTML = '&lt;div class="empty-message">No private conversations yet.&lt;/div>';
    } else {
      listContainer.innerHTML = sortedChats.map((chat, index) => {
        const isSystemChat = chat.system_chat || false;
        const lastMsg = isSystemChat ? getSystemMessageTitle(chat.body, chat.values) : (chat.last_message ? escapeHtml(chat.last_message.substring(0, 60)) + '...' : 'No messages');
        const subject = isSystemChat ? ' System Notification' : (chat.subject || 'No subject');
        const participant = chat.participants_string || 'Unknown';
        const unreadIndicator = chat.new ? '&lt;span class="unread-indicator">&lt;/span>' : '';

        // Format timestamp
        const timestamp = formatTimestamp(chat.time_last_message);

        return `
          &lt;div class="chat-selection-item" data-chat-index="${index}" style="position: relative; padding-right: 40px;">
            &lt;div style="flex: 1;">
              &lt;h3>${escapeHtml(participant)} - ${escapeHtml(subject)}${unreadIndicator}&lt;/h3>
              &lt;p>${lastMsg}&lt;/p>
              &lt;p style="font-size: 11px; opacity: 0.7; margin-top: 4px;">${timestamp}&lt;/p>
            &lt;/div>
            &lt;button class="delete-chat-btn" data-chat-index="${index}">&lt;/button>
          &lt;/div>
        `;
      }).join('');

      listContainer.querySelectorAll('.chat-selection-item').forEach(item => {
        const chatItem = item.querySelector('div[style*="flex: 1"]');
        if (chatItem) {
          chatItem.addEventListener('click', async () => {
            const chatIndex = parseInt(item.dataset.chatIndex);
            const selectedChat = sortedChats[chatIndex];

            if (window.DEBUG_MODE) {
              console.log('[MESSENGER DEBUG] Opening chat from showAllChats:');
              console.log('  selectedChat:', selectedChat);
              console.log('  participants_string:', selectedChat.participants_string);
              console.log('  own_user_id:', data.own_user_id);
            }

            const targetCompanyName = selectedChat.participants_string;
            let targetUserId = nameToIdMap.get(targetCompanyName);

            if (window.DEBUG_MODE) {
              console.log('  targetUserId from map:', targetUserId, 'type:', typeof targetUserId);
              console.log('  targetCompanyName:', targetCompanyName);
            }

            // If not found in contact list and not a system chat, try user search
            if (!targetUserId &amp;&amp; !selectedChat.system_chat &amp;&amp; targetCompanyName) {
              if (window.DEBUG_MODE) {
                console.log('[MESSENGER DEBUG] User not in contacts, searching via /user/search...');
              }
              try {
                const searchResults = await searchUsers(targetCompanyName);
                if (searchResults.data &amp;&amp; searchResults.data.companies &amp;&amp; searchResults.data.companies.length > 0) {
                  // Find exact match
                  const exactMatch = searchResults.data.companies.find(c => c.company_name === targetCompanyName);
                  if (exactMatch) {
                    targetUserId = exactMatch.id;
                    if (window.DEBUG_MODE) {
                      console.log('[MESSENGER DEBUG] Found user via search:', targetUserId);
                    }
                  } else if (window.DEBUG_MODE) {
                    console.warn('[MESSENGER DEBUG] No exact match in search results');
                  }
                }
              } catch (error) {
                if (window.DEBUG_MODE) {
                  console.error('[MESSENGER DEBUG] User search failed:', error);
                }
              }
            }

            if (!targetUserId &amp;&amp; !selectedChat.system_chat) {
              if (window.DEBUG_MODE) {
                console.warn('[MESSENGER DEBUG] Could not resolve user ID for:', targetCompanyName);
              }
            }

            document.getElementById('allChatsOverlay').classList.add('hidden');
            openExistingChat(targetCompanyName, targetUserId, selectedChat, data.own_user_id);
          });
        }
      });

      listContainer.querySelectorAll('.delete-chat-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const chatIndex = parseInt(btn.dataset.chatIndex);
          const chatToDelete = sortedChats[chatIndex];
          const chatItem = btn.closest('.chat-selection-item');

          const wasDeleted = await deleteChatWithConfirmation(chatToDelete);
          // Remove element immediately from DOM if deleted
          if (wasDeleted &amp;&amp; chatItem) {
            chatItem.remove();
          }
        });
      });
    }

    document.getElementById('allChatsOverlay').classList.remove('hidden');

  } catch (error) {
    console.error('Error loading all chats:', error);
    alert(`Error: ${error.message}`);
  }
}

/**
 * Closes the all chats overlay.
 */
export function closeAllChats() {
  document.getElementById('allChatsOverlay').classList.add('hidden');
}

/**
 * Updates the unread message badge count in the UI.
 * Shows count of unread user messages (excludes system notifications).
 *
 * Badge Behavior:
 * - Visible only when unread count > 0
 * - Hidden when no unread messages
 * - Only counts non-system chats
 *
 * Side Effects:
 * - Fetches all messenger chats from API
 * - Updates badge visibility and count
 *
 * @async
 * @returns {Promise&lt;void>}
 */
export async function updateUnreadBadge(retryCount = 0) {
  try {
    const data = await fetchMessengerChats();
    // Filter out hijacking messages - they go to Blackbeard's Phone Booth now
    const unreadCount = data.chats.filter(chat => {
      if (!chat.new) return false;
      // Exclude hijacking system messages
      if (chat.system_chat &amp;&amp; chat.body === 'vessel_got_hijacked') {
        return false;
      }
      return true;
    }).length;

    // Get previous count from per-user cache
    const cacheKey = window.CACHE_KEY || 'badgeCache';
    const previousCache = localStorage.getItem(cacheKey);
    const previousCount = previousCache ? JSON.parse(previousCache).messages || 0 : 0;

    // Update badge using badge-manager
    updateBadge('unreadBadge', unreadCount, unreadCount > 0, 'RED');

    if (unreadCount > 0) {

      // Show browser notification if count increased and notifications are enabled
      if (unreadCount > previousCount &amp;&amp; window.settings?.enableInboxNotifications) {
        // Find new unread messages
        const unreadChats = data.chats.filter(chat => chat.new);
        const systemMessages = unreadChats.filter(chat => chat.system_chat);
        const userMessages = unreadChats.filter(chat => !chat.system_chat);

        let notificationTitle = ` ${unreadCount} unread message${unreadCount === 1 ? '' : 's'}`;
        let notificationBody = '';

        if (systemMessages.length > 0 &amp;&amp; userMessages.length > 0) {
          notificationBody = `${userMessages.length} private message${userMessages.length === 1 ? '' : 's'}, ${systemMessages.length} system notification${systemMessages.length === 1 ? '' : 's'}`;
        } else if (systemMessages.length > 0) {
          // Check if any are hijack messages
          const hijackMessages = systemMessages.filter(chat => chat.body === 'vessel_got_hijacked');
          if (hijackMessages.length > 0) {
            notificationTitle = ' Vessel Hijacked!';
            notificationBody = `${hijackMessages.length} vessel${hijackMessages.length === 1 ? ' has' : 's have'} been hijacked! Check your inbox immediately.`;
          } else {
            notificationBody = `${systemMessages.length} system notification${systemMessages.length === 1 ? '' : 's'}`;
          }
        } else {
          notificationBody = `${userMessages.length} new private message${userMessages.length === 1 ? '' : 's'}`;
        }

        // Show desktop notification
        if (Notification.permission === 'granted') {
          showNotification(notificationTitle, {
            body: `

${notificationBody}`,
            icon: '/favicon.ico',
            tag: "shipping-manager-inbox",
            requireInteraction: systemMessages.some(chat => chat.body === 'vessel_got_hijacked'), // Keep hijack notifications visible
            data: { action: 'open-inbox' }
          });
        }
      }
    }

    // Save to cache for next page load
    if (window.saveBadgeCache) {
      window.saveBadgeCache({ messages: unreadCount });
    }
  } catch (error) {
    // Check if it's a network error (ERR_NETWORK_CHANGED, Failed to fetch, etc.)
    const isNetworkError = error.message.includes('fetch') ||
                          error.message.includes('network') ||
                          error.name === 'TypeError';

    // Retry up to 2 times with exponential backoff
    if (isNetworkError &amp;&amp; retryCount &lt; 2) {
      const delay = Math.pow(2, retryCount) * 1000; // 1s, 2s
      console.log(`[Messenger] Network error, retrying in ${delay}ms (attempt ${retryCount + 1}/2)`);
      setTimeout(() => updateUnreadBadge(retryCount + 1), delay);
    } else {
      console.error('Error checking unread messages:', error);
    }
  }
}

export async function sendPrivateMessage() {
  const messageInput = document.getElementById('messengerInput');
  const subjectInput = document.getElementById('subjectInput');
  const sendBtn = document.getElementById('sendPrivateMessageBtn');
  const message = messageInput.value.trim();

  if (!message || message.length > 1000) {
    alert('Invalid message length.');
    return;
  }

  let subject;
  if (currentPrivateChat.isNewChat) {
    subject = subjectInput.value.trim();
    if (!subject || subject.length === 0) {
      alert('Please enter a subject.');
      subjectInput.focus();
      return;
    }
  } else {
    subject = currentPrivateChat.subject;
  }

  // Show "Sending..." feedback
  const originalBtnText = sendBtn.textContent;
  sendBtn.textContent = 'Sending...';
  sendBtn.disabled = true;
  messageInput.disabled = true;

  try {
    await apiSendPrivateMessage(currentPrivateChat.targetUserId, subject, message);

    // Show success notification
    showSideNotification(` &lt;strong>Message sent&lt;/strong>&lt;br>&lt;br>Sent to ${escapeHtml(currentPrivateChat.targetCompanyName)}`, 'success', 3000);

    messageInput.value = '';
    messageInput.style.height = 'auto';

    if (window.debouncedUpdateUnreadBadge) {
      window.debouncedUpdateUnreadBadge();
    }

    // Reload messages to show the new message in the chat
    if (currentPrivateChat.chatId) {
      // Existing chat - reload messages
      await loadPrivateMessages(currentPrivateChat.chatId);
    } else {
      // New chat - refresh to get the chat ID
      const savedCompanyName = currentPrivateChat.targetCompanyName;
      const savedUserId = currentPrivateChat.targetUserId;
      closeMessenger();
      setTimeout(() => {
        openMessenger(savedCompanyName, savedUserId);
      }, 300); // Faster reload
    }

  } catch (error) {
    showSideNotification(` &lt;strong>Error&lt;/strong>&lt;br>&lt;br>${escapeHtml(error.message)}`, 'error', 5000);
  } finally {
    sendBtn.textContent = originalBtnText;
    sendBtn.disabled = false;
    messageInput.disabled = false;
  }
}

export function getCurrentPrivateChat() {
  return currentPrivateChat;
}

async function deleteChatWithConfirmation(chat) {
  const participant = chat.participants_string || 'Unknown';
  const isSystemChat = chat.system_chat || false;

  // For system chats, use getSystemMessageTitle() to format subject
  let subject = chat.subject || 'No subject';
  if (isSystemChat &amp;&amp; chat.body) {
    subject = getSystemMessageTitle(chat.body, chat.values);
  }

  const confirmed = await showConfirmDialog({
    title: ' Delete Chat',
    message: `Do you want to delete this conversation?`,
    details: [
      { label: 'Participant', value: participant },
      { label: 'Subject', value: subject }
    ],
    confirmText: 'Delete',
    cancelText: 'Cancel'
  });

  if (!confirmed) return false;

  try {
    // Extract case_id from values if this is a hijacking message
    const caseId = (isSystemChat &amp;&amp; chat.body === 'vessel_got_hijacked' &amp;&amp; chat.values?.case_id)
      ? chat.values.case_id
      : null;

    await apiDeleteChat(chat.id, isSystemChat, caseId);

    if (window.debouncedUpdateUnreadBadge) {
      window.debouncedUpdateUnreadBadge();
    }

    return true;
  } catch (error) {
    alert(`Error deleting chat: ${error.message}`);
    return false;
  }
}

export async function deleteCurrentChat() {
  if (!currentPrivateChat.chatId) {
    alert('No chat to delete');
    return;
  }

  // For system chats, use getSystemMessageTitle() to format subject
  let subject = currentPrivateChat.subject || 'No subject';
  if (currentPrivateChat.isSystemChat &amp;&amp; currentPrivateChat.body) {
    subject = getSystemMessageTitle(currentPrivateChat.body, currentPrivateChat.values);
  }

  const confirmed = await showConfirmDialog({
    title: ' Delete Chat',
    message: `Do you want to delete this conversation?`,
    details: [
      { label: 'Participant', value: currentPrivateChat.targetCompanyName },
      { label: 'Subject', value: subject }
    ],
    confirmText: 'Delete',
    cancelText: 'Cancel'
  });

  if (!confirmed) return;

  try {
    // Extract case_id from values if this is a hijacking message
    const isSystemChat = currentPrivateChat.isSystemChat || false;
    const caseId = (isSystemChat &amp;&amp; currentPrivateChat.body === 'vessel_got_hijacked' &amp;&amp; currentPrivateChat.values?.case_id)
      ? currentPrivateChat.values.case_id
      : null;

    await apiDeleteChat(currentPrivateChat.chatId, isSystemChat, caseId);
    closeMessenger();

    if (window.debouncedUpdateUnreadBadge) {
      window.debouncedUpdateUnreadBadge();
    }
  } catch (error) {
    alert(`Error deleting chat: ${error.message}`);
  }
}

/**
 * Hijacking handler: Accept the full ransom price
 */
window.acceptHijackingPrice = async function(caseId, amount) {
  // CRITICAL: ALWAYS get current price from API - NEVER trust cached values!
  let actualAmount = amount;

  try {
    const caseResponse = await fetch('/api/hijacking/get-case', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ case_id: caseId })
    });

    const caseData = await caseResponse.json();
    if (caseResponse.ok &amp;&amp; caseData.data) {
      actualAmount = caseData.data.requested_amount;
      console.log(`[Hijacking] Current price from API: $${actualAmount} (cached was: $${amount})`);
    }
  } catch (error) {
    console.error('[Hijacking] Failed to get current price, using cached:', error);
  }

  // Get current cash from header display
  const cashDisplay = document.getElementById('cashDisplay');
  const cashText = cashDisplay?.textContent || '$0';
  const currentCash = parseInt(cashText.replace(/[$,\s]/g, '')) || 0;

  const confirmed = await showConfirmDialog({
    title: ' Accept Ransom',
    message: `Accept the ransom demand and pay the full price?`,
    details: [
      { label: 'Case ID', value: caseId },
      { label: 'Total Cost', value: `$${actualAmount.toLocaleString()}` },
      { label: 'Available Cash', value: `$${currentCash.toLocaleString()}` }
    ],
    confirmText: 'Pay Ransom',
    cancelText: 'Cancel'
  });

  if (!confirmed) return;

  try {
    // Pay the ransom (not submit offer!)
    const response = await fetch('/api/hijacking/pay', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ case_id: caseId })
    });

    const data = await response.json();
    console.log('[Hijacking] Pay ransom response:', data);

    if (!response.ok) {
      throw new Error(data.error || 'Failed to pay ransom');
    }

    // Reload the case details to get the REAL status from API
    const caseResponse = await fetch('/api/hijacking/get-case', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ case_id: caseId })
    });

    const caseData = await caseResponse.json();
    console.log('[Hijacking] Get case after accept:', caseData);

    if (!caseResponse.ok || !caseData.data) {
      throw new Error('Failed to reload case details');
    }

    const updatedCase = caseData.data;

    // Get the original chat values from the stored data
    const feed = document.getElementById('messengerFeed');
    const bubble = feed.querySelector('.message-bubble.system');

    if (bubble) {
      // Retrieve stored chat values
      const storedValues = bubble.dataset.chatValues ? JSON.parse(bubble.dataset.chatValues) : {};

      // Reconstruct chat with updated data
      const chat = {
        body: 'vessel_got_hijacked',
        values: {
          case_id: caseId,
          vessel_name: storedValues.vessel_name || 'Unknown',
          tr_danger_zone: storedValues.tr_danger_zone || 'Unknown',
          requested_amount: updatedCase.requested_amount || 0
        },
        time_last_message: Date.now() / 1000
      };

      // Re-render the message with updated case details
      await displaySystemMessage(chat);

      // Check if payment was actually successful (paid_amount OR status = 'solved')
      if (updatedCase.paid_amount !== null || updatedCase.status === 'solved') {
        const finalAmount = updatedCase.paid_amount || updatedCase.requested_amount;
        showSideNotification(
          `&lt;strong> Ransom Paid!&lt;/strong>&lt;br>&lt;br>` +
          `Amount: $${finalAmount.toLocaleString()}&lt;br>` +
          `Your vessel will be released.`,
          'success',
          5000
        );
      } else {
        // Payment didn't go through - show current status
        showSideNotification(
          `&lt;strong>Payment sent&lt;/strong>&lt;br>&lt;br>` +
          `Your offer: $${amount.toLocaleString()}&lt;br>` +
          `Current demand: $${updatedCase.requested_amount.toLocaleString()}`,
          'info',
          5000
        );
      }
    }

  } catch (error) {
    console.error('[Hijacking] Error:', error);
    showSideNotification(`Error: ${error.message}`, 'error');
  }
};

/**
 * Hijacking handler: Show negotiation options
 */
window.showNegotiateOptions = function(caseId) {
  const actionsDiv = document.getElementById(`hijacking-actions-${caseId}`);
  const negotiateDiv = document.getElementById(`hijacking-negotiate-${caseId}`);

  if (actionsDiv) actionsDiv.style.display = 'none';
  if (negotiateDiv) negotiateDiv.style.display = 'block';
};

/**
 * Hijacking handler: Cancel negotiation and return to main actions
 */
window.cancelNegotiate = function(caseId) {
  const actionsDiv = document.getElementById(`hijacking-actions-${caseId}`);
  const negotiateDiv = document.getElementById(`hijacking-negotiate-${caseId}`);

  if (actionsDiv) actionsDiv.style.display = 'flex';
  if (negotiateDiv) negotiateDiv.style.display = 'none';

  // Clear radio selection
  const radios = document.querySelectorAll(`input[name="hijacking-offer-${caseId}"]`);
  radios.forEach(radio => radio.checked = false);
};

/**
 * Hijacking handler: Propose selected counter-offer
 */
window.proposeHijackingPrice = async function(caseId, requestedAmount) {
  const selectedButton = document.querySelector(`.hijacking-offer-btn[data-case-id="${caseId}"].selected`);

  if (!selectedButton) {
    showSideNotification('Please select an offer option', 'warning');
    return;
  }

  // Check if this is a fixed amount offer or percentage-based
  let offerAmount;
  if (selectedButton.dataset.fixedAmount) {
    offerAmount = parseInt(selectedButton.dataset.fixedAmount);
  } else {
    const percentage = parseFloat(selectedButton.dataset.percentage);
    offerAmount = Math.floor(requestedAmount * percentage);
  }

  // Get offer name from button
  const offerName = selectedButton.querySelector('div:first-child').textContent;

  // Get current cash from header display
  const cashDisplay = document.getElementById('cashDisplay');
  const cashText = cashDisplay?.textContent || '$0';
  const currentCash = parseInt(cashText.replace(/[$,\s]/g, '')) || 0;

  const confirmed = await showConfirmDialog({
    title: ' Submit Counter-Offer',
    message: `Submit this counter-offer to the pirates?`,
    details: [
      { label: 'Case ID', value: caseId },
      { label: 'Offer Type', value: offerName },
      { label: 'Total Cost', value: `$${offerAmount.toLocaleString()}` },
      { label: 'Available Cash', value: `$${currentCash.toLocaleString()}` }
    ],
    confirmText: 'Submit Offer',
    cancelText: 'Cancel'
  });

  if (!confirmed) return;

  try {
    // Send the offer
    const response = await fetch('/api/hijacking/submit-offer', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ case_id: caseId, amount: offerAmount })
    });

    const data = await response.json();
    console.log('[Hijacking] Submit offer response:', data);

    if (!response.ok) {
      throw new Error(data.error || 'Failed to submit offer');
    }

    // Save user's offer to history immediately
    try {
      // Load existing history
      const historyResponse = await fetch(`/api/hijacking/history/${caseId}`);
      const historyData = await historyResponse.json();
      const negotiationHistory = historyData.history || [];

      // Add user's offer to history
      negotiationHistory.push({
        type: 'user',
        amount: offerAmount,
        timestamp: Date.now() / 1000
      });

      // Save updated history (preserve ALL existing metadata fields)
      const dataToSave = {
        history: negotiationHistory
      };

      // Preserve autopilot_resolved if it exists
      if (historyData.autopilot_resolved !== undefined) {
        dataToSave.autopilot_resolved = historyData.autopilot_resolved;
      }

      // Preserve resolved_at if it exists
      if (historyData.resolved_at) {
        dataToSave.resolved_at = historyData.resolved_at;
      }

      // Preserve payment_verification if it exists
      if (historyData.payment_verification) {
        dataToSave.payment_verification = historyData.payment_verification;
      }

      await fetch(`/api/hijacking/history/${caseId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dataToSave)
      });

      console.log('[Hijacking] User offer saved to history:', offerAmount);
    } catch (error) {
      console.error('[Hijacking] Failed to save user offer to history:', error);
    }

    // Show success notification
    showSideNotification(`Offer submitted!`, 'success', 3000);

    // Get counter-offer from API response (immediate, no waiting!)
    const pirateCounterOffer = data.data?.requested_amount;
    console.log('[Hijacking] Submit offer response:', data);
    console.log('[Hijacking] Pirate counter-offer:', pirateCounterOffer);

    if (!pirateCounterOffer) {
      throw new Error('API did not return counter-offer');
    }

    // Save pirate counter-offer to history
    let negotiationHistory = [];
    try {
      const historyResponse = await fetch(`/api/hijacking/history/${caseId}`);
      const historyData = await historyResponse.json();
      negotiationHistory = historyData.history || [];

      negotiationHistory.push({
        type: 'pirate',
        amount: pirateCounterOffer,
        timestamp: Date.now() / 1000
      });

      // Save updated history (preserve ALL existing metadata fields)
      const dataToSave = {
        history: negotiationHistory
      };

      // Preserve autopilot_resolved if it exists
      if (historyData.autopilot_resolved !== undefined) {
        dataToSave.autopilot_resolved = historyData.autopilot_resolved;
      }

      // Preserve resolved_at if it exists
      if (historyData.resolved_at) {
        dataToSave.resolved_at = historyData.resolved_at;
      }

      // Preserve payment_verification if it exists
      if (historyData.payment_verification) {
        dataToSave.payment_verification = historyData.payment_verification;
      }

      await fetch(`/api/hijacking/history/${caseId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dataToSave)
      });

      console.log('[Hijacking] Pirate counter-offer saved to history:', pirateCounterOffer);
    } catch (error) {
      console.error('[Hijacking] Failed to save pirate counter-offer to history:', error);
    }

    // Count how many user offers have been made (max 2 before auto-accept bug on 3rd)
    const userOfferCount = negotiationHistory.filter(h => h.type === 'user').length;
    console.log('[Hijacking] User has made', userOfferCount, 'offers');

    // Reload the hijacking message to show updated negotiation history
    // displaySystemMessage already renders everything correctly, no need for showCounterOfferUI
    if (currentPrivateChat &amp;&amp; currentPrivateChat.body === 'vessel_got_hijacked') {
      await displaySystemMessage(currentPrivateChat);
    }

    // Show notification about pirate response
    showSideNotification(` Pirates counter-offered: $${pirateCounterOffer.toLocaleString()}`, 'warning', 6000);

    // Scroll to see the new offer
    const feed = document.getElementById('messengerFeed');
    if (feed) {
      setTimeout(() => {
        feed.scrollTop = feed.scrollHeight;
      }, 100);
    }

  } catch (error) {
    console.error('[Hijacking] Error:', error);
    showSideNotification(`Error: ${error.message}`, 'error');
  }
};

/**
 * Stop hijacking case polling.
 */
function stopHijackingPolling() {
  if (hijackingPollingInterval) {
    console.log('[Hijacking] Stopping polling');
    clearInterval(hijackingPollingInterval);
    hijackingPollingInterval = null;
  }
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation Version: 0.0.7 - ShippingManager CoPilot
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
