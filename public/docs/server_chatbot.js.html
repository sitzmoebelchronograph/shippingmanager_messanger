<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>server/chatbot.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Dark theme matching app style - carefully scoped to not break layout */
        html, body {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
            overflow-x: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Custom scrollbar styling for all browsers */
        * {
            scrollbar-width: thin !important;
            scrollbar-color: #404040 #1a1a1a !important;
        }

        /* Webkit browsers (Chrome, Safari, Edge) */
        *::-webkit-scrollbar {
            width: 6px !important;
            height: 6px !important;
        }

        *::-webkit-scrollbar-track {
            background: #1a1a1a !important;
        }

        *::-webkit-scrollbar-thumb {
            background-color: #404040 !important;
            border-radius: 3px !important;
        }

        *::-webkit-scrollbar-thumb:hover {
            background-color: #505050 !important;
        }

        /* Navigation sidebar - remove padding and white borders */
        nav {
            background-color: #242424 !important;
            border-right: 1px solid #404040 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow-x: hidden !important;
        }
        nav h2, nav h3 {
            color: #e0e0e0 !important;
            border-bottom: 1px solid #404040 !important;
            padding: 10px 15px !important;
            margin: 0 !important;
            background-color: #242424 !important;
            font-size: 14px !important;
            font-weight: 600 !important;
        }
        nav h3 {
            font-size: 13px !important;
        }
        nav ul {
            padding: 0 !important;
            margin: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li {
            list-style: none !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li a {
            color: #c9d1d9 !important;
            display: block !important;
            padding: 8px 15px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            background-color: #242424 !important;
            margin: 0 !important;
            border: none !important;
            font-size: 14px !important;
        }
        nav ul li a:hover {
            color: #60a5fa !important;
            background-color: rgba(96, 165, 250, 0.1) !important;
        }
        /* Module links (direct children of nav > ul > li) */
        nav > ul > li > a {
            color: #60a5fa !important;
            font-weight: 600 !important;
            padding: 10px 15px !important;
            font-size: 14px !important;
            border-left: 3px solid #60a5fa !important;
            padding-left: 12px !important;
        }
        nav > ul > li > a:hover {
            background-color: rgba(96, 165, 250, 0.15) !important;
        }
        /* Sub-items (methods/functions) indented */
        nav ul.methods {
            padding-left: 15px !important;
        }
        nav ul.methods li a {
            color: #9ca3af !important;
            font-size: 13px !important;
            padding: 6px 15px !important;
            font-weight: 400 !important;
        }
        nav ul.methods li a:hover {
            color: #c9d1d9 !important;
        }
        nav > h2:first-child {
            font-size: 16px !important;
            font-weight: 700 !important;
            padding: 12px 15px !important;
        }

        /* Main content area - dark background */
        #main {
            background-color: #1a1a1a !important;
            padding: 20px !important;
        }

        /* Article and sections - ensure dark background */
        article, section, .container-overview, .description {
            background-color: #1a1a1a !important;
        }

        /* Images - style demo images */
        img {
            max-width: 100% !important;
            height: auto !important;
            border: 1px solid #404040 !important;
            border-radius: 8px !important;
            margin: 20px 0 !important;
        }

        /* Links */
        a {
            color: #60a5fa !important;
            text-decoration: none !important;
        }
        a:hover {
            color: #93c5fd !important;
            text-decoration: underline !important;
        }

        /* Headings */
        h1, h2, h3, h4, h5, h6 {
            color: #e0e0e0 !important;
            border-bottom-color: #404040 !important;
            background-color: transparent !important;
        }
        h4.name {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
        }

        /* Code blocks */
        pre {
            background-color: #0d1117 !important;
            border: 1px solid #404040 !important;
        }
        pre code {
            background-color: transparent !important;
        }
        code {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
        }

        /* Tables */
        table {
            border-color: #404040 !important;
            background-color: #1a1a1a !important;
        }
        table thead tr {
            background-color: #242424 !important;
        }
        table tbody tr {
            background-color: #1a1a1a !important;
        }
        table tbody tr:nth-child(even) {
            background-color: #1f1f1f !important;
        }
        table td, table th {
            border-color: #404040 !important;
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }
        .params .name, .props .name {
            color: #10b981 !important;
            font-family: 'Courier New', monospace !important;
        }

        /* Descriptions and details */
        .description, .details, dt, dd, p, ul, ol, dl {
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }

        /* Types */
        .type-signature {
            color: #a78bfa !important;
        }

        /* Source links */
        .details .details-item-container {
            border-left-color: #404040 !important;
        }

        /* Breadcrumbs */
        .page-title {
            color: #e0e0e0 !important;
        }

        /* Search */
        #nav-search {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
            color: #e0e0e0 !important;
        }

        /* Mobile nav trigger */
        .navicon-button {
            background-color: #2a2a2a !important;
        }

        /* Footer */
        footer {
            background-color: #1a1a1a !important;
            color: #9ca3af !important;
            border-top: 1px solid #404040 !important;
            text-align: center !important;
            padding: 20px !important;
        }

        /* Remove horizontal scrollbar and white borders */
        * {
            box-sizing: border-box !important;
        }
    </style>
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">README</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-build-guide.html">Build Guide</a></li><li><a href="tutorial-installation-guide.html">Installation Guide</a></li></ul><h3>Classes</h3><ul><li><a href="module-server_chatbot-ChatBot.html">ChatBot</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot-ChatBot.html#executeCommand">executeCommand</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#findCustomCommand">findCustomCommand</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#generateForecastText">generateForecastText</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#getDefaultChatBotObject">getDefaultChatBotObject</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#handleForecastCommand">handleForecastCommand</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#handleHelpCommand">handleHelpCommand</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#initialize">initialize</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#isCommandAllowedInChannel">isCommandAllowedInChannel</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#isOnCooldown">isOnCooldown</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#mapChatBotObjectToFlatSettings">mapChatBotObjectToFlatSettings</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#mapSettingsToChatBotObject">mapSettingsToChatBotObject</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#processAllianceMessage">processAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#processPrivateMessage">processPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#resolveCommandName">resolveCommandName</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#scheduleDailyForecast">scheduleDailyForecast</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#sendAllianceMessage">sendAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#sendDailyForecast">sendDailyForecast</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#sendErrorMessage">sendErrorMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#sendPrivateMessage">sendPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#sendResponse">sendResponse</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#setupScheduledTasks">setupScheduledTasks</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#updateCooldown">updateCooldown</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#updateSettings">updateSettings</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#validateCommandArguments">validateCommandArguments</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#validateForecastArguments">validateForecastArguments</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-api.html">api</a><ul class='methods'><li data-type='method'><a href="module-api.html#.activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-api.html#.deleteChat">deleteChat</a></li><li data-type='method'><a href="module-api.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-api.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-api.html#.departVessels">departVessels</a></li><li data-type='method'><a href="module-api.html#.doWearMaintenanceBulk">doWearMaintenanceBulk</a></li><li data-type='method'><a href="module-api.html#.fetchAcquirableVessels">fetchAcquirableVessels</a></li><li data-type='method'><a href="module-api.html#.fetchAllianceMembers">fetchAllianceMembers</a></li><li data-type='method'><a href="module-api.html#.fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-api.html#.fetchBunkerPrices">fetchBunkerPrices</a></li><li data-type='method'><a href="module-api.html#.fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-api.html#.fetchChat">fetchChat</a></li><li data-type='method'><a href="module-api.html#.fetchContacts">fetchContacts</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerChats">fetchMessengerChats</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerMessages">fetchMessengerMessages</a></li><li data-type='method'><a href="module-api.html#.fetchUserCompany">fetchUserCompany</a></li><li data-type='method'><a href="module-api.html#.fetchUserSettings">fetchUserSettings</a></li><li data-type='method'><a href="module-api.html#.fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-api.html#.getCompanyNameCached">getCompanyNameCached</a></li><li data-type='method'><a href="module-api.html#.getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-api.html#.markChatAsRead">markChatAsRead</a></li><li data-type='method'><a href="module-api.html#.purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-api.html#.purchaseFuel">purchaseFuel</a></li><li data-type='method'><a href="module-api.html#.purchaseVessel">purchaseVessel</a></li><li data-type='method'><a href="module-api.html#.searchUsers">searchUsers</a></li><li data-type='method'><a href="module-api.html#.sendChatMessage">sendChatMessage</a></li><li data-type='method'><a href="module-api.html#.sendPrivateMessage">sendPrivateMessage</a></li></ul></li><li><a href="module-app.html">app</a></li><li><a href="module-automation.html">automation</a><ul class='methods'><li data-type='method'><a href="module-automation.html#.initAutomation">initAutomation</a></li><li data-type='method'><a href="module-automation.html#.runAutomationChecks">runAutomationChecks</a></li><li data-type='method'><a href="module-automation.html#.triggerAutoRebuyChecks">triggerAutoRebuyChecks</a></li><li data-type='method'><a href="module-automation.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-automation.html#~checkAutoCampaignRenewal">checkAutoCampaignRenewal</a></li><li data-type='method'><a href="module-automation.html#~checkAutoDepartAll">checkAutoDepartAll</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyCO2">checkAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyFuel">checkAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~getTotalCapacity">getTotalCapacity</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyCO2">performAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyFuel">performAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~sendAutoPilotFeedback">sendAutoPilotFeedback</a></li><li data-type='method'><a href="module-automation.html#~showCenterAlert">showCenterAlert</a></li><li data-type='method'><a href="module-automation.html#~updateAutoDepartLabel">updateAutoDepartLabel</a></li></ul></li><li><a href="module-bunker-management.html">bunker-management</a><ul class='methods'><li data-type='method'><a href="module-bunker-management.html#.buyMaxCO2">buyMaxCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.buyMaxFuel">buyMaxFuel</a></li><li data-type='method'><a href="module-bunker-management.html#.getCurrentBunkerState">getCurrentBunkerState</a></li><li data-type='method'><a href="module-bunker-management.html#.setCapacityFromBunkerUpdate">setCapacityFromBunkerUpdate</a></li><li data-type='method'><a href="module-bunker-management.html#.updateBunkerStatus">updateBunkerStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCampaignsStatus">updateCampaignsStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCO2">updateCurrentCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCash">updateCurrentCash</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentFuel">updateCurrentFuel</a></li><li data-type='method'><a href="module-bunker-management.html#~retryFetchPrices">retryFetchPrices</a></li></ul></li><li><a href="module-chat.html">chat</a><ul class='methods'><li data-type='method'><a href="module-chat.html#.displayMessages">displayMessages</a></li><li data-type='method'><a href="module-chat.html#.handleMessageInput">handleMessageInput</a></li><li data-type='method'><a href="module-chat.html#.initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-chat.html#.loadAllianceMembers">loadAllianceMembers</a></li><li data-type='method'><a href="module-chat.html#.loadMessages">loadMessages</a></li><li data-type='method'><a href="module-chat.html#.parseMessageWithMentions">parseMessageWithMentions</a></li><li data-type='method'><a href="module-chat.html#.sendMessage">sendMessage</a></li><li data-type='method'><a href="module-chat.html#.setChatScrollListener">setChatScrollListener</a></li><li data-type='method'><a href="module-chat.html#~attemptReconnect">attemptReconnect</a></li><li data-type='method'><a href="module-chat.html#~displaySuggestions">displaySuggestions</a></li><li data-type='method'><a href="module-chat.html#~formatLocalTime">formatLocalTime</a></li><li data-type='method'><a href="module-chat.html#~handleAnchorUpdate">handleAnchorUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleAutoCoopComplete">handleAutoCoopComplete</a></li><li data-type='method'><a href="module-chat.html#~handleAutoCoopNoTargets">handleAutoCoopNoTargets</a></li><li data-type='method'><a href="module-chat.html#~handleAutopilotDepartStart">handleAutopilotDepartStart</a></li><li data-type='method'><a href="module-chat.html#~handleBackendAutoRepairComplete">handleBackendAutoRepairComplete</a></li><li data-type='method'><a href="module-chat.html#~handleBunkerUpdate">handleBunkerUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleCO2Purchased">handleCO2Purchased</a></li><li data-type='method'><a href="module-chat.html#~handleCampaignStatusUpdate">handleCampaignStatusUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleCampaignsRenewed">handleCampaignsRenewed</a></li><li data-type='method'><a href="module-chat.html#~handleCoopUpdate">handleCoopUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleFuelPurchased">handleFuelPurchased</a></li><li data-type='method'><a href="module-chat.html#~handleGenericNotification">handleGenericNotification</a></li><li data-type='method'><a href="module-chat.html#~handleHeaderDataUpdate">handleHeaderDataUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleHijackingUpdate">handleHijackingUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleMentionAutocomplete">handleMentionAutocomplete</a></li><li data-type='method'><a href="module-chat.html#~handleMessengerUpdate">handleMessengerUpdate</a></li><li data-type='method'><a href="module-chat.html#~handlePriceAlert">handlePriceAlert</a></li><li data-type='method'><a href="module-chat.html#~handlePriceUpdate">handlePriceUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleRepairCountUpdate">handleRepairCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleUnreadMessagesUpdate">handleUnreadMessagesUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleUserActionNotification">handleUserActionNotification</a></li><li data-type='method'><a href="module-chat.html#~handleVesselCountUpdate">handleVesselCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDepartComplete">handleVesselsDepartComplete</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDeparted">handleVesselsDeparted</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsFailed">handleVesselsFailed</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsRepaired">handleVesselsRepaired</a></li><li data-type='method'><a href="module-chat.html#~hideMemberSuggestions">hideMemberSuggestions</a></li><li data-type='method'><a href="module-chat.html#~insertMention">insertMention</a></li><li data-type='method'><a href="module-chat.html#~registerUsernameClickEvents">registerUsernameClickEvents</a></li></ul></li><li><a href="module-coop.html">coop</a><ul class='methods'><li data-type='method'><a href="module-coop.html#.closeCoopOverlay">closeCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.fetchCoopData">fetchCoopData</a></li><li data-type='method'><a href="module-coop.html#.sendCoopMax">sendCoopMax</a></li><li data-type='method'><a href="module-coop.html#.showCoopOverlay">showCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.updateCoopBadge">updateCoopBadge</a></li><li data-type='method'><a href="module-coop.html#~renderMemberCard">renderMemberCard</a></li></ul></li><li><a href="module-desktop-notification-templates.html">desktop-notification-templates</a><ul class='methods'><li data-type='method'><a href="module-desktop-notification-templates.html#.createDesktopNotification">createDesktopNotification</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.getDefaultEmoji">getDefaultEmoji</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.getNotificationTypes">getNotificationTypes</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.isValidNotificationType">isValidNotificationType</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyAlert">notifyAlert</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyError">notifyError</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifySuccess">notifySuccess</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyWarning">notifyWarning</a></li></ul></li><li><a href="module-event-info.html">event-info</a><ul class='methods'><li data-type='method'><a href="module-event-info.html#.initEventInfo">initEventInfo</a></li><li data-type='method'><a href="module-event-info.html#.openEventModal">openEventModal</a></li><li data-type='method'><a href="module-event-info.html#.updateEventData">updateEventData</a></li><li data-type='method'><a href="module-event-info.html#~startEventTimer">startEventTimer</a></li></ul></li><li><a href="module-forecast-calendar.html">forecast-calendar</a><ul class='methods'><li data-type='method'><a href="module-forecast-calendar.html#.initForecastCalendar">initForecastCalendar</a></li><li data-type='method'><a href="module-forecast-calendar.html#.updateEventDiscount">updateEventDiscount</a></li><li data-type='method'><a href="module-forecast-calendar.html#~createTableHTML">createTableHTML</a></li><li data-type='method'><a href="module-forecast-calendar.html#~formatDate">formatDate</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getBrowserTimezone">getBrowserTimezone</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getCo2Class">getCo2Class</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getCurrentVisibleDay">getCurrentVisibleDay</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getFuelClass">getFuelClass</a></li><li data-type='method'><a href="module-forecast-calendar.html#~isEventActiveAtTime">isEventActiveAtTime</a></li><li data-type='method'><a href="module-forecast-calendar.html#~isEventActiveOnDay">isEventActiveOnDay</a></li><li data-type='method'><a href="module-forecast-calendar.html#~loadForecastData">loadForecastData</a></li><li data-type='method'><a href="module-forecast-calendar.html#~preloadMonth">preloadMonth</a></li><li data-type='method'><a href="module-forecast-calendar.html#~renderBook">renderBook</a></li><li data-type='method'><a href="module-forecast-calendar.html#~updateEventBadge">updateEventBadge</a></li></ul></li><li><a href="module-messenger.html">messenger</a><ul class='methods'><li data-type='method'><a href="module-messenger.html#.closeAllChats">closeAllChats</a></li><li data-type='method'><a href="module-messenger.html#.closeChatSelection">closeChatSelection</a></li><li data-type='method'><a href="module-messenger.html#.openMessenger">openMessenger</a></li><li data-type='method'><a href="module-messenger.html#.openNewChat">openNewChat</a></li><li data-type='method'><a href="module-messenger.html#.showAllChats">showAllChats</a></li><li data-type='method'><a href="module-messenger.html#.updateUnreadBadge">updateUnreadBadge</a></li><li data-type='method'><a href="module-messenger.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-messenger.html#~loadPrivateMessages">loadPrivateMessages</a></li><li data-type='method'><a href="module-messenger.html#~startHijackingPolling">startHijackingPolling</a></li><li data-type='method'><a href="module-messenger.html#~stopHijackingPolling">stopHijackingPolling</a></li></ul></li><li><a href="module-public_js_modules_hijacking.html">public/js/modules/hijacking</a><ul class='methods'><li data-type='method'><a href="module-public_js_modules_hijacking.html#.closeHijackingInbox">closeHijackingInbox</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.openHijackingInbox">openHijackingInbox</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.updateHijackedVesselsDisplay">updateHijackedVesselsDisplay</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.updateHijackingBadge">updateHijackingBadge</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~deleteCase">deleteCase</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~openCaseDetails">openCaseDetails</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~refreshHijackingBadge">refreshHijackingBadge</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~renderCaseList">renderCaseList</a></li></ul></li><li><a href="module-server_automation.html">server/automation</a><ul class='methods'><li data-type='method'><a href="module-server_automation.html#~getRandomInterval">getRandomInterval</a></li><li data-type='method'><a href="module-server_automation.html#~initialize">initialize</a></li><li data-type='method'><a href="module-server_automation.html#~loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_automation.html#~parseInterval">parseInterval</a></li><li data-type='method'><a href="module-server_automation.html#~restartAutoRepair">restartAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~runAutoRepair">runAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~scheduleAutoRepair">scheduleAutoRepair</a></li></ul></li><li><a href="module-server_autopilot.html">server/autopilot</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot.html#~acceptRansomWithRetry">acceptRansomWithRetry</a></li><li data-type='method'><a href="module-server_autopilot.html#~analyzeVesselDepartures">analyzeVesselDepartures</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoAnchorPointPurchase">autoAnchorPointPurchase</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoCampaignRenewal">autoCampaignRenewal</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoCoop">autoCoop</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoDepartVessels">autoDepartVessels</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoNegotiateHijacking">autoNegotiateHijacking</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoRebuyAll">autoRebuyAll</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoRebuyCO2">autoRebuyCO2</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoRebuyFuel">autoRebuyFuel</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoRepairVessels">autoRepairVessels</a></li><li data-type='method'><a href="module-server_autopilot.html#~calculatePendingAnchorPoints">calculatePendingAnchorPoints</a></li><li data-type='method'><a href="module-server_autopilot.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-server_autopilot.html#~checkPriceAlerts">checkPriceAlerts</a></li><li data-type='method'><a href="module-server_autopilot.html#~countActiveCampaignTypes">countActiveCampaignTypes</a></li><li data-type='method'><a href="module-server_autopilot.html#~departVessels">departVessels</a></li><li data-type='method'><a href="module-server_autopilot.html#~fetchAllianceDataCached">fetchAllianceDataCached</a></li><li data-type='method'><a href="module-server_autopilot.html#~fetchCoopDataCached">fetchCoopDataCached</a></li><li data-type='method'><a href="module-server_autopilot.html#~getCachedCapacity">getCachedCapacity</a></li><li data-type='method'><a href="module-server_autopilot.html#~getCaseWithRetry">getCaseWithRetry</a></li><li data-type='method'><a href="module-server_autopilot.html#~getTotalCapacity">getTotalCapacity</a></li><li data-type='method'><a href="module-server_autopilot.html#~initializeAutopilotState">initializeAutopilotState</a></li><li data-type='method'><a href="module-server_autopilot.html#~isAutopilotPaused">isAutopilotPaused</a></li><li data-type='method'><a href="module-server_autopilot.html#~mainEventLoop">mainEventLoop</a></li><li data-type='method'><a href="module-server_autopilot.html#~pauseAutopilot">pauseAutopilot</a></li><li data-type='method'><a href="module-server_autopilot.html#~processHijackingCase">processHijackingCase</a></li><li data-type='method'><a href="module-server_autopilot.html#~refreshHijackingBadge">refreshHijackingBadge</a></li><li data-type='method'><a href="module-server_autopilot.html#~resumeAutopilot">resumeAutopilot</a></li><li data-type='method'><a href="module-server_autopilot.html#~setBroadcastFunction">setBroadcastFunction</a></li><li data-type='method'><a href="module-server_autopilot.html#~startMainEventLoop">startMainEventLoop</a></li><li data-type='method'><a href="module-server_autopilot.html#~submitOfferWithRetry">submitOfferWithRetry</a></li><li data-type='method'><a href="module-server_autopilot.html#~tryUpdateAllData">tryUpdateAllData</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateAllData">updateAllData</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateCampaigns">updateCampaigns</a></li><li data-type='method'><a href="module-server_autopilot.html#~updatePrices">updatePrices</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateRepairCount">updateRepairCount</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateUnreadMessages">updateUnreadMessages</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateVesselCount">updateVesselCount</a></li></ul></li><li><a href="module-server_cache.html">server/cache</a><ul class='methods'><li data-type='method'><a href="module-server_cache.html#~clearAllCaches">clearAllCaches</a></li><li data-type='method'><a href="module-server_cache.html#~getAllianceCache">getAllianceCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCampaignCache">getCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCompanyCache">getCompanyCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCoopCache">getCoopCache</a></li><li data-type='method'><a href="module-server_cache.html#~invalidateCampaignCache">invalidateCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~invalidateCoopCache">invalidateCoopCache</a></li><li data-type='method'><a href="module-server_cache.html#~isCacheValid">isCacheValid</a></li><li data-type='method'><a href="module-server_cache.html#~setAllianceCache">setAllianceCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCampaignCache">setCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCompanyCache">setCompanyCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCoopCache">setCoopCache</a></li></ul></li><li><a href="module-server_certificate.html">server/certificate</a><ul class='methods'><li data-type='method'><a href="module-server_certificate.html#~createHttpsServer">createHttpsServer</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCA">generateCA</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCertificate">generateCertificate</a></li><li data-type='method'><a href="module-server_certificate.html#~getNetworkIPs">getNetworkIPs</a></li><li data-type='method'><a href="module-server_certificate.html#~isCertificateInstalled">isCertificateInstalled</a></li><li data-type='method'><a href="module-server_certificate.html#~loadCertificate">loadCertificate</a></li></ul></li><li><a href="module-server_chatbot.html">server/chatbot</a></li><li><a href="module-server_config.html">server/config</a><ul class='methods'><li data-type='method'><a href="module-server_config.html#~getAppDataDir">getAppDataDir</a></li><li data-type='method'><a href="module-server_config.html#~getLocalAppDataDir">getLocalAppDataDir</a></li><li data-type='method'><a href="module-server_config.html#~getLogDir">getLogDir</a></li><li data-type='method'><a href="module-server_config.html#~getSessionCookie">getSessionCookie</a></li><li data-type='method'><a href="module-server_config.html#~getSettingsDir">getSettingsDir</a></li><li data-type='method'><a href="module-server_config.html#~loadStartupSettings">loadStartupSettings</a></li><li data-type='method'><a href="module-server_config.html#~setSessionCookie">setSessionCookie</a></li></ul></li><li><a href="module-server_gameapi.html">server/gameapi</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi.html#~activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-server_gameapi.html#~bulkRepairVessels">bulkRepairVessels</a></li><li data-type='method'><a href="module-server_gameapi.html#~departVessel">departVessel</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchAutoPrice">fetchAutoPrice</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchBunkerState">fetchBunkerState</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchEventData">fetchEventData</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchPrices">fetchPrices</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchRepairCount">fetchRepairCount</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchUnreadMessages">fetchUnreadMessages</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-server_gameapi.html#~getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-server_gameapi.html#~purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-server_gameapi.html#~purchaseFuel">purchaseFuel</a></li></ul></li><li><a href="module-server_middleware_index.html">server/middleware/index</a><ul class='methods'><li data-type='method'><a href="module-server_middleware_index.html#~setupMiddleware">setupMiddleware</a></li></ul></li><li><a href="module-server_routes_alliance.html">server/routes/alliance</a><ul class='methods'><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-members">GET /api/alliance-members</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/chat">GET /api/chat</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/company-name">POST /api/company-name</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/send-message">POST /api/send-message</a></li></ul></li><li><a href="module-server_routes_anchor.html">server/routes/anchor</a></li><li><a href="module-server_routes_coop.html">server/routes/coop</a><ul class='methods'><li data-type='method'><a href="module-server_routes_coop.html#.GET/api/coop/data">GET /api/coop/data</a></li><li data-type='method'><a href="module-server_routes_coop.html#.POST/api/coop/send-max">POST /api/coop/send-max</a></li></ul></li><li><a href="module-server_routes_forecast.html">server/routes/forecast</a><ul class='methods'><li data-type='method'><a href="module-server_routes_forecast.html#~convertCESTToTimezone">convertCESTToTimezone</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~generateChatbotText">generateChatbotText</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~generateMetadata">generateMetadata</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getForecastDataPath">getForecastDataPath</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getNextDayData">getNextDayData</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getPreviousDayData">getPreviousDayData</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getServerLocalTimezone">getServerLocalTimezone</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getTimezoneOffsetHours">getTimezoneOffsetHours</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getValidTimezones">getValidTimezones</a></li></ul></li><li><a href="module-server_routes_game.html">server/routes/game</a></li><li><a href="module-server_routes_health.html">server/routes/health</a></li><li><a href="module-server_routes_messenger.html">server/routes/messenger</a><ul class='methods'><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/contact/get-contacts">GET /api/contact/get-contacts</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/hijacking/get-cases">GET /api/hijacking/get-cases</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/messenger/get-chats">GET /api/messenger/get-chats</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/delete-chat">POST /api/messenger/delete-chat</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/get-messages">POST /api/messenger/get-messages</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/send-private">POST /api/messenger/send-private</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/user/search">POST /api/user/search</a></li><li data-type='method'><a href="module-server_routes_messenger.html#~migrateHijackHistory">migrateHijackHistory</a></li></ul></li><li><a href="module-server_routes_settings.html">server/routes/settings</a><ul class='methods'><li data-type='method'><a href="module-server_routes_settings.html#.GET/api/settings">GET /api/settings</a></li><li data-type='method'><a href="module-server_routes_settings.html#.POST/api/settings">POST /api/settings</a></li></ul></li><li><a href="module-server_scheduler.html">server/scheduler</a><ul class='methods'><li data-type='method'><a href="module-server_scheduler.html#~initScheduler">initScheduler</a></li><li data-type='method'><a href="module-server_scheduler.html#~isServerReady">isServerReady</a></li></ul></li><li><a href="module-server_settings-schema.html">server/settings-schema</a><ul class='methods'><li data-type='method'><a href="module-server_settings-schema.html#~getDefault">getDefault</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getDefaults">getDefaults</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getRequiredKeys">getRequiredKeys</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getSettingsFilePath">getSettingsFilePath</a></li><li data-type='method'><a href="module-server_settings-schema.html#~initializeSettings">initializeSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~saveSettings">saveSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~validateSettings">validateSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~validateValue">validateValue</a></li></ul></li><li><a href="module-server_state.html">server/state</a><ul class='methods'><li data-type='method'><a href="module-server_state.html#~getAutopilotState">getAutopilotState</a></li><li data-type='method'><a href="module-server_state.html#~getBunkerState">getBunkerState</a></li><li data-type='method'><a href="module-server_state.html#~getCampaignStatus">getCampaignStatus</a></li><li data-type='method'><a href="module-server_state.html#~getCoopData">getCoopData</a></li><li data-type='method'><a href="module-server_state.html#~getEventData">getEventData</a></li><li data-type='method'><a href="module-server_state.html#~getHeaderData">getHeaderData</a></li><li data-type='method'><a href="module-server_state.html#~getLastCO2Alert">getLastCO2Alert</a></li><li data-type='method'><a href="module-server_state.html#~getLastFuelAlert">getLastFuelAlert</a></li><li data-type='method'><a href="module-server_state.html#~getPrices">getPrices</a></li><li data-type='method'><a href="module-server_state.html#~getRepairCount">getRepairCount</a></li><li data-type='method'><a href="module-server_state.html#~getSettings">getSettings</a></li><li data-type='method'><a href="module-server_state.html#~getUserState">getUserState</a></li><li data-type='method'><a href="module-server_state.html#~getVesselCounts">getVesselCounts</a></li><li data-type='method'><a href="module-server_state.html#~isAutopilotPaused">isAutopilotPaused</a></li><li data-type='method'><a href="module-server_state.html#~setAutopilotPaused">setAutopilotPaused</a></li><li data-type='method'><a href="module-server_state.html#~setAutopilotState">setAutopilotState</a></li><li data-type='method'><a href="module-server_state.html#~setLastCO2Alert">setLastCO2Alert</a></li><li data-type='method'><a href="module-server_state.html#~setLastFuelAlert">setLastFuelAlert</a></li><li data-type='method'><a href="module-server_state.html#~updateBunkerState">updateBunkerState</a></li><li data-type='method'><a href="module-server_state.html#~updateCampaignStatus">updateCampaignStatus</a></li><li data-type='method'><a href="module-server_state.html#~updateCoopData">updateCoopData</a></li><li data-type='method'><a href="module-server_state.html#~updateEventData">updateEventData</a></li><li data-type='method'><a href="module-server_state.html#~updateHeaderData">updateHeaderData</a></li><li data-type='method'><a href="module-server_state.html#~updatePrices">updatePrices</a></li><li data-type='method'><a href="module-server_state.html#~updateRepairCount">updateRepairCount</a></li><li data-type='method'><a href="module-server_state.html#~updateSettings">updateSettings</a></li><li data-type='method'><a href="module-server_state.html#~updateVesselCounts">updateVesselCounts</a></li></ul></li><li><a href="module-server_utils_api.html">server/utils/api</a><ul class='methods'><li data-type='method'><a href="module-server_utils_api.html#~apiCall">apiCall</a></li><li data-type='method'><a href="module-server_utils_api.html#~apiCallWithRetry">apiCallWithRetry</a></li><li data-type='method'><a href="module-server_utils_api.html#~getAllianceId">getAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~getChatFeed">getChatFeed</a></li><li data-type='method'><a href="module-server_utils_api.html#~getCompanyName">getCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserCompanyName">getUserCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserId">getUserId</a></li><li data-type='method'><a href="module-server_utils_api.html#~initializeAlliance">initializeAlliance</a></li><li data-type='method'><a href="module-server_utils_api.html#~sleep">sleep</a></li></ul></li><li><a href="module-server_utils_encryption.html">server/utils/encryption</a><ul class='methods'><li data-type='method'><a href="module-server_utils_encryption.html#~decryptData">decryptData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~deleteEncryptedData">deleteEncryptedData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~encryptData">encryptData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~getEncryptionInfo">getEncryptionInfo</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~getMachineKey">getMachineKey</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~isEncrypted">isEncrypted</a></li></ul></li><li><a href="module-server_utils_logger.html">server/utils/logger</a><ul class='methods'><li data-type='method'><a href="module-server_utils_logger.html#~debug">debug</a></li><li data-type='method'><a href="module-server_utils_logger.html#~error">error</a></li><li data-type='method'><a href="module-server_utils_logger.html#~isDebugMode">isDebugMode</a></li><li data-type='method'><a href="module-server_utils_logger.html#~loadLogLevel">loadLogLevel</a></li><li data-type='method'><a href="module-server_utils_logger.html#~log">log</a></li><li data-type='method'><a href="module-server_utils_logger.html#~warn">warn</a></li></ul></li><li><a href="module-server_utils_session-manager.html">server/utils/session-manager</a><ul class='methods'><li data-type='method'><a href="module-server_utils_session-manager.html#~deleteSession">deleteSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getAllUserIds">getAllUserIds</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getAvailableSessions">getAvailableSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getSession">getSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getSessionsPath">getSessionsPath</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~hasSession">hasSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~loadAllSessions">loadAllSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~loadSessions">loadSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~migrateToEncrypted">migrateToEncrypted</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~saveSession">saveSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~saveSessions">saveSessions</a></li></ul></li><li><a href="module-server_websocket.html">server/websocket</a><ul class='methods'><li data-type='method'><a href="module-server_websocket.html#~broadcast">broadcast</a></li><li data-type='method'><a href="module-server_websocket.html#~broadcastBunkerUpdate">broadcastBunkerUpdate</a></li><li data-type='method'><a href="module-server_websocket.html#~broadcastToUser">broadcastToUser</a></li><li data-type='method'><a href="module-server_websocket.html#~getCachedHijackingCase">getCachedHijackingCase</a></li><li data-type='method'><a href="module-server_websocket.html#~getCachedMessengerChats">getCachedMessengerChats</a></li><li data-type='method'><a href="module-server_websocket.html#~getProcessedMessageIds">getProcessedMessageIds</a></li><li data-type='method'><a href="module-server_websocket.html#~getProcessedMessagesCachePath">getProcessedMessagesCachePath</a></li><li data-type='method'><a href="module-server_websocket.html#~initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-server_websocket.html#~loadProcessedMessageCache">loadProcessedMessageCache</a></li><li data-type='method'><a href="module-server_websocket.html#~performChatRefresh">performChatRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~performHijackingRefresh">performHijackingRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~performMessengerRefresh">performMessengerRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~saveProcessedMessageCache">saveProcessedMessageCache</a></li><li data-type='method'><a href="module-server_websocket.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~startHijackingAutoRefresh">startHijackingAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~startMessengerAutoRefresh">startMessengerAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopChatAutoRefresh">stopChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopHijackingAutoRefresh">stopHijackingAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopMessengerAutoRefresh">stopMessengerAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~triggerImmediateChatRefresh">triggerImmediateChatRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~triggerImmediateHijackingRefresh">triggerImmediateHijackingRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~triggerImmediateMessengerRefresh">triggerImmediateMessengerRefresh</a></li></ul></li><li><a href="module-ui-dialogs.html">ui-dialogs</a><ul class='methods'><li data-type='method'><a href="module-ui-dialogs.html#.buyCampaign">buyCampaign</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeCampaignsOverlay">closeCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeSettings">closeSettings</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showCampaignsOverlay">showCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showConfirmDialog">showConfirmDialog</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showContactList">showContactList</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showSettings">showSettings</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#.escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-utils.html#.formatNumber">formatNumber</a></li><li data-type='method'><a href="module-utils.html#.registerServiceWorker">registerServiceWorker</a></li><li data-type='method'><a href="module-utils.html#.renderStars">renderStars</a></li><li data-type='method'><a href="module-utils.html#.requestNotificationPermission">requestNotificationPermission</a></li><li data-type='method'><a href="module-utils.html#.showNotification">showNotification</a></li><li data-type='method'><a href="module-utils.html#.showSideNotification">showSideNotification</a></li></ul></li><li><a href="module-vessel-management.html">vessel-management</a><ul class='methods'><li data-type='method'><a href="module-vessel-management.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.purchaseSingleVessel">purchaseSingleVessel</a></li><li data-type='method'><a href="module-vessel-management.html#.updateVesselCount">updateVesselCount</a></li><li data-type='method'><a href="module-vessel-management.html#~createVesselCard">createVesselCard</a></li><li data-type='method'><a href="module-vessel-management.html#~displayFilteredVessels">displayFilteredVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~getAvailableAnchorSlots">getAvailableAnchorSlots</a></li><li data-type='method'><a href="module-vessel-management.html#~getCO2EfficiencyClass">getCO2EfficiencyClass</a></li><li data-type='method'><a href="module-vessel-management.html#~getCapacityDisplay">getCapacityDisplay</a></li><li data-type='method'><a href="module-vessel-management.html#~getFuelEfficiencyClass">getFuelEfficiencyClass</a></li><li data-type='method'><a href="module-vessel-management.html#~loadMorePendingVessels">loadMorePendingVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~loadMoreVessels">loadMoreVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~populateDynamicFilters">populateDynamicFilters</a></li><li data-type='method'><a href="module-vessel-management.html#~preloadCommonVesselImages">preloadCommonVesselImages</a></li><li data-type='method'><a href="module-vessel-management.html#~preloadVesselImage">preloadVesselImage</a></li><li data-type='method'><a href="module-vessel-management.html#~refreshVesselCardsIfVisible">refreshVesselCardsIfVisible</a></li><li data-type='method'><a href="module-vessel-management.html#~showBulkRepairDialog">showBulkRepairDialog</a></li><li data-type='method'><a href="module-vessel-management.html#~updateCapacityDropdowns">updateCapacityDropdowns</a></li><li data-type='method'><a href="module-vessel-management.html#~vesselPassesFilters">vesselPassesFilters</a></li></ul></li><li><a href="module-vessel-selling.html">vessel-selling</a><ul class='methods'><li data-type='method'><a href="module-vessel-selling.html#.bulkSellVessels">bulkSellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#.closeSellVesselsOverlay">closeSellVesselsOverlay</a></li><li data-type='method'><a href="module-vessel-selling.html#.openSellVesselsOverlay">openSellVesselsOverlay</a></li><li data-type='method'><a href="module-vessel-selling.html#.setSellFilter">setSellFilter</a></li><li data-type='method'><a href="module-vessel-selling.html#.showSellCart">showSellCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~addVesselsToCart">addVesselsToCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~displaySellVessels">displaySellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#~getCO2EfficiencyClass">getCO2EfficiencyClass</a></li><li data-type='method'><a href="module-vessel-selling.html#~getCapacityDisplay">getCapacityDisplay</a></li><li data-type='method'><a href="module-vessel-selling.html#~getFuelEfficiencyClass">getFuelEfficiencyClass</a></li><li data-type='method'><a href="module-vessel-selling.html#~groupVesselsByModel">groupVesselsByModel</a></li><li data-type='method'><a href="module-vessel-selling.html#~loadUserVesselsForSale">loadUserVesselsForSale</a></li><li data-type='method'><a href="module-vessel-selling.html#~removeVesselSelectionFromCart">removeVesselSelectionFromCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~sellVessels">sellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#~toggleVesselSelection">toggleVesselSelection</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateBulkSellButton">updateBulkSellButton</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateSelectButtonState">updateSelectButtonState</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateVesselSelectionInCart">updateVesselSelectionInCart</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#buildNav">buildNav</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#lockBulkBuyButton">lockBulkBuyButton</a></li><li><a href="global.html#lockCo2Button">lockCo2Button</a></li><li><a href="global.html#lockCoopButtons">lockCoopButtons</a></li><li><a href="global.html#lockDepartButton">lockDepartButton</a></li><li><a href="global.html#lockFuelButton">lockFuelButton</a></li><li><a href="global.html#lockRepairButton">lockRepairButton</a></li><li><a href="global.html#publish">publish</a></li><li><a href="global.html#showAnchorTimer">showAnchorTimer</a></li><li><a href="global.html#unlockBulkBuyButton">unlockBulkBuyButton</a></li><li><a href="global.html#unlockCo2Button">unlockCo2Button</a></li><li><a href="global.html#unlockCoopButtons">unlockCoopButtons</a></li><li><a href="global.html#unlockDepartButton">unlockDepartButton</a></li><li><a href="global.html#unlockFuelButton">unlockFuelButton</a></li><li><a href="global.html#unlockRepairButton">unlockRepairButton</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">server/chatbot.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Chat Bot System
 *
 * Handles automated responses to alliance chat commands and private messages.
 * Features:
 * - Command parsing and execution
 * - Private message auto-reply
 * - Scheduled message sending
 * - Custom command management
 * - Rate limiting and cooldowns
 *
 * @module server/chatbot
 */

const fs = require('fs').promises;
const path = require('path');
const { apiCall, getAllianceId, getUserId } = require('./utils/api');
const { triggerImmediateChatRefresh, triggerImmediateMessengerRefresh } = require('./websocket');
const { getSettingsFilePath } = require('./settings-schema');
const { getAppDataDir } = require('./config');
const logger = require('./utils/logger');

/**
 * ChatBot class handles all bot functionality
 */
class ChatBot {
    constructor() {
        this.settings = null;
        this.lastCommandTime = new Map(); // userId -> { command -> timestamp }
        this.processedMessages = new Set(); // Track processed DMs to avoid duplicates
        this.scheduledTasks = new Map(); // taskId -> timeout
        this.initialized = false;
    }

    /**
     * Initialize the chat bot with settings
     */
    async initialize() {
        try {
            await this.loadSettings();
            this.setupScheduledTasks();
            this.initialized = true;
            logger.log('[ChatBot] Initialized successfully');
        } catch (error) {
            logger.error('[ChatBot] Failed to initialize:', error);
        }
    }

    /**
     * Load settings from per-user settings file (settings-{userId}.json)
     */
    async loadSettings() {
        try {
            const userId = getUserId();
            if (!userId) {
                logger.error('[ChatBot] No user ID available');
                this.settings = this.getDefaultChatBotObject();
                return;
            }

            const settingsPath = getSettingsFilePath(userId);
            const data = await fs.readFile(settingsPath, 'utf8');
            const allSettings = JSON.parse(data);

            // Map per-user settings to chatbot settings object
            this.settings = this.mapSettingsToChatBotObject(allSettings);
            logger.log('[ChatBot] Settings loaded');
        } catch (error) {
            logger.error('[ChatBot] Error loading settings:', error);
            this.settings = this.getDefaultChatBotObject();
        }
    }

    /**
     * Map per-user settings to chatbot settings object
     */
    mapSettingsToChatBotObject(settings) {
        return {
            enabled: settings.chatbotEnabled || false,
            commandPrefix: settings.chatbotPrefix || '!',
            allianceCommands: {
                enabled: settings.chatbotAllianceCommandsEnabled || false,
                cooldownSeconds: settings.chatbotCooldownSeconds || 30
            },
            commands: {
                forecast: {
                    enabled: settings.chatbotForecastCommandEnabled || false,
                    responseType: 'dm',
                    adminOnly: false,
                    aliases: settings.chatbotForecastAliases || ['prices', 'price']
                },
                help: {
                    enabled: settings.chatbotHelpCommandEnabled || false,
                    responseType: 'dm',
                    adminOnly: false,
                    aliases: settings.chatbotHelpAliases || ['commands', 'help']
                }
            },
            scheduledMessages: {
                dailyForecast: {
                    enabled: settings.chatbotDailyForecastEnabled || false,
                    timeUTC: settings.chatbotDailyForecastTime || '18:00',
                    dayOffset: 1 // 1 = tomorrow
                }
            },
            dmCommands: {
                enabled: settings.chatbotDMCommandsEnabled || false
            },
            customCommands: settings.chatbotCustomCommands || []
        };
    }

    /**
     * Get default chat bot settings object
     */
    getDefaultChatBotObject() {
        return {
            enabled: false,
            commandPrefix: '!',
            allianceCommands: {
                enabled: true,
                cooldownSeconds: 30
            },
            commands: {
                forecast: {
                    enabled: true,
                    responseType: 'dm',
                    adminOnly: false
                },
                help: {
                    enabled: true,
                    responseType: 'dm',
                    adminOnly: false
                }
            },
            scheduledMessages: {
                dailyForecast: {
                    enabled: false,
                    timeUTC: '18:00',
                    dayOffset: 1 // 1 = tomorrow
                }
            },
            dmCommands: {
                enabled: false
            },
            customCommands: []
        };
    }

    /**
     * Map ChatBot object to flat per-user settings keys
     * This is the reverse operation of mapSettingsToChatBotObject()
     * @param {Object} chatbotSettings - Nested ChatBot settings object
     * @returns {Object} Flat settings keys for per-user settings file
     */
    mapChatBotObjectToFlatSettings(chatbotSettings) {
        const flatSettings = {};

        flatSettings.chatbotEnabled = chatbotSettings.enabled || false;
        flatSettings.chatbotPrefix = chatbotSettings.commandPrefix || '!';

        if (chatbotSettings.allianceCommands) {
            flatSettings.chatbotAllianceCommandsEnabled = chatbotSettings.allianceCommands.enabled || false;
            flatSettings.chatbotCooldownSeconds = chatbotSettings.allianceCommands.cooldownSeconds || 30;
        }

        if (chatbotSettings.commands?.forecast) {
            flatSettings.chatbotForecastCommandEnabled = chatbotSettings.commands.forecast.enabled || false;
        }

        if (chatbotSettings.commands?.help) {
            flatSettings.chatbotHelpCommandEnabled = chatbotSettings.commands.help.enabled || false;
        }

        if (chatbotSettings.scheduledMessages?.dailyForecast) {
            flatSettings.chatbotDailyForecastEnabled = chatbotSettings.scheduledMessages.dailyForecast.enabled || false;
            flatSettings.chatbotDailyForecastTime = chatbotSettings.scheduledMessages.dailyForecast.timeUTC || '18:00';
        }

        if (chatbotSettings.dmCommands) {
            flatSettings.chatbotDMCommandsEnabled = chatbotSettings.dmCommands.enabled || false;
        }

        flatSettings.chatbotCustomCommands = chatbotSettings.customCommands || [];

        return flatSettings;
    }

    /**
     * Resolve command name from input (including aliases)
     * @param {string} input - Command input string
     * @returns {string|null} - Resolved command name or null if not found
     */
    resolveCommandName(input) {
        const commandLower = input.toLowerCase();

        // Check exact match first
        if (this.settings.commands[commandLower]) {
            return commandLower;
        }

        // Check aliases
        for (const [cmdName, cmdConfig] of Object.entries(this.settings.commands)) {
            if (cmdConfig.aliases &amp;&amp; cmdConfig.aliases.includes(commandLower)) {
                return cmdName;
            }
        }

        // Check custom commands
        return null;
    }

    /**
     * Process alliance chat message for commands
     */
    async processAllianceMessage(message, userId, userName) {
        if (!this.settings?.enabled) {
            return;
        }

        if (!this.settings?.allianceCommands?.enabled) {
            return;
        }

        // Check if message starts with command prefix
        const prefix = this.settings.commandPrefix || '!';
        if (!message.startsWith(prefix)) {
            // Not a command, ignore silently
            return;
        }

        // Parse command
        const parts = message.slice(prefix.length).trim().split(/\s+/);
        const commandInput = parts[0].toLowerCase();
        const args = parts.slice(1);

        logger.log(`[ChatBot] Command from ${userName}: !${commandInput} ${args.join(' ')}`);

        // Resolve command name (including aliases)
        const command = this.resolveCommandName(commandInput);
        if (!command) {
            // Check custom commands as fallback
            const customCmd = this.findCustomCommand(commandInput);
            if (!customCmd || !customCmd.enabled) {
                return; // Ignore unknown or disabled commands
            }
            // Custom command handling would go here
            return;
        }

        // Get command config
        const cmdConfig = this.settings.commands[command];
        if (!cmdConfig || !cmdConfig.enabled) {
            return; // Ignore disabled commands
        }

        // Check if command is allowed in alliance chat based on settings
        const isAllianceAllowed = this.isCommandAllowedInChannel(command, 'alliance');
        if (!isAllianceAllowed) {
            logger.log(`[ChatBot] Command '${command}' not allowed in alliance chat per settings`);
            return;
        }

        // Validate arguments BEFORE executing command
        if (!this.validateCommandArguments(command, args)) {
            logger.debug(`[ChatBot] Invalid arguments for command '${command}': [${args.join(', ')}]`);
            return;
        }

        // Check admin permission
        const { getUserId } = require('./utils/api');
        const currentUserId = getUserId();
        if (cmdConfig.adminOnly &amp;&amp; userId !== currentUserId) {
            logger.log(`[ChatBot] User ${userId} tried admin command ${command}`);
            return;
        }

        // Check cooldown
        if (this.isOnCooldown(userId, command)) {
            logger.log(`[ChatBot] Command ${command} on cooldown for user ${userId}`);
            return;
        }

        // Execute command
        try {
            await this.executeCommand(command, args, userId, userName, cmdConfig);
            this.updateCooldown(userId, command);
        } catch (error) {
            logger.error(`[ChatBot] Error executing command ${command}:`, error);
            // Errors ONLY go to console - no messages to users!
        }
    }

    /**
     * Process private message for auto-reply
     * Subject is ignored - only message body is parsed for commands
     */
    async processPrivateMessage(messageId, body, senderId, senderName) {
        if (!this.settings?.enabled || !this.settings?.dmCommands?.enabled) {
            logger.debug(`[ChatBot] DM processing disabled - enabled:${this.settings?.enabled} dmCommands:${this.settings?.dmCommands?.enabled}`);
            return false;
        }

        // Check if already processed
        if (this.processedMessages.has(messageId)) {
            return false;
        }

        // IMPORTANT: Parse command from message BODY only (subject is ignored)
        // In DMs, prefix is OPTIONAL (e.g., "forecast 2 GMT" or "!forecast 2 GMT")
        const prefix = this.settings.commandPrefix || '!';
        const bodyTrimmed = body.trim();

        logger.debug(`[ChatBot] Processing DM body: "${bodyTrimmed}"`);

        // Try with prefix first, then without
        let commandText;
        if (bodyTrimmed.startsWith(prefix)) {
            // Has prefix: "!forecast 2 GMT"
            commandText = bodyTrimmed.slice(prefix.length).trim();
        } else {
            // No prefix: "forecast 2 GMT"
            commandText = bodyTrimmed;
        }

        const parts = commandText.split(/\s+/);
        const commandInput = parts[0].toLowerCase();
        const args = parts.slice(1);

        logger.debug(`[ChatBot] Parsed command:"${commandInput}" args:[${args.join(', ')}]`);

        // Resolve command name (including aliases)
        const command = this.resolveCommandName(commandInput);
        if (!command) {
            logger.debug(`[ChatBot] Command not resolved: "${commandInput}"`);
            // Check custom commands as fallback
            const customCmd = this.findCustomCommand(commandInput);
            if (!customCmd || !customCmd.enabled) {
                return false; // Not a valid command
            }
            // Custom command handling would go here
            return false;
        }

        logger.debug(`[ChatBot] Resolved command: "${command}"`);

        // Get command config
        const cmdConfig = this.settings.commands[command];
        if (!cmdConfig || !cmdConfig.enabled) {
            logger.debug(`[ChatBot] Command "${command}" not enabled in config`);
            return false;
        }

        // Check if command is allowed in DMs based on settings
        const isDMAllowed = this.isCommandAllowedInChannel(command, 'dm');
        if (!isDMAllowed) {
            logger.debug(`[ChatBot] Command "${command}" not allowed in DMs`);
            return false;
        }

        // Validate arguments BEFORE executing command
        if (!this.validateCommandArguments(command, args)) {
            logger.debug(`[ChatBot] Invalid arguments for DM command '${command}': [${args.join(', ')}]`);
            return false;
        }

        logger.log(`[ChatBot] DM command from ${senderName}: !${command}`);

        // Mark as processed
        this.processedMessages.add(messageId);

        // Execute command
        try {
            await this.executeCommand(command, args, senderId, senderName, cmdConfig, true);

            return true;
        } catch (error) {
            logger.error(`[ChatBot] Error processing DM command ${command}:`, error);
            // Errors ONLY go to console - no messages to users!
            return true; // Still mark as processed
        }
    }

    /**
     * Execute a command
     */
    async executeCommand(command, args, userId, userName, config, isDM = false) {
        switch (command) {
            case 'forecast':
                await this.handleForecastCommand(args, userId, userName, config, isDM);
                break;

            case 'help':
                await this.handleHelpCommand(userId, userName, config, isDM);
                break;

            default:
                // Custom command
                if (config.message) {
                    await this.sendResponse(config.message, config.responseType, userId, isDM);
                }
                break;
        }
    }

    /**
     * Handle forecast command
     */
    async handleForecastCommand(args, userId, userName, config, isDM) {
        // Parse arguments
        const now = new Date();
        let day;
        let responseType = config.responseType || 'dm';

        // If no arguments, use tomorrow (default forecast behavior)
        if (args.length === 0) {
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            day = tomorrow.getDate();
        } else {
            day = parseInt(args[0]) || now.getDate() + 1; // Default to tomorrow if arg invalid
        }

        // Default timezone: undefined = server will use its local timezone
        // This allows the API to determine the appropriate timezone
        let timezone = args[1] || undefined;

        // Validate day (1-31)
        if (day &lt; 1 || day > 31) {
            throw new Error('Invalid day. Please specify a day between 1 and 31.');
        }

        // Validate timezone if provided
        const validTimezones = [
            'PST', 'PDT', 'MST', 'MDT', 'CST', 'CDT', 'EST', 'EDT',
            'GMT', 'BST', 'WET', 'WEST', 'CET', 'CEST', 'EET', 'EEST',
            'JST', 'KST', 'IST',
            'AEST', 'AEDT', 'ACST', 'ACDT', 'AWST',
            'NZST', 'NZDT',
            'UTC'
        ];

        if (timezone &amp;&amp; !validTimezones.includes(timezone.toUpperCase())) {
            // Invalid timezone - send error message
            const errorMsg = ` Invalid timezone: "${timezone}"\n\n`;
            const tzList = ` Supported timezones:\n${validTimezones.join(', ')}`;
            await this.sendResponse(errorMsg + tzList, responseType, userId, isDM);
            return; // Exit early
        }

        // Normalize timezone to uppercase (if provided)
        if (timezone) {
            timezone = timezone.toUpperCase();
        }

        // Get forecast data
        const forecastText = await this.generateForecastText(day, timezone);

        // Only send response if we got valid forecast text
        if (forecastText &amp;&amp; forecastText.trim()) {
            await this.sendResponse(forecastText, responseType, userId, isDM);
        } else {
            logger.log('[ChatBot] No forecast text generated - skipping response');
        }
    }

    /**
     * Generate forecast text for a specific day
     * @param {number} day - Day of month (1-31)
     * @param {string|undefined} timezone - Timezone abbreviation (undefined = server local timezone)
     */
    async generateForecastText(day, timezone) {
        try {
            logger.log(`[ChatBot] Generating forecast for day ${day}${timezone ? ` in ${timezone}` : ' (server timezone)'}`);

            // Use the existing forecast API endpoint (includes event discounts, formatting, etc.)
            const axios = require('axios');
            const { getSessionCookie } = require('./config');

            // Build query parameters
            const params = new URLSearchParams({
                source: 'chatbot',
                day: day.toString()
            });

            if (timezone) {
                params.append('timezone', timezone);
            }

            // Call internal API endpoint
            const response = await axios.get(`https://localhost:12345/api/forecast?${params.toString()}`, {
                headers: {
                    'Cookie': `shipping_manager_session=${getSessionCookie()}`
                },
                httpsAgent: new (require('https').Agent)({ rejectUnauthorized: false })
            });

            const forecastText = response.data;

            logger.log(`[ChatBot] Forecast generated successfully for day ${day}`);
            return forecastText;

        } catch (error) {
            logger.error('[ChatBot] Error generating forecast:', error.message);
            logger.debug('[ChatBot] Full error:', error);
            // Return empty response on error - no error messages to users
            return '';
        }
    }

    /**
     * Handle help command
     */
    async handleHelpCommand(userId, userName, config, isDM) {
        const prefix = this.settings.commandPrefix || '!';

        let helpText = ' Available Commands\n\n';

        // Built-in commands
        if (this.settings.commands.forecast?.enabled) {
            helpText += ` Get fuel and CO price forecast\n\n`;
            helpText += `${prefix}forecast [day] [timezone]\n`;
            helpText += ` day: 1-31 (default: tomorrow)\n`;
            helpText += ` timezone: (default: server timezone)\n\n`;
            helpText += ` Examples\n`;
            helpText += ` ${prefix}forecast 26 UTC\n`;
            helpText += ` ${prefix}forecast 15\n`;
            helpText += ` ${prefix}forecast\n\n`;
            helpText += ` Supported timezones:\n`;
            helpText += `PST, PDT, MST, MDT, CST, CDT, EST, EDT, GMT, BST, WET, WEST, CET, CEST, EET, EEST, JST, KST, IST, AEST, AEDT, ACST, ACDT, AWST, NZST, NZDT, UTC\n\n`;
        }

        if (this.settings.commands.help?.enabled) {
            helpText += ` Show help\n\n`;
            helpText += `${prefix}help\n\n`;
        }

        // Custom commands
        for (const cmd of this.settings.customCommands || []) {
            if (cmd.enabled) {
                helpText += ` ${cmd.description || 'Custom command'}\n\n`;
                helpText += `${prefix}${cmd.trigger}`;
                if (cmd.adminOnly) {
                    helpText += ' (admin only)';
                }
                helpText += '\n\n';
            }
        }

        helpText += `Response times may vary up to 15 seconds - keep calm :)`;

        await this.sendResponse(helpText, config.responseType || 'public', userId, isDM);
    }

    /**
     * Send response based on type
     */
    async sendResponse(message, responseType, userId, isDM) {

        // Bot owner ALWAYS gets public responses in alliance chat
        const { getUserId } = require('./utils/api');
        const myUserId = getUserId();
        if (userId === myUserId &amp;&amp; !isDM) {
            // If bot owner writes in alliance chat, always respond publicly
            responseType = 'public';
        } else if (responseType === 'dm' &amp;&amp; userId === myUserId) {
            // Never send DM to myself (bot owner)
            responseType = 'public';
        }

        if (isDM &amp;&amp; responseType === 'public') {
            // If command came from DM but wants public response, send to DM instead
            responseType = 'dm';
        }

        switch (responseType) {
            case 'public':
                await this.sendAllianceMessage(message);
                break;

            case 'dm':
                const result = await this.sendPrivateMessage(userId, 'Bot Response', message);

                // If self-DM failed, fall back to public response
                if (!result) {
                    const { getUserId } = require('./utils/api');
                    const myUserId = getUserId();
                    if (userId === myUserId) {
                        // Send shortened public response
                        const shortMsg = message.length > 200 ?
                            message.substring(0, 197) + '...' :
                            message;
                        await this.sendAllianceMessage(`[Auto-Reply] ${shortMsg}`);
                    }
                }
                break;

            case 'both':
                await this.sendAllianceMessage(message.substring(0, 200) + '...'); // Short version
                await this.sendPrivateMessage(userId, 'Full Response', message);
                break;
        }
    }

    /**
     * Log error to console only - NEVER send errors to chat or DM
     */
    async sendErrorMessage(userId, command, error) {
        // ONLY log to console - no messages to users
        logger.error(`[ChatBot] Error executing command '${command}' for user ${userId}:`, error);
        // That's it - no sending messages anywhere!
    }

    /**
     * Send alliance message
     */
    async sendAllianceMessage(message) {
        try {
            const allianceId = getAllianceId();

            // CRITICAL: Game API has 1000 character limit
            if (message.length > 1000) {
                logger.error(`[ChatBot]  WARNING: Message too long! ${message.length} chars (max: 1000)`);
                logger.error(`[ChatBot] Message will be truncated to avoid API error`);

                // Truncate message and add indicator
                message = message.substring(0, 997) + '...';
            }

            // Use the correct endpoint that posts to alliance chat
            const response = await apiCall('/alliance/post-chat', 'POST', {
                alliance_id: allianceId,
                text: message
            });

            // Only log errors
            if (response?.error) {
                logger.error('[ChatBot] API returned error:', response.error);
            } else {
                // Trigger immediate chat refresh so clients see the response quickly
                // instead of waiting up to 25 seconds for next polling cycle
                triggerImmediateChatRefresh();
            }
        } catch (error) {
            logger.error('[ChatBot] Failed to send alliance message:', error);
            logger.error('[ChatBot] Error details:', error.response?.data || error.message);
        }
    }

    /**
     * Send private message
     */
    async sendPrivateMessage(userId, subject, message) {
        const { getUserId } = require('./utils/api');
        const myUserId = getUserId();

        try {
            // CRITICAL: Game API has 1000 character limit for messages
            if (message.length > 1000) {
                logger.error(`[ChatBot]  WARNING: DM too long! ${message.length} chars (max: 1000)`);
                logger.error(`[ChatBot] Message will be truncated to avoid API error`);

                // Truncate message and add indicator
                message = message.substring(0, 997) + '...';
            }

            const response = await apiCall('/messenger/send-message', 'POST', {
                recipient: userId,
                subject: subject,
                body: message
            });

            // Trigger immediate messenger refresh so user sees the response quickly
            // instead of waiting up to 10 seconds for next polling cycle
            if (response &amp;&amp; !response.error) {
                triggerImmediateMessengerRefresh();
            }

            return response;
        } catch (error) {
            logger.error(`[ChatBot] Failed to send private message to ${userId}:`, error);
            logger.error(`[ChatBot] Error details:`, error.response?.data || error.message);

            // Special handling for self-DM attempts
            if (userId === myUserId) {
                logger.error(`[ChatBot] Cannot send DM to yourself - game API limitation`);
                logger.log(`[ChatBot] Falling back to public response`);
                // Don't re-throw for self-DM, handle gracefully
                return null;
            }

            throw error; // Re-throw for other errors
        }
    }

    /**
     * Check if command is on cooldown
     */
    isOnCooldown(userId, command) {
        const userCooldowns = this.lastCommandTime.get(userId);
        if (!userCooldowns) return false;

        const lastTime = userCooldowns[command];
        if (!lastTime) return false;

        const cooldownMs = (this.settings.allianceCommands?.cooldownSeconds || 30) * 1000;
        return Date.now() - lastTime &lt; cooldownMs;
    }

    /**
     * Update cooldown for command
     */
    updateCooldown(userId, command) {
        if (!this.lastCommandTime.has(userId)) {
            this.lastCommandTime.set(userId, {});
        }
        this.lastCommandTime.get(userId)[command] = Date.now();
    }

    /**
     * Validate command arguments
     * @param {string} command - Command name
     * @param {Array&lt;string>} args - Command arguments
     * @returns {boolean} - True if arguments are valid
     */
    validateCommandArguments(command, args) {
        switch (command) {
            case 'forecast':
                return this.validateForecastArguments(args);

            case 'help':
                // Help command accepts no arguments
                return args.length === 0;

            default:
                // Custom commands or unknown commands - accept any arguments
                return true;
        }
    }

    /**
     * Validate forecast command arguments
     * Valid formats:
     * - No args (default: tomorrow)
     * - 1 arg: day (number 1-31)
     * - 2 args: day (number 1-31) + timezone (valid timezone string)
     */
    validateForecastArguments(args) {
        // No arguments is valid (default: tomorrow)
        if (args.length === 0) {
            return true;
        }

        // 1 argument: must be a valid day number (1-31)
        if (args.length === 1) {
            const day = parseInt(args[0]);
            return !isNaN(day) &amp;&amp; day >= 1 &amp;&amp; day &lt;= 31;
        }

        // 2 arguments: day (1-31) + timezone
        if (args.length === 2) {
            const day = parseInt(args[0]);
            const timezone = args[1].toUpperCase();

            // Validate day
            if (isNaN(day) || day &lt; 1 || day > 31) {
                return false;
            }

            // Validate timezone
            const validTimezones = [
                'PST', 'PDT', 'MST', 'MDT', 'CST', 'CDT', 'EST', 'EDT',
                'GMT', 'BST', 'WET', 'WEST', 'CET', 'CEST', 'EET', 'EEST',
                'JST', 'KST', 'IST',
                'AEST', 'AEDT', 'ACST', 'ACDT', 'AWST',
                'NZST', 'NZDT',
                'UTC'
            ];

            return validTimezones.includes(timezone);
        }

        // More than 2 arguments is invalid
        return false;
    }

    /**
     * Check if a command is allowed in a specific channel (alliance or DM)
     */
    isCommandAllowedInChannel(command, channel) {
        try {
            const userId = getUserId();
            if (!userId) {
                return channel === 'alliance';
            }

            const settingsPath = getSettingsFilePath(userId);
            // Read current settings to get latest values
            const data = require('fs').readFileSync(settingsPath, 'utf8');
            const settings = JSON.parse(data);

            // Build setting key based on command and channel
            // e.g., chatbotForecastAllianceEnabled or chatbotForecastDMEnabled
            const capitalizedCommand = command.charAt(0).toUpperCase() + command.slice(1);
            const channelType = channel === 'dm' ? 'DM' : 'Alliance';
            const settingKey = `chatbot${capitalizedCommand}${channelType}Enabled`;

            // Check if setting exists and return its value
            if (settingKey in settings) {
                return settings[settingKey];
            }

            // Default behavior if setting doesn't exist
            // Allow in alliance by default, block in DM by default
            return channel === 'alliance';
        } catch (error) {
            logger.error('[ChatBot] Error checking command channel permission:', error);
            // On error, allow in alliance, block in DM
            return channel === 'alliance';
        }
    }

    /**
     * Find custom command by trigger
     */
    findCustomCommand(trigger) {
        return this.settings.customCommands?.find(cmd =>
            cmd.trigger.toLowerCase() === trigger.toLowerCase()
        );
    }

    /**
     * Setup scheduled tasks
     */
    setupScheduledTasks() {
        // Clear existing tasks
        for (const timeout of this.scheduledTasks.values()) {
            clearTimeout(timeout);
        }
        this.scheduledTasks.clear();

        // Setup daily forecast
        if (this.settings.scheduledMessages?.dailyForecast?.enabled) {
            this.scheduleDailyForecast();
        }
    }

    /**
     * Schedule daily forecast message
     * Uses LOCAL server time, not UTC
     */
    scheduleDailyForecast() {
        const config = this.settings.scheduledMessages.dailyForecast;
        const [hours, minutes] = config.timeUTC.split(':').map(Number);

        const now = new Date();
        const scheduledTime = new Date();

        // Use LOCAL time instead of UTC
        scheduledTime.setHours(hours, minutes, 0, 0);

        // If time has passed today, schedule for tomorrow
        if (scheduledTime &lt;= now) {
            scheduledTime.setDate(scheduledTime.getDate() + 1);
        }

        const msUntilScheduled = scheduledTime - now;

        // Log the scheduled time in local timezone for debugging
        logger.log(`[ChatBot] Daily forecast scheduled for: ${scheduledTime.toLocaleString('de-DE')} (in ${Math.round(msUntilScheduled / 1000 / 60)} minutes)`);

        const timeout = setTimeout(async () => {
            await this.sendDailyForecast();
            // Reschedule for next day
            this.scheduleDailyForecast();
        }, msUntilScheduled);

        this.scheduledTasks.set('dailyForecast', timeout);
    }

    /**
     * Send daily forecast message
     */
    async sendDailyForecast() {
        try {
            // Determine timezone based on current date
            const now = new Date();
            const month = now.getMonth(); // 0-11
            const isEuropeSummer = month >= 3 &amp;&amp; month &lt;= 9; // April to October
            const timezone = isEuropeSummer ? 'CEST' : 'CET';

            const tomorrow = now.getDate() + 1;
            const forecastText = await this.generateForecastText(tomorrow, timezone);
            await this.sendAllianceMessage(forecastText);

            // Broadcast success notification to all connected clients
            const { broadcastToUser } = require('./websocket');
            const userId = getUserId();
            if (broadcastToUser &amp;&amp; userId) {
                logger.log('[ChatBot]  Daily forecast sent successfully to alliance chat');
                broadcastToUser(userId, 'user_action_notification', {
                    type: 'success',
                    message: ` &lt;strong>Daily Forecast Posted&lt;/strong>&lt;br>&lt;br>Tomorrow's forecast has been automatically posted to alliance chat at ${now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}`
                });
            }

            // Trigger immediate chat refresh so the message appears in UI
            const { triggerImmediateChatRefresh } = require('./websocket');
            if (triggerImmediateChatRefresh) {
                triggerImmediateChatRefresh();
            }
        } catch (error) {
            logger.error('[ChatBot] Failed to send daily forecast:', error);

            // Broadcast error notification
            const { broadcastToUser } = require('./websocket');
            const userId = getUserId();
            if (broadcastToUser &amp;&amp; userId) {
                broadcastToUser(userId, 'user_action_notification', {
                    type: 'error',
                    message: ` &lt;strong>Forecast Posting Failed&lt;/strong>&lt;br>&lt;br>Could not post daily forecast: ${error.message}`
                });
            }
        }
    }

    /**
     * Update settings from frontend
     * Settings are saved to per-user settings file using flat keys
     */
    async updateSettings(newSettings) {
        // Update internal state
        this.settings = { ...this.settings, ...newSettings };

        try {
            const userId = getUserId();
            if (!userId) {
                logger.error('[ChatBot] Cannot update settings: No user ID available');
                return;
            }

            // Get per-user settings file path
            const settingsPath = getSettingsFilePath(userId);

            // Read current per-user settings
            const data = await fs.readFile(settingsPath, 'utf8');
            const allSettings = JSON.parse(data);

            // Map ChatBot's nested structure to flat keys
            const flatChatBotSettings = this.mapChatBotObjectToFlatSettings(this.settings);

            // Merge flat ChatBot keys into per-user settings
            Object.assign(allSettings, flatChatBotSettings);

            // Save updated per-user settings
            await fs.writeFile(settingsPath, JSON.stringify(allSettings, null, 2), 'utf8');

            logger.log('[ChatBot] Settings updated successfully');

            // Restart scheduled tasks
            this.setupScheduledTasks();
        } catch (error) {
            logger.error('[ChatBot] Error updating settings:', error);
        }
    }
}

// Create singleton instance
const chatBot = new ChatBot();

module.exports = chatBot;</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation Version: 0.0.7 - ShippingManager CoPilot
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
