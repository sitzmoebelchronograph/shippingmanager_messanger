<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>public/js/modules/vessel-management.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Dark theme matching app style - carefully scoped to not break layout */
        html, body {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
            overflow-x: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Custom scrollbar styling for all browsers */
        * {
            scrollbar-width: thin !important;
            scrollbar-color: #404040 #1a1a1a !important;
        }

        /* Webkit browsers (Chrome, Safari, Edge) */
        *::-webkit-scrollbar {
            width: 6px !important;
            height: 6px !important;
        }

        *::-webkit-scrollbar-track {
            background: #1a1a1a !important;
        }

        *::-webkit-scrollbar-thumb {
            background-color: #404040 !important;
            border-radius: 3px !important;
        }

        *::-webkit-scrollbar-thumb:hover {
            background-color: #505050 !important;
        }

        /* Navigation sidebar - remove padding and white borders */
        nav {
            background-color: #242424 !important;
            border-right: 1px solid #404040 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow-x: hidden !important;
        }
        nav h2, nav h3 {
            color: #e0e0e0 !important;
            border-bottom: 1px solid #404040 !important;
            padding: 10px 15px !important;
            margin: 0 !important;
            background-color: #242424 !important;
            font-size: 14px !important;
            font-weight: 600 !important;
        }
        nav h3 {
            font-size: 13px !important;
        }
        nav ul {
            padding: 0 !important;
            margin: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li {
            list-style: none !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li a {
            color: #c9d1d9 !important;
            display: block !important;
            padding: 8px 15px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            background-color: #242424 !important;
            margin: 0 !important;
            border: none !important;
            font-size: 14px !important;
        }
        nav ul li a:hover {
            color: #60a5fa !important;
            background-color: rgba(96, 165, 250, 0.1) !important;
        }
        /* Module links (direct children of nav > ul > li) */
        nav > ul > li > a {
            color: #60a5fa !important;
            font-weight: 600 !important;
            padding: 10px 15px !important;
            font-size: 14px !important;
            border-left: 3px solid #60a5fa !important;
            padding-left: 12px !important;
        }
        nav > ul > li > a:hover {
            background-color: rgba(96, 165, 250, 0.15) !important;
        }
        /* Sub-items (methods/functions) indented */
        nav ul.methods {
            padding-left: 15px !important;
        }
        nav ul.methods li a {
            color: #9ca3af !important;
            font-size: 13px !important;
            padding: 6px 15px !important;
            font-weight: 400 !important;
        }
        nav ul.methods li a:hover {
            color: #c9d1d9 !important;
        }
        nav > h2:first-child {
            font-size: 16px !important;
            font-weight: 700 !important;
            padding: 12px 15px !important;
        }

        /* Main content area - dark background */
        #main {
            background-color: #1a1a1a !important;
            padding: 20px !important;
        }

        /* Article and sections - ensure dark background */
        article, section, .container-overview, .description {
            background-color: #1a1a1a !important;
        }

        /* Images - style demo images */
        img {
            max-width: 100% !important;
            height: auto !important;
            border: 1px solid #404040 !important;
            border-radius: 8px !important;
            margin: 20px 0 !important;
        }

        /* Links */
        a {
            color: #60a5fa !important;
            text-decoration: none !important;
        }
        a:hover {
            color: #93c5fd !important;
            text-decoration: underline !important;
        }

        /* Headings */
        h1, h2, h3, h4, h5, h6 {
            color: #e0e0e0 !important;
            border-bottom-color: #404040 !important;
            background-color: transparent !important;
        }
        h4.name {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
        }

        /* Code blocks */
        pre {
            background-color: #0d1117 !important;
            border: 1px solid #404040 !important;
        }
        pre code {
            background-color: transparent !important;
        }
        code {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
        }

        /* Tables */
        table {
            border-color: #404040 !important;
            background-color: #1a1a1a !important;
        }
        table thead tr {
            background-color: #242424 !important;
        }
        table tbody tr {
            background-color: #1a1a1a !important;
        }
        table tbody tr:nth-child(even) {
            background-color: #1f1f1f !important;
        }
        table td, table th {
            border-color: #404040 !important;
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }
        .params .name, .props .name {
            color: #10b981 !important;
            font-family: 'Courier New', monospace !important;
        }

        /* Descriptions and details */
        .description, .details, dt, dd, p, ul, ol, dl {
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }

        /* Types */
        .type-signature {
            color: #a78bfa !important;
        }

        /* Source links */
        .details .details-item-container {
            border-left-color: #404040 !important;
        }

        /* Breadcrumbs */
        .page-title {
            color: #e0e0e0 !important;
        }

        /* Search */
        #nav-search {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
            color: #e0e0e0 !important;
        }

        /* Mobile nav trigger */
        .navicon-button {
            background-color: #2a2a2a !important;
        }

        /* Footer */
        footer {
            background-color: #1a1a1a !important;
            color: #9ca3af !important;
            border-top: 1px solid #404040 !important;
            text-align: center !important;
            padding: 20px !important;
        }

        /* Remove horizontal scrollbar and white borders */
        * {
            box-sizing: border-box !important;
        }
    </style>
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">README</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-build-guide.html">Build Guide</a></li><li><a href="tutorial-installation-guide.html">Installation Guide</a></li></ul><h3>Classes</h3><ul><li><a href="module-core_debounced-api.DebouncedAPIManager.html">DebouncedAPIManager</a><ul class='methods'><li data-type='method'><a href="module-core_debounced-api.DebouncedAPIManager.html#call">call</a></li><li data-type='method'><a href="module-core_debounced-api.DebouncedAPIManager.html#cancelAll">cancelAll</a></li><li data-type='method'><a href="module-core_debounced-api.DebouncedAPIManager.html#get">get</a></li><li data-type='method'><a href="module-core_debounced-api.DebouncedAPIManager.html#register">register</a></li></ul></li><li><a href="module-server_chatbot-ChatBot.html">ChatBot</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot-ChatBot.html#initialize">initialize</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#processAllianceMessage">processAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#processPrivateMessage">processPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#setupScheduledTasks">setupScheduledTasks</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#updateSettings">updateSettings</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-alliance-tabs.html">alliance-tabs</a><ul class='methods'><li data-type='method'><a href="module-alliance-tabs.html#.clearAllianceTabCache">clearAllianceTabCache</a></li><li data-type='method'><a href="module-alliance-tabs.html#.closeAllianceCoopOverlay">closeAllianceCoopOverlay</a></li><li data-type='method'><a href="module-alliance-tabs.html#.getCurrentTab">getCurrentTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#.hideAllAllianceUI">hideAllAllianceUI</a></li><li data-type='method'><a href="module-alliance-tabs.html#.initAllianceTabs">initAllianceTabs</a></li><li data-type='method'><a href="module-alliance-tabs.html#.refreshCurrentTab">refreshCurrentTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#.showAllAllianceUI">showAllAllianceUI</a></li><li data-type='method'><a href="module-alliance-tabs.html#.showAllianceCoopOverlay">showAllianceCoopOverlay</a></li><li data-type='method'><a href="module-alliance-tabs.html#.switchTab">switchTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#.updateCoopTabBadge">updateCoopTabBadge</a></li><li data-type='method'><a href="module-alliance-tabs.html#~acceptUserToAlliance">acceptUserToAlliance</a></li><li data-type='method'><a href="module-alliance-tabs.html#~appendSearchResults">appendSearchResults</a></li><li data-type='method'><a href="module-alliance-tabs.html#~attachAllianceClickHandlers">attachAllianceClickHandlers</a></li><li data-type='method'><a href="module-alliance-tabs.html#~attachSearchEventListeners">attachSearchEventListeners</a></li><li data-type='method'><a href="module-alliance-tabs.html#~createAllianceRow">createAllianceRow</a></li><li data-type='method'><a href="module-alliance-tabs.html#~declineUserFromAlliance">declineUserFromAlliance</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchAllianceInfo">fetchAllianceInfo</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchAllianceInfoById">fetchAllianceInfoById</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchAllianceMembers">fetchAllianceMembers</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchAllianceMembersById">fetchAllianceMembersById</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchAllianceSettings">fetchAllianceSettings</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchHighScores">fetchHighScores</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchLeagueInfo">fetchLeagueInfo</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchQueuePool">fetchQueuePool</a></li><li data-type='method'><a href="module-alliance-tabs.html#~generateAllianceInfoHTML">generateAllianceInfoHTML</a></li><li data-type='method'><a href="module-alliance-tabs.html#~handleJoinAllianceClick">handleJoinAllianceClick</a></li><li data-type='method'><a href="module-alliance-tabs.html#~leaveAlliance">leaveAlliance</a></li><li data-type='method'><a href="module-alliance-tabs.html#~loadTabContent">loadTabContent</a></li><li data-type='method'><a href="module-alliance-tabs.html#~loadWelcomeMessage">loadWelcomeMessage</a></li><li data-type='method'><a href="module-alliance-tabs.html#~normalizeColor">normalizeColor</a></li><li data-type='method'><a href="module-alliance-tabs.html#~performSearch">performSearch</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderAllianzTab">renderAllianzTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderCoopTab">renderCoopTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderHighScoreTab">renderHighScoreTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderLigaTab">renderLigaTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderManagementTab">renderManagementTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderMemberCard">renderMemberCard</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderSearchResults">renderSearchResults</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderSearchTab">renderSearchTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderSettingsTab">renderSettingsTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~saveWelcomeMessage">saveWelcomeMessage</a></li><li data-type='method'><a href="module-alliance-tabs.html#~sendWelcomeMessageToUser">sendWelcomeMessageToUser</a></li><li data-type='method'><a href="module-alliance-tabs.html#~showAllianceDetailsModal">showAllianceDetailsModal</a></li><li data-type='method'><a href="module-alliance-tabs.html#~showDonateDialog">showDonateDialog</a></li><li data-type='method'><a href="module-alliance-tabs.html#~showTextInputDialog">showTextInputDialog</a></li><li data-type='method'><a href="module-alliance-tabs.html#~updateAllianceSettings">updateAllianceSettings</a></li><li data-type='method'><a href="module-alliance-tabs.html#~updateManagementTabVisibility">updateManagementTabVisibility</a></li><li data-type='method'><a href="module-alliance-tabs.html#~updateTabVisibilityForAllianceMembers">updateTabVisibilityForAllianceMembers</a></li><li data-type='method'><a href="module-alliance-tabs.html#~updateTabVisibilityForNonMembers">updateTabVisibilityForNonMembers</a></li><li data-type='method'><a href="module-alliance-tabs.html#~updateUserRole">updateUserRole</a></li><li data-type='method'><a href="module-alliance-tabs.html#~updateWelcomeMessageCharCount">updateWelcomeMessageCharCount</a></li></ul></li><li><a href="module-api.html">api</a><ul class='methods'><li data-type='method'><a href="module-api.html#.activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-api.html#.deleteAllLogs">deleteAllLogs</a></li><li data-type='method'><a href="module-api.html#.deleteChat">deleteChat</a></li><li data-type='method'><a href="module-api.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-api.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-api.html#.departVessels">departVessels</a></li><li data-type='method'><a href="module-api.html#.doWearMaintenanceBulk">doWearMaintenanceBulk</a></li><li data-type='method'><a href="module-api.html#.downloadLogbookExport">downloadLogbookExport</a></li><li data-type='method'><a href="module-api.html#.fetchAcquirableVessels">fetchAcquirableVessels</a></li><li data-type='method'><a href="module-api.html#.fetchAllianceMembers">fetchAllianceMembers</a></li><li data-type='method'><a href="module-api.html#.fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-api.html#.fetchBunkerPrices">fetchBunkerPrices</a></li><li data-type='method'><a href="module-api.html#.fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-api.html#.fetchChat">fetchChat</a></li><li data-type='method'><a href="module-api.html#.fetchContacts">fetchContacts</a></li><li data-type='method'><a href="module-api.html#.fetchLogbookEntries">fetchLogbookEntries</a></li><li data-type='method'><a href="module-api.html#.fetchLogbookFileSize">fetchLogbookFileSize</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerChats">fetchMessengerChats</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerMessages">fetchMessengerMessages</a></li><li data-type='method'><a href="module-api.html#.fetchUserCompany">fetchUserCompany</a></li><li data-type='method'><a href="module-api.html#.fetchUserSettings">fetchUserSettings</a></li><li data-type='method'><a href="module-api.html#.fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-api.html#.getCompanyNameCached">getCompanyNameCached</a></li><li data-type='method'><a href="module-api.html#.getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-api.html#.markChatAsRead">markChatAsRead</a></li><li data-type='method'><a href="module-api.html#.purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-api.html#.purchaseFuel">purchaseFuel</a></li><li data-type='method'><a href="module-api.html#.purchaseVessel">purchaseVessel</a></li><li data-type='method'><a href="module-api.html#.searchUsers">searchUsers</a></li><li data-type='method'><a href="module-api.html#.sendChatMessage">sendChatMessage</a></li><li data-type='method'><a href="module-api.html#.sendPrivateMessage">sendPrivateMessage</a></li></ul></li><li><a href="module-app.html">app</a></li><li><a href="module-automation.html">automation</a><ul class='methods'><li data-type='method'><a href="module-automation.html#.initAutomation">initAutomation</a></li><li data-type='method'><a href="module-automation.html#.runAutomationChecks">runAutomationChecks</a></li><li data-type='method'><a href="module-automation.html#.triggerAutoRebuyChecks">triggerAutoRebuyChecks</a></li><li data-type='method'><a href="module-automation.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-automation.html#~checkAutoCampaignRenewal">checkAutoCampaignRenewal</a></li><li data-type='method'><a href="module-automation.html#~checkAutoDepartAll">checkAutoDepartAll</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyCO2">checkAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyFuel">checkAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~getTotalCapacity">getTotalCapacity</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyCO2">performAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyFuel">performAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~updateAutoDepartLabel">updateAutoDepartLabel</a></li></ul></li><li><a href="module-badge-manager.html">badge-manager</a><ul class='methods'><li data-type='method'><a href="module-badge-manager.html#.getBadgeCount">getBadgeCount</a></li><li data-type='method'><a href="module-badge-manager.html#.hideBadge">hideBadge</a></li><li data-type='method'><a href="module-badge-manager.html#.showBadge">showBadge</a></li><li data-type='method'><a href="module-badge-manager.html#.updateBadge">updateBadge</a></li><li data-type='method'><a href="module-badge-manager.html#.updateButtonState">updateButtonState</a></li><li data-type='method'><a href="module-badge-manager.html#.updateButtonTooltip">updateButtonTooltip</a></li><li data-type='method'><a href="module-badge-manager.html#.updateButtonVisibility">updateButtonVisibility</a></li></ul></li><li><a href="module-bunker-management.html">bunker-management</a><ul class='methods'><li data-type='method'><a href="module-bunker-management.html#.buyMaxCO2">buyMaxCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.buyMaxFuel">buyMaxFuel</a></li><li data-type='method'><a href="module-bunker-management.html#.getCurrentBunkerState">getCurrentBunkerState</a></li><li data-type='method'><a href="module-bunker-management.html#.setCapacityFromBunkerUpdate">setCapacityFromBunkerUpdate</a></li><li data-type='method'><a href="module-bunker-management.html#.updateBunkerStatus">updateBunkerStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCO2">updateCurrentCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCash">updateCurrentCash</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentFuel">updateCurrentFuel</a></li></ul></li><li><a href="module-chat.html">chat</a><ul class='methods'><li data-type='method'><a href="module-chat.html#.displayMessages">displayMessages</a></li><li data-type='method'><a href="module-chat.html#.handleMessageInput">handleMessageInput</a></li><li data-type='method'><a href="module-chat.html#.initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-chat.html#.loadAllianceMembers">loadAllianceMembers</a></li><li data-type='method'><a href="module-chat.html#.loadMessages">loadMessages</a></li><li data-type='method'><a href="module-chat.html#.markAllianceChatAsRead">markAllianceChatAsRead</a></li><li data-type='method'><a href="module-chat.html#.parseMessageWithMentions">parseMessageWithMentions</a></li><li data-type='method'><a href="module-chat.html#.sendMessage">sendMessage</a></li><li data-type='method'><a href="module-chat.html#.setChatScrollListener">setChatScrollListener</a></li><li data-type='method'><a href="module-chat.html#~attemptReconnect">attemptReconnect</a></li><li data-type='method'><a href="module-chat.html#~displaySuggestions">displaySuggestions</a></li><li data-type='method'><a href="module-chat.html#~formatLocalTime">formatLocalTime</a></li><li data-type='method'><a href="module-chat.html#~handleAllianceChanged">handleAllianceChanged</a></li><li data-type='method'><a href="module-chat.html#~handleAllianceIndexReady">handleAllianceIndexReady</a></li><li data-type='method'><a href="module-chat.html#~handleAutoCoopComplete">handleAutoCoopComplete</a></li><li data-type='method'><a href="module-chat.html#~handleAutoCoopNoTargets">handleAutoCoopNoTargets</a></li><li data-type='method'><a href="module-chat.html#~handleAutopilotDepartStart">handleAutopilotDepartStart</a></li><li data-type='method'><a href="module-chat.html#~handleBackendAutoRepairComplete">handleBackendAutoRepairComplete</a></li><li data-type='method'><a href="module-chat.html#~handleBunkerUpdate">handleBunkerUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleCO2Purchased">handleCO2Purchased</a></li><li data-type='method'><a href="module-chat.html#~handleCampaignsRenewed">handleCampaignsRenewed</a></li><li data-type='method'><a href="module-chat.html#~handleCompanyTypeUpdate">handleCompanyTypeUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleCoopUpdate">handleCoopUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleDrydockCountUpdate">handleDrydockCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleFuelPurchased">handleFuelPurchased</a></li><li data-type='method'><a href="module-chat.html#~handleGenericNotification">handleGenericNotification</a></li><li data-type='method'><a href="module-chat.html#~handleHarborMapRefreshRequired">handleHarborMapRefreshRequired</a></li><li data-type='method'><a href="module-chat.html#~handleHeaderDataUpdate">handleHeaderDataUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleHijackingUpdate">handleHijackingUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleMentionAutocomplete">handleMentionAutocomplete</a></li><li data-type='method'><a href="module-chat.html#~handleMessengerUpdate">handleMessengerUpdate</a></li><li data-type='method'><a href="module-chat.html#~handlePriceAlert">handlePriceAlert</a></li><li data-type='method'><a href="module-chat.html#~handlePriceUpdate">handlePriceUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleRepairCountUpdate">handleRepairCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleStaffTrainingPointsUpdate">handleStaffTrainingPointsUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleStaffUpdate">handleStaffUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleUnreadMessagesUpdate">handleUnreadMessagesUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleUserActionNotification">handleUserActionNotification</a></li><li data-type='method'><a href="module-chat.html#~handleVesselCountUpdate">handleVesselCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDepartBatch">handleVesselsDepartBatch</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDepartComplete">handleVesselsDepartComplete</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDeparted">handleVesselsDeparted</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDrydocked">handleVesselsDrydocked</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsFailed">handleVesselsFailed</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsRepaired">handleVesselsRepaired</a></li><li data-type='method'><a href="module-chat.html#~hideMemberSuggestions">hideMemberSuggestions</a></li><li data-type='method'><a href="module-chat.html#~insertMention">insertMention</a></li><li data-type='method'><a href="module-chat.html#~registerUsernameClickEvents">registerUsernameClickEvents</a></li><li data-type='method'><a href="module-chat.html#~updateAllianceChatBadge">updateAllianceChatBadge</a></li></ul></li><li><a href="module-company-profile.html">company-profile</a><ul class='methods'><li data-type='method'><a href="module-company-profile.html#.closeCompanyProfile">closeCompanyProfile</a></li><li data-type='method'><a href="module-company-profile.html#.initCompanyProfile">initCompanyProfile</a></li><li data-type='method'><a href="module-company-profile.html#.openCompanyProfile">openCompanyProfile</a></li><li data-type='method'><a href="module-company-profile.html#.openPlayerProfile">openPlayerProfile</a></li><li data-type='method'><a href="module-company-profile.html#~adjustSalary">adjustSalary</a></li><li data-type='method'><a href="module-company-profile.html#~attachAllianceClickListener">attachAllianceClickListener</a></li><li data-type='method'><a href="module-company-profile.html#~attachSalaryButtonListeners">attachSalaryButtonListeners</a></li><li data-type='method'><a href="module-company-profile.html#~buildAchievementsSection">buildAchievementsSection</a></li><li data-type='method'><a href="module-company-profile.html#~buildSection">buildSection</a></li><li data-type='method'><a href="module-company-profile.html#~buildStaffSection">buildStaffSection</a></li><li data-type='method'><a href="module-company-profile.html#~formatLabel">formatLabel</a></li><li data-type='method'><a href="module-company-profile.html#~formatMoraleLabel">formatMoraleLabel</a></li><li data-type='method'><a href="module-company-profile.html#~formatPerkName">formatPerkName</a></li><li data-type='method'><a href="module-company-profile.html#~formatValue">formatValue</a></li><li data-type='method'><a href="module-company-profile.html#~generateMoraleSmiley">generateMoraleSmiley</a></li><li data-type='method'><a href="module-company-profile.html#~loadCompanyProfile">loadCompanyProfile</a></li><li data-type='method'><a href="module-company-profile.html#~loadStaffData">loadStaffData</a></li><li data-type='method'><a href="module-company-profile.html#~renderCompanyProfile">renderCompanyProfile</a></li><li data-type='method'><a href="module-company-profile.html#~renderSearchResults">renderSearchResults</a></li><li data-type='method'><a href="module-company-profile.html#~searchPlayers">searchPlayers</a></li><li data-type='method'><a href="module-company-profile.html#~toggleAchievementsList">toggleAchievementsList</a></li><li data-type='method'><a href="module-company-profile.html#~toggleStaffDetails">toggleStaffDetails</a></li><li data-type='method'><a href="module-company-profile.html#~trainPerk">trainPerk</a></li></ul></li><li><a href="module-coop.html">coop</a><ul class='methods'><li data-type='method'><a href="module-coop.html#.closeCoopOverlay">closeCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.fetchCoopData">fetchCoopData</a></li><li data-type='method'><a href="module-coop.html#.sendCoopMax">sendCoopMax</a></li><li data-type='method'><a href="module-coop.html#.showCoopOverlay">showCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.updateCoopBadge">updateCoopBadge</a></li><li data-type='method'><a href="module-coop.html#~renderMemberCard">renderMemberCard</a></li></ul></li><li><a href="module-core_app-initializer.html">core/app-initializer</a><ul class='methods'><li data-type='method'><a href="module-core_app-initializer.html#.initializeApp">initializeApp</a></li><li data-type='method'><a href="module-core_app-initializer.html#~createAllianceChatHandler">createAllianceChatHandler</a></li><li data-type='method'><a href="module-core_app-initializer.html#~createBuyVesselsHandler">createBuyVesselsHandler</a></li><li data-type='method'><a href="module-core_app-initializer.html#~createDebouncedFunctions">createDebouncedFunctions</a></li><li data-type='method'><a href="module-core_app-initializer.html#~createForecastHandler">createForecastHandler</a></li><li data-type='method'><a href="module-core_app-initializer.html#~createTestBrowserNotification">createTestBrowserNotification</a></li><li data-type='method'><a href="module-core_app-initializer.html#~exposeGlobalFunctions">exposeGlobalFunctions</a></li><li data-type='method'><a href="module-core_app-initializer.html#~formatNumberWithSeparator">formatNumberWithSeparator</a></li><li data-type='method'><a href="module-core_app-initializer.html#~initializeSettingsUI">initializeSettingsUI</a></li><li data-type='method'><a href="module-core_app-initializer.html#~loadInitialData">loadInitialData</a></li><li data-type='method'><a href="module-core_app-initializer.html#~loadUserSettings">loadUserSettings</a></li><li data-type='method'><a href="module-core_app-initializer.html#~registerAllEventListeners">registerAllEventListeners</a></li><li data-type='method'><a href="module-core_app-initializer.html#~setCheckboxState">setCheckboxState</a></li><li data-type='method'><a href="module-core_app-initializer.html#~setCheckboxValue">setCheckboxValue</a></li><li data-type='method'><a href="module-core_app-initializer.html#~setFormattedInputValue">setFormattedInputValue</a></li><li data-type='method'><a href="module-core_app-initializer.html#~setInputValue">setInputValue</a></li><li data-type='method'><a href="module-core_app-initializer.html#~toggleElementVisibility">toggleElementVisibility</a></li></ul></li><li><a href="module-core_auto-refresh.html">core/auto-refresh</a><ul class='methods'><li data-type='method'><a href="module-core_auto-refresh.html#.getActiveIntervals">getActiveIntervals</a></li><li data-type='method'><a href="module-core_auto-refresh.html#.initNotificationButtonUpdater">initNotificationButtonUpdater</a></li><li data-type='method'><a href="module-core_auto-refresh.html#.initVersionChecker">initVersionChecker</a></li><li data-type='method'><a href="module-core_auto-refresh.html#.initVisibilityHandler">initVisibilityHandler</a></li><li data-type='method'><a href="module-core_auto-refresh.html#.preloadAllImages">preloadAllImages</a></li><li data-type='method'><a href="module-core_auto-refresh.html#.stopAllIntervals">stopAllIntervals</a></li><li data-type='method'><a href="module-core_auto-refresh.html#.stopInterval">stopInterval</a></li></ul></li><li><a href="module-core_badge-cache.html">core/badge-cache</a><ul class='methods'><li data-type='method'><a href="module-core_badge-cache.html#.loadCache">loadCache</a></li><li data-type='method'><a href="module-core_badge-cache.html#.saveBadgeCache">saveBadgeCache</a></li><li data-type='method'><a href="module-core_badge-cache.html#.updateCoopDisplay">updateCoopDisplay</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadBunkerStatus">loadBunkerStatus</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadCampaignsBadge">loadCampaignsBadge</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadCoopData">loadCoopData</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadHijackingBadge">loadHijackingBadge</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadPrices">loadPrices</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadRepairBadges">loadRepairBadges</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadStockAndAnchor">loadStockAndAnchor</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadVesselBadges">loadVesselBadges</a></li></ul></li><li><a href="module-core_debounced-api.html">core/debounced-api</a><ul class='methods'><li data-type='method'><a href="module-core_debounced-api.html#.cancelAllDebouncedFunctions">cancelAllDebouncedFunctions</a></li><li data-type='method'><a href="module-core_debounced-api.html#.cancelDebouncedFunction">cancelDebouncedFunction</a></li><li data-type='method'><a href="module-core_debounced-api.html#.createDebouncedFunction">createDebouncedFunction</a></li><li data-type='method'><a href="module-core_debounced-api.html#.isDebouncePending">isDebouncePending</a></li></ul></li><li><a href="module-core_event-registry.html">core/event-registry</a><ul class='methods'><li data-type='method'><a href="module-core_event-registry.html#.registerAutoDepartSettingsListeners">registerAutoDepartSettingsListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerAutoPilotFeatureListeners">registerAutoPilotFeatureListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerAutoPilotListeners">registerAutoPilotListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerAutoRebuyCO2Listeners">registerAutoRebuyCO2Listeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerAutoRebuyFuelListeners">registerAutoRebuyFuelListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerBunkerListeners">registerBunkerListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerChatBotSettingsListeners">registerChatBotSettingsListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerChatEventListeners">registerChatEventListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerCustomCommandsListeners">registerCustomCommandsListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerDialogEventListeners">registerDialogEventListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerMessengerEventListeners">registerMessengerEventListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerNotificationPermissionListener">registerNotificationPermissionListener</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerNumberFormatting">registerNumberFormatting</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerSectionToggle">registerSectionToggle</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerSettingsThresholdListeners">registerSettingsThresholdListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerVesselCatalogEventListeners">registerVesselCatalogEventListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#~createCustomCommandElement">createCustomCommandElement</a></li><li data-type='method'><a href="module-core_event-registry.html#~formatNumberWithSeparator">formatNumberWithSeparator</a></li></ul></li><li><a href="module-core_global-exports.html">core/global-exports</a><ul class='methods'><li data-type='method'><a href="module-core_global-exports.html#.exportApiUrl">exportApiUrl</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportAutopilotFunctions">exportAutopilotFunctions</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportCacheKeys">exportCacheKeys</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportDebouncedFunctions">exportDebouncedFunctions</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportDebugMode">exportDebugMode</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportGlobals">exportGlobals</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportLogbookHandler">exportLogbookHandler</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportOverlayFunctions">exportOverlayFunctions</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportSettingsHandler">exportSettingsHandler</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportStorageFunctions">exportStorageFunctions</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportVersionFunctions">exportVersionFunctions</a></li></ul></li><li><a href="module-core_settings-sync.html">core/settings-sync</a><ul class='methods'><li data-type='method'><a href="module-core_settings-sync.html#.handleSettingsUpdate">handleSettingsUpdate</a></li><li data-type='method'><a href="module-core_settings-sync.html#.toggleAutoPilotAgentCheckboxes">toggleAutoPilotAgentCheckboxes</a></li><li data-type='method'><a href="module-core_settings-sync.html#~formatNumberWithSeparator">formatNumberWithSeparator</a></li><li data-type='method'><a href="module-core_settings-sync.html#~updateAutoPilotToggles">updateAutoPilotToggles</a></li><li data-type='method'><a href="module-core_settings-sync.html#~updateAutoRebuyCO2UI">updateAutoRebuyCO2UI</a></li><li data-type='method'><a href="module-core_settings-sync.html#~updateAutoRebuyFuelUI">updateAutoRebuyFuelUI</a></li><li data-type='method'><a href="module-core_settings-sync.html#~updateChatBotSettings">updateChatBotSettings</a></li><li data-type='method'><a href="module-core_settings-sync.html#~updateNotificationSettings">updateNotificationSettings</a></li><li data-type='method'><a href="module-core_settings-sync.html#~updateThresholdInputs">updateThresholdInputs</a></li></ul></li><li><a href="module-core_storage-manager.html">core/storage-manager</a><ul class='methods'><li data-type='method'><a href="module-core_storage-manager.html#.clearUserStorage">clearUserStorage</a></li><li data-type='method'><a href="module-core_storage-manager.html#.getStorage">getStorage</a></li><li data-type='method'><a href="module-core_storage-manager.html#.getUserStorageKey">getUserStorageKey</a></li><li data-type='method'><a href="module-core_storage-manager.html#.getUserStoragePrefix">getUserStoragePrefix</a></li><li data-type='method'><a href="module-core_storage-manager.html#.removeStorage">removeStorage</a></li><li data-type='method'><a href="module-core_storage-manager.html#.setStorage">setStorage</a></li><li data-type='method'><a href="module-core_storage-manager.html#.setUserStoragePrefix">setUserStoragePrefix</a></li></ul></li><li><a href="module-core_websocket-client.html">core/websocket-client</a><ul class='methods'><li data-type='method'><a href="module-core_websocket-client.html#.getWebSocketState">getWebSocketState</a></li><li data-type='method'><a href="module-core_websocket-client.html#.incrementReconnectCounter">incrementReconnectCounter</a></li><li data-type='method'><a href="module-core_websocket-client.html#.initAutopilotControls">initAutopilotControls</a></li><li data-type='method'><a href="module-core_websocket-client.html#.loadAutopilotState">loadAutopilotState</a></li><li data-type='method'><a href="module-core_websocket-client.html#.resetReconnectCounter">resetReconnectCounter</a></li><li data-type='method'><a href="module-core_websocket-client.html#.triggerPriceAlertCheck">triggerPriceAlertCheck</a></li><li data-type='method'><a href="module-core_websocket-client.html#.updateWebSocketState">updateWebSocketState</a></li></ul></li><li><a href="module-depart-manager.html">depart-manager</a><ul class='methods'><li data-type='method'><a href="module-depart-manager.html#.closeDepartManager">closeDepartManager</a></li><li data-type='method'><a href="module-depart-manager.html#.initializeDepartManager">initializeDepartManager</a></li><li data-type='method'><a href="module-depart-manager.html#.openDepartManager">openDepartManager</a></li><li data-type='method'><a href="module-depart-manager.html#.toggleDepartManager">toggleDepartManager</a></li><li data-type='method'><a href="module-depart-manager.html#~departSelectedVessels">departSelectedVessels</a></li><li data-type='method'><a href="module-depart-manager.html#~drag">drag</a></li><li data-type='method'><a href="module-depart-manager.html#~loadDepartableVessels">loadDepartableVessels</a></li><li data-type='method'><a href="module-depart-manager.html#~locateVesselOnMap">locateVesselOnMap</a></li><li data-type='method'><a href="module-depart-manager.html#~selectAllVessels">selectAllVessels</a></li><li data-type='method'><a href="module-depart-manager.html#~selectRouteInMapFilter">selectRouteInMapFilter</a></li><li data-type='method'><a href="module-depart-manager.html#~startDrag">startDrag</a></li><li data-type='method'><a href="module-depart-manager.html#~stopDrag">stopDrag</a></li><li data-type='method'><a href="module-depart-manager.html#~unselectAllVessels">unselectAllVessels</a></li><li data-type='method'><a href="module-depart-manager.html#~updateDepartButtonCount">updateDepartButtonCount</a></li></ul></li><li><a href="module-desktop-notification-templates.html">desktop-notification-templates</a><ul class='methods'><li data-type='method'><a href="module-desktop-notification-templates.html#.createDesktopNotification">createDesktopNotification</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.getDefaultEmoji">getDefaultEmoji</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.getNotificationTypes">getNotificationTypes</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.isValidNotificationType">isValidNotificationType</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyAlert">notifyAlert</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyError">notifyError</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifySuccess">notifySuccess</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyWarning">notifyWarning</a></li></ul></li><li><a href="module-event-info.html">event-info</a><ul class='methods'><li data-type='method'><a href="module-event-info.html#.initEventInfo">initEventInfo</a></li><li data-type='method'><a href="module-event-info.html#.openEventModal">openEventModal</a></li><li data-type='method'><a href="module-event-info.html#.updateEventData">updateEventData</a></li><li data-type='method'><a href="module-event-info.html#~startEventTimer">startEventTimer</a></li></ul></li><li><a href="module-forecast-calendar.html">forecast-calendar</a><ul class='methods'><li data-type='method'><a href="module-forecast-calendar.html#.initForecastCalendar">initForecastCalendar</a></li><li data-type='method'><a href="module-forecast-calendar.html#.updateEventDiscount">updateEventDiscount</a></li><li data-type='method'><a href="module-forecast-calendar.html#~createTableHTML">createTableHTML</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getBrowserTimezone">getBrowserTimezone</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getCo2Class">getCo2Class</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getCurrentVisibleDay">getCurrentVisibleDay</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getFuelClass">getFuelClass</a></li><li data-type='method'><a href="module-forecast-calendar.html#~isEventActiveAtTime">isEventActiveAtTime</a></li><li data-type='method'><a href="module-forecast-calendar.html#~isEventActiveOnDay">isEventActiveOnDay</a></li><li data-type='method'><a href="module-forecast-calendar.html#~loadForecastData">loadForecastData</a></li><li data-type='method'><a href="module-forecast-calendar.html#~preloadMonth">preloadMonth</a></li><li data-type='method'><a href="module-forecast-calendar.html#~renderBook">renderBook</a></li><li data-type='method'><a href="module-forecast-calendar.html#~updateEventBadge">updateEventBadge</a></li></ul></li><li><a href="module-harbor-map-aggregator.html">harbor-map-aggregator</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-aggregator.html#~aggregateReachablePorts">aggregateReachablePorts</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~aggregateVesselData">aggregateVesselData</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~categorizeVesselsByPort">categorizeVesselsByPort</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~extractPortsFromGameIndex">extractPortsFromGameIndex</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~extractVesselsFromGameIndex">extractVesselsFromGameIndex</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~filterAssignedPorts">filterAssignedPorts</a></li></ul></li><li><a href="module-harbor-map-calculator.html">harbor-map-calculator</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateCargoUtilization">calculateCargoUtilization</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateDemandLevel">calculateDemandLevel</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateETA">calculateETA</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateVesselPosition">calculateVesselPosition</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~formatCargoCapacity">formatCargoCapacity</a></li></ul></li><li><a href="module-harbor-map-init.html">harbor-map-init</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-init.html#.closeHarborMap">closeHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.initHarborMap">initHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.openHarborMap">openHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.preloadHarborMapData">preloadHarborMapData</a></li><li data-type='method'><a href="module-harbor-map-init.html#.refreshHarborMapIfOpen">refreshHarborMapIfOpen</a></li><li data-type='method'><a href="module-harbor-map-init.html#.reloadMap">reloadMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.startHarborMapAutoUpdate">startHarborMapAutoUpdate</a></li><li data-type='method'><a href="module-harbor-map-init.html#.stopHarborMapAutoUpdate">stopHarborMapAutoUpdate</a></li><li data-type='method'><a href="module-harbor-map-init.html#~departVesselWrapper">departVesselWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~getVesselByIdWrapper">getVesselByIdWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~selectVesselFromMap">selectVesselFromMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#~sellVesselFromPanelWrapper">sellVesselFromPanelWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~updateVesselMarkerWrapper">updateVesselMarkerWrapper</a></li></ul></li><li><a href="module-harbor-map_api-client.html">harbor-map/api-client</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_api-client.html#.clearHarborMapCache">clearHarborMapCache</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.exportVesselHistory">exportVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchHarborMapOverview">fetchHarborMapOverview</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchPortDetails">fetchPortDetails</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchVesselHistory">fetchVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchVesselReachablePorts">fetchVesselReachablePorts</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.getCachedOverview">getCachedOverview</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.invalidateOverviewCache">invalidateOverviewCache</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.prefetchHarborMapData">prefetchHarborMapData</a></li></ul></li><li><a href="module-harbor-map_filters.html">harbor-map/filters</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_filters.html#.filterPorts">filterPorts</a></li><li data-type='method'><a href="module-harbor-map_filters.html#.filterVessels">filterVessels</a></li><li data-type='method'><a href="module-harbor-map_filters.html#.getPortFilterOptions">getPortFilterOptions</a></li><li data-type='method'><a href="module-harbor-map_filters.html#.getVesselFilterOptions">getVesselFilterOptions</a></li><li data-type='method'><a href="module-harbor-map_filters.html#~calculateVesselUtilization">calculateVesselUtilization</a></li></ul></li><li><a href="module-harbor-map_map-controller.html">harbor-map/map-controller</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_map-controller.html#.clearRoute">clearRoute</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.closeAllPanels">closeAllPanels</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.deselectAll">deselectAll</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.drawRoute">drawRoute</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getCurrentPorts">getCurrentPorts</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getMap">getMap</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getSelectedPortCode">getSelectedPortCode</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getVesselById">getVesselById</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.initMap">initMap</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.loadOverview">loadOverview</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.renderPorts">renderPorts</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.renderVessels">renderVessels</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.selectPort">selectPort</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.selectVessel">selectVessel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.setPortFilter">setPortFilter</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.setRouteFilter">setRouteFilter</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.setVesselFilter">setVesselFilter</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.updateVesselMarker">updateVesselMarker</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.updateWeatherDataSetting">updateWeatherDataSetting</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~addCustomControls">addCustomControls</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~applyFiltersAndRender">applyFiltersAndRender</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~applyMapTheme">applyMapTheme</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~calculateHeading">calculateHeading</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~categorizeVesselsByPortClientSide">categorizeVesselsByPortClientSide</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~changeTileLayer">changeTileLayer</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~createVesselIcon">createVesselIcon</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~getVesselType">getVesselType</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~hideRouteVesselsPanel">hideRouteVesselsPanel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~showRouteVesselsPanel">showRouteVesselsPanel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~showWeatherInfo">showWeatherInfo</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~toggleWeatherLayer">toggleWeatherLayer</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~updateRouteDropdown">updateRouteDropdown</a></li></ul></li><li><a href="module-harbor-map_panel-drag.html">harbor-map/panel-drag</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_panel-drag.html#.initializePanelDrag">initializePanelDrag</a></li></ul></li><li><a href="module-harbor-map_port-panel.html">harbor-map/port-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_port-panel.html#.closePortPanel">closePortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.hidePortPanel">hidePortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.selectVesselFromPort">selectVesselFromPort</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.showPortPanel">showPortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#~loadPortWeather">loadPortWeather</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#~renderDemandSection">renderDemandSection</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#~renderVesselList">renderVesselList</a></li></ul></li><li><a href="module-harbor-map_route-vessels-panel.html">harbor-map/route-vessels-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.closeRoutePanel">closeRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.hideRoutePanel">hideRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.selectRouteVessel">selectRouteVessel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.showRoutePanel">showRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#~storeVessels">storeVessels</a></li></ul></li><li><a href="module-harbor-map_vessel-panel.html">harbor-map/vessel-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.closeVesselPanel">closeVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.exportHistoryFormat">exportHistoryFormat</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.hideVesselPanel">hideVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.sellVesselFromPanel">sellVesselFromPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.showVesselPanel">showVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.startRenameVessel">startRenameVessel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.toggleExportMenu">toggleExportMenu</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~cancelVesselRename">cancelVesselRename</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~closeExportMenuOnClickOutside">closeExportMenuOnClickOutside</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~getCountryFlag">getCountryFlag</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~getPortCountryCode">getPortCountryCode</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~loadVesselHistory">loadVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~loadVesselWeather">loadVesselWeather</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~openRepairDialog">openRepairDialog</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~processDepartureQueue">processDepartureQueue</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~renderHistoryPage">renderHistoryPage</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~saveVesselRename">saveVesselRename</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~setupInfiniteScroll">setupInfiniteScroll</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~toggleParkVessel">toggleParkVessel</a></li></ul></li><li><a href="module-logbook.html">logbook</a><ul class='methods'><li data-type='method'><a href="module-logbook.html#.deleteAllLogsConfirmed">deleteAllLogsConfirmed</a></li><li data-type='method'><a href="module-logbook.html#.getLogFileSize">getLogFileSize</a></li><li data-type='method'><a href="module-logbook.html#.initLogbook">initLogbook</a></li><li data-type='method'><a href="module-logbook.html#.prependLogEntry">prependLogEntry</a></li><li data-type='method'><a href="module-logbook.html#~convertActionFilterToBackend">convertActionFilterToBackend</a></li><li data-type='method'><a href="module-logbook.html#~exportLogs">exportLogs</a></li><li data-type='method'><a href="module-logbook.html#~formatDetails">formatDetails</a></li><li data-type='method'><a href="module-logbook.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-logbook.html#~getTransactionType">getTransactionType</a></li><li data-type='method'><a href="module-logbook.html#~loadLogs">loadLogs</a></li><li data-type='method'><a href="module-logbook.html#~renderLogTable">renderLogTable</a></li><li data-type='method'><a href="module-logbook.html#~updateActionFilter">updateActionFilter</a></li></ul></li><li><a href="module-map-icon-bar.html">map-icon-bar</a><ul class='methods'><li data-type='method'><a href="module-map-icon-bar.html#.initializeMapIconBar">initializeMapIconBar</a></li><li data-type='method'><a href="module-map-icon-bar.html#~handleIconAction">handleIconAction</a></li></ul></li><li><a href="module-messenger.html">messenger</a><ul class='methods'><li data-type='method'><a href="module-messenger.html#.closeAllChats">closeAllChats</a></li><li data-type='method'><a href="module-messenger.html#.closeChatSelection">closeChatSelection</a></li><li data-type='method'><a href="module-messenger.html#.openMessenger">openMessenger</a></li><li data-type='method'><a href="module-messenger.html#.openNewChat">openNewChat</a></li><li data-type='method'><a href="module-messenger.html#.showAllChats">showAllChats</a></li><li data-type='method'><a href="module-messenger.html#.updateUnreadBadge">updateUnreadBadge</a></li><li data-type='method'><a href="module-messenger.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-messenger.html#~loadPrivateMessages">loadPrivateMessages</a></li><li data-type='method'><a href="module-messenger.html#~stopHijackingPolling">stopHijackingPolling</a></li></ul></li><li><a href="module-public_js_modules_hijacking.html">public/js/modules/hijacking</a><ul class='methods'><li data-type='method'><a href="module-public_js_modules_hijacking.html#.closeHijackingInbox">closeHijackingInbox</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.openHijackingInbox">openHijackingInbox</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.updateHijackedVesselsDisplay">updateHijackedVesselsDisplay</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.updateHijackingBadge">updateHijackingBadge</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~deleteCase">deleteCase</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~openCaseDetails">openCaseDetails</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~refreshHijackingBadge">refreshHijackingBadge</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~renderCaseList">renderCaseList</a></li></ul></li><li><a href="module-server_automation.html">server/automation</a><ul class='methods'><li data-type='method'><a href="module-server_automation.html#~getRandomInterval">getRandomInterval</a></li><li data-type='method'><a href="module-server_automation.html#~initialize">initialize</a></li><li data-type='method'><a href="module-server_automation.html#~loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_automation.html#~parseInterval">parseInterval</a></li><li data-type='method'><a href="module-server_automation.html#~restartAutoRepair">restartAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~runAutoRepair">runAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~scheduleAutoRepair">scheduleAutoRepair</a></li></ul></li><li><a href="module-server_autopilot.html">server/autopilot</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot.html#~analyzeVesselDepartures">analyzeVesselDepartures</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoRebuyAll">autoRebuyAll</a></li><li data-type='method'><a href="module-server_autopilot.html#~checkPriceAlerts">checkPriceAlerts</a></li><li data-type='method'><a href="module-server_autopilot.html#~countActiveCampaignTypes">countActiveCampaignTypes</a></li><li data-type='method'><a href="module-server_autopilot.html#~initializeAutopilotState">initializeAutopilotState</a></li><li data-type='method'><a href="module-server_autopilot.html#~isAutopilotPaused">isAutopilotPaused</a></li><li data-type='method'><a href="module-server_autopilot.html#~mainEventLoop">mainEventLoop</a></li><li data-type='method'><a href="module-server_autopilot.html#~pauseAutopilot">pauseAutopilot</a></li><li data-type='method'><a href="module-server_autopilot.html#~resumeAutopilot">resumeAutopilot</a></li><li data-type='method'><a href="module-server_autopilot.html#~setBroadcastFunction">setBroadcastFunction</a></li><li data-type='method'><a href="module-server_autopilot.html#~startMainEventLoop">startMainEventLoop</a></li><li data-type='method'><a href="module-server_autopilot.html#~tryUpdateAllData">tryUpdateAllData</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateAllData">updateAllData</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateCampaigns">updateCampaigns</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateDrydockCount">updateDrydockCount</a></li><li data-type='method'><a href="module-server_autopilot.html#~updatePrices">updatePrices</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateRepairCount">updateRepairCount</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateUnreadMessages">updateUnreadMessages</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateVesselCount">updateVesselCount</a></li></ul></li><li><a href="module-server_autopilot_pilot_atmosphere_broker.html">server/autopilot/pilot_atmosphere_broker</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_atmosphere_broker.html#~autoRebuyCO2">autoRebuyCO2</a></li></ul></li><li><a href="module-server_autopilot_pilot_barrel_boss.html">server/autopilot/pilot_barrel_boss</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_barrel_boss.html#~autoRebuyFuel">autoRebuyFuel</a></li></ul></li><li><a href="module-server_autopilot_pilot_captain_blackbeard.html">server/autopilot/pilot_captain_blackbeard</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~acceptRansomWithRetry">acceptRansomWithRetry</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~autoNegotiateHijacking">autoNegotiateHijacking</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~getCaseWithRetry">getCaseWithRetry</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~processHijackingCase">processHijackingCase</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~submitOfferWithRetry">submitOfferWithRetry</a></li></ul></li><li><a href="module-server_autopilot_pilot_cargo_marshal.html">server/autopilot/pilot_cargo_marshal</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~autoDepartVessels">autoDepartVessels</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~departVessels">departVessels</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~getTotalCapacity">getTotalCapacity</a></li></ul></li><li><a href="module-server_autopilot_pilot_drydock_master.html">server/autopilot/pilot_drydock_master</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_drydock_master.html#~autoDrydockVessels">autoDrydockVessels</a></li></ul></li><li><a href="module-server_autopilot_pilot_fair_hand.html">server/autopilot/pilot_fair_hand</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_fair_hand.html#~autoCoop">autoCoop</a></li></ul></li><li><a href="module-server_autopilot_pilot_harbormaster.html">server/autopilot/pilot_harbormaster</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_harbormaster.html#~autoAnchorPointPurchase">autoAnchorPointPurchase</a></li><li data-type='method'><a href="module-server_autopilot_pilot_harbormaster.html#~setBroadcastFunction">setBroadcastFunction</a></li></ul></li><li><a href="module-server_autopilot_pilot_reputation_chief.html">server/autopilot/pilot_reputation_chief</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_reputation_chief.html#~autoCampaignRenewal">autoCampaignRenewal</a></li></ul></li><li><a href="module-server_autopilot_pilot_yard_foreman.html">server/autopilot/pilot_yard_foreman</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_yard_foreman.html#~autoRepairVessels">autoRepairVessels</a></li></ul></li><li><a href="module-server_cache.html">server/cache</a><ul class='methods'><li data-type='method'><a href="module-server_cache.html#~clearAllCaches">clearAllCaches</a></li><li data-type='method'><a href="module-server_cache.html#~getAllianceCache">getAllianceCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCampaignCache">getCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCompanyCache">getCompanyCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCoopCache">getCoopCache</a></li><li data-type='method'><a href="module-server_cache.html#~invalidateCampaignCache">invalidateCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~invalidateCoopCache">invalidateCoopCache</a></li><li data-type='method'><a href="module-server_cache.html#~isCacheValid">isCacheValid</a></li><li data-type='method'><a href="module-server_cache.html#~setAllianceCache">setAllianceCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCampaignCache">setCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCompanyCache">setCompanyCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCoopCache">setCoopCache</a></li></ul></li><li><a href="module-server_certificate.html">server/certificate</a><ul class='methods'><li data-type='method'><a href="module-server_certificate.html#~createHttpsServer">createHttpsServer</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCA">generateCA</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCertificate">generateCertificate</a></li><li data-type='method'><a href="module-server_certificate.html#~getNetworkIPs">getNetworkIPs</a></li><li data-type='method'><a href="module-server_certificate.html#~isCertificateInstalled">isCertificateInstalled</a></li><li data-type='method'><a href="module-server_certificate.html#~loadCertificate">loadCertificate</a></li></ul></li><li><a href="module-server_chatbot.html">server/chatbot</a></li><li><a href="module-server_chatbot_commands.html">server/chatbot/commands</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_commands.html#~generateForecastText">generateForecastText</a></li><li data-type='method'><a href="module-server_chatbot_commands.html#~handleForecastCommand">handleForecastCommand</a></li><li data-type='method'><a href="module-server_chatbot_commands.html#~handleHelpCommand">handleHelpCommand</a></li><li data-type='method'><a href="module-server_chatbot_commands.html#~handleWelcomeCommand">handleWelcomeCommand</a></li></ul></li><li><a href="module-server_chatbot_executor.html">server/chatbot/executor</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_executor.html#~executeCommand">executeCommand</a></li></ul></li><li><a href="module-server_chatbot_parser.html">server/chatbot/parser</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_parser.html#~findCustomCommand">findCustomCommand</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~hasManagementRole">hasManagementRole</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~isCommandAllowedInChannel">isCommandAllowedInChannel</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~isOnCooldown">isOnCooldown</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~processAllianceMessage">processAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~processPrivateMessage">processPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~resolveCommandName">resolveCommandName</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~updateCooldown">updateCooldown</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~validateCommandArguments">validateCommandArguments</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~validateForecastArguments">validateForecastArguments</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~validateWelcomeArguments">validateWelcomeArguments</a></li></ul></li><li><a href="module-server_chatbot_scheduler.html">server/chatbot/scheduler</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_scheduler.html#~scheduleDailyForecast">scheduleDailyForecast</a></li><li data-type='method'><a href="module-server_chatbot_scheduler.html#~sendDailyForecast">sendDailyForecast</a></li><li data-type='method'><a href="module-server_chatbot_scheduler.html#~setupScheduledTasks">setupScheduledTasks</a></li></ul></li><li><a href="module-server_chatbot_sender.html">server/chatbot/sender</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_sender.html#~sendAllianceMessage">sendAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot_sender.html#~sendErrorMessage">sendErrorMessage</a></li><li data-type='method'><a href="module-server_chatbot_sender.html#~sendPrivateMessage">sendPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot_sender.html#~sendResponse">sendResponse</a></li></ul></li><li><a href="module-server_chatbot_settings.html">server/chatbot/settings</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_settings.html#~getDefaultChatBotObject">getDefaultChatBotObject</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~hasManagementRole">hasManagementRole</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~mapChatBotObjectToFlatSettings">mapChatBotObjectToFlatSettings</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~mapSettingsToChatBotObject">mapSettingsToChatBotObject</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~updateSettings">updateSettings</a></li></ul></li><li><a href="module-server_config.html">server/config</a><ul class='methods'><li data-type='method'><a href="module-server_config.html#~getAppDataDir">getAppDataDir</a></li><li data-type='method'><a href="module-server_config.html#~getAppPlatformCookie">getAppPlatformCookie</a></li><li data-type='method'><a href="module-server_config.html#~getAppVersionCookie">getAppVersionCookie</a></li><li data-type='method'><a href="module-server_config.html#~getLocalAppDataDir">getLocalAppDataDir</a></li><li data-type='method'><a href="module-server_config.html#~getLogDir">getLogDir</a></li><li data-type='method'><a href="module-server_config.html#~getSessionCookie">getSessionCookie</a></li><li data-type='method'><a href="module-server_config.html#~getSettingsDir">getSettingsDir</a></li><li data-type='method'><a href="module-server_config.html#~loadStartupSettings">loadStartupSettings</a></li><li data-type='method'><a href="module-server_config.html#~setSessionCookie">setSessionCookie</a></li></ul></li><li><a href="module-server_gameapi.html">server/gameapi</a></li><li><a href="module-server_gameapi_bunker.html">server/gameapi/bunker</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi_bunker.html#~fetchBunkerState">fetchBunkerState</a></li><li data-type='method'><a href="module-server_gameapi_bunker.html#~fetchPrices">fetchPrices</a></li><li data-type='method'><a href="module-server_gameapi_bunker.html#~purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-server_gameapi_bunker.html#~purchaseFuel">purchaseFuel</a></li></ul></li><li><a href="module-server_gameapi_campaign.html">server/gameapi/campaign</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi_campaign.html#~activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-server_gameapi_campaign.html#~fetchCampaigns">fetchCampaigns</a></li></ul></li><li><a href="module-server_gameapi_maintenance.html">server/gameapi/maintenance</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi_maintenance.html#~bulkRepairVessels">bulkRepairVessels</a></li><li data-type='method'><a href="module-server_gameapi_maintenance.html#~fetchRepairCount">fetchRepairCount</a></li><li data-type='method'><a href="module-server_gameapi_maintenance.html#~getMaintenanceCost">getMaintenanceCost</a></li></ul></li><li><a href="module-server_gameapi_port.html">server/gameapi/port</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi_port.html#~fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-server_gameapi_port.html#~fetchAutoPrice">fetchAutoPrice</a></li><li data-type='method'><a href="module-server_gameapi_port.html#~getAssignedPorts">getAssignedPorts</a></li><li data-type='method'><a href="module-server_gameapi_port.html#~getRoutesByPorts">getRoutesByPorts</a></li><li data-type='method'><a href="module-server_gameapi_port.html#~getVesselPorts">getVesselPorts</a></li></ul></li><li><a href="module-server_gameapi_util.html">server/gameapi/util</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi_util.html#~fetchEventData">fetchEventData</a></li><li data-type='method'><a href="module-server_gameapi_util.html#~fetchUnreadMessages">fetchUnreadMessages</a></li><li data-type='method'><a href="module-server_gameapi_util.html#~getGameIndex">getGameIndex</a></li></ul></li><li><a href="module-server_gameapi_vessel.html">server/gameapi/vessel</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi_vessel.html#~departVessel">departVessel</a></li><li data-type='method'><a href="module-server_gameapi_vessel.html#~fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-server_gameapi_vessel.html#~getAllUserVessels">getAllUserVessels</a></li><li data-type='method'><a href="module-server_gameapi_vessel.html#~getVesselHistory">getVesselHistory</a></li></ul></li><li><a href="module-server_middleware_index.html">server/middleware/index</a><ul class='methods'><li data-type='method'><a href="module-server_middleware_index.html#~setupMiddleware">setupMiddleware</a></li></ul></li><li><a href="module-server_routes_alliance.html">server/routes/alliance</a><ul class='methods'><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-high-scores">GET /api/alliance-high-scores</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-info">GET /api/alliance-info</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-info/:id">GET /api/alliance-info/:id</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-members">GET /api/alliance-members</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-members/:id">GET /api/alliance-members/:id</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-settings">GET /api/alliance-settings</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/chat">GET /api/chat</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/league-info">GET /api/league-info</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/alliance-accept-user">POST /api/alliance-accept-user</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/alliance-decline-user">POST /api/alliance-decline-user</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/alliance-leave">POST /api/alliance-leave</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/alliance-queue-pool">POST /api/alliance-queue-pool</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/alliance-update-user-role">POST /api/alliance-update-user-role</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/chat/mark-read">POST /api/chat/mark-read</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/company-name">POST /api/company-name</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/send-message">POST /api/send-message</a></li></ul></li><li><a href="module-server_routes_alliance-logo.html">server/routes/alliance-logo</a></li><li><a href="module-server_routes_alliances.html">server/routes/alliances</a></li><li><a href="module-server_routes_anchor.html">server/routes/anchor</a></li><li><a href="module-server_routes_coop.html">server/routes/coop</a><ul class='methods'><li data-type='method'><a href="module-server_routes_coop.html#.GET/api/coop/data">GET /api/coop/data</a></li><li data-type='method'><a href="module-server_routes_coop.html#.POST/api/coop/send-max">POST /api/coop/send-max</a></li></ul></li><li><a href="module-server_routes_forecast.html">server/routes/forecast</a><ul class='methods'><li data-type='method'><a href="module-server_routes_forecast.html#~convertCESTToTimezone">convertCESTToTimezone</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~generateChatbotText">generateChatbotText</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~generateMetadata">generateMetadata</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getForecastDataPath">getForecastDataPath</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getNextDayData">getNextDayData</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getPreviousDayData">getPreviousDayData</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getServerLocalTimezone">getServerLocalTimezone</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getTimezoneOffsetHours">getTimezoneOffsetHours</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getValidTimezones">getValidTimezones</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~parseNumericOffset">parseNumericOffset</a></li></ul></li><li><a href="module-server_routes_game.html">server/routes/game</a></li><li><a href="module-server_routes_game_autopilot.html">server/routes/game/autopilot</a></li><li><a href="module-server_routes_game_bunker.html">server/routes/game/bunker</a></li><li><a href="module-server_routes_game_depart.html">server/routes/game/depart</a></li><li><a href="module-server_routes_game_maintenance.html">server/routes/game/maintenance</a></li><li><a href="module-server_routes_game_marketing.html">server/routes/game/marketing</a></li><li><a href="module-server_routes_game_user.html">server/routes/game/user</a><ul class='methods'><li data-type='method'><a href="module-server_routes_game_user.html#~compareVersions">compareVersions</a></li></ul></li><li><a href="module-server_routes_game_vessel.html">server/routes/game/vessel</a></li><li><a href="module-server_routes_harbor-map.html">server/routes/harbor-map</a><ul class='methods'><li data-type='method'><a href="module-server_routes_harbor-map.html#~escapeCSVFormula">escapeCSVFormula</a></li><li data-type='method'><a href="module-server_routes_harbor-map.html#~formatHistoryAsTXT">formatHistoryAsTXT</a></li><li data-type='method'><a href="module-server_routes_harbor-map.html#~getGameIndexCached">getGameIndexCached</a></li></ul></li><li><a href="module-server_routes_health.html">server/routes/health</a></li><li><a href="module-server_routes_messenger.html">server/routes/messenger</a><ul class='methods'><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/contact/get-contacts">GET /api/contact/get-contacts</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/hijacking/get-cases">GET /api/hijacking/get-cases</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/messenger/get-chats">GET /api/messenger/get-chats</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/delete-chat">POST /api/messenger/delete-chat</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/get-messages">POST /api/messenger/get-messages</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/send-private">POST /api/messenger/send-private</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/user/search">POST /api/user/search</a></li><li data-type='method'><a href="module-server_routes_messenger.html#~ensureHijackHistoryDir">ensureHijackHistoryDir</a></li></ul></li><li><a href="module-server_routes_poi.html">server/routes/poi</a><ul class='methods'><li data-type='method'><a href="module-server_routes_poi.html#~ensureCacheDir">ensureCacheDir</a></li><li data-type='method'><a href="module-server_routes_poi.html#~fetchAllMuseumsFromAPI">fetchAllMuseumsFromAPI</a></li><li data-type='method'><a href="module-server_routes_poi.html#~fetchAllWrecksFromAPI">fetchAllWrecksFromAPI</a></li><li data-type='method'><a href="module-server_routes_poi.html#~filterPOIsByBbox">filterPOIsByBbox</a></li><li data-type='method'><a href="module-server_routes_poi.html#~initializePOICache">initializePOICache</a></li><li data-type='method'><a href="module-server_routes_poi.html#~isCacheValid">isCacheValid</a></li><li data-type='method'><a href="module-server_routes_poi.html#~loadFromCache">loadFromCache</a></li><li data-type='method'><a href="module-server_routes_poi.html#~reduceWreckData">reduceWreckData</a></li><li data-type='method'><a href="module-server_routes_poi.html#~saveToCache">saveToCache</a></li><li data-type='method'><a href="module-server_routes_poi.html#~startAutomaticCacheRefresh">startAutomaticCacheRefresh</a></li></ul></li><li><a href="module-server_routes_settings.html">server/routes/settings</a><ul class='methods'><li data-type='method'><a href="module-server_routes_settings.html#.GET/api/settings">GET /api/settings</a></li><li data-type='method'><a href="module-server_routes_settings.html#.POST/api/settings">POST /api/settings</a></li></ul></li><li><a href="module-server_routes_staff.html">server/routes/staff</a></li><li><a href="module-server_routes_vessel-image.html">server/routes/vessel-image</a></li><li><a href="module-server_scheduler.html">server/scheduler</a><ul class='methods'><li data-type='method'><a href="module-server_scheduler.html#~initScheduler">initScheduler</a></li><li data-type='method'><a href="module-server_scheduler.html#~isServerReady">isServerReady</a></li></ul></li><li><a href="module-server_services_alliance-indexer.html">server/services/alliance-indexer</a></li><li><a href="module-server_settings-schema.html">server/settings-schema</a><ul class='methods'><li data-type='method'><a href="module-server_settings-schema.html#~getDefault">getDefault</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getDefaults">getDefaults</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getRequiredKeys">getRequiredKeys</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getSettingsFilePath">getSettingsFilePath</a></li><li data-type='method'><a href="module-server_settings-schema.html#~initializeSettings">initializeSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~saveSettings">saveSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~validateSettings">validateSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~validateValue">validateValue</a></li></ul></li><li><a href="module-server_state.html">server/state</a><ul class='methods'><li data-type='method'><a href="module-server_state.html#~getAllLocks">getAllLocks</a></li><li data-type='method'><a href="module-server_state.html#~getAutopilotState">getAutopilotState</a></li><li data-type='method'><a href="module-server_state.html#~getBunkerState">getBunkerState</a></li><li data-type='method'><a href="module-server_state.html#~getCampaignStatus">getCampaignStatus</a></li><li data-type='method'><a href="module-server_state.html#~getCoopData">getCoopData</a></li><li data-type='method'><a href="module-server_state.html#~getDrydockCount">getDrydockCount</a></li><li data-type='method'><a href="module-server_state.html#~getEventData">getEventData</a></li><li data-type='method'><a href="module-server_state.html#~getHeaderData">getHeaderData</a></li><li data-type='method'><a href="module-server_state.html#~getLastCO2Alert">getLastCO2Alert</a></li><li data-type='method'><a href="module-server_state.html#~getLastFuelAlert">getLastFuelAlert</a></li><li data-type='method'><a href="module-server_state.html#~getLockStatus">getLockStatus</a></li><li data-type='method'><a href="module-server_state.html#~getPrices">getPrices</a></li><li data-type='method'><a href="module-server_state.html#~getRepairCount">getRepairCount</a></li><li data-type='method'><a href="module-server_state.html#~getSettings">getSettings</a></li><li data-type='method'><a href="module-server_state.html#~getUserState">getUserState</a></li><li data-type='method'><a href="module-server_state.html#~getVesselCounts">getVesselCounts</a></li><li data-type='method'><a href="module-server_state.html#~isAutopilotPaused">isAutopilotPaused</a></li><li data-type='method'><a href="module-server_state.html#~setAutopilotPaused">setAutopilotPaused</a></li><li data-type='method'><a href="module-server_state.html#~setAutopilotState">setAutopilotState</a></li><li data-type='method'><a href="module-server_state.html#~setLastCO2Alert">setLastCO2Alert</a></li><li data-type='method'><a href="module-server_state.html#~setLastFuelAlert">setLastFuelAlert</a></li><li data-type='method'><a href="module-server_state.html#~setLockStatus">setLockStatus</a></li><li data-type='method'><a href="module-server_state.html#~updateBunkerState">updateBunkerState</a></li><li data-type='method'><a href="module-server_state.html#~updateCampaignStatus">updateCampaignStatus</a></li><li data-type='method'><a href="module-server_state.html#~updateCoopData">updateCoopData</a></li><li data-type='method'><a href="module-server_state.html#~updateDrydockCount">updateDrydockCount</a></li><li data-type='method'><a href="module-server_state.html#~updateEventData">updateEventData</a></li><li data-type='method'><a href="module-server_state.html#~updateHeaderData">updateHeaderData</a></li><li data-type='method'><a href="module-server_state.html#~updatePrices">updatePrices</a></li><li data-type='method'><a href="module-server_state.html#~updateRepairCount">updateRepairCount</a></li><li data-type='method'><a href="module-server_state.html#~updateSettings">updateSettings</a></li><li data-type='method'><a href="module-server_state.html#~updateVesselCounts">updateVesselCounts</a></li></ul></li><li><a href="module-server_utils_api.html">server/utils/api</a><ul class='methods'><li data-type='method'><a href="module-server_utils_api.html#~apiCall">apiCall</a></li><li data-type='method'><a href="module-server_utils_api.html#~apiCallWithRetry">apiCallWithRetry</a></li><li data-type='method'><a href="module-server_utils_api.html#~checkAndUpdateAllianceId">checkAndUpdateAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~getAllianceId">getAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~getAllianceName">getAllianceName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getChatFeed">getChatFeed</a></li><li data-type='method'><a href="module-server_utils_api.html#~getCompanyName">getCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserCompanyName">getUserCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserId">getUserId</a></li><li data-type='method'><a href="module-server_utils_api.html#~initializeAlliance">initializeAlliance</a></li><li data-type='method'><a href="module-server_utils_api.html#~setAllianceId">setAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~sleep">sleep</a></li></ul></li><li><a href="module-server_utils_audit-logger.html">server/utils/audit-logger</a><ul class='methods'><li data-type='method'><a href="module-server_utils_audit-logger.html#~auditLog">auditLog</a></li><li data-type='method'><a href="module-server_utils_audit-logger.html#~formatCurrency">formatCurrency</a></li><li data-type='method'><a href="module-server_utils_audit-logger.html#~formatNumber">formatNumber</a></li></ul></li><li><a href="module-server_utils_contribution-store.html">server/utils/contribution-store</a><ul class='methods'><li data-type='method'><a href="module-server_utils_contribution-store.html#~enrichHistoryWithContributions">enrichHistoryWithContributions</a></li><li data-type='method'><a href="module-server_utils_contribution-store.html#~ensureDirectory">ensureDirectory</a></li><li data-type='method'><a href="module-server_utils_contribution-store.html#~getContributionGain">getContributionGain</a></li><li data-type='method'><a href="module-server_utils_contribution-store.html#~getFilePath">getFilePath</a></li><li data-type='method'><a href="module-server_utils_contribution-store.html#~loadContributionGains">loadContributionGains</a></li><li data-type='method'><a href="module-server_utils_contribution-store.html#~saveContributionGain">saveContributionGain</a></li></ul></li><li><a href="module-server_utils_encryption.html">server/utils/encryption</a><ul class='methods'><li data-type='method'><a href="module-server_utils_encryption.html#~decryptData">decryptData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~deleteEncryptedData">deleteEncryptedData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~encryptData">encryptData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~getEncryptionInfo">getEncryptionInfo</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~getMachineKey">getMachineKey</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~isEncrypted">isEncrypted</a></li></ul></li><li><a href="module-server_utils_harbor-fee-store.html">server/utils/harbor-fee-store</a><ul class='methods'><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~enrichHistoryWithFees">enrichHistoryWithFees</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~ensureDirectory">ensureDirectory</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~getFilePath">getFilePath</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~getHarborFee">getHarborFee</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~isMigrationCompleted">isMigrationCompleted</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~loadHarborFees">loadHarborFees</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~markMigrationCompleted">markMigrationCompleted</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~saveHarborFee">saveHarborFee</a></li></ul></li><li><a href="module-server_utils_logger.html">server/utils/logger</a><ul class='methods'><li data-type='method'><a href="module-server_utils_logger.html#~debug">debug</a></li><li data-type='method'><a href="module-server_utils_logger.html#~error">error</a></li><li data-type='method'><a href="module-server_utils_logger.html#~info">info</a></li><li data-type='method'><a href="module-server_utils_logger.html#~isDebugMode">isDebugMode</a></li><li data-type='method'><a href="module-server_utils_logger.html#~loadLogLevel">loadLogLevel</a></li><li data-type='method'><a href="module-server_utils_logger.html#~warn">warn</a></li></ul></li><li><a href="module-server_utils_migrate-harbor-fees.html">server/utils/migrate-harbor-fees</a><ul class='methods'><li data-type='method'><a href="module-server_utils_migrate-harbor-fees.html#~migrateAllHarborFees">migrateAllHarborFees</a></li><li data-type='method'><a href="module-server_utils_migrate-harbor-fees.html#~migrateHarborFeesForUser">migrateHarborFeesForUser</a></li><li data-type='method'><a href="module-server_utils_migrate-harbor-fees.html#~resolveVesselNameToId">resolveVesselNameToId</a></li><li data-type='method'><a href="module-server_utils_migrate-harbor-fees.html#~timestampToMySQLDatetime">timestampToMySQLDatetime</a></li></ul></li><li><a href="module-server_utils_read-tracker.html">server/utils/read-tracker</a><ul class='methods'><li data-type='method'><a href="module-server_utils_read-tracker.html#~ensureReadTrackingFile">ensureReadTrackingFile</a></li><li data-type='method'><a href="module-server_utils_read-tracker.html#~getLastReadTimestamp">getLastReadTimestamp</a></li><li data-type='method'><a href="module-server_utils_read-tracker.html#~saveReadTrackingFile">saveReadTrackingFile</a></li><li data-type='method'><a href="module-server_utils_read-tracker.html#~updateLastReadTimestamp">updateLastReadTimestamp</a></li></ul></li><li><a href="module-server_utils_session-manager.html">server/utils/session-manager</a><ul class='methods'><li data-type='method'><a href="module-server_utils_session-manager.html#~deleteSession">deleteSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getAllUserIds">getAllUserIds</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getAvailableSessions">getAvailableSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getSession">getSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getSessionsPath">getSessionsPath</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~hasSession">hasSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~loadAllSessions">loadAllSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~loadSessions">loadSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~migrateToEncrypted">migrateToEncrypted</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~saveSession">saveSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~saveSessions">saveSessions</a></li></ul></li><li><a href="module-server_websocket.html">server/websocket</a><ul class='methods'><li data-type='method'><a href="module-server_websocket.html#~initWebSocket">initWebSocket</a></li></ul></li><li><a href="module-server_websocket_broadcaster.html">server/websocket/broadcaster</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_broadcaster.html#~broadcast">broadcast</a></li><li data-type='method'><a href="module-server_websocket_broadcaster.html#~broadcastBunkerUpdate">broadcastBunkerUpdate</a></li><li data-type='method'><a href="module-server_websocket_broadcaster.html#~broadcastHarborMapRefresh">broadcastHarborMapRefresh</a></li><li data-type='method'><a href="module-server_websocket_broadcaster.html#~broadcastToUser">broadcastToUser</a></li><li data-type='method'><a href="module-server_websocket_broadcaster.html#~getWebSocketServer">getWebSocketServer</a></li><li data-type='method'><a href="module-server_websocket_broadcaster.html#~setWebSocketServer">setWebSocketServer</a></li></ul></li><li><a href="module-server_websocket_chat-refresh.html">server/websocket/chat-refresh</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_chat-refresh.html#~performChatRefresh">performChatRefresh</a></li><li data-type='method'><a href="module-server_websocket_chat-refresh.html#~setMessengerRefreshFn">setMessengerRefreshFn</a></li><li data-type='method'><a href="module-server_websocket_chat-refresh.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket_chat-refresh.html#~stopChatAutoRefresh">stopChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket_chat-refresh.html#~triggerImmediateChatRefresh">triggerImmediateChatRefresh</a></li></ul></li><li><a href="module-server_websocket_hijacking-cache.html">server/websocket/hijacking-cache</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_hijacking-cache.html#~getCachedHijackingCase">getCachedHijackingCase</a></li><li data-type='method'><a href="module-server_websocket_hijacking-cache.html#~invalidateHijackingCase">invalidateHijackingCase</a></li></ul></li><li><a href="module-server_websocket_hijacking-refresh.html">server/websocket/hijacking-refresh</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_hijacking-refresh.html#~performHijackingRefresh">performHijackingRefresh</a></li><li data-type='method'><a href="module-server_websocket_hijacking-refresh.html#~startHijackingAutoRefresh">startHijackingAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket_hijacking-refresh.html#~stopHijackingAutoRefresh">stopHijackingAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket_hijacking-refresh.html#~triggerImmediateHijackingRefresh">triggerImmediateHijackingRefresh</a></li></ul></li><li><a href="module-server_websocket_message-cache.html">server/websocket/message-cache</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_message-cache.html#~getProcessedMessageIds">getProcessedMessageIds</a></li><li data-type='method'><a href="module-server_websocket_message-cache.html#~getProcessedMessagesCachePath">getProcessedMessagesCachePath</a></li><li data-type='method'><a href="module-server_websocket_message-cache.html#~loadProcessedMessageCache">loadProcessedMessageCache</a></li><li data-type='method'><a href="module-server_websocket_message-cache.html#~saveProcessedMessageCache">saveProcessedMessageCache</a></li></ul></li><li><a href="module-server_websocket_messenger-cache.html">server/websocket/messenger-cache</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_messenger-cache.html#~getCachedMessengerChats">getCachedMessengerChats</a></li></ul></li><li><a href="module-server_websocket_messenger-refresh.html">server/websocket/messenger-refresh</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_messenger-refresh.html#~performMessengerRefresh">performMessengerRefresh</a></li><li data-type='method'><a href="module-server_websocket_messenger-refresh.html#~startMessengerAutoRefresh">startMessengerAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket_messenger-refresh.html#~stopMessengerAutoRefresh">stopMessengerAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket_messenger-refresh.html#~triggerImmediateMessengerRefresh">triggerImmediateMessengerRefresh</a></li></ul></li><li><a href="module-ui-dialogs.html">ui-dialogs</a><ul class='methods'><li data-type='method'><a href="module-ui-dialogs.html#.buyCampaign">buyCampaign</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeCampaignsOverlay">closeCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeSettings">closeSettings</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showCampaignsOverlay">showCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showConfirmDialog">showConfirmDialog</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showContactList">showContactList</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showSettings">showSettings</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#.escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-utils.html#.formatNumber">formatNumber</a></li><li data-type='method'><a href="module-utils.html#.getCO2PriceClass">getCO2PriceClass</a></li><li data-type='method'><a href="module-utils.html#.getFuelPriceClass">getFuelPriceClass</a></li><li data-type='method'><a href="module-utils.html#.isMobileDevice">isMobileDevice</a></li><li data-type='method'><a href="module-utils.html#.registerServiceWorker">registerServiceWorker</a></li><li data-type='method'><a href="module-utils.html#.renderStars">renderStars</a></li><li data-type='method'><a href="module-utils.html#.requestNotificationPermission">requestNotificationPermission</a></li><li data-type='method'><a href="module-utils.html#.showNotification">showNotification</a></li><li data-type='method'><a href="module-utils.html#.showSideNotification">showSideNotification</a></li></ul></li><li><a href="module-vessel-management.html">vessel-management</a><ul class='methods'><li data-type='method'><a href="module-vessel-management.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.openRepairAndDrydockDialog">openRepairAndDrydockDialog</a></li><li data-type='method'><a href="module-vessel-management.html#.purchaseSingleVessel">purchaseSingleVessel</a></li><li data-type='method'><a href="module-vessel-management.html#.updateLockStateFromServer">updateLockStateFromServer</a></li><li data-type='method'><a href="module-vessel-management.html#.updateVesselCount">updateVesselCount</a></li><li data-type='method'><a href="module-vessel-management.html#~createVesselCard">createVesselCard</a></li><li data-type='method'><a href="module-vessel-management.html#~displayFilteredVessels">displayFilteredVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~executeDrydock">executeDrydock</a></li><li data-type='method'><a href="module-vessel-management.html#~getAvailableAnchorSlots">getAvailableAnchorSlots</a></li><li data-type='method'><a href="module-vessel-management.html#~getCO2EfficiencyClass">getCO2EfficiencyClass</a></li><li data-type='method'><a href="module-vessel-management.html#~getCapacityDisplay">getCapacityDisplay</a></li><li data-type='method'><a href="module-vessel-management.html#~getFuelEfficiencyClass">getFuelEfficiencyClass</a></li><li data-type='method'><a href="module-vessel-management.html#~loadCartFromStorage">loadCartFromStorage</a></li><li data-type='method'><a href="module-vessel-management.html#~loadMorePendingVessels">loadMorePendingVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~loadMoreVessels">loadMoreVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~populateDynamicFilters">populateDynamicFilters</a></li><li data-type='method'><a href="module-vessel-management.html#~refreshVesselCardsIfVisible">refreshVesselCardsIfVisible</a></li><li data-type='method'><a href="module-vessel-management.html#~renderDrydockTab">renderDrydockTab</a></li><li data-type='method'><a href="module-vessel-management.html#~renderRepairTab">renderRepairTab</a></li><li data-type='method'><a href="module-vessel-management.html#~saveCartToStorage">saveCartToStorage</a></li><li data-type='method'><a href="module-vessel-management.html#~showRepairAndDrydockDialog">showRepairAndDrydockDialog</a></li><li data-type='method'><a href="module-vessel-management.html#~updateCapacityDropdowns">updateCapacityDropdowns</a></li><li data-type='method'><a href="module-vessel-management.html#~vesselPassesFilters">vesselPassesFilters</a></li></ul></li><li><a href="module-vessel-selling.html">vessel-selling</a><ul class='methods'><li data-type='method'><a href="module-vessel-selling.html#.bulkSellVessels">bulkSellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#.closeSellVesselsOverlay">closeSellVesselsOverlay</a></li><li data-type='method'><a href="module-vessel-selling.html#.openSellVesselsOverlay">openSellVesselsOverlay</a></li><li data-type='method'><a href="module-vessel-selling.html#.refreshVesselsForSale">refreshVesselsForSale</a></li><li data-type='method'><a href="module-vessel-selling.html#.setSellFilter">setSellFilter</a></li><li data-type='method'><a href="module-vessel-selling.html#.showSellCart">showSellCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~clearSellCartCache">clearSellCartCache</a></li><li data-type='method'><a href="module-vessel-selling.html#~displaySellVessels">displaySellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#~fetchAllSellPrices">fetchAllSellPrices</a></li><li data-type='method'><a href="module-vessel-selling.html#~getCO2EfficiencyClass">getCO2EfficiencyClass</a></li><li data-type='method'><a href="module-vessel-selling.html#~getCapacityDisplay">getCapacityDisplay</a></li><li data-type='method'><a href="module-vessel-selling.html#~getFuelEfficiencyClass">getFuelEfficiencyClass</a></li><li data-type='method'><a href="module-vessel-selling.html#~groupVesselsByModel">groupVesselsByModel</a></li><li data-type='method'><a href="module-vessel-selling.html#~loadSellCartFromCache">loadSellCartFromCache</a></li><li data-type='method'><a href="module-vessel-selling.html#~loadUserVesselsForSale">loadUserVesselsForSale</a></li><li data-type='method'><a href="module-vessel-selling.html#~removeVesselSelectionFromCart">removeVesselSelectionFromCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~saveSellCartToCache">saveSellCartToCache</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateBulkSellButton">updateBulkSellButton</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateSelectButtonState">updateSelectButtonState</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateVesselSelectionInCart">updateVesselSelectionInCart</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#buildNav">buildNav</a></li><li><a href="global.html#deleteAllLogs">deleteAllLogs</a></li><li><a href="global.html#escapeCSVFormula">escapeCSVFormula</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#flushAllToDisk">flushAllToDisk</a></li><li><a href="global.html#formatDetailsAsTXT">formatDetailsAsTXT</a></li><li><a href="global.html#formatFileSize">formatFileSize</a></li><li><a href="global.html#formatLogsAsCSV">formatLogsAsCSV</a></li><li><a href="global.html#formatLogsAsTXT">formatLogsAsTXT</a></li><li><a href="global.html#fs">fs</a></li><li><a href="global.html#getCategoryFromAction">getCategoryFromAction</a></li><li><a href="global.html#getLogEntries">getLogEntries</a></li><li><a href="global.html#getLogFilePath">getLogFilePath</a></li><li><a href="global.html#getLogFileSize">getLogFileSize</a></li><li><a href="global.html#getLogsFromCache">getLogsFromCache</a></li><li><a href="global.html#getSourceFromAction">getSourceFromAction</a></li><li><a href="global.html#getTransactionType">getTransactionType</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#isDepartInProgress">isDepartInProgress</a></li><li><a href="global.html#loadLogsFromDisk">loadLogsFromDisk</a></li><li><a href="global.html#lockBulkBuyButton">lockBulkBuyButton</a></li><li><a href="global.html#lockCo2Button">lockCo2Button</a></li><li><a href="global.html#lockCoopButtons">lockCoopButtons</a></li><li><a href="global.html#lockDepartButton">lockDepartButton</a></li><li><a href="global.html#lockDrydockButton">lockDrydockButton</a></li><li><a href="global.html#lockFuelButton">lockFuelButton</a></li><li><a href="global.html#lockRepairButton">lockRepairButton</a></li><li><a href="global.html#logAutopilotAction">logAutopilotAction</a></li><li><a href="global.html#publish">publish</a></li><li><a href="global.html#searchInObject">searchInObject</a></li><li><a href="global.html#showAnchorTimer">showAnchorTimer</a></li><li><a href="global.html#shutdown">shutdown</a></li><li><a href="global.html#unlockBulkBuyButton">unlockBulkBuyButton</a></li><li><a href="global.html#unlockCo2Button">unlockCo2Button</a></li><li><a href="global.html#unlockCoopButtons">unlockCoopButtons</a></li><li><a href="global.html#unlockDepartButton">unlockDepartButton</a></li><li><a href="global.html#unlockDrydockButton">unlockDrydockButton</a></li><li><a href="global.html#unlockFuelButton">unlockFuelButton</a></li><li><a href="global.html#unlockRepairButton">unlockRepairButton</a></li><li><a href="global.html#writeLogsToDisk">writeLogsToDisk</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">public/js/modules/vessel-management.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Vessel Management Module - Handles all vessel-related operations including purchasing,
 * departures, bulk repair, and vessel catalog browsing with filtering.
 *
 * Key Features:
 * - Vessel count tracking (ready to depart, at anchor, pending delivery)
 * - Bulk departure with fuel/CO2 consumption and income calculation
 * - Bulk repair system with wear threshold filtering
 * - Vessel catalog with container/tanker filtering
 * - Engine type filtering for specialized searches
 * - Multi-vessel purchase with confirmation and sequential API calls
 * - Stock price display for IPO companies
 * - Pending vessel tracking with delivery countdown
 *
 * Purchase Flow:
 * - Single purchase: Click "Buy Now" for immediate purchase
 * - Bulk purchase: Select multiple vessels, click "Bulk Buy"
 * - Sequential API calls with 1.5s delay to prevent rate limiting
 * - Cash updates after each successful purchase
 * - Auto-stops on limit reached or insufficient funds
 *
 * Departure System:
 * - Departs all vessels in "port" status simultaneously
 * - Calculates fuel consumption and CO2 emissions
 * - Shows income from vessel departures minus harbor fees
 * - Updates bunker inventory immediately for UX responsiveness
 * - Refreshes vessel and bunker status after completion
 *
 * Repair System:
 * - Filters vessels by wear percentage threshold (user configurable)
 * - Fetches repair costs for all qualifying vessels
 * - Shows total cost with affordability check
 * - Bulk repair via single API call
 *
 * @module vessel-management
 * @requires utils - Formatting and feedback functions
 * @requires api - Vessel API endpoints
 * @requires ui-dialogs - Confirmation dialogs
 * @requires bunker-management - Cash and fuel inventory management
 */

import { formatNumber, showSideNotification } from './utils.js';
import { escapeHtml } from './utils.js';
import {
  fetchVessels,
  fetchUserSettings,
  departAllVessels as apiDepartAllVessels,
  fetchAcquirableVessels,
  purchaseVessel as apiPurchaseVessel
} from './api.js';
import { selectVessel } from './harbor-map/map-controller.js';
import { showConfirmDialog } from './ui-dialogs.js';
import { getCurrentBunkerState, updateCurrentCash } from './bunker-management.js';
import { updateBadge, updateButtonState, updateButtonTooltip } from './badge-manager.js';

/**
 * Load cart from localStorage (user-specific)
 */
function loadCartFromStorage() {
  try {
    const storageKey = window.USER_STORAGE_PREFIX ? `vesselCart_${window.USER_STORAGE_PREFIX}` : 'vesselCart';
    const stored = localStorage.getItem(storageKey);
    return stored ? JSON.parse(stored) : [];
  } catch (error) {
    console.error('[Vessel Cart] Failed to load from storage:', error);
    return [];
  }
}

/**
 * Save cart to localStorage (user-specific)
 */
function saveCartToStorage() {
  try {
    const storageKey = window.USER_STORAGE_PREFIX ? `vesselCart_${window.USER_STORAGE_PREFIX}` : 'vesselCart';
    localStorage.setItem(storageKey, JSON.stringify(selectedVessels));
  } catch (error) {
    console.error('[Vessel Cart] Failed to save to storage:', error);
  }
}

/**
 * Array of all vessels available for purchase.
 * Populated from API and filtered by type/engine for display.
 * @type {Array&lt;Object>}
 */
let allAcquirableVessels = [];

/**
 * Current vessel type filter: 'container' or 'tanker'.
 * @type {string}
 */
let currentVesselFilter = 'container';

/**
 * Current engine type filter (null shows all engines).
 * Populated from unique engine types in vessel catalog.
 * @type {string|null}
 */
let selectedEngineType = null;

/**
 * Array of selected vessels for bulk purchase.
 * Each item contains vessel object and quantity.
 * Persisted in localStorage to survive page reloads.
 * @type {Array&lt;{vessel: Object, quantity: number}>}
 */
let selectedVessels = loadCartFromStorage();

/**
 * Cache for last known vessel counts to prevent flickering during updates
 */
let lastKnownCounts = {
  pending: null,
  port: null,
  anchor: null
};

/**
 * Get available anchor slots from global cache
 * @returns {number} Number of free anchor slots (from updateDataCache.anchor.available)
 */
function getAvailableAnchorSlots() {
  // Read DIRECTLY from global cache that's managed by chat.js
  // This is the SAME value shown in the header as "Free X"
  if (window.updateDataCache &amp;&amp; window.updateDataCache.anchor &amp;&amp; window.updateDataCache.anchor.available !== undefined) {
    return window.updateDataCache.anchor.available;
  }
  // Fallback: if cache not available yet, return 0 (disabled buttons until data loads)
  return 0;
}

/**
 * Refresh vessel cards display if vessels are currently visible
 * This updates button states based on available anchor slots
 * NOTE: This function is no longer called automatically - overlays only refresh when user opens them
 * Keeping function for backward compatibility but it should not be used
 * @deprecated Auto-refresh disabled to prevent filter resets
 */
function refreshVesselCardsIfVisible() {
  // Function intentionally disabled - do nothing
  // Vessel catalog will update when user reopens it
  console.warn('[Vessel Management] refreshVesselCardsIfVisible() called but auto-refresh is disabled');
}

// Keep function on window for backward compatibility but it does nothing now
window.refreshVesselCardsIfVisible = refreshVesselCardsIfVisible;

/**
 * Server-controlled lock states.
 * IMPORTANT: These are READ-ONLY on client side. Only server can modify via WebSocket events.
 * Client receives lock_status updates from server and must never set these directly.
 *
 * Lock Types:
 * - depart: Vessel departure operation in progress
 * - repair: Bulk repair operation in progress
 * - bulkBuy: Bulk vessel purchase in progress
 * - fuelPurchase: Fuel purchase operation in progress
 * - co2Purchase: CO2 purchase operation in progress
 *
 * @type {Object}
 */
const serverLockState = {
  depart: false,
  repair: false,
  bulkBuy: false,
  fuelPurchase: false,
  co2Purchase: false,
  drydock: false
};

/**
 * Updates lock state from server WebSocket event.
 * Called by chat.js when receiving 'lock_status' event.
 * Updates internal state AND UI to reflect server lock status.
 *
 * @param {Object} locks - Lock state object from server
 */
export function updateLockStateFromServer(locks) {
  if (locks.depart !== undefined) {
    serverLockState.depart = locks.depart;
    // Update depart button UI based on server lock state and vessel count
    const countBadge = document.querySelector('.map-icon-item[data-action="departAll"] .map-icon-badge');
    const hasVessels = countBadge &amp;&amp; !countBadge.classList.contains('hidden') &amp;&amp; parseInt(countBadge.textContent) > 0;
    updateButtonState('departAll', locks.depart || !hasVessels);
  }

  if (locks.repair !== undefined) {
    serverLockState.repair = locks.repair;
    updateButtonState('repairAll', locks.repair);
  }

  if (locks.bulkBuy !== undefined) {
    serverLockState.bulkBuy = locks.bulkBuy;
    const cartBtn = document.getElementById('cartBtn');
    if (cartBtn) {
      cartBtn.disabled = locks.bulkBuy;
    }
  }

  if (locks.fuelPurchase !== undefined) {
    serverLockState.fuelPurchase = locks.fuelPurchase;
    const fuelBtn = document.getElementById('fuelBtn');
    if (fuelBtn) {
      fuelBtn.disabled = locks.fuelPurchase;
    }
  }

  if (locks.co2Purchase !== undefined) {
    serverLockState.co2Purchase = locks.co2Purchase;
    const co2Btn = document.getElementById('co2Btn');
    if (co2Btn) {
      co2Btn.disabled = locks.co2Purchase;
    }
  }

  if (locks.drydock !== undefined) {
    serverLockState.drydock = locks.drydock;
    updateButtonState('drydockAll', locks.drydock);
  }

  console.log('[Lock State] Updated from server:', serverLockState);
}

/**
 * Updates vessel count badges and status displays for different vessel states.
 * Fetches current vessel data and updates UI badges for ready-to-depart, at-anchor, and pending vessels.
 *
 * Vessel States:
 * - 'port': Ready to depart (shows on depart button badge)
 * - 'anchor': At anchor waiting for route planning (shows on anchor button)
 * - 'pending': Vessel purchased but not yet delivered (shows delivery countdown)
 *
 * Additional Data Updates:
 * - Anchor capacity: Available slots vs maximum
 * - Stock price: For companies that have gone IPO
 * - Stock trend: Up/down indicator
 *
 * Side Effects:
 * - Fetches vessel and user settings data from API
 * - Updates multiple DOM badges and displays
 * - Enables/disables buttons based on vessel availability
 * - Updates button tooltips with contextual information
 *
 * @async
 * @returns {Promise&lt;void>}
 *
 * @example
 * // Called once on page load
 * updateVesselCount();
 */
export async function updateVesselCount() {
  try {
    // Fetch data
    const data = await fetchVessels();
    const vessels = data.vessels || [];

    const readyToDepart = vessels.filter(v => v.status === 'port' &amp;&amp; !v.is_parked).length;
    const atAnchor = vessels.filter(v => v.status === 'anchor').length;
    const pendingVessels = vessels.filter(v => v.status === 'pending').length;

    // Cache new values
    lastKnownCounts.pending = pendingVessels;
    lastKnownCounts.port = readyToDepart;
    lastKnownCounts.anchor = atAnchor;

    // Update harbor map if open (piggyback on vessel data update)
    if (window.harborMap &amp;&amp; window.harborMap.refreshIfOpen) {
      await window.harborMap.refreshIfOpen();
    }

    // Update pending vessels badge
    updateBadge('pendingVesselsBadge', pendingVessels, pendingVessels > 0, 'ORANGE');
    updateButtonTooltip('buyVessels', pendingVessels > 0 ? `Vessels in delivery: ${pendingVessels}` : 'Buy vessels');

    // Update pending filter button in overlay (if exists)
    const pendingBtn = document.getElementById('filterPendingBtn');
    const pendingCountSpan = document.getElementById('pendingCount');
    if (pendingBtn &amp;&amp; pendingCountSpan) {
      pendingCountSpan.textContent = pendingVessels;
      if (pendingVessels > 0) {
        pendingBtn.classList.remove('hidden');
      } else {
        pendingBtn.classList.add('hidden');
      }
    }

    // Update depart badge and button
    updateBadge('vesselCount', readyToDepart, readyToDepart > 0, 'BLUE');
    updateButtonState('departAll', readyToDepart === 0 || serverLockState.depart);
    updateButtonTooltip('departAll',
      readyToDepart > 0
        ? `Depart all ${readyToDepart} vessel${readyToDepart === 1 ? '' : 's'} from harbor`
        : 'No vessels ready to depart'
    );

    // Update anchor badge and button
    updateBadge('anchorCount', atAnchor, atAnchor > 0, 'RED');
    updateButtonTooltip('anchor',
      atAnchor > 0
        ? `${atAnchor} vessel${atAnchor === 1 ? '' : 's'} at anchor - Click to purchase anchor points`
        : 'Purchase anchor points'
    );

    const settingsResponse = await fetchUserSettings();
    if (settingsResponse) {
      // Anchor slots are managed by global updateDataCache.anchor.available (read-only)
      const stockValue = settingsResponse.user?.stock_value || 0;
      const stockTrend = settingsResponse.user?.stock_trend || '';

      // Anchor display is handled by script.js and chat.js - don't duplicate here

      const stockDisplay = document.getElementById('stockDisplay');
      const stockTrendElement = document.getElementById('stockTrend');
      const ipo = settingsResponse.user?.ipo || 0;

      if (stockDisplay &amp;&amp; stockTrendElement) {
        const stockContainer = stockDisplay.parentElement;

        if (ipo === 1) {
          stockContainer.classList.remove('hidden');
          stockDisplay.textContent = `$${stockValue.toFixed(2)}`;

          if (stockTrend === 'up') {
            stockTrendElement.textContent = '';
            stockTrendElement.classList.add('text-success');
            stockTrendElement.classList.remove('text-danger');
          } else if (stockTrend === 'down') {
            stockTrendElement.textContent = '';
            stockTrendElement.classList.add('text-danger');
            stockTrendElement.classList.remove('text-success');
          } else {
            stockTrendElement.textContent = '';
            stockTrendElement.classList.remove('text-success', 'text-danger');
          }
        } else {
          stockContainer.classList.add('hidden');
        }
      }
    }

    // Refresh vessel cards to update button states based on new anchor slot availability
    refreshVesselCardsIfVisible();

  } catch (error) {
    console.error('Error updating vessel count:', error);
  }
}

/**
 * Departs all vessels currently in harbor (status 'port').
 * Calculates and displays fuel usage, CO2 emissions, income, and harbor fees.
 *
 * Departure Process:
 * 1. Disables depart button to prevent double-click
 * 2. Calls API to depart all ready vessels
 * 3. Extracts resource usage and income from response
 * 4. Updates local cash/fuel/CO2 immediately for UX
 * 5. Triggers delayed refresh of vessel and bunker displays
 * 6. Shows detailed price alert with departure summary
 *
 * Partial Departure Handling:
 * - If not all vessels departed (insufficient fuel): Shows error with count
 * - If no vessels departed: Shows critical error message
 * - If all departed successfully: Shows success message with details
 *
 * Resource Updates:
 * - Cash: Increased by (depart_income - harbor_fee)
 * - Fuel: Decreased by fuel_usage
 * - CO2: Decreased by co2_emission
 *
 * Side Effects:
 * - Makes API call to depart vessels
 * - Updates bunker state (cash, fuel, CO2)
 * - Triggers debounced vessel and bunker status updates
 * - Shows price alert with departure details
 * - Disables button during operation
 *
 * @async
 * @returns {Promise&lt;void>}
 *
 * @example
 * // User clicks "Depart All" button
 * departAllVessels();
 * // Shows: "5 vessels departed! Fuel: 150t, CO2: 45t, Net income: $125,000"
 */
export async function departAllVessels() {
  // Server will handle lock checking - no client-side lock check needed
  // Button lock is controlled by server via WebSocket lock_status events

  try {
    const data = await apiDepartAllVessels();

    // Backend broadcasts notification to ALL clients via WebSocket
    // No need to show notification here - all clients will receive it

    // Server will broadcast lock_status to unlock button
    // No client-side state manipulation needed

    if (window.DEBUG_MODE) {
      if (data.success === false) {
        console.log('[Depart All] Departure failed:', data.reason);
      } else {
        console.log('[Depart All] Departure succeeded');
      }
    }

  } catch (error) {
    // Network errors or other exceptions
    console.error('[Depart All] Error:', error);
    // Server will handle unlock via lock_status event
  }
}

export async function updateRepairCount(settings) {
  try {
    const data = await fetchVessels();
    const vessels = data.vessels || [];

    const vesselsNeedingRepair = vessels.filter(v => {
      const wear = parseInt(v.wear) || 0;
      return wear >= settings.maintenanceThreshold;
    });

    // Update repair badge using badge-manager
    updateBadge('repairCount', vesselsNeedingRepair.length, vesselsNeedingRepair.length > 0, 'RED');

    // Get drydock count from badge (if exists)
    const drydockBadge = document.querySelector('.map-icon-item[data-action="repairAll"] .map-icon-badge-bottom-left');
    const drydockCount = drydockBadge ? (parseInt(drydockBadge.textContent) || 0) : 0;

    // Update button state (check both repair AND drydock counts)
    const hasWork = vesselsNeedingRepair.length > 0 || drydockCount > 0;
    updateButtonState('repairAll', !hasWork);

    // Update tooltip
    if (vesselsNeedingRepair.length > 0 &amp;&amp; drydockCount > 0) {
      updateButtonTooltip('repairAll', `Repair ${vesselsNeedingRepair.length} vessel${vesselsNeedingRepair.length === 1 ? '' : 's'} or drydock ${drydockCount} vessel${drydockCount === 1 ? '' : 's'}`);
    } else if (vesselsNeedingRepair.length > 0) {
      updateButtonTooltip('repairAll', `Repair ${vesselsNeedingRepair.length} vessel${vesselsNeedingRepair.length === 1 ? '' : 's'} with ${settings.maintenanceThreshold}%+ wear`);
    } else if (drydockCount > 0) {
      updateButtonTooltip('repairAll', `Drydock ${drydockCount} vessel${drydockCount === 1 ? '' : 's'}`);
    } else {
      updateButtonTooltip('repairAll', 'No vessels need repair or drydock');
    }
  } catch (error) {
    console.error('Error updating repair count:', error);
  }
}

/**
 * Repairs all vessels with wear at or above the configured maintenance threshold.
 * Shows confirmation dialog with total cost and processes bulk repair.
 *
 * Repair Flow:
 * 1. Fetch current vessels from API
 * 2. Filter vessels by wear threshold from settings
 * 3. Get repair cost estimate for all qualifying vessels
 * 4. Check affordability (cash >= total cost)
 * 5. Show confirmation dialog with cost breakdown
 * 6. Process bulk repair API call
 * 7. Update bunker status and repair count displays
 *
 * Cost Calculation:
 * - Fetches maintenance data for each vessel
 * - Sums "wear" type maintenance costs
 * - Compares against current cash
 *
 * Side Effects:
 * - Fetches vessel and maintenance cost data
 * - Shows confirmation dialog
 * - Makes bulk repair API call
 * - Updates cash via bunker state
 * - Triggers debounced status updates
 * - Shows success/error feedback
 * - Disables button during operation
 *
 * @async
 * @param {Object} settings - User settings object
 * @param {number} settings.maintenanceThreshold - Minimum wear percentage to trigger repair
 * @returns {Promise&lt;void>}
 *
 * @example
 * // Repairs all vessels with 10%+ wear
 * repairAllVessels({ maintenanceThreshold: 10 });
 */
/**
 * Shows bulk repair dialog with vessel list and costs
 */
/**
 * Shows tabbed dialog with Wear Repairs and Drydock tabs
 * @param {Object} settings - User settings
 * @param {number} repairCount - Badge count for repairs
 * @param {number} drydockCount - Badge count for drydock
 * @param {number} [specificVesselId] - Optional: Show only this vessel
 */
async function showRepairAndDrydockDialog(settings, repairCount, drydockCount, specificVesselId = null) {
  return new Promise(async (resolve) => {
    const overlay = document.createElement('div');
    overlay.className = 'confirm-dialog-overlay';

    const dialog = document.createElement('div');
    dialog.className = 'confirm-dialog bulk-repair-dialog';

    // Show dialog immediately with loading state
    dialog.innerHTML = `
      &lt;div class="confirm-dialog-header">
        &lt;h3> Vessel Maintenance&lt;/h3>
        &lt;div class="confirm-dialog-buttons">
          &lt;button class="confirm-dialog-btn cancel" data-action="cancel-loading">Close&lt;/button>
        &lt;/div>
      &lt;/div>
      &lt;div class="confirm-dialog-body" style="text-align: center; padding: 60px;">
        &lt;div style="font-size: 32px; margin-bottom: 16px;">&lt;/div>
        &lt;div style="color: #9ca3af;">Loading vessel data...&lt;/div>
      &lt;/div>
    `;
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);

    // Allow closing during loading
    let isCancelled = false;
    const cancelButton = dialog.querySelector('[data-action="cancel-loading"]');
    if (cancelButton) {
      cancelButton.addEventListener('click', () => {
        isCancelled = true;
        overlay.remove();
        resolve(false);
      });
    }
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        isCancelled = true;
        overlay.remove();
        resolve(false);
      }
    });

    // Determine initial active tab based on badge counts
    let activeTab = repairCount > 0 ? 'repair' : 'drydock';

    // Declare repairData and drydockData outside if/else
    let repairData;
    let drydockData;

    // If specific vessel ID provided, fetch only that vessel
    if (specificVesselId) {
      const indexResponse = await fetch(window.apiUrl('/api/game/index'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const indexData = await indexResponse.json();
      const allVessels = indexData.data.user_vessels || [];
      const specificVessel = allVessels.find(v => v.id === specificVesselId);

      if (!specificVessel) {
        showSideNotification('Vessel not found', 'error');
        resolve(false);
        return;
      }

      // Fetch repair cost for specific vessel (IGNORE thresholds - always show)
      const wear = parseFloat(specificVessel.wear) || 0;
      let repairCostData = { vessels: [], totalCost: 0, cash: 0 };

      try {
        const repairResponse = await fetch(window.apiUrl('/api/vessel/get-repair-preview'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ threshold: 0 }) // Use threshold 0 to get all vessels
        });
        const allRepairData = await repairResponse.json();

        // Filter for specific vessel
        const specificRepairVessel = allRepairData.vessels?.find(v => v.id === specificVesselId);
        if (specificRepairVessel) {
          // Found in API response - use real cost
          repairCostData = {
            vessels: [specificRepairVessel],
            totalCost: specificRepairVessel.cost || 0,
            cash: allRepairData.cash || 0
          };
        } else {
          // Not in API response (probably wear = 0%) - add manually with $0 cost
          repairCostData = {
            vessels: [{
              id: specificVessel.id,
              name: specificVessel.name,
              wear: wear.toFixed(2),
              cost: 0
            }],
            totalCost: 0,
            cash: allRepairData.cash || indexData.data.bunker?.cash || 0
          };
        }
      } catch (error) {
        console.error('[Vessel Management] Failed to fetch repair costs:', error);
        // Fallback: show vessel with $0 cost
        repairCostData = {
          vessels: [{
            id: specificVessel.id,
            name: specificVessel.name,
            wear: wear.toFixed(2),
            cost: 0
          }],
          totalCost: 0,
          cash: indexData.data.bunker?.cash || 0
        };
      }

      repairData = {
        vessels: repairCostData.vessels,
        totalCost: repairCostData.totalCost,
        cash: repairCostData.cash
      };

      // Prepare drydock data for specific vessel (IGNORE thresholds - always show)
      const drydockDataRaw = [specificVessel];
      const vesselIds = [specificVessel.id];

      let costData = { vessels: [], totalCost: 0, cash: 0 };
      try {
        const costResponse = await fetch(window.apiUrl('/api/maintenance/get-drydock-status'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            vessel_ids: JSON.stringify(vesselIds),
            speed: settings.autoDrydockSpeed || 'minimum',
            maintenance_type: settings.autoDrydockType || 'major'
          })
        });
        costData = await costResponse.json();
        console.log('[Vessel Management] Drydock cost response:', costData);
      } catch (error) {
        console.error('[Vessel Management] Failed to fetch drydock costs:', error);
      }

      // ALWAYS show vessel, even if API returns no cost (e.g., 350h until check)
      drydockData = {
        vessels: drydockDataRaw.map(v => {
          const costVessel = costData.vessels?.find(cv => cv.id === v.id);
          return {
            ...v,
            cost: costVessel?.cost || 0
          };
        }),
        totalCost: costData.totalCost || 0,
        cash: costData.cash || repairCostData.cash || 0
      };

      // Determine active tab based on what's available
      activeTab = repairData.vessels.length > 0 ? 'repair' : 'drydock';

      // Update counts for badge display
      repairCount = repairData.vessels.length;
      drydockCount = drydockData.vessels.length;

      // Continue with dialog rendering below (skip fetch)
    } else {
      // Fetch data for both tabs (normal mode - all vessels meeting criteria)
      const [repairDataFetch, drydockDataRaw] = await Promise.all([
        repairCount > 0 ? fetch(window.apiUrl('/api/vessel/get-repair-preview'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ threshold: settings.maintenanceThreshold })
        }).then(res => res.json()) : Promise.resolve({ vessels: [] }),

        drydockCount > 0 ? fetch(window.apiUrl('/api/game/index'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        }).then(res => res.json()).then(data => {
          const vessels = data.data.user_vessels || [];
          return vessels.filter(v => {
            const hours = v.hours_until_check !== undefined ? v.hours_until_check : 999;
            const alreadyScheduled = v.next_route_is_maintenance === true;
            return hours &lt;= settings.autoDrydockThreshold &amp;&amp; !alreadyScheduled;
          });
        }) : Promise.resolve([])
      ]);

      repairData = repairDataFetch;

      // Fetch drydock costs
      drydockData = { vessels: [], totalCost: 0, cash: 0 };
      if (drydockDataRaw.length > 0) {
        const vesselIds = drydockDataRaw.map(v => v.id);
        const costResponse = await fetch(window.apiUrl('/api/maintenance/get-drydock-status'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            vessel_ids: JSON.stringify(vesselIds),
            speed: settings.autoDrydockSpeed || 'minimum',
            maintenance_type: settings.autoDrydockType || 'major'
          })
        });
        const costData = await costResponse.json();

        // Merge vessel data with costs
        drydockData.vessels = drydockDataRaw.map(v => {
          const costVessel = costData.vessels?.find(cv => cv.id === v.id);
          return {
            ...v,
            cost: costVessel?.cost || 0
          };
        });
        drydockData.totalCost = costData.totalCost || 0;
        drydockData.cash = costData.cash || 0;
      }
    }

    // If user cancelled during loading, don't update dialog
    if (isCancelled) {
      return;
    }

    const updateDialog = () => {
      // Determine which execute button to show based on active tab
      const executeButtonHTML = activeTab === 'repair'
        ? (repairData.vessels?.length > 0 ? '&lt;button class="confirm-dialog-btn confirm" id="executeRepair">Repair All&lt;/button>' : '')
        : (drydockData.vessels?.length > 0 ? '&lt;button class="confirm-dialog-btn confirm" id="executeDrydock">Send to Drydock&lt;/button>' : '');

      dialog.innerHTML = `
        &lt;div class="confirm-dialog-header">
          &lt;h3> Vessel Maintenance&lt;/h3>
          &lt;div class="confirm-dialog-buttons">
            &lt;button class="confirm-dialog-btn cancel" data-action="cancel">Close&lt;/button>
            ${executeButtonHTML}
          &lt;/div>
        &lt;/div>
        &lt;div class="confirm-dialog-body">
          &lt;div class="repair-tabs">
            &lt;button class="tab-button ${activeTab === 'repair' ? 'tab-active' : ''}" data-tab="repair">
              Wear Repairs
              ${repairCount > 0 ? `&lt;span class="tab-badge">${repairCount}&lt;/span>` : ''}
            &lt;/button>
            &lt;button class="tab-button ${activeTab === 'drydock' ? 'tab-active' : ''}" data-tab="drydock">
              Drydock
              ${drydockCount > 0 ? `&lt;span class="tab-badge">${drydockCount}&lt;/span>` : ''}
            &lt;/button>
          &lt;/div>

          &lt;div class="tab-content ${activeTab === 'repair' ? 'tab-active' : ''}" id="repairTab">
            ${renderRepairTab(repairData, settings)}
          &lt;/div>

          &lt;div class="tab-content ${activeTab === 'drydock' ? 'tab-active' : ''}" id="drydockTab">
            ${renderDrydockTab(drydockData, settings, specificVesselId !== null)}
          &lt;/div>
        &lt;/div>
      `;

      // Tab switching
      dialog.querySelectorAll('[data-tab]').forEach(btn => {
        btn.addEventListener('click', () => {
          activeTab = btn.dataset.tab;
          updateDialog();
        });
      });

      // Close button
      dialog.querySelector('[data-action="cancel"]').addEventListener('click', () => {
        overlay.remove();
        resolve(false);
      });

      // Repair tab execute button
      const repairExecuteBtn = dialog.querySelector('#executeRepair');
      if (repairExecuteBtn) {
        repairExecuteBtn.addEventListener('click', async () => {
          // Close dialog
          overlay.remove();

          // Execute repair directly (no need to reload data - we already have it)
          // Disable repair button during operation
          updateButtonState('repairAll', true);

          try {
            // Call backend to repair all vessels
            const response = await fetch(window.apiUrl('/api/vessel/bulk-repair'), {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ threshold: settings.maintenanceThreshold })
            });

            await response.json();

            // Re-enable button
            updateButtonState('repairAll', false);

            // Update counts
            if (window.debouncedUpdateRepairCount &amp;&amp; window.debouncedUpdateBunkerStatus) {
              setTimeout(() => window.debouncedUpdateRepairCount(800), 1000);
              setTimeout(() => window.debouncedUpdateBunkerStatus(800), 1200);
            }
          } catch (error) {
            console.error('[Bulk Repair] Error:', error);
            // Re-enable button on error
            updateButtonState('repairAll', false);
          }

          resolve(true);
        });
      }

      // Drydock tab execute button
      const drydockExecuteBtn = dialog.querySelector('#executeDrydock');
      if (drydockExecuteBtn) {
        drydockExecuteBtn.addEventListener('click', async () => {
          await executeDrydock(settings, dialog, overlay);
          resolve(true);
        });
      }

      // Live update drydock costs when speed or type changes
      const drydockSpeedSelect = dialog.querySelector('#drydockSpeed');
      const drydockTypeSelect = dialog.querySelector('#drydockType');

      const updateDrydockCosts = async () => {
        if (!drydockSpeedSelect || !drydockTypeSelect) return;

        const selectedSpeed = drydockSpeedSelect.value;
        const selectedType = drydockTypeSelect.value;

        // Get all vessel IDs from drydockData
        const vesselIds = drydockData.vessels.map(v => v.id);
        if (vesselIds.length === 0) return;

        try {
          const costResponse = await fetch(window.apiUrl('/api/maintenance/get-drydock-status'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              vessel_ids: JSON.stringify(vesselIds),
              speed: selectedSpeed,
              maintenance_type: selectedType
            })
          });
          const costData = await costResponse.json();

          // Update drydockData with new costs
          drydockData.vessels = drydockData.vessels.map(v => {
            const costVessel = costData.vessels?.find(cv => cv.id === v.id);
            return {
              ...v,
              cost: costVessel?.cost || 0
            };
          });
          drydockData.totalCost = costData.totalCost || 0;
          drydockData.cash = costData.cash || drydockData.cash;

          // Update settings temporarily for rendering
          settings.autoDrydockSpeed = selectedSpeed;
          settings.autoDrydockType = selectedType;

          // Re-render dialog
          updateDialog();
        } catch (error) {
          console.error('[Vessel Management] Failed to update drydock costs:', error);
        }
      };

      if (drydockSpeedSelect) {
        drydockSpeedSelect.addEventListener('change', updateDrydockCosts);
      }
      if (drydockTypeSelect) {
        drydockTypeSelect.addEventListener('change', updateDrydockCosts);
      }
    };

    // Update dialog content (overlay already added to DOM above)
    updateDialog();
    // Note: overlay click listener already added above during loading state
  });
}

/**
 * Renders the Repair tab content
 */
function renderRepairTab(costData, settings) {
  const vessels = costData.vessels || [];
  const totalCost = costData.totalCost || 0;
  const bunkerCash = costData.cash || 0;
  const affordable = bunkerCash >= totalCost;

  if (vessels.length === 0) {
    return '&lt;div style="text-align: center; color: #9ca3af; padding: 40px;">No vessels need repair&lt;/div>';
  }

  const vesselListHtml = vessels.map(v => `
    &lt;div class="repair-vessel-row">
      &lt;span class="vessel-name">${escapeHtml(v.name)}&lt;/span>
      &lt;span class="vessel-wear">${v.wear}%&lt;/span>
      &lt;span class="vessel-cost">$${formatNumber(v.cost)}&lt;/span>
    &lt;/div>
  `).join('');

  return `
    &lt;div class="repair-summary ${affordable ? 'affordable' : 'too-expensive'}">
      &lt;div class="summary-row">
        &lt;span class="label">Vessels to repair:&lt;/span>
        &lt;span class="value">${vessels.length}&lt;/span>
      &lt;/div>
      &lt;div class="summary-row total">
        &lt;span class="label">Total Cost:&lt;/span>
        &lt;span class="value">$${formatNumber(totalCost)}&lt;/span>
      &lt;/div>
      &lt;div class="summary-row cash">
        &lt;span class="label">Available Cash:&lt;/span>
        &lt;span class="value">$${formatNumber(bunkerCash)}&lt;/span>
      &lt;/div>
      &lt;div class="summary-row threshold">
        &lt;span class="label">Wear Threshold:&lt;/span>
        &lt;span class="value">${settings.maintenanceThreshold}%+&lt;/span>
      &lt;/div>
    &lt;/div>
    &lt;div class="repair-vessel-list">
      &lt;div class="repair-vessel-header">
        &lt;span>Vessel Name&lt;/span>
        &lt;span>Wear&lt;/span>
        &lt;span>Cost&lt;/span>
      &lt;/div>
      ${vesselListHtml}
    &lt;/div>
  `;
}

/**
 * Renders the Drydock tab content
 * @param {Object} drydockData - Drydock vessels and costs
 * @param {Object} settings - User settings
 * @param {boolean} [isSpecificVessel=false] - Whether showing specific vessel (hides threshold)
 */
function renderDrydockTab(drydockData, settings, isSpecificVessel = false) {
  const vessels = drydockData.vessels || [];
  const totalCost = drydockData.totalCost || 0;
  const bunkerCash = drydockData.cash || 0;
  const affordable = bunkerCash >= totalCost;

  if (vessels.length === 0) {
    return '&lt;div style="text-align: center; color: #9ca3af; padding: 40px;">No vessels need drydock&lt;/div>';
  }

  const vesselListHtml = vessels.map(v => {
    const hours = v.hours_until_check !== undefined ? v.hours_until_check : 999;
    const route = v.route_destination ? ` ${v.route_destination}` : 'No route';
    const cost = v.cost || 0;
    return `
      &lt;div class="drydock-vessel-row">
        &lt;input type="checkbox" class="drydock-vessel-checkbox" data-vessel-id="${v.id}" checked>
        &lt;span class="vessel-name">${escapeHtml(v.name)}&lt;/span>
        &lt;span class="vessel-hours">${hours}h&lt;/span>
        &lt;span class="vessel-route">${escapeHtml(route)}&lt;/span>
        &lt;span class="vessel-cost">$${formatNumber(cost)}&lt;/span>
      &lt;/div>
    `;
  }).join('');

  const typeLabel = settings.autoDrydockType === 'major' ? 'Major (100%)' : 'Minor (60%)';
  const speedLabel = settings.autoDrydockSpeed === 'maximum' ? 'Maximum' : 'Minimum';

  return `
    &lt;div class="repair-summary ${affordable ? 'affordable' : 'too-expensive'}">
      &lt;div class="summary-row">
        &lt;span class="label">Vessels to drydock:&lt;/span>
        &lt;span class="value">${vessels.length}&lt;/span>
      &lt;/div>
      &lt;div class="summary-row total">
        &lt;span class="label">Total Cost:&lt;/span>
        &lt;span class="value">$${formatNumber(totalCost)}&lt;/span>
      &lt;/div>
      &lt;div class="summary-row cash">
        &lt;span class="label">Available Cash:&lt;/span>
        &lt;span class="value">$${formatNumber(bunkerCash)}&lt;/span>
      &lt;/div>
      &lt;div class="summary-row">
        &lt;span class="label">Type:&lt;/span>
        &lt;span class="value">${typeLabel}&lt;/span>
      &lt;/div>
      &lt;div class="summary-row">
        &lt;span class="label">Speed:&lt;/span>
        &lt;span class="value">${speedLabel}&lt;/span>
      &lt;/div>
      ${!isSpecificVessel ? `
        &lt;div class="summary-row threshold">
          &lt;span class="label">Hours Threshold:&lt;/span>
          &lt;span class="value">${settings.autoDrydockThreshold}h&lt;/span>
        &lt;/div>
      ` : ''}
    &lt;/div>
    &lt;div class="drydock-options">
      &lt;div class="drydock-option-group">
        &lt;label for="drydockSpeed">Route Speed&lt;/label>
        &lt;select id="drydockSpeed">
          &lt;option value="minimum" ${settings.autoDrydockSpeed === 'minimum' ? 'selected' : ''}>Minimum (Slow, Less Fuel)&lt;/option>
          &lt;option value="maximum" ${settings.autoDrydockSpeed === 'maximum' ? 'selected' : ''}>Maximum (Fast, More Fuel)&lt;/option>
        &lt;/select>
      &lt;/div>
      &lt;div class="drydock-option-group">
        &lt;label for="drydockType">Maintenance Type&lt;/label>
        &lt;select id="drydockType">
          &lt;option value="major" ${settings.autoDrydockType === 'major' ? 'selected' : ''}>Major (100% Antifouling)&lt;/option>
          &lt;option value="minor" ${settings.autoDrydockType === 'minor' ? 'selected' : ''}>Minor (60% Antifouling)&lt;/option>
        &lt;/select>
      &lt;/div>
    &lt;/div>
    &lt;div class="repair-vessel-list">
      &lt;div class="repair-vessel-header" style="grid-template-columns: auto 2fr 1fr 1fr 1fr;">
        &lt;span>Select&lt;/span>
        &lt;span>Vessel Name&lt;/span>
        &lt;span>Hours&lt;/span>
        &lt;span>Route&lt;/span>
        &lt;span>Cost&lt;/span>
      &lt;/div>
      ${vesselListHtml}
    &lt;/div>
  `;
}

/**
 * Executes drydock for selected vessels
 */
async function executeDrydock(settings, dialog, overlay) {
  const checkedBoxes = dialog.querySelectorAll('.drydock-vessel-checkbox:checked');
  if (checkedBoxes.length === 0) {
    showSideNotification('No vessels selected', 'info');
    return;
  }

  const vesselIds = Array.from(checkedBoxes).map(cb => cb.dataset.vesselId);
  const speed = dialog.querySelector('#drydockSpeed').value;
  const maintenanceType = dialog.querySelector('#drydockType').value;

  try {
    overlay.remove();

    const response = await fetch(window.apiUrl('/api/maintenance/bulk-drydock'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        vessel_ids: JSON.stringify(vesselIds),
        speed,
        maintenance_type: maintenanceType
      })
    });

    const data = await response.json();

    if (data.error) {
      showSideNotification(`Drydock failed: ${data.error}`, 'error');
    }
  } catch (error) {
    console.error('[Drydock] Error:', error);
    showSideNotification('Drydock failed', 'error');
  }
}

function showBulkRepairDialog(costData, threshold) {
  return new Promise((resolve) => {
    const overlay = document.createElement('div');
    overlay.className = 'confirm-dialog-overlay';

    const dialog = document.createElement('div');
    dialog.className = 'confirm-dialog bulk-repair-dialog';

    const vessels = costData.vessels || [];
    const totalCost = costData.totalCost || 0;
    const bunkerCash = costData.cash || 0;
    const affordable = bunkerCash >= totalCost;

    // Build vessel list HTML
    const vesselListHtml = vessels.map(v => `
      &lt;div class="repair-vessel-row">
        &lt;span class="vessel-name">${escapeHtml(v.name)}&lt;/span>
        &lt;span class="vessel-wear">${v.wear}%&lt;/span>
        &lt;span class="vessel-cost">$${formatNumber(v.cost)}&lt;/span>
      &lt;/div>
    `).join('');

    dialog.innerHTML = `
      &lt;div class="confirm-dialog-header">
        &lt;h3> Bulk Vessel Repair&lt;/h3>
        &lt;div class="confirm-dialog-buttons">
          &lt;button class="confirm-dialog-btn cancel" data-action="cancel">Cancel&lt;/button>
          &lt;button class="confirm-dialog-btn confirm" data-action="confirm">Repair All&lt;/button>
        &lt;/div>
      &lt;/div>
      &lt;div class="confirm-dialog-body">
        &lt;div class="repair-summary ${affordable ? 'affordable' : 'too-expensive'}">
          &lt;div class="summary-row">
            &lt;span class="label">Vessels to repair:&lt;/span>
            &lt;span class="value">${vessels.length}&lt;/span>
          &lt;/div>
          &lt;div class="summary-row total">
            &lt;span class="label">Total Cost:&lt;/span>
            &lt;span class="value">$${formatNumber(totalCost)}&lt;/span>
          &lt;/div>
          &lt;div class="summary-row cash">
            &lt;span class="label">Available Cash:&lt;/span>
            &lt;span class="value">$${formatNumber(bunkerCash)}&lt;/span>
          &lt;/div>
          &lt;div class="summary-row threshold">
            &lt;span class="label">Wear Threshold:&lt;/span>
            &lt;span class="value">${threshold}%+&lt;/span>
          &lt;/div>
        &lt;/div>
        &lt;div class="repair-vessel-list">
          &lt;div class="repair-vessel-header">
            &lt;span>Vessel Name&lt;/span>
            &lt;span>Wear&lt;/span>
            &lt;span>Cost&lt;/span>
          &lt;/div>
          ${vesselListHtml}
        &lt;/div>
      &lt;/div>
    `;

    overlay.appendChild(dialog);
    document.body.appendChild(overlay);

    const handleClose = (confirmed) => {
      overlay.remove();
      resolve(confirmed);
    };

    dialog.querySelectorAll('[data-action]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        handleClose(btn.dataset.action === 'confirm');
      });
    });

    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) handleClose(false);
    });
  });
}

/**
 * Opens tabbed dialog with Wear Repairs and Drydock options
 * @param {Object} settings - User settings
 * @param {number} [specificVesselId] - Optional: Show only this vessel
 */
export async function openRepairAndDrydockDialog(settings, specificVesselId = null) {
  // Get badge counts from map icon bar
  const repairCountBadge = document.querySelector('.map-icon-item[data-action="repairAll"] .map-icon-badge');
  const drydockCountBadge = document.querySelector('.map-icon-item[data-action="repairAll"] .map-icon-badge-bottom-left');

  const repairCount = repairCountBadge ? (parseInt(repairCountBadge.textContent) || 0) : 0;
  const drydockCount = drydockCountBadge ? (parseInt(drydockCountBadge.textContent) || 0) : 0;

  // If specific vessel ID provided, always show dialog (even if counts are 0)
  if (!specificVesselId &amp;&amp; repairCount === 0 &amp;&amp; drydockCount === 0) {
    showSideNotification('No vessels need repair or drydock', 'info');
    return;
  }

  // Show tabbed dialog
  await showRepairAndDrydockDialog(settings, repairCount, drydockCount, specificVesselId);
}

export async function repairAllVessels(settings) {
  // Get repair count from badge
  const repairCountBadge = document.querySelector('.map-icon-item[data-action="repairAll"] .map-icon-badge');
  const vesselsNeedingRepair = repairCountBadge ? (parseInt(repairCountBadge.textContent) || 0) : 0;

  if (vesselsNeedingRepair === 0) return;

  try {
    // Fetch vessel data and repair costs from backend
    // Disable button during preview
    updateButtonState('repairAll', true);

    const costResponse = await fetch(window.apiUrl('/api/vessel/get-repair-preview'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ threshold: settings.maintenanceThreshold })
    });

    const costData = await costResponse.json();

    if (!costData.vessels || costData.vessels.length === 0) {
      showSideNotification('No vessels need repair', 'info');
      updateButtonState('repairAll', false);
      return;
    }

    // Show detailed confirmation dialog with vessel list (button stays disabled)
    const confirmed = await showBulkRepairDialog(costData, settings.maintenanceThreshold);

    if (!confirmed) {
      updateButtonState('repairAll', false);
      return;
    }

    // Button stays disabled during repair
    // Call backend which handles everything and broadcasts to all clients
    const response = await fetch(window.apiUrl('/api/vessel/bulk-repair'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ threshold: settings.maintenanceThreshold })
    });

    await response.json();

    // Backend broadcasts notification to ALL clients via WebSocket
    // No need to show notification here - all clients will receive it

    // Update locally for immediate feedback, then re-enable button
    if (window.debouncedUpdateRepairCount &amp;&amp; window.debouncedUpdateBunkerStatus) {
      await window.debouncedUpdateRepairCount(800);
      await window.debouncedUpdateBunkerStatus(800);
    }

    // Re-enable button AFTER badge updates complete
    updateButtonState('repairAll', false);

  } catch (error) {
    // Error notifications are also broadcasted by backend
    console.error('[Bulk Repair] Error:', error);

    // Re-enable button on error
    updateButtonState('repairAll', false);
  }
}

// Track if filters have been populated to avoid re-populating on every open
let filtersPopulated = false;

export async function loadAcquirableVessels(preserveFilters = false) {
  try {
    const data = await fetchAcquirableVessels();
    allAcquirableVessels = data.data.vessels_for_sale || [];

    if (window.DEBUG_MODE) console.log('[Load Vessels] Loaded', allAcquirableVessels.length, 'vessels');

    // Log first few vessels to understand data structure (only once)
    if (window.DEBUG_MODE &amp;&amp; allAcquirableVessels.length > 0 &amp;&amp; !filtersPopulated) {
      console.log('[Load Vessels] Sample vessel data:', allAcquirableVessels[0]);
      console.log('[Load Vessels] Vessel types in data:', [...new Set(allAcquirableVessels.map(v => v.capacity_type))]);
      console.log('[Load Vessels] Engine types in data:', [...new Set(allAcquirableVessels.map(v => v.engine_type))]);
      console.log('[Load Vessels] Year range in data:', Math.min(...allAcquirableVessels.map(v => v.year)), '-', Math.max(...allAcquirableVessels.map(v => v.year)));

      // Check for special properties
      const withPerks = allAcquirableVessels.filter(v => v.perks &amp;&amp; v.perks !== null &amp;&amp; v.perks !== '');
      const creditsOnly = allAcquirableVessels.filter(v => v.only_for_credits);
      console.log('[Load Vessels] Special properties:', {
        withPerks: withPerks.length,
        creditsOnly: creditsOnly.length,
        perksExample: withPerks.length > 0 ? { name: withPerks[0].name, perks: withPerks[0].perks, perkType: typeof withPerks[0].perks } : 'None',
        creditsExample: creditsOnly.length > 0 ? { name: creditsOnly[0].name, only_for_credits: creditsOnly[0].only_for_credits, valueType: typeof creditsOnly[0].only_for_credits } : 'None'
      });
    }

    // Populate dynamic filters based on actual vessel data (only first time)
    if (!filtersPopulated) {
      populateDynamicFilters();
      filtersPopulated = true;
    }

    // Show/hide "Credits Only" filter based on whether any vessels exist
    const creditsOnlyCheckbox = document.querySelector('input[name="special"][value="credits"]');
    const hasCreditsOnlyVessels = allAcquirableVessels.some(v => v.only_for_credits);
    if (creditsOnlyCheckbox) {
      const creditsLabel = creditsOnlyCheckbox.closest('label');
      if (creditsLabel) {
        if (hasCreditsOnlyVessels) {
          creditsLabel.style.display = '';
        } else {
          creditsLabel.style.display = 'none';
          creditsOnlyCheckbox.checked = false; // Uncheck if hidden
        }
      }
    }

    // Vessel images are preloaded on page load (script.js STEP 8.5)
    // No need to preload here anymore

    // Apply or preserve filters based on parameter
    if (preserveFilters) {
      // Just re-display with existing filters (after purchase)
      displayFilteredVessels();
    } else {
      // Initialize filters from DOM checkboxes (first load)
      window.applyVesselFilters();
    }

    // Restore cart badge from localStorage
    updateCartBadge();
  } catch (error) {
    console.error('Error loading vessels:', error);
    document.getElementById('vesselCatalogFeed').innerHTML = `
      &lt;div style="text-align: center; color: #ef4444; padding: 40px;">
        Failed to load vessels. Please try again.
      &lt;/div>
    `;
  }
}

/**
 * Get capacity display for acquirable vessels.
 * Display differs from selling catalog because API endpoint returns different data structure:
 * - Acquirable vessels: Simple capacity number (vessel.capacity_max as number)
 * - User vessels (selling): Detailed breakdown object (vessel.capacity_max.dry, .refrigerated, etc.)
 */
function getCapacityDisplay(vessel) {
  if (vessel.capacity_type === 'container') {
    // Container vessels - capacity_max can be number or object {dry, refrigerated}
    if (typeof vessel.capacity_max === 'object') {
      // Total capacity is dry + refrigerated (not max of either)
      const dry = vessel.capacity_max.dry ?? 0;
      const ref = vessel.capacity_max.refrigerated ?? 0;
      const total = dry + ref;
      return `${formatNumber(total)} TEU`;
    }
    return `${formatNumber(vessel.capacity_max ?? 0)} TEU`;
  } else if (vessel.capacity_type === 'tanker') {
    // Tanker vessels - capacity_max can be number or object {crude_oil, fuel}
    if (typeof vessel.capacity_max === 'object') {
      // Total capacity is fuel + crude (not max of either)
      const fuel = vessel.capacity_max.fuel ?? 0;
      const crude = vessel.capacity_max.crude_oil ?? 0;
      const total = fuel + crude;
      return `${formatNumber(total)} bbl`;
    }
    return `${formatNumber(vessel.capacity_max ?? 0)} bbl`;
  } else {
    // Other vessel types (bulk carriers, etc)
    return `${formatNumber(vessel.capacity_max ?? 0)}t`;
  }
}

/**
 * Get CSS class name for CO2 efficiency factor
 * @param {number} factor - CO2 efficiency factor
 * @returns {string} CSS class name
 */
function getCO2EfficiencyClass(factor) {
  if (factor &lt; 1.0) return 'vessel-spec-co2-efficient';
  if (factor === 1.0) return 'vessel-spec-co2-standard';
  return 'vessel-spec-co2-inefficient';
}

/**
 * Get CSS class name for Fuel efficiency factor
 * @param {number} factor - Fuel efficiency factor
 * @returns {string} CSS class name
 */
function getFuelEfficiencyClass(factor) {
  if (factor &lt; 1.0) return 'vessel-spec-fuel-efficient';
  if (factor === 1.0) return 'vessel-spec-fuel-standard';
  return 'vessel-spec-fuel-inefficient';
}

// Track if pending view is active
let isPendingViewActive = false;

export async function showPendingVessels(pendingVessels) {
  // Toggle pending view
  if (isPendingViewActive) {
    // User clicked pending again - restore previous view
    isPendingViewActive = false;

    // Show cart button again
    const cartBtn = document.getElementById('cartBtn');
    if (cartBtn) cartBtn.classList.remove('hidden');

    // Load and show regular acquirable vessels - this will read filters from DOM
    await loadAcquirableVessels(false);
    return;
  }

  // Entering pending view
  isPendingViewActive = true;

  const feed = document.getElementById('vesselCatalogFeed');

  const cartBtn = document.getElementById('cartBtn');
  if (cartBtn) cartBtn.classList.add('hidden');

  if (pendingVessels.length === 0) {
    feed.innerHTML = `
      &lt;div style="text-align: center; color: #9ca3af; padding: 40px;">
        No pending vessels
      &lt;/div>
    `;
    isPendingViewActive = false;
    return;
  }

  // Show ALL pending vessels - no filters applied
  const filteredVessels = pendingVessels;

  // Sort by price
  filteredVessels.sort((a, b) => {
    if (priceSort === 'asc') {
      return (a.price || 0) - (b.price || 0);
    } else {
      return (b.price || 0) - (a.price || 0);
    }
  });

  if (filteredVessels.length === 0) {
    feed.innerHTML = `
      &lt;div style="text-align: center; color: #9ca3af; padding: 40px;">
        No pending vessels match the selected filters
      &lt;/div>
    `;
    return;
  }

  // Store for lazy loading
  currentlyDisplayedVessels = filteredVessels;

  const grid = document.createElement('div');
  grid.className = filteredVessels.length === 1 ? 'vessel-catalog-grid single-vessel' : 'vessel-catalog-grid';
  grid.id = 'vesselCatalogGrid';

  // Disconnect existing observer if any
  if (lazyLoadObserver) {
    lazyLoadObserver.disconnect();
  }

  // Load initial batch only
  const initialBatch = filteredVessels.slice(0, INITIAL_LOAD_COUNT);

  initialBatch.forEach(vessel => {
    // Use the same createVesselCard() function for consistent styling
    // Mark as pending vessel for any special styling needed
    const card = createVesselCard(vessel, true); // true = isPending
    grid.appendChild(card);
  });

  // If more vessels exist, add lazy load sentinel
  if (filteredVessels.length > INITIAL_LOAD_COUNT) {
    const sentinel = document.createElement('div');
    sentinel.id = 'lazyLoadSentinel';
    sentinel.className = 'lazy-load-sentinel';
    sentinel.innerHTML = '&lt;div style="text-align: center; padding: 20px; color: #9ca3af;">Loading more vessels...&lt;/div>';
    grid.appendChild(sentinel);

    // Setup Intersection Observer for lazy loading
    lazyLoadObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          loadMorePendingVessels();
        }
      });
    }, {
      rootMargin: '200px'
    });

    lazyLoadObserver.observe(sentinel);
  }

  feed.innerHTML = '';
  feed.appendChild(grid);

  // Adjust window size if only 1 vessel is displayed
  const buyVesselsOverlay = document.getElementById('buyVesselsOverlay');
  const messengerWindow = buyVesselsOverlay?.querySelector('.messenger-window');
  if (messengerWindow) {
    if (filteredVessels.length === 1) {
      messengerWindow.classList.add('messenger-window-single-vessel');
    } else {
      messengerWindow.classList.remove('messenger-window-single-vessel');
    }
  }

  if (window.DEBUG_MODE) console.log(`[Pending Vessels] Showing ${Math.min(INITIAL_LOAD_COUNT, filteredVessels.length)} of ${filteredVessels.length} vessels (lazy loading enabled)`);
}

/**
 * Load more pending vessels when scrolling
 */
function loadMorePendingVessels() {
  const grid = document.getElementById('vesselCatalogGrid');
  const sentinel = document.getElementById('lazyLoadSentinel');

  if (!grid || !sentinel) return;

  // Count currently loaded vessels (exclude sentinel)
  const currentCount = grid.children.length - 1;

  // Get next batch
  const nextBatch = currentlyDisplayedVessels.slice(currentCount, currentCount + LAZY_LOAD_BATCH);

  if (nextBatch.length === 0) {
    sentinel.remove();
    if (lazyLoadObserver) {
      lazyLoadObserver.disconnect();
    }
    return;
  }

  // Insert new vessels before sentinel
  nextBatch.forEach(vessel => {
    const imageUrl = `/api/vessel-image/${vessel.type}`;

    let timeDisplay = '';
    const remaining = vessel.time_arrival || 0;

    if (remaining > 0) {
      const days = Math.floor(remaining / 86400);
      const hours = Math.floor((remaining % 86400) / 3600);
      const minutes = Math.floor((remaining % 3600) / 60);
      if (days > 0) {
        timeDisplay = `${days}d ${hours}h`;
      } else if (hours > 0) {
        timeDisplay = `${hours}h ${minutes}m`;
      } else {
        timeDisplay = `${minutes}m`;
      }
    } else {
      timeDisplay = 'Ready';
    }

    const capacityDisplay = getCapacityDisplay(vessel);
    const co2Class = getCO2EfficiencyClass(vessel.co2_factor);
    const fuelClass = getFuelEfficiencyClass(vessel.fuel_factor);

    let additionalAttrs = '';
    if (vessel.width &amp;&amp; vessel.width !== 0) {
      additionalAttrs += `&lt;div class="vessel-spec">&lt;strong>Width:&lt;/strong> ${vessel.width} m&lt;/div>`;
    }
    if (vessel.price_in_points &amp;&amp; vessel.price_in_points !== 0) {
      additionalAttrs += `&lt;div class="vessel-spec">&lt;strong>Points Price:&lt;/strong> ${formatNumber(vessel.price_in_points)}&lt;/div>`;
    }
    if (vessel.perks &amp;&amp; vessel.perks !== null) {
      additionalAttrs += `&lt;div class="vessel-spec vessel-spec-fullwidth">&lt;strong>Perks:&lt;/strong> ${vessel.perks}&lt;/div>`;
    }

    const card = document.createElement('div');
    card.className = 'vessel-card pending-vessel';
    card.innerHTML = `
      &lt;div class="vessel-image-container">
        &lt;img src="${imageUrl}" alt="${vessel.name}" class="vessel-image" onerror="this.src='data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 400 300%22>&lt;rect fill=%22%23374151%22 width=%22400%22 height=%22300%22/>&lt;text x=%2250%%22 y=%2250%%22 fill=%22%239ca3af%22 text-anchor=%22middle%22 font-size=%2224%22>&lt;/text>&lt;/svg>'">
        ${vessel.only_for_credits ? '&lt;div class="vessel-credits-only-badge">$&lt;/div>' : ''}
        &lt;div class="vessel-time-badge"> ${timeDisplay}&lt;/div>
        &lt;div class="vessel-price-badge">$${formatNumber(vessel.price || 0)}&lt;/div>
      &lt;/div>
      &lt;div class="vessel-content">
        &lt;div class="vessel-header">
          &lt;h3 class="vessel-name">${vessel.name}&lt;/h3>
        &lt;/div>
        &lt;div class="vessel-specs">
          &lt;div class="vessel-spec">&lt;strong>Capacity:&lt;/strong> ${capacityDisplay}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Range:&lt;/strong> ${formatNumber(vessel.range || 0)} nm&lt;/div>
          &lt;div class="vessel-spec ${co2Class}">&lt;strong>CO2 Factor:&lt;/strong> ${vessel.co2_factor}&lt;/div>
          &lt;div class="vessel-spec ${fuelClass}">&lt;strong>Fuel Factor:&lt;/strong> ${vessel.fuel_factor}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Fuel Cap.:&lt;/strong> ${formatNumber(vessel.fuel_capacity || 0)} t&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Service:&lt;/strong> ${vessel.hours_between_service || 0}h&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Engine:&lt;/strong> ${vessel.engine_type || 'N/A'} (${formatNumber(vessel.kw || 0)} kW)&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Speed:&lt;/strong> ${vessel.max_speed || 0} kn&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Type:&lt;/strong> ${vessel.type_name || vessel.type}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Port:&lt;/strong> ${(vessel.current_port_code || '').replace(/_/g, ' ')}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Year:&lt;/strong> ${vessel.year || 'N/A'}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Length:&lt;/strong> ${vessel.length || 0} m&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>IMO:&lt;/strong> ${vessel.imo || 'N/A'}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>MMSI:&lt;/strong> ${vessel.mmsi || 'N/A'}&lt;/div>
          ${vessel.gearless || vessel.antifouling || additionalAttrs ? '&lt;div class="vessel-spec-divider">&lt;/div>' : ''}
          ${vessel.gearless ? '&lt;div class="vessel-spec vessel-spec-fullwidth vessel-spec-gearless">&lt;strong> Gearless:&lt;/strong> own cranes&lt;/div>' : ''}
          ${vessel.antifouling ? `&lt;div class="vessel-spec vessel-spec-fullwidth vessel-spec-antifouling">&lt;strong> Antifouling:&lt;/strong> ${vessel.antifouling}&lt;/div>` : ''}
          ${additionalAttrs}
        &lt;/div>
      &lt;/div>
    `;
    grid.insertBefore(card, sentinel);
  });

  if (window.DEBUG_MODE) console.log(`[Lazy Load] Loaded ${nextBatch.length} more pending vessels (${currentCount + nextBatch.length}/${currentlyDisplayedVessels.length})`);

  // If all loaded, remove sentinel
  if (currentCount + nextBatch.length >= currentlyDisplayedVessels.length) {
    sentinel.remove();
    if (lazyLoadObserver) {
      lazyLoadObserver.disconnect();
    }
  }
}

export function displayVessels() {
  const feed = document.getElementById('vesselCatalogFeed');

  let filtered;

  if (selectedEngineType) {
    filtered = allAcquirableVessels.filter(v => v.engine_type === selectedEngineType);
  } else {
    filtered = allAcquirableVessels.filter(v => v.capacity_type === currentVesselFilter);
  }

  if (filtered.length === 0) {
    const filterText = selectedEngineType
      ? `No vessels with engine type "${selectedEngineType}"`
      : `No ${currentVesselFilter} vessels available`;
    feed.innerHTML = `
      &lt;div style="text-align: center; color: #9ca3af; padding: 40px;">
        ${filterText}
      &lt;/div>
    `;
    return;
  }

  filtered.sort((a, b) => a.price - b.price);

  const grid = document.createElement('div');
  grid.className = 'vessel-catalog-grid';

  filtered.forEach(vessel => {
    const selectedItem = selectedVessels.find(v => v.vessel.id === vessel.id);
    const isSelected = !!selectedItem;
    const imageUrl = `/api/vessel-image/${vessel.type}`;

    // Check if anchor slots are available
    const availableSlots = getAvailableAnchorSlots();
    const canPurchase = availableSlots > 0;

    const capacityDisplay = getCapacityDisplay(vessel);
    const co2Class = getCO2EfficiencyClass(vessel.co2_factor);
    const fuelClass = getFuelEfficiencyClass(vessel.fuel_factor);

    let additionalAttrs = '';
    if (vessel.width &amp;&amp; vessel.width !== 0) {
      additionalAttrs += `&lt;div class="vessel-spec">&lt;strong>Width:&lt;/strong> ${vessel.width} m&lt;/div>`;
    }
    if (vessel.price_in_points &amp;&amp; vessel.price_in_points !== 0) {
      additionalAttrs += `&lt;div class="vessel-spec">&lt;strong>Points Price:&lt;/strong> ${formatNumber(vessel.price_in_points)}&lt;/div>`;
    }
    if (vessel.perks &amp;&amp; vessel.perks !== null) {
      additionalAttrs += `&lt;div class="vessel-spec vessel-spec-fullwidth">&lt;strong>Perks:&lt;/strong> ${vessel.perks}&lt;/div>`;
    }

    const card = document.createElement('div');
    card.className = 'vessel-card';
    card.innerHTML = `
      &lt;div class="vessel-image-container">
        &lt;img src="${imageUrl}" alt="${vessel.name}" class="vessel-image" onerror="this.src='data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 400 300%22>&lt;rect fill=%22%23374151%22 width=%22400%22 height=%22300%22/>&lt;text x=%2250%%22 y=%2250%%22 fill=%22%239ca3af%22 text-anchor=%22middle%22 font-size=%2224%22>&lt;/text>&lt;/svg>'">
        ${vessel.only_for_credits ? '&lt;div class="vessel-credits-overlay">$&lt;/div>' : ''}
      &lt;/div>
      &lt;div class="vessel-content">
        &lt;div class="vessel-header">
          &lt;h3 class="vessel-name">${vessel.name}&lt;/h3>
          &lt;div class="vessel-price">$${formatNumber(vessel.price)}&lt;/div>
        &lt;/div>
        &lt;div class="vessel-specs">
          &lt;div class="vessel-spec">&lt;strong>Capacity:&lt;/strong> ${capacityDisplay}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Range:&lt;/strong> ${formatNumber(vessel.range)} nm&lt;/div>
          &lt;div class="vessel-spec ${co2Class}">&lt;strong>CO2 Factor:&lt;/strong> ${vessel.co2_factor}&lt;/div>
          &lt;div class="vessel-spec ${fuelClass}">&lt;strong>Fuel Factor:&lt;/strong> ${vessel.fuel_factor}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Fuel Cap.:&lt;/strong> ${formatNumber(vessel.fuel_capacity)} t&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Service:&lt;/strong> ${vessel.hours_between_service}h&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Engine:&lt;/strong> ${vessel.engine_type} (${formatNumber(vessel.kw)} kW)&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Speed:&lt;/strong> ${vessel.max_speed} kn&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Type:&lt;/strong> ${vessel.type_name}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Port:&lt;/strong> ${vessel.current_port_code.replace(/_/g, ' ')}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Year:&lt;/strong> ${vessel.year}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Length:&lt;/strong> ${vessel.length} m&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>IMO:&lt;/strong> ${vessel.imo || 'N/A'}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>MMSI:&lt;/strong> ${vessel.mmsi || 'N/A'}&lt;/div>
          ${vessel.gearless || vessel.antifouling || additionalAttrs ? '&lt;div class="vessel-spec vessel-spec-divider">&lt;/div>' : ''}
          ${vessel.gearless ? '&lt;div class="vessel-spec vessel-spec-fullwidth vessel-spec-gearless">&lt;strong> Gearless:&lt;/strong> own cranes&lt;/div>' : ''}
          ${vessel.antifouling ? `&lt;div class="vessel-spec vessel-spec-fullwidth vessel-spec-antifouling">&lt;strong> Antifouling:&lt;/strong> ${vessel.antifouling}&lt;/div>` : ''}
          ${additionalAttrs}
        &lt;/div>
        &lt;div class="vessel-actions">
          &lt;input type="number" class="vessel-quantity-input" data-vessel-id="${vessel.id}" value="${isSelected ? selectedItem.quantity : 1}" min="1" max="99" ${!canPurchase ? 'disabled' : ''} />
          &lt;div class="vessel-action-buttons">
            &lt;button class="vessel-select-btn" data-vessel-id="${vessel.id}" ${!canPurchase ? 'disabled title="Not enough anchor slots"' : ''}>
              Add to Cart
            &lt;/button>
            &lt;button class="vessel-buy-btn" data-vessel-id="${vessel.id}" ${!canPurchase ? 'disabled title="Not enough anchor slots"' : ''}>
              Buy Now
            &lt;/button>
          &lt;/div>
        &lt;/div>
      &lt;/div>
    `;

    card.querySelector('.vessel-select-btn').addEventListener('click', () => {
      const quantityInput = card.querySelector('.vessel-quantity-input');
      const quantity = parseInt(quantityInput.value) || 1;
      toggleVesselSelection(vessel, quantity);
    });
    card.querySelector('.vessel-buy-btn').addEventListener('click', () => {
      const quantityInput = card.querySelector('.vessel-quantity-input');
      const quantity = parseInt(quantityInput.value) || 1;
      purchaseSingleVessel(vessel, quantity);
    });

    grid.appendChild(card);
  });

  feed.innerHTML = '';
  feed.appendChild(grid);
}

export function showEngineFilterOverlay() {
  const overlay = document.getElementById('engineFilterOverlay');
  const listContainer = document.getElementById('engineFilterList');

  const engineTypes = [...new Set(allAcquirableVessels.map(v => v.engine_type))].sort();

  let html = '&lt;div style="max-width: 800px; margin: 0 auto;">';

  html += `
    &lt;div class="chat-selection-item" data-engine="" style="cursor: pointer; padding: 15px; background: ${!selectedEngineType ? 'rgba(16, 185, 129, 0.2)' : 'rgba(31, 41, 55, 0.4)'}; border: 1px solid ${!selectedEngineType ? 'rgba(16, 185, 129, 0.4)' : 'rgba(255, 255, 255, 0.1)'}; border-radius: 8px; transition: all 0.2s; margin-bottom: 10px;">
      &lt;div style="font-weight: 600; color: #e0e0e0;">All Engines&lt;/div>
      &lt;div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">Show all vessels&lt;/div>
    &lt;/div>
  `;

  html += '&lt;div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">';

  engineTypes.forEach((engineType, index) => {
    const count = allAcquirableVessels.filter(v => v.engine_type === engineType).length;
    const isSelected = selectedEngineType === engineType;
    const isLastAndOdd = (index === engineTypes.length - 1) &amp;&amp; (engineTypes.length % 2 !== 0);

    html += `
      &lt;div class="chat-selection-item engine-filter-item${isSelected ? ' selected' : ''}" data-engine="${engineType}" style="cursor: pointer; padding: 15px; border: 1px solid ${isSelected ? 'rgba(16, 185, 129, 0.4)' : 'rgba(255, 255, 255, 0.1)'}; border-radius: 8px; transition: all 0.2s;${isLastAndOdd ? ' grid-column: 1 / -1; max-width: 50%; margin: 0 auto;' : ''}">
        &lt;div style="font-weight: 600; color: #e0e0e0;"> ${engineType}&lt;/div>
        &lt;div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">${count} vessel${count === 1 ? '' : 's'} available&lt;/div>
      &lt;/div>
    `;
  });

  html += '&lt;/div>&lt;/div>';
  listContainer.innerHTML = html;

  listContainer.querySelectorAll('.chat-selection-item').forEach(item => {
    item.addEventListener('click', () => {
      const engineType = item.getAttribute('data-engine');
      selectedEngineType = engineType || null;

      if (selectedEngineType) {
        document.getElementById('filterContainerBtn').classList.remove('active');
        document.getElementById('filterTankerBtn').classList.remove('active');
        document.getElementById('filterEngineBtn').classList.add('active');
      } else {
        document.getElementById('filterEngineBtn').classList.remove('active');
        if (currentVesselFilter === 'container') {
          document.getElementById('filterContainerBtn').classList.add('active');
        } else {
          document.getElementById('filterTankerBtn').classList.add('active');
        }
      }

      overlay.classList.add('hidden');
      displayVessels();
    });
  });

  overlay.classList.remove('hidden');
}

export function closeEngineFilterOverlay() {
  document.getElementById('engineFilterOverlay').classList.add('hidden');
}

function toggleVesselSelection(vessel, quantity) {
  const index = selectedVessels.findIndex(v => v.vessel.id === vessel.id);

  if (index > -1) {
    // Add to existing quantity
    selectedVessels[index].quantity += quantity;
  } else {
    // Add new item to cart
    selectedVessels.push({ vessel, quantity });
  }

  saveCartToStorage();
  updateCartBadge();
  displayVessels();
}

function updateCartBadge() {
  const totalCount = selectedVessels.reduce((sum, item) => sum + item.quantity, 0);
  const selectedCountEl = document.getElementById('selectedCount');
  const cartBtn = document.getElementById('cartBtn');
  const cartCountEl = document.getElementById('cartCount');

  if (selectedCountEl) selectedCountEl.textContent = totalCount;
  if (cartCountEl) cartCountEl.textContent = totalCount;
  if (cartBtn) {
    if (selectedVessels.length > 0) {
      cartBtn.classList.remove('hidden');
    } else {
      cartBtn.classList.add('hidden');
    }
  }
}

function removeFromCart(vesselId) {
  selectedVessels = selectedVessels.filter(v => v.vessel.id !== vesselId);
  saveCartToStorage();
  updateCartBadge();
  displayVessels();
}

function updateCartItemQuantity(vesselId, newQuantity) {
  const index = selectedVessels.findIndex(v => v.vessel.id === vesselId);
  if (index > -1 &amp;&amp; newQuantity > 0) {
    selectedVessels[index].quantity = newQuantity;
    saveCartToStorage();
    updateCartBadge();
  }
}

export function showShoppingCart() {
  if (selectedVessels.length === 0) {
    showSideNotification('Cart is empty', 'info');
    return;
  }

  const bunkerState = getCurrentBunkerState();

  // Calculate total
  const totalCost = selectedVessels.reduce((sum, item) => sum + (item.vessel.price * item.quantity), 0);
  const totalItems = selectedVessels.reduce((sum, item) => sum + item.quantity, 0);
  const affordable = bunkerState.currentCash >= totalCost;

  const overlay = document.createElement('div');
  overlay.className = 'confirm-dialog-overlay';

  const dialog = document.createElement('div');
  dialog.className = 'confirm-dialog shopping-cart-dialog';

  // Build cart items HTML in invoice style
  const cartItemsHtml = selectedVessels.map(item => `
    &lt;div class="cart-item invoice-line" data-vessel-id="${item.vessel.id}">
      &lt;span class="invoice-name">${escapeHtml(item.vessel.name)}&lt;/span>
      &lt;span class="invoice-unit-price">$${formatNumber(item.vessel.price)}&lt;/span>
      &lt;div class="invoice-quantity-controls">
        &lt;button class="cart-qty-btn minus" data-vessel-id="${item.vessel.id}">&lt;/button>
        &lt;span class="cart-qty-display">${item.quantity}&lt;/span>
        &lt;button class="cart-qty-btn plus" data-vessel-id="${item.vessel.id}">+&lt;/button>
      &lt;/div>
      &lt;span class="invoice-total">$${formatNumber(item.vessel.price * item.quantity)}&lt;/span>
      &lt;button class="remove-btn-small" data-vessel-id="${item.vessel.id}" title="Remove">&lt;/button>
    &lt;/div>
  `).join('');

  dialog.innerHTML = `
    &lt;div class="confirm-dialog-header invoice-header">
      &lt;h3>Purchase Order Summary&lt;/h3>
      &lt;div class="confirm-dialog-buttons">
        &lt;button class="confirm-dialog-btn cancel" data-action="cancel">Cancel&lt;/button>
        &lt;button class="confirm-dialog-btn confirm ${!affordable ? 'disabled' : ''}" data-action="checkout" ${!affordable ? 'disabled' : ''}>Confirm Purchase&lt;/button>
      &lt;/div>
    &lt;/div>
    &lt;div class="confirm-dialog-body invoice-body">
      &lt;div class="invoice-header-row">
        &lt;span class="invoice-name">Vessel&lt;/span>
        &lt;span class="invoice-unit-price">Price&lt;/span>
        &lt;span class="invoice-quantity">Qty&lt;/span>
        &lt;span class="invoice-total">Total&lt;/span>
        &lt;span class="invoice-action">&lt;/span>
      &lt;/div>
      &lt;div class="cart-items invoice-items">
        ${cartItemsHtml}
      &lt;/div>
      &lt;div class="invoice-separator">&lt;/div>
      &lt;div class="invoice-totals">
        &lt;div class="invoice-total-row">
          &lt;span class="invoice-total-label">Total Vessels:&lt;/span>
          &lt;span class="invoice-total-value">${totalItems}&lt;/span>
        &lt;/div>
        &lt;div class="invoice-total-row">
          &lt;span class="invoice-total-label">Cash Available:&lt;/span>
          &lt;span class="invoice-total-value">$${formatNumber(bunkerState.currentCash)}&lt;/span>
        &lt;/div>
        &lt;div class="invoice-total-row grand-total ${!affordable ? 'too-expensive' : ''}">
          &lt;span class="invoice-total-label">Total Amount:&lt;/span>
          &lt;span class="invoice-total-value">$${formatNumber(totalCost)}&lt;/span>
        &lt;/div>
      &lt;/div>
    &lt;/div>
  `;

  overlay.appendChild(dialog);
  document.body.appendChild(overlay);

  // Handle close
  const handleClose = () => {
    overlay.remove();
  };

  // Handle checkout
  const handleCheckout = () => {
    overlay.remove();
    purchaseBulk();
  };

  // Button handlers
  dialog.querySelector('[data-action="cancel"]').addEventListener('click', handleClose);
  const checkoutBtn = dialog.querySelector('[data-action="checkout"]');
  if (checkoutBtn &amp;&amp; !checkoutBtn.disabled) {
    checkoutBtn.addEventListener('click', handleCheckout);
  }

  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) handleClose();
  });

  // Quantity controls
  dialog.querySelectorAll('.cart-qty-btn.minus').forEach(btn => {
    btn.addEventListener('click', () => {
      const vesselId = parseInt(btn.dataset.vesselId);
      const item = selectedVessels.find(v => v.vessel.id === vesselId);
      if (item &amp;&amp; item.quantity > 1) {
        updateCartItemQuantity(vesselId, item.quantity - 1);
        overlay.remove();
        showShoppingCart(); // Refresh dialog
      }
    });
  });

  dialog.querySelectorAll('.cart-qty-btn.plus').forEach(btn => {
    btn.addEventListener('click', () => {
      const vesselId = parseInt(btn.dataset.vesselId);
      const item = selectedVessels.find(v => v.vessel.id === vesselId);
      if (item &amp;&amp; item.quantity &lt; 99) {
        updateCartItemQuantity(vesselId, item.quantity + 1);
        overlay.remove();
        showShoppingCart(); // Refresh dialog
      }
    });
  });

  // Remove buttons
  dialog.querySelectorAll('.cart-remove-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const vesselId = parseInt(btn.dataset.vesselId);
      removeFromCart(vesselId);

      if (selectedVessels.length === 0) {
        overlay.remove();
        showSideNotification('Cart is now empty', 'info');
      } else {
        overlay.remove();
        showShoppingCart(); // Refresh dialog
      }
    });
  });
}

/**
 * Purchases one or more copies of a specific vessel with confirmation and sequential processing.
 * Handles single and multi-quantity purchases with affordability checks and rate limiting.
 *
 * Purchase Flow:
 * 1. Calculate total cost (price  quantity)
 * 2. Build confirmation dialog with itemized list
 * 3. Show affordability indicator (green/red)
 * 4. Process purchases sequentially with 1.5s delays
 * 5. Update cash after each successful purchase
 * 6. Handle errors (limit reached, insufficient funds, network errors)
 * 7. Remove from selection list
 * 8. Refresh vessel catalog and counts
 *
 * Error Handling:
 * - 'vessel_limit_reached': Stops purchasing, shows count purchased
 * - 'not_enough_cash': Stops purchasing, shows count purchased
 * - Other errors: Shows error but may continue with remaining
 * - Network errors: Logs and shows feedback
 *
 * Rate Limiting:
 * - 1.5 second delay between purchases to prevent API throttling
 * - No delay after final purchase
 *
 * Side Effects:
 * - Shows confirmation dialog
 * - Makes multiple API calls (one per vessel)
 * - Updates cash after each purchase
 * - Removes from selectedVessels array
 * - Updates selection count badge
 * - Triggers vessel count refresh
 * - Reloads vessel catalog
 * - Shows success/error feedback
 *
 * @async
 * @param {Object} vessel - Vessel object to purchase
 * @param {number} [quantity=1] - Number of copies to purchase
 * @returns {Promise&lt;void>}
 *
 * @example
 * // Buy 3 copies of a container vessel
 * purchaseSingleVessel(vesselObject, 3);
 */
export async function purchaseSingleVessel(vessel, quantity = 1) {
  const bunkerState = getCurrentBunkerState();
  const totalCost = vessel.price * quantity;

  if (window.DEBUG_MODE) console.log('[Purchase Vessel] Bunker state:', bunkerState);
  if (bunkerState.currentCash === 0) {
    console.warn('[Purchase Vessel] WARNING: currentCash is 0! This may indicate bunker data not loaded yet.');
  }

  const vesselDetails = [];
  for (let i = 0; i &lt; quantity; i++) {
    vesselDetails.push({
      label: `${i + 1}. ${vessel.name}`,
      value: `$${formatNumber(vessel.price)}`
    });
  }
  vesselDetails.push({
    label: 'Total Cost',
    value: `$${formatNumber(totalCost)}`
  });
  vesselDetails.push({
    label: 'Cash Available',
    value: `$${formatNumber(bunkerState.currentCash)}`
  });

  const confirmed = await showConfirmDialog({
    title: `Purchase ${quantity > 1 ? `${quantity} Vessels` : 'Vessel'}`,
    message: quantity > 1 ? 'Purchasing multiple vessels with 1.5s delay between each:' : null,
    details: vesselDetails,
    confirmText: 'Buy',
    cancelText: 'Cancel'
  });

  if (!confirmed) return;

  let successCount = 0;
  const purchasedVessels = [];

  for (let i = 0; i &lt; quantity; i++) {
    try {
      const data = await apiPurchaseVessel(vessel.id, vessel.name, vessel.antifouling, true); // silent=true

      if (data.error) {
        if (data.error === 'vessel_limit_reached') {
          const msg = successCount > 0
            ? ` &lt;strong>Vessel limit reached! Purchased ${successCount} vessel(s), cannot buy more.&lt;/strong>`
            : ` &lt;strong>Vessel limit reached! Cannot purchase any vessels.&lt;/strong>`;
          showSideNotification(msg, 'error', null, false);
          break;
        } else if (data.error === 'not_enough_cash') {
          const msg = successCount > 0
            ? ` &lt;strong>Not enough cash! Purchased ${successCount} vessel(s), ran out of money.&lt;/strong>`
            : ` &lt;strong>Not enough cash! Cannot afford this vessel.&lt;/strong>`;
          showSideNotification(msg, 'error', null, true);
          break;
        } else {
          const msg = successCount > 0
            ? ` &lt;strong>Error: ${data.error} - Purchased ${successCount} so far&lt;/strong>`
            : ` &lt;strong>Error: ${data.error}&lt;/strong>`;
          showSideNotification(msg, 'error');
        }
      } else {
        successCount++;
        purchasedVessels.push({ name: vessel.name, price: vessel.price });
        if (data.user &amp;&amp; data.user.cash !== undefined) {
          updateCurrentCash(data.user.cash);
        }
      }

      if (i &lt; quantity - 1) {
        await new Promise(resolve => setTimeout(resolve, 1500));
      }
    } catch (error) {
      console.error('Error purchasing vessel:', error);
      showSideNotification(` &lt;strong>Network error purchasing ${vessel.name}&lt;/strong>`, 'error', null, true);
    }
  }

  // Send summary notification to backend (broadcasts to ALL clients)
  if (successCount > 0) {
    try {
      const totalCost = purchasedVessels.reduce((sum, v) => sum + v.price, 0);
      await fetch(`${window.API_PREFIX}/vessel/broadcast-purchase-summary`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ vessels: purchasedVessels, totalCost })
      });
    } catch (error) {
      console.error('Error broadcasting purchase summary:', error);
    }
  }

  if (successCount > 0 &amp;&amp; window.updateVesselCount) {
    await updateVesselCount();
  }

  selectedVessels = selectedVessels.filter(v => v.vessel.id !== vessel.id);
  updateCartBadge();

  await loadAcquirableVessels(true);
}

export async function purchaseBulk() {
  if (selectedVessels.length === 0) return;

  const bunkerState = getCurrentBunkerState();
  const vesselDetails = [];
  let totalCost = 0;
  let itemNumber = 1;

  if (window.DEBUG_MODE) console.log('[Purchase Bulk] Bunker state:', bunkerState);
  if (bunkerState.currentCash === 0) {
    console.warn('[Purchase Bulk] WARNING: currentCash is 0! This may indicate bunker data not loaded yet.');
  }

  selectedVessels.forEach(item => {
    for (let i = 0; i &lt; item.quantity; i++) {
      vesselDetails.push({
        label: `${itemNumber}. ${item.vessel.name}`,
        value: `$${formatNumber(item.vessel.price)}`
      });
      totalCost += item.vessel.price;
      itemNumber++;
    }
  });

  vesselDetails.push({
    label: 'Total Cost',
    value: `$${formatNumber(totalCost)}`
  });
  vesselDetails.push({
    label: 'Cash Available',
    value: `$${formatNumber(bunkerState.currentCash)}`
  });

  const totalVesselCount = selectedVessels.reduce((sum, item) => sum + item.quantity, 0);

  const confirmed = await showConfirmDialog({
    title: `Bulk Purchase (${totalVesselCount} Vessels)`,
    message: 'Purchasing vessels sequentially with 1.5s delay between each:',
    details: vesselDetails,
    confirmText: 'Buy All',
    cancelText: 'Cancel'
  });

  if (!confirmed) return;

  // Broadcast bulk buy start to lock buttons on all clients
  try {
    await fetch(`${window.API_PREFIX}/vessel/bulk-buy-start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
  } catch (error) {
    console.error('Error broadcasting bulk buy start:', error);
  }

  const cartBtn = document.getElementById('cartBtn');
  cartBtn.disabled = true;
  cartBtn.textContent = 'Purchasing...';

  let successCount = 0;
  const purchasedVessels = [];

  for (let i = 0; i &lt; selectedVessels.length; i++) {
    const item = selectedVessels[i];

    for (let q = 0; q &lt; item.quantity; q++) {
      try {
        const data = await apiPurchaseVessel(item.vessel.id, item.vessel.name, item.vessel.antifouling, true); // silent=true

        if (data.error) {
          console.error(`Failed to purchase ${item.vessel.name}:`, data.error);

          if (data.error === 'vessel_limit_reached') {
            const msg = successCount > 0
              ? ` &lt;strong>Vessel limit reached! Purchased ${successCount} vessel(s), could not buy more.&lt;/strong>`
              : ` &lt;strong>Vessel limit reached! Cannot purchase any vessels.&lt;/strong>`;
            showSideNotification(msg, 'error', null, false);
            i = selectedVessels.length;
            break;
          } else if (data.error === 'not_enough_cash') {
            const msg = successCount > 0
              ? ` &lt;strong>Not enough cash! Purchased ${successCount} vessel(s), ran out of money.&lt;/strong>`
              : ` &lt;strong>Not enough cash! Cannot afford any vessels.&lt;/strong>`;
            showSideNotification(msg, 'error', null, true);
            i = selectedVessels.length;
            break;
          } else {
            const msg = successCount > 0
              ? ` &lt;strong>Error: ${data.error} - Purchased ${successCount} so far&lt;/strong>`
              : ` &lt;strong>Error: ${data.error}&lt;/strong>`;
            showSideNotification(msg, 'error');
          }
        } else {
          successCount++;
          purchasedVessels.push({ name: item.vessel.name, price: item.vessel.price });
          if (data.user &amp;&amp; data.user.cash !== undefined) {
            updateCurrentCash(data.user.cash);
          }
        }
      } catch (error) {
        console.error(`Error purchasing ${item.vessel.name}:`, error);
        showSideNotification(` &lt;strong>Network error purchasing ${item.vessel.name}&lt;/strong>`, 'error', null, true);
      }

      await new Promise(resolve => setTimeout(resolve, 1500));
    }
  }

  // Send summary notification to backend (broadcasts to ALL clients)
  if (successCount > 0) {
    try {
      const purchaseTotalCost = purchasedVessels.reduce((sum, v) => sum + v.price, 0);
      await fetch(`${window.API_PREFIX}/vessel/broadcast-purchase-summary`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ vessels: purchasedVessels, totalCost: purchaseTotalCost })
      });
    } catch (error) {
      console.error('Error broadcasting purchase summary:', error);
    }
  } else {
    // If no successful purchases, still need to broadcast complete to unlock buttons
    try {
      await fetch(`${window.API_PREFIX}/vessel/broadcast-purchase-summary`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ vessels: [], totalCost: 0 })
      });
    } catch (error) {
      console.error('Error broadcasting bulk buy complete:', error);
    }
  }

  if (cartBtn) {
    cartBtn.disabled = false;
    cartBtn.textContent = ` Cart (0)`;
    cartBtn.classList.add('hidden');
  }

  selectedVessels = [];
  saveCartToStorage(); // Clear cart from localStorage
  const selectedCountEl = document.getElementById('selectedCount');
  if (selectedCountEl) selectedCountEl.textContent = '0';

  // Backend broadcasts notification to ALL clients via WebSocket
  // No need to show notification here - all clients will receive it

  if (successCount > 0 &amp;&amp; window.updateVesselCount) {
    await updateVesselCount();
  }

  await loadAcquirableVessels(true);
}

export function setVesselFilter(filter) {
  currentVesselFilter = filter;
  selectedEngineType = null;
}

export function getVesselFilter() {
  return currentVesselFilter;
}

/**
 * Locks the depart button when autopilot or manual departure starts.
 * Called by WebSocket handler when 'autopilot_depart_start' is received.
 * UI-ONLY function - state is managed by server via lock_status events.
 * @global
 */
export function lockDepartButton() {
  updateButtonState('departAll', true);
  if (window.DEBUG_MODE) console.log('[Depart Button] Locked (UI only) - departure in progress');
}

/**
 * Unlocks the depart button when departure process completes.
 * Called by WebSocket handler when 'vessels_depart_complete' is received.
 * UI-ONLY function - state is managed by server via lock_status events.
 * @global
 */
export function unlockDepartButton() {
  // Check if there are vessels ready to depart
  const countBadge = document.querySelector('.map-icon-item[data-action="departAll"] .map-icon-badge');
  const hasVessels = countBadge &amp;&amp; !countBadge.classList.contains('hidden') &amp;&amp; parseInt(countBadge.textContent) > 0;
  updateButtonState('departAll', !hasVessels);
  if (window.DEBUG_MODE) console.log('[Depart Button] Unlocked (UI only) - departure complete');
}

/**
 * Returns whether a departure operation is currently in progress.
 * Used to prevent button state changes during departure.
 * Returns server-controlled lock state (READ-ONLY).
 * @global
 * @returns {boolean} True if departure is in progress
 */
export function isDepartInProgress() {
  return serverLockState.depart;
}

/**
 * Locks the repair button when repair process starts.
 * Called by WebSocket handler when 'repair_start' is received.
 * UI-ONLY function - state is managed by server via lock_status events.
 * @global
 */
export function lockRepairButton() {
  updateButtonState('repairAll', true);
  if (window.DEBUG_MODE) console.log('[Repair Button] Locked (UI only) - repair in progress');
}

/**
 * Unlocks the repair button when repair process completes.
 * Called by WebSocket handler when 'repair_complete' is received.
 * UI-ONLY function - state is managed by server via lock_status events.
 * @global
 */
export function unlockRepairButton() {
  updateButtonState('repairAll', false);
  if (window.DEBUG_MODE) console.log('[Repair Button] Unlocked (UI only) - repair complete');
}

/**
 * Locks the bulk buy (cart) button when bulk purchase starts.
 * Called by WebSocket handler when 'bulk_buy_start' is received.
 * UI-ONLY function - state is managed by server via lock_status events.
 * @global
 */
export function lockBulkBuyButton() {
  const cartBtn = document.getElementById('cartBtn');
  if (cartBtn) {
    cartBtn.disabled = true;
  }
  if (window.DEBUG_MODE) console.log('[Bulk Buy Button] Locked (UI only) - bulk purchase in progress');
}

/**
 * Unlocks the bulk buy (cart) button when bulk purchase completes.
 * Called by WebSocket handler when 'bulk_buy_complete' is received.
 * UI-ONLY function - state is managed by server via lock_status events.
 * @global
 */
export function unlockBulkBuyButton() {
  const cartBtn = document.getElementById('cartBtn');
  if (cartBtn) {
    cartBtn.disabled = false;
  }
  if (window.DEBUG_MODE) console.log('[Bulk Buy Button] Unlocked (UI only) - bulk purchase complete');
}

/**
 * Locks the fuel purchase button.
 * Called by WebSocket handler when 'fuel_purchase_start' is received.
 * UI-ONLY function - state is managed by server via lock_status events.
 * @global
 */
export function lockFuelButton() {
  const fuelBtn = document.getElementById('fuelBtn');
  if (fuelBtn) {
    fuelBtn.disabled = true;
  }
  if (window.DEBUG_MODE) console.log('[Fuel Button] Locked (UI only) - fuel purchase in progress');
}

/**
 * Unlocks the fuel purchase button.
 * Called by WebSocket handler when 'fuel_purchase_complete' is received.
 * UI-ONLY function - state is managed by server via lock_status events.
 * @global
 */
export function unlockFuelButton() {
  const fuelBtn = document.getElementById('fuelBtn');
  if (fuelBtn) {
    fuelBtn.disabled = false;
  }
  if (window.DEBUG_MODE) console.log('[Fuel Button] Unlocked (UI only) - fuel purchase complete');
}

/**
 * Locks the CO2 purchase button.
 * Called by WebSocket handler when 'co2_purchase_start' is received.
 * UI-ONLY function - state is managed by server via lock_status events.
 * @global
 */
export function lockCo2Button() {
  const co2Btn = document.getElementById('co2Btn');
  if (co2Btn) {
    co2Btn.disabled = true;
  }
  if (window.DEBUG_MODE) console.log('[CO2 Button] Locked (UI only) - CO2 purchase in progress');
}

/**
 * Unlocks the CO2 purchase button.
 * Called by WebSocket handler when 'co2_purchase_complete' is received.
 * UI-ONLY function - state is managed by server via lock_status events.
 * @global
 */
export function unlockCo2Button() {
  const co2Btn = document.getElementById('co2Btn');
  if (co2Btn) {
    co2Btn.disabled = false;
  }
  if (window.DEBUG_MODE) console.log('[CO2 Button] Unlocked (UI only) - CO2 purchase complete');
}

/**
 * Locks the drydock button when drydock process starts.
 * Called by WebSocket handler when 'drydock_start' is received.
 * UI-ONLY function - state is managed by server via lock_status events.
 * @global
 */
export function lockDrydockButton() {
  updateButtonState('drydockAll', true);
  if (window.DEBUG_MODE) console.log('[Drydock Button] Locked (UI only) - drydock in progress');
}

/**
 * Unlocks the drydock button when drydock process completes.
 * Called by WebSocket handler when 'drydock_complete' is received.
 * UI-ONLY function - state is managed by server via lock_status events.
 * @global
 */
export function unlockDrydockButton() {
  updateButtonState('drydockAll', false);
  if (window.DEBUG_MODE) console.log('[Drydock Button] Unlocked (UI only) - drydock complete');
}

// ===== NEW FILTER SYSTEM =====

/**
 * Populate dynamic filter dropdowns based on actual vessel data
 */
function populateDynamicFilters() {
  if (window.DEBUG_MODE) console.log('[Filters] Populating dynamic filters from', allAcquirableVessels.length, 'vessels');

  // Price Range: 500k steps up to 10M, then 10M steps to 100M, then 50M steps to 200M
  const priceMin = document.getElementById('priceMin');
  const priceMax = document.getElementById('priceMax');
  priceMin.innerHTML = '&lt;option value="0">0&lt;/option>';
  priceMax.innerHTML = '';

  // 500k steps: 0.5M to 10M
  for (let price = 500000; price &lt;= 10000000; price += 500000) {
    const label = `${(price / 1000000).toFixed(1)}M`;
    priceMin.innerHTML += `&lt;option value="${price}">${label}&lt;/option>`;
    priceMax.innerHTML += `&lt;option value="${price}">${label}&lt;/option>`;
  }

  // 10M steps: 10M to 100M
  for (let price = 10000000; price &lt;= 100000000; price += 10000000) {
    const label = `${(price / 1000000)}M`;
    priceMin.innerHTML += `&lt;option value="${price}">${label}&lt;/option>`;
    priceMax.innerHTML += `&lt;option value="${price}">${label}&lt;/option>`;
  }

  // 50M steps: 100M to 200M
  for (let price = 100000000; price &lt;= 200000000; price += 50000000) {
    const label = `${(price / 1000000)}M`;
    priceMin.innerHTML += `&lt;option value="${price}">${label}&lt;/option>`;
    priceMax.innerHTML += `&lt;option value="${price}">${label}&lt;/option>`;
  }

  // Add "max" option for priceMax
  priceMax.innerHTML += '&lt;option value="Infinity">max&lt;/option>';
  priceMax.value = 'Infinity';

  // Year Built: All unique years from vessel data (MOVED TO BOTTOM - unwichtig)
  const years = [...new Set(allAcquirableVessels.map(v => v.year))].sort((a, b) => a - b);
  const yearMin = document.getElementById('yearMin');
  const yearMax = document.getElementById('yearMax');
  yearMin.innerHTML = `&lt;option value="0">${years[0]}&lt;/option>`;
  yearMax.innerHTML = `&lt;option value="9999">${years[years.length - 1]}&lt;/option>`;

  years.forEach(year => {
    yearMin.innerHTML += `&lt;option value="${year}">${year}&lt;/option>`;
    yearMax.innerHTML += `&lt;option value="${year}">${year}&lt;/option>`;
  });
  yearMax.value = '9999';

  // Engine Type: Multiselect with all unique engine types
  // CRITICAL: Only "All Engines" should be selected by default, NOT all individual options
  const engineTypes = [...new Set(allAcquirableVessels.map(v => v.engine_type))].sort();
  const engineSelect = document.getElementById('engineType');
  engineSelect.innerHTML = '&lt;option value="all" selected>All Engines&lt;/option>';

  engineTypes.forEach(engineType => {
    const displayName = engineType.toUpperCase().replace(/_/g, ' ');
    // NOT selected by default - user must select manually
    engineSelect.innerHTML += `&lt;option value="${engineType}">${displayName}&lt;/option>`;
  });

  // Max Speed: 5kn steps from min to max speed (NO "kn" in dropdown, it's in title)
  const speeds = allAcquirableVessels.map(v => v.max_speed);
  const minSpeed = Math.floor(Math.min(...speeds) / 5) * 5;
  const maxSpeed = Math.ceil(Math.max(...speeds) / 5) * 5;
  const speedMin = document.getElementById('speedMin');
  const speedMax = document.getElementById('speedMax');
  speedMin.innerHTML = `&lt;option value="0">${minSpeed}&lt;/option>`;
  speedMax.innerHTML = `&lt;option value="999">${maxSpeed}&lt;/option>`;

  for (let speed = minSpeed; speed &lt;= maxSpeed; speed += 5) {
    speedMin.innerHTML += `&lt;option value="${speed}">${speed}&lt;/option>`;
    speedMax.innerHTML += `&lt;option value="${speed}">${speed}&lt;/option>`;
  }
  speedMax.value = '999';

  // Service Hours: 50h steps from min to max (NO "h" in dropdown, it's in title)
  const serviceHours = allAcquirableVessels.map(v => v.hours_between_service);
  const minService = Math.floor(Math.min(...serviceHours) / 50) * 50;
  const maxService = Math.ceil(Math.max(...serviceHours) / 50) * 50;
  const serviceMin = document.getElementById('serviceMin');
  const serviceMax = document.getElementById('serviceMax');
  serviceMin.innerHTML = `&lt;option value="0">${minService}&lt;/option>`;
  serviceMax.innerHTML = '';

  for (let service = minService; service &lt;= maxService; service += 50) {
    serviceMin.innerHTML += `&lt;option value="${service}">${service}&lt;/option>`;
    serviceMax.innerHTML += `&lt;option value="${service}">${service}&lt;/option>`;
  }

  // Add "max" option for serviceMax
  serviceMax.innerHTML += '&lt;option value="Infinity">max&lt;/option>';
  serviceMax.value = 'Infinity';

  // Fuel Factor: 0.5 steps from ACTUAL min to max (NOT from 0!)
  const fuelFactors = allAcquirableVessels.map(v => v.fuel_factor);
  const minFuel = Math.floor(Math.min(...fuelFactors) * 2) / 2;
  const maxFuel = Math.ceil(Math.max(...fuelFactors) * 2) / 2;
  const fuelMin = document.getElementById('fuelFactorMin');
  const fuelMax = document.getElementById('fuelFactorMax');
  fuelMin.innerHTML = '';
  fuelMax.innerHTML = '';

  for (let fuel = minFuel; fuel &lt;= maxFuel; fuel += 0.5) {
    fuelMin.innerHTML += `&lt;option value="${fuel}">${fuel.toFixed(1)}&lt;/option>`;
    fuelMax.innerHTML += `&lt;option value="${fuel}">${fuel.toFixed(1)}&lt;/option>`;
  }
  fuelMin.value = minFuel.toString();
  fuelMax.value = maxFuel.toString();

  // CO2 Factor: 0.5 steps from ACTUAL min to max (NOT from 0!)
  const co2Factors = allAcquirableVessels.map(v => v.co2_factor);
  const minCO2 = Math.floor(Math.min(...co2Factors) * 2) / 2;
  const maxCO2 = Math.ceil(Math.max(...co2Factors) * 2) / 2;
  const co2Min = document.getElementById('co2FactorMin');
  const co2Max = document.getElementById('co2FactorMax');
  co2Min.innerHTML = '';
  co2Max.innerHTML = '';

  for (let co2 = minCO2; co2 &lt;= maxCO2; co2 += 0.5) {
    co2Min.innerHTML += `&lt;option value="${co2}">${co2.toFixed(1)}&lt;/option>`;
    co2Max.innerHTML += `&lt;option value="${co2}">${co2.toFixed(1)}&lt;/option>`;
  }
  co2Min.value = minCO2.toString();
  co2Max.value = maxCO2.toString();

  // Capacity: Dynamic based on which vessel types are selected
  updateCapacityDropdowns();

  if (window.DEBUG_MODE) {
    console.log('[Filters] Dynamic filters populated:', {
      years: years.length,
      engineTypes: engineTypes.length,
      speedRange: `${minSpeed}-${maxSpeed}kn`,
      serviceRange: `${minService}-${maxService}h`,
      fuelFactorRange: `${minFuel}-${maxFuel}`,
      co2FactorRange: `${minCO2}-${maxCO2}`
    });
  }
}

/**
 * Update capacity dropdowns based on selected vessel types
 * Shows/hides TEU and BBL sections depending on which vessel types are selected
 */
function updateCapacityDropdowns() {
  const vesselTypeCheckboxes = document.querySelectorAll('input[name="vesselType"]:checked');
  const selectedTypes = Array.from(vesselTypeCheckboxes).map(cb => cb.value);

  const teuSection = document.getElementById('capacityTEUSection');
  const bblSection = document.getElementById('capacityBBLSection');

  // Show/hide sections based on selected types
  if (selectedTypes.includes('container')) {
    teuSection.classList.remove('hidden');

    // Get actual max TEU from API (min always starts at 0)
    const containerCapacities = allAcquirableVessels
      .filter(v => v.capacity_type === 'container')
      .map(v => v.capacity_max || 0);

    if (containerCapacities.length === 0) {
      teuSection.classList.add('hidden');
      return;
    }

    const apiMaxTEU = Math.max(...containerCapacities);

    // Fixed step sizes: 0 | 50 | 100 | 250 | 500 | 1k | 2k | 3k | 4k | 5k | 10k | 15k | 20k | 25k
    const teuSteps = [0, 50, 100, 250, 500, 1000, 2000, 3000, 4000, 5000, 10000, 15000, 20000, 25000];

    // Filter steps to only include values &lt;= API max
    const validSteps = teuSteps.filter(step => step &lt;= apiMaxTEU);

    // Always include actual max from API
    const finalSteps = [...new Set([...validSteps, apiMaxTEU])].sort((a, b) => a - b);

    const capacityMinTEU = document.getElementById('capacityMinTEU');
    const capacityMaxTEU = document.getElementById('capacityMaxTEU');
    capacityMinTEU.innerHTML = '';
    capacityMaxTEU.innerHTML = '';

    // Populate Min dropdown
    finalSteps.forEach(cap => {
      const label = cap >= 1000 ? `${(cap / 1000)}k` : `${cap}`;
      capacityMinTEU.innerHTML += `&lt;option value="${cap}">${label}&lt;/option>`;
    });

    // Populate Max dropdown (with steps + "max" option)
    finalSteps.forEach(cap => {
      const label = cap >= 1000 ? `${(cap / 1000)}k` : `${cap}`;
      capacityMaxTEU.innerHTML += `&lt;option value="${cap}">${label}&lt;/option>`;
    });
    // Add "max" option (value = Infinity to show all vessels >= minValue)
    capacityMaxTEU.innerHTML += `&lt;option value="Infinity">max&lt;/option>`;

    capacityMinTEU.value = 0;
    capacityMaxTEU.value = 'Infinity';  // Default to "max"

    if (window.DEBUG_MODE) console.log('[Filters] TEU range:', { min: 0, apiMax: apiMaxTEU, steps: finalSteps });
  } else {
    teuSection.classList.add('hidden');
  }

  if (selectedTypes.includes('tanker')) {
    bblSection.classList.remove('hidden');

    // Get actual max BBL from API (min always starts at 0)
    const tankerCapacities = allAcquirableVessels
      .filter(v => v.capacity_type === 'tanker')
      .map(v => {
        const cap = v.capacity_max || {};
        return Math.max(
          cap.crude_oil || 0,
          cap.chemicals || 0,
          cap.lng || 0,
          cap.products || 0,
          cap.fuel || 0
        );
      });

    if (tankerCapacities.length === 0) {
      bblSection.classList.add('hidden');
      return;
    }

    const apiMaxBBL = Math.max(...tankerCapacities);

    // Fixed BBL step sizes: 0 | 5k | 10k | 25k | 50k | 75k | 100k | 150k | 200k | 250k | 300k | 400k | 500k | 750k | 1M
    const bblSteps = [0, 5000, 10000, 25000, 50000, 75000, 100000, 150000, 200000, 250000, 300000, 400000, 500000, 750000, 1000000];

    // Filter steps to only include values &lt;= API max
    const validSteps = bblSteps.filter(step => step &lt;= apiMaxBBL);

    // Always include actual max from API
    const finalSteps = [...new Set([...validSteps, apiMaxBBL])].sort((a, b) => a - b);

    const capacityMinBBL = document.getElementById('capacityMinBBL');
    const capacityMaxBBL = document.getElementById('capacityMaxBBL');
    capacityMinBBL.innerHTML = '';
    capacityMaxBBL.innerHTML = '';

    // Populate Min dropdown
    finalSteps.forEach(cap => {
      const label = cap >= 1000 ? `${(cap / 1000)}k` : `${cap}`;
      capacityMinBBL.innerHTML += `&lt;option value="${cap}">${label}&lt;/option>`;
    });

    // Populate Max dropdown (with steps + "max" option)
    finalSteps.forEach(cap => {
      const label = cap >= 1000 ? `${(cap / 1000)}k` : `${cap}`;
      capacityMaxBBL.innerHTML += `&lt;option value="${cap}">${label}&lt;/option>`;
    });
    // Add "max" option (value = Infinity to show all vessels >= minValue)
    capacityMaxBBL.innerHTML += `&lt;option value="Infinity">max&lt;/option>`;

    capacityMinBBL.value = 0;
    capacityMaxBBL.value = 'Infinity';  // Default to "max"

    if (window.DEBUG_MODE) console.log('[Filters] BBL range:', { min: 0, apiMax: apiMaxBBL, steps: finalSteps });
  } else {
    bblSection.classList.add('hidden');
  }
}

// Auto-apply filters when any filter input changes
document.addEventListener('DOMContentLoaded', () => {
  // Vessel type checkboxes: update capacity dropdowns AND apply filters
  document.querySelectorAll('input[name="vesselType"]').forEach(checkbox => {
    checkbox.addEventListener('change', () => {
      if (allAcquirableVessels.length > 0) {
        updateCapacityDropdowns();
        applyVesselFilters();
      }
    });
  });

  // Special checkboxes: apply filters on change
  document.querySelectorAll('input[name="special"]').forEach(checkbox => {
    checkbox.addEventListener('change', () => {
      if (allAcquirableVessels.length > 0) {
        applyVesselFilters();
      }
    });
  });

  // All filter dropdowns: apply filters on change
  const filterSelects = [
    'priceMin', 'priceMax',
    'yearMin', 'yearMax',
    'engineType',
    'speedMin', 'speedMax',
    'serviceMin', 'serviceMax',
    'fuelFactorMin', 'fuelFactorMax',
    'co2FactorMin', 'co2FactorMax',
    'capacityMin', 'capacityMax'
  ];

  filterSelects.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.addEventListener('change', () => {
        if (allAcquirableVessels.length > 0) {
          applyVesselFilters();
        }
      });
    }
  });
});

// ===== IMAGE CACHING SYSTEM =====
// Since same vessel.type = same image, cache images by type to avoid redundant loads
// Vessel image preloading completely handled in script.js STEP 8.5
// All vessel and harbor images are preloaded on page load in background

/**
 * Create a vessel card element with image caching
 */
function createVesselCard(vessel, isPending = false) {
  const imageUrl = `/api/vessel-image/${vessel.type}`;

  // Images are preloaded on page load (script.js STEP 8.5)
  // No need to check cache here - all images already loaded

  // Pending vessels don't show purchase buttons
  let isVesselTypeLocked = false;
  let availableSlots = 0;
  let canPurchase = false;

  if (!isPending) {
    // Check if user has unlocked this vessel type
    // Container is ALWAYS unlocked (everyone has it by default)
    // Tanker is locked until company_type includes "tanker"
    const userCompanyType = window.USER_COMPANY_TYPE;
    isVesselTypeLocked = vessel.capacity_type === 'tanker' &amp;&amp; (!userCompanyType || !userCompanyType.includes('tanker'));

    // Check if anchor slots are available
    availableSlots = getAvailableAnchorSlots();
    canPurchase = availableSlots > 0 &amp;&amp; !isVesselTypeLocked;
  }

  const capacityDisplay = getCapacityDisplay(vessel);
  const co2Class = getCO2EfficiencyClass(vessel.co2_factor);
  const fuelClass = getFuelEfficiencyClass(vessel.fuel_factor);

  let additionalAttrs = '';
  if (vessel.width &amp;&amp; vessel.width !== 0) {
    additionalAttrs += `&lt;div class="vessel-spec">&lt;strong>Width:&lt;/strong> ${vessel.width} m&lt;/div>`;
  }
  if (vessel.price_in_points &amp;&amp; vessel.price_in_points !== 0) {
    additionalAttrs += `&lt;div class="vessel-spec">&lt;strong>Points Price:&lt;/strong> ${formatNumber(vessel.price_in_points)}&lt;/div>`;
  }
  if (vessel.perks &amp;&amp; vessel.perks !== null) {
    additionalAttrs += `&lt;div class="vessel-spec vessel-spec-fullwidth">&lt;strong>Perks:&lt;/strong> ${vessel.perks}&lt;/div>`;
  }

  const card = document.createElement('div');
  card.className = isPending ? 'vessel-card pending-vessel' : 'vessel-card';
  card.innerHTML = `
    &lt;div class="vessel-image-container">
      &lt;img src="${imageUrl}" alt="${vessel.name}" class="vessel-image" onerror="this.src='data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 400 300%22>&lt;rect fill=%22%23374151%22 width=%22400%22 height=%22300%22/>&lt;text x=%2250%%22 y=%2250%%22 fill=%22%239ca3af%22 text-anchor=%22middle%22 font-size=%2224%22>&lt;/text>&lt;/svg>'">
      ${vessel.only_for_credits ? '&lt;div class="vessel-credits-overlay">$&lt;/div>' : ''}
      ${isVesselTypeLocked ? '&lt;div class="vessel-locked-overlay">&lt;div class="vessel-locked-banner"> Locked&lt;/div>&lt;div class="vessel-locked-text">Unlock ' + vessel.capacity_type + ' vessels first&lt;/div>&lt;/div>' : ''}
      ${isPending ? `&lt;div class="vessel-time-badge"> In Delivery ${(() => {
        const remaining = vessel.time_arrival || 0;
        if (remaining > 0) {
          const days = Math.floor(remaining / 86400);
          const hours = Math.floor((remaining % 86400) / 3600);
          const minutes = Math.floor((remaining % 3600) / 60);
          if (days > 0) return `${days}d ${hours}h`;
          if (hours > 0) return `${hours}h ${minutes}m`;
          return `${minutes}m`;
        }
        return 'Ready';
      })()}&lt;/div>` : ''}
      ${isPending ? '&lt;button class="vessel-locate-btn vessel-locate-btn-image" data-vessel-id="' + vessel.id + '" title="Show on map" onmouseover="this.querySelector(\'span\').style.animation=\'pulse-arrow 0.6s ease-in-out infinite\'" onmouseout="this.querySelector(\'span\').style.animation=\'none\'">&lt;span>&lt;/span>&lt;/button>' : ''}
    &lt;/div>
    &lt;div class="vessel-content">
      &lt;div class="vessel-header">
        &lt;h3 class="vessel-name">${vessel.name}&lt;/h3>
        &lt;div class="vessel-price">$${formatNumber(vessel.price)}&lt;/div>
      &lt;/div>
      &lt;div class="vessel-specs">
        &lt;div class="vessel-spec">&lt;strong>Capacity:&lt;/strong> ${capacityDisplay}&lt;/div>
        &lt;div class="vessel-spec">&lt;strong>Range:&lt;/strong> ${formatNumber(vessel.range)} nm&lt;/div>
        &lt;div class="vessel-spec ${co2Class}">&lt;strong>CO2 Factor:&lt;/strong> ${vessel.co2_factor}&lt;/div>
        &lt;div class="vessel-spec ${fuelClass}">&lt;strong>Fuel Factor:&lt;/strong> ${vessel.fuel_factor}&lt;/div>
        &lt;div class="vessel-spec">&lt;strong>Fuel Cap.:&lt;/strong> ${formatNumber(vessel.fuel_capacity)} t&lt;/div>
        &lt;div class="vessel-spec">&lt;strong>Service:&lt;/strong> ${vessel.hours_between_service}h&lt;/div>
        &lt;div class="vessel-spec">&lt;strong>Engine:&lt;/strong> ${vessel.engine_type} (${formatNumber(vessel.kw)} kW)&lt;/div>
        &lt;div class="vessel-spec">&lt;strong>Speed:&lt;/strong> ${vessel.max_speed} kn&lt;/div>
        &lt;div class="vessel-spec">&lt;strong>Type:&lt;/strong> ${vessel.type_name}&lt;/div>
        &lt;div class="vessel-spec">&lt;strong>Port:&lt;/strong> ${vessel.current_port_code.replace(/_/g, ' ')}&lt;/div>
        &lt;div class="vessel-spec">&lt;strong>Year:&lt;/strong> ${vessel.year}&lt;/div>
        &lt;div class="vessel-spec">&lt;strong>Length:&lt;/strong> ${vessel.length} m&lt;/div>
        &lt;div class="vessel-spec">&lt;strong>IMO:&lt;/strong> ${vessel.imo || 'N/A'}&lt;/div>
        &lt;div class="vessel-spec">&lt;strong>MMSI:&lt;/strong> ${vessel.mmsi || 'N/A'}&lt;/div>
        ${vessel.gearless || vessel.antifouling || additionalAttrs ? '&lt;div class="vessel-spec vessel-spec-divider">&lt;/div>' : ''}
        ${vessel.gearless ? '&lt;div class="vessel-spec vessel-spec-fullwidth vessel-spec-gearless">&lt;strong> Gearless:&lt;/strong> own cranes&lt;/div>' : ''}
        ${vessel.antifouling ? `&lt;div class="vessel-spec vessel-spec-fullwidth vessel-spec-antifouling">&lt;strong> Antifouling:&lt;/strong> ${vessel.antifouling}&lt;/div>` : ''}
        ${additionalAttrs}
      &lt;/div>
      ${!isPending ? `
        &lt;div class="vessel-actions">
          &lt;input type="number" class="vessel-quantity-input" data-vessel-id="${vessel.id}" value="1" min="1" max="99" ${!canPurchase ? 'disabled' : ''} />
          &lt;div class="vessel-action-buttons">
            &lt;button class="vessel-select-btn" data-vessel-id="${vessel.id}" ${!canPurchase ? 'disabled title="' + (isVesselTypeLocked ? 'Vessel type locked' : 'Not enough anchor slots') + '"' : ''}>
              Add to Cart
            &lt;/button>
            &lt;button class="vessel-buy-btn" data-vessel-id="${vessel.id}" ${!canPurchase ? 'disabled title="' + (isVesselTypeLocked ? 'Vessel type locked' : 'Not enough anchor slots') + '"' : ''}>
              Buy Now
            &lt;/button>
          &lt;/div>
        &lt;/div>
      ` : ''}
    &lt;/div>
  `;

  // Only add event listeners for acquirable vessels
  if (!isPending) {
    card.querySelector('.vessel-select-btn').addEventListener('click', () => {
      const quantityInput = card.querySelector('.vessel-quantity-input');
      const quantity = parseInt(quantityInput.value) || 1;
      toggleVesselSelection(vessel, quantity);
      quantityInput.value = 1; // Reset to 1 after adding to cart
    });
    card.querySelector('.vessel-buy-btn').addEventListener('click', () => {
      const quantityInput = card.querySelector('.vessel-quantity-input');
      const quantity = parseInt(quantityInput.value) || 1;
      purchaseSingleVessel(vessel, quantity);
    });
  } else {
    // For pending vessels, add locate button listener
    const locateBtn = card.querySelector('.vessel-locate-btn');
    if (locateBtn) {
      locateBtn.addEventListener('click', async () => {
        const vesselId = parseInt(locateBtn.dataset.vesselId);

        // Close buy vessels overlay
        document.getElementById('buyVesselsOverlay').classList.add('hidden');

        // Open harbor map and select vessel
        if (window.showHarborMapOverlay) {
          await window.showHarborMapOverlay();
        }

        // Select the vessel on map
        await selectVessel(vesselId);
      });
    }
  }

  return card;
}

let currentFilters = {
  vesselType: ['container', 'tanker'],
  priceMin: 0,
  priceMax: 999999999,
  yearMin: 0,
  yearMax: 9999,
  engineTypes: [], // Array of selected engine types
  speedMin: 0,
  speedMax: 999,
  serviceMin: 0,
  serviceMax: 999999,
  fuelFactorMin: 0,
  fuelFactorMax: 999,
  co2FactorMin: 0,
  co2FactorMax: 999,
  capacityMinTEU: 0,
  capacityMaxTEU: 999999,
  capacityMinBBL: 0,
  capacityMaxBBL: 999999,
  special: [] // Default: show all vessels (with AND without perks)
};

let priceSort = 'asc'; // 'asc' or 'desc'

// Track if filters are in default state
function areFiltersDefault() {
  const vesselTypeChecked = document.querySelectorAll('input[name="vesselType"]:checked').length;
  const vesselTypeTotal = document.querySelectorAll('input[name="vesselType"]').length;

  const engineSelect = document.getElementById('engineType');
  const allEnginesSelected = engineSelect.value === 'all';

  // Check if special filters are in default state (both unchecked)
  const perksChecked = document.querySelector('input[name="special"][value="perks"]')?.checked || false;
  const creditsChecked = document.querySelector('input[name="special"][value="credits"]')?.checked || false;
  const specialFiltersDefault = !perksChecked &amp;&amp; !creditsChecked;

  return vesselTypeChecked === vesselTypeTotal &amp;&amp;
         specialFiltersDefault &amp;&amp; // Default: both unchecked
         allEnginesSelected &amp;&amp;
         document.getElementById('priceMin').value === '0' &amp;&amp;
         document.getElementById('priceMax').value === 'Infinity' &amp;&amp;
         document.getElementById('yearMin').value === '0' &amp;&amp;
         document.getElementById('yearMax').value === '9999' &amp;&amp;
         document.getElementById('speedMin').value === '0' &amp;&amp;
         document.getElementById('speedMax').value === '999' &amp;&amp;
         document.getElementById('serviceMin').value === '0' &amp;&amp;
         document.getElementById('serviceMax').value === 'Infinity' &amp;&amp;
         document.getElementById('fuelFactorMin').value === document.getElementById('fuelFactorMin').options[0].value &amp;&amp;
         document.getElementById('fuelFactorMax').value === document.getElementById('fuelFactorMax').options[document.getElementById('fuelFactorMax').options.length - 1].value &amp;&amp;
         document.getElementById('co2FactorMin').value === document.getElementById('co2FactorMin').options[0].value &amp;&amp;
         document.getElementById('co2FactorMax').value === document.getElementById('co2FactorMax').options[document.getElementById('co2FactorMax').options.length - 1].value &amp;&amp;
         (!document.getElementById('capacityMinTEU') || document.getElementById('capacityMinTEU').value === '0') &amp;&amp;
         (!document.getElementById('capacityMaxTEU') || document.getElementById('capacityMaxTEU').value === 'Infinity') &amp;&amp;
         (!document.getElementById('capacityMinBBL') || document.getElementById('capacityMinBBL').value === '0') &amp;&amp;
         (!document.getElementById('capacityMaxBBL') || document.getElementById('capacityMaxBBL').value === 'Infinity');
}

/**
 * Apply all selected filters to vessel catalog
 */
window.applyVesselFilters = function() {
  if (window.DEBUG_MODE) console.log('[Apply Filters] Collecting filter values from dropdowns...');

  // Vessel Type checkboxes
  currentFilters.vesselType = [];
  document.querySelectorAll('input[name="vesselType"]:checked').forEach(cb => {
    currentFilters.vesselType.push(cb.value);
  });

  // Price Range dropdowns
  currentFilters.priceMin = parseFloat(document.getElementById('priceMin').value) || 0;
  const priceMaxEl = document.getElementById('priceMax');
  currentFilters.priceMax = priceMaxEl.value === 'Infinity' ? Infinity : parseFloat(priceMaxEl.value) || 999999999;

  // Year Built dropdowns
  currentFilters.yearMin = parseInt(document.getElementById('yearMin').value) || 0;
  currentFilters.yearMax = parseInt(document.getElementById('yearMax').value) || 9999;

  // Engine Type dropdown
  const engineSelect = document.getElementById('engineType');
  const selectedEngine = engineSelect.value;
  if (selectedEngine === 'all') {
    currentFilters.engineTypes = []; // Empty means show all
  } else {
    currentFilters.engineTypes = [selectedEngine];
  }

  // Speed Range dropdowns
  currentFilters.speedMin = parseFloat(document.getElementById('speedMin').value) || 0;
  currentFilters.speedMax = parseFloat(document.getElementById('speedMax').value) || 999;

  // Service Hours dropdowns
  currentFilters.serviceMin = parseFloat(document.getElementById('serviceMin').value) || 0;
  const serviceMaxEl = document.getElementById('serviceMax');
  currentFilters.serviceMax = serviceMaxEl.value === 'Infinity' ? Infinity : parseFloat(serviceMaxEl.value) || 999999;

  // Fuel Factor dropdowns
  currentFilters.fuelFactorMin = parseFloat(document.getElementById('fuelFactorMin').value) || 0;
  currentFilters.fuelFactorMax = parseFloat(document.getElementById('fuelFactorMax').value) || 999;

  // CO2 Factor dropdowns
  currentFilters.co2FactorMin = parseFloat(document.getElementById('co2FactorMin').value) || 0;
  currentFilters.co2FactorMax = parseFloat(document.getElementById('co2FactorMax').value) || 999;

  // Capacity Size dropdowns (separate for TEU and BBL)
  const teuMinEl = document.getElementById('capacityMinTEU');
  const teuMaxEl = document.getElementById('capacityMaxTEU');
  const bblMinEl = document.getElementById('capacityMinBBL');
  const bblMaxEl = document.getElementById('capacityMaxBBL');

  currentFilters.capacityMinTEU = teuMinEl ? parseFloat(teuMinEl.value) || 0 : 0;
  currentFilters.capacityMaxTEU = teuMaxEl ? (teuMaxEl.value === 'Infinity' ? Infinity : parseFloat(teuMaxEl.value) || 999999) : 999999;
  currentFilters.capacityMinBBL = bblMinEl ? parseFloat(bblMinEl.value) || 0 : 0;
  currentFilters.capacityMaxBBL = bblMaxEl ? (bblMaxEl.value === 'Infinity' ? Infinity : parseFloat(bblMaxEl.value) || 999999) : 999999;

  // Special checkboxes
  currentFilters.special = [];
  document.querySelectorAll('input[name="special"]:checked').forEach(cb => {
    currentFilters.special.push(cb.value);
  });

  // Show/hide reset button based on whether filters are in default state
  const resetBar = document.getElementById('resetFiltersBtn');
  if (areFiltersDefault()) {
    resetBar.classList.add('hidden');
  } else {
    resetBar.classList.remove('hidden');
  }

  if (window.DEBUG_MODE) console.log('[Apply Filters] Collected filters:', currentFilters);

  // Apply filters and redisplay
  displayFilteredVessels();
};

/**
 * Reset all filters to default (show all vessels)
 */
window.resetVesselFilters = function() {
  // Reset vessel type checkboxes to checked (all types)
  document.querySelectorAll('input[name="vesselType"]').forEach(cb => {
    cb.checked = true;
  });

  // Reset special checkboxes: both unchecked (show all vessels)
  document.querySelector('input[name="special"][value="perks"]').checked = false;
  document.querySelector('input[name="special"][value="credits"]').checked = false;

  // Reset all dropdowns to min/max values
  document.getElementById('priceMin').value = '0';
  document.getElementById('priceMax').value = 'Infinity';
  document.getElementById('yearMin').value = '0';
  document.getElementById('yearMax').value = '9999';

  // Reset engine type dropdown to "All Engines"
  const engineSelect = document.getElementById('engineType');
  engineSelect.value = 'all';

  document.getElementById('speedMin').value = '0';
  document.getElementById('speedMax').value = '999';
  document.getElementById('serviceMin').value = '0';
  document.getElementById('serviceMax').value = 'Infinity';
  // Reset Factor dropdowns to their actual min/max values (first and last option)
  const fuelFactorMin = document.getElementById('fuelFactorMin');
  const fuelFactorMax = document.getElementById('fuelFactorMax');
  if (fuelFactorMin &amp;&amp; fuelFactorMin.options.length > 0) {
    fuelFactorMin.value = fuelFactorMin.options[0].value;
    fuelFactorMax.value = fuelFactorMax.options[fuelFactorMax.options.length - 1].value;
  }

  const co2FactorMin = document.getElementById('co2FactorMin');
  const co2FactorMax = document.getElementById('co2FactorMax');
  if (co2FactorMin &amp;&amp; co2FactorMin.options.length > 0) {
    co2FactorMin.value = co2FactorMin.options[0].value;
    co2FactorMax.value = co2FactorMax.options[co2FactorMax.options.length - 1].value;
  }

  // Reset capacity dropdowns to their min/max (first and last option)
  const capacityMinTEU = document.getElementById('capacityMinTEU');
  const capacityMaxTEU = document.getElementById('capacityMaxTEU');
  if (capacityMinTEU &amp;&amp; capacityMinTEU.options.length > 0) {
    capacityMinTEU.value = capacityMinTEU.options[0].value;
    capacityMaxTEU.value = capacityMaxTEU.options[capacityMaxTEU.options.length - 1].value;
  }

  const capacityMinBBL = document.getElementById('capacityMinBBL');
  const capacityMaxBBL = document.getElementById('capacityMaxBBL');
  if (capacityMinBBL &amp;&amp; capacityMinBBL.options.length > 0) {
    capacityMinBBL.value = capacityMinBBL.options[0].value;
    capacityMaxBBL.value = capacityMaxBBL.options[capacityMaxBBL.options.length - 1].value;
  }

  if (window.DEBUG_MODE) console.log('[Filters] Reset to defaults');
  applyVesselFilters();
};

/**
 * Toggle price sort between ascending and descending
 */
window.togglePriceSort = function() {
  const btn = document.getElementById('sortPriceBtn');
  if (priceSort === 'asc') {
    priceSort = 'desc';
    btn.innerHTML = ' Price ';
    btn.dataset.sort = 'desc';
  } else {
    priceSort = 'asc';
    btn.innerHTML = ' Price ';
    btn.dataset.sort = 'asc';
  }
  displayFilteredVessels();
};

/**
 * Check if vessel passes all filter criteria
 */
function vesselPassesFilters(vessel) {
  // Vessel Type - If no types selected, show none
  if (currentFilters.vesselType.length === 0) {
    return false;
  }
  if (!currentFilters.vesselType.includes(vessel.capacity_type)) {
    return false;
  }

  // Price Range
  const price = vessel.price || 0;
  const maxPrice = currentFilters.priceMax === Infinity ? Number.MAX_SAFE_INTEGER : currentFilters.priceMax;
  if (price &lt; currentFilters.priceMin || price > maxPrice) {
    return false;
  }

  // Year Built
  const year = vessel.year || 0;
  if (year &lt; currentFilters.yearMin || year > currentFilters.yearMax) {
    return false;
  }

  // Engine Type - If specific engines selected, filter by them
  if (currentFilters.engineTypes.length > 0) {
    const engineType = vessel.engine_type || '';
    if (!currentFilters.engineTypes.includes(engineType)) {
      return false;
    }
  }

  // Max Speed
  const speed = vessel.max_speed || 0;
  if (speed &lt; currentFilters.speedMin || speed > currentFilters.speedMax) {
    return false;
  }

  // Service Hours
  const service = vessel.hours_between_service || 0;
  const maxService = currentFilters.serviceMax === Infinity ? Number.MAX_SAFE_INTEGER : currentFilters.serviceMax;
  if (service &lt; currentFilters.serviceMin || service > maxService) {
    return false;
  }

  // Fuel Factor
  const fuelFactor = vessel.fuel_factor;
  if (fuelFactor &lt; currentFilters.fuelFactorMin || fuelFactor > currentFilters.fuelFactorMax) {
    return false;
  }

  // CO2 Factor
  const co2Factor = vessel.co2_factor;
  if (co2Factor &lt; currentFilters.co2FactorMin || co2Factor > currentFilters.co2FactorMax) {
    return false;
  }

  // Capacity Size - Check against appropriate filter (TEU for containers, BBL for tankers)
  if (vessel.capacity_type === 'container') {
    const vesselCapacity = vessel.capacity_max || 0;
    const maxTEU = currentFilters.capacityMaxTEU === Infinity ? Number.MAX_SAFE_INTEGER : currentFilters.capacityMaxTEU;
    if (vesselCapacity &lt; currentFilters.capacityMinTEU || vesselCapacity > maxTEU) {
      return false;
    }
  } else if (vessel.capacity_type === 'tanker') {
    const cap = vessel.capacity_max || {};
    const vesselCapacity = Math.max(
      cap.crude_oil || 0,
      cap.chemicals || 0,
      cap.lng || 0,
      cap.products || 0
    );
    const maxBBL = currentFilters.capacityMaxBBL === Infinity ? Number.MAX_SAFE_INTEGER : currentFilters.capacityMaxBBL;
    if (vesselCapacity &lt; currentFilters.capacityMinBBL || vesselCapacity > maxBBL) {
      return false;
    }
  }

  // Special filters - INCLUSIVE filtering (show ONLY vessels matching at least one checked filter)
  // If at least one special filter is active, vessel must match one of them
  if (currentFilters.special.length > 0) {
    let matchesSpecialFilter = false;

    // Check if vessel matches "Credits Only" filter
    // only_for_credits can be: true, 1, "1", or any truthy value
    if (currentFilters.special.includes('credits') &amp;&amp; vessel.only_for_credits) {
      matchesSpecialFilter = true;
      if (window.DEBUG_MODE) console.log('[Filter] Vessel matches "Credits Only":', vessel.name, 'only_for_credits:', vessel.only_for_credits);
    }

    // Check if vessel matches "Has Perks" filter
    // Perks can be any of these:
    // - antifouling: string like "type_a" (null = no antifouling)
    // - bulbous_bow: 1 or 0
    // - enhanced_thrusters: 1 or 0
    // - perks: string description (null = no perks)
    if (currentFilters.special.includes('perks')) {
      const hasAnyPerk = (
        (vessel.antifouling &amp;&amp; vessel.antifouling !== null &amp;&amp; vessel.antifouling !== '') ||
        vessel.bulbous_bow === 1 ||
        vessel.enhanced_thrusters === 1 ||
        (vessel.perks &amp;&amp; vessel.perks !== null &amp;&amp; vessel.perks !== '')
      );

      if (hasAnyPerk) {
        matchesSpecialFilter = true;
        if (window.DEBUG_MODE) {
          const perkDetails = [];
          if (vessel.antifouling) perkDetails.push(`antifouling:${vessel.antifouling}`);
          if (vessel.bulbous_bow === 1) perkDetails.push('bulbous_bow');
          if (vessel.enhanced_thrusters === 1) perkDetails.push('enhanced_thrusters');
          if (vessel.perks) perkDetails.push(`perks:${vessel.perks}`);
          console.log('[Filter] Vessel matches "Has Perks":', vessel.name, perkDetails.join(', '));
        }
      }
    }

    // If no special filter matches, exclude this vessel
    if (!matchesSpecialFilter) {
      if (window.DEBUG_MODE &amp;&amp; currentFilters.special.includes('perks')) {
        console.log('[Filter] Vessel EXCLUDED (no perks):', vessel.name, {
          antifouling: vessel.antifouling,
          bulbous_bow: vessel.bulbous_bow,
          enhanced_thrusters: vessel.enhanced_thrusters,
          perks: vessel.perks,
          only_for_credits: vessel.only_for_credits
        });
      }
      return false;
    }
  }
  // If NO special filters are active (both unchecked), show ALL vessels (no filtering)

  return true;
}

// Lazy loading state
let currentlyDisplayedVessels = [];
let lazyLoadObserver = null;
const INITIAL_LOAD_COUNT = 12; // Load first 12 vessels immediately
const LAZY_LOAD_BATCH = 12; // Load 12 more when scrolling

/**
 * Display filtered and sorted vessels with lazy loading
 */
function displayFilteredVessels() {
  if (window.DEBUG_MODE) {
    console.log('[Filters] displayFilteredVessels called');
    console.log('[Filters] allAcquirableVessels:', allAcquirableVessels.length);
    console.log('[Filters] currentFilters:', currentFilters);
  }

  const filteredVessels = allAcquirableVessels.filter(vesselPassesFilters);

  if (window.DEBUG_MODE) console.log('[Filters] After filter:', filteredVessels.length);

  // Sort by price
  filteredVessels.sort((a, b) => {
    if (priceSort === 'asc') {
      return (a.price || 0) - (b.price || 0);
    } else {
      return (b.price || 0) - (a.price || 0);
    }
  });

  // Store filtered vessels for lazy loading
  currentlyDisplayedVessels = filteredVessels;

  // Render vessels
  const feed = document.getElementById('vesselCatalogFeed');
  if (!feed) {
    console.error('[Filters] vesselCatalogFeed not found!');
    return;
  }

  if (filteredVessels.length === 0) {
    feed.innerHTML = '&lt;div style="text-align: center; padding: 40px; color: #9ca3af; font-size: 16px;">No vessels match the selected filters&lt;/div>';
    return;
  }

  feed.innerHTML = '';

  const grid = document.createElement('div');
  grid.className = filteredVessels.length === 1 ? 'vessel-catalog-grid single-vessel' : 'vessel-catalog-grid';
  grid.id = 'vesselCatalogGrid';

  // Disconnect existing observer if any
  if (lazyLoadObserver) {
    lazyLoadObserver.disconnect();
  }

  // Load initial batch
  const initialBatch = filteredVessels.slice(0, INITIAL_LOAD_COUNT);
  initialBatch.forEach(vessel => {
    const card = createVesselCard(vessel);
    grid.appendChild(card);
  });

  // If more vessels exist, add lazy load sentinel
  if (filteredVessels.length > INITIAL_LOAD_COUNT) {
    const sentinel = document.createElement('div');
    sentinel.id = 'lazyLoadSentinel';
    sentinel.className = 'lazy-load-sentinel';
    sentinel.innerHTML = '&lt;div style="text-align: center; padding: 20px; color: #9ca3af;">Loading more vessels...&lt;/div>';
    grid.appendChild(sentinel);

    // Setup Intersection Observer for lazy loading
    lazyLoadObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          loadMoreVessels();
        }
      });
    }, {
      rootMargin: '200px' // Start loading 200px before sentinel is visible
    });

    lazyLoadObserver.observe(sentinel);
  }

  feed.appendChild(grid);

  // Adjust window size if only 1 vessel is displayed
  const buyVesselsOverlay = document.getElementById('buyVesselsOverlay');
  const messengerWindow = buyVesselsOverlay?.querySelector('.messenger-window');
  if (messengerWindow) {
    if (filteredVessels.length === 1) {
      messengerWindow.classList.add('messenger-window-single-vessel');
    } else {
      messengerWindow.classList.remove('messenger-window-single-vessel');
    }
  }

  if (window.DEBUG_MODE) console.log(`[Filters] Showing ${Math.min(INITIAL_LOAD_COUNT, filteredVessels.length)} of ${filteredVessels.length} vessels (lazy loading enabled)`);
}

/**
 * Load next batch of vessels when scrolling
 */
function loadMoreVessels() {
  const grid = document.getElementById('vesselCatalogGrid');
  const sentinel = document.getElementById('lazyLoadSentinel');

  if (!grid || !sentinel) return;

  // Count currently loaded vessels (exclude sentinel)
  const currentCount = grid.children.length - 1;

  // Get next batch
  const nextBatch = currentlyDisplayedVessels.slice(currentCount, currentCount + LAZY_LOAD_BATCH);

  if (nextBatch.length === 0) {
    // No more vessels to load, remove sentinel
    sentinel.remove();
    if (lazyLoadObserver) {
      lazyLoadObserver.disconnect();
    }
    return;
  }

  // Insert new vessels before sentinel
  nextBatch.forEach(vessel => {
    const card = createVesselCard(vessel);
    grid.insertBefore(card, sentinel);
  });

  if (window.DEBUG_MODE) console.log(`[Lazy Load] Loaded ${nextBatch.length} more vessels (${currentCount + nextBatch.length}/${currentlyDisplayedVessels.length})`);

  // If all loaded, remove sentinel
  if (currentCount + nextBatch.length >= currentlyDisplayedVessels.length) {
    sentinel.remove();
    if (lazyLoadObserver) {
      lazyLoadObserver.disconnect();
    }
  }
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation Version: 0.0.7 - ShippingManager CoPilot
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
