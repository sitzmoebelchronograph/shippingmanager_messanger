<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>server/routes/game.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Dark theme matching app style - carefully scoped to not break layout */
        html, body {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
            overflow-x: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Custom scrollbar styling for all browsers */
        * {
            scrollbar-width: thin !important;
            scrollbar-color: #404040 #1a1a1a !important;
        }

        /* Webkit browsers (Chrome, Safari, Edge) */
        *::-webkit-scrollbar {
            width: 6px !important;
            height: 6px !important;
        }

        *::-webkit-scrollbar-track {
            background: #1a1a1a !important;
        }

        *::-webkit-scrollbar-thumb {
            background-color: #404040 !important;
            border-radius: 3px !important;
        }

        *::-webkit-scrollbar-thumb:hover {
            background-color: #505050 !important;
        }

        /* Navigation sidebar - remove padding and white borders */
        nav {
            background-color: #242424 !important;
            border-right: 1px solid #404040 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow-x: hidden !important;
        }
        nav h2, nav h3 {
            color: #e0e0e0 !important;
            border-bottom: 1px solid #404040 !important;
            padding: 10px 15px !important;
            margin: 0 !important;
            background-color: #242424 !important;
            font-size: 14px !important;
            font-weight: 600 !important;
        }
        nav h3 {
            font-size: 13px !important;
        }
        nav ul {
            padding: 0 !important;
            margin: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li {
            list-style: none !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li a {
            color: #c9d1d9 !important;
            display: block !important;
            padding: 8px 15px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            background-color: #242424 !important;
            margin: 0 !important;
            border: none !important;
            font-size: 14px !important;
        }
        nav ul li a:hover {
            color: #60a5fa !important;
            background-color: rgba(96, 165, 250, 0.1) !important;
        }
        /* Module links (direct children of nav > ul > li) */
        nav > ul > li > a {
            color: #60a5fa !important;
            font-weight: 600 !important;
            padding: 10px 15px !important;
            font-size: 14px !important;
            border-left: 3px solid #60a5fa !important;
            padding-left: 12px !important;
        }
        nav > ul > li > a:hover {
            background-color: rgba(96, 165, 250, 0.15) !important;
        }
        /* Sub-items (methods/functions) indented */
        nav ul.methods {
            padding-left: 15px !important;
        }
        nav ul.methods li a {
            color: #9ca3af !important;
            font-size: 13px !important;
            padding: 6px 15px !important;
            font-weight: 400 !important;
        }
        nav ul.methods li a:hover {
            color: #c9d1d9 !important;
        }
        nav > h2:first-child {
            font-size: 16px !important;
            font-weight: 700 !important;
            padding: 12px 15px !important;
        }

        /* Main content area - dark background */
        #main {
            background-color: #1a1a1a !important;
            padding: 20px !important;
        }

        /* Article and sections - ensure dark background */
        article, section, .container-overview, .description {
            background-color: #1a1a1a !important;
        }

        /* Images - style demo images */
        img {
            max-width: 100% !important;
            height: auto !important;
            border: 1px solid #404040 !important;
            border-radius: 8px !important;
            margin: 20px 0 !important;
        }

        /* Links */
        a {
            color: #60a5fa !important;
            text-decoration: none !important;
        }
        a:hover {
            color: #93c5fd !important;
            text-decoration: underline !important;
        }

        /* Headings */
        h1, h2, h3, h4, h5, h6 {
            color: #e0e0e0 !important;
            border-bottom-color: #404040 !important;
            background-color: transparent !important;
        }
        h4.name {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
        }

        /* Code blocks */
        pre {
            background-color: #0d1117 !important;
            border: 1px solid #404040 !important;
        }
        pre code {
            background-color: transparent !important;
        }
        code {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
        }

        /* Tables */
        table {
            border-color: #404040 !important;
            background-color: #1a1a1a !important;
        }
        table thead tr {
            background-color: #242424 !important;
        }
        table tbody tr {
            background-color: #1a1a1a !important;
        }
        table tbody tr:nth-child(even) {
            background-color: #1f1f1f !important;
        }
        table td, table th {
            border-color: #404040 !important;
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }
        .params .name, .props .name {
            color: #10b981 !important;
            font-family: 'Courier New', monospace !important;
        }

        /* Descriptions and details */
        .description, .details, dt, dd, p, ul, ol, dl {
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }

        /* Types */
        .type-signature {
            color: #a78bfa !important;
        }

        /* Source links */
        .details .details-item-container {
            border-left-color: #404040 !important;
        }

        /* Breadcrumbs */
        .page-title {
            color: #e0e0e0 !important;
        }

        /* Search */
        #nav-search {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
            color: #e0e0e0 !important;
        }

        /* Mobile nav trigger */
        .navicon-button {
            background-color: #2a2a2a !important;
        }

        /* Footer */
        footer {
            background-color: #1a1a1a !important;
            color: #9ca3af !important;
            border-top: 1px solid #404040 !important;
            text-align: center !important;
            padding: 20px !important;
        }

        /* Remove horizontal scrollbar and white borders */
        * {
            box-sizing: border-box !important;
        }
    </style>
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">README</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-build-guide.html">Build Guide</a></li><li><a href="tutorial-installation-guide.html">Installation Guide</a></li></ul><h3>Classes</h3><ul><li><a href="module-server_chatbot-ChatBot.html">ChatBot</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot-ChatBot.html#initialize">initialize</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#processAllianceMessage">processAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#processPrivateMessage">processPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#setupScheduledTasks">setupScheduledTasks</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#updateSettings">updateSettings</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-api.html">api</a><ul class='methods'><li data-type='method'><a href="module-api.html#.activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-api.html#.deleteAllLogs">deleteAllLogs</a></li><li data-type='method'><a href="module-api.html#.deleteChat">deleteChat</a></li><li data-type='method'><a href="module-api.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-api.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-api.html#.departVessels">departVessels</a></li><li data-type='method'><a href="module-api.html#.doWearMaintenanceBulk">doWearMaintenanceBulk</a></li><li data-type='method'><a href="module-api.html#.downloadLogbookExport">downloadLogbookExport</a></li><li data-type='method'><a href="module-api.html#.fetchAcquirableVessels">fetchAcquirableVessels</a></li><li data-type='method'><a href="module-api.html#.fetchAllianceMembers">fetchAllianceMembers</a></li><li data-type='method'><a href="module-api.html#.fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-api.html#.fetchBunkerPrices">fetchBunkerPrices</a></li><li data-type='method'><a href="module-api.html#.fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-api.html#.fetchChat">fetchChat</a></li><li data-type='method'><a href="module-api.html#.fetchContacts">fetchContacts</a></li><li data-type='method'><a href="module-api.html#.fetchLogbookEntries">fetchLogbookEntries</a></li><li data-type='method'><a href="module-api.html#.fetchLogbookFileSize">fetchLogbookFileSize</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerChats">fetchMessengerChats</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerMessages">fetchMessengerMessages</a></li><li data-type='method'><a href="module-api.html#.fetchUserCompany">fetchUserCompany</a></li><li data-type='method'><a href="module-api.html#.fetchUserSettings">fetchUserSettings</a></li><li data-type='method'><a href="module-api.html#.fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-api.html#.getCompanyNameCached">getCompanyNameCached</a></li><li data-type='method'><a href="module-api.html#.getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-api.html#.markChatAsRead">markChatAsRead</a></li><li data-type='method'><a href="module-api.html#.purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-api.html#.purchaseFuel">purchaseFuel</a></li><li data-type='method'><a href="module-api.html#.purchaseVessel">purchaseVessel</a></li><li data-type='method'><a href="module-api.html#.searchUsers">searchUsers</a></li><li data-type='method'><a href="module-api.html#.sendChatMessage">sendChatMessage</a></li><li data-type='method'><a href="module-api.html#.sendPrivateMessage">sendPrivateMessage</a></li></ul></li><li><a href="module-app.html">app</a></li><li><a href="module-automation.html">automation</a><ul class='methods'><li data-type='method'><a href="module-automation.html#.initAutomation">initAutomation</a></li><li data-type='method'><a href="module-automation.html#.runAutomationChecks">runAutomationChecks</a></li><li data-type='method'><a href="module-automation.html#.triggerAutoRebuyChecks">triggerAutoRebuyChecks</a></li><li data-type='method'><a href="module-automation.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-automation.html#~checkAutoCampaignRenewal">checkAutoCampaignRenewal</a></li><li data-type='method'><a href="module-automation.html#~checkAutoDepartAll">checkAutoDepartAll</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyCO2">checkAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyFuel">checkAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~getTotalCapacity">getTotalCapacity</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyCO2">performAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyFuel">performAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~updateAutoDepartLabel">updateAutoDepartLabel</a></li></ul></li><li><a href="module-badge-manager.html">badge-manager</a><ul class='methods'><li data-type='method'><a href="module-badge-manager.html#.getBadgeCount">getBadgeCount</a></li><li data-type='method'><a href="module-badge-manager.html#.hideBadge">hideBadge</a></li><li data-type='method'><a href="module-badge-manager.html#.showBadge">showBadge</a></li><li data-type='method'><a href="module-badge-manager.html#.updateBadge">updateBadge</a></li><li data-type='method'><a href="module-badge-manager.html#.updateButtonState">updateButtonState</a></li><li data-type='method'><a href="module-badge-manager.html#.updateButtonTooltip">updateButtonTooltip</a></li><li data-type='method'><a href="module-badge-manager.html#.updateButtonVisibility">updateButtonVisibility</a></li></ul></li><li><a href="module-bunker-management.html">bunker-management</a><ul class='methods'><li data-type='method'><a href="module-bunker-management.html#.buyMaxCO2">buyMaxCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.buyMaxFuel">buyMaxFuel</a></li><li data-type='method'><a href="module-bunker-management.html#.getCurrentBunkerState">getCurrentBunkerState</a></li><li data-type='method'><a href="module-bunker-management.html#.setCapacityFromBunkerUpdate">setCapacityFromBunkerUpdate</a></li><li data-type='method'><a href="module-bunker-management.html#.updateBunkerStatus">updateBunkerStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCO2">updateCurrentCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCash">updateCurrentCash</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentFuel">updateCurrentFuel</a></li></ul></li><li><a href="module-chat.html">chat</a><ul class='methods'><li data-type='method'><a href="module-chat.html#.displayMessages">displayMessages</a></li><li data-type='method'><a href="module-chat.html#.handleMessageInput">handleMessageInput</a></li><li data-type='method'><a href="module-chat.html#.initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-chat.html#.loadAllianceMembers">loadAllianceMembers</a></li><li data-type='method'><a href="module-chat.html#.loadMessages">loadMessages</a></li><li data-type='method'><a href="module-chat.html#.markAllianceChatAsRead">markAllianceChatAsRead</a></li><li data-type='method'><a href="module-chat.html#.parseMessageWithMentions">parseMessageWithMentions</a></li><li data-type='method'><a href="module-chat.html#.sendMessage">sendMessage</a></li><li data-type='method'><a href="module-chat.html#.setChatScrollListener">setChatScrollListener</a></li><li data-type='method'><a href="module-chat.html#~attemptReconnect">attemptReconnect</a></li><li data-type='method'><a href="module-chat.html#~displaySuggestions">displaySuggestions</a></li><li data-type='method'><a href="module-chat.html#~formatLocalTime">formatLocalTime</a></li><li data-type='method'><a href="module-chat.html#~handleAutoCoopComplete">handleAutoCoopComplete</a></li><li data-type='method'><a href="module-chat.html#~handleAutoCoopNoTargets">handleAutoCoopNoTargets</a></li><li data-type='method'><a href="module-chat.html#~handleAutopilotDepartStart">handleAutopilotDepartStart</a></li><li data-type='method'><a href="module-chat.html#~handleBackendAutoRepairComplete">handleBackendAutoRepairComplete</a></li><li data-type='method'><a href="module-chat.html#~handleBunkerUpdate">handleBunkerUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleCO2Purchased">handleCO2Purchased</a></li><li data-type='method'><a href="module-chat.html#~handleCampaignsRenewed">handleCampaignsRenewed</a></li><li data-type='method'><a href="module-chat.html#~handleCompanyTypeUpdate">handleCompanyTypeUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleCoopUpdate">handleCoopUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleDrydockCountUpdate">handleDrydockCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleFuelPurchased">handleFuelPurchased</a></li><li data-type='method'><a href="module-chat.html#~handleGenericNotification">handleGenericNotification</a></li><li data-type='method'><a href="module-chat.html#~handleHarborMapRefreshRequired">handleHarborMapRefreshRequired</a></li><li data-type='method'><a href="module-chat.html#~handleHeaderDataUpdate">handleHeaderDataUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleHijackingUpdate">handleHijackingUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleMentionAutocomplete">handleMentionAutocomplete</a></li><li data-type='method'><a href="module-chat.html#~handleMessengerUpdate">handleMessengerUpdate</a></li><li data-type='method'><a href="module-chat.html#~handlePriceAlert">handlePriceAlert</a></li><li data-type='method'><a href="module-chat.html#~handlePriceUpdate">handlePriceUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleRepairCountUpdate">handleRepairCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleUnreadMessagesUpdate">handleUnreadMessagesUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleUserActionNotification">handleUserActionNotification</a></li><li data-type='method'><a href="module-chat.html#~handleVesselCountUpdate">handleVesselCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDepartBatch">handleVesselsDepartBatch</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDepartComplete">handleVesselsDepartComplete</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDeparted">handleVesselsDeparted</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDrydocked">handleVesselsDrydocked</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsFailed">handleVesselsFailed</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsRepaired">handleVesselsRepaired</a></li><li data-type='method'><a href="module-chat.html#~hideMemberSuggestions">hideMemberSuggestions</a></li><li data-type='method'><a href="module-chat.html#~insertMention">insertMention</a></li><li data-type='method'><a href="module-chat.html#~registerUsernameClickEvents">registerUsernameClickEvents</a></li><li data-type='method'><a href="module-chat.html#~updateAllianceChatBadge">updateAllianceChatBadge</a></li></ul></li><li><a href="module-coop.html">coop</a><ul class='methods'><li data-type='method'><a href="module-coop.html#.closeCoopOverlay">closeCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.fetchCoopData">fetchCoopData</a></li><li data-type='method'><a href="module-coop.html#.sendCoopMax">sendCoopMax</a></li><li data-type='method'><a href="module-coop.html#.showCoopOverlay">showCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.updateCoopBadge">updateCoopBadge</a></li><li data-type='method'><a href="module-coop.html#~renderMemberCard">renderMemberCard</a></li></ul></li><li><a href="module-desktop-notification-templates.html">desktop-notification-templates</a><ul class='methods'><li data-type='method'><a href="module-desktop-notification-templates.html#.createDesktopNotification">createDesktopNotification</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.getDefaultEmoji">getDefaultEmoji</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.getNotificationTypes">getNotificationTypes</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.isValidNotificationType">isValidNotificationType</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyAlert">notifyAlert</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyError">notifyError</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifySuccess">notifySuccess</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyWarning">notifyWarning</a></li></ul></li><li><a href="module-event-info.html">event-info</a><ul class='methods'><li data-type='method'><a href="module-event-info.html#.initEventInfo">initEventInfo</a></li><li data-type='method'><a href="module-event-info.html#.openEventModal">openEventModal</a></li><li data-type='method'><a href="module-event-info.html#.updateEventData">updateEventData</a></li><li data-type='method'><a href="module-event-info.html#~startEventTimer">startEventTimer</a></li></ul></li><li><a href="module-forecast-calendar.html">forecast-calendar</a><ul class='methods'><li data-type='method'><a href="module-forecast-calendar.html#.initForecastCalendar">initForecastCalendar</a></li><li data-type='method'><a href="module-forecast-calendar.html#.updateEventDiscount">updateEventDiscount</a></li><li data-type='method'><a href="module-forecast-calendar.html#~createTableHTML">createTableHTML</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getBrowserTimezone">getBrowserTimezone</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getCo2Class">getCo2Class</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getCurrentVisibleDay">getCurrentVisibleDay</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getFuelClass">getFuelClass</a></li><li data-type='method'><a href="module-forecast-calendar.html#~isEventActiveAtTime">isEventActiveAtTime</a></li><li data-type='method'><a href="module-forecast-calendar.html#~isEventActiveOnDay">isEventActiveOnDay</a></li><li data-type='method'><a href="module-forecast-calendar.html#~loadForecastData">loadForecastData</a></li><li data-type='method'><a href="module-forecast-calendar.html#~preloadMonth">preloadMonth</a></li><li data-type='method'><a href="module-forecast-calendar.html#~renderBook">renderBook</a></li><li data-type='method'><a href="module-forecast-calendar.html#~updateEventBadge">updateEventBadge</a></li></ul></li><li><a href="module-harbor-map-aggregator.html">harbor-map-aggregator</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-aggregator.html#~aggregateReachablePorts">aggregateReachablePorts</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~aggregateVesselData">aggregateVesselData</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~categorizeVesselsByPort">categorizeVesselsByPort</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~extractPortsFromGameIndex">extractPortsFromGameIndex</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~extractVesselsFromGameIndex">extractVesselsFromGameIndex</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~filterAssignedPorts">filterAssignedPorts</a></li></ul></li><li><a href="module-harbor-map-calculator.html">harbor-map-calculator</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateCargoUtilization">calculateCargoUtilization</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateDemandLevel">calculateDemandLevel</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateETA">calculateETA</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateVesselPosition">calculateVesselPosition</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~formatCargoCapacity">formatCargoCapacity</a></li></ul></li><li><a href="module-harbor-map-init.html">harbor-map-init</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-init.html#.closeHarborMap">closeHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.initHarborMap">initHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.openHarborMap">openHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.preloadHarborMapData">preloadHarborMapData</a></li><li data-type='method'><a href="module-harbor-map-init.html#.refreshHarborMapIfOpen">refreshHarborMapIfOpen</a></li><li data-type='method'><a href="module-harbor-map-init.html#.reloadMap">reloadMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.startHarborMapAutoUpdate">startHarborMapAutoUpdate</a></li><li data-type='method'><a href="module-harbor-map-init.html#.stopHarborMapAutoUpdate">stopHarborMapAutoUpdate</a></li><li data-type='method'><a href="module-harbor-map-init.html#~departVesselWrapper">departVesselWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~getVesselByIdWrapper">getVesselByIdWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~selectVesselFromMap">selectVesselFromMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#~sellVesselFromPanelWrapper">sellVesselFromPanelWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~updateVesselMarkerWrapper">updateVesselMarkerWrapper</a></li></ul></li><li><a href="module-harbor-map_api-client.html">harbor-map/api-client</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_api-client.html#.clearHarborMapCache">clearHarborMapCache</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.exportVesselHistory">exportVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchHarborMapOverview">fetchHarborMapOverview</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchPortDetails">fetchPortDetails</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchVesselHistory">fetchVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchVesselReachablePorts">fetchVesselReachablePorts</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.getCachedOverview">getCachedOverview</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.invalidateOverviewCache">invalidateOverviewCache</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.prefetchHarborMapData">prefetchHarborMapData</a></li></ul></li><li><a href="module-harbor-map_filters.html">harbor-map/filters</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_filters.html#.filterPorts">filterPorts</a></li><li data-type='method'><a href="module-harbor-map_filters.html#.filterVessels">filterVessels</a></li><li data-type='method'><a href="module-harbor-map_filters.html#.getPortFilterOptions">getPortFilterOptions</a></li><li data-type='method'><a href="module-harbor-map_filters.html#.getVesselFilterOptions">getVesselFilterOptions</a></li><li data-type='method'><a href="module-harbor-map_filters.html#~calculateVesselUtilization">calculateVesselUtilization</a></li></ul></li><li><a href="module-harbor-map_map-controller.html">harbor-map/map-controller</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_map-controller.html#.clearRoute">clearRoute</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.closeAllPanels">closeAllPanels</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.deselectAll">deselectAll</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.drawRoute">drawRoute</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getCurrentPorts">getCurrentPorts</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getMap">getMap</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getSelectedPortCode">getSelectedPortCode</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getVesselById">getVesselById</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.initMap">initMap</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.loadOverview">loadOverview</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.renderPorts">renderPorts</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.renderVessels">renderVessels</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.selectPort">selectPort</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.selectVessel">selectVessel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.setPortFilter">setPortFilter</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.setVesselFilter">setVesselFilter</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.updateVesselMarker">updateVesselMarker</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.updateWeatherDataSetting">updateWeatherDataSetting</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~addCustomControls">addCustomControls</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~applyFiltersAndRender">applyFiltersAndRender</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~applyMapTheme">applyMapTheme</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~calculateHeading">calculateHeading</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~categorizeVesselsByPortClientSide">categorizeVesselsByPortClientSide</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~changeTileLayer">changeTileLayer</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~createVesselIcon">createVesselIcon</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~getVesselType">getVesselType</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~hideRouteVesselsPanel">hideRouteVesselsPanel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~setRouteFilter">setRouteFilter</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~showRouteVesselsPanel">showRouteVesselsPanel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~showWeatherInfo">showWeatherInfo</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~toggleWeatherLayer">toggleWeatherLayer</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~updateRouteDropdown">updateRouteDropdown</a></li></ul></li><li><a href="module-harbor-map_panel-drag.html">harbor-map/panel-drag</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_panel-drag.html#.initializePanelDrag">initializePanelDrag</a></li></ul></li><li><a href="module-harbor-map_port-panel.html">harbor-map/port-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_port-panel.html#.closePortPanel">closePortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.hidePortPanel">hidePortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.selectVesselFromPort">selectVesselFromPort</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.showPortPanel">showPortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#~loadPortWeather">loadPortWeather</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#~renderDemandSection">renderDemandSection</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#~renderVesselList">renderVesselList</a></li></ul></li><li><a href="module-harbor-map_route-vessels-panel.html">harbor-map/route-vessels-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.closeRoutePanel">closeRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.hideRoutePanel">hideRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.selectRouteVessel">selectRouteVessel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.showRoutePanel">showRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#~storeVessels">storeVessels</a></li></ul></li><li><a href="module-harbor-map_vessel-panel.html">harbor-map/vessel-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.closeVesselPanel">closeVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.exportHistoryFormat">exportHistoryFormat</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.hideVesselPanel">hideVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.sellVesselFromPanel">sellVesselFromPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.showVesselPanel">showVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.startRenameVessel">startRenameVessel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.toggleExportMenu">toggleExportMenu</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~cancelVesselRename">cancelVesselRename</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~closeExportMenuOnClickOutside">closeExportMenuOnClickOutside</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~getCountryFlag">getCountryFlag</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~getPortCountryCode">getPortCountryCode</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~loadVesselHistory">loadVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~loadVesselWeather">loadVesselWeather</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~openRepairDialog">openRepairDialog</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~renderHistoryPage">renderHistoryPage</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~saveVesselRename">saveVesselRename</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~setupInfiniteScroll">setupInfiniteScroll</a></li></ul></li><li><a href="module-logbook.html">logbook</a><ul class='methods'><li data-type='method'><a href="module-logbook.html#.deleteAllLogsConfirmed">deleteAllLogsConfirmed</a></li><li data-type='method'><a href="module-logbook.html#.getLogFileSize">getLogFileSize</a></li><li data-type='method'><a href="module-logbook.html#.initLogbook">initLogbook</a></li><li data-type='method'><a href="module-logbook.html#.prependLogEntry">prependLogEntry</a></li><li data-type='method'><a href="module-logbook.html#~convertActionFilterToBackend">convertActionFilterToBackend</a></li><li data-type='method'><a href="module-logbook.html#~exportLogs">exportLogs</a></li><li data-type='method'><a href="module-logbook.html#~formatDetails">formatDetails</a></li><li data-type='method'><a href="module-logbook.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-logbook.html#~getTransactionType">getTransactionType</a></li><li data-type='method'><a href="module-logbook.html#~loadLogs">loadLogs</a></li><li data-type='method'><a href="module-logbook.html#~renderDetailsRow">renderDetailsRow</a></li><li data-type='method'><a href="module-logbook.html#~renderLogTable">renderLogTable</a></li><li data-type='method'><a href="module-logbook.html#~toggleExpanded">toggleExpanded</a></li><li data-type='method'><a href="module-logbook.html#~updateActionFilter">updateActionFilter</a></li></ul></li><li><a href="module-map-icon-bar.html">map-icon-bar</a><ul class='methods'><li data-type='method'><a href="module-map-icon-bar.html#.initializeMapIconBar">initializeMapIconBar</a></li><li data-type='method'><a href="module-map-icon-bar.html#~handleIconAction">handleIconAction</a></li></ul></li><li><a href="module-messenger.html">messenger</a><ul class='methods'><li data-type='method'><a href="module-messenger.html#.closeAllChats">closeAllChats</a></li><li data-type='method'><a href="module-messenger.html#.closeChatSelection">closeChatSelection</a></li><li data-type='method'><a href="module-messenger.html#.openMessenger">openMessenger</a></li><li data-type='method'><a href="module-messenger.html#.openNewChat">openNewChat</a></li><li data-type='method'><a href="module-messenger.html#.showAllChats">showAllChats</a></li><li data-type='method'><a href="module-messenger.html#.updateUnreadBadge">updateUnreadBadge</a></li><li data-type='method'><a href="module-messenger.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-messenger.html#~loadPrivateMessages">loadPrivateMessages</a></li><li data-type='method'><a href="module-messenger.html#~showCounterOfferUI">showCounterOfferUI</a></li><li data-type='method'><a href="module-messenger.html#~stopHijackingPolling">stopHijackingPolling</a></li></ul></li><li><a href="module-public_js_modules_hijacking.html">public/js/modules/hijacking</a><ul class='methods'><li data-type='method'><a href="module-public_js_modules_hijacking.html#.closeHijackingInbox">closeHijackingInbox</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.openHijackingInbox">openHijackingInbox</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.updateHijackedVesselsDisplay">updateHijackedVesselsDisplay</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.updateHijackingBadge">updateHijackingBadge</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~deleteCase">deleteCase</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~openCaseDetails">openCaseDetails</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~refreshHijackingBadge">refreshHijackingBadge</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~renderCaseList">renderCaseList</a></li></ul></li><li><a href="module-server_automation.html">server/automation</a><ul class='methods'><li data-type='method'><a href="module-server_automation.html#~getRandomInterval">getRandomInterval</a></li><li data-type='method'><a href="module-server_automation.html#~initialize">initialize</a></li><li data-type='method'><a href="module-server_automation.html#~loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_automation.html#~parseInterval">parseInterval</a></li><li data-type='method'><a href="module-server_automation.html#~restartAutoRepair">restartAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~runAutoRepair">runAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~scheduleAutoRepair">scheduleAutoRepair</a></li></ul></li><li><a href="module-server_autopilot.html">server/autopilot</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot.html#~analyzeVesselDepartures">analyzeVesselDepartures</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoRebuyAll">autoRebuyAll</a></li><li data-type='method'><a href="module-server_autopilot.html#~checkPriceAlerts">checkPriceAlerts</a></li><li data-type='method'><a href="module-server_autopilot.html#~countActiveCampaignTypes">countActiveCampaignTypes</a></li><li data-type='method'><a href="module-server_autopilot.html#~initializeAutopilotState">initializeAutopilotState</a></li><li data-type='method'><a href="module-server_autopilot.html#~isAutopilotPaused">isAutopilotPaused</a></li><li data-type='method'><a href="module-server_autopilot.html#~mainEventLoop">mainEventLoop</a></li><li data-type='method'><a href="module-server_autopilot.html#~pauseAutopilot">pauseAutopilot</a></li><li data-type='method'><a href="module-server_autopilot.html#~resumeAutopilot">resumeAutopilot</a></li><li data-type='method'><a href="module-server_autopilot.html#~setBroadcastFunction">setBroadcastFunction</a></li><li data-type='method'><a href="module-server_autopilot.html#~startMainEventLoop">startMainEventLoop</a></li><li data-type='method'><a href="module-server_autopilot.html#~tryUpdateAllData">tryUpdateAllData</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateAllData">updateAllData</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateCampaigns">updateCampaigns</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateDrydockCount">updateDrydockCount</a></li><li data-type='method'><a href="module-server_autopilot.html#~updatePrices">updatePrices</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateRepairCount">updateRepairCount</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateUnreadMessages">updateUnreadMessages</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateVesselCount">updateVesselCount</a></li></ul></li><li><a href="module-server_autopilot_pilot_atmosphere_broker.html">server/autopilot/pilot_atmosphere_broker</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_atmosphere_broker.html#~autoRebuyCO2">autoRebuyCO2</a></li></ul></li><li><a href="module-server_autopilot_pilot_barrel_boss.html">server/autopilot/pilot_barrel_boss</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_barrel_boss.html#~autoRebuyFuel">autoRebuyFuel</a></li></ul></li><li><a href="module-server_autopilot_pilot_captain_blackbeard.html">server/autopilot/pilot_captain_blackbeard</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~acceptRansomWithRetry">acceptRansomWithRetry</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~autoNegotiateHijacking">autoNegotiateHijacking</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~getCaseWithRetry">getCaseWithRetry</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~processHijackingCase">processHijackingCase</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~submitOfferWithRetry">submitOfferWithRetry</a></li></ul></li><li><a href="module-server_autopilot_pilot_cargo_marshal.html">server/autopilot/pilot_cargo_marshal</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~autoDepartVessels">autoDepartVessels</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~departVessels">departVessels</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~getTotalCapacity">getTotalCapacity</a></li></ul></li><li><a href="module-server_autopilot_pilot_drydock_master.html">server/autopilot/pilot_drydock_master</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_drydock_master.html#~autoDrydockVessels">autoDrydockVessels</a></li></ul></li><li><a href="module-server_autopilot_pilot_fair_hand.html">server/autopilot/pilot_fair_hand</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_fair_hand.html#~autoCoop">autoCoop</a></li></ul></li><li><a href="module-server_autopilot_pilot_harbormaster.html">server/autopilot/pilot_harbormaster</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_harbormaster.html#~autoAnchorPointPurchase">autoAnchorPointPurchase</a></li><li data-type='method'><a href="module-server_autopilot_pilot_harbormaster.html#~setBroadcastFunction">setBroadcastFunction</a></li></ul></li><li><a href="module-server_autopilot_pilot_reputation_chief.html">server/autopilot/pilot_reputation_chief</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_reputation_chief.html#~autoCampaignRenewal">autoCampaignRenewal</a></li></ul></li><li><a href="module-server_autopilot_pilot_yard_foreman.html">server/autopilot/pilot_yard_foreman</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_yard_foreman.html#~autoRepairVessels">autoRepairVessels</a></li></ul></li><li><a href="module-server_cache.html">server/cache</a><ul class='methods'><li data-type='method'><a href="module-server_cache.html#~clearAllCaches">clearAllCaches</a></li><li data-type='method'><a href="module-server_cache.html#~getAllianceCache">getAllianceCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCampaignCache">getCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCompanyCache">getCompanyCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCoopCache">getCoopCache</a></li><li data-type='method'><a href="module-server_cache.html#~invalidateCampaignCache">invalidateCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~invalidateCoopCache">invalidateCoopCache</a></li><li data-type='method'><a href="module-server_cache.html#~isCacheValid">isCacheValid</a></li><li data-type='method'><a href="module-server_cache.html#~setAllianceCache">setAllianceCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCampaignCache">setCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCompanyCache">setCompanyCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCoopCache">setCoopCache</a></li></ul></li><li><a href="module-server_certificate.html">server/certificate</a><ul class='methods'><li data-type='method'><a href="module-server_certificate.html#~createHttpsServer">createHttpsServer</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCA">generateCA</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCertificate">generateCertificate</a></li><li data-type='method'><a href="module-server_certificate.html#~getNetworkIPs">getNetworkIPs</a></li><li data-type='method'><a href="module-server_certificate.html#~isCertificateInstalled">isCertificateInstalled</a></li><li data-type='method'><a href="module-server_certificate.html#~loadCertificate">loadCertificate</a></li></ul></li><li><a href="module-server_chatbot.html">server/chatbot</a></li><li><a href="module-server_chatbot_commands.html">server/chatbot/commands</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_commands.html#~generateForecastText">generateForecastText</a></li><li data-type='method'><a href="module-server_chatbot_commands.html#~handleForecastCommand">handleForecastCommand</a></li><li data-type='method'><a href="module-server_chatbot_commands.html#~handleHelpCommand">handleHelpCommand</a></li></ul></li><li><a href="module-server_chatbot_executor.html">server/chatbot/executor</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_executor.html#~executeCommand">executeCommand</a></li></ul></li><li><a href="module-server_chatbot_parser.html">server/chatbot/parser</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_parser.html#~findCustomCommand">findCustomCommand</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~isCommandAllowedInChannel">isCommandAllowedInChannel</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~isOnCooldown">isOnCooldown</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~processAllianceMessage">processAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~processPrivateMessage">processPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~resolveCommandName">resolveCommandName</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~updateCooldown">updateCooldown</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~validateCommandArguments">validateCommandArguments</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~validateForecastArguments">validateForecastArguments</a></li></ul></li><li><a href="module-server_chatbot_scheduler.html">server/chatbot/scheduler</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_scheduler.html#~scheduleDailyForecast">scheduleDailyForecast</a></li><li data-type='method'><a href="module-server_chatbot_scheduler.html#~sendDailyForecast">sendDailyForecast</a></li><li data-type='method'><a href="module-server_chatbot_scheduler.html#~setupScheduledTasks">setupScheduledTasks</a></li></ul></li><li><a href="module-server_chatbot_sender.html">server/chatbot/sender</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_sender.html#~sendAllianceMessage">sendAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot_sender.html#~sendErrorMessage">sendErrorMessage</a></li><li data-type='method'><a href="module-server_chatbot_sender.html#~sendPrivateMessage">sendPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot_sender.html#~sendResponse">sendResponse</a></li></ul></li><li><a href="module-server_chatbot_settings.html">server/chatbot/settings</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_settings.html#~getDefaultChatBotObject">getDefaultChatBotObject</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~mapChatBotObjectToFlatSettings">mapChatBotObjectToFlatSettings</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~mapSettingsToChatBotObject">mapSettingsToChatBotObject</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~updateSettings">updateSettings</a></li></ul></li><li><a href="module-server_config.html">server/config</a><ul class='methods'><li data-type='method'><a href="module-server_config.html#~getAppDataDir">getAppDataDir</a></li><li data-type='method'><a href="module-server_config.html#~getLocalAppDataDir">getLocalAppDataDir</a></li><li data-type='method'><a href="module-server_config.html#~getLogDir">getLogDir</a></li><li data-type='method'><a href="module-server_config.html#~getSessionCookie">getSessionCookie</a></li><li data-type='method'><a href="module-server_config.html#~getSettingsDir">getSettingsDir</a></li><li data-type='method'><a href="module-server_config.html#~loadStartupSettings">loadStartupSettings</a></li><li data-type='method'><a href="module-server_config.html#~setSessionCookie">setSessionCookie</a></li></ul></li><li><a href="module-server_gameapi.html">server/gameapi</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi.html#~activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-server_gameapi.html#~bulkRepairVessels">bulkRepairVessels</a></li><li data-type='method'><a href="module-server_gameapi.html#~departVessel">departVessel</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchAutoPrice">fetchAutoPrice</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchBunkerState">fetchBunkerState</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchEventData">fetchEventData</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchPrices">fetchPrices</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchRepairCount">fetchRepairCount</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchUnreadMessages">fetchUnreadMessages</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-server_gameapi.html#~getAllUserVessels">getAllUserVessels</a></li><li data-type='method'><a href="module-server_gameapi.html#~getAssignedPorts">getAssignedPorts</a></li><li data-type='method'><a href="module-server_gameapi.html#~getGameIndex">getGameIndex</a></li><li data-type='method'><a href="module-server_gameapi.html#~getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-server_gameapi.html#~getVesselHistory">getVesselHistory</a></li><li data-type='method'><a href="module-server_gameapi.html#~getVesselPorts">getVesselPorts</a></li><li data-type='method'><a href="module-server_gameapi.html#~purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-server_gameapi.html#~purchaseFuel">purchaseFuel</a></li></ul></li><li><a href="module-server_middleware_index.html">server/middleware/index</a><ul class='methods'><li data-type='method'><a href="module-server_middleware_index.html#~setupMiddleware">setupMiddleware</a></li></ul></li><li><a href="module-server_routes_alliance.html">server/routes/alliance</a><ul class='methods'><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-members">GET /api/alliance-members</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/chat">GET /api/chat</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/chat/mark-read">POST /api/chat/mark-read</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/company-name">POST /api/company-name</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/send-message">POST /api/send-message</a></li></ul></li><li><a href="module-server_routes_anchor.html">server/routes/anchor</a></li><li><a href="module-server_routes_coop.html">server/routes/coop</a><ul class='methods'><li data-type='method'><a href="module-server_routes_coop.html#.GET/api/coop/data">GET /api/coop/data</a></li><li data-type='method'><a href="module-server_routes_coop.html#.POST/api/coop/send-max">POST /api/coop/send-max</a></li></ul></li><li><a href="module-server_routes_forecast.html">server/routes/forecast</a><ul class='methods'><li data-type='method'><a href="module-server_routes_forecast.html#~convertCESTToTimezone">convertCESTToTimezone</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~generateChatbotText">generateChatbotText</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~generateMetadata">generateMetadata</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getForecastDataPath">getForecastDataPath</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getNextDayData">getNextDayData</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getPreviousDayData">getPreviousDayData</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getServerLocalTimezone">getServerLocalTimezone</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getTimezoneOffsetHours">getTimezoneOffsetHours</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getValidTimezones">getValidTimezones</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~parseNumericOffset">parseNumericOffset</a></li></ul></li><li><a href="module-server_routes_game.html">server/routes/game</a></li><li><a href="module-server_routes_harbor-map.html">server/routes/harbor-map</a><ul class='methods'><li data-type='method'><a href="module-server_routes_harbor-map.html#~escapeCSVFormula">escapeCSVFormula</a></li><li data-type='method'><a href="module-server_routes_harbor-map.html#~formatHistoryAsTXT">formatHistoryAsTXT</a></li><li data-type='method'><a href="module-server_routes_harbor-map.html#~getGameIndexCached">getGameIndexCached</a></li></ul></li><li><a href="module-server_routes_health.html">server/routes/health</a></li><li><a href="module-server_routes_messenger.html">server/routes/messenger</a><ul class='methods'><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/contact/get-contacts">GET /api/contact/get-contacts</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/hijacking/get-cases">GET /api/hijacking/get-cases</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/messenger/get-chats">GET /api/messenger/get-chats</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/delete-chat">POST /api/messenger/delete-chat</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/get-messages">POST /api/messenger/get-messages</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/send-private">POST /api/messenger/send-private</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/user/search">POST /api/user/search</a></li><li data-type='method'><a href="module-server_routes_messenger.html#~migrateHijackHistory">migrateHijackHistory</a></li></ul></li><li><a href="module-server_routes_poi.html">server/routes/poi</a><ul class='methods'><li data-type='method'><a href="module-server_routes_poi.html#~ensureCacheDir">ensureCacheDir</a></li><li data-type='method'><a href="module-server_routes_poi.html#~fetchAllMuseumsFromAPI">fetchAllMuseumsFromAPI</a></li><li data-type='method'><a href="module-server_routes_poi.html#~fetchAllWrecksFromAPI">fetchAllWrecksFromAPI</a></li><li data-type='method'><a href="module-server_routes_poi.html#~filterPOIsByBbox">filterPOIsByBbox</a></li><li data-type='method'><a href="module-server_routes_poi.html#~initializePOICache">initializePOICache</a></li><li data-type='method'><a href="module-server_routes_poi.html#~isCacheValid">isCacheValid</a></li><li data-type='method'><a href="module-server_routes_poi.html#~loadFromCache">loadFromCache</a></li><li data-type='method'><a href="module-server_routes_poi.html#~reduceWreckData">reduceWreckData</a></li><li data-type='method'><a href="module-server_routes_poi.html#~saveToCache">saveToCache</a></li><li data-type='method'><a href="module-server_routes_poi.html#~startAutomaticCacheRefresh">startAutomaticCacheRefresh</a></li></ul></li><li><a href="module-server_routes_settings.html">server/routes/settings</a><ul class='methods'><li data-type='method'><a href="module-server_routes_settings.html#.GET/api/settings">GET /api/settings</a></li><li data-type='method'><a href="module-server_routes_settings.html#.POST/api/settings">POST /api/settings</a></li></ul></li><li><a href="module-server_routes_vessel-image.html">server/routes/vessel-image</a></li><li><a href="module-server_scheduler.html">server/scheduler</a><ul class='methods'><li data-type='method'><a href="module-server_scheduler.html#~initScheduler">initScheduler</a></li><li data-type='method'><a href="module-server_scheduler.html#~isServerReady">isServerReady</a></li></ul></li><li><a href="module-server_settings-schema.html">server/settings-schema</a><ul class='methods'><li data-type='method'><a href="module-server_settings-schema.html#~getDefault">getDefault</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getDefaults">getDefaults</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getRequiredKeys">getRequiredKeys</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getSettingsFilePath">getSettingsFilePath</a></li><li data-type='method'><a href="module-server_settings-schema.html#~initializeSettings">initializeSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~saveSettings">saveSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~validateSettings">validateSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~validateValue">validateValue</a></li></ul></li><li><a href="module-server_state.html">server/state</a><ul class='methods'><li data-type='method'><a href="module-server_state.html#~getAllLocks">getAllLocks</a></li><li data-type='method'><a href="module-server_state.html#~getAutopilotState">getAutopilotState</a></li><li data-type='method'><a href="module-server_state.html#~getBunkerState">getBunkerState</a></li><li data-type='method'><a href="module-server_state.html#~getCampaignStatus">getCampaignStatus</a></li><li data-type='method'><a href="module-server_state.html#~getCoopData">getCoopData</a></li><li data-type='method'><a href="module-server_state.html#~getDrydockCount">getDrydockCount</a></li><li data-type='method'><a href="module-server_state.html#~getEventData">getEventData</a></li><li data-type='method'><a href="module-server_state.html#~getHeaderData">getHeaderData</a></li><li data-type='method'><a href="module-server_state.html#~getLastCO2Alert">getLastCO2Alert</a></li><li data-type='method'><a href="module-server_state.html#~getLastFuelAlert">getLastFuelAlert</a></li><li data-type='method'><a href="module-server_state.html#~getLockStatus">getLockStatus</a></li><li data-type='method'><a href="module-server_state.html#~getPrices">getPrices</a></li><li data-type='method'><a href="module-server_state.html#~getRepairCount">getRepairCount</a></li><li data-type='method'><a href="module-server_state.html#~getSettings">getSettings</a></li><li data-type='method'><a href="module-server_state.html#~getUserState">getUserState</a></li><li data-type='method'><a href="module-server_state.html#~getVesselCounts">getVesselCounts</a></li><li data-type='method'><a href="module-server_state.html#~isAutopilotPaused">isAutopilotPaused</a></li><li data-type='method'><a href="module-server_state.html#~setAutopilotPaused">setAutopilotPaused</a></li><li data-type='method'><a href="module-server_state.html#~setAutopilotState">setAutopilotState</a></li><li data-type='method'><a href="module-server_state.html#~setLastCO2Alert">setLastCO2Alert</a></li><li data-type='method'><a href="module-server_state.html#~setLastFuelAlert">setLastFuelAlert</a></li><li data-type='method'><a href="module-server_state.html#~setLockStatus">setLockStatus</a></li><li data-type='method'><a href="module-server_state.html#~updateBunkerState">updateBunkerState</a></li><li data-type='method'><a href="module-server_state.html#~updateCampaignStatus">updateCampaignStatus</a></li><li data-type='method'><a href="module-server_state.html#~updateCoopData">updateCoopData</a></li><li data-type='method'><a href="module-server_state.html#~updateDrydockCount">updateDrydockCount</a></li><li data-type='method'><a href="module-server_state.html#~updateEventData">updateEventData</a></li><li data-type='method'><a href="module-server_state.html#~updateHeaderData">updateHeaderData</a></li><li data-type='method'><a href="module-server_state.html#~updatePrices">updatePrices</a></li><li data-type='method'><a href="module-server_state.html#~updateRepairCount">updateRepairCount</a></li><li data-type='method'><a href="module-server_state.html#~updateSettings">updateSettings</a></li><li data-type='method'><a href="module-server_state.html#~updateVesselCounts">updateVesselCounts</a></li></ul></li><li><a href="module-server_utils_api.html">server/utils/api</a><ul class='methods'><li data-type='method'><a href="module-server_utils_api.html#~apiCall">apiCall</a></li><li data-type='method'><a href="module-server_utils_api.html#~apiCallWithRetry">apiCallWithRetry</a></li><li data-type='method'><a href="module-server_utils_api.html#~getAllianceId">getAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~getChatFeed">getChatFeed</a></li><li data-type='method'><a href="module-server_utils_api.html#~getCompanyName">getCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserCompanyName">getUserCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserId">getUserId</a></li><li data-type='method'><a href="module-server_utils_api.html#~initializeAlliance">initializeAlliance</a></li><li data-type='method'><a href="module-server_utils_api.html#~sleep">sleep</a></li></ul></li><li><a href="module-server_utils_audit-logger.html">server/utils/audit-logger</a><ul class='methods'><li data-type='method'><a href="module-server_utils_audit-logger.html#~auditLog">auditLog</a></li><li data-type='method'><a href="module-server_utils_audit-logger.html#~formatCurrency">formatCurrency</a></li><li data-type='method'><a href="module-server_utils_audit-logger.html#~formatNumber">formatNumber</a></li></ul></li><li><a href="module-server_utils_encryption.html">server/utils/encryption</a><ul class='methods'><li data-type='method'><a href="module-server_utils_encryption.html#~decryptData">decryptData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~deleteEncryptedData">deleteEncryptedData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~encryptData">encryptData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~getEncryptionInfo">getEncryptionInfo</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~getMachineKey">getMachineKey</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~isEncrypted">isEncrypted</a></li></ul></li><li><a href="module-server_utils_harbor-fee-store.html">server/utils/harbor-fee-store</a><ul class='methods'><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~enrichHistoryWithFees">enrichHistoryWithFees</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~ensureDirectory">ensureDirectory</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~getFilePath">getFilePath</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~getHarborFee">getHarborFee</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~isMigrationCompleted">isMigrationCompleted</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~loadHarborFees">loadHarborFees</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~markMigrationCompleted">markMigrationCompleted</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~saveHarborFee">saveHarborFee</a></li></ul></li><li><a href="module-server_utils_logger.html">server/utils/logger</a><ul class='methods'><li data-type='method'><a href="module-server_utils_logger.html#~debug">debug</a></li><li data-type='method'><a href="module-server_utils_logger.html#~error">error</a></li><li data-type='method'><a href="module-server_utils_logger.html#~info">info</a></li><li data-type='method'><a href="module-server_utils_logger.html#~isDebugMode">isDebugMode</a></li><li data-type='method'><a href="module-server_utils_logger.html#~loadLogLevel">loadLogLevel</a></li><li data-type='method'><a href="module-server_utils_logger.html#~warn">warn</a></li></ul></li><li><a href="module-server_utils_migrate-harbor-fees.html">server/utils/migrate-harbor-fees</a><ul class='methods'><li data-type='method'><a href="module-server_utils_migrate-harbor-fees.html#~migrateAllHarborFees">migrateAllHarborFees</a></li><li data-type='method'><a href="module-server_utils_migrate-harbor-fees.html#~migrateHarborFeesForUser">migrateHarborFeesForUser</a></li><li data-type='method'><a href="module-server_utils_migrate-harbor-fees.html#~resolveVesselNameToId">resolveVesselNameToId</a></li><li data-type='method'><a href="module-server_utils_migrate-harbor-fees.html#~timestampToMySQLDatetime">timestampToMySQLDatetime</a></li></ul></li><li><a href="module-server_utils_read-tracker.html">server/utils/read-tracker</a><ul class='methods'><li data-type='method'><a href="module-server_utils_read-tracker.html#~ensureReadTrackingFile">ensureReadTrackingFile</a></li><li data-type='method'><a href="module-server_utils_read-tracker.html#~getLastReadTimestamp">getLastReadTimestamp</a></li><li data-type='method'><a href="module-server_utils_read-tracker.html#~saveReadTrackingFile">saveReadTrackingFile</a></li><li data-type='method'><a href="module-server_utils_read-tracker.html#~updateLastReadTimestamp">updateLastReadTimestamp</a></li></ul></li><li><a href="module-server_utils_session-manager.html">server/utils/session-manager</a><ul class='methods'><li data-type='method'><a href="module-server_utils_session-manager.html#~deleteSession">deleteSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getAllUserIds">getAllUserIds</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getAvailableSessions">getAvailableSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getSession">getSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getSessionsPath">getSessionsPath</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~hasSession">hasSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~loadAllSessions">loadAllSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~loadSessions">loadSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~migrateToEncrypted">migrateToEncrypted</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~saveSession">saveSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~saveSessions">saveSessions</a></li></ul></li><li><a href="module-server_websocket.html">server/websocket</a><ul class='methods'><li data-type='method'><a href="module-server_websocket.html#~broadcast">broadcast</a></li><li data-type='method'><a href="module-server_websocket.html#~broadcastBunkerUpdate">broadcastBunkerUpdate</a></li><li data-type='method'><a href="module-server_websocket.html#~broadcastHarborMapRefresh">broadcastHarborMapRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~broadcastToUser">broadcastToUser</a></li><li data-type='method'><a href="module-server_websocket.html#~getCachedHijackingCase">getCachedHijackingCase</a></li><li data-type='method'><a href="module-server_websocket.html#~getCachedMessengerChats">getCachedMessengerChats</a></li><li data-type='method'><a href="module-server_websocket.html#~getProcessedMessageIds">getProcessedMessageIds</a></li><li data-type='method'><a href="module-server_websocket.html#~getProcessedMessagesCachePath">getProcessedMessagesCachePath</a></li><li data-type='method'><a href="module-server_websocket.html#~initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-server_websocket.html#~loadProcessedMessageCache">loadProcessedMessageCache</a></li><li data-type='method'><a href="module-server_websocket.html#~performChatRefresh">performChatRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~performHijackingRefresh">performHijackingRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~performMessengerRefresh">performMessengerRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~saveProcessedMessageCache">saveProcessedMessageCache</a></li><li data-type='method'><a href="module-server_websocket.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~startHijackingAutoRefresh">startHijackingAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~startMessengerAutoRefresh">startMessengerAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopChatAutoRefresh">stopChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopHijackingAutoRefresh">stopHijackingAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopMessengerAutoRefresh">stopMessengerAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~triggerImmediateChatRefresh">triggerImmediateChatRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~triggerImmediateHijackingRefresh">triggerImmediateHijackingRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~triggerImmediateMessengerRefresh">triggerImmediateMessengerRefresh</a></li></ul></li><li><a href="module-ui-dialogs.html">ui-dialogs</a><ul class='methods'><li data-type='method'><a href="module-ui-dialogs.html#.buyCampaign">buyCampaign</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeCampaignsOverlay">closeCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeSettings">closeSettings</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showCampaignsOverlay">showCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showConfirmDialog">showConfirmDialog</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showContactList">showContactList</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showSettings">showSettings</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#.escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-utils.html#.formatNumber">formatNumber</a></li><li data-type='method'><a href="module-utils.html#.isMobileDevice">isMobileDevice</a></li><li data-type='method'><a href="module-utils.html#.registerServiceWorker">registerServiceWorker</a></li><li data-type='method'><a href="module-utils.html#.renderStars">renderStars</a></li><li data-type='method'><a href="module-utils.html#.requestNotificationPermission">requestNotificationPermission</a></li><li data-type='method'><a href="module-utils.html#.showNotification">showNotification</a></li><li data-type='method'><a href="module-utils.html#.showSideNotification">showSideNotification</a></li></ul></li><li><a href="module-vessel-management.html">vessel-management</a><ul class='methods'><li data-type='method'><a href="module-vessel-management.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.openRepairAndDrydockDialog">openRepairAndDrydockDialog</a></li><li data-type='method'><a href="module-vessel-management.html#.purchaseSingleVessel">purchaseSingleVessel</a></li><li data-type='method'><a href="module-vessel-management.html#.updateLockStateFromServer">updateLockStateFromServer</a></li><li data-type='method'><a href="module-vessel-management.html#.updateVesselCount">updateVesselCount</a></li><li data-type='method'><a href="module-vessel-management.html#~createVesselCard">createVesselCard</a></li><li data-type='method'><a href="module-vessel-management.html#~displayFilteredVessels">displayFilteredVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~executeDrydock">executeDrydock</a></li><li data-type='method'><a href="module-vessel-management.html#~getAvailableAnchorSlots">getAvailableAnchorSlots</a></li><li data-type='method'><a href="module-vessel-management.html#~getCO2EfficiencyClass">getCO2EfficiencyClass</a></li><li data-type='method'><a href="module-vessel-management.html#~getCapacityDisplay">getCapacityDisplay</a></li><li data-type='method'><a href="module-vessel-management.html#~getFuelEfficiencyClass">getFuelEfficiencyClass</a></li><li data-type='method'><a href="module-vessel-management.html#~loadCartFromStorage">loadCartFromStorage</a></li><li data-type='method'><a href="module-vessel-management.html#~loadMorePendingVessels">loadMorePendingVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~loadMoreVessels">loadMoreVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~populateDynamicFilters">populateDynamicFilters</a></li><li data-type='method'><a href="module-vessel-management.html#~preloadCommonVesselImages">preloadCommonVesselImages</a></li><li data-type='method'><a href="module-vessel-management.html#~preloadVesselImage">preloadVesselImage</a></li><li data-type='method'><a href="module-vessel-management.html#~refreshVesselCardsIfVisible">refreshVesselCardsIfVisible</a></li><li data-type='method'><a href="module-vessel-management.html#~renderDrydockTab">renderDrydockTab</a></li><li data-type='method'><a href="module-vessel-management.html#~renderRepairTab">renderRepairTab</a></li><li data-type='method'><a href="module-vessel-management.html#~saveCartToStorage">saveCartToStorage</a></li><li data-type='method'><a href="module-vessel-management.html#~showRepairAndDrydockDialog">showRepairAndDrydockDialog</a></li><li data-type='method'><a href="module-vessel-management.html#~updateCapacityDropdowns">updateCapacityDropdowns</a></li><li data-type='method'><a href="module-vessel-management.html#~vesselPassesFilters">vesselPassesFilters</a></li></ul></li><li><a href="module-vessel-selling.html">vessel-selling</a><ul class='methods'><li data-type='method'><a href="module-vessel-selling.html#.bulkSellVessels">bulkSellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#.closeSellVesselsOverlay">closeSellVesselsOverlay</a></li><li data-type='method'><a href="module-vessel-selling.html#.openSellVesselsOverlay">openSellVesselsOverlay</a></li><li data-type='method'><a href="module-vessel-selling.html#.refreshVesselsForSale">refreshVesselsForSale</a></li><li data-type='method'><a href="module-vessel-selling.html#.setSellFilter">setSellFilter</a></li><li data-type='method'><a href="module-vessel-selling.html#.showSellCart">showSellCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~clearSellCartCache">clearSellCartCache</a></li><li data-type='method'><a href="module-vessel-selling.html#~displaySellVessels">displaySellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#~getCO2EfficiencyClass">getCO2EfficiencyClass</a></li><li data-type='method'><a href="module-vessel-selling.html#~getCapacityDisplay">getCapacityDisplay</a></li><li data-type='method'><a href="module-vessel-selling.html#~getFuelEfficiencyClass">getFuelEfficiencyClass</a></li><li data-type='method'><a href="module-vessel-selling.html#~groupVesselsByModel">groupVesselsByModel</a></li><li data-type='method'><a href="module-vessel-selling.html#~loadSellCartFromCache">loadSellCartFromCache</a></li><li data-type='method'><a href="module-vessel-selling.html#~loadUserVesselsForSale">loadUserVesselsForSale</a></li><li data-type='method'><a href="module-vessel-selling.html#~removeVesselSelectionFromCart">removeVesselSelectionFromCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~saveSellCartToCache">saveSellCartToCache</a></li><li data-type='method'><a href="module-vessel-selling.html#~sellVessels">sellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateBulkSellButton">updateBulkSellButton</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateSelectButtonState">updateSelectButtonState</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateVesselSelectionInCart">updateVesselSelectionInCart</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#buildNav">buildNav</a></li><li><a href="global.html#deleteAllLogs">deleteAllLogs</a></li><li><a href="global.html#escapeCSVFormula">escapeCSVFormula</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#flushAllToDisk">flushAllToDisk</a></li><li><a href="global.html#formatDetailsAsTXT">formatDetailsAsTXT</a></li><li><a href="global.html#formatFileSize">formatFileSize</a></li><li><a href="global.html#formatLogsAsCSV">formatLogsAsCSV</a></li><li><a href="global.html#formatLogsAsTXT">formatLogsAsTXT</a></li><li><a href="global.html#fs">fs</a></li><li><a href="global.html#getCategoryFromAction">getCategoryFromAction</a></li><li><a href="global.html#getLogEntries">getLogEntries</a></li><li><a href="global.html#getLogFilePath">getLogFilePath</a></li><li><a href="global.html#getLogFileSize">getLogFileSize</a></li><li><a href="global.html#getLogsFromCache">getLogsFromCache</a></li><li><a href="global.html#getSourceFromAction">getSourceFromAction</a></li><li><a href="global.html#getTransactionType">getTransactionType</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#isDepartInProgress">isDepartInProgress</a></li><li><a href="global.html#loadLogsFromDisk">loadLogsFromDisk</a></li><li><a href="global.html#lockBulkBuyButton">lockBulkBuyButton</a></li><li><a href="global.html#lockCo2Button">lockCo2Button</a></li><li><a href="global.html#lockCoopButtons">lockCoopButtons</a></li><li><a href="global.html#lockDepartButton">lockDepartButton</a></li><li><a href="global.html#lockDrydockButton">lockDrydockButton</a></li><li><a href="global.html#lockFuelButton">lockFuelButton</a></li><li><a href="global.html#lockRepairButton">lockRepairButton</a></li><li><a href="global.html#logAutopilotAction">logAutopilotAction</a></li><li><a href="global.html#publish">publish</a></li><li><a href="global.html#searchInObject">searchInObject</a></li><li><a href="global.html#showAnchorTimer">showAnchorTimer</a></li><li><a href="global.html#shutdown">shutdown</a></li><li><a href="global.html#unlockBulkBuyButton">unlockBulkBuyButton</a></li><li><a href="global.html#unlockCo2Button">unlockCo2Button</a></li><li><a href="global.html#unlockCoopButtons">unlockCoopButtons</a></li><li><a href="global.html#unlockDepartButton">unlockDepartButton</a></li><li><a href="global.html#unlockDrydockButton">unlockDrydockButton</a></li><li><a href="global.html#unlockFuelButton">unlockFuelButton</a></li><li><a href="global.html#unlockRepairButton">unlockRepairButton</a></li><li><a href="global.html#writeLogsToDisk">writeLogsToDisk</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">server/routes/game.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Game Management API Routes
 *
 * This module provides HTTP endpoints for managing game resources including vessels,
 * fuel/CO2 purchases, user settings, vessel maintenance, marketing campaigns, and
 * vessel acquisitions. These endpoints proxy requests to the Shipping Manager game API
 * while adding validation and error handling.
 *
 * Key Features:
 * - Vessel management (list vessels in harbor, purchase new vessels, bulk repairs)
 * - Bunker operations (fuel and CO2 price monitoring and purchasing)
 * - Route management (depart all vessels at once)
 * - Marketing campaigns (view available campaigns, activate/renew)
 * - User settings retrieval (anchor points, company data)
 *
 * Why This Module:
 * - Consolidates all game resource management endpoints
 * - Provides validation before forwarding to game API
 * - Standardizes error responses across all game operations
 * - Enables automation features (auto-rebuy, auto-depart, auto-repair)
 *
 * Common Patterns:
 * - GET endpoints retrieve current state (prices, vessels, settings)
 * - POST endpoints perform actions (purchase, depart, repair)
 * - All endpoints include error handling with descriptive messages
 * - Graceful degradation (empty arrays instead of errors for UI-critical endpoints)
 *
 * @requires express - Router and middleware
 * @requires ../utils/api - API helper function (apiCall)
 * @module server/routes/game
 */

const express = require('express');
const validator = require('validator');
const { apiCall, apiCallWithRetry, getUserId } = require('../utils/api');
const gameapi = require('../gameapi');
const { broadcastToUser } = require('../websocket');
const fs = require('fs').promises;
const logger = require('../utils/logger');
const autopilot = require('../autopilot');
const { auditLog, CATEGORIES, SOURCES, formatCurrency } = require('../utils/audit-logger');

const router = express.Router();

/** GET /api/vessel/get-vessels - Retrieves all vessels currently in harbor. Uses /game/index endpoint to get complete vessel list with status, cargo, maintenance needs, etc. Also caches company_type in local settings. */
router.get('/vessel/get-vessels', async (req, res) => {
  try {
    const data = await apiCallWithRetry('/game/index', 'POST', {});

    // Cache company_type in local settings for offline access
    const userId = getUserId();
    if (userId &amp;&amp; data.user?.company_type) {
      try {
        const { getSettingsFilePath } = require('../settings-schema');
        const settingsFile = getSettingsFilePath(userId);

        // Read current settings
        const settingsData = await fs.readFile(settingsFile, 'utf8');
        const settings = JSON.parse(settingsData);

        // Update company_type
        settings.company_type = data.user.company_type;

        // Write back to file
        await fs.writeFile(settingsFile, JSON.stringify(settings, null, 2), 'utf8');

        logger.debug(`[Vessel API] Cached company_type: ${JSON.stringify(data.user.company_type)}`);
      } catch (cacheError) {
        // Don't fail the request if caching fails
        logger.warn('[Vessel API] Failed to cache company_type:', cacheError.message);
      }
    }

    res.json({
      vessels: data.data.user_vessels,
      experience_points: data.data.experience_points,
      levelup_experience_points: data.data.levelup_experience_points,
      company_type: data.user?.company_type
    });
  } catch (error) {
    logger.error('Error getting vessels:', error);
    res.status(500).json({ error: 'Failed to retrieve vessels' });
  }
});

/** POST /api/user/get-company - Returns user company data including capacity values. */
router.post('/user/get-company', express.json(), async (req, res) => {
  try {
    const data = await apiCall('/user/get-company', 'POST', {});
    res.json(data);
  } catch (error) {
    logger.error('Error fetching company data:', error);
    res.status(500).json({ error: 'Failed to fetch company data' });
  }
});

/** GET /api/user/get-settings - Retrieves user settings including anchor points (used for auto-rebuy calculations). Also caches company_type in local settings. */
router.get('/user/get-settings', async (req, res) => {
  try {
    const data = await apiCall('/user/get-user-settings', 'GET', {});

    // Cache company_type in local settings for offline access
    const userId = getUserId();
    if (userId &amp;&amp; data.user?.company_type) {
      try {
        const { getSettingsFilePath } = require('../settings-schema');
        const settingsFile = getSettingsFilePath(userId);

        // Read current settings
        const settingsData = await fs.readFile(settingsFile, 'utf8');
        const settings = JSON.parse(settingsData);

        // Update company_type
        settings.company_type = data.user.company_type;

        // Write back to file
        await fs.writeFile(settingsFile, JSON.stringify(settings, null, 2), 'utf8');

        logger.debug(`[User Settings] Cached company_type: ${JSON.stringify(data.user.company_type)}`);
      } catch (cacheError) {
        // Don't fail the request if caching fails
        logger.warn('[User Settings] Failed to cache company_type:', cacheError.message);
      }
    }

    res.json(data);
  } catch (error) {
    logger.error('Error getting user settings:', error);
    res.status(500).json({ error: 'Failed to retrieve user settings' });
  }
});

/** GET /api/bunker/get-prices - Fetches current market prices for fuel and CO2. Critical for price alerts and auto-rebuy features. */
router.get('/bunker/get-prices', async (req, res) => {
  try {
    const data = await apiCall('/bunker/get-prices', 'POST', {});
    res.json(data);
  } catch (error) {
    logger.error('Error getting bunker prices:', error);
    res.status(500).json({ error: 'Failed to retrieve bunker prices' });
  }
});

/**
 * POST /api/bunker/purchase-fuel - Purchases specified amount of fuel.
 * Validation: amount must be positive integer. Used by manual purchases and auto-rebuy automation.
 */
router.post('/bunker/purchase-fuel', express.json(), async (req, res) => {
  const { amount } = req.body;

  if (!amount || !Number.isInteger(amount) || amount &lt;= 0) {
    return res.status(400).json({ error: 'Invalid amount' });
  }

  const userId = getUserId();
  const state = require('../state');

  // LOCK: Prevent concurrent fuel purchases (race condition protection)
  if (state.getLockStatus(userId, 'fuelPurchase')) {
    logger.debug('[Fuel Purchase] SKIPPED - Another fuel purchase is already in progress');
    return res.status(409).json({ error: 'Fuel purchase already in progress' });
  }

  // Set lock and broadcast to all clients
  state.setLockStatus(userId, 'fuelPurchase', true);
  if (userId) {
    broadcastToUser(userId, 'fuel_purchase_start', {});
    broadcastToUser(userId, 'lock_status', {
      depart: state.getLockStatus(userId, 'depart'),
      fuelPurchase: true,
      co2Purchase: state.getLockStatus(userId, 'co2Purchase'),
      repair: state.getLockStatus(userId, 'repair'),
      bulkBuy: state.getLockStatus(userId, 'bulkBuy')
    });
  }
  logger.debug('[Fuel Purchase] Lock acquired');

  try {
    // Get cash BEFORE purchase to calculate actual cost
    const bunkerBefore = state.getBunkerState(userId);
    const cashBefore = bunkerBefore ? bunkerBefore.cash : 0;

    // API expects amount in tons (NOT kg) - send directly
    const data = await apiCall('/bunker/purchase-fuel', 'POST', { amount });

    // Broadcast bunker update to all clients (manual purchase)
    if (userId &amp;&amp; data.user) {
      // API doesn't return capacity fields - use values from state
      const { broadcastBunkerUpdate } = require('../websocket');

      broadcastBunkerUpdate(userId, {
        fuel: data.user.fuel / 1000,
        co2: (data.user.co2 || data.user.co2_certificate) / 1000,
        cash: data.user.cash,
        maxFuel: bunkerBefore.maxFuel,
        maxCO2: bunkerBefore.maxCO2
      });

      // Calculate ACTUAL cost from API response (includes discounts!)
      const cashAfter = data.user.cash;
      const actualCost = Math.round(cashBefore - cashAfter);
      const actualPricePerTon = Math.round(actualCost / amount);

      logger.info(`[Manual Fuel Purchase] User bought ${amount}t @ $${actualPricePerTon}/t = $${actualCost.toLocaleString('en-US')} (Cash before: $${cashBefore.toLocaleString('en-US')} Cash after: $${cashAfter.toLocaleString('en-US')})`);

      // AUDIT LOG: Manual fuel purchase
      // (using audit-logger imported at top of file)

      // Validate data - FAIL LOUD if missing
      if (!data.user || data.user.fuel === undefined || data.user.fuel === null) {
        throw new Error('API response missing user.fuel data');
      }

      await auditLog(
        userId,
        CATEGORIES.BUNKER,
        'Manual Fuel Purchase',
        `+${amount}t @ ${formatCurrency(actualPricePerTon)}/t = ${formatCurrency(actualCost)}`,
        {
          amount_tons: amount,
          price_per_ton: actualPricePerTon,
          total_cost: actualCost,
          balance_before: cashBefore,
          balance_after: cashAfter,
          inventory_before_kg: bunkerBefore.fuel,
          inventory_after_kg: data.user.fuel
        },
        'SUCCESS',
        SOURCES.MANUAL
      );

      broadcastToUser(userId, 'user_action_notification', {
        type: 'success',
        message: `
          &lt;div style="font-family: monospace; font-size: 13px;">
            &lt;div style="text-align: center; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 8px; margin-bottom: 12px;">
              &lt;strong style="font-size: 14px;"> Fuel Purchase&lt;/strong>
            &lt;/div>
            &lt;div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
              &lt;span>Amount:&lt;/span>
              &lt;span>&lt;strong>${Math.round(amount).toLocaleString('en-US')}t&lt;/strong>&lt;/span>
            &lt;/div>
            &lt;div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
              &lt;span>Price per ton:&lt;/span>
              &lt;span>$${actualPricePerTon}/t&lt;/span>
            &lt;/div>
            &lt;div style="height: 1px; background: rgba(255,255,255,0.2); margin: 10px 0;">&lt;/div>
            &lt;div style="display: flex; justify-content: space-between; font-size: 15px;">
              &lt;span>&lt;strong>Total:&lt;/strong>&lt;/span>
              &lt;span style="color: #ef4444;">&lt;strong>$${actualCost.toLocaleString('en-US')}&lt;/strong>&lt;/span>
            &lt;/div>
          &lt;/div>
        `
      });

      // Trigger immediate data update
      await autopilot.tryUpdateAllData();
    }

    // Release lock BEFORE sending response
    state.setLockStatus(userId, 'fuelPurchase', false);
    logger.debug('[Fuel Purchase] Lock released');

    // Broadcast fuel purchase complete and updated lock status
    broadcastToUser(userId, 'fuel_purchase_complete', { amount });
    broadcastToUser(userId, 'lock_status', {
      depart: state.getLockStatus(userId, 'depart'),
      fuelPurchase: false,
      co2Purchase: state.getLockStatus(userId, 'co2Purchase'),
      repair: state.getLockStatus(userId, 'repair'),
      bulkBuy: state.getLockStatus(userId, 'bulkBuy')
    });

    res.json(data);
  } catch (error) {
    logger.error('Error purchasing fuel:', error);

    // Release lock on error
    state.setLockStatus(userId, 'fuelPurchase', false);

    // Broadcast error notification to all clients
    if (userId) {
      // Escape error message to prevent XSS
      const safeErrorMessage = validator.escape(error.message || 'Unknown error');
      broadcastToUser(userId, 'user_action_notification', {
        type: 'error',
        message: ` &lt;strong>Purchase Failed&lt;/strong>&lt;br>&lt;br>${safeErrorMessage}`
      });

      // Broadcast fuel purchase complete and updated lock status
      broadcastToUser(userId, 'fuel_purchase_complete', { amount: 0 });
      broadcastToUser(userId, 'lock_status', {
        depart: state.getLockStatus(userId, 'depart'),
        fuelPurchase: false,
        co2Purchase: state.getLockStatus(userId, 'co2Purchase'),
        repair: state.getLockStatus(userId, 'repair'),
        bulkBuy: state.getLockStatus(userId, 'bulkBuy')
      });
    }

    res.status(500).json({ error: 'Failed to purchase fuel' });
  } finally {
    // ALWAYS release lock, even if error occurred
    state.setLockStatus(userId, 'fuelPurchase', false);
    logger.debug('[Fuel Purchase] Lock released (finally)');
  }
});

/**
 * POST /api/bunker/purchase-co2 - Purchases specified amount of CO2 certificates.
 * Validation: amount must be positive integer. Used by manual purchases and auto-rebuy automation.
 */
router.post('/bunker/purchase-co2', express.json(), async (req, res) => {
  const { amount } = req.body;

  if (!amount || !Number.isInteger(amount) || amount &lt;= 0) {
    return res.status(400).json({ error: 'Invalid amount' });
  }

  const userId = getUserId();
  const state = require('../state');

  // LOCK: Prevent concurrent CO2 purchases (race condition protection)
  if (state.getLockStatus(userId, 'co2Purchase')) {
    logger.debug('[CO2 Purchase] SKIPPED - Another CO2 purchase is already in progress');
    return res.status(409).json({ error: 'CO2 purchase already in progress' });
  }

  // Set lock and broadcast to all clients
  state.setLockStatus(userId, 'co2Purchase', true);
  if (userId) {
    broadcastToUser(userId, 'co2_purchase_start', {});
    broadcastToUser(userId, 'lock_status', {
      depart: state.getLockStatus(userId, 'depart'),
      fuelPurchase: state.getLockStatus(userId, 'fuelPurchase'),
      co2Purchase: true,
      repair: state.getLockStatus(userId, 'repair'),
      bulkBuy: state.getLockStatus(userId, 'bulkBuy')
    });
  }
  logger.debug('[CO2 Purchase] Lock acquired');

  try {
    // Get cash BEFORE purchase to calculate actual cost
    const bunkerBefore = state.getBunkerState(userId);
    const cashBefore = bunkerBefore ? bunkerBefore.cash : 0;

    // API expects amount in tons (NOT kg) - send directly
    const data = await apiCall('/bunker/purchase-co2', 'POST', { amount });

    // Broadcast bunker update to all clients (manual purchase)
    if (userId &amp;&amp; data.user) {
      // API doesn't return capacity fields - use values from state
      const { broadcastBunkerUpdate } = require('../websocket');

      broadcastBunkerUpdate(userId, {
        fuel: data.user.fuel / 1000,
        co2: (data.user.co2 || data.user.co2_certificate) / 1000,
        cash: data.user.cash,
        maxFuel: bunkerBefore.maxFuel,
        maxCO2: bunkerBefore.maxCO2
      });

      // Calculate ACTUAL cost from API response (includes discounts!)
      const cashAfter = data.user.cash;
      const actualCost = Math.round(cashBefore - cashAfter);
      const actualPricePerTon = Math.round(actualCost / amount);

      logger.info(`[Manual CO2 Purchase] User bought ${amount}t @ $${actualPricePerTon}/t = $${actualCost.toLocaleString('en-US')} (Cash before: $${cashBefore.toLocaleString('en-US')} Cash after: $${cashAfter.toLocaleString('en-US')})`);

      // AUDIT LOG: Manual CO2 purchase
      // (using audit-logger imported at top of file)

      // Validate data - FAIL LOUD if missing
      const co2After = data.user.co2 || data.user.co2_certificate;
      if (co2After === undefined || co2After === null) {
        throw new Error('API response missing user.co2/co2_certificate data');
      }

      await auditLog(
        userId,
        CATEGORIES.BUNKER,
        'Manual CO2 Purchase',
        `+${amount}t @ ${formatCurrency(actualPricePerTon)}/t = ${formatCurrency(actualCost)}`,
        {
          amount_tons: amount,
          price_per_ton: actualPricePerTon,
          total_cost: actualCost,
          balance_before: cashBefore,
          balance_after: cashAfter,
          inventory_before_kg: bunkerBefore.co2,
          inventory_after_kg: co2After
        },
        'SUCCESS',
        SOURCES.MANUAL
      );

      broadcastToUser(userId, 'user_action_notification', {
        type: 'success',
        message: `
          &lt;div style="font-family: monospace; font-size: 13px;">
            &lt;div style="text-align: center; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 8px; margin-bottom: 12px;">
              &lt;strong style="font-size: 14px;"> CO2 Purchase&lt;/strong>
            &lt;/div>
            &lt;div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
              &lt;span>Amount:&lt;/span>
              &lt;span>&lt;strong>${Math.round(amount).toLocaleString('en-US')}t&lt;/strong>&lt;/span>
            &lt;/div>
            &lt;div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
              &lt;span>Price per ton:&lt;/span>
              &lt;span>$${actualPricePerTon}/t&lt;/span>
            &lt;/div>
            &lt;div style="height: 1px; background: rgba(255,255,255,0.2); margin: 10px 0;">&lt;/div>
            &lt;div style="display: flex; justify-content: space-between; font-size: 15px;">
              &lt;span>&lt;strong>Total:&lt;/strong>&lt;/span>
              &lt;span style="color: #ef4444;">&lt;strong>$${actualCost.toLocaleString('en-US')}&lt;/strong>&lt;/span>
            &lt;/div>
          &lt;/div>
        `
      });

      // Trigger immediate data update
      await autopilot.tryUpdateAllData();
    }

    // Release lock BEFORE sending response
    state.setLockStatus(userId, 'co2Purchase', false);
    logger.debug('[CO2 Purchase] Lock released');

    // Broadcast CO2 purchase complete and updated lock status
    broadcastToUser(userId, 'co2_purchase_complete', { amount });
    broadcastToUser(userId, 'lock_status', {
      depart: state.getLockStatus(userId, 'depart'),
      fuelPurchase: state.getLockStatus(userId, 'fuelPurchase'),
      co2Purchase: false,
      repair: state.getLockStatus(userId, 'repair'),
      bulkBuy: state.getLockStatus(userId, 'bulkBuy')
    });

    res.json(data);
  } catch (error) {
    logger.error('Error purchasing CO2:', error);

    // Release lock on error
    state.setLockStatus(userId, 'co2Purchase', false);

    // Broadcast error notification to all clients
    if (userId) {
      // Escape error message to prevent XSS
      const safeErrorMessage = validator.escape(error.message || 'Unknown error');
      broadcastToUser(userId, 'user_action_notification', {
        type: 'error',
        message: ` &lt;strong>Purchase Failed&lt;/strong>&lt;br>&lt;br>${safeErrorMessage}`
      });

      // Broadcast CO2 purchase complete and updated lock status
      broadcastToUser(userId, 'co2_purchase_complete', { amount: 0 });
      broadcastToUser(userId, 'lock_status', {
        depart: state.getLockStatus(userId, 'depart'),
        fuelPurchase: state.getLockStatus(userId, 'fuelPurchase'),
        co2Purchase: false,
        repair: state.getLockStatus(userId, 'repair'),
        bulkBuy: state.getLockStatus(userId, 'bulkBuy')
      });
    }

    res.status(500).json({ error: 'Failed to purchase CO2' });
  } finally {
    // ALWAYS release lock, even if error occurred
    state.setLockStatus(userId, 'co2Purchase', false);
    logger.debug('[CO2 Purchase] Lock released (finally)');
  }
});

/**
 * POST /api/route/depart - Universal depart endpoint
 * Accepts optional array of vessel IDs. If no IDs provided, departs ALL vessels in harbor.
 * Uses the EXACT same logic and notifications as autopilot.
 *
 * Request body (optional):
 * {
 *   vessel_ids: [123, 456, 789]  // Optional - if omitted, departs ALL vessels
 * }
 */
router.post('/route/depart', async (req, res) => {
  try {
    const userId = getUserId();

    // Extract vessel IDs from request body (optional)
    const vesselIds = req.body?.vessel_ids || null;

    if (vesselIds &amp;&amp; !Array.isArray(vesselIds)) {
      return res.status(400).json({ error: 'vessel_ids must be an array' });
    }

    if (vesselIds) {
      logger.debug(`[Depart API] Departing ${vesselIds.length} specific vessels`);
    } else {
      logger.debug(`[Depart API] Departing ALL vessels in harbor`);
    }

    // Call universal depart function
    // vesselIds = null means "depart all"
    // vesselIds = [1,2,3] means "depart these specific vessels"
    const { broadcastHarborMapRefresh } = require('../websocket');
    // (using broadcastToUser imported at top of file)
    const result = await autopilot.departVessels(userId, vesselIds, broadcastToUser, autopilot.autoRebuyAll, autopilot.tryUpdateAllData);

    // LOGBOOK: Manual vessel departure (same format as Auto-Depart)
    if (result &amp;&amp; result.success &amp;&amp; result.departedCount > 0) {
      // Log success
      await auditLog(
        userId,
        CATEGORIES.VESSEL,
        'Manual Depart',
        `${result.departedCount} vessels | +${formatCurrency(result.totalRevenue)}`,
        {
          vesselCount: result.departedCount,
          totalRevenue: result.totalRevenue,
          totalFuelUsed: result.totalFuelUsed,
          totalCO2Used: result.totalCO2Used,
          totalHarborFees: result.totalHarborFees,
          departedVessels: result.departedVessels
        },
        'SUCCESS',
        SOURCES.MANUAL
      );

      // Log warnings if any vessels had excessive harbor fees
      if (result.highFeeCount > 0) {
        const totalHarborFees = result.highFeeVessels.reduce((sum, v) => sum + v.harborFee, 0);
        await auditLog(
          userId,
          CATEGORIES.VESSEL,
          'Manual Depart',
          `${result.highFeeCount} vessel${result.highFeeCount > 1 ? 's' : ''} with excessive harbor fees | ${formatCurrency(totalHarborFees)} fees`,
          {
            vesselCount: result.highFeeCount,
            totalHarborFees: totalHarborFees,
            highFeeVessels: result.highFeeVessels
          },
          'WARNING',
          SOURCES.MANUAL
        );
      }
    }

    // Trigger Harbor Map refresh (vessels departed)
    if (broadcastHarborMapRefresh) {
      broadcastHarborMapRefresh(userId, 'vessels_departed', {
        count: vesselIds ? vesselIds.length : 'all'
      });
    }

    res.json(result || { success: true, message: 'Depart triggered' });
  } catch (error) {
    logger.error('[Depart API] Error:', error);
    res.status(500).json({ error: 'Failed to depart vessels' });
  }
});



/**
 * GET /api/port/get-assigned-ports - Retrieves demand and consumed data for all assigned ports.
 * Used by intelligent auto-depart to calculate remaining port capacity.
 * Returns port demand/consumed for both container and tanker cargo types.
 * @returns {Object} data.ports - Array of port objects with demand/consumed data
 */
router.get('/port/get-assigned-ports', async (req, res) => {
  try {
    const data = await apiCall('/port/get-assigned-ports', 'POST', {});
    res.json(data);
  } catch (error) {
    logger.error('Error fetching assigned ports:', error);
    res.status(500).json({ error: 'Failed to fetch assigned ports' });
  }
});

/** POST /api/maintenance/get - Calculates maintenance cost for specified vessels. Returns total repair cost and individual vessel costs. */
router.post('/maintenance/get', express.json(), async (req, res) => {
  const { vessel_ids } = req.body;

  if (!vessel_ids) {
    return res.status(400).json({ error: 'Missing vessel_ids' });
  }

  try {
    const data = await apiCall('/maintenance/get', 'POST', { vessel_ids });
    res.json(data);
  } catch (error) {
    logger.error('Error getting maintenance cost:', error);
    res.status(500).json({ error: 'Failed to get maintenance cost' });
  }
});

/** POST /api/maintenance/do-wear-maintenance-bulk - Performs bulk wear maintenance on multiple vessels. Repairs all specified vessels in a single API call. */
router.post('/maintenance/do-wear-maintenance-bulk', express.json(), async (req, res) => {
  const { vessel_ids } = req.body;

  if (!vessel_ids) {
    return res.status(400).json({ error: 'Missing vessel_ids' });
  }

  try {
    const data = await apiCall('/maintenance/do-wear-maintenance-bulk', 'POST', { vessel_ids });
    res.json(data);
  } catch (error) {
    logger.error('Error performing bulk maintenance:', error);
    res.status(500).json({ error: 'Failed to perform bulk maintenance' });
  }
});

/** POST /api/maintenance/get-drydock-status - Gets drydock maintenance pricing for specified vessels. Returns pricing for major/minor drydock and wear repairs. */
router.post('/maintenance/get-drydock-status', express.json(), async (req, res) => {
  const { vessel_ids, speed, maintenance_type } = req.body;

  if (!vessel_ids) {
    return res.status(400).json({ error: 'Missing vessel_ids' });
  }

  if (!speed || !['maximum', 'minimum'].includes(speed)) {
    return res.status(400).json({ error: 'Invalid speed. Must be "maximum" or "minimum"' });
  }

  if (!maintenance_type || !['major', 'minor'].includes(maintenance_type)) {
    return res.status(400).json({ error: 'Invalid maintenance_type. Must be "major" or "minor"' });
  }

  try {
    const data = await apiCall('/maintenance/get', 'POST', {
      vessel_ids
    });

    // Parse maintenance data and extract correct costs based on type
    const vessels = data.data.vessels.map(v => {
      const maintenanceType = maintenance_type === 'major' ? 'drydock_major' : 'drydock_minor';
      const maintenanceInfo = v.maintenance_data?.find(m => m.type === maintenanceType);

      return {
        id: v.id,
        cost: maintenanceInfo?.discounted_price || maintenanceInfo?.price || 0,
        duration: maintenanceInfo?.duration || 0,
        nearest_dry_dock: v.nearest_dry_dock
      };
    });

    const totalCost = vessels.reduce((sum, v) => sum + v.cost, 0);

    res.json({
      vessels,
      totalCost,
      cash: data.user.cash
    });
  } catch (error) {
    logger.error('Error getting drydock status:', error);
    res.status(500).json({ error: 'Failed to get drydock status' });
  }
});

/** POST /api/maintenance/bulk-drydock - Executes drydock maintenance for specified vessels. Sends vessels to nearest drydock for major or minor antifouling restoration. */
router.post('/maintenance/bulk-drydock', express.json(), async (req, res) => {
  const { vessel_ids, speed, maintenance_type } = req.body;

  if (!vessel_ids) {
    return res.status(400).json({ error: 'Missing vessel_ids' });
  }

  if (!speed || !['maximum', 'minimum'].includes(speed)) {
    return res.status(400).json({ error: 'Invalid speed. Must be "maximum" or "minimum"' });
  }

  if (!maintenance_type || !['major', 'minor'].includes(maintenance_type)) {
    return res.status(400).json({ error: 'Invalid maintenance_type. Must be "major" or "minor"' });
  }

  const userId = getUserId();
  const state = require('../state');

  // LOCK: Prevent concurrent drydock operations (race condition protection)
  if (state.getLockStatus(userId, 'drydock')) {
    logger.debug('[Drydock] SKIPPED - Another drydock operation is already in progress');
    return res.status(409).json({ error: 'Drydock operation already in progress' });
  }

  // Set lock and broadcast to all clients
  state.setLockStatus(userId, 'drydock', true);
  broadcastToUser(userId, 'drydock_start', {});
  broadcastToUser(userId, 'lock_status', {
    depart: state.getLockStatus(userId, 'depart'),
    fuelPurchase: state.getLockStatus(userId, 'fuelPurchase'),
    co2Purchase: state.getLockStatus(userId, 'co2Purchase'),
    repair: state.getLockStatus(userId, 'repair'),
    bulkBuy: state.getLockStatus(userId, 'bulkBuy'),
    drydock: true
  });
  logger.debug('[Drydock] Lock acquired');

  try {
    const data = await apiCall('/maintenance/do-major-drydock-maintenance-bulk', 'POST', {
      vessel_ids,
      speed,
      maintenance_type
    });
    const vesselCount = JSON.parse(vessel_ids).length;
    if (userId &amp;&amp; data.data?.success) {
      logger.info(`[Manual Drydock] User sent ${vesselCount} vessel(s) to drydock (${maintenance_type}, ${speed} speed)`);

      // AUDIT LOG: Manual bulk drydock
      // (using audit-logger imported at top of file)

      const vessels = data.data.vessels || [];
      let totalCost = 0;

      // Calculate total cost if vessel data is available
      if (vessels.length > 0) {
        totalCost = vessels.reduce((sum, v) => sum + (v.cost || 0), 0);
      }

      // Log with available data (even if vessels array is empty)
      await auditLog(
        userId,
        CATEGORIES.VESSEL,
        'Manual Bulk Drydock',
        vessels.length > 0
          ? `Sent ${vessels.length} vessel(s) to ${maintenance_type} drydock (${speed} speed) for ${formatCurrency(totalCost)}`
          : `Sent ${vesselCount} vessel(s) to ${maintenance_type} drydock (${speed} speed)`,
        {
          vessel_count: vessels.length > 0 ? vessels.length : vesselCount,
          total_cost: totalCost > 0 ? totalCost : undefined,
          maintenance_type: maintenance_type,
          speed: speed,
          vessels: vessels.length > 0 ? vessels.map(v => ({
            id: v.id,
            cost: v.cost,
            duration: v.duration,
            nearest_dry_dock: v.nearest_dry_dock
          })) : undefined
        },
        'SUCCESS',
        SOURCES.MANUAL
      );

      // Broadcast success notification
      broadcastToUser(userId, 'user_action_notification', {
        type: 'success',
        message: ` &lt;strong>Drydock Scheduled!&lt;/strong>&lt;br>&lt;br>Sent ${vesselCount} vessel(s) to drydock`
      });

      // Broadcast bunker update (cash/fuel/co2 updated)
      if (data.user) {
        const cachedCapacity = autopilot.getCachedCapacity(userId);
        broadcastToUser(userId, 'bunker_update', {
          fuel: data.user.fuel / 1000,
          co2: (data.user.co2 || data.user.co2_certificate) / 1000,
          cash: data.user.cash,
          maxFuel: cachedCapacity.maxFuel,
          maxCO2: cachedCapacity.maxCO2
        });
      }

      // Trigger immediate drydock count update
      await autopilot.tryUpdateAllData();
    }

    // Release lock BEFORE sending response
    state.setLockStatus(userId, 'drydock', false);
    logger.debug('[Drydock] Lock released');

    // Broadcast drydock complete and updated lock status
    broadcastToUser(userId, 'drydock_complete', { count: vesselCount });
    broadcastToUser(userId, 'lock_status', {
      depart: state.getLockStatus(userId, 'depart'),
      fuelPurchase: state.getLockStatus(userId, 'fuelPurchase'),
      co2Purchase: state.getLockStatus(userId, 'co2Purchase'),
      repair: state.getLockStatus(userId, 'repair'),
      bulkBuy: state.getLockStatus(userId, 'bulkBuy'),
      drydock: false
    });

    res.json(data);
  } catch (error) {
    logger.error('Error executing drydock:', error);

    // Release lock on error
    state.setLockStatus(userId, 'drydock', false);

    if (userId) {
      const safeErrorMessage = validator.escape(error.message || 'Unknown error');
      broadcastToUser(userId, 'user_action_notification', {
        type: 'error',
        message: ` &lt;strong>Drydock Failed&lt;/strong>&lt;br>&lt;br>${safeErrorMessage}`
      });

      // Broadcast drydock complete and updated lock status on error
      broadcastToUser(userId, 'drydock_complete', { count: 0 });
      broadcastToUser(userId, 'lock_status', {
        depart: state.getLockStatus(userId, 'depart'),
        fuelPurchase: state.getLockStatus(userId, 'fuelPurchase'),
        co2Purchase: state.getLockStatus(userId, 'co2Purchase'),
        repair: state.getLockStatus(userId, 'repair'),
        bulkBuy: state.getLockStatus(userId, 'bulkBuy'),
        drydock: false
      });

      // AUDIT LOG: Manual bulk drydock failed
      // (using audit-logger imported at top of file)
      try {
        const vesselCount = vessel_ids ? JSON.parse(vessel_ids).length : 0;

        await auditLog(
          userId,
          CATEGORIES.VESSEL,
          'Manual Bulk Drydock',
          `Failed to send ${vesselCount} vessel(s) to ${maintenance_type || 'unknown'} drydock: ${error.message}`,
          {
            vessel_count: vesselCount,
            maintenance_type: maintenance_type || 'unknown',
            speed: speed || 'unknown',
            error: error.message,
            stack: error.stack
          },
          'ERROR',
          SOURCES.MANUAL
        );
      } catch (auditError) {
        logger.error('[Drydock] Audit logging failed:', auditError.message);
      }
    }

    res.status(500).json({ error: 'Failed to execute drydock' });
  } finally {
    // ALWAYS release lock, even if error occurred
    state.setLockStatus(userId, 'drydock', false);
    logger.debug('[Drydock] Lock released (finally)');
  }
});

/**
 * GET /api/marketing/get-campaigns - Retrieves available marketing campaigns and active campaign status.
 * Graceful error handling: Returns empty arrays instead of error to prevent UI breaking.
 */
router.get('/marketing/get-campaigns', async (req, res) => {
  try {
    const data = await apiCall('/marketing-campaign/get-marketing', 'POST', {});
    res.json(data);
  } catch (error) {
    logger.error('Error getting marketing campaigns:', error.message, error.stack);

    // Return empty campaigns instead of error to prevent UI breaking
    res.json({
      data: {
        marketing_campaigns: [],
        active_campaigns: []
      },
      user: {
        reputation: 0
      }
    });
  }
});

/** POST /api/marketing/activate-campaign - Activates a marketing campaign by campaign_id. Used for manual activation and auto-renewal automation. */
router.post('/marketing/activate-campaign', express.json(), async (req, res) => {
  const { campaign_id } = req.body;

  if (!campaign_id) {
    return res.status(400).json({ error: 'Missing campaign_id' });
  }

  try {
    const data = await apiCall('/marketing-campaign/activate-marketing-campaign', 'POST', { campaign_id });

    // Log campaign activation (regardless of data.success value)
    const userId = getUserId();
    if (userId) {
      // (using audit-logger imported at top of file)
      try {
        // Fetch campaign details to get name and price
        const campaigns = await gameapi.fetchCampaigns();

        // Search in both available and active campaigns (campaign might have moved to active after activation)
        let activatedCampaign = campaigns?.available?.find(c => c.id === campaign_id);
        if (!activatedCampaign) {
          activatedCampaign = campaigns?.active?.find(c => c.id === campaign_id);
        }

        if (activatedCampaign) {
          await auditLog(
            userId,
            CATEGORIES.MARKETING,
            'Campaign Activation',
            `${activatedCampaign.name} (${activatedCampaign.option_name}) | -${formatCurrency(activatedCampaign.price)}`,
            {
              campaign_id,
              campaign_name: activatedCampaign.name,
              campaign_type: activatedCampaign.option_name,
              price: activatedCampaign.price,
              duration: activatedCampaign.duration
            },
            'SUCCESS',
            SOURCES.MANUAL
          );
        } else {
          // Campaign not found in available or active - log with minimal info
          logger.warn(`[Marketing] Campaign ${campaign_id} not found in campaigns list after activation`);
          await auditLog(
            userId,
            CATEGORIES.MARKETING,
            'Campaign Activation',
            `Campaign ID ${campaign_id} activated`,
            {
              campaign_id
            },
            'SUCCESS',
            SOURCES.MANUAL
          );
        }
      } catch (auditError) {
        logger.error('[Marketing] Audit logging failed:', auditError.message);
      }
    }

    // Clear campaign cache to force fresh data fetch
    const cache = require('../cache');
    cache.invalidateCampaignCache();
    logger.debug('[Marketing] Campaign cache invalidated after activation');

    // Trigger data update to refresh campaign badge and header
    // (using autopilot imported at top of file)
    if (autopilot &amp;&amp; autopilot.tryUpdateAllData) {
      try {
        await autopilot.tryUpdateAllData();
        logger.debug('[Marketing] Campaign data update triggered after activation');
      } catch (updateError) {
        logger.error('[Marketing] Failed to update campaign data:', updateError.message);
      }
    }

    res.json(data);
  } catch (error) {
    logger.error('Error activating campaign:', error);

    // Log failed activation attempt
    const userId = getUserId();
    if (userId) {
      // (using audit-logger imported at top of file)
      try {
        await auditLog(
          userId,
          CATEGORIES.MARKETING,
          'Campaign Activation',
          `Failed to activate campaign ${campaign_id}`,
          {
            campaign_id,
            error: error.message
          },
          'ERROR',
          SOURCES.MANUAL
        );
      } catch (auditError) {
        logger.error('[Marketing] Audit logging failed:', auditError.message);
      }
    }

    res.status(500).json({ error: 'Failed to activate campaign' });
  }
});

/** GET /api/vessel/get-all-acquirable - Fetches all vessels available for purchase from the marketplace. */
router.get('/vessel/get-all-acquirable', async (req, res) => {
  try {
    const data = await apiCall('/vessel/get-all-acquirable-vessels', 'POST', {});
    res.json(data);
  } catch (error) {
    logger.error('Error getting acquirable vessels:', error);
    res.status(500).json({ error: 'Failed to retrieve acquirable vessels' });
  }
});

/**
 * POST /api/vessel/get-sell-price - Gets the selling price for a vessel.
 * Returns the selling price and original price for a user-owned vessel.
 */
router.post('/vessel/get-sell-price', express.json(), async (req, res) => {
  const { vessel_id } = req.body;

  if (!vessel_id) {
    return res.status(400).json({ error: 'Missing vessel_id' });
  }

  try {
    const data = await apiCall('/vessel/get-sell-price', 'POST', { vessel_id });
    res.json(data);
  } catch (error) {
    logger.error(`[Get Sell Price] Failed for vessel ${vessel_id}:`, error.message);
    res.status(500).json({ error: 'Failed to get sell price', message: error.message });
  }
});

/**
 * POST /api/vessel/sell-vessels - Sells multiple vessels by their IDs.
 * Accepts an array of vessel IDs and sells each one individually.
 * Broadcasts notifications and bunker updates to all connected clients.
 */
router.post('/vessel/sell-vessels', express.json(), async (req, res) => {
  const { vessel_ids } = req.body;

  if (!vessel_ids || !Array.isArray(vessel_ids) || vessel_ids.length === 0) {
    return res.status(400).json({ error: 'Missing or invalid vessel_ids array' });
  }

  try {
    const userId = getUserId();

    // Fetch vessel details BEFORE selling to get prices
    let vesselDetails = [];
    const vesselPriceMap = new Map();

    try {
      const gameData = await apiCallWithRetry('/game/index', 'POST', {});
      const allVessels = gameData.data?.vessels || [];
      vesselDetails = allVessels.filter(v => vessel_ids.includes(v.id));

      // Build price map from vessel details (BEFORE selling)
      vesselDetails.forEach(v => {
        if (v.sell_price) {
          vesselPriceMap.set(v.id, v.sell_price);
        }
      });

      logger.debug(`[Vessel Sell] Fetched prices for ${vesselPriceMap.size} vessels before selling`);
    } catch (error) {
      logger.warn('[Vessel Sell] Failed to fetch vessel details for audit log:', error.message);
    }

    let soldCount = 0;
    const errors = [];

    // Sell each vessel individually (API only supports single vessel sales)
    for (const vesselId of vessel_ids) {
      try {
        const data = await apiCall('/vessel/sell-vessel', 'POST', { vessel_id: vesselId });
        if (data.success) {
          soldCount++;

          // Use price from BEFORE selling (from /game/index) or fall back to API response
          const sellPrice = vesselPriceMap.get(vesselId) || data.vessel?.sell_price || 0;

          if (sellPrice === 0) {
            logger.error(`[Vessel Sell] Vessel ${vesselId} sold but no price found (neither in /game/index nor in API response)`);
          } else {
            logger.debug(`[Vessel Sell] Vessel ${vesselId} sold for $${sellPrice.toLocaleString()}`);
          }
        }
      } catch (error) {
        logger.error(`[Vessel Sell] Failed to sell vessel ${vesselId}:`, error.message);
        errors.push({ vesselId, error: error.message });
      }
    }

    // Fetch and broadcast updated bunker state (cash increased)
    try {
      const gameData = await apiCallWithRetry('/game/index', 'POST', {});
      if (gameData.data?.user) {
        const user = gameData.data.user;

        // API doesn't return capacity fields - use cached values from autopilot
        const cachedCapacity = autopilot.getCachedCapacity(userId);

        broadcastToUser(userId, 'bunker_update', {
          fuel: user.fuel / 1000,
          co2: (user.co2 || user.co2_certificate) / 1000,
          cash: user.cash,
          maxFuel: cachedCapacity.maxFuel,
          maxCO2: cachedCapacity.maxCO2
        });
      }
    } catch (error) {
      logger.error('[Vessel Sell] Failed to fetch updated bunker state:', error);
    }

    res.json({
      success: true,
      sold: soldCount,
      errors: errors.length > 0 ? errors : undefined
    });

  } catch (error) {
    logger.error('[Vessel Sell] Error:', error);
    const userId = getUserId();
    if (userId) {
      // Escape error message to prevent XSS
      const safeErrorMessage = validator.escape(error.message || 'Unknown error');
      broadcastToUser(userId, 'user_action_notification', {
        type: 'error',
        message: ` &lt;strong>Sale Failed&lt;/strong>&lt;br>&lt;br>${safeErrorMessage}`
      });
    }
    res.status(500).json({ error: 'Failed to sell vessels' });
  }
});

/**
 * POST /api/vessel/purchase-vessel - Purchases a new vessel with specified configuration.
 * Default configuration: 4-blade propeller, optional antifouling, no enhanced deck beams.
 * Validation: vessel_id and name are required fields.
 */
router.post('/vessel/purchase-vessel', express.json(), async (req, res) => {
  const { vessel_id, name, antifouling_model, count, silent } = req.body;

  // Validate required fields
  if (!vessel_id || !name) {
    return res.status(400).json({ error: 'Missing required fields: vessel_id, name' });
  }

  // Validate vessel_id is a positive integer
  if (!Number.isInteger(vessel_id) || vessel_id &lt;= 0) {
    return res.status(400).json({ error: 'Invalid vessel_id. Must be a positive integer' });
  }

  // Validate name is a string with reasonable length
  if (typeof name !== 'string') {
    return res.status(400).json({ error: 'Invalid name. Must be a string' });
  }

  if (name.length &lt; 1 || name.length > 100) {
    return res.status(400).json({ error: 'Invalid name length. Must be between 1 and 100 characters' });
  }

  // Validate antifouling_model if provided
  if (antifouling_model !== undefined &amp;&amp; antifouling_model !== null &amp;&amp; typeof antifouling_model !== 'string') {
    return res.status(400).json({ error: 'Invalid antifouling_model. Must be a string or null' });
  }

  try {
    const userId = getUserId();

    // Fetch vessel price BEFORE purchasing
    let vesselCost = 0;
    try {
      const acquirableData = await apiCall('/vessel/get-all-acquirable-vessels', 'POST', {});
      const vessels = acquirableData.data?.vessels_for_sale || [];
      const vessel = vessels.find(v => v.id === vessel_id);
      if (vessel &amp;&amp; vessel.price) {
        vesselCost = vessel.price;
        logger.debug(`[Vessel Purchase] Fetched price $${vesselCost.toLocaleString()} for vessel ${vessel_id} before purchasing`);
      } else {
        logger.warn(`[Vessel Purchase] Could not find vessel ${vessel_id} in acquirable vessels list (${vessels.length} vessels available)`);
      }
    } catch (priceError) {
      logger.warn('[Vessel Purchase] Failed to fetch vessel price before purchase:', priceError.message);
    }

    const data = await apiCall('/vessel/purchase-vessel', 'POST', {
      vessel_id,
      name,
      adjust_speed: '4_blade_propeller',
      antifouling_model: antifouling_model || null,
      enhanced_deck_beams: 0
    });

    // Broadcast notification to all clients (unless silent=true)
    if (userId &amp;&amp; data.user_vessel &amp;&amp; !silent) {
      const vesselName = data.user_vessel.name || name;
      const purchaseCount = count || 1;
      const safeVesselName = validator.escape(vesselName);

      broadcastToUser(userId, 'user_action_notification', {
        type: 'success',
        message: ` &lt;strong>Purchase Successful!&lt;/strong>&lt;br>&lt;br>Purchased ${purchaseCount}x ${safeVesselName}`
      });
    }

    // Broadcast bunker update (cash decreased from purchase)
    if (userId &amp;&amp; data.user) {
      broadcastToUser(userId, 'bunker_update', {
        cash: data.user.cash
      });
      logger.debug(`[Vessel Purchase] Broadcast cash update: $${data.user.cash.toLocaleString()}`);
    }

    // Broadcast vessel count update (pending vessel added)
    if (userId) {
      try {
        const vesselsResponse = await apiCall('/game/index', 'GET');
        if (vesselsResponse?.vessels) {
          const readyToDepart = vesselsResponse.vessels.filter(v =>
            v.status === 'ready' &amp;&amp; v.maintenance > 0
          ).length;
          const atAnchor = vesselsResponse.vessels.filter(v =>
            v.status === 'anchor'
          ).length;
          const pending = vesselsResponse.vessels.filter(v =>
            v.status === 'pending'
          ).length;

          broadcastToUser(userId, 'vessel_count_update', {
            readyToDepart,
            atAnchor,
            pending
          });
          logger.debug(`[Vessel Purchase] Broadcast vessel count update: pending=${pending}`);
        }
      } catch (error) {
        logger.error('[Vessel Purchase] Failed to broadcast vessel count update:', error.message);
      }
    }

    res.json(data);
  } catch (error) {
    logger.error('Error purchasing vessel:', error);

    const userId = getUserId();
    if (userId &amp;&amp; !silent) {
      // Escape error message to prevent XSS
      const safeErrorMessage = validator.escape(error.message || 'Unknown error');
      broadcastToUser(userId, 'user_action_notification', {
        type: 'error',
        message: ` &lt;strong>Purchase Failed&lt;/strong>&lt;br>&lt;br>${safeErrorMessage}`
      });
    }

    res.status(500).json({ error: 'Failed to purchase vessel' });
  }
});

/**
 * POST /api/vessel/bulk-buy-start - Broadcasts bulk buy start to lock buttons across all clients
 */
router.post('/vessel/bulk-buy-start', express.json(), async (req, res) => {
  const userId = getUserId();
  if (!userId) {
    return res.status(401).json({ error: 'Not authenticated' });
  }

  try {
    broadcastToUser(userId, 'bulk_buy_start', {});
    res.json({ success: true });
  } catch (error) {
    logger.error('Error broadcasting bulk buy start:', error);
    res.status(500).json({ error: 'Failed to broadcast start' });
  }
});

/**
 * POST /api/vessel/broadcast-purchase-summary - Broadcasts a summary notification of vessel purchases to all clients
 */
router.post('/vessel/broadcast-purchase-summary', express.json(), async (req, res) => {
  const { vessels, totalCost } = req.body;

  if (!vessels || !Array.isArray(vessels)) {
    return res.status(400).json({ error: 'Missing required field: vessels (array)' });
  }

  const userId = getUserId();
  if (!userId) {
    return res.status(401).json({ error: 'Not authenticated' });
  }

  try {
    // Group vessels by name for display
    const vesselGroups = vessels.reduce((acc, v) => {
      if (!acc[v.name]) {
        acc[v.name] = { name: v.name, quantity: 0, price: v.price, totalPrice: 0 };
      }
      acc[v.name].quantity++;
      acc[v.name].totalPrice += v.price;
      return acc;
    }, {});
    const groupedVessels = Object.values(vesselGroups);

    // Build vessel list HTML with prices
    let vesselListHtml = '';
    if (groupedVessels.length > 5) {
      // If more than 5 types, show scrollable list
      vesselListHtml = '&lt;div style="max-height: 200px; overflow-y: auto; margin: 10px 0; padding-right: 5px;">&lt;ul style="margin: 0; padding-left: 20px; text-align: left;">';
      groupedVessels.forEach(v => {
        vesselListHtml += `&lt;li>${v.quantity}x ${v.name} - $${v.totalPrice.toLocaleString()}&lt;/li>`;
      });
      vesselListHtml += '&lt;/ul>&lt;/div>';
    } else {
      // If 5 or fewer types, show simple list
      vesselListHtml = '&lt;br>';
      groupedVessels.forEach(v => {
        vesselListHtml += `${v.quantity}x ${v.name} - $${v.totalPrice.toLocaleString()}&lt;br>`;
      });
    }

    const message = ` &lt;strong>Purchased ${vessels.length} vessel${vessels.length > 1 ? 's' : ''}!&lt;/strong>${vesselListHtml}Total Cost: $${totalCost.toLocaleString()}`;

    broadcastToUser(userId, 'user_action_notification', {
      type: 'success',
      message
    });

    // AUDIT LOG: Manual vessel purchase - Log matching the notification message
    // (using audit-logger imported at top of file)
    try {
      await auditLog(
        userId,
        CATEGORIES.VESSEL,
        'Manual Vessel Purchase',
        `Purchased ${vessels.length} vessel${vessels.length > 1 ? 's' : ''}! Total Cost: $${totalCost.toLocaleString()}`,
        {
          vessel_count: vessels.length,
          total_cost: totalCost,
          vessels: groupedVessels.map(v => ({
            name: v.name,
            quantity: v.quantity,
            price_per_vessel: v.price,
            total_price: v.totalPrice
          }))
        },
        'SUCCESS',
        SOURCES.MANUAL
      );
    } catch (auditError) {
      logger.error('[Vessel Purchase] Audit logging failed:', auditError.message);
    }

    // Broadcast bulk buy complete to unlock buttons
    broadcastToUser(userId, 'bulk_buy_complete', {
      count: vessels.length
    });

    // Trigger Harbor Map refresh (vessels purchased)
    const { broadcastHarborMapRefresh } = require('../websocket');
    if (broadcastHarborMapRefresh) {
      broadcastHarborMapRefresh(userId, 'vessels_purchased', {
        count: vessels.length
      });
    }

    res.json({ success: true });
  } catch (error) {
    logger.error('Error broadcasting purchase summary:', error);
    res.status(500).json({ error: 'Failed to broadcast summary' });
  }
});

/**
 * POST /api/vessel/broadcast-sale-summary - Broadcasts a summary notification of vessel sales to all clients
 */
router.post('/vessel/broadcast-sale-summary', express.json(), async (req, res) => {
  const { vessels, totalPrice, totalVessels } = req.body;

  if (!vessels || !Array.isArray(vessels)) {
    return res.status(400).json({ error: 'Missing required field: vessels (array)' });
  }

  const userId = getUserId();
  if (!userId) {
    return res.status(401).json({ error: 'Not authenticated' });
  }

  try {
    // Build vessel list HTML with prices
    let vesselListHtml = '';
    if (vessels.length > 5) {
      // If more than 5, show scrollable list
      vesselListHtml = '&lt;div style="max-height: 200px; overflow-y: auto; margin: 10px 0; padding-right: 5px;">&lt;ul style="margin: 0; padding-left: 20px; text-align: left;">';
      vessels.forEach(v => {
        vesselListHtml += `&lt;li>${v.quantity}x ${v.name} - $${v.totalPrice.toLocaleString()}&lt;/li>`;
      });
      vesselListHtml += '&lt;/ul>&lt;/div>';
    } else {
      // If 5 or fewer, show simple list
      vesselListHtml = '&lt;br>';
      vessels.forEach(v => {
        vesselListHtml += `${v.quantity}x ${v.name} - $${v.totalPrice.toLocaleString()}&lt;br>`;
      });
    }

    const message = ` &lt;strong>Sold ${totalVessels} vessel${totalVessels > 1 ? 's' : ''}!&lt;/strong>${vesselListHtml}Total Revenue: $${totalPrice.toLocaleString()}`;

    broadcastToUser(userId, 'user_action_notification', {
      type: 'success',
      message
    });

    // AUDIT LOG: Manual vessel sale - Log matching the notification message
    // (using audit-logger imported at top of file)
    try {
      await auditLog(
        userId,
        CATEGORIES.VESSEL,
        'Manual Vessel Sale',
        `Sold ${totalVessels} vessel${totalVessels > 1 ? 's' : ''}! Total Revenue: $${totalPrice.toLocaleString()}`,
        {
          vessel_count: totalVessels,
          total_price: totalPrice,
          vessels: vessels.map(v => ({
            name: v.name,
            quantity: v.quantity,
            price_per_vessel: v.price,
            total_price: v.totalPrice
          }))
        },
        'SUCCESS',
        SOURCES.MANUAL
      );
    } catch (auditError) {
      logger.error('[Vessel Sale] Audit logging failed:', auditError.message);
    }

    // Trigger Harbor Map refresh (vessels sold)
    const { broadcastHarborMapRefresh } = require('../websocket');
    if (broadcastHarborMapRefresh) {
      broadcastHarborMapRefresh(userId, 'vessels_sold', {
        count: totalVessels
      });
    }

    res.json({ success: true });
  } catch (error) {
    logger.error('Error broadcasting sale summary:', error);
    res.status(500).json({ error: 'Failed to broadcast summary' });
  }
});

/** POST /api/vessel/get-repair-preview - Gets repair preview with vessel list and costs */
router.post('/vessel/get-repair-preview', express.json(), async (req, res) => {
  const { threshold } = req.body;

  if (threshold === null || threshold === undefined || threshold &lt; 0 || threshold > 100) {
    return res.status(400).json({ error: 'Invalid threshold' });
  }

  try {
    // Get all vessels
    const vesselData = await apiCallWithRetry('/game/index', 'POST', {});
    const allVessels = vesselData.data.user_vessels;
    const user = vesselData.user;

    // Filter vessels needing repair
    const vesselsToRepair = allVessels.filter(v => {
      const wear = parseInt(v.wear);
      return wear >= threshold;
    });

    if (vesselsToRepair.length === 0) {
      return res.json({ vessels: [], totalCost: 0, cash: user.cash });
    }

    // Get repair costs
    const vesselIds = vesselsToRepair.map(v => v.id);
    const costData = await gameapi.getMaintenanceCost(vesselIds);

    // Build vessel details with costs
    const vesselDetails = vesselsToRepair.map(vessel => {
      const costVessel = costData.vessels.find(v => v.id === vessel.id);
      const wearMaintenance = costVessel?.maintenance_data?.find(m => m.type === 'wear');
      const cost = wearMaintenance?.price;
      return {
        id: vessel.id,
        name: vessel.name,
        wear: vessel.wear,
        cost: cost
      };
    });

    // Calculate total cost
    const calculatedTotalCost = vesselDetails.reduce((sum, v) => sum + v.cost, 0);
    const finalTotalCost = costData.totalCost > 0 ? costData.totalCost : calculatedTotalCost;

    res.json({
      vessels: vesselDetails,
      totalCost: finalTotalCost,
      cash: user.cash
    });

  } catch (error) {
    logger.error('Error getting repair preview:', error);
    res.status(500).json({ error: 'Failed to get repair preview' });
  }
});

/** POST /api/vessel/bulk-repair - Repairs all vessels needing maintenance based on threshold */
router.post('/vessel/bulk-repair', express.json(), async (req, res) => {
  const { threshold } = req.body;

  if (!threshold || threshold &lt; 0 || threshold > 100) {
    return res.status(400).json({ error: 'Invalid threshold' });
  }

  try {
    // Get all vessels
    const vesselData = await apiCallWithRetry('/game/index', 'POST', {});
    const allVessels = vesselData.data.user_vessels;

    // Filter vessels needing repair
    const vesselsToRepair = allVessels.filter(v => {
      const wear = parseInt(v.wear);
      return wear >= threshold;
    });

    if (vesselsToRepair.length === 0) {
      const userId = getUserId();
      if (userId) {
        broadcastToUser(userId, 'user_action_notification', {
          type: 'info',
          message: ' No vessels need repair!'
        });
      }
      return res.json({ count: 0, totalCost: 0 });
    }

    // Get repair costs
    const vesselIds = vesselsToRepair.map(v => v.id);
    const costData = await gameapi.getMaintenanceCost(vesselIds);
    const totalCost = costData.totalCost;

    // Build vessel details with costs
    const vesselDetails = vesselsToRepair.map(vessel => {
      const costVessel = costData.vessels.find(v => v.id === vessel.id);
      const wearMaintenance = costVessel?.maintenance_data?.find(m => m.type === 'wear');
      const cost = wearMaintenance?.price;
      logger.debug(`[Bulk Repair] Vessel ${vessel.name} (ID: ${vessel.id}): wear=${vessel.wear}%, cost=$${cost}`);
      return {
        id: vessel.id,
        name: vessel.name,
        wear: vessel.wear,
        cost: cost
      };
    });

    // Recalculate totalCost from vessel details (in case API returned 0)
    const calculatedTotalCost = vesselDetails.reduce((sum, v) => sum + v.cost, 0);
    logger.debug(`[Bulk Repair] Total calculated from vessels: $${calculatedTotalCost.toLocaleString()}, costData.totalCost: $${costData.totalCost.toLocaleString()}`);

    // Check cash (use calculatedTotalCost if totalCost is 0)
    const finalTotalCost = totalCost > 0 ? totalCost : calculatedTotalCost;
    const state = require('../state');
    const userId = getUserId();
    const bunker = state.getBunkerState(userId);

    if (finalTotalCost > bunker.cash) {
      broadcastToUser(userId, 'user_action_notification', {
        type: 'error',
        message: ` &lt;strong>Not enough cash!&lt;/strong>&lt;br>&lt;br>Repair cost: $${totalCost.toLocaleString()}&lt;br>Your cash: $${bunker.cash.toLocaleString()}&lt;br>Missing: $${(totalCost - bunker.cash).toLocaleString()}`
      });
      return res.status(400).json({ error: 'Not enough cash' });
    }

    // Broadcast repair start (lock buttons across all tabs)
    if (userId) {
      broadcastToUser(userId, 'repair_start', {});
    }

    // Execute repairs
    const repairData = await gameapi.bulkRepairVessels(vesselIds);

    // Use repairData.totalCost if available (API sometimes returns it), otherwise use finalTotalCost
    const actualCost = repairData.totalCost > 0 ? repairData.totalCost : finalTotalCost;

    logger.debug(`[Manual Bulk Repair] Repaired ${vesselsToRepair.length} vessels - costData.totalCost: $${totalCost.toLocaleString()}, calculatedTotalCost: $${calculatedTotalCost.toLocaleString()}, repairData.totalCost: $${repairData.totalCost.toLocaleString()}, Using: $${actualCost.toLocaleString()}`);

    // AUDIT LOG: Manual bulk repair
    // (using audit-logger imported at top of file)

    // Validate data - FAIL LOUD if missing
    if (vesselsToRepair.length === 0) {
      throw new Error('No vessels to repair');
    }

    if (actualCost === 0) {
      throw new Error('Repair cost is 0 - API data invalid');
    }

    await auditLog(
      userId,
      CATEGORIES.VESSEL,
      'Manual Bulk Repair',
      `Repaired ${vesselsToRepair.length} vessel(s) for ${formatCurrency(actualCost)}`,
      {
        vessel_count: vesselsToRepair.length,
        total_cost: actualCost,
        threshold: threshold,
        vessels: vesselDetails.map(v => {
          if (!v.cost) {
            throw new Error(`Vessel ${v.id} (${v.name}) missing cost in repair data`);
          }
          return {
            id: v.id,
            name: v.name,
            wear: v.wear,
            cost: v.cost
          };
        })
      },
      'SUCCESS',
      SOURCES.MANUAL
    );

    // Broadcast success to all clients using same format as autopilot
    if (userId) {
      broadcastToUser(userId, 'vessels_repaired', {
        count: vesselsToRepair.length,
        totalCost: actualCost,
        vessels: vesselDetails
      });

      // Update bunker cash
      broadcastToUser(userId, 'bunker_update', {
        fuel: bunker.fuel,
        co2: bunker.co2,
        cash: bunker.cash - actualCost,
        maxFuel: bunker.maxFuel,
        maxCO2: bunker.maxCO2
      });

      // Broadcast repair complete (unlock buttons across all tabs)
      broadcastToUser(userId, 'repair_complete', {
        count: vesselsToRepair.length
      });
    }

    res.json({
      count: vesselsToRepair.length,
      totalCost: actualCost,
      vessels: vesselDetails
    });
  } catch (error) {
    logger.error('Error repairing vessels:', error);

    const userId = getUserId();
    if (userId) {
      // Escape error message to prevent XSS
      const safeErrorMessage = validator.escape(error.message || 'Unknown error');
      broadcastToUser(userId, 'user_action_notification', {
        type: 'error',
        message: ` &lt;strong>Error&lt;/strong>&lt;br>&lt;br>${safeErrorMessage}`
      });
    }

    res.status(500).json({ error: 'Failed to repair vessels' });
  }
});

/** POST /api/vessel/rename-vessel - Rename a vessel */
router.post('/vessel/rename-vessel', express.json(), async (req, res) => {
  try {
    const { vessel_id, name } = req.body;

    // Validate input
    if (!vessel_id) {
      return res.status(400).json({ error: 'Vessel ID is required' });
    }

    if (!name || typeof name !== 'string') {
      return res.status(400).json({ error: 'Vessel name is required' });
    }

    // Validate name length (2-30 characters)
    const trimmedName = name.trim();
    if (trimmedName.length &lt; 2 || trimmedName.length > 30) {
      return res.status(400).json({ error: 'Vessel name must be between 2 and 30 characters' });
    }

    logger.info(`[Vessel Rename] Renaming vessel ${vessel_id} to "${trimmedName}"`);

    // Call game API
    const data = await apiCall('/vessel/rename-vessel', 'POST', {
      vessel_id: vessel_id,
      name: trimmedName
    });

    logger.info(`[Vessel Rename] Success - Vessel ${vessel_id} renamed to "${trimmedName}"`);

    // Broadcast Harbor Map refresh
    const userId = getUserId();
    if (userId) {
      const { broadcastHarborMapRefresh } = require('../websocket');
      if (broadcastHarborMapRefresh) {
        broadcastHarborMapRefresh(userId, 'vessel_renamed', {
          vessel_id: vessel_id,
          new_name: trimmedName
        });
      }
    }

    res.json(data);
  } catch (error) {
    logger.error('[Vessel Rename] Error:', error.message);
    res.status(500).json({ error: 'Failed to rename vessel' });
  }
});

/** POST /api/check-price-alerts - Manually trigger price alert check (called on page load) */
router.post('/check-price-alerts', async (req, res) => {
  try {
    await autopilot.checkPriceAlerts();
    res.json({ success: true });
  } catch (error) {
    logger.error('[API] Failed to check price alerts:', error.message);
    res.status(500).json({ error: 'Failed to check price alerts' });
  }
});

/** POST /api/autopilot/trigger-depart - Event-driven auto-depart trigger (called when vessels arrive in harbor) */
router.post('/autopilot/trigger-depart', async (req, res) => {
  try {
    const userId = getUserId();
    const state = require('../state');

    const settings = state.getSettings(userId);

    // Only execute if auto-depart is enabled
    if (!settings?.autoDepartAll) {
      return res.json({ success: false, message: 'Auto-depart not enabled' });
    }

    logger.debug(`[Auto-Depart] Event-driven trigger received for user ${userId}`);

    // Execute auto-depart with all required parameters
    // (using broadcastToUser imported at top of file)
    await autopilot.autoDepartVessels(
      autopilot.isAutopilotPaused(),
      broadcastToUser,
      autopilot.autoRebuyAll,
      autopilot.tryUpdateAllData
    );

    res.json({ success: true, message: 'Auto-depart triggered' });
  } catch (error) {
    logger.error('[Auto-Depart] Trigger failed:', error);
    res.status(500).json({ error: 'Failed to trigger auto-depart' });
  }
});

/**
 * POST /api/autopilot/toggle - Pause/Resume autopilot
 *
 * Toggles autopilot paused state. When paused, the central autopilot monitor
 * still runs on its schedule, but skips all actions (depart, repair, rebuy, etc.).
 * Header data updates continue to run normally.
 */
router.post('/autopilot/toggle', async (req, res) => {
  try {
    const userId = getUserId();
    // (using broadcastToUser imported at top of file)

    // Toggle paused state in autopilot.js (global state)
    const currentlyPaused = autopilot.isAutopilotPaused();
    const newPausedState = !currentlyPaused;

    if (newPausedState) {
      autopilot.pauseAutopilot();
    } else {
      autopilot.resumeAutopilot();
    }

    const status = newPausedState ? 'paused' : 'resumed';
    logger.info(`[Autopilot] User ${userId} ${status} autopilot`);

    // Broadcast status to this user's connected clients
    broadcastToUser(userId, 'autopilot_status', {
      paused: newPausedState,
      message: `Autopilot ${status}`
    });

    res.json({
      success: true,
      paused: newPausedState,
      message: `Autopilot ${status}`
    });
  } catch (error) {
    logger.error('[Autopilot] Toggle failed:', error);
    res.status(500).json({ error: 'Failed to toggle autopilot' });
  }
});

/**
 * GET /api/autopilot/status - Get current autopilot pause status
 *
 * Returns the current autopilot paused state (global state from autopilot.js).
 * Used on page load to sync button state across all devices.
 */
router.get('/autopilot/status', async (req, res) => {
  try {
    const isPaused = autopilot.isAutopilotPaused();

    res.json({
      success: true,
      paused: isPaused
    });
  } catch (error) {
    logger.error('[Autopilot] Get status failed:', error);
    res.status(500).json({ error: 'Failed to get autopilot status' });
  }
});

/** POST /api/game/index - Proxies /game/index endpoint from game API */
router.post('/game/index', async (req, res) => {
  try {
    const data = await apiCall('/game/index', 'POST', {});
    res.json(data);
  } catch (error) {
    logger.error('Error calling /game/index:', error);
    res.status(500).json({ error: 'Failed to fetch game index data' });
  }
});

module.exports = router;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation Version: 0.0.7 - ShippingManager CoPilot
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
