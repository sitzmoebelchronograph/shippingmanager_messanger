<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>public/js/modules/harbor-map/map-controller.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Dark theme matching app style - carefully scoped to not break layout */
        html, body {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
            overflow-x: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Custom scrollbar styling for all browsers */
        * {
            scrollbar-width: thin !important;
            scrollbar-color: #404040 #1a1a1a !important;
        }

        /* Webkit browsers (Chrome, Safari, Edge) */
        *::-webkit-scrollbar {
            width: 6px !important;
            height: 6px !important;
        }

        *::-webkit-scrollbar-track {
            background: #1a1a1a !important;
        }

        *::-webkit-scrollbar-thumb {
            background-color: #404040 !important;
            border-radius: 3px !important;
        }

        *::-webkit-scrollbar-thumb:hover {
            background-color: #505050 !important;
        }

        /* Navigation sidebar - remove padding and white borders */
        nav {
            background-color: #242424 !important;
            border-right: 1px solid #404040 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow-x: hidden !important;
        }
        nav h2, nav h3 {
            color: #e0e0e0 !important;
            border-bottom: 1px solid #404040 !important;
            padding: 10px 15px !important;
            margin: 0 !important;
            background-color: #242424 !important;
            font-size: 14px !important;
            font-weight: 600 !important;
        }
        nav h3 {
            font-size: 13px !important;
        }
        nav ul {
            padding: 0 !important;
            margin: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li {
            list-style: none !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li a {
            color: #c9d1d9 !important;
            display: block !important;
            padding: 8px 15px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            background-color: #242424 !important;
            margin: 0 !important;
            border: none !important;
            font-size: 14px !important;
        }
        nav ul li a:hover {
            color: #60a5fa !important;
            background-color: rgba(96, 165, 250, 0.1) !important;
        }
        /* Module links (direct children of nav > ul > li) */
        nav > ul > li > a {
            color: #60a5fa !important;
            font-weight: 600 !important;
            padding: 10px 15px !important;
            font-size: 14px !important;
            border-left: 3px solid #60a5fa !important;
            padding-left: 12px !important;
        }
        nav > ul > li > a:hover {
            background-color: rgba(96, 165, 250, 0.15) !important;
        }
        /* Sub-items (methods/functions) indented */
        nav ul.methods {
            padding-left: 15px !important;
        }
        nav ul.methods li a {
            color: #9ca3af !important;
            font-size: 13px !important;
            padding: 6px 15px !important;
            font-weight: 400 !important;
        }
        nav ul.methods li a:hover {
            color: #c9d1d9 !important;
        }
        nav > h2:first-child {
            font-size: 16px !important;
            font-weight: 700 !important;
            padding: 12px 15px !important;
        }

        /* Main content area - dark background */
        #main {
            background-color: #1a1a1a !important;
            padding: 20px !important;
        }

        /* Article and sections - ensure dark background */
        article, section, .container-overview, .description {
            background-color: #1a1a1a !important;
        }

        /* Images - style demo images */
        img {
            max-width: 100% !important;
            height: auto !important;
            border: 1px solid #404040 !important;
            border-radius: 8px !important;
            margin: 20px 0 !important;
        }

        /* Links */
        a {
            color: #60a5fa !important;
            text-decoration: none !important;
        }
        a:hover {
            color: #93c5fd !important;
            text-decoration: underline !important;
        }

        /* Headings */
        h1, h2, h3, h4, h5, h6 {
            color: #e0e0e0 !important;
            border-bottom-color: #404040 !important;
            background-color: transparent !important;
        }
        h4.name {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
        }

        /* Code blocks */
        pre {
            background-color: #0d1117 !important;
            border: 1px solid #404040 !important;
        }
        pre code {
            background-color: transparent !important;
        }
        code {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
        }

        /* Tables */
        table {
            border-color: #404040 !important;
            background-color: #1a1a1a !important;
        }
        table thead tr {
            background-color: #242424 !important;
        }
        table tbody tr {
            background-color: #1a1a1a !important;
        }
        table tbody tr:nth-child(even) {
            background-color: #1f1f1f !important;
        }
        table td, table th {
            border-color: #404040 !important;
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }
        .params .name, .props .name {
            color: #10b981 !important;
            font-family: 'Courier New', monospace !important;
        }

        /* Descriptions and details */
        .description, .details, dt, dd, p, ul, ol, dl {
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }

        /* Types */
        .type-signature {
            color: #a78bfa !important;
        }

        /* Source links */
        .details .details-item-container {
            border-left-color: #404040 !important;
        }

        /* Breadcrumbs */
        .page-title {
            color: #e0e0e0 !important;
        }

        /* Search */
        #nav-search {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
            color: #e0e0e0 !important;
        }

        /* Mobile nav trigger */
        .navicon-button {
            background-color: #2a2a2a !important;
        }

        /* Footer */
        footer {
            background-color: #1a1a1a !important;
            color: #9ca3af !important;
            border-top: 1px solid #404040 !important;
            text-align: center !important;
            padding: 20px !important;
        }

        /* Remove horizontal scrollbar and white borders */
        * {
            box-sizing: border-box !important;
        }
    </style>
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">README</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-build-guide.html">Build Guide</a></li><li><a href="tutorial-installation-guide.html">Installation Guide</a></li></ul><h3>Classes</h3><ul><li><a href="module-server_chatbot-ChatBot.html">ChatBot</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot-ChatBot.html#executeCommand">executeCommand</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#findCustomCommand">findCustomCommand</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#generateForecastText">generateForecastText</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#getDefaultChatBotObject">getDefaultChatBotObject</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#handleForecastCommand">handleForecastCommand</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#handleHelpCommand">handleHelpCommand</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#initialize">initialize</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#isCommandAllowedInChannel">isCommandAllowedInChannel</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#isOnCooldown">isOnCooldown</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#mapChatBotObjectToFlatSettings">mapChatBotObjectToFlatSettings</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#mapSettingsToChatBotObject">mapSettingsToChatBotObject</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#processAllianceMessage">processAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#processPrivateMessage">processPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#resolveCommandName">resolveCommandName</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#scheduleDailyForecast">scheduleDailyForecast</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#sendAllianceMessage">sendAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#sendDailyForecast">sendDailyForecast</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#sendErrorMessage">sendErrorMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#sendPrivateMessage">sendPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#sendResponse">sendResponse</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#setupScheduledTasks">setupScheduledTasks</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#updateCooldown">updateCooldown</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#updateSettings">updateSettings</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#validateCommandArguments">validateCommandArguments</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#validateForecastArguments">validateForecastArguments</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-api.html">api</a><ul class='methods'><li data-type='method'><a href="module-api.html#.activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-api.html#.deleteAllLogs">deleteAllLogs</a></li><li data-type='method'><a href="module-api.html#.deleteChat">deleteChat</a></li><li data-type='method'><a href="module-api.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-api.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-api.html#.departVessels">departVessels</a></li><li data-type='method'><a href="module-api.html#.doWearMaintenanceBulk">doWearMaintenanceBulk</a></li><li data-type='method'><a href="module-api.html#.downloadLogbookExport">downloadLogbookExport</a></li><li data-type='method'><a href="module-api.html#.fetchAcquirableVessels">fetchAcquirableVessels</a></li><li data-type='method'><a href="module-api.html#.fetchAllianceMembers">fetchAllianceMembers</a></li><li data-type='method'><a href="module-api.html#.fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-api.html#.fetchBunkerPrices">fetchBunkerPrices</a></li><li data-type='method'><a href="module-api.html#.fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-api.html#.fetchChat">fetchChat</a></li><li data-type='method'><a href="module-api.html#.fetchContacts">fetchContacts</a></li><li data-type='method'><a href="module-api.html#.fetchLogbookEntries">fetchLogbookEntries</a></li><li data-type='method'><a href="module-api.html#.fetchLogbookFileSize">fetchLogbookFileSize</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerChats">fetchMessengerChats</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerMessages">fetchMessengerMessages</a></li><li data-type='method'><a href="module-api.html#.fetchUserCompany">fetchUserCompany</a></li><li data-type='method'><a href="module-api.html#.fetchUserSettings">fetchUserSettings</a></li><li data-type='method'><a href="module-api.html#.fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-api.html#.getCompanyNameCached">getCompanyNameCached</a></li><li data-type='method'><a href="module-api.html#.getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-api.html#.markChatAsRead">markChatAsRead</a></li><li data-type='method'><a href="module-api.html#.purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-api.html#.purchaseFuel">purchaseFuel</a></li><li data-type='method'><a href="module-api.html#.purchaseVessel">purchaseVessel</a></li><li data-type='method'><a href="module-api.html#.searchUsers">searchUsers</a></li><li data-type='method'><a href="module-api.html#.sendChatMessage">sendChatMessage</a></li><li data-type='method'><a href="module-api.html#.sendPrivateMessage">sendPrivateMessage</a></li></ul></li><li><a href="module-app.html">app</a></li><li><a href="module-automation.html">automation</a><ul class='methods'><li data-type='method'><a href="module-automation.html#.initAutomation">initAutomation</a></li><li data-type='method'><a href="module-automation.html#.runAutomationChecks">runAutomationChecks</a></li><li data-type='method'><a href="module-automation.html#.triggerAutoRebuyChecks">triggerAutoRebuyChecks</a></li><li data-type='method'><a href="module-automation.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-automation.html#~checkAutoCampaignRenewal">checkAutoCampaignRenewal</a></li><li data-type='method'><a href="module-automation.html#~checkAutoDepartAll">checkAutoDepartAll</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyCO2">checkAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyFuel">checkAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~getTotalCapacity">getTotalCapacity</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyCO2">performAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyFuel">performAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~sendAutoPilotFeedback">sendAutoPilotFeedback</a></li><li data-type='method'><a href="module-automation.html#~showCenterAlert">showCenterAlert</a></li><li data-type='method'><a href="module-automation.html#~updateAutoDepartLabel">updateAutoDepartLabel</a></li></ul></li><li><a href="module-bunker-management.html">bunker-management</a><ul class='methods'><li data-type='method'><a href="module-bunker-management.html#.buyMaxCO2">buyMaxCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.buyMaxFuel">buyMaxFuel</a></li><li data-type='method'><a href="module-bunker-management.html#.getCurrentBunkerState">getCurrentBunkerState</a></li><li data-type='method'><a href="module-bunker-management.html#.setCapacityFromBunkerUpdate">setCapacityFromBunkerUpdate</a></li><li data-type='method'><a href="module-bunker-management.html#.updateBunkerStatus">updateBunkerStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCampaignsStatus">updateCampaignsStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCO2">updateCurrentCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCash">updateCurrentCash</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentFuel">updateCurrentFuel</a></li><li data-type='method'><a href="module-bunker-management.html#~retryFetchPrices">retryFetchPrices</a></li></ul></li><li><a href="module-chat.html">chat</a><ul class='methods'><li data-type='method'><a href="module-chat.html#.displayMessages">displayMessages</a></li><li data-type='method'><a href="module-chat.html#.handleMessageInput">handleMessageInput</a></li><li data-type='method'><a href="module-chat.html#.initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-chat.html#.loadAllianceMembers">loadAllianceMembers</a></li><li data-type='method'><a href="module-chat.html#.loadMessages">loadMessages</a></li><li data-type='method'><a href="module-chat.html#.parseMessageWithMentions">parseMessageWithMentions</a></li><li data-type='method'><a href="module-chat.html#.sendMessage">sendMessage</a></li><li data-type='method'><a href="module-chat.html#.setChatScrollListener">setChatScrollListener</a></li><li data-type='method'><a href="module-chat.html#~attemptReconnect">attemptReconnect</a></li><li data-type='method'><a href="module-chat.html#~displaySuggestions">displaySuggestions</a></li><li data-type='method'><a href="module-chat.html#~formatLocalTime">formatLocalTime</a></li><li data-type='method'><a href="module-chat.html#~handleAutoCoopComplete">handleAutoCoopComplete</a></li><li data-type='method'><a href="module-chat.html#~handleAutoCoopNoTargets">handleAutoCoopNoTargets</a></li><li data-type='method'><a href="module-chat.html#~handleAutopilotDepartStart">handleAutopilotDepartStart</a></li><li data-type='method'><a href="module-chat.html#~handleBackendAutoRepairComplete">handleBackendAutoRepairComplete</a></li><li data-type='method'><a href="module-chat.html#~handleBunkerUpdate">handleBunkerUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleCO2Purchased">handleCO2Purchased</a></li><li data-type='method'><a href="module-chat.html#~handleCampaignStatusUpdate">handleCampaignStatusUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleCampaignsRenewed">handleCampaignsRenewed</a></li><li data-type='method'><a href="module-chat.html#~handleCompanyTypeUpdate">handleCompanyTypeUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleCoopUpdate">handleCoopUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleFuelPurchased">handleFuelPurchased</a></li><li data-type='method'><a href="module-chat.html#~handleGenericNotification">handleGenericNotification</a></li><li data-type='method'><a href="module-chat.html#~handleHeaderDataUpdate">handleHeaderDataUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleHijackingUpdate">handleHijackingUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleMentionAutocomplete">handleMentionAutocomplete</a></li><li data-type='method'><a href="module-chat.html#~handleMessengerUpdate">handleMessengerUpdate</a></li><li data-type='method'><a href="module-chat.html#~handlePriceAlert">handlePriceAlert</a></li><li data-type='method'><a href="module-chat.html#~handlePriceUpdate">handlePriceUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleRepairCountUpdate">handleRepairCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleUnreadMessagesUpdate">handleUnreadMessagesUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleUserActionNotification">handleUserActionNotification</a></li><li data-type='method'><a href="module-chat.html#~handleVesselCountUpdate">handleVesselCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDepartComplete">handleVesselsDepartComplete</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDeparted">handleVesselsDeparted</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsFailed">handleVesselsFailed</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsRepaired">handleVesselsRepaired</a></li><li data-type='method'><a href="module-chat.html#~hideMemberSuggestions">hideMemberSuggestions</a></li><li data-type='method'><a href="module-chat.html#~insertMention">insertMention</a></li><li data-type='method'><a href="module-chat.html#~registerUsernameClickEvents">registerUsernameClickEvents</a></li><li data-type='method'><a href="module-chat.html#~updateAllianceChatBadge">updateAllianceChatBadge</a></li></ul></li><li><a href="module-coop.html">coop</a><ul class='methods'><li data-type='method'><a href="module-coop.html#.closeCoopOverlay">closeCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.fetchCoopData">fetchCoopData</a></li><li data-type='method'><a href="module-coop.html#.sendCoopMax">sendCoopMax</a></li><li data-type='method'><a href="module-coop.html#.showCoopOverlay">showCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.updateCoopBadge">updateCoopBadge</a></li><li data-type='method'><a href="module-coop.html#~renderMemberCard">renderMemberCard</a></li></ul></li><li><a href="module-desktop-notification-templates.html">desktop-notification-templates</a><ul class='methods'><li data-type='method'><a href="module-desktop-notification-templates.html#.createDesktopNotification">createDesktopNotification</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.getDefaultEmoji">getDefaultEmoji</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.getNotificationTypes">getNotificationTypes</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.isValidNotificationType">isValidNotificationType</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyAlert">notifyAlert</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyError">notifyError</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifySuccess">notifySuccess</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyWarning">notifyWarning</a></li></ul></li><li><a href="module-event-info.html">event-info</a><ul class='methods'><li data-type='method'><a href="module-event-info.html#.initEventInfo">initEventInfo</a></li><li data-type='method'><a href="module-event-info.html#.openEventModal">openEventModal</a></li><li data-type='method'><a href="module-event-info.html#.updateEventData">updateEventData</a></li><li data-type='method'><a href="module-event-info.html#~startEventTimer">startEventTimer</a></li></ul></li><li><a href="module-forecast-calendar.html">forecast-calendar</a><ul class='methods'><li data-type='method'><a href="module-forecast-calendar.html#.initForecastCalendar">initForecastCalendar</a></li><li data-type='method'><a href="module-forecast-calendar.html#.updateEventDiscount">updateEventDiscount</a></li><li data-type='method'><a href="module-forecast-calendar.html#~createTableHTML">createTableHTML</a></li><li data-type='method'><a href="module-forecast-calendar.html#~formatDate">formatDate</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getBrowserTimezone">getBrowserTimezone</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getCo2Class">getCo2Class</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getCurrentVisibleDay">getCurrentVisibleDay</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getFuelClass">getFuelClass</a></li><li data-type='method'><a href="module-forecast-calendar.html#~isEventActiveAtTime">isEventActiveAtTime</a></li><li data-type='method'><a href="module-forecast-calendar.html#~isEventActiveOnDay">isEventActiveOnDay</a></li><li data-type='method'><a href="module-forecast-calendar.html#~loadForecastData">loadForecastData</a></li><li data-type='method'><a href="module-forecast-calendar.html#~preloadMonth">preloadMonth</a></li><li data-type='method'><a href="module-forecast-calendar.html#~renderBook">renderBook</a></li><li data-type='method'><a href="module-forecast-calendar.html#~updateEventBadge">updateEventBadge</a></li></ul></li><li><a href="module-harbor-map-aggregator.html">harbor-map-aggregator</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-aggregator.html#~aggregateReachablePorts">aggregateReachablePorts</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~aggregateVesselData">aggregateVesselData</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~categorizeVesselsByPort">categorizeVesselsByPort</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~extractPortsFromGameIndex">extractPortsFromGameIndex</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~extractVesselsFromGameIndex">extractVesselsFromGameIndex</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~filterAssignedPorts">filterAssignedPorts</a></li></ul></li><li><a href="module-harbor-map-calculator.html">harbor-map-calculator</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateCargoUtilization">calculateCargoUtilization</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateDemandLevel">calculateDemandLevel</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateETA">calculateETA</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateVesselPosition">calculateVesselPosition</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~formatCargoCapacity">formatCargoCapacity</a></li></ul></li><li><a href="module-harbor-map-init.html">harbor-map-init</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-init.html#.closeHarborMap">closeHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.initHarborMap">initHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.openHarborMap">openHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.preloadHarborMapData">preloadHarborMapData</a></li><li data-type='method'><a href="module-harbor-map-init.html#.refreshHarborMapIfOpen">refreshHarborMapIfOpen</a></li><li data-type='method'><a href="module-harbor-map-init.html#.reloadMap">reloadMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.startHarborMapAutoUpdate">startHarborMapAutoUpdate</a></li><li data-type='method'><a href="module-harbor-map-init.html#.stopHarborMapAutoUpdate">stopHarborMapAutoUpdate</a></li><li data-type='method'><a href="module-harbor-map-init.html#~departVesselWrapper">departVesselWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~getVesselByIdWrapper">getVesselByIdWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~selectVesselFromMap">selectVesselFromMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#~sellVesselFromPanelWrapper">sellVesselFromPanelWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~updateVesselMarkerWrapper">updateVesselMarkerWrapper</a></li></ul></li><li><a href="module-harbor-map_api-client.html">harbor-map/api-client</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_api-client.html#.clearHarborMapCache">clearHarborMapCache</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.exportVesselHistory">exportVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchHarborMapOverview">fetchHarborMapOverview</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchPortDetails">fetchPortDetails</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchVesselHistory">fetchVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchVesselReachablePorts">fetchVesselReachablePorts</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.getCachedOverview">getCachedOverview</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.prefetchHarborMapData">prefetchHarborMapData</a></li></ul></li><li><a href="module-harbor-map_map-controller.html">harbor-map/map-controller</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_map-controller.html#.clearRoute">clearRoute</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.deselectAll">deselectAll</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.drawRoute">drawRoute</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getSelectedPortCode">getSelectedPortCode</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getVesselById">getVesselById</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.initMap">initMap</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.loadOverview">loadOverview</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.renderPorts">renderPorts</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.renderVessels">renderVessels</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.selectPort">selectPort</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.selectVessel">selectVessel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.setPortFilter">setPortFilter</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.updateVesselMarker">updateVesselMarker</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.updateWeatherDataSetting">updateWeatherDataSetting</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~addCustomControls">addCustomControls</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~applyMapTheme">applyMapTheme</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~calculateHeading">calculateHeading</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~changeTileLayer">changeTileLayer</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~createVesselIcon">createVesselIcon</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~getVesselType">getVesselType</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~hideRouteVesselsPanel">hideRouteVesselsPanel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~setRouteFilter">setRouteFilter</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~showRouteVesselsPanel">showRouteVesselsPanel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~showWeatherInfo">showWeatherInfo</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~toggleWeatherLayer">toggleWeatherLayer</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~updateRouteDropdown">updateRouteDropdown</a></li></ul></li><li><a href="module-harbor-map_panel-drag.html">harbor-map/panel-drag</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_panel-drag.html#.initializePanelDrag">initializePanelDrag</a></li></ul></li><li><a href="module-harbor-map_port-panel.html">harbor-map/port-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_port-panel.html#.closePortPanel">closePortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.hidePortPanel">hidePortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.selectVesselFromPort">selectVesselFromPort</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.showPortPanel">showPortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#~renderDemandSection">renderDemandSection</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#~renderVesselList">renderVesselList</a></li></ul></li><li><a href="module-harbor-map_route-vessels-panel.html">harbor-map/route-vessels-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.closeRoutePanel">closeRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.hideRoutePanel">hideRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.selectRouteVessel">selectRouteVessel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.showRoutePanel">showRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#~storeVessels">storeVessels</a></li></ul></li><li><a href="module-harbor-map_vessel-panel.html">harbor-map/vessel-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.closeVesselPanel">closeVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.exportHistoryFormat">exportHistoryFormat</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.hideVesselPanel">hideVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.sellVesselFromPanel">sellVesselFromPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.showVesselPanel">showVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.toggleExportMenu">toggleExportMenu</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~closeExportMenuOnClickOutside">closeExportMenuOnClickOutside</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~loadVesselHistory">loadVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~renderHistoryPage">renderHistoryPage</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~setupInfiniteScroll">setupInfiniteScroll</a></li></ul></li><li><a href="module-logbook.html">logbook</a><ul class='methods'><li data-type='method'><a href="module-logbook.html#.deleteAllLogsConfirmed">deleteAllLogsConfirmed</a></li><li data-type='method'><a href="module-logbook.html#.getLogFileSize">getLogFileSize</a></li><li data-type='method'><a href="module-logbook.html#.initLogbook">initLogbook</a></li><li data-type='method'><a href="module-logbook.html#.prependLogEntry">prependLogEntry</a></li><li data-type='method'><a href="module-logbook.html#~exportLogs">exportLogs</a></li><li data-type='method'><a href="module-logbook.html#~formatDetails">formatDetails</a></li><li data-type='method'><a href="module-logbook.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-logbook.html#~loadLogs">loadLogs</a></li><li data-type='method'><a href="module-logbook.html#~renderDetailsRow">renderDetailsRow</a></li><li data-type='method'><a href="module-logbook.html#~renderLogTable">renderLogTable</a></li><li data-type='method'><a href="module-logbook.html#~searchInObject">searchInObject</a></li><li data-type='method'><a href="module-logbook.html#~toggleExpanded">toggleExpanded</a></li><li data-type='method'><a href="module-logbook.html#~updateAutopilotFilter">updateAutopilotFilter</a></li></ul></li><li><a href="module-messenger.html">messenger</a><ul class='methods'><li data-type='method'><a href="module-messenger.html#.closeAllChats">closeAllChats</a></li><li data-type='method'><a href="module-messenger.html#.closeChatSelection">closeChatSelection</a></li><li data-type='method'><a href="module-messenger.html#.openMessenger">openMessenger</a></li><li data-type='method'><a href="module-messenger.html#.openNewChat">openNewChat</a></li><li data-type='method'><a href="module-messenger.html#.showAllChats">showAllChats</a></li><li data-type='method'><a href="module-messenger.html#.updateUnreadBadge">updateUnreadBadge</a></li><li data-type='method'><a href="module-messenger.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-messenger.html#~loadPrivateMessages">loadPrivateMessages</a></li><li data-type='method'><a href="module-messenger.html#~startHijackingPolling">startHijackingPolling</a></li><li data-type='method'><a href="module-messenger.html#~stopHijackingPolling">stopHijackingPolling</a></li></ul></li><li><a href="module-public_js_modules_hijacking.html">public/js/modules/hijacking</a><ul class='methods'><li data-type='method'><a href="module-public_js_modules_hijacking.html#.closeHijackingInbox">closeHijackingInbox</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.openHijackingInbox">openHijackingInbox</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.updateHijackedVesselsDisplay">updateHijackedVesselsDisplay</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.updateHijackingBadge">updateHijackingBadge</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~deleteCase">deleteCase</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~openCaseDetails">openCaseDetails</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~refreshHijackingBadge">refreshHijackingBadge</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~renderCaseList">renderCaseList</a></li></ul></li><li><a href="module-server_automation.html">server/automation</a><ul class='methods'><li data-type='method'><a href="module-server_automation.html#~getRandomInterval">getRandomInterval</a></li><li data-type='method'><a href="module-server_automation.html#~initialize">initialize</a></li><li data-type='method'><a href="module-server_automation.html#~loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_automation.html#~parseInterval">parseInterval</a></li><li data-type='method'><a href="module-server_automation.html#~restartAutoRepair">restartAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~runAutoRepair">runAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~scheduleAutoRepair">scheduleAutoRepair</a></li></ul></li><li><a href="module-server_autopilot.html">server/autopilot</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot.html#~analyzeVesselDepartures">analyzeVesselDepartures</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoRebuyAll">autoRebuyAll</a></li><li data-type='method'><a href="module-server_autopilot.html#~checkPriceAlerts">checkPriceAlerts</a></li><li data-type='method'><a href="module-server_autopilot.html#~countActiveCampaignTypes">countActiveCampaignTypes</a></li><li data-type='method'><a href="module-server_autopilot.html#~initializeAutopilotState">initializeAutopilotState</a></li><li data-type='method'><a href="module-server_autopilot.html#~isAutopilotPaused">isAutopilotPaused</a></li><li data-type='method'><a href="module-server_autopilot.html#~mainEventLoop">mainEventLoop</a></li><li data-type='method'><a href="module-server_autopilot.html#~pauseAutopilot">pauseAutopilot</a></li><li data-type='method'><a href="module-server_autopilot.html#~resumeAutopilot">resumeAutopilot</a></li><li data-type='method'><a href="module-server_autopilot.html#~setBroadcastFunction">setBroadcastFunction</a></li><li data-type='method'><a href="module-server_autopilot.html#~startMainEventLoop">startMainEventLoop</a></li><li data-type='method'><a href="module-server_autopilot.html#~tryUpdateAllData">tryUpdateAllData</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateAllData">updateAllData</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateCampaigns">updateCampaigns</a></li><li data-type='method'><a href="module-server_autopilot.html#~updatePrices">updatePrices</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateRepairCount">updateRepairCount</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateUnreadMessages">updateUnreadMessages</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateVesselCount">updateVesselCount</a></li></ul></li><li><a href="module-server_autopilot_pilot_atmosphere_broker.html">server/autopilot/pilot_atmosphere_broker</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_atmosphere_broker.html#~autoRebuyCO2">autoRebuyCO2</a></li></ul></li><li><a href="module-server_autopilot_pilot_barrel_boss.html">server/autopilot/pilot_barrel_boss</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_barrel_boss.html#~autoRebuyFuel">autoRebuyFuel</a></li></ul></li><li><a href="module-server_autopilot_pilot_captain_blackbeard.html">server/autopilot/pilot_captain_blackbeard</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~acceptRansomWithRetry">acceptRansomWithRetry</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~autoNegotiateHijacking">autoNegotiateHijacking</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~getCaseWithRetry">getCaseWithRetry</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~processHijackingCase">processHijackingCase</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~submitOfferWithRetry">submitOfferWithRetry</a></li></ul></li><li><a href="module-server_autopilot_pilot_cargo_marshal.html">server/autopilot/pilot_cargo_marshal</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~autoDepartVessels">autoDepartVessels</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~departVessels">departVessels</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~getTotalCapacity">getTotalCapacity</a></li></ul></li><li><a href="module-server_autopilot_pilot_fair_hand.html">server/autopilot/pilot_fair_hand</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_fair_hand.html#~autoCoop">autoCoop</a></li></ul></li><li><a href="module-server_autopilot_pilot_harbormaster.html">server/autopilot/pilot_harbormaster</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_harbormaster.html#~autoAnchorPointPurchase">autoAnchorPointPurchase</a></li></ul></li><li><a href="module-server_autopilot_pilot_reputation_chief.html">server/autopilot/pilot_reputation_chief</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_reputation_chief.html#~autoCampaignRenewal">autoCampaignRenewal</a></li></ul></li><li><a href="module-server_autopilot_pilot_yard_foreman.html">server/autopilot/pilot_yard_foreman</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_yard_foreman.html#~autoRepairVessels">autoRepairVessels</a></li></ul></li><li><a href="module-server_cache.html">server/cache</a><ul class='methods'><li data-type='method'><a href="module-server_cache.html#~clearAllCaches">clearAllCaches</a></li><li data-type='method'><a href="module-server_cache.html#~getAllianceCache">getAllianceCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCampaignCache">getCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCompanyCache">getCompanyCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCoopCache">getCoopCache</a></li><li data-type='method'><a href="module-server_cache.html#~invalidateCampaignCache">invalidateCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~invalidateCoopCache">invalidateCoopCache</a></li><li data-type='method'><a href="module-server_cache.html#~isCacheValid">isCacheValid</a></li><li data-type='method'><a href="module-server_cache.html#~setAllianceCache">setAllianceCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCampaignCache">setCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCompanyCache">setCompanyCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCoopCache">setCoopCache</a></li></ul></li><li><a href="module-server_certificate.html">server/certificate</a><ul class='methods'><li data-type='method'><a href="module-server_certificate.html#~createHttpsServer">createHttpsServer</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCA">generateCA</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCertificate">generateCertificate</a></li><li data-type='method'><a href="module-server_certificate.html#~getNetworkIPs">getNetworkIPs</a></li><li data-type='method'><a href="module-server_certificate.html#~isCertificateInstalled">isCertificateInstalled</a></li><li data-type='method'><a href="module-server_certificate.html#~loadCertificate">loadCertificate</a></li></ul></li><li><a href="module-server_chatbot.html">server/chatbot</a></li><li><a href="module-server_config.html">server/config</a><ul class='methods'><li data-type='method'><a href="module-server_config.html#~getAppDataDir">getAppDataDir</a></li><li data-type='method'><a href="module-server_config.html#~getLocalAppDataDir">getLocalAppDataDir</a></li><li data-type='method'><a href="module-server_config.html#~getLogDir">getLogDir</a></li><li data-type='method'><a href="module-server_config.html#~getSessionCookie">getSessionCookie</a></li><li data-type='method'><a href="module-server_config.html#~getSettingsDir">getSettingsDir</a></li><li data-type='method'><a href="module-server_config.html#~loadStartupSettings">loadStartupSettings</a></li><li data-type='method'><a href="module-server_config.html#~setSessionCookie">setSessionCookie</a></li></ul></li><li><a href="module-server_gameapi.html">server/gameapi</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi.html#~activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-server_gameapi.html#~bulkRepairVessels">bulkRepairVessels</a></li><li data-type='method'><a href="module-server_gameapi.html#~departVessel">departVessel</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchAutoPrice">fetchAutoPrice</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchBunkerState">fetchBunkerState</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchEventData">fetchEventData</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchPrices">fetchPrices</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchRepairCount">fetchRepairCount</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchUnreadMessages">fetchUnreadMessages</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-server_gameapi.html#~getAllUserVessels">getAllUserVessels</a></li><li data-type='method'><a href="module-server_gameapi.html#~getAssignedPorts">getAssignedPorts</a></li><li data-type='method'><a href="module-server_gameapi.html#~getGameIndex">getGameIndex</a></li><li data-type='method'><a href="module-server_gameapi.html#~getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-server_gameapi.html#~getVesselHistory">getVesselHistory</a></li><li data-type='method'><a href="module-server_gameapi.html#~getVesselPorts">getVesselPorts</a></li><li data-type='method'><a href="module-server_gameapi.html#~purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-server_gameapi.html#~purchaseFuel">purchaseFuel</a></li></ul></li><li><a href="module-server_middleware_index.html">server/middleware/index</a><ul class='methods'><li data-type='method'><a href="module-server_middleware_index.html#~setupMiddleware">setupMiddleware</a></li></ul></li><li><a href="module-server_routes_alliance.html">server/routes/alliance</a><ul class='methods'><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-members">GET /api/alliance-members</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/chat">GET /api/chat</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/company-name">POST /api/company-name</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/send-message">POST /api/send-message</a></li></ul></li><li><a href="module-server_routes_anchor.html">server/routes/anchor</a></li><li><a href="module-server_routes_coop.html">server/routes/coop</a><ul class='methods'><li data-type='method'><a href="module-server_routes_coop.html#.GET/api/coop/data">GET /api/coop/data</a></li><li data-type='method'><a href="module-server_routes_coop.html#.POST/api/coop/send-max">POST /api/coop/send-max</a></li></ul></li><li><a href="module-server_routes_forecast.html">server/routes/forecast</a><ul class='methods'><li data-type='method'><a href="module-server_routes_forecast.html#~convertCESTToTimezone">convertCESTToTimezone</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~generateChatbotText">generateChatbotText</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~generateMetadata">generateMetadata</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getForecastDataPath">getForecastDataPath</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getNextDayData">getNextDayData</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getPreviousDayData">getPreviousDayData</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getServerLocalTimezone">getServerLocalTimezone</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getTimezoneOffsetHours">getTimezoneOffsetHours</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getValidTimezones">getValidTimezones</a></li></ul></li><li><a href="module-server_routes_game.html">server/routes/game</a></li><li><a href="module-server_routes_harbor-map.html">server/routes/harbor-map</a><ul class='methods'><li data-type='method'><a href="module-server_routes_harbor-map.html#~formatHistoryAsCSV">formatHistoryAsCSV</a></li><li data-type='method'><a href="module-server_routes_harbor-map.html#~formatHistoryAsTXT">formatHistoryAsTXT</a></li><li data-type='method'><a href="module-server_routes_harbor-map.html#~getGameIndexCached">getGameIndexCached</a></li></ul></li><li><a href="module-server_routes_health.html">server/routes/health</a></li><li><a href="module-server_routes_messenger.html">server/routes/messenger</a><ul class='methods'><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/contact/get-contacts">GET /api/contact/get-contacts</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/hijacking/get-cases">GET /api/hijacking/get-cases</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/messenger/get-chats">GET /api/messenger/get-chats</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/delete-chat">POST /api/messenger/delete-chat</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/get-messages">POST /api/messenger/get-messages</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/send-private">POST /api/messenger/send-private</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/user/search">POST /api/user/search</a></li><li data-type='method'><a href="module-server_routes_messenger.html#~migrateHijackHistory">migrateHijackHistory</a></li></ul></li><li><a href="module-server_routes_settings.html">server/routes/settings</a><ul class='methods'><li data-type='method'><a href="module-server_routes_settings.html#.GET/api/settings">GET /api/settings</a></li><li data-type='method'><a href="module-server_routes_settings.html#.POST/api/settings">POST /api/settings</a></li></ul></li><li><a href="module-server_scheduler.html">server/scheduler</a><ul class='methods'><li data-type='method'><a href="module-server_scheduler.html#~initScheduler">initScheduler</a></li><li data-type='method'><a href="module-server_scheduler.html#~isServerReady">isServerReady</a></li></ul></li><li><a href="module-server_settings-schema.html">server/settings-schema</a><ul class='methods'><li data-type='method'><a href="module-server_settings-schema.html#~getDefault">getDefault</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getDefaults">getDefaults</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getRequiredKeys">getRequiredKeys</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getSettingsFilePath">getSettingsFilePath</a></li><li data-type='method'><a href="module-server_settings-schema.html#~initializeSettings">initializeSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~saveSettings">saveSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~validateSettings">validateSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~validateValue">validateValue</a></li></ul></li><li><a href="module-server_state.html">server/state</a><ul class='methods'><li data-type='method'><a href="module-server_state.html#~getAutopilotState">getAutopilotState</a></li><li data-type='method'><a href="module-server_state.html#~getBunkerState">getBunkerState</a></li><li data-type='method'><a href="module-server_state.html#~getCampaignStatus">getCampaignStatus</a></li><li data-type='method'><a href="module-server_state.html#~getCoopData">getCoopData</a></li><li data-type='method'><a href="module-server_state.html#~getEventData">getEventData</a></li><li data-type='method'><a href="module-server_state.html#~getHeaderData">getHeaderData</a></li><li data-type='method'><a href="module-server_state.html#~getLastCO2Alert">getLastCO2Alert</a></li><li data-type='method'><a href="module-server_state.html#~getLastFuelAlert">getLastFuelAlert</a></li><li data-type='method'><a href="module-server_state.html#~getPrices">getPrices</a></li><li data-type='method'><a href="module-server_state.html#~getRepairCount">getRepairCount</a></li><li data-type='method'><a href="module-server_state.html#~getSettings">getSettings</a></li><li data-type='method'><a href="module-server_state.html#~getUserState">getUserState</a></li><li data-type='method'><a href="module-server_state.html#~getVesselCounts">getVesselCounts</a></li><li data-type='method'><a href="module-server_state.html#~isAutopilotPaused">isAutopilotPaused</a></li><li data-type='method'><a href="module-server_state.html#~setAutopilotPaused">setAutopilotPaused</a></li><li data-type='method'><a href="module-server_state.html#~setAutopilotState">setAutopilotState</a></li><li data-type='method'><a href="module-server_state.html#~setLastCO2Alert">setLastCO2Alert</a></li><li data-type='method'><a href="module-server_state.html#~setLastFuelAlert">setLastFuelAlert</a></li><li data-type='method'><a href="module-server_state.html#~updateBunkerState">updateBunkerState</a></li><li data-type='method'><a href="module-server_state.html#~updateCampaignStatus">updateCampaignStatus</a></li><li data-type='method'><a href="module-server_state.html#~updateCoopData">updateCoopData</a></li><li data-type='method'><a href="module-server_state.html#~updateEventData">updateEventData</a></li><li data-type='method'><a href="module-server_state.html#~updateHeaderData">updateHeaderData</a></li><li data-type='method'><a href="module-server_state.html#~updatePrices">updatePrices</a></li><li data-type='method'><a href="module-server_state.html#~updateRepairCount">updateRepairCount</a></li><li data-type='method'><a href="module-server_state.html#~updateSettings">updateSettings</a></li><li data-type='method'><a href="module-server_state.html#~updateVesselCounts">updateVesselCounts</a></li></ul></li><li><a href="module-server_utils_api.html">server/utils/api</a><ul class='methods'><li data-type='method'><a href="module-server_utils_api.html#~apiCall">apiCall</a></li><li data-type='method'><a href="module-server_utils_api.html#~apiCallWithRetry">apiCallWithRetry</a></li><li data-type='method'><a href="module-server_utils_api.html#~getAllianceId">getAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~getChatFeed">getChatFeed</a></li><li data-type='method'><a href="module-server_utils_api.html#~getCompanyName">getCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserCompanyName">getUserCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserId">getUserId</a></li><li data-type='method'><a href="module-server_utils_api.html#~initializeAlliance">initializeAlliance</a></li><li data-type='method'><a href="module-server_utils_api.html#~sleep">sleep</a></li></ul></li><li><a href="module-server_utils_encryption.html">server/utils/encryption</a><ul class='methods'><li data-type='method'><a href="module-server_utils_encryption.html#~decryptData">decryptData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~deleteEncryptedData">deleteEncryptedData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~encryptData">encryptData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~getEncryptionInfo">getEncryptionInfo</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~getMachineKey">getMachineKey</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~isEncrypted">isEncrypted</a></li></ul></li><li><a href="module-server_utils_logger.html">server/utils/logger</a><ul class='methods'><li data-type='method'><a href="module-server_utils_logger.html#~debug">debug</a></li><li data-type='method'><a href="module-server_utils_logger.html#~error">error</a></li><li data-type='method'><a href="module-server_utils_logger.html#~isDebugMode">isDebugMode</a></li><li data-type='method'><a href="module-server_utils_logger.html#~loadLogLevel">loadLogLevel</a></li><li data-type='method'><a href="module-server_utils_logger.html#~log">log</a></li><li data-type='method'><a href="module-server_utils_logger.html#~warn">warn</a></li></ul></li><li><a href="module-server_utils_session-manager.html">server/utils/session-manager</a><ul class='methods'><li data-type='method'><a href="module-server_utils_session-manager.html#~deleteSession">deleteSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getAllUserIds">getAllUserIds</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getAvailableSessions">getAvailableSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getSession">getSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getSessionsPath">getSessionsPath</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~hasSession">hasSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~loadAllSessions">loadAllSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~loadSessions">loadSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~migrateToEncrypted">migrateToEncrypted</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~saveSession">saveSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~saveSessions">saveSessions</a></li></ul></li><li><a href="module-server_websocket.html">server/websocket</a><ul class='methods'><li data-type='method'><a href="module-server_websocket.html#~broadcast">broadcast</a></li><li data-type='method'><a href="module-server_websocket.html#~broadcastBunkerUpdate">broadcastBunkerUpdate</a></li><li data-type='method'><a href="module-server_websocket.html#~broadcastToUser">broadcastToUser</a></li><li data-type='method'><a href="module-server_websocket.html#~getCachedHijackingCase">getCachedHijackingCase</a></li><li data-type='method'><a href="module-server_websocket.html#~getCachedMessengerChats">getCachedMessengerChats</a></li><li data-type='method'><a href="module-server_websocket.html#~getProcessedMessageIds">getProcessedMessageIds</a></li><li data-type='method'><a href="module-server_websocket.html#~getProcessedMessagesCachePath">getProcessedMessagesCachePath</a></li><li data-type='method'><a href="module-server_websocket.html#~initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-server_websocket.html#~loadProcessedMessageCache">loadProcessedMessageCache</a></li><li data-type='method'><a href="module-server_websocket.html#~performChatRefresh">performChatRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~performHijackingRefresh">performHijackingRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~performMessengerRefresh">performMessengerRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~saveProcessedMessageCache">saveProcessedMessageCache</a></li><li data-type='method'><a href="module-server_websocket.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~startHijackingAutoRefresh">startHijackingAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~startMessengerAutoRefresh">startMessengerAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopChatAutoRefresh">stopChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopHijackingAutoRefresh">stopHijackingAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopMessengerAutoRefresh">stopMessengerAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~triggerImmediateChatRefresh">triggerImmediateChatRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~triggerImmediateHijackingRefresh">triggerImmediateHijackingRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~triggerImmediateMessengerRefresh">triggerImmediateMessengerRefresh</a></li></ul></li><li><a href="module-ui-dialogs.html">ui-dialogs</a><ul class='methods'><li data-type='method'><a href="module-ui-dialogs.html#.buyCampaign">buyCampaign</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeCampaignsOverlay">closeCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeSettings">closeSettings</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showCampaignsOverlay">showCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showConfirmDialog">showConfirmDialog</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showContactList">showContactList</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showSettings">showSettings</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#.escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-utils.html#.formatNumber">formatNumber</a></li><li data-type='method'><a href="module-utils.html#.registerServiceWorker">registerServiceWorker</a></li><li data-type='method'><a href="module-utils.html#.renderStars">renderStars</a></li><li data-type='method'><a href="module-utils.html#.requestNotificationPermission">requestNotificationPermission</a></li><li data-type='method'><a href="module-utils.html#.showNotification">showNotification</a></li><li data-type='method'><a href="module-utils.html#.showSideNotification">showSideNotification</a></li></ul></li><li><a href="module-vessel-management.html">vessel-management</a><ul class='methods'><li data-type='method'><a href="module-vessel-management.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.purchaseSingleVessel">purchaseSingleVessel</a></li><li data-type='method'><a href="module-vessel-management.html#.updateVesselCount">updateVesselCount</a></li><li data-type='method'><a href="module-vessel-management.html#~createVesselCard">createVesselCard</a></li><li data-type='method'><a href="module-vessel-management.html#~displayFilteredVessels">displayFilteredVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~getAvailableAnchorSlots">getAvailableAnchorSlots</a></li><li data-type='method'><a href="module-vessel-management.html#~getCO2EfficiencyClass">getCO2EfficiencyClass</a></li><li data-type='method'><a href="module-vessel-management.html#~getCapacityDisplay">getCapacityDisplay</a></li><li data-type='method'><a href="module-vessel-management.html#~getFuelEfficiencyClass">getFuelEfficiencyClass</a></li><li data-type='method'><a href="module-vessel-management.html#~loadCartFromStorage">loadCartFromStorage</a></li><li data-type='method'><a href="module-vessel-management.html#~loadMorePendingVessels">loadMorePendingVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~loadMoreVessels">loadMoreVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~populateDynamicFilters">populateDynamicFilters</a></li><li data-type='method'><a href="module-vessel-management.html#~preloadCommonVesselImages">preloadCommonVesselImages</a></li><li data-type='method'><a href="module-vessel-management.html#~preloadVesselImage">preloadVesselImage</a></li><li data-type='method'><a href="module-vessel-management.html#~refreshVesselCardsIfVisible">refreshVesselCardsIfVisible</a></li><li data-type='method'><a href="module-vessel-management.html#~saveCartToStorage">saveCartToStorage</a></li><li data-type='method'><a href="module-vessel-management.html#~showBulkRepairDialog">showBulkRepairDialog</a></li><li data-type='method'><a href="module-vessel-management.html#~updateCapacityDropdowns">updateCapacityDropdowns</a></li><li data-type='method'><a href="module-vessel-management.html#~vesselPassesFilters">vesselPassesFilters</a></li></ul></li><li><a href="module-vessel-selling.html">vessel-selling</a><ul class='methods'><li data-type='method'><a href="module-vessel-selling.html#.bulkSellVessels">bulkSellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#.closeSellVesselsOverlay">closeSellVesselsOverlay</a></li><li data-type='method'><a href="module-vessel-selling.html#.openSellVesselsOverlay">openSellVesselsOverlay</a></li><li data-type='method'><a href="module-vessel-selling.html#.refreshVesselsForSale">refreshVesselsForSale</a></li><li data-type='method'><a href="module-vessel-selling.html#.setSellFilter">setSellFilter</a></li><li data-type='method'><a href="module-vessel-selling.html#.showSellCart">showSellCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~addVesselsToCart">addVesselsToCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~displaySellVessels">displaySellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#~getCO2EfficiencyClass">getCO2EfficiencyClass</a></li><li data-type='method'><a href="module-vessel-selling.html#~getCapacityDisplay">getCapacityDisplay</a></li><li data-type='method'><a href="module-vessel-selling.html#~getFuelEfficiencyClass">getFuelEfficiencyClass</a></li><li data-type='method'><a href="module-vessel-selling.html#~groupVesselsByModel">groupVesselsByModel</a></li><li data-type='method'><a href="module-vessel-selling.html#~loadUserVesselsForSale">loadUserVesselsForSale</a></li><li data-type='method'><a href="module-vessel-selling.html#~removeVesselSelectionFromCart">removeVesselSelectionFromCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~sellVessels">sellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#~toggleVesselSelection">toggleVesselSelection</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateBulkSellButton">updateBulkSellButton</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateSelectButtonState">updateSelectButtonState</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateVesselSelectionInCart">updateVesselSelectionInCart</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#buildNav">buildNav</a></li><li><a href="global.html#deleteAllLogs">deleteAllLogs</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#flushAllToDisk">flushAllToDisk</a></li><li><a href="global.html#formatDetailsAsTXT">formatDetailsAsTXT</a></li><li><a href="global.html#formatFileSize">formatFileSize</a></li><li><a href="global.html#formatLogsAsCSV">formatLogsAsCSV</a></li><li><a href="global.html#formatLogsAsTXT">formatLogsAsTXT</a></li><li><a href="global.html#fs">fs</a></li><li><a href="global.html#getLogEntries">getLogEntries</a></li><li><a href="global.html#getLogFilePath">getLogFilePath</a></li><li><a href="global.html#getLogFileSize">getLogFileSize</a></li><li><a href="global.html#getLogsFromCache">getLogsFromCache</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#loadLogsFromDisk">loadLogsFromDisk</a></li><li><a href="global.html#lockBulkBuyButton">lockBulkBuyButton</a></li><li><a href="global.html#lockCo2Button">lockCo2Button</a></li><li><a href="global.html#lockCoopButtons">lockCoopButtons</a></li><li><a href="global.html#lockDepartButton">lockDepartButton</a></li><li><a href="global.html#lockFuelButton">lockFuelButton</a></li><li><a href="global.html#lockRepairButton">lockRepairButton</a></li><li><a href="global.html#logAutopilotAction">logAutopilotAction</a></li><li><a href="global.html#publish">publish</a></li><li><a href="global.html#searchInObject">searchInObject</a></li><li><a href="global.html#showAnchorTimer">showAnchorTimer</a></li><li><a href="global.html#shutdown">shutdown</a></li><li><a href="global.html#unlockBulkBuyButton">unlockBulkBuyButton</a></li><li><a href="global.html#unlockCo2Button">unlockCo2Button</a></li><li><a href="global.html#unlockCoopButtons">unlockCoopButtons</a></li><li><a href="global.html#unlockDepartButton">unlockDepartButton</a></li><li><a href="global.html#unlockFuelButton">unlockFuelButton</a></li><li><a href="global.html#unlockRepairButton">unlockRepairButton</a></li><li><a href="global.html#writeLogsToDisk">writeLogsToDisk</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">public/js/modules/harbor-map/map-controller.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Harbor Map Controller
 * Handles Leaflet.js map initialization, rendering, and user interactions
 * ONLY renders data - NO data processing (all logic in backend)
 *
 * @module harbor-map/map-controller
 */

import { fetchHarborMapOverview, fetchVesselReachablePorts, fetchPortDetails, getCachedOverview } from './api-client.js';
import { showVesselPanel, hideVesselPanel } from './vessel-panel.js';
import { showPortPanel, hidePortPanel } from './port-panel.js';
import { initializePanelDrag } from './panel-drag.js';

// Map instance
let map = null;

// Layer groups
let vesselLayer = null;
let portLayer = null;
let routeLayer = null;
let weatherLayer = null;

// Marker cluster groups
let vesselClusterGroup = null;
let portClusterGroup = null;

// Current state
let currentFilter = localStorage.getItem('harborMapFilter') || 'my_ports'; // 'my_ports' or 'all_ports'
let selectedVesselId = null;
let selectedPortCode = null;
let currentMapStyle = localStorage.getItem('harborMapStyle') || 'dark'; // 'standard', 'dark', or 'satellite'
let weatherEnabled = localStorage.getItem('harborMapWeather') === 'true' || false;

// Weather control reference
let weatherControl = null;

// Current data (for route filtering)
let currentVessels = [];
let currentPorts = [];
let currentRouteFilter = null; // null = show all, string = show specific route

// Tile layers
let currentTileLayer = null;
const tileLayers = {
  standard: {
    name: 'Standard',
    url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    attribution: ' OpenStreetMap contributors'
  },
  dark: {
    name: 'Dark Mode',
    url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
    attribution: ' OpenStreetMap contributors  CARTO'
  },
  satellite: {
    name: 'Satellite',
    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    attribution: 'Tiles  Esri'
  }
};

/**
 * Gets vessel type from capacity_type field
 *
 * @param {string} capacityType - Capacity type ('container' or 'tanker')
 * @returns {string} - 'container', 'tanker', or 'unknown'
 */
function getVesselType(capacityType) {
  if (!capacityType) return 'unknown';
  const lower = capacityType.toLowerCase();
  if (lower === 'container') return 'container';
  if (lower === 'tanker') return 'tanker';
  return 'unknown';
}

/**
 * Creates vessel icon with type and status classes
 *
 * @param {string} status - Vessel status ('enroute', 'port', 'anchor')
 * @param {string} vesselType - Vessel type ('container', 'tanker', 'unknown')
 * @param {number} heading - Vessel heading in degrees (0-360), optional
 * @returns {L.DivIcon} Leaflet icon
 */
function createVesselIcon(status, vesselType, heading = 0) {
  const statusClass = status === 'enroute' ? 'sailing' : status;
  const typeClass = vesselType !== 'unknown' ? vesselType : '';
  const className = `vessel-marker ${statusClass} ${typeClass}`.trim();

  // Apply rotation to triangle
  const rotation = heading ? `transform: rotate(${heading}deg);` : '';

  return L.divIcon({
    className,
    html: `&lt;div class="vessel-icon" style="${rotation}">&lt;/div>`,
    iconSize: [12, 16],
    iconAnchor: [6, 8]
  });
}

/**
 * Calculates heading from two coordinates
 *
 * @param {Object} from - {lat, lon}
 * @param {Object} to - {lat, lon}
 * @returns {number} Heading in degrees
 */
function calculateHeading(from, to) {
  const lat1 = from.lat * Math.PI / 180;
  const lat2 = to.lat * Math.PI / 180;
  const dLon = (to.lon - from.lon) * Math.PI / 180;

  const y = Math.sin(dLon) * Math.cos(lat2);
  const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);

  let heading = Math.atan2(y, x) * 180 / Math.PI;
  heading = (heading + 360) % 360; // Normalize to 0-360

  return heading;
}

const portIcons = {
  default: L.divIcon({ className: 'port-marker', html: '&lt;div class="port-icon">&lt;/div>', iconSize: [14, 14], iconAnchor: [7, 7] }),
  origin: L.divIcon({ className: 'port-marker origin', html: '&lt;div class="port-icon">&lt;/div>', iconSize: [12, 12], iconAnchor: [6, 6] }),
  destination: L.divIcon({ className: 'port-marker destination', html: '&lt;div class="port-icon">&lt;/div>', iconSize: [12, 12], iconAnchor: [6, 6] })
};

/**
 * Initializes Leaflet map with OpenStreetMap tiles
 * Sets up layer groups and marker clusters
 *
 * @param {string} containerId - HTML element ID for map container
 * @returns {void}
 * @example
 * initMap('harbor-map-container');
 */
export function initMap(containerId) {
  // Initialize map centered on northern hemisphere
  map = L.map(containerId, {
    center: [20, 0], // Center on northern hemisphere (20 North, 0 longitude)
    zoom: 1.50,
    minZoom: 1.50, // Minimum zoom = initial zoom (can't zoom out further than world view)
    maxZoom: 18,
    attributionControl: false, // Disable attribution control
    worldCopyJump: true, // Enable world wrapping (jump to copy when panning)
    maxBounds: [[-90, -180], [90, 180]], // Restrict to valid lat/lon
    maxBoundsViscosity: 1.0 // Make bounds hard (can't drag outside)
  });

  // Add saved tile layer (or default to dark)
  currentTileLayer = L.tileLayer(tileLayers[currentMapStyle].url, {
    maxZoom: 19
  }).addTo(map);

  console.log(`[Harbor Map] Initialized with saved style: ${currentMapStyle}`);

  // Set map container background color based on theme
  const mapContainer = map.getContainer();
  const backgroundColor = currentMapStyle === 'standard' ? '#e0e0e0' : '#1f1f1f';
  mapContainer.style.backgroundColor = backgroundColor;

  // Initialize layer groups
  vesselLayer = L.layerGroup().addTo(map);
  portLayer = L.layerGroup().addTo(map);
  routeLayer = L.layerGroup().addTo(map);

  // Initialize marker cluster groups with custom icons
  vesselClusterGroup = L.markerClusterGroup({
    maxClusterRadius: 15,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    zoomToBoundsOnClick: true,
    iconCreateFunction: function(cluster) {
      const markers = cluster.getAllChildMarkers();
      let containerCount = 0;
      let tankerCount = 0;
      let otherCount = 0;

      // Count vessel types in cluster
      markers.forEach(marker => {
        const className = marker.options.icon.options.className;
        if (className.includes('container')) {
          containerCount++;
        } else if (className.includes('tanker')) {
          tankerCount++;
        } else {
          otherCount++;
        }
      });

      const total = markers.length;

      // Calculate mixed color based on composition (pastel colors)
      let bgColor;
      if (containerCount === total) {
        bgColor = '#fde68a'; // Pastel yellow (all containers)
      } else if (tankerCount === total) {
        bgColor = '#fdba74'; // Pastel orange (all tankers)
      } else {
        // Mixed cluster - blend colors
        const containerRatio = containerCount / total;
        const tankerRatio = tankerCount / total;

        if (containerRatio > tankerRatio) {
          bgColor = '#fcd34d'; // Light yellow-orange (more containers)
        } else if (tankerRatio > containerRatio) {
          bgColor = '#fda874'; // Light orange-yellow (more tankers)
        } else {
          bgColor = '#fbbf72'; // Balanced pastel mix
        }
      }

      return L.divIcon({
        html: `&lt;div style="background-color: ${bgColor}; opacity: 0.85; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #78350f; font-weight: 600; font-size: 10px; border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 2px 8px rgba(0,0,0,0.15);">${total}&lt;/div>`,
        className: 'vessel-cluster-icon',
        iconSize: L.point(20, 20)
      });
    }
  });

  portClusterGroup = L.markerClusterGroup({
    maxClusterRadius: 15,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    zoomToBoundsOnClick: true,
    iconCreateFunction: function(cluster) {
      const count = cluster.getChildCount();
      return L.divIcon({
        html: `&lt;div style="background-color: #bfdbfe; opacity: 0.85; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #1e3a8a; font-weight: 600; font-size: 10px; border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 2px 8px rgba(0,0,0,0.15);">${count}&lt;/div>`,
        className: 'port-cluster-icon',
        iconSize: L.point(20, 20)
      });
    }
  });

  vesselLayer.addLayer(vesselClusterGroup);
  portLayer.addLayer(portClusterGroup);

  // Add custom controls
  addCustomControls();

  // Initialize weather layer and dblclick handler only if enableWeatherData is enabled
  const settings = window.getSettings ? window.getSettings() : {};
  if (settings.enableWeatherData === true) {
    // Initialize weather layer if enabled
    if (weatherEnabled) {
      toggleWeatherLayer(true);
    }

    // Add long-press handler for weather info
    let pressTimer = null;
    let pressStartPos = null;
    const LONG_PRESS_DURATION = 700; // milliseconds
    const MAX_MOVE_DISTANCE = 10; // pixels

    const handlePressStart = (e) => {
      pressStartPos = e.latlng;
      pressTimer = setTimeout(async () => {
        await showWeatherInfo(e.latlng);
        pressTimer = null;
      }, LONG_PRESS_DURATION);
    };

    const handlePressEnd = (e) => {
      if (pressTimer) {
        clearTimeout(pressTimer);
        pressTimer = null;
      }
    };

    const handlePressMove = (e) => {
      // Cancel if mouse/finger moved too much
      if (pressTimer &amp;&amp; pressStartPos) {
        const distance = map.distance(pressStartPos, e.latlng);
        if (distance > MAX_MOVE_DISTANCE) {
          clearTimeout(pressTimer);
          pressTimer = null;
        }
      }
    };

    map.on('mousedown', handlePressStart);
    map.on('mouseup', handlePressEnd);
    map.on('mousemove', handlePressMove);
    map.on('touchstart', handlePressStart);
    map.on('touchend', handlePressEnd);
    map.on('touchmove', handlePressMove);
  }

  // Initialize panel dragging
  initializePanelDrag();
  console.log('[Harbor Map] Panel drag initialized');
}

/**
 * Shows weather info popup for a location
 *
 * @param {L.LatLng} latlng - Location coordinates
 * @param {string} tooltipContent - Optional tooltip content to show above weather
 * @returns {Promise&lt;void>}
 */
async function showWeatherInfo(latlng, tooltipContent = null) {
  try {
    // Check if weather data is enabled in settings
    const settings = window.getSettings ? window.getSettings() : {};
    if (settings.enableWeatherData === false) {
      return; // Weather data disabled, do nothing
    }

    // Show loading popup
    const loadingPopup = L.popup()
      .setLatLng(latlng)
      .setContent('&lt;div style="padding: 8px; text-align: center;"> Loading weather...&lt;/div>')
      .openOn(map);

    // Fetch location name and weather data in parallel
    const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latlng.lat.toFixed(4)}&amp;longitude=${latlng.lng.toFixed(4)}&amp;current_weather=true`;
    const geocodeUrl = `https://nominatim.openstreetmap.org/reverse?format=json&amp;lat=${latlng.lat.toFixed(4)}&amp;lon=${latlng.lng.toFixed(4)}&amp;zoom=10`;

    const [weatherResponse, geocodeResponse] = await Promise.all([
      fetch(weatherUrl),
      fetch(geocodeUrl, { headers: { 'User-Agent': 'ShippingManager' } })
    ]);

    const data = await weatherResponse.json();

    if (!data.current_weather) {
      throw new Error('No weather data available');
    }

    const weather = data.current_weather;

    // Try to get location name from geocoding
    let locationName = null;
    try {
      const geocodeData = await geocodeResponse.json();
      // Try to get city, town, village, or fallback
      locationName = geocodeData.address?.city ||
                    geocodeData.address?.town ||
                    geocodeData.address?.village ||
                    geocodeData.address?.county ||
                    null;
    } catch (e) {
      // Geocoding failed, will show coordinates instead
    }

    // Weather code to emoji mapping
    const weatherEmoji = {
      0: '',    // Clear sky
      1: '',   // Mainly clear
      2: '',    // Partly cloudy
      3: '',    // Overcast
      45: '',  // Fog
      48: '',  // Depositing rime fog
      51: '',  // Drizzle light
      53: '',  // Drizzle moderate
      55: '',  // Drizzle dense
      61: '',  // Rain slight
      63: '',  // Rain moderate
      65: '',  // Rain heavy
      71: '',  // Snow fall slight
      73: '',  // Snow fall moderate
      75: '',  // Snow fall heavy
      77: '',   // Snow grains
      80: '',  // Rain showers slight
      81: '',  // Rain showers moderate
      82: '',  // Rain showers violent
      85: '',  // Snow showers slight
      86: '',  // Snow showers heavy
      95: '',   // Thunderstorm
      96: '',   // Thunderstorm with hail
      99: ''    // Thunderstorm with heavy hail
    };

    const icon = weatherEmoji[weather.weathercode] || '';
    const temp = weather.temperature.toFixed(1);
    const wind = weather.windspeed.toFixed(0);

    // Theme-based colors - match tooltip styles exactly
    const isDark = currentMapStyle === 'dark' || currentMapStyle === 'satellite';
    const bgColor = isDark ? 'rgba(31, 31, 31, 0.95)' : 'rgba(255, 255, 255, 0.95)';
    const borderColor = isDark ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.2)';
    const boxShadow = isDark ? '0 2px 8px rgba(0, 0, 0, 0.3)' : '0 2px 8px rgba(0, 0, 0, 0.15)';
    const textColor = isDark ? '#e5e7eb' : '#1f2937';
    const tempColor = isDark ? '#60a5fa' : '#2563eb';

    // Display location name if available, otherwise coordinates
    const locationText = locationName
      ? ` ${locationName}`
      : ` ${latlng.lat.toFixed(2)}, ${latlng.lng.toFixed(2)}`;

    // Create combined popup with tooltip content and weather
    const tooltipSection = tooltipContent ? `
      &lt;div style="padding: 6px 8px; font-size: 11px; line-height: 1.4; background: ${bgColor}; color: ${textColor}; border: 1px solid ${borderColor}; border-radius: 4px; box-shadow: ${boxShadow}; margin-bottom: 4px;">
        ${tooltipContent}
      &lt;/div>
    ` : '';

    const content = `
      &lt;div>
        ${tooltipSection}
        &lt;div style="padding: 4px 8px; font-size: 11px; line-height: 1.4; background: ${bgColor}; color: ${textColor}; border: 1px solid ${borderColor}; border-radius: 4px; box-shadow: ${boxShadow};">
          &lt;div style="display: flex; align-items: center; gap: 6px;">
            &lt;span style="font-size: 18px;">${icon}&lt;/span>
            &lt;div>
              &lt;div style="font-size: 14px; font-weight: 600; color: ${tempColor};">${temp}C&lt;/div>
              &lt;div style="font-size: 9px; opacity: 0.7;"> ${wind} km/h&lt;/div>
              &lt;div style="font-size: 8px; opacity: 0.6; margin-top: 2px;">${locationText}&lt;/div>
            &lt;/div>
          &lt;/div>
        &lt;/div>
      &lt;/div>
    `;

    // Update popup with weather data
    loadingPopup.setContent(content);
  } catch (error) {
    console.error('[Harbor Map] Failed to fetch weather:', error);
    L.popup()
      .setLatLng(latlng)
      .setContent('&lt;div style="padding: 8px; text-align: center; color: #ef4444;"> Weather unavailable&lt;/div>')
      .openOn(map);
  }
}

/**
 * Toggles weather radar overlay (RainViewer)
 *
 * @param {boolean} enabled - Show or hide weather layer
 * @returns {void}
 */
function toggleWeatherLayer(enabled) {
  if (enabled) {
    // Get current timestamp (rounded to nearest 10 minutes for caching)
    const now = new Date();
    const timestamp = Math.floor(now.getTime() / 1000 / 600) * 600;

    // Create weather layer with RainViewer tiles
    weatherLayer = L.tileLayer(
      `https://tilecache.rainviewer.com/v2/radar/${timestamp}/512/{z}/{x}/{y}/2/1_1.png`,
      {
        opacity: 0.6,
        attribution: ' RainViewer',
        maxZoom: 18
      }
    );

    weatherLayer.addTo(map);
    weatherEnabled = true;
    localStorage.setItem('harborMapWeather', 'true');
    console.log('[Harbor Map] Weather radar enabled');
  } else {
    if (weatherLayer) {
      map.removeLayer(weatherLayer);
      weatherLayer = null;
    }
    weatherEnabled = false;
    localStorage.setItem('harborMapWeather', 'false');
    console.log('[Harbor Map] Weather radar disabled');
  }
}

/**
 * Adds custom Leaflet controls (filter, refresh)
 * Positioned in top-right corner below zoom controls
 */
function addCustomControls() {
  // Port Filter Control
  const FilterControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
      const container = L.DomUtil.create('div', 'leaflet-control-custom leaflet-control-filter');
      container.innerHTML = `
        &lt;select id="portFilterSelect">
          &lt;option value="my_ports">My Ports&lt;/option>
          &lt;option value="all_ports">All Ports&lt;/option>
          &lt;option value="my_ports_with_arrived_vessels">Ports with Arrived Vessels&lt;/option>
          &lt;option value="my_ports_with_anchored_vessels">Ports with Anchored Vessels&lt;/option>
          &lt;option value="my_ports_with_vessels_in_maint">Ports with Vessels in Maintenance&lt;/option>
          &lt;option value="my_ports_with_pending_vessels">Ports with Pending Vessels&lt;/option>
        &lt;/select>
      `;

      // Prevent map click propagation
      L.DomEvent.disableClickPropagation(container);

      // Add change listener
      container.querySelector('select').addEventListener('change', async (e) => {
        await setPortFilter(e.target.value);
      });

      return container;
    }
  });

  // Refresh Control
  const RefreshControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
      const container = L.DomUtil.create('div', 'leaflet-control-custom leaflet-control-refresh');
      container.innerHTML = '&lt;button title="Refresh">&lt;/button>';

      // Prevent map click propagation
      L.DomEvent.disableClickPropagation(container);

      // Add click listener
      container.querySelector('button').addEventListener('click', async () => {
        const { clearHarborMapCache } = await import('./api-client.js');
        await clearHarborMapCache();
        await loadOverview();
      });

      return container;
    }
  });

  // Settings Control
  const SettingsControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
      const container = L.DomUtil.create('div', 'leaflet-control-custom leaflet-control-settings');
      container.innerHTML = `
        &lt;select id="mapStyleSelect" title="Map Style">
          &lt;option value="standard">Standard&lt;/option>
          &lt;option value="dark">Dark Mode&lt;/option>
          &lt;option value="satellite">Satellite&lt;/option>
        &lt;/select>
      `;

      // Prevent map click propagation
      L.DomEvent.disableClickPropagation(container);

      // Add change listener
      container.querySelector('select').addEventListener('change', (e) => {
        changeTileLayer(e.target.value);
      });

      return container;
    }
  });

  // Route Filter Control
  const RouteFilterControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
      const container = L.DomUtil.create('div', 'leaflet-control-custom leaflet-control-route-filter');
      container.innerHTML = `
        &lt;select id="routeFilterSelect">
          &lt;option value="">All Routes&lt;/option>
        &lt;/select>
      `;

      // Prevent map click propagation
      L.DomEvent.disableClickPropagation(container);

      // Add change listener
      container.querySelector('select').addEventListener('change', (e) => {
        setRouteFilter(e.target.value);
      });

      return container;
    }
  });

  // Fullscreen Control
  const FullscreenControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
      const container = L.DomUtil.create('div', 'leaflet-control-custom leaflet-control-fullscreen');
      container.innerHTML = '&lt;button title="Fullscreen">&lt;/button>';

      // Prevent map click propagation
      L.DomEvent.disableClickPropagation(container);

      // Add click listener
      container.querySelector('button').addEventListener('click', () => {
        const mapWrapper = document.querySelector('.chat-area-wrapper');
        const button = container.querySelector('button');

        if (!mapWrapper) {
          console.error('[Harbor Map] Cannot find map wrapper for fullscreen');
          return;
        }

        if (mapWrapper.classList.contains('fullscreen')) {
          // Exit fullscreen
          mapWrapper.classList.remove('fullscreen');
          button.innerHTML = '';
          button.title = 'Fullscreen';
        } else {
          // Enter fullscreen
          mapWrapper.classList.add('fullscreen');
          button.innerHTML = '';
          button.title = 'Exit Fullscreen';
        }

        // Invalidate map size after transition
        setTimeout(() => {
          map.invalidateSize();
        }, 300);
      });

      return container;
    }
  });

  // Weather Control
  const WeatherControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
      const container = L.DomUtil.create('div', 'leaflet-control-custom leaflet-control-weather');
      const icon = weatherEnabled ? '' : '';
      container.innerHTML = `&lt;button title="Toggle Weather Radar">${icon}&lt;/button>`;

      // Prevent map click propagation
      L.DomEvent.disableClickPropagation(container);

      // Add click listener
      container.querySelector('button').addEventListener('click', () => {
        const button = container.querySelector('button');
        const newState = !weatherEnabled;
        toggleWeatherLayer(newState);
        button.innerHTML = newState ? '' : '';
        button.title = newState ? 'Hide Weather Radar' : 'Show Weather Radar';
      });

      return container;
    }
  });

  // Add controls to map (order matters - top to bottom)
  map.addControl(new FullscreenControl());

  // Only add Weather Control if enableWeatherData is enabled
  const settings = window.getSettings ? window.getSettings() : {};
  if (settings.enableWeatherData === true) {
    weatherControl = new WeatherControl();
    map.addControl(weatherControl);
  }

  map.addControl(new RefreshControl());
  map.addControl(new SettingsControl());
  map.addControl(new RouteFilterControl());
  map.addControl(new FilterControl());

  // Set saved values in dropdowns
  const mapStyleSelect = document.getElementById('mapStyleSelect');
  const portFilterSelect = document.getElementById('portFilterSelect');

  if (mapStyleSelect) {
    mapStyleSelect.value = currentMapStyle;
  }

  if (portFilterSelect) {
    portFilterSelect.value = currentFilter;
  }

  console.log(`[Harbor Map] Restored saved settings - Style: ${currentMapStyle}, Filter: ${currentFilter}`);

  // Apply theme class for control styling
  applyMapTheme(currentMapStyle);
}

/**
 * Applies theme class to map container for control styling
 *
 * @param {string} style - Map style key ('standard', 'dark', 'satellite')
 * @returns {void}
 */
function applyMapTheme(style) {
  const mapCanvas = document.getElementById('harborMapCanvas');
  if (!mapCanvas) return;

  // Remove all theme classes
  mapCanvas.classList.remove('theme-light', 'theme-dark');

  // Add appropriate theme class
  if (style === 'standard') {
    mapCanvas.classList.add('theme-light');
  } else {
    // dark and satellite both use dark controls
    mapCanvas.classList.add('theme-dark');
  }

  console.log(`[Harbor Map] Applied theme class for style: ${style}`);
}

/**
 * Changes the map tile layer (theme)
 *
 * @param {string} layerKey - Key from tileLayers object
 * @returns {void}
 */
function changeTileLayer(layerKey) {
  if (!tileLayers[layerKey]) return;

  // Remove current layer
  if (currentTileLayer) {
    map.removeLayer(currentTileLayer);
  }

  // Add new layer
  currentTileLayer = L.tileLayer(tileLayers[layerKey].url, {
    maxZoom: 19
  }).addTo(map);

  // Save to localStorage
  currentMapStyle = layerKey;
  localStorage.setItem('harborMapStyle', layerKey);

  // Apply theme class for control styling
  applyMapTheme(layerKey);

  // Update map container background color
  const mapContainer = map.getContainer();
  const backgroundColor = layerKey === 'standard' ? '#e0e0e0' : '#1f1f1f';
  mapContainer.style.backgroundColor = backgroundColor;

  console.log(`[Harbor Map] Changed map style to: ${tileLayers[layerKey].name} (saved)`);
}

/**
 * Renders vessels as markers on the map
 * Uses color-coded icons based on vessel status
 *
 * @param {Array&lt;Object>} vessels - Vessels with position data from backend
 * @returns {void}
 * @example
 * renderVessels([{ id: 1234, position: { lat: -27.38, lon: 153.12 }, status: 'enroute', ... }]);
 */
export function renderVessels(vessels) {
  vesselClusterGroup.clearLayers();

  console.log(`[Harbor Map] Rendering ${vessels.length} vessels`);

  let skipped = 0;
  vessels.forEach(vessel => {
    if (!vessel.position) {
      skipped++;
      return;
    }

    // Get vessel type from capacity_type field
    const vesselType = getVesselType(vessel.capacity_type);

    // Calculate heading if vessel has route
    let heading = 0;
    if (vessel.routes &amp;&amp; vessel.routes.length > 0 &amp;&amp; vessel.routes[0].path &amp;&amp; vessel.routes[0].path.length >= 2) {
      const path = vessel.routes[0].path;
      // Find current position in path and calculate heading to next point
      for (let i = 0; i &lt; path.length - 1; i++) {
        const point = path[i];
        if (Math.abs(point.lat - vessel.position.lat) &lt; 0.01 &amp;&amp; Math.abs(point.lon - vessel.position.lon) &lt; 0.01) {
          heading = calculateHeading(point, path[i + 1]);
          break;
        }
      }
      // If not found in path, use first two points
      if (heading === 0 &amp;&amp; path.length >= 2) {
        heading = calculateHeading(path[0], path[1]);
      }
    }

    // Create icon with type, status, and heading
    const icon = createVesselIcon(vessel.status, vesselType, heading);

    // Add offset for vessels in port to prevent overlap with port marker
    // Shift slightly northeast to make both clickable
    let vesselLat = vessel.position.lat;
    let vesselLon = vessel.position.lon;
    if (vessel.status === 'port' || vessel.status === 'anchor') {
      vesselLat += 0.003; // ~300m north
      vesselLon += 0.003; // ~300m east
    }

    // Create marker
    const marker = L.marker([vesselLat, vesselLon], { icon });

    // Prepare tooltip content with detailed cargo info
    let cargoDisplay = 'N/A';
    if (vessel.capacity &amp;&amp; vessel.capacity_max) {
      if (vessel.capacity_type === 'container') {
        const dry = vessel.capacity.dry;
        const ref = vessel.capacity.refrigerated;
        const dryMax = vessel.capacity_max.dry;
        const refMax = vessel.capacity_max.refrigerated;
        cargoDisplay = `Dry: ${dry}/${dryMax} TEU, Ref: ${ref}/${refMax} TEU`;
      } else if (vessel.capacity_type === 'tanker') {
        const fuel = vessel.capacity.fuel;
        const crude = vessel.capacity.crude_oil;
        const fuelMax = vessel.capacity_max.fuel;
        const crudeMax = vessel.capacity_max.crude_oil;
        cargoDisplay = `Fuel: ${fuel}/${fuelMax} bbl, Crude: ${crude}/${crudeMax} bbl`;
      }
    }

    const vesselTooltipContent = `
      &lt;strong>${vessel.name}&lt;/strong>&lt;br>
      Status: ${vessel.status}${vessel.eta !== 'N/A' ? ` | ETA: ${vessel.eta}` : ''}&lt;br>
      Cargo: ${cargoDisplay}
    `;

    // Bind tooltip (hover) with vessel info
    marker.bindTooltip(vesselTooltipContent, {
      direction: 'auto',
      offset: [0, -10]
    });

    // Click handler - close tooltip, open vessel panel and show combined weather popup
    marker.on('click', async (e) => {
      marker.closeTooltip();
      window.harborMap.selectVesselFromMap(vessel.id);
      await showWeatherInfo(e.latlng, vesselTooltipContent);
    });

    vesselClusterGroup.addLayer(marker);
  });

  console.log(`[Harbor Map] Rendered ${vessels.length - skipped} vessels, skipped ${skipped} without position`);
}

/**
 * Renders ports as markers on the map
 * Uses color-coded markers for demand levels
 *
 * @param {Array&lt;Object>} ports - Ports with demand data from backend
 * @returns {void}
 * @example
 * renderPorts([{ code: 'AUBNE', lat: -27.38, lon: 153.12, demandLevel: 'high', ... }]);
 */
export function renderPorts(ports) {
  portClusterGroup.clearLayers();

  console.log(`[Harbor Map] Rendering ${ports.length} ports`);
  if (ports.length > 0) {
    console.log('[Harbor Map] First port sample:', {
      code: ports[0].code,
      hasDemand: !!ports[0].demand,
      demand: ports[0].demand
    });
  }

  ports.forEach(port => {
    if (!port.lat || !port.lon) return;

    // Format demand for tooltip
    let demandText = 'No active route / Demand unknown';
    if (port.demand) {
      const parts = [];
      if (port.demand.container) {
        const dry = port.demand.container.dry || 0;
        const ref = port.demand.container.refrigerated || 0;
        parts.push(`Container: Dry ${dry.toLocaleString()} TEU / Ref ${ref.toLocaleString()} TEU`);
      }
      if (port.demand.tanker) {
        const fuel = port.demand.tanker.fuel || 0;
        const crude = port.demand.tanker.crude_oil || 0;
        parts.push(`Tanker: Fuel: ${fuel.toLocaleString()} bbl / Crude: ${crude.toLocaleString()} bbl`);
      }
      if (parts.length > 0) {
        demandText = parts.join('&lt;br>');
      }
    }

    // Format port name
    const portName = port.code.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');

    // Prepare tooltip content
    const portTooltipContent = `
      &lt;strong>${portName}&lt;/strong>&lt;br>
      ${demandText}
    `;

    // Create marker
    const marker = L.marker([parseFloat(port.lat), parseFloat(port.lon)], {
      icon: portIcons.default
    });

    // Bind tooltip (hover) with port info
    marker.bindTooltip(portTooltipContent, {
      direction: 'auto',
      offset: [0, -10]
    });

    // Click handler - close tooltip, select port and show combined weather popup
    marker.on('click', async (e) => {
      marker.closeTooltip();
      selectPort(port.code);
      await showWeatherInfo(e.latlng, portTooltipContent);
    });

    portClusterGroup.addLayer(marker);
  });
}

/**
 * Draws route path on map with blue polyline
 * Highlights origin (red) and destination (green) ports
 *
 * @param {Object} route - Route data from backend
 * @param {Array&lt;Object>} ports - Array of port objects with demand data
 * @param {boolean} autoZoom - Whether to auto-zoom to route bounds (default: true)
 * @returns {void}
 * @example
 * drawRoute({ path: [{lat: -27.38, lon: 153.12}, ...], origin: 'AUBNE', destination: 'NZAKL' }, ports);
 */
export function drawRoute(route, ports = [], autoZoom = true) {
  routeLayer.clearLayers();

  if (!route || !route.path || route.path.length === 0) {
    console.log('[Harbor Map] No route to draw');
    return;
  }

  // Support both field names for backwards compatibility
  const originPort = route.origin || route.origin_port_code;
  const destinationPort = route.destination || route.destination_port_code;

  console.log('[Harbor Map] Drawing route:', {
    origin: originPort,
    destination: destinationPort,
    pathLength: route.path.length
  });

  // Draw route path as blue polyline
  const latLngs = route.path.map(p => [p.lat, p.lon]);
  const polyline = L.polyline(latLngs, {
    color: '#3388ff',
    weight: 3,
    opacity: 0.7
  });

  routeLayer.addLayer(polyline);

  // Highlight origin port (red)
  if (originPort) {
    const originName = originPort.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
    const originMarker = L.marker(latLngs[0], { icon: portIcons.origin });

    // Find port data for demand info
    const originPortData = ports.find(p => p.code === originPort);
    let demandText = 'N/A';

    if (originPortData &amp;&amp; originPortData.demand) {
      const parts = [];
      if (originPortData.demand.container) {
        const dry = originPortData.demand.container.dry || 0;
        const ref = originPortData.demand.container.refrigerated || 0;
        parts.push(`Container: Dry ${dry.toLocaleString()} TEU / Ref ${ref.toLocaleString()} TEU`);
      }
      if (originPortData.demand.tanker) {
        const fuel = originPortData.demand.tanker.fuel || 0;
        const crude = originPortData.demand.tanker.crude_oil || 0;
        parts.push(`Tanker: Fuel: ${fuel.toLocaleString()} bbl / Crude: ${crude.toLocaleString()} bbl`);
      }
      if (parts.length > 0) {
        demandText = parts.join('&lt;br>');
      }
    }

    // Bind tooltip - same format as normal ports (mouseover only)
    originMarker.bindTooltip(`
      &lt;strong>${originName}&lt;/strong>&lt;br>
      &lt;strong>Demand&lt;/strong>&lt;br>
      ${demandText}
    `, {
      direction: 'auto',
      offset: [0, -10],
      className: 'route-port-tooltip'
    });

    // Click handler - open port panel
    originMarker.on('click', () => selectPort(originPort));

    routeLayer.addLayer(originMarker);
    console.log('[Harbor Map] Added origin port marker:', originName, latLngs[0]);
  } else {
    console.warn('[Harbor Map] No origin port in route data');
  }

  // Highlight destination port (green)
  if (destinationPort) {
    const destName = destinationPort.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
    const destMarker = L.marker(latLngs[latLngs.length - 1], { icon: portIcons.destination });

    // Find port data for demand info
    const destPortData = ports.find(p => p.code === destinationPort);
    let demandText = 'N/A';

    if (destPortData &amp;&amp; destPortData.demand) {
      const parts = [];
      if (destPortData.demand.container) {
        const dry = destPortData.demand.container.dry || 0;
        const ref = destPortData.demand.container.refrigerated || 0;
        parts.push(`Container: Dry ${dry.toLocaleString()} TEU / Ref ${ref.toLocaleString()} TEU`);
      }
      if (destPortData.demand.tanker) {
        const fuel = destPortData.demand.tanker.fuel || 0;
        const crude = destPortData.demand.tanker.crude_oil || 0;
        parts.push(`Tanker: Fuel: ${fuel.toLocaleString()} bbl / Crude: ${crude.toLocaleString()} bbl`);
      }
      if (parts.length > 0) {
        demandText = parts.join('&lt;br>');
      }
    }

    // Bind tooltip - same format as normal ports (mouseover only)
    destMarker.bindTooltip(`
      &lt;strong>${destName}&lt;/strong>&lt;br>
      &lt;strong>Demand&lt;/strong>&lt;br>
      ${demandText}
    `, {
      direction: 'auto',
      offset: [0, -10],
      className: 'route-port-tooltip'
    });

    // Click handler - open port panel
    destMarker.on('click', () => selectPort(destinationPort));

    routeLayer.addLayer(destMarker);
    console.log('[Harbor Map] Added destination port marker:', destName, latLngs[latLngs.length - 1]);
  } else {
    console.warn('[Harbor Map] No destination port in route data');
  }

  // Fit map to route bounds (only if autoZoom is true)
  if (autoZoom) {
    map.fitBounds(polyline.getBounds(), {
      paddingTopLeft: [50, 50],
      paddingBottomRight: [325, 50] // 275px panel + 50px extra padding
    });
  }
}

/**
 * Clears route layer (removes blue line and port highlights)
 *
 * @returns {void}
 * @example
 * clearRoute();
 */
export function clearRoute() {
  routeLayer.clearLayers();
}

/**
 * Sets port filter to specific value and reloads map
 *
 * @param {string} filter - 'my_ports' or 'all_ports'
 * @returns {Promise&lt;void>}
 * @example
 * await setPortFilter('my_ports');
 */
export async function setPortFilter(filter) {
  currentFilter = filter;
  localStorage.setItem('harborMapFilter', filter);
  console.log(`[Harbor Map] Filter changed to: ${filter} (saved)`);

  // Clear cache to force fresh data fetch with new filter
  const { clearHarborMapCache } = await import('./api-client.js');
  await clearHarborMapCache();

  await loadOverview();
}

/**
 * Loads and renders harbor map overview from cache only
 * Does NOT fetch from API - relies on background auto-update
 *
 * @returns {Promise&lt;void>}
 * @example
 * await loadOverview();
 */
export async function loadOverview() {
  try {
    // Always use cached data only
    const cachedData = getCachedOverview();

    if (cachedData &amp;&amp; cachedData.filter === currentFilter) {
      console.log('[Harbor Map] Loading from cache (no API call)');

      // Store data for route filtering
      currentVessels = cachedData.vessels;
      currentPorts = cachedData.ports;

      // Update route dropdown
      updateRouteDropdown();

      // Apply route filter if active
      const vesselsToRender = currentRouteFilter
        ? currentVessels.filter(v => v.route_name === currentRouteFilter)
        : currentVessels;

      renderVessels(vesselsToRender);
      renderPorts(cachedData.ports);
      clearRoute();

      // Reset selection state
      selectedVesselId = null;
      selectedPortCode = null;

      hideVesselPanel();
      hidePortPanel();

      return;
    }

    // No cache available - fetch once (only on first load or filter change)
    console.log('[Harbor Map] No cache available, fetching initial data...');
    const data = await fetchHarborMapOverview(currentFilter);

    console.log('[Harbor Map] Overview data:', {
      vessels: data.vessels.length,
      ports: data.ports.length,
      filter: data.filter,
      sampleVessel: data.vessels[0]
    });

    // Store data for route filtering
    currentVessels = data.vessels;
    currentPorts = data.ports;

    // Update route dropdown
    updateRouteDropdown();

    // Apply route filter if active
    const vesselsToRender = currentRouteFilter
      ? currentVessels.filter(v => v.route_name === currentRouteFilter)
      : currentVessels;

    renderVessels(vesselsToRender);
    renderPorts(data.ports);
    clearRoute();

    // Reset selection state
    selectedVesselId = null;
    selectedPortCode = null;

    hideVesselPanel();
    hidePortPanel();
  } catch (error) {
    console.error('Error loading harbor map overview:', error);
  }
}

/**
 * Selects a vessel and shows reachable ports
 * Hides other vessels, draws route, shows vessel panel
 *
 * @param {number} vesselId - Vessel ID to select
 * @returns {Promise&lt;void>}
 * @example
 * await selectVessel(1234);
 */
export async function selectVessel(vesselId) {
  try {
    selectedVesselId = vesselId;
    selectedPortCode = null;

    const data = await fetchVesselReachablePorts(vesselId);

    console.log(`[Harbor Map] Vessel ${vesselId} selected:`, {
      reachablePorts: data.reachablePorts.length,
      hasRoute: !!data.route
    });

    // Clear vessel markers (hide all vessels)
    vesselClusterGroup.clearLayers();

    // Render the selected vessel on the map
    if (data.vessel &amp;&amp; data.vessel.position) {
      // Get vessel type and create icon (NO rotation for selected vessel)
      const vesselType = getVesselType(data.vessel.capacity_type);
      const icon = createVesselIcon(data.vessel.status, vesselType, 0); // heading = 0 (no rotation)

      // Add offset for vessels in port to prevent overlap with port marker
      let vesselLat = data.vessel.position.lat;
      let vesselLon = data.vessel.position.lon;
      if (data.vessel.status === 'port' || data.vessel.status === 'anchor') {
        vesselLat += 0.003; // ~300m north
        vesselLon += 0.003; // ~300m east
      }

      // Create marker for selected vessel
      const vesselMarker = L.marker([vesselLat, vesselLon], { icon });

      // Bind tooltip
      vesselMarker.bindTooltip(`
        &lt;strong>${data.vessel.name}&lt;/strong>&lt;br>
        Status: ${data.vessel.status}&lt;br>
        ${data.vessel.eta !== 'N/A' ? `ETA: ${data.vessel.eta}&lt;br>` : ''}
        Cargo: ${data.vessel.formattedCargo || 'N/A'}
      `, {
        direction: 'top',
        offset: [0, -10]
      });

      vesselClusterGroup.addLayer(vesselMarker);
    }

    // If vessel is in port, highlight the current port
    if ((data.vessel.status === 'port' || data.vessel.status === 'anchor') &amp;&amp; data.vessel.port_code) {
      console.log('[Harbor Map] Vessel in port, highlighting port:', data.vessel.port_code);

      // Find the port in reachable ports or current ports
      let currentPort = data.reachablePorts.find(p => p.code === data.vessel.port_code);
      if (!currentPort) {
        // Try to find in current ports
        currentPort = currentPorts.find(p => p.code === data.vessel.port_code);
      }

      // If we found the port, make sure it's rendered
      if (currentPort) {
        // Add current port to reachable ports if not already there
        const portExists = data.reachablePorts.some(p => p.code === data.vessel.port_code);
        if (!portExists) {
          data.reachablePorts.unshift(currentPort); // Add at beginning
        }
      }
    }

    // Render only reachable ports (including current port if vessel is in port)
    renderPorts(data.reachablePorts);

    // Draw route if vessel is sailing (without auto-zoom)
    if (data.route) {
      // Prefer assignedPorts (correct demand) over allPorts (no demand for non-assigned)
      const portsForDemand = data.assignedPorts || data.allPorts;
      drawRoute(data.route, portsForDemand, false);
    }

    // Zoom to show route (prioritize route over all ports)
    if (data.route &amp;&amp; data.route.path) {
      const bounds = L.latLngBounds();
      data.route.path.forEach(p => bounds.extend([p.lat, p.lon]));

      // Padding: top, right (account for 275px panel), bottom, left
      map.fitBounds(bounds, {
        paddingTopLeft: [50, 50],
        paddingBottomRight: [325, 50] // 275px panel + 50px extra padding
      });
    } else if (data.reachablePorts.length > 0) {
      // Fallback: fit all reachable ports if no route
      const bounds = L.latLngBounds();
      data.reachablePorts.forEach(port => {
        if (port.lat &amp;&amp; port.lon) {
          bounds.extend([parseFloat(port.lat), parseFloat(port.lon)]);
        }
      });
      map.fitBounds(bounds, {
        paddingTopLeft: [50, 50],
        paddingBottomRight: [325, 50]
      });
    } else if (data.vessel &amp;&amp; data.vessel.position) {
      // Fallback: center on vessel if no route or ports
      map.setView([data.vessel.position.lat, data.vessel.position.lon], map.getZoom(), {
        animate: true,
        duration: 0.5,
        paddingTopLeft: [50, 50],
        paddingBottomRight: [325, 50] // 275px panel + 50px padding
      });
    }

    // Close port panel first, then show vessel panel
    hidePortPanel();
    showVesselPanel(data.vessel);
  } catch (error) {
    console.error(`Error selecting vessel ${vesselId}:`, error);
  }
}

/**
 * Selects a port and shows categorized vessels
 * Shows port panel with vessels in/to/from port
 *
 * @param {string} portCode - Port code to select
 * @returns {Promise&lt;void>}
 * @example
 * await selectPort('AUBNE');
 */
export async function selectPort(portCode) {
  try {
    console.log(`[Harbor Map] Port ${portCode} clicked`);
    selectedPortCode = portCode;
    selectedVesselId = null;

    const data = await fetchPortDetails(portCode);

    console.log(`[Harbor Map] Port data received:`, {
      port: data.port.code,
      hasDemand: !!data.port.demand,
      vessels: {
        inPort: data.vessels.inPort.length,
        toPort: data.vessels.toPort.length,
        fromPort: data.vessels.fromPort.length
      }
    });

    // Center port in the middle of visible area (left 2/3 not covered by panel)
    if (data.port.lat &amp;&amp; data.port.lon) {
      // First zoom to port with panel padding (like routes do)
      map.setView([data.port.lat, data.port.lon], map.getZoom(), {
        animate: true,
        duration: 0.5,
        paddingTopLeft: [50, 50],
        paddingBottomRight: [325, 50] // 275px panel + 50px padding
      });
    }

    // Close vessel panel first, then show port panel
    hideVesselPanel();
    showPortPanel(data.port, data.vessels);
  } catch (error) {
    console.error(`Error selecting port ${portCode}:`, error);
  }
}

/**
 * Deselects current selection and returns to overview
 *
 * @returns {Promise&lt;void>}
 * @example
 * await deselectAll();
 */
export async function deselectAll() {
  await loadOverview();
}

/**
 * Gets the currently selected port code
 *
 * @returns {string|null} Port code or null if no port selected
 * @example
 * const portCode = getSelectedPortCode();
 */
export function getSelectedPortCode() {
  return selectedPortCode;
}

/**
 * Updates weather data setting and applies changes immediately to the map
 * WITHOUT reloading the entire map
 *
 * @param {boolean} enabled - Whether weather data should be enabled
 * @returns {void}
 */
export function updateWeatherDataSetting(enabled) {
  // This function is called when settings change
  // Weather controls are only initialized/removed on page load (not dynamically)
  // User must reload page for changes to take effect
  console.log('[Harbor Map] Weather data setting updated to:', enabled, '(reload required)');
}

/**
 * Gets a vessel by ID from current vessels cache
 *
 * @param {number} vesselId - Vessel ID to find
 * @returns {Promise&lt;Object|null>} Vessel object or null if not found
 * @example
 * const vessel = await getVesselById(1234);
 */
export async function getVesselById(vesselId, skipCache = false) {
  // If skipCache is false, try to find in current cache first
  if (!skipCache) {
    const cachedVessel = currentVessels.find(v => v.id === vesselId);
    if (cachedVessel) {
      return cachedVessel;
    }
  }

  // Refresh overview from server with cache-busting timestamp
  try {
    const timestamp = Date.now();
    const response = await fetch(window.apiUrl(`/api/harbor-map/overview?filter=${currentFilter}&amp;_=${timestamp}`));

    if (!response.ok) {
      throw new Error(`Failed to fetch harbor map overview: ${response.statusText}`);
    }

    const overview = await response.json();
    currentVessels = overview.vessels || [];
    currentPorts = overview.ports || [];

    console.log(`[Harbor Map] Fetched fresh data from server, found ${currentVessels.length} vessels`);

    return currentVessels.find(v => v.id === vesselId) || null;
  } catch (error) {
    console.error('[Harbor Map] Failed to get vessel by ID:', error);
    return null;
  }
}

/**
 * Updates a single vessel marker on the map without full refresh
 *
 * @param {number} vesselId - Vessel ID to update
 * @returns {Promise&lt;void>}
 * @example
 * await updateVesselMarker(1234);
 */
export async function updateVesselMarker(vesselId) {
  const vessel = await getVesselById(vesselId);
  if (!vessel) {
    console.warn('[Harbor Map] Vessel not found for marker update:', vesselId);
    return;
  }

  // Re-render all vessels to update the marker
  // This keeps the vessel visible on the map with updated status
  renderVessels(currentVessels);
  console.log('[Harbor Map] Vessel marker updated:', vesselId);
}

/**
 * Updates the route dropdown with all unique routes from current vessels
 * Populates the dropdown with route names from vessels with status 'enroute'
 *
 * @returns {void}
 * @example
 * updateRouteDropdown();
 */
function updateRouteDropdown() {
  const routeSelect = document.getElementById('routeFilterSelect');
  if (!routeSelect) {
    console.warn('[Harbor Map] Route filter select not found');
    return;
  }

  // Extract unique route names from vessels with status 'enroute'
  const routes = new Set();
  currentVessels.forEach(vessel => {
    if (vessel.status === 'enroute' &amp;&amp; vessel.route_name) {
      routes.add(vessel.route_name);
    }
  });

  // Sort routes alphabetically
  const sortedRoutes = Array.from(routes).sort();

  console.log(`[Harbor Map] Found ${sortedRoutes.length} unique routes`);

  // Clear existing options (except "All Routes")
  routeSelect.innerHTML = '&lt;option value="">All Routes&lt;/option>';

  // Add route options
  sortedRoutes.forEach(routeName => {
    const option = document.createElement('option');
    option.value = routeName;
    option.textContent = routeName;
    routeSelect.appendChild(option);
  });

  // Restore selected route if it exists
  if (currentRouteFilter &amp;&amp; sortedRoutes.includes(currentRouteFilter)) {
    routeSelect.value = currentRouteFilter;
  } else {
    currentRouteFilter = null;
    routeSelect.value = '';
  }
}

/**
 * Sets the route filter and re-renders map with filtered vessels
 * Also opens the route vessels panel if a route is selected
 * When a route is selected, draws the route path and shows only origin/destination ports
 *
 * @param {string} routeName - Route name to filter by (empty string = all routes)
 * @returns {void}
 * @example
 * setRouteFilter('Hamburg - New York');
 */
function setRouteFilter(routeName) {
  currentRouteFilter = routeName || null;
  console.log(`[Harbor Map] Route filter changed to: ${currentRouteFilter || 'All Routes'}`);

  // Filter vessels
  const vesselsToRender = currentRouteFilter
    ? currentVessels.filter(v => v.route_name === currentRouteFilter)
    : currentVessels;

  console.log(`[Harbor Map] Rendering ${vesselsToRender.length} vessels (filtered by route)`);

  if (currentRouteFilter &amp;&amp; vesselsToRender.length > 0) {
    // Route selected - extract route from first vessel
    const firstVessel = vesselsToRender[0];

    // Build route from vessel.active_route (same as in vessel click handler)
    if (firstVessel.status === 'enroute' &amp;&amp; firstVessel.active_route?.path) {
      // Handle reversed routes
      const isReversed = firstVessel.active_route.reversed === true;
      const actualOrigin = isReversed
        ? (firstVessel.active_route.destination_port_code || firstVessel.active_route.destination)
        : (firstVessel.active_route.origin_port_code || firstVessel.active_route.origin);
      const actualDestination = isReversed
        ? (firstVessel.active_route.origin_port_code || firstVessel.active_route.origin)
        : (firstVessel.active_route.destination_port_code || firstVessel.active_route.destination);

      const route = {
        path: firstVessel.active_route.path,
        origin: actualOrigin,
        destination: actualDestination
      };

      // Filter ports to show only origin and destination
      const routePorts = currentPorts.filter(p =>
        p.code === route.origin || p.code === route.destination
      );

      // Render vessels and route ports
      renderVessels(vesselsToRender);
      renderPorts(routePorts);

      // Draw route path (with auto-zoom)
      drawRoute(route, currentPorts, true);

      console.log(`[Harbor Map] Route drawn: ${route.origin}  ${route.destination}, ${route.path.length} points`);
    } else {
      console.warn('[Harbor Map] No active route available for vessel');
      renderVessels(vesselsToRender);
      renderPorts(currentPorts);
      clearRoute();
    }

    // Show route vessels panel
    showRouteVesselsPanel(currentRouteFilter, vesselsToRender);
  } else {
    // No route selected - show all vessels and ports
    renderVessels(vesselsToRender);
    renderPorts(currentPorts);
    clearRoute();
    hideRouteVesselsPanel();
  }
}

/**
 * Shows the route vessels panel with a list of all vessels on the selected route
 *
 * @param {string} routeName - Name of the route
 * @param {Array&lt;Object>} vessels - Vessels on this route
 * @returns {void}
 */
async function showRouteVesselsPanel(routeName, vessels) {
  const { showRoutePanel } = await import('./route-vessels-panel.js');
  showRoutePanel(routeName, vessels);
}

/**
 * Hides the route vessels panel
 *
 * @returns {void}
 */
async function hideRouteVesselsPanel() {
  const { hideRoutePanel } = await import('./route-vessels-panel.js');
  hideRoutePanel();
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation Version: 0.0.7 - ShippingManager CoPilot
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
