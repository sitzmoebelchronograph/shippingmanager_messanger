<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>server/gameapi.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Dark theme matching app style - carefully scoped to not break layout */
        html, body {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
            overflow-x: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Custom scrollbar styling for all browsers */
        * {
            scrollbar-width: thin !important;
            scrollbar-color: #404040 #1a1a1a !important;
        }

        /* Webkit browsers (Chrome, Safari, Edge) */
        *::-webkit-scrollbar {
            width: 6px !important;
            height: 6px !important;
        }

        *::-webkit-scrollbar-track {
            background: #1a1a1a !important;
        }

        *::-webkit-scrollbar-thumb {
            background-color: #404040 !important;
            border-radius: 3px !important;
        }

        *::-webkit-scrollbar-thumb:hover {
            background-color: #505050 !important;
        }

        /* Navigation sidebar - remove padding and white borders */
        nav {
            background-color: #242424 !important;
            border-right: 1px solid #404040 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow-x: hidden !important;
        }
        nav h2, nav h3 {
            color: #e0e0e0 !important;
            border-bottom: 1px solid #404040 !important;
            padding: 10px 15px !important;
            margin: 0 !important;
            background-color: #242424 !important;
            font-size: 14px !important;
            font-weight: 600 !important;
        }
        nav h3 {
            font-size: 13px !important;
        }
        nav ul {
            padding: 0 !important;
            margin: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li {
            list-style: none !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li a {
            color: #c9d1d9 !important;
            display: block !important;
            padding: 8px 15px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            background-color: #242424 !important;
            margin: 0 !important;
            border: none !important;
            font-size: 14px !important;
        }
        nav ul li a:hover {
            color: #60a5fa !important;
            background-color: rgba(96, 165, 250, 0.1) !important;
        }
        /* Module links (direct children of nav > ul > li) */
        nav > ul > li > a {
            color: #60a5fa !important;
            font-weight: 600 !important;
            padding: 10px 15px !important;
            font-size: 14px !important;
            border-left: 3px solid #60a5fa !important;
            padding-left: 12px !important;
        }
        nav > ul > li > a:hover {
            background-color: rgba(96, 165, 250, 0.15) !important;
        }
        /* Sub-items (methods/functions) indented */
        nav ul.methods {
            padding-left: 15px !important;
        }
        nav ul.methods li a {
            color: #9ca3af !important;
            font-size: 13px !important;
            padding: 6px 15px !important;
            font-weight: 400 !important;
        }
        nav ul.methods li a:hover {
            color: #c9d1d9 !important;
        }
        nav > h2:first-child {
            font-size: 16px !important;
            font-weight: 700 !important;
            padding: 12px 15px !important;
        }

        /* Main content area - dark background */
        #main {
            background-color: #1a1a1a !important;
            padding: 20px !important;
        }

        /* Article and sections - ensure dark background */
        article, section, .container-overview, .description {
            background-color: #1a1a1a !important;
        }

        /* Images - style demo images */
        img {
            max-width: 100% !important;
            height: auto !important;
            border: 1px solid #404040 !important;
            border-radius: 8px !important;
            margin: 20px 0 !important;
        }

        /* Links */
        a {
            color: #60a5fa !important;
            text-decoration: none !important;
        }
        a:hover {
            color: #93c5fd !important;
            text-decoration: underline !important;
        }

        /* Headings */
        h1, h2, h3, h4, h5, h6 {
            color: #e0e0e0 !important;
            border-bottom-color: #404040 !important;
            background-color: transparent !important;
        }
        h4.name {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
        }

        /* Code blocks */
        pre {
            background-color: #0d1117 !important;
            border: 1px solid #404040 !important;
        }
        pre code {
            background-color: transparent !important;
        }
        code {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
        }

        /* Tables */
        table {
            border-color: #404040 !important;
            background-color: #1a1a1a !important;
        }
        table thead tr {
            background-color: #242424 !important;
        }
        table tbody tr {
            background-color: #1a1a1a !important;
        }
        table tbody tr:nth-child(even) {
            background-color: #1f1f1f !important;
        }
        table td, table th {
            border-color: #404040 !important;
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }
        .params .name, .props .name {
            color: #10b981 !important;
            font-family: 'Courier New', monospace !important;
        }

        /* Descriptions and details */
        .description, .details, dt, dd, p, ul, ol, dl {
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }

        /* Types */
        .type-signature {
            color: #a78bfa !important;
        }

        /* Source links */
        .details .details-item-container {
            border-left-color: #404040 !important;
        }

        /* Breadcrumbs */
        .page-title {
            color: #e0e0e0 !important;
        }

        /* Search */
        #nav-search {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
            color: #e0e0e0 !important;
        }

        /* Mobile nav trigger */
        .navicon-button {
            background-color: #2a2a2a !important;
        }

        /* Footer */
        footer {
            background-color: #1a1a1a !important;
            color: #9ca3af !important;
            border-top: 1px solid #404040 !important;
            text-align: center !important;
            padding: 20px !important;
        }

        /* Remove horizontal scrollbar and white borders */
        * {
            box-sizing: border-box !important;
        }
    </style>
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">README</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-build-guide.html">Build Guide</a></li><li><a href="tutorial-installation-guide.html">Installation Guide</a></li></ul><h3>Classes</h3><ul><li><a href="module-server_chatbot-ChatBot.html">ChatBot</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot-ChatBot.html#executeCommand">executeCommand</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#findCustomCommand">findCustomCommand</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#generateForecastText">generateForecastText</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#getDefaultChatBotObject">getDefaultChatBotObject</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#handleForecastCommand">handleForecastCommand</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#handleHelpCommand">handleHelpCommand</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#initialize">initialize</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#isCommandAllowedInChannel">isCommandAllowedInChannel</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#isOnCooldown">isOnCooldown</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#mapChatBotObjectToFlatSettings">mapChatBotObjectToFlatSettings</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#mapSettingsToChatBotObject">mapSettingsToChatBotObject</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#processAllianceMessage">processAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#processPrivateMessage">processPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#resolveCommandName">resolveCommandName</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#scheduleDailyForecast">scheduleDailyForecast</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#sendAllianceMessage">sendAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#sendDailyForecast">sendDailyForecast</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#sendErrorMessage">sendErrorMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#sendPrivateMessage">sendPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#sendResponse">sendResponse</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#setupScheduledTasks">setupScheduledTasks</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#updateCooldown">updateCooldown</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#updateSettings">updateSettings</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#validateCommandArguments">validateCommandArguments</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#validateForecastArguments">validateForecastArguments</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-api.html">api</a><ul class='methods'><li data-type='method'><a href="module-api.html#.activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-api.html#.deleteChat">deleteChat</a></li><li data-type='method'><a href="module-api.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-api.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-api.html#.departVessels">departVessels</a></li><li data-type='method'><a href="module-api.html#.doWearMaintenanceBulk">doWearMaintenanceBulk</a></li><li data-type='method'><a href="module-api.html#.fetchAcquirableVessels">fetchAcquirableVessels</a></li><li data-type='method'><a href="module-api.html#.fetchAllianceMembers">fetchAllianceMembers</a></li><li data-type='method'><a href="module-api.html#.fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-api.html#.fetchBunkerPrices">fetchBunkerPrices</a></li><li data-type='method'><a href="module-api.html#.fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-api.html#.fetchChat">fetchChat</a></li><li data-type='method'><a href="module-api.html#.fetchContacts">fetchContacts</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerChats">fetchMessengerChats</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerMessages">fetchMessengerMessages</a></li><li data-type='method'><a href="module-api.html#.fetchUserCompany">fetchUserCompany</a></li><li data-type='method'><a href="module-api.html#.fetchUserSettings">fetchUserSettings</a></li><li data-type='method'><a href="module-api.html#.fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-api.html#.getCompanyNameCached">getCompanyNameCached</a></li><li data-type='method'><a href="module-api.html#.getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-api.html#.markChatAsRead">markChatAsRead</a></li><li data-type='method'><a href="module-api.html#.purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-api.html#.purchaseFuel">purchaseFuel</a></li><li data-type='method'><a href="module-api.html#.purchaseVessel">purchaseVessel</a></li><li data-type='method'><a href="module-api.html#.searchUsers">searchUsers</a></li><li data-type='method'><a href="module-api.html#.sendChatMessage">sendChatMessage</a></li><li data-type='method'><a href="module-api.html#.sendPrivateMessage">sendPrivateMessage</a></li></ul></li><li><a href="module-app.html">app</a></li><li><a href="module-automation.html">automation</a><ul class='methods'><li data-type='method'><a href="module-automation.html#.initAutomation">initAutomation</a></li><li data-type='method'><a href="module-automation.html#.runAutomationChecks">runAutomationChecks</a></li><li data-type='method'><a href="module-automation.html#.triggerAutoRebuyChecks">triggerAutoRebuyChecks</a></li><li data-type='method'><a href="module-automation.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-automation.html#~checkAutoCampaignRenewal">checkAutoCampaignRenewal</a></li><li data-type='method'><a href="module-automation.html#~checkAutoDepartAll">checkAutoDepartAll</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyCO2">checkAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyFuel">checkAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~getTotalCapacity">getTotalCapacity</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyCO2">performAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyFuel">performAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~sendAutoPilotFeedback">sendAutoPilotFeedback</a></li><li data-type='method'><a href="module-automation.html#~showCenterAlert">showCenterAlert</a></li><li data-type='method'><a href="module-automation.html#~updateAutoDepartLabel">updateAutoDepartLabel</a></li></ul></li><li><a href="module-bunker-management.html">bunker-management</a><ul class='methods'><li data-type='method'><a href="module-bunker-management.html#.buyMaxCO2">buyMaxCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.buyMaxFuel">buyMaxFuel</a></li><li data-type='method'><a href="module-bunker-management.html#.getCurrentBunkerState">getCurrentBunkerState</a></li><li data-type='method'><a href="module-bunker-management.html#.setCapacityFromBunkerUpdate">setCapacityFromBunkerUpdate</a></li><li data-type='method'><a href="module-bunker-management.html#.updateBunkerStatus">updateBunkerStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCampaignsStatus">updateCampaignsStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCO2">updateCurrentCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCash">updateCurrentCash</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentFuel">updateCurrentFuel</a></li><li data-type='method'><a href="module-bunker-management.html#~retryFetchPrices">retryFetchPrices</a></li></ul></li><li><a href="module-chat.html">chat</a><ul class='methods'><li data-type='method'><a href="module-chat.html#.displayMessages">displayMessages</a></li><li data-type='method'><a href="module-chat.html#.handleMessageInput">handleMessageInput</a></li><li data-type='method'><a href="module-chat.html#.initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-chat.html#.loadAllianceMembers">loadAllianceMembers</a></li><li data-type='method'><a href="module-chat.html#.loadMessages">loadMessages</a></li><li data-type='method'><a href="module-chat.html#.parseMessageWithMentions">parseMessageWithMentions</a></li><li data-type='method'><a href="module-chat.html#.sendMessage">sendMessage</a></li><li data-type='method'><a href="module-chat.html#.setChatScrollListener">setChatScrollListener</a></li><li data-type='method'><a href="module-chat.html#~attemptReconnect">attemptReconnect</a></li><li data-type='method'><a href="module-chat.html#~displaySuggestions">displaySuggestions</a></li><li data-type='method'><a href="module-chat.html#~formatLocalTime">formatLocalTime</a></li><li data-type='method'><a href="module-chat.html#~handleAnchorUpdate">handleAnchorUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleAutoCoopComplete">handleAutoCoopComplete</a></li><li data-type='method'><a href="module-chat.html#~handleAutoCoopNoTargets">handleAutoCoopNoTargets</a></li><li data-type='method'><a href="module-chat.html#~handleAutopilotDepartStart">handleAutopilotDepartStart</a></li><li data-type='method'><a href="module-chat.html#~handleBackendAutoRepairComplete">handleBackendAutoRepairComplete</a></li><li data-type='method'><a href="module-chat.html#~handleBunkerUpdate">handleBunkerUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleCO2Purchased">handleCO2Purchased</a></li><li data-type='method'><a href="module-chat.html#~handleCampaignStatusUpdate">handleCampaignStatusUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleCampaignsRenewed">handleCampaignsRenewed</a></li><li data-type='method'><a href="module-chat.html#~handleCoopUpdate">handleCoopUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleFuelPurchased">handleFuelPurchased</a></li><li data-type='method'><a href="module-chat.html#~handleGenericNotification">handleGenericNotification</a></li><li data-type='method'><a href="module-chat.html#~handleHeaderDataUpdate">handleHeaderDataUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleHijackingUpdate">handleHijackingUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleMentionAutocomplete">handleMentionAutocomplete</a></li><li data-type='method'><a href="module-chat.html#~handleMessengerUpdate">handleMessengerUpdate</a></li><li data-type='method'><a href="module-chat.html#~handlePriceAlert">handlePriceAlert</a></li><li data-type='method'><a href="module-chat.html#~handlePriceUpdate">handlePriceUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleRepairCountUpdate">handleRepairCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleUnreadMessagesUpdate">handleUnreadMessagesUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleUserActionNotification">handleUserActionNotification</a></li><li data-type='method'><a href="module-chat.html#~handleVesselCountUpdate">handleVesselCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDepartComplete">handleVesselsDepartComplete</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDeparted">handleVesselsDeparted</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsFailed">handleVesselsFailed</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsRepaired">handleVesselsRepaired</a></li><li data-type='method'><a href="module-chat.html#~hideMemberSuggestions">hideMemberSuggestions</a></li><li data-type='method'><a href="module-chat.html#~insertMention">insertMention</a></li><li data-type='method'><a href="module-chat.html#~registerUsernameClickEvents">registerUsernameClickEvents</a></li></ul></li><li><a href="module-coop.html">coop</a><ul class='methods'><li data-type='method'><a href="module-coop.html#.closeCoopOverlay">closeCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.fetchCoopData">fetchCoopData</a></li><li data-type='method'><a href="module-coop.html#.sendCoopMax">sendCoopMax</a></li><li data-type='method'><a href="module-coop.html#.showCoopOverlay">showCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.updateCoopBadge">updateCoopBadge</a></li><li data-type='method'><a href="module-coop.html#~renderMemberCard">renderMemberCard</a></li></ul></li><li><a href="module-desktop-notification-templates.html">desktop-notification-templates</a><ul class='methods'><li data-type='method'><a href="module-desktop-notification-templates.html#.createDesktopNotification">createDesktopNotification</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.getDefaultEmoji">getDefaultEmoji</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.getNotificationTypes">getNotificationTypes</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.isValidNotificationType">isValidNotificationType</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyAlert">notifyAlert</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyError">notifyError</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifySuccess">notifySuccess</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyWarning">notifyWarning</a></li></ul></li><li><a href="module-event-info.html">event-info</a><ul class='methods'><li data-type='method'><a href="module-event-info.html#.initEventInfo">initEventInfo</a></li><li data-type='method'><a href="module-event-info.html#.openEventModal">openEventModal</a></li><li data-type='method'><a href="module-event-info.html#.updateEventData">updateEventData</a></li><li data-type='method'><a href="module-event-info.html#~startEventTimer">startEventTimer</a></li></ul></li><li><a href="module-forecast-calendar.html">forecast-calendar</a><ul class='methods'><li data-type='method'><a href="module-forecast-calendar.html#.initForecastCalendar">initForecastCalendar</a></li><li data-type='method'><a href="module-forecast-calendar.html#.updateEventDiscount">updateEventDiscount</a></li><li data-type='method'><a href="module-forecast-calendar.html#~createTableHTML">createTableHTML</a></li><li data-type='method'><a href="module-forecast-calendar.html#~formatDate">formatDate</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getBrowserTimezone">getBrowserTimezone</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getCo2Class">getCo2Class</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getCurrentVisibleDay">getCurrentVisibleDay</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getFuelClass">getFuelClass</a></li><li data-type='method'><a href="module-forecast-calendar.html#~isEventActiveAtTime">isEventActiveAtTime</a></li><li data-type='method'><a href="module-forecast-calendar.html#~isEventActiveOnDay">isEventActiveOnDay</a></li><li data-type='method'><a href="module-forecast-calendar.html#~loadForecastData">loadForecastData</a></li><li data-type='method'><a href="module-forecast-calendar.html#~preloadMonth">preloadMonth</a></li><li data-type='method'><a href="module-forecast-calendar.html#~renderBook">renderBook</a></li><li data-type='method'><a href="module-forecast-calendar.html#~updateEventBadge">updateEventBadge</a></li></ul></li><li><a href="module-messenger.html">messenger</a><ul class='methods'><li data-type='method'><a href="module-messenger.html#.closeAllChats">closeAllChats</a></li><li data-type='method'><a href="module-messenger.html#.closeChatSelection">closeChatSelection</a></li><li data-type='method'><a href="module-messenger.html#.openMessenger">openMessenger</a></li><li data-type='method'><a href="module-messenger.html#.openNewChat">openNewChat</a></li><li data-type='method'><a href="module-messenger.html#.showAllChats">showAllChats</a></li><li data-type='method'><a href="module-messenger.html#.updateUnreadBadge">updateUnreadBadge</a></li><li data-type='method'><a href="module-messenger.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-messenger.html#~loadPrivateMessages">loadPrivateMessages</a></li><li data-type='method'><a href="module-messenger.html#~startHijackingPolling">startHijackingPolling</a></li><li data-type='method'><a href="module-messenger.html#~stopHijackingPolling">stopHijackingPolling</a></li></ul></li><li><a href="module-public_js_modules_hijacking.html">public/js/modules/hijacking</a><ul class='methods'><li data-type='method'><a href="module-public_js_modules_hijacking.html#.closeHijackingInbox">closeHijackingInbox</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.openHijackingInbox">openHijackingInbox</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.updateHijackedVesselsDisplay">updateHijackedVesselsDisplay</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.updateHijackingBadge">updateHijackingBadge</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~deleteCase">deleteCase</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~openCaseDetails">openCaseDetails</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~refreshHijackingBadge">refreshHijackingBadge</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~renderCaseList">renderCaseList</a></li></ul></li><li><a href="module-server_automation.html">server/automation</a><ul class='methods'><li data-type='method'><a href="module-server_automation.html#~getRandomInterval">getRandomInterval</a></li><li data-type='method'><a href="module-server_automation.html#~initialize">initialize</a></li><li data-type='method'><a href="module-server_automation.html#~loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_automation.html#~parseInterval">parseInterval</a></li><li data-type='method'><a href="module-server_automation.html#~restartAutoRepair">restartAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~runAutoRepair">runAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~scheduleAutoRepair">scheduleAutoRepair</a></li></ul></li><li><a href="module-server_autopilot.html">server/autopilot</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot.html#~acceptRansomWithRetry">acceptRansomWithRetry</a></li><li data-type='method'><a href="module-server_autopilot.html#~analyzeVesselDepartures">analyzeVesselDepartures</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoAnchorPointPurchase">autoAnchorPointPurchase</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoCampaignRenewal">autoCampaignRenewal</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoCoop">autoCoop</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoDepartVessels">autoDepartVessels</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoNegotiateHijacking">autoNegotiateHijacking</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoRebuyAll">autoRebuyAll</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoRebuyCO2">autoRebuyCO2</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoRebuyFuel">autoRebuyFuel</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoRepairVessels">autoRepairVessels</a></li><li data-type='method'><a href="module-server_autopilot.html#~calculatePendingAnchorPoints">calculatePendingAnchorPoints</a></li><li data-type='method'><a href="module-server_autopilot.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-server_autopilot.html#~checkPriceAlerts">checkPriceAlerts</a></li><li data-type='method'><a href="module-server_autopilot.html#~countActiveCampaignTypes">countActiveCampaignTypes</a></li><li data-type='method'><a href="module-server_autopilot.html#~departVessels">departVessels</a></li><li data-type='method'><a href="module-server_autopilot.html#~fetchAllianceDataCached">fetchAllianceDataCached</a></li><li data-type='method'><a href="module-server_autopilot.html#~fetchCoopDataCached">fetchCoopDataCached</a></li><li data-type='method'><a href="module-server_autopilot.html#~getCachedCapacity">getCachedCapacity</a></li><li data-type='method'><a href="module-server_autopilot.html#~getCaseWithRetry">getCaseWithRetry</a></li><li data-type='method'><a href="module-server_autopilot.html#~getTotalCapacity">getTotalCapacity</a></li><li data-type='method'><a href="module-server_autopilot.html#~initializeAutopilotState">initializeAutopilotState</a></li><li data-type='method'><a href="module-server_autopilot.html#~isAutopilotPaused">isAutopilotPaused</a></li><li data-type='method'><a href="module-server_autopilot.html#~mainEventLoop">mainEventLoop</a></li><li data-type='method'><a href="module-server_autopilot.html#~pauseAutopilot">pauseAutopilot</a></li><li data-type='method'><a href="module-server_autopilot.html#~processHijackingCase">processHijackingCase</a></li><li data-type='method'><a href="module-server_autopilot.html#~refreshHijackingBadge">refreshHijackingBadge</a></li><li data-type='method'><a href="module-server_autopilot.html#~resumeAutopilot">resumeAutopilot</a></li><li data-type='method'><a href="module-server_autopilot.html#~setBroadcastFunction">setBroadcastFunction</a></li><li data-type='method'><a href="module-server_autopilot.html#~startMainEventLoop">startMainEventLoop</a></li><li data-type='method'><a href="module-server_autopilot.html#~submitOfferWithRetry">submitOfferWithRetry</a></li><li data-type='method'><a href="module-server_autopilot.html#~tryUpdateAllData">tryUpdateAllData</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateAllData">updateAllData</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateCampaigns">updateCampaigns</a></li><li data-type='method'><a href="module-server_autopilot.html#~updatePrices">updatePrices</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateRepairCount">updateRepairCount</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateUnreadMessages">updateUnreadMessages</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateVesselCount">updateVesselCount</a></li></ul></li><li><a href="module-server_cache.html">server/cache</a><ul class='methods'><li data-type='method'><a href="module-server_cache.html#~clearAllCaches">clearAllCaches</a></li><li data-type='method'><a href="module-server_cache.html#~getAllianceCache">getAllianceCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCampaignCache">getCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCompanyCache">getCompanyCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCoopCache">getCoopCache</a></li><li data-type='method'><a href="module-server_cache.html#~invalidateCampaignCache">invalidateCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~invalidateCoopCache">invalidateCoopCache</a></li><li data-type='method'><a href="module-server_cache.html#~isCacheValid">isCacheValid</a></li><li data-type='method'><a href="module-server_cache.html#~setAllianceCache">setAllianceCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCampaignCache">setCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCompanyCache">setCompanyCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCoopCache">setCoopCache</a></li></ul></li><li><a href="module-server_certificate.html">server/certificate</a><ul class='methods'><li data-type='method'><a href="module-server_certificate.html#~createHttpsServer">createHttpsServer</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCA">generateCA</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCertificate">generateCertificate</a></li><li data-type='method'><a href="module-server_certificate.html#~getNetworkIPs">getNetworkIPs</a></li><li data-type='method'><a href="module-server_certificate.html#~isCertificateInstalled">isCertificateInstalled</a></li><li data-type='method'><a href="module-server_certificate.html#~loadCertificate">loadCertificate</a></li></ul></li><li><a href="module-server_chatbot.html">server/chatbot</a></li><li><a href="module-server_config.html">server/config</a><ul class='methods'><li data-type='method'><a href="module-server_config.html#~getAppDataDir">getAppDataDir</a></li><li data-type='method'><a href="module-server_config.html#~getLocalAppDataDir">getLocalAppDataDir</a></li><li data-type='method'><a href="module-server_config.html#~getLogDir">getLogDir</a></li><li data-type='method'><a href="module-server_config.html#~getSessionCookie">getSessionCookie</a></li><li data-type='method'><a href="module-server_config.html#~getSettingsDir">getSettingsDir</a></li><li data-type='method'><a href="module-server_config.html#~loadStartupSettings">loadStartupSettings</a></li><li data-type='method'><a href="module-server_config.html#~setSessionCookie">setSessionCookie</a></li></ul></li><li><a href="module-server_gameapi.html">server/gameapi</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi.html#~activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-server_gameapi.html#~bulkRepairVessels">bulkRepairVessels</a></li><li data-type='method'><a href="module-server_gameapi.html#~departVessel">departVessel</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchAutoPrice">fetchAutoPrice</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchBunkerState">fetchBunkerState</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchEventData">fetchEventData</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchPrices">fetchPrices</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchRepairCount">fetchRepairCount</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchUnreadMessages">fetchUnreadMessages</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-server_gameapi.html#~getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-server_gameapi.html#~purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-server_gameapi.html#~purchaseFuel">purchaseFuel</a></li></ul></li><li><a href="module-server_middleware_index.html">server/middleware/index</a><ul class='methods'><li data-type='method'><a href="module-server_middleware_index.html#~setupMiddleware">setupMiddleware</a></li></ul></li><li><a href="module-server_routes_alliance.html">server/routes/alliance</a><ul class='methods'><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-members">GET /api/alliance-members</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/chat">GET /api/chat</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/company-name">POST /api/company-name</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/send-message">POST /api/send-message</a></li></ul></li><li><a href="module-server_routes_anchor.html">server/routes/anchor</a></li><li><a href="module-server_routes_coop.html">server/routes/coop</a><ul class='methods'><li data-type='method'><a href="module-server_routes_coop.html#.GET/api/coop/data">GET /api/coop/data</a></li><li data-type='method'><a href="module-server_routes_coop.html#.POST/api/coop/send-max">POST /api/coop/send-max</a></li></ul></li><li><a href="module-server_routes_forecast.html">server/routes/forecast</a><ul class='methods'><li data-type='method'><a href="module-server_routes_forecast.html#~convertCESTToTimezone">convertCESTToTimezone</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~generateChatbotText">generateChatbotText</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~generateMetadata">generateMetadata</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getForecastDataPath">getForecastDataPath</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getNextDayData">getNextDayData</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getPreviousDayData">getPreviousDayData</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getServerLocalTimezone">getServerLocalTimezone</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getTimezoneOffsetHours">getTimezoneOffsetHours</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getValidTimezones">getValidTimezones</a></li></ul></li><li><a href="module-server_routes_game.html">server/routes/game</a></li><li><a href="module-server_routes_health.html">server/routes/health</a></li><li><a href="module-server_routes_messenger.html">server/routes/messenger</a><ul class='methods'><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/contact/get-contacts">GET /api/contact/get-contacts</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/hijacking/get-cases">GET /api/hijacking/get-cases</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/messenger/get-chats">GET /api/messenger/get-chats</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/delete-chat">POST /api/messenger/delete-chat</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/get-messages">POST /api/messenger/get-messages</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/send-private">POST /api/messenger/send-private</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/user/search">POST /api/user/search</a></li><li data-type='method'><a href="module-server_routes_messenger.html#~migrateHijackHistory">migrateHijackHistory</a></li></ul></li><li><a href="module-server_routes_settings.html">server/routes/settings</a><ul class='methods'><li data-type='method'><a href="module-server_routes_settings.html#.GET/api/settings">GET /api/settings</a></li><li data-type='method'><a href="module-server_routes_settings.html#.POST/api/settings">POST /api/settings</a></li></ul></li><li><a href="module-server_scheduler.html">server/scheduler</a><ul class='methods'><li data-type='method'><a href="module-server_scheduler.html#~initScheduler">initScheduler</a></li><li data-type='method'><a href="module-server_scheduler.html#~isServerReady">isServerReady</a></li></ul></li><li><a href="module-server_settings-schema.html">server/settings-schema</a><ul class='methods'><li data-type='method'><a href="module-server_settings-schema.html#~getDefault">getDefault</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getDefaults">getDefaults</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getRequiredKeys">getRequiredKeys</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getSettingsFilePath">getSettingsFilePath</a></li><li data-type='method'><a href="module-server_settings-schema.html#~initializeSettings">initializeSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~saveSettings">saveSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~validateSettings">validateSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~validateValue">validateValue</a></li></ul></li><li><a href="module-server_state.html">server/state</a><ul class='methods'><li data-type='method'><a href="module-server_state.html#~getAutopilotState">getAutopilotState</a></li><li data-type='method'><a href="module-server_state.html#~getBunkerState">getBunkerState</a></li><li data-type='method'><a href="module-server_state.html#~getCampaignStatus">getCampaignStatus</a></li><li data-type='method'><a href="module-server_state.html#~getCoopData">getCoopData</a></li><li data-type='method'><a href="module-server_state.html#~getEventData">getEventData</a></li><li data-type='method'><a href="module-server_state.html#~getHeaderData">getHeaderData</a></li><li data-type='method'><a href="module-server_state.html#~getLastCO2Alert">getLastCO2Alert</a></li><li data-type='method'><a href="module-server_state.html#~getLastFuelAlert">getLastFuelAlert</a></li><li data-type='method'><a href="module-server_state.html#~getPrices">getPrices</a></li><li data-type='method'><a href="module-server_state.html#~getRepairCount">getRepairCount</a></li><li data-type='method'><a href="module-server_state.html#~getSettings">getSettings</a></li><li data-type='method'><a href="module-server_state.html#~getUserState">getUserState</a></li><li data-type='method'><a href="module-server_state.html#~getVesselCounts">getVesselCounts</a></li><li data-type='method'><a href="module-server_state.html#~isAutopilotPaused">isAutopilotPaused</a></li><li data-type='method'><a href="module-server_state.html#~setAutopilotPaused">setAutopilotPaused</a></li><li data-type='method'><a href="module-server_state.html#~setAutopilotState">setAutopilotState</a></li><li data-type='method'><a href="module-server_state.html#~setLastCO2Alert">setLastCO2Alert</a></li><li data-type='method'><a href="module-server_state.html#~setLastFuelAlert">setLastFuelAlert</a></li><li data-type='method'><a href="module-server_state.html#~updateBunkerState">updateBunkerState</a></li><li data-type='method'><a href="module-server_state.html#~updateCampaignStatus">updateCampaignStatus</a></li><li data-type='method'><a href="module-server_state.html#~updateCoopData">updateCoopData</a></li><li data-type='method'><a href="module-server_state.html#~updateEventData">updateEventData</a></li><li data-type='method'><a href="module-server_state.html#~updateHeaderData">updateHeaderData</a></li><li data-type='method'><a href="module-server_state.html#~updatePrices">updatePrices</a></li><li data-type='method'><a href="module-server_state.html#~updateRepairCount">updateRepairCount</a></li><li data-type='method'><a href="module-server_state.html#~updateSettings">updateSettings</a></li><li data-type='method'><a href="module-server_state.html#~updateVesselCounts">updateVesselCounts</a></li></ul></li><li><a href="module-server_utils_api.html">server/utils/api</a><ul class='methods'><li data-type='method'><a href="module-server_utils_api.html#~apiCall">apiCall</a></li><li data-type='method'><a href="module-server_utils_api.html#~apiCallWithRetry">apiCallWithRetry</a></li><li data-type='method'><a href="module-server_utils_api.html#~getAllianceId">getAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~getChatFeed">getChatFeed</a></li><li data-type='method'><a href="module-server_utils_api.html#~getCompanyName">getCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserCompanyName">getUserCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserId">getUserId</a></li><li data-type='method'><a href="module-server_utils_api.html#~initializeAlliance">initializeAlliance</a></li><li data-type='method'><a href="module-server_utils_api.html#~sleep">sleep</a></li></ul></li><li><a href="module-server_utils_encryption.html">server/utils/encryption</a><ul class='methods'><li data-type='method'><a href="module-server_utils_encryption.html#~decryptData">decryptData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~deleteEncryptedData">deleteEncryptedData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~encryptData">encryptData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~getEncryptionInfo">getEncryptionInfo</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~getMachineKey">getMachineKey</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~isEncrypted">isEncrypted</a></li></ul></li><li><a href="module-server_utils_logger.html">server/utils/logger</a><ul class='methods'><li data-type='method'><a href="module-server_utils_logger.html#~debug">debug</a></li><li data-type='method'><a href="module-server_utils_logger.html#~error">error</a></li><li data-type='method'><a href="module-server_utils_logger.html#~isDebugMode">isDebugMode</a></li><li data-type='method'><a href="module-server_utils_logger.html#~loadLogLevel">loadLogLevel</a></li><li data-type='method'><a href="module-server_utils_logger.html#~log">log</a></li><li data-type='method'><a href="module-server_utils_logger.html#~warn">warn</a></li></ul></li><li><a href="module-server_utils_session-manager.html">server/utils/session-manager</a><ul class='methods'><li data-type='method'><a href="module-server_utils_session-manager.html#~deleteSession">deleteSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getAllUserIds">getAllUserIds</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getAvailableSessions">getAvailableSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getSession">getSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getSessionsPath">getSessionsPath</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~hasSession">hasSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~loadAllSessions">loadAllSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~loadSessions">loadSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~migrateToEncrypted">migrateToEncrypted</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~saveSession">saveSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~saveSessions">saveSessions</a></li></ul></li><li><a href="module-server_websocket.html">server/websocket</a><ul class='methods'><li data-type='method'><a href="module-server_websocket.html#~broadcast">broadcast</a></li><li data-type='method'><a href="module-server_websocket.html#~broadcastBunkerUpdate">broadcastBunkerUpdate</a></li><li data-type='method'><a href="module-server_websocket.html#~broadcastToUser">broadcastToUser</a></li><li data-type='method'><a href="module-server_websocket.html#~getCachedHijackingCase">getCachedHijackingCase</a></li><li data-type='method'><a href="module-server_websocket.html#~getCachedMessengerChats">getCachedMessengerChats</a></li><li data-type='method'><a href="module-server_websocket.html#~getProcessedMessageIds">getProcessedMessageIds</a></li><li data-type='method'><a href="module-server_websocket.html#~getProcessedMessagesCachePath">getProcessedMessagesCachePath</a></li><li data-type='method'><a href="module-server_websocket.html#~initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-server_websocket.html#~loadProcessedMessageCache">loadProcessedMessageCache</a></li><li data-type='method'><a href="module-server_websocket.html#~performChatRefresh">performChatRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~performHijackingRefresh">performHijackingRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~performMessengerRefresh">performMessengerRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~saveProcessedMessageCache">saveProcessedMessageCache</a></li><li data-type='method'><a href="module-server_websocket.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~startHijackingAutoRefresh">startHijackingAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~startMessengerAutoRefresh">startMessengerAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopChatAutoRefresh">stopChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopHijackingAutoRefresh">stopHijackingAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopMessengerAutoRefresh">stopMessengerAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~triggerImmediateChatRefresh">triggerImmediateChatRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~triggerImmediateHijackingRefresh">triggerImmediateHijackingRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~triggerImmediateMessengerRefresh">triggerImmediateMessengerRefresh</a></li></ul></li><li><a href="module-ui-dialogs.html">ui-dialogs</a><ul class='methods'><li data-type='method'><a href="module-ui-dialogs.html#.buyCampaign">buyCampaign</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeCampaignsOverlay">closeCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeSettings">closeSettings</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showCampaignsOverlay">showCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showConfirmDialog">showConfirmDialog</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showContactList">showContactList</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showSettings">showSettings</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#.escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-utils.html#.formatNumber">formatNumber</a></li><li data-type='method'><a href="module-utils.html#.registerServiceWorker">registerServiceWorker</a></li><li data-type='method'><a href="module-utils.html#.renderStars">renderStars</a></li><li data-type='method'><a href="module-utils.html#.requestNotificationPermission">requestNotificationPermission</a></li><li data-type='method'><a href="module-utils.html#.showNotification">showNotification</a></li><li data-type='method'><a href="module-utils.html#.showSideNotification">showSideNotification</a></li></ul></li><li><a href="module-vessel-management.html">vessel-management</a><ul class='methods'><li data-type='method'><a href="module-vessel-management.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.purchaseSingleVessel">purchaseSingleVessel</a></li><li data-type='method'><a href="module-vessel-management.html#.updateVesselCount">updateVesselCount</a></li><li data-type='method'><a href="module-vessel-management.html#~createVesselCard">createVesselCard</a></li><li data-type='method'><a href="module-vessel-management.html#~displayFilteredVessels">displayFilteredVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~getAvailableAnchorSlots">getAvailableAnchorSlots</a></li><li data-type='method'><a href="module-vessel-management.html#~getCO2EfficiencyClass">getCO2EfficiencyClass</a></li><li data-type='method'><a href="module-vessel-management.html#~getCapacityDisplay">getCapacityDisplay</a></li><li data-type='method'><a href="module-vessel-management.html#~getFuelEfficiencyClass">getFuelEfficiencyClass</a></li><li data-type='method'><a href="module-vessel-management.html#~loadMorePendingVessels">loadMorePendingVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~loadMoreVessels">loadMoreVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~populateDynamicFilters">populateDynamicFilters</a></li><li data-type='method'><a href="module-vessel-management.html#~preloadCommonVesselImages">preloadCommonVesselImages</a></li><li data-type='method'><a href="module-vessel-management.html#~preloadVesselImage">preloadVesselImage</a></li><li data-type='method'><a href="module-vessel-management.html#~refreshVesselCardsIfVisible">refreshVesselCardsIfVisible</a></li><li data-type='method'><a href="module-vessel-management.html#~showBulkRepairDialog">showBulkRepairDialog</a></li><li data-type='method'><a href="module-vessel-management.html#~updateCapacityDropdowns">updateCapacityDropdowns</a></li><li data-type='method'><a href="module-vessel-management.html#~vesselPassesFilters">vesselPassesFilters</a></li></ul></li><li><a href="module-vessel-selling.html">vessel-selling</a><ul class='methods'><li data-type='method'><a href="module-vessel-selling.html#.bulkSellVessels">bulkSellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#.closeSellVesselsOverlay">closeSellVesselsOverlay</a></li><li data-type='method'><a href="module-vessel-selling.html#.openSellVesselsOverlay">openSellVesselsOverlay</a></li><li data-type='method'><a href="module-vessel-selling.html#.setSellFilter">setSellFilter</a></li><li data-type='method'><a href="module-vessel-selling.html#.showSellCart">showSellCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~addVesselsToCart">addVesselsToCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~displaySellVessels">displaySellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#~getCO2EfficiencyClass">getCO2EfficiencyClass</a></li><li data-type='method'><a href="module-vessel-selling.html#~getCapacityDisplay">getCapacityDisplay</a></li><li data-type='method'><a href="module-vessel-selling.html#~getFuelEfficiencyClass">getFuelEfficiencyClass</a></li><li data-type='method'><a href="module-vessel-selling.html#~groupVesselsByModel">groupVesselsByModel</a></li><li data-type='method'><a href="module-vessel-selling.html#~loadUserVesselsForSale">loadUserVesselsForSale</a></li><li data-type='method'><a href="module-vessel-selling.html#~removeVesselSelectionFromCart">removeVesselSelectionFromCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~sellVessels">sellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#~toggleVesselSelection">toggleVesselSelection</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateBulkSellButton">updateBulkSellButton</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateSelectButtonState">updateSelectButtonState</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateVesselSelectionInCart">updateVesselSelectionInCart</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#buildNav">buildNav</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#lockBulkBuyButton">lockBulkBuyButton</a></li><li><a href="global.html#lockCo2Button">lockCo2Button</a></li><li><a href="global.html#lockCoopButtons">lockCoopButtons</a></li><li><a href="global.html#lockDepartButton">lockDepartButton</a></li><li><a href="global.html#lockFuelButton">lockFuelButton</a></li><li><a href="global.html#lockRepairButton">lockRepairButton</a></li><li><a href="global.html#publish">publish</a></li><li><a href="global.html#showAnchorTimer">showAnchorTimer</a></li><li><a href="global.html#unlockBulkBuyButton">unlockBulkBuyButton</a></li><li><a href="global.html#unlockCo2Button">unlockCo2Button</a></li><li><a href="global.html#unlockCoopButtons">unlockCoopButtons</a></li><li><a href="global.html#unlockDepartButton">unlockDepartButton</a></li><li><a href="global.html#unlockFuelButton">unlockFuelButton</a></li><li><a href="global.html#unlockRepairButton">unlockRepairButton</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">server/gameapi.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Game API Client
 *
 * Centralized module for all API calls to the Shipping Manager game server.
 * Provides clean interface for autopilot features to interact with game API.
 *
 * All functions use the apiCall helper from utils/api which handles:
 * - Session cookie authentication
 * - Connection pooling (Keep-Alive)
 * - Error handling
 * - Request timeouts
 *
 * Used exclusively by server/autopilot.js for automated actions.
 * Manual user actions still use routes in server/routes/game.js
 *
 * @module server/gameapi
 */

const { apiCall, getUserId } = require('./utils/api');
const config = require('./config');
const path = require('path');
const os = require('os');
const fs = require('fs');
const logger = require('./utils/logger');
const cache = require('./cache');

// Debug mode - controlled by server/config.js
const DEBUG_MODE = config.DEBUG_MODE;

// Harbor fee bug logs directory - use APPDATA when running as .exe
const { getAppDataDir } = require('./config');
const HARBOR_FEE_BUG_DIR = process.pkg
  ? path.join(getAppDataDir(), 'ShippingManagerCoPilot', 'userdata', 'logs', 'harborfeebug')
  : path.join(__dirname, '..', 'userdata', 'logs', 'harborfeebug');

// Known harbor fee bugs file (for game developers)
const HARBOR_BUGS_FILE = process.pkg
  ? path.join(getAppDataDir(), 'ShippingManagerCoPilot', 'userdata', 'logs', 'known-harbor-fee-bugs.json')
  : path.join(__dirname, '..', 'userdata', 'logs', 'known-harbor-fee-bugs.json');

// Bunker price bug logs directory
const BUNKER_PRICE_BUG_DIR = process.pkg
  ? path.join(getAppDataDir(), 'ShippingManagerCoPilot', 'userdata', 'logs', 'bunkerpricebug')
  : path.join(__dirname, '..', 'userdata', 'logs', 'bunkerpricebug');

// Known bunker price bugs file (for game developers)
const BUNKER_PRICE_BUGS_FILE = process.pkg
  ? path.join(getAppDataDir(), 'ShippingManagerCoPilot', 'userdata', 'logs', 'known-bunker-price-bugs.json')
  : path.join(__dirname, '..', 'userdata', 'logs', 'known-bunker-price-bugs.json');

/**
 * Fetches current market prices for fuel and CO2.
 * Called by scheduler at :01 and :31 every hour.
 *
 * IMPORTANT API QUIRKS:
 * - Game updates prices at :01 and :31 past the hour (server local time)
 * - Prices are in $/ton
 * - Response includes ALL 48 price intervals for current day
 * - Current price must be matched by time slot (HH:00 or HH:30)
 * - Time slots use LOCAL server time, NOT UTC
 *
 * Why This Timing Matters:
 * - Scheduler calls at :02 and :32 to ensure fresh prices are available
 * - Calling at :00 or :30 risks getting stale prices (race condition)
 * - 29-minute purchase window at each price point
 *
 * @async
 * @returns {Promise&lt;{fuel: number, co2: number}>} Current prices in $/ton
 * @throws {Error} If API returns malformed data or network error
 */
async function fetchPrices() {
  const data = await apiCall('/bunker/get-prices', 'POST', {});

  // API returns array of prices with timestamps
  // Structure: { data: { prices: [{fuel_price, co2_price, time, day}, ...] }, user: {...} }

  if (!data.data || !data.data.prices || data.data.prices.length === 0) {
    throw new Error('No prices found in API response');
  }

  const prices = data.data.prices;

  // Get current LOCAL time to find matching price (prices are in server's local time)
  const now = new Date();
  const localHours = now.getHours(); // Local hours, not UTC
  const localMinutes = now.getMinutes();
  const currentTime = `${String(localHours).padStart(2, '0')}:${localMinutes &lt; 30 ? '00' : '30'}`;

  // Find price matching current time slot
  let currentPrice = prices.find(p => p.time === currentTime);

  // Check for event discounts
  const eventFuelDiscount = data.data.event_fuel_discount || null;
  const eventCO2Discount = data.data.event_co2_discount || null;
  const discountedFuel = data.data.discounted_fuel || null;
  const discountedCO2 = data.data.discounted_co2 || null;

  // Build eventDiscount object for compatibility
  let eventDiscount = null;
  if (eventFuelDiscount &amp;&amp; discountedFuel) {
    eventDiscount = { percentage: eventFuelDiscount, type: 'fuel' };
  } else if (eventCO2Discount &amp;&amp; discountedCO2) {
    eventDiscount = { percentage: eventCO2Discount, type: 'co2' };
  }

  // Track missing timeslot bugs (if no exact match and no discounted prices)
  if (!currentPrice &amp;&amp; (discountedFuel === null || discountedCO2 === null)) {
    // Load known bugs list
    let knownBugs = {
      description: "Known timeslots where API doesn't return price data. Collected for game developers.",
      bugs: {}
    };
    try {
      if (fs.existsSync(BUNKER_PRICE_BUGS_FILE)) {
        knownBugs = JSON.parse(fs.readFileSync(BUNKER_PRICE_BUGS_FILE, 'utf8'));
      }
    } catch (err) {
      logger.debug(`[GameAPI] Failed to load known price bugs file: ${err.message}`);
    }

    // Check if this timeslot is already known
    const isKnownBug = knownBugs.bugs[currentTime] !== undefined;

    if (!isKnownBug) {
      // NEW BUG - Log full details and save to file
      logger.error(`[GameAPI] MISSING TIMESLOT detected (NEW)!`);
      logger.error(`  Requested timeslot: ${currentTime}`);
      logger.error(`  Available timeslots: ${prices.map(p => p.time).join(', ')}`);
      logger.error(`  Has discounted prices: fuel=${discountedFuel}, co2=${discountedCO2}`);

      // Save full raw response to file for game developers
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
      const filename = `price-response-${currentTime.replace(':', '-')}-${timestamp}.json`;
      const filepath = path.join(BUNKER_PRICE_BUG_DIR, filename);

      try {
        // Ensure bunker price bug directory exists
        fs.mkdirSync(BUNKER_PRICE_BUG_DIR, { recursive: true });
        fs.writeFileSync(filepath, JSON.stringify(data, null, 2));
        logger.error(`  Raw API response saved to: ${filepath}`);
      } catch (err) {
        logger.error(`  Failed to save response file: ${err.message}`);
      }

      // Add to known bugs list
      knownBugs.bugs[currentTime] = {
        first_seen: new Date().toISOString(),
        last_seen: new Date().toISOString(),
        occurrence_count: 1,
        has_discounted_prices: discountedFuel !== null &amp;&amp; discountedCO2 !== null,
        response_file: filepath
      };

      try {
        fs.writeFileSync(BUNKER_PRICE_BUGS_FILE, JSON.stringify(knownBugs, null, 2));
        logger.error(`  Timeslot ${currentTime} added to known bugs list`);
      } catch (err) {
        logger.error(`  Failed to update known bugs file: ${err.message}`);
      }
    } else {
      // Known bug - update occurrence count and last_seen
      knownBugs.bugs[currentTime].last_seen = new Date().toISOString();
      knownBugs.bugs[currentTime].occurrence_count++;

      try {
        fs.writeFileSync(BUNKER_PRICE_BUGS_FILE, JSON.stringify(knownBugs, null, 2));
      } catch (err) {
        // Ignore write errors for known bugs
      }

      logger.debug(`[GameAPI] Missing timeslot at known buggy time: ${currentTime} (occurrence #${knownBugs.bugs[currentTime].occurrence_count})`);
    }

    // Use last price in array as fallback
    currentPrice = prices[prices.length - 1];
    if (DEBUG_MODE) {
      logger.log(`[GameAPI] No exact time match for ${currentTime}, using last price from ${currentPrice.time}`);
    }
  }

  // Use discounted prices if available
  const finalFuelPrice = discountedFuel !== null ? discountedFuel : currentPrice.fuel_price;
  const finalCO2Price = discountedCO2 !== null ? discountedCO2 : currentPrice.co2_price;

  // CRITICAL VALIDATION: If API returns invalid prices (0, null, undefined), throw error
  // This prevents broadcasting invalid prices to clients
  if (!finalFuelPrice || finalFuelPrice &lt;= 0) {
    logger.error(`[GameAPI]  API returned INVALID fuel price: ${finalFuelPrice} (discounted: ${discountedFuel}, regular: ${currentPrice.fuel_price})`);
    throw new Error(`Invalid fuel price from API: ${finalFuelPrice}`);
  }
  if (!finalCO2Price || finalCO2Price &lt;= 0) {
    logger.error(`[GameAPI]  API returned INVALID CO2 price: ${finalCO2Price} (discounted: ${discountedCO2}, regular: ${currentPrice.co2_price})`);
    throw new Error(`Invalid CO2 price from API: ${finalCO2Price}`);
  }

  if (DEBUG_MODE) {
    if (eventDiscount) {
      logger.log(`[GameAPI] EVENT ACTIVE: ${eventDiscount.percentage}% off ${eventDiscount.type}`);
      logger.log(`[GameAPI] Current prices (${currentPrice.time}): Fuel=$${finalFuelPrice}/t${discountedFuel ? ` (was $${currentPrice.fuel_price})` : ''}, CO2=$${finalCO2Price}/t${discountedCO2 ? ` (was $${currentPrice.co2_price})` : ''}`);
    } else {
      logger.log(`[GameAPI] Current prices (${currentPrice.time}): Fuel=$${finalFuelPrice}/t, CO2=$${finalCO2Price}/t`);
    }
  }

  // Fetch full event data if there's an active event
  let eventData = null;
  if (eventDiscount) {
    try {
      eventData = await fetchEventData();
    } catch (error) {
      logger.warn('[GameAPI] Failed to fetch event data:', error.message);
    }
  }

  return {
    fuel: finalFuelPrice,
    co2: finalCO2Price,
    eventDiscount: eventDiscount,
    eventData: eventData, // Full event with time_start, time_end, etc.
    regularFuel: currentPrice.fuel_price,
    regularCO2: currentPrice.co2_price
  };
}

/**
 * Fetches current bunker state (fuel, CO2, cash, capacity).
 * Used by auto-rebuy to check if purchase is needed.
 *
 * CRITICAL API QUIRK:
 * - /bunker/get-prices does NOT return capacity fields (max_fuel, max_co2)
 * - Must use /game/index endpoint which includes user_settings.max_fuel/.max_co2
 * - This is why we can't use /bunker/get-prices for bunker state
 *
 * Unit Conversions:
 * - API stores values in kilograms (kg)
 * - We convert to tons (t) for readability: 1t = 1000kg
 * - All internal logic uses tons, only API calls use kg
 *
 * @async
 * @returns {Promise&lt;Object>} Bunker state with fuel, co2, cash, maxFuel, maxCO2 (all in tons except cash)
 * @throws {Error} If user_settings or capacity fields missing
 */
async function fetchBunkerState() {
  const data = await apiCall('/game/index', 'POST', {});
  const user = data.user;
  const settings = data.data.user_settings;

  if (!settings || !settings.max_fuel || !settings.max_co2) {
    logger.error('[GameAPI] ERROR: user_settings or capacity fields missing from API response!');
    throw new Error('user_settings or capacity fields missing from API');
  }

  const bunkerState = {
    fuel: user.fuel / 1000, // Convert kg to tons
    co2: user.co2 / 1000,
    cash: user.cash,
    points: user.points || 0,
    maxFuel: settings.max_fuel / 1000,
    maxCO2: settings.max_co2 / 1000
  };

  if (DEBUG_MODE) {
    logger.log(`[GameAPI] Bunker state: Fuel=${bunkerState.fuel.toFixed(1)}t/${bunkerState.maxFuel.toFixed(0)}t, CO2=${bunkerState.co2.toFixed(1)}t/${bunkerState.maxCO2.toFixed(0)}t, Cash=$${bunkerState.cash}, Points=${bunkerState.points}`);
  }

  return bunkerState;
}

/**
 * Purchases specified amount of fuel.
 * Used by auto-rebuy feature.
 *
 * API Quirks:
 * - API expects amount in kilograms (kg), not tons
 * - This function accepts tons and converts to kg internally (amount * 1000)
 * - Response does NOT include updated capacity fields (max_fuel, max_co2)
 * - Response does NOT include purchase cost - we calculate it ourselves
 * - Purchase is INSTANT (no delay/cooldown in game API)
 *
 * Why Unit Conversion:
 * - Game UI displays tons (more readable: "500t" vs "500000kg")
 * - API internally uses kg for precision
 * - Conversion factor: 1 ton = 1000 kg (always integer math)
 *
 * @async
 * @param {number} amount - Amount in tons (integer)
 * @param {number|null} [pricePerTon=null] - Optional price override, fetches from state if null
 * @returns {Promise&lt;Object>} Purchase result: {success, amount, newTotal, cost}
 * @throws {Error} If API call fails
 */
async function purchaseFuel(amount, pricePerTon = null, userId = null) {
  // API expects amount in kg, we work in tons - convert tons to kg
  const amountInKg = amount * 1000;

  if (DEBUG_MODE) {
    logger.log(`[GameAPI] purchaseFuel REQUEST: Sending ${amount}t (${amountInKg}kg) to API`);
    logger.log(`[GameAPI] purchaseFuel REQUEST body:`, JSON.stringify({ amount: amountInKg }, null, 2));
  }

  const data = await apiCall('/bunker/purchase-fuel', 'POST', { amount: amountInKg });

  if (DEBUG_MODE) {
    logger.log(`[GameAPI] purchaseFuel RESPONSE:`, JSON.stringify(data, null, 2));
  }

  // Check if purchase was successful
  if (data.error || data.success === false) {
    const errorMsg = data.error || 'Purchase failed';
    if (data.user &amp;&amp; data.user.cash !== undefined) {
      logger.log(`[GameAPI] Purchase FAILED with error "${errorMsg}" - API reports current cash: $${data.user.cash.toLocaleString()}`);
    }
    throw new Error(errorMsg);
  }

  // Calculate cost ourselves since API doesn't return it
  // If price not provided, get it from state
  let cost = 0;
  if (pricePerTon) {
    cost = amount * pricePerTon;
  } else {
    const state = require('./state');
    const actualUserId = userId || getUserId();
    const prices = state.getPrices(actualUserId);
    cost = amount * prices.fuel;
  }

  const result = {
    success: true,
    amount: amount, // Return amount in tons
    newTotal: data.user.fuel / 1000, // kg to tons
    cost: cost
  };
  if (DEBUG_MODE) {
    logger.log(`[GameAPI] Purchased ${amount}t fuel for $${result.cost}, new total: ${result.newTotal.toFixed(1)}t`);
  }
  return result;
}

/**
 * Purchases specified amount of CO2 certificates.
 * Used by auto-rebuy feature.
 *
 * API Quirks:
 * - Same quirks as purchaseFuel (see above)
 * - API field name is 'co2' OR 'co2_certificate' depending on endpoint
 * - Always check both fields: data.user.co2 || data.user.co2_certificate
 *
 * @async
 * @param {number} amount - Amount in tons (integer)
 * @param {number|null} [pricePerTon=null] - Optional price override, fetches from state if null
 * @returns {Promise&lt;Object>} Purchase result: {success, amount, newTotal, cost}
 * @throws {Error} If API call fails
 */
async function purchaseCO2(amount, pricePerTon = null, userId = null) {
  // API expects amount in kg, we work in tons - convert tons to kg
  const amountInKg = amount * 1000;
  const data = await apiCall('/bunker/purchase-co2', 'POST', { amount: amountInKg });

  if (DEBUG_MODE) {
    logger.log(`[GameAPI] purchaseCO2 API response:`, JSON.stringify(data, null, 2));
  }

  // Check if purchase was successful
  if (data.error || data.success === false) {
    throw new Error(data.error || 'Purchase failed');
  }

  // Calculate cost ourselves since API doesn't return it
  // If price not provided, get it from state
  let cost = 0;
  if (pricePerTon) {
    cost = amount * pricePerTon;
  } else {
    const state = require('./state');
    const actualUserId = userId || getUserId();
    const prices = state.getPrices(actualUserId);
    cost = amount * prices.co2;
  }

  const result = {
    success: true,
    amount: amount, // Return amount in tons
    newTotal: (data.user.co2 || data.user.co2_certificate) / 1000, // kg to tons
    cost: cost
  };
  if (DEBUG_MODE) {
    logger.log(`[GameAPI] Purchased ${amount}t CO2 for $${result.cost}, new total: ${result.newTotal.toFixed(1)}t`);
  }
  return result;
}

/**
 * Fetches all vessels currently in harbor.
 * Used by auto-depart to determine which vessels to send.
 *
 * Returns:
 * - Only vessels with status 'in_harbor' or 'ready'
 * - Includes vessel specs, assigned routes, cargo capacity, wear level
 * - Does NOT include historical voyage data (use /vessel/get-vessel-history)
 *
 * @async
 * @returns {Promise&lt;Array&lt;Object>>} Array of vessel objects
 * @throws {Error} If API call fails
 */
async function fetchVessels() {
  const data = await apiCall('/game/index', 'POST', {});
  return data.data.user_vessels || [];
}

/**
 * Departs a single vessel on its assigned route.
 * Used by intelligent auto-depart feature.
 *
 * CRITICAL API BEHAVIORS:
 * - Vessel must have assigned route (route_id) and valid price-per-TEU (> 0)
 * - API returns income BEFORE harbor fees (must calculate netIncome ourselves)
 * - Negative netIncome is possible if harbor fees > income (full port scenario)
 * - API error "Vessel not found or status invalid" = vessel already departed (race condition)
 *
 * Error Handling Strategy:
 * - Always pass through ACTUAL error message from API (don't mask it)
 * - "Vessel not found" is OK during auto-depart (vessel departed between checks)
 * - Negative netIncome triggers debug logging + saves raw API response to file
 *
 * Parameters:
 * - speed: Vessel's cruising speed in knots (from vessel specs)
 * - guards: 0 or 10 (game mechanic for piracy protection)
 * - history: Always 0 (don't add to history - undocumented API parameter)
 *
 * @async
 * @param {number} vesselId - User vessel ID
 * @param {number} speed - Travel speed in knots
 * @param {number} [guards=0] - Number of guards (0 or 10)
 * @returns {Promise&lt;Object>} Departure result: {success, vesselId, income, netIncome, fuelUsed, ...}
 * @throws {Error} Only on network/critical failures (not on game logic errors)
 */
async function departVessel(vesselId, speed, guards = 0) {
  const data = await apiCall('/route/depart', 'POST', {
    user_vessel_id: vesselId,
    speed: speed,
    guards: guards,
    history: 0
  });

  // Check if API returned an error
  if (!data.data || !data.data.depart_info) {
    // IMPORTANT: Always pass through the ACTUAL error message from the API
    const actualError = data.error || 'Unknown error';
    const actualMessage = data.message || actualError;

    if (DEBUG_MODE) {
      logger.log(`[GameAPI] Depart failed for vessel ${vesselId} - Error: "${actualError}"`);
    }

    // Special case: Vessel already departed (race condition)
    if (actualError === 'Vessel not found or status invalid') {
      if (DEBUG_MODE) {
        logger.log(`[GameAPI] Vessel ${vesselId} was already departed (race condition - ignoring)`);
      }
    }

    return {
      success: false,
      vesselId: vesselId,
      error: actualError,
      errorMessage: actualError,  // Pass through the ACTUAL error
      apiResponse: data
    };
  }

  const departInfo = data.data.depart_info;
  const vesselData = data.data.user_vessels?.[0];

  const netIncome = departInfo.depart_income - departInfo.harbor_fee;

  // Track negative netIncome bugs (known game bug with incorrect harbor fees)
  if (netIncome &lt; 0) {
    const destination = vesselData?.route_destination || 'UNKNOWN';

    // Load known bugs list
    let knownBugs = { description: "Known harbors with harbor fee calculation bugs. Collected for game developers.", bugs: {} };
    try {
      if (fs.existsSync(HARBOR_BUGS_FILE)) {
        knownBugs = JSON.parse(fs.readFileSync(HARBOR_BUGS_FILE, 'utf8'));
      }
    } catch (err) {
      logger.debug(`[gameapi.departVessel] Failed to load known bugs file: ${err.message}`);
    }

    // Check if this harbor is already known
    const isKnownBug = knownBugs.bugs[destination] !== undefined;

    if (!isKnownBug) {
      // NEW BUG - Log full details and save to file
      logger.error(`[gameapi.departVessel] NEGATIVE netIncome detected (NEW HARBOR)!`);
      logger.error(`  Vessel: ${vesselData?.name} (ID: ${vesselId})`);
      logger.error(`  Destination: ${destination}`);
      logger.error(`  Income: $${departInfo.depart_income}`);
      logger.error(`  Harbor Fee: $${departInfo.harbor_fee}`);
      logger.error(`  Net Income: $${netIncome}`);

      // Save full raw response to file for game developers
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
      const filename = `depart-response-${vesselData?.name || vesselId}-${timestamp}.json`;
      const filepath = path.join(HARBOR_FEE_BUG_DIR, filename);

      try {
        // Ensure harbor fee bug directory exists
        fs.mkdirSync(HARBOR_FEE_BUG_DIR, { recursive: true });
        fs.writeFileSync(filepath, JSON.stringify(data, null, 2));
        logger.error(`  Raw API response saved to: ${filepath}`);
      } catch (err) {
        logger.error(`  Failed to save response file: ${err.message}`);
      }

      // Add to known bugs list
      knownBugs.bugs[destination] = {
        first_seen: new Date().toISOString(),
        vessel_name: vesselData?.name,
        vessel_id: vesselId,
        income: departInfo.depart_income,
        harbor_fee: departInfo.harbor_fee,
        net_income: netIncome,
        response_file: filepath
      };

      try {
        fs.writeFileSync(HARBOR_BUGS_FILE, JSON.stringify(knownBugs, null, 2));
        logger.error(`  Harbor ${destination} added to known bugs list`);
      } catch (err) {
        logger.error(`  Failed to update known bugs file: ${err.message}`);
      }
    } else {
      // Known bug - just debug log
      logger.debug(`[gameapi.departVessel] Negative netIncome at known buggy harbor: ${destination} (Income: $${departInfo.depart_income}, Fee: $${departInfo.harbor_fee}, Net: $${netIncome})`);
    }
  }

  return {
    success: true,
    vesselId: vesselId,
    vesselName: vesselData?.name,
    destination: vesselData?.route_destination,
    income: departInfo.depart_income,
    harborFee: departInfo.harbor_fee,
    netIncome: netIncome,
    fuelUsed: departInfo.fuel_usage / 1000, // kg to tons
    co2Used: departInfo.co2_emission / 1000, // kg to tons,
    speed: speed,
    guards: guards
  };
}

/**
 * Fetches demand and consumed data for all assigned ports.
 * Used by intelligent auto-depart to calculate remaining port capacity.
 *
 * @returns {Promise&lt;Array>} Array of port objects with demand/consumed data
 */
async function fetchAssignedPorts() {
  const data = await apiCall('/port/get-assigned-ports', 'POST', {});
  return data.data.ports || [];
}

/**
 * Fetches available marketing campaigns and active campaign status.
 * Uses cache to avoid duplicate API calls (campaigns change rarely).
 * Used by auto-campaign-renewal feature.
 *
 * @returns {Promise&lt;Object>} Campaigns data with available and active campaigns
 */
async function fetchCampaigns() {
  try {
    // Check cache first
    const cached = cache.getCampaignCache();
    if (cached) {
      const available = cached.data.marketing_campaigns || [];
      const active = cached.data.active_campaigns || [];

      if (DEBUG_MODE) {
        logger.log(`[GameAPI] Campaigns from cache - Active: ${active.length}, Available: ${available.length}`);
      }

      return {
        available: available,
        active: active
      };
    }

    // Cache miss - fetch from API
    const data = await apiCall('/marketing-campaign/get-marketing', 'POST', {});

    // Store in cache
    cache.setCampaignCache(data);

    const available = data.data.marketing_campaigns || [];
    const active = data.data.active_campaigns || [];

    if (DEBUG_MODE) {
      logger.log(`[GameAPI] Fetched campaigns from API - Active: ${active.length}, Available: ${available.length}`);
    }

    return {
      available: available,
      active: active
    };
  } catch (error) {
    logger.error('[GameAPI] Error fetching campaigns:', error.message);
    return {
      available: [],
      active: []
    };
  }
}

/**
 * Activates a marketing campaign by ID.
 * Used by auto-campaign-renewal feature.
 *
 * @param {number} campaignId - Campaign ID to activate
 * @returns {Promise&lt;Object>} Activation result
 */
async function activateCampaign(campaignId) {
  const data = await apiCall('/marketing-campaign/activate-marketing-campaign', 'POST', {
    campaign_id: campaignId
  });

  // Invalidate campaign cache after activation
  cache.invalidateCampaignCache();

  return {
    success: true,
    campaignId: campaignId
  };
}

/**
 * Calculates maintenance cost for specified vessels.
 * Used by auto-repair feature to check total cost before executing repairs.
 *
 * CRITICAL API QUIRK:
 * - API expects vessel_ids as JSON STRING: "[123,456,789]"
 * - NOT as array: [123,456,789]
 * - Must call JSON.stringify(vesselIds) before sending
 * - This is inconsistent with other endpoints (they accept arrays)
 *
 * Response Structure:
 * - Returns array of vessels with maintenance_data
 * - Each vessel has maintenance_data array with type: 'wear', 'drydock', etc.
 * - API does NOT provide total_cost field - must calculate ourselves
 * - Calculate: sum all vessel.maintenance_data.find(m => m.type === 'wear').price
 *
 * @async
 * @param {Array&lt;number>} vesselIds - Array of vessel IDs
 * @returns {Promise&lt;Object>} {totalCost, vessels} - Calculated total and vessel details
 * @throws {Error} If API call fails
 */
async function getMaintenanceCost(vesselIds) {
  if (DEBUG_MODE) {
    logger.log(`[GameAPI] Requesting maintenance cost for vessel IDs: [${vesselIds.join(', ')}]`);
  }

  // Frontend sends: JSON.stringify({ vessel_ids: JSON.stringify(vesselIds) })
  // Which results in: { vessel_ids: "[17696320,17696321]" }
  // So we need to send the array as a JSON string
  const vesselIdsString = JSON.stringify(vesselIds);
  if (DEBUG_MODE) {
    logger.log(`[GameAPI] Sending vessel_ids as JSON string: ${vesselIdsString}`);
  }

  try {
    const data = await apiCall('/maintenance/get', 'POST', { vessel_ids: vesselIdsString });

    if (data.error) {
      logger.error(`[GameAPI] API Error: ${data.error}`);
      return { totalCost: 0, vessels: [] };
    }

    const vessels = data.data?.vessels || [];

    // Calculate total cost from individual vessel maintenance_data (API doesn't provide total_cost)
    let totalCost = 0;
    vessels.forEach(vessel => {
      const wearMaintenance = vessel.maintenance_data?.find(m => m.type === 'wear');
      if (wearMaintenance) {
        totalCost += wearMaintenance.price || 0;
      }
    });

    if (DEBUG_MODE) {
      logger.log(`[GameAPI] Calculated total maintenance cost: $${totalCost} for ${vesselIds.length} vessels`);
    }
    return {
      totalCost: totalCost,
      vessels: vessels
    };
  } catch (error) {
    logger.error(`[GameAPI] getMaintenanceCost failed:`, error.message);
    throw error;
  }
}

/**
 * Performs bulk wear maintenance on multiple vessels.
 * Used by auto-repair feature to repair all vessels at once.
 *
 * API Quirks:
 * - Same JSON string requirement as getMaintenanceCost (see above)
 * - Must send: vessel_ids: JSON.stringify([123,456,789])
 * - API DOES return total_cost field (unlike getMaintenanceCost)
 * - Repairs execute instantly (no animation/delay in game)
 * - All repairs succeed or all fail (atomic operation)
 *
 * @async
 * @param {Array&lt;number>} vesselIds - Array of vessel IDs to repair
 * @returns {Promise&lt;Object>} {success, count, totalCost} - Repair result
 * @throws {Error} If API call fails
 */
async function bulkRepairVessels(vesselIds) {
  if (DEBUG_MODE) {
    logger.log(`[GameAPI] Executing bulk repair for vessel IDs: [${vesselIds.join(', ')}]`);
  }

  // Frontend sends vessel_ids as JSON string: "[17696320,17696321]"
  const vesselIdsString = JSON.stringify(vesselIds);
  if (DEBUG_MODE) {
    logger.log(`[GameAPI] Sending vessel_ids as JSON string: ${vesselIdsString}`);
  }

  const data = await apiCall('/maintenance/do-wear-maintenance-bulk', 'POST', {
    vessel_ids: vesselIdsString
  });

  if (data.error) {
    logger.error(`[GameAPI] Bulk repair API Error: ${data.error}`);
    return { success: false, count: 0, totalCost: 0 };
  }

  const totalCost = data.data?.total_cost || 0;
  if (DEBUG_MODE) {
    logger.log(`[GameAPI] Repaired ${vesselIds.length} vessels - API returned cost: $${totalCost}`);
  }

  return {
    success: true,
    count: vesselIds.length,
    totalCost: totalCost
  };
}

/**
 * Fetches count of vessels needing repair.
 * Used by scheduler to update repair badge.
 *
 * @returns {Promise&lt;number>} Count of vessels with wear > 0
 */
async function fetchRepairCount() {
  const data = await apiCall('/game/index', 'POST', {});
  const vessels = data.data.user_vessels || [];
  return vessels.filter(v => v.wear > 0).length;
}

/**
 * Fetches unread private message count.
 * Used by scheduler to update messages badge.
 *
 * @returns {Promise&lt;number>} Count of unread messages
 */
async function fetchUnreadMessages() {
  try {
    // Use shared cache from websocket.js to reduce duplicate API calls
    const { getCachedMessengerChats } = require('./websocket');
    const chats = await getCachedMessengerChats();

    if (DEBUG_MODE) {
      // Debug: Log all chats with their properties
      logger.log(`[GameAPI] Total chats: ${chats.length}`);
      chats.forEach((chat, i) => {
        logger.log(`[GameAPI] Chat ${i}: system_chat=${chat.system_chat}, new=${chat.new}, subject="${chat.subject || 'N/A'}"`);
      });
    }

    // Count ALL chats where new=true (including system messages like hijack notifications)
    const unreadCount = chats.filter(chat => chat.new).length;
    if (DEBUG_MODE) {
      logger.log(`[GameAPI] Unread messages count (including system): ${unreadCount}`);
    }
    return unreadCount;
  } catch (error) {
    logger.error('[GameAPI] Error fetching unread messages:', error.message);
    return 0;
  }
}

/**
 * Fetches auto-calculated price for a route.
 * Used to check if price-per-TEU is 0 before departure.
 *
 * @param {number} userVesselId - User's vessel ID
 * @param {number} routeId - Route ID
 * @returns {Promise&lt;Object>} Auto-price response with suggested pricing
 */
async function fetchAutoPrice(userVesselId, routeId) {
  try {
    const data = await apiCall('/demand/auto-price', 'POST', {
      user_vessel_id: userVesselId,
      route_id: routeId
    });

    if (DEBUG_MODE) {
      logger.log(`[GameAPI] Auto-price for vessel ${userVesselId} on route ${routeId}:`, data);
    }

    return data;
  } catch (error) {
    logger.error(`[GameAPI] Error fetching auto-price for vessel ${userVesselId}:`, error.message);
    throw error;
  }
}

/**
 * Fetches active event data from game.
 * Used by scheduler to broadcast complete event information to frontend.
 *
 * Event Structure:
 * - id: Event ID
 * - type: Event type (e.g., "demand_and_discount")
 * - capacity_type: Container or tanker
 * - name: Event name identifier
 * - daily_demand_multiplier: Demand boost (e.g., 50x)
 * - ports: JSON string of port codes (must be parsed)
 * - discount_type: Resource type ("fuel" or "co2")
 * - discount_percentage: Discount amount (e.g., 20)
 * - time_start, time_end, ends_in: Event timing info
 * - header_key, subheader_key, description_key: Localization keys
 *
 * @async
 * @returns {Promise&lt;Object|null>} Event object or null if no active event
 * @throws {Error} If API call fails
 */
async function fetchEventData() {
  const data = await apiCall('/game/index', 'POST', {});

  if (!data.data || !data.data.event || data.data.event.length === 0) {
    if (DEBUG_MODE) {
      logger.log('[GameAPI] No active events');
    }
    return null;
  }

  const event = data.data.event[0];

  if (DEBUG_MODE) {
    logger.log(`[GameAPI] Active event: ${event.name} (${event.type})`);
    logger.log(`[GameAPI] Discount: ${event.discount_percentage}% off ${event.discount_type}`);
    logger.log(`[GameAPI] Demand multiplier: ${event.daily_demand_multiplier}x`);
    logger.log(`[GameAPI] Ends in: ${Math.floor(event.ends_in / 3600)}h ${Math.floor((event.ends_in % 3600) / 60)}m`);
  }

  return event;
}

module.exports = {
  fetchPrices,
  fetchBunkerState,
  purchaseFuel,
  purchaseCO2,
  fetchVessels,
  departVessel,
  fetchAssignedPorts,
  fetchCampaigns,
  activateCampaign,
  getMaintenanceCost,
  bulkRepairVessels,
  fetchRepairCount,
  fetchUnreadMessages,
  fetchAutoPrice,
  fetchEventData
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation Version: 0.0.7 - ShippingManager CoPilot
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
