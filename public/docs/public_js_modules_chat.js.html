<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>public/js/modules/chat.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Dark theme matching app style - carefully scoped to not break layout */
        html, body {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
            overflow-x: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Custom scrollbar styling for all browsers */
        * {
            scrollbar-width: thin !important;
            scrollbar-color: #404040 #1a1a1a !important;
        }

        /* Webkit browsers (Chrome, Safari, Edge) */
        *::-webkit-scrollbar {
            width: 6px !important;
            height: 6px !important;
        }

        *::-webkit-scrollbar-track {
            background: #1a1a1a !important;
        }

        *::-webkit-scrollbar-thumb {
            background-color: #404040 !important;
            border-radius: 3px !important;
        }

        *::-webkit-scrollbar-thumb:hover {
            background-color: #505050 !important;
        }

        /* Navigation sidebar - remove padding and white borders */
        nav {
            background-color: #242424 !important;
            border-right: 1px solid #404040 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow-x: hidden !important;
        }
        nav h2, nav h3 {
            color: #e0e0e0 !important;
            border-bottom: 1px solid #404040 !important;
            padding: 10px 15px !important;
            margin: 0 !important;
            background-color: #242424 !important;
            font-size: 14px !important;
            font-weight: 600 !important;
        }
        nav h3 {
            font-size: 13px !important;
        }
        nav ul {
            padding: 0 !important;
            margin: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li {
            list-style: none !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li a {
            color: #c9d1d9 !important;
            display: block !important;
            padding: 8px 15px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            background-color: #242424 !important;
            margin: 0 !important;
            border: none !important;
            font-size: 14px !important;
        }
        nav ul li a:hover {
            color: #60a5fa !important;
            background-color: rgba(96, 165, 250, 0.1) !important;
        }
        /* Module links (direct children of nav > ul > li) */
        nav > ul > li > a {
            color: #60a5fa !important;
            font-weight: 600 !important;
            padding: 10px 15px !important;
            font-size: 14px !important;
            border-left: 3px solid #60a5fa !important;
            padding-left: 12px !important;
        }
        nav > ul > li > a:hover {
            background-color: rgba(96, 165, 250, 0.15) !important;
        }
        /* Sub-items (methods/functions) indented */
        nav ul.methods {
            padding-left: 15px !important;
        }
        nav ul.methods li a {
            color: #9ca3af !important;
            font-size: 13px !important;
            padding: 6px 15px !important;
            font-weight: 400 !important;
        }
        nav ul.methods li a:hover {
            color: #c9d1d9 !important;
        }
        nav > h2:first-child {
            font-size: 16px !important;
            font-weight: 700 !important;
            padding: 12px 15px !important;
        }

        /* Main content area - dark background */
        #main {
            background-color: #1a1a1a !important;
            padding: 20px !important;
        }

        /* Article and sections - ensure dark background */
        article, section, .container-overview, .description {
            background-color: #1a1a1a !important;
        }

        /* Images - style demo images */
        img {
            max-width: 100% !important;
            height: auto !important;
            border: 1px solid #404040 !important;
            border-radius: 8px !important;
            margin: 20px 0 !important;
        }

        /* Links */
        a {
            color: #60a5fa !important;
            text-decoration: none !important;
        }
        a:hover {
            color: #93c5fd !important;
            text-decoration: underline !important;
        }

        /* Headings */
        h1, h2, h3, h4, h5, h6 {
            color: #e0e0e0 !important;
            border-bottom-color: #404040 !important;
            background-color: transparent !important;
        }
        h4.name {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
        }

        /* Code blocks */
        pre {
            background-color: #0d1117 !important;
            border: 1px solid #404040 !important;
        }
        pre code {
            background-color: transparent !important;
        }
        code {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
        }

        /* Tables */
        table {
            border-color: #404040 !important;
            background-color: #1a1a1a !important;
        }
        table thead tr {
            background-color: #242424 !important;
        }
        table tbody tr {
            background-color: #1a1a1a !important;
        }
        table tbody tr:nth-child(even) {
            background-color: #1f1f1f !important;
        }
        table td, table th {
            border-color: #404040 !important;
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }
        .params .name, .props .name {
            color: #10b981 !important;
            font-family: 'Courier New', monospace !important;
        }

        /* Descriptions and details */
        .description, .details, dt, dd, p, ul, ol, dl {
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }

        /* Types */
        .type-signature {
            color: #a78bfa !important;
        }

        /* Source links */
        .details .details-item-container {
            border-left-color: #404040 !important;
        }

        /* Breadcrumbs */
        .page-title {
            color: #e0e0e0 !important;
        }

        /* Search */
        #nav-search {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
            color: #e0e0e0 !important;
        }

        /* Mobile nav trigger */
        .navicon-button {
            background-color: #2a2a2a !important;
        }

        /* Footer */
        footer {
            background-color: #1a1a1a !important;
            color: #9ca3af !important;
            border-top: 1px solid #404040 !important;
            text-align: center !important;
            padding: 20px !important;
        }

        /* Remove horizontal scrollbar and white borders */
        * {
            box-sizing: border-box !important;
        }
    </style>
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">README</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-build-guide.html">Build Guide</a></li><li><a href="tutorial-installation-guide.html">Installation Guide</a></li></ul><h3>Classes</h3><ul><li><a href="module-server_chatbot-ChatBot.html">ChatBot</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot-ChatBot.html#initialize">initialize</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#processAllianceMessage">processAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#processPrivateMessage">processPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#setupScheduledTasks">setupScheduledTasks</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#updateSettings">updateSettings</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-api.html">api</a><ul class='methods'><li data-type='method'><a href="module-api.html#.activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-api.html#.deleteAllLogs">deleteAllLogs</a></li><li data-type='method'><a href="module-api.html#.deleteChat">deleteChat</a></li><li data-type='method'><a href="module-api.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-api.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-api.html#.departVessels">departVessels</a></li><li data-type='method'><a href="module-api.html#.doWearMaintenanceBulk">doWearMaintenanceBulk</a></li><li data-type='method'><a href="module-api.html#.downloadLogbookExport">downloadLogbookExport</a></li><li data-type='method'><a href="module-api.html#.fetchAcquirableVessels">fetchAcquirableVessels</a></li><li data-type='method'><a href="module-api.html#.fetchAllianceMembers">fetchAllianceMembers</a></li><li data-type='method'><a href="module-api.html#.fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-api.html#.fetchBunkerPrices">fetchBunkerPrices</a></li><li data-type='method'><a href="module-api.html#.fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-api.html#.fetchChat">fetchChat</a></li><li data-type='method'><a href="module-api.html#.fetchContacts">fetchContacts</a></li><li data-type='method'><a href="module-api.html#.fetchLogbookEntries">fetchLogbookEntries</a></li><li data-type='method'><a href="module-api.html#.fetchLogbookFileSize">fetchLogbookFileSize</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerChats">fetchMessengerChats</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerMessages">fetchMessengerMessages</a></li><li data-type='method'><a href="module-api.html#.fetchUserCompany">fetchUserCompany</a></li><li data-type='method'><a href="module-api.html#.fetchUserSettings">fetchUserSettings</a></li><li data-type='method'><a href="module-api.html#.fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-api.html#.getCompanyNameCached">getCompanyNameCached</a></li><li data-type='method'><a href="module-api.html#.getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-api.html#.markChatAsRead">markChatAsRead</a></li><li data-type='method'><a href="module-api.html#.purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-api.html#.purchaseFuel">purchaseFuel</a></li><li data-type='method'><a href="module-api.html#.purchaseVessel">purchaseVessel</a></li><li data-type='method'><a href="module-api.html#.searchUsers">searchUsers</a></li><li data-type='method'><a href="module-api.html#.sendChatMessage">sendChatMessage</a></li><li data-type='method'><a href="module-api.html#.sendPrivateMessage">sendPrivateMessage</a></li></ul></li><li><a href="module-app.html">app</a></li><li><a href="module-automation.html">automation</a><ul class='methods'><li data-type='method'><a href="module-automation.html#.initAutomation">initAutomation</a></li><li data-type='method'><a href="module-automation.html#.runAutomationChecks">runAutomationChecks</a></li><li data-type='method'><a href="module-automation.html#.triggerAutoRebuyChecks">triggerAutoRebuyChecks</a></li><li data-type='method'><a href="module-automation.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-automation.html#~checkAutoCampaignRenewal">checkAutoCampaignRenewal</a></li><li data-type='method'><a href="module-automation.html#~checkAutoDepartAll">checkAutoDepartAll</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyCO2">checkAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyFuel">checkAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~getTotalCapacity">getTotalCapacity</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyCO2">performAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyFuel">performAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~updateAutoDepartLabel">updateAutoDepartLabel</a></li></ul></li><li><a href="module-badge-manager.html">badge-manager</a><ul class='methods'><li data-type='method'><a href="module-badge-manager.html#.getBadgeCount">getBadgeCount</a></li><li data-type='method'><a href="module-badge-manager.html#.hideBadge">hideBadge</a></li><li data-type='method'><a href="module-badge-manager.html#.showBadge">showBadge</a></li><li data-type='method'><a href="module-badge-manager.html#.updateBadge">updateBadge</a></li><li data-type='method'><a href="module-badge-manager.html#.updateButtonState">updateButtonState</a></li><li data-type='method'><a href="module-badge-manager.html#.updateButtonTooltip">updateButtonTooltip</a></li><li data-type='method'><a href="module-badge-manager.html#.updateButtonVisibility">updateButtonVisibility</a></li></ul></li><li><a href="module-bunker-management.html">bunker-management</a><ul class='methods'><li data-type='method'><a href="module-bunker-management.html#.buyMaxCO2">buyMaxCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.buyMaxFuel">buyMaxFuel</a></li><li data-type='method'><a href="module-bunker-management.html#.getCurrentBunkerState">getCurrentBunkerState</a></li><li data-type='method'><a href="module-bunker-management.html#.setCapacityFromBunkerUpdate">setCapacityFromBunkerUpdate</a></li><li data-type='method'><a href="module-bunker-management.html#.updateBunkerStatus">updateBunkerStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCO2">updateCurrentCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCash">updateCurrentCash</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentFuel">updateCurrentFuel</a></li></ul></li><li><a href="module-chat.html">chat</a><ul class='methods'><li data-type='method'><a href="module-chat.html#.displayMessages">displayMessages</a></li><li data-type='method'><a href="module-chat.html#.handleMessageInput">handleMessageInput</a></li><li data-type='method'><a href="module-chat.html#.initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-chat.html#.loadAllianceMembers">loadAllianceMembers</a></li><li data-type='method'><a href="module-chat.html#.loadMessages">loadMessages</a></li><li data-type='method'><a href="module-chat.html#.markAllianceChatAsRead">markAllianceChatAsRead</a></li><li data-type='method'><a href="module-chat.html#.parseMessageWithMentions">parseMessageWithMentions</a></li><li data-type='method'><a href="module-chat.html#.sendMessage">sendMessage</a></li><li data-type='method'><a href="module-chat.html#.setChatScrollListener">setChatScrollListener</a></li><li data-type='method'><a href="module-chat.html#~attemptReconnect">attemptReconnect</a></li><li data-type='method'><a href="module-chat.html#~displaySuggestions">displaySuggestions</a></li><li data-type='method'><a href="module-chat.html#~formatLocalTime">formatLocalTime</a></li><li data-type='method'><a href="module-chat.html#~handleAutoCoopComplete">handleAutoCoopComplete</a></li><li data-type='method'><a href="module-chat.html#~handleAutoCoopNoTargets">handleAutoCoopNoTargets</a></li><li data-type='method'><a href="module-chat.html#~handleAutopilotDepartStart">handleAutopilotDepartStart</a></li><li data-type='method'><a href="module-chat.html#~handleBackendAutoRepairComplete">handleBackendAutoRepairComplete</a></li><li data-type='method'><a href="module-chat.html#~handleBunkerUpdate">handleBunkerUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleCO2Purchased">handleCO2Purchased</a></li><li data-type='method'><a href="module-chat.html#~handleCampaignsRenewed">handleCampaignsRenewed</a></li><li data-type='method'><a href="module-chat.html#~handleCompanyTypeUpdate">handleCompanyTypeUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleCoopUpdate">handleCoopUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleDrydockCountUpdate">handleDrydockCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleFuelPurchased">handleFuelPurchased</a></li><li data-type='method'><a href="module-chat.html#~handleGenericNotification">handleGenericNotification</a></li><li data-type='method'><a href="module-chat.html#~handleHarborMapRefreshRequired">handleHarborMapRefreshRequired</a></li><li data-type='method'><a href="module-chat.html#~handleHeaderDataUpdate">handleHeaderDataUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleHijackingUpdate">handleHijackingUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleMentionAutocomplete">handleMentionAutocomplete</a></li><li data-type='method'><a href="module-chat.html#~handleMessengerUpdate">handleMessengerUpdate</a></li><li data-type='method'><a href="module-chat.html#~handlePriceAlert">handlePriceAlert</a></li><li data-type='method'><a href="module-chat.html#~handlePriceUpdate">handlePriceUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleRepairCountUpdate">handleRepairCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleUnreadMessagesUpdate">handleUnreadMessagesUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleUserActionNotification">handleUserActionNotification</a></li><li data-type='method'><a href="module-chat.html#~handleVesselCountUpdate">handleVesselCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDepartBatch">handleVesselsDepartBatch</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDepartComplete">handleVesselsDepartComplete</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDeparted">handleVesselsDeparted</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDrydocked">handleVesselsDrydocked</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsFailed">handleVesselsFailed</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsRepaired">handleVesselsRepaired</a></li><li data-type='method'><a href="module-chat.html#~hideMemberSuggestions">hideMemberSuggestions</a></li><li data-type='method'><a href="module-chat.html#~insertMention">insertMention</a></li><li data-type='method'><a href="module-chat.html#~registerUsernameClickEvents">registerUsernameClickEvents</a></li><li data-type='method'><a href="module-chat.html#~updateAllianceChatBadge">updateAllianceChatBadge</a></li></ul></li><li><a href="module-coop.html">coop</a><ul class='methods'><li data-type='method'><a href="module-coop.html#.closeCoopOverlay">closeCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.fetchCoopData">fetchCoopData</a></li><li data-type='method'><a href="module-coop.html#.sendCoopMax">sendCoopMax</a></li><li data-type='method'><a href="module-coop.html#.showCoopOverlay">showCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.updateCoopBadge">updateCoopBadge</a></li><li data-type='method'><a href="module-coop.html#~renderMemberCard">renderMemberCard</a></li></ul></li><li><a href="module-desktop-notification-templates.html">desktop-notification-templates</a><ul class='methods'><li data-type='method'><a href="module-desktop-notification-templates.html#.createDesktopNotification">createDesktopNotification</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.getDefaultEmoji">getDefaultEmoji</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.getNotificationTypes">getNotificationTypes</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.isValidNotificationType">isValidNotificationType</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyAlert">notifyAlert</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyError">notifyError</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifySuccess">notifySuccess</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyWarning">notifyWarning</a></li></ul></li><li><a href="module-event-info.html">event-info</a><ul class='methods'><li data-type='method'><a href="module-event-info.html#.initEventInfo">initEventInfo</a></li><li data-type='method'><a href="module-event-info.html#.openEventModal">openEventModal</a></li><li data-type='method'><a href="module-event-info.html#.updateEventData">updateEventData</a></li><li data-type='method'><a href="module-event-info.html#~startEventTimer">startEventTimer</a></li></ul></li><li><a href="module-forecast-calendar.html">forecast-calendar</a><ul class='methods'><li data-type='method'><a href="module-forecast-calendar.html#.initForecastCalendar">initForecastCalendar</a></li><li data-type='method'><a href="module-forecast-calendar.html#.updateEventDiscount">updateEventDiscount</a></li><li data-type='method'><a href="module-forecast-calendar.html#~createTableHTML">createTableHTML</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getBrowserTimezone">getBrowserTimezone</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getCo2Class">getCo2Class</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getCurrentVisibleDay">getCurrentVisibleDay</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getFuelClass">getFuelClass</a></li><li data-type='method'><a href="module-forecast-calendar.html#~isEventActiveAtTime">isEventActiveAtTime</a></li><li data-type='method'><a href="module-forecast-calendar.html#~isEventActiveOnDay">isEventActiveOnDay</a></li><li data-type='method'><a href="module-forecast-calendar.html#~loadForecastData">loadForecastData</a></li><li data-type='method'><a href="module-forecast-calendar.html#~preloadMonth">preloadMonth</a></li><li data-type='method'><a href="module-forecast-calendar.html#~renderBook">renderBook</a></li><li data-type='method'><a href="module-forecast-calendar.html#~updateEventBadge">updateEventBadge</a></li></ul></li><li><a href="module-harbor-map-aggregator.html">harbor-map-aggregator</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-aggregator.html#~aggregateReachablePorts">aggregateReachablePorts</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~aggregateVesselData">aggregateVesselData</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~categorizeVesselsByPort">categorizeVesselsByPort</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~extractPortsFromGameIndex">extractPortsFromGameIndex</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~extractVesselsFromGameIndex">extractVesselsFromGameIndex</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~filterAssignedPorts">filterAssignedPorts</a></li></ul></li><li><a href="module-harbor-map-calculator.html">harbor-map-calculator</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateCargoUtilization">calculateCargoUtilization</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateDemandLevel">calculateDemandLevel</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateETA">calculateETA</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateVesselPosition">calculateVesselPosition</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~formatCargoCapacity">formatCargoCapacity</a></li></ul></li><li><a href="module-harbor-map-init.html">harbor-map-init</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-init.html#.closeHarborMap">closeHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.initHarborMap">initHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.openHarborMap">openHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.preloadHarborMapData">preloadHarborMapData</a></li><li data-type='method'><a href="module-harbor-map-init.html#.refreshHarborMapIfOpen">refreshHarborMapIfOpen</a></li><li data-type='method'><a href="module-harbor-map-init.html#.reloadMap">reloadMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.startHarborMapAutoUpdate">startHarborMapAutoUpdate</a></li><li data-type='method'><a href="module-harbor-map-init.html#.stopHarborMapAutoUpdate">stopHarborMapAutoUpdate</a></li><li data-type='method'><a href="module-harbor-map-init.html#~departVesselWrapper">departVesselWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~getVesselByIdWrapper">getVesselByIdWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~selectVesselFromMap">selectVesselFromMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#~sellVesselFromPanelWrapper">sellVesselFromPanelWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~updateVesselMarkerWrapper">updateVesselMarkerWrapper</a></li></ul></li><li><a href="module-harbor-map_api-client.html">harbor-map/api-client</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_api-client.html#.clearHarborMapCache">clearHarborMapCache</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.exportVesselHistory">exportVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchHarborMapOverview">fetchHarborMapOverview</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchPortDetails">fetchPortDetails</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchVesselHistory">fetchVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchVesselReachablePorts">fetchVesselReachablePorts</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.getCachedOverview">getCachedOverview</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.invalidateOverviewCache">invalidateOverviewCache</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.prefetchHarborMapData">prefetchHarborMapData</a></li></ul></li><li><a href="module-harbor-map_filters.html">harbor-map/filters</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_filters.html#.filterPorts">filterPorts</a></li><li data-type='method'><a href="module-harbor-map_filters.html#.filterVessels">filterVessels</a></li><li data-type='method'><a href="module-harbor-map_filters.html#.getPortFilterOptions">getPortFilterOptions</a></li><li data-type='method'><a href="module-harbor-map_filters.html#.getVesselFilterOptions">getVesselFilterOptions</a></li><li data-type='method'><a href="module-harbor-map_filters.html#~calculateVesselUtilization">calculateVesselUtilization</a></li></ul></li><li><a href="module-harbor-map_map-controller.html">harbor-map/map-controller</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_map-controller.html#.clearRoute">clearRoute</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.closeAllPanels">closeAllPanels</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.deselectAll">deselectAll</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.drawRoute">drawRoute</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getCurrentPorts">getCurrentPorts</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getMap">getMap</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getSelectedPortCode">getSelectedPortCode</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getVesselById">getVesselById</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.initMap">initMap</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.loadOverview">loadOverview</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.renderPorts">renderPorts</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.renderVessels">renderVessels</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.selectPort">selectPort</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.selectVessel">selectVessel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.setPortFilter">setPortFilter</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.setVesselFilter">setVesselFilter</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.updateVesselMarker">updateVesselMarker</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.updateWeatherDataSetting">updateWeatherDataSetting</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~addCustomControls">addCustomControls</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~applyFiltersAndRender">applyFiltersAndRender</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~applyMapTheme">applyMapTheme</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~calculateHeading">calculateHeading</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~categorizeVesselsByPortClientSide">categorizeVesselsByPortClientSide</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~changeTileLayer">changeTileLayer</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~createVesselIcon">createVesselIcon</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~getVesselType">getVesselType</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~hideRouteVesselsPanel">hideRouteVesselsPanel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~setRouteFilter">setRouteFilter</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~showRouteVesselsPanel">showRouteVesselsPanel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~showWeatherInfo">showWeatherInfo</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~toggleWeatherLayer">toggleWeatherLayer</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~updateRouteDropdown">updateRouteDropdown</a></li></ul></li><li><a href="module-harbor-map_panel-drag.html">harbor-map/panel-drag</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_panel-drag.html#.initializePanelDrag">initializePanelDrag</a></li></ul></li><li><a href="module-harbor-map_port-panel.html">harbor-map/port-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_port-panel.html#.closePortPanel">closePortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.hidePortPanel">hidePortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.selectVesselFromPort">selectVesselFromPort</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.showPortPanel">showPortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#~loadPortWeather">loadPortWeather</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#~renderDemandSection">renderDemandSection</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#~renderVesselList">renderVesselList</a></li></ul></li><li><a href="module-harbor-map_route-vessels-panel.html">harbor-map/route-vessels-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.closeRoutePanel">closeRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.hideRoutePanel">hideRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.selectRouteVessel">selectRouteVessel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.showRoutePanel">showRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#~storeVessels">storeVessels</a></li></ul></li><li><a href="module-harbor-map_vessel-panel.html">harbor-map/vessel-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.closeVesselPanel">closeVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.exportHistoryFormat">exportHistoryFormat</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.hideVesselPanel">hideVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.sellVesselFromPanel">sellVesselFromPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.showVesselPanel">showVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.startRenameVessel">startRenameVessel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.toggleExportMenu">toggleExportMenu</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~cancelVesselRename">cancelVesselRename</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~closeExportMenuOnClickOutside">closeExportMenuOnClickOutside</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~getCountryFlag">getCountryFlag</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~getPortCountryCode">getPortCountryCode</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~loadVesselHistory">loadVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~loadVesselWeather">loadVesselWeather</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~openRepairDialog">openRepairDialog</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~renderHistoryPage">renderHistoryPage</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~saveVesselRename">saveVesselRename</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~setupInfiniteScroll">setupInfiniteScroll</a></li></ul></li><li><a href="module-logbook.html">logbook</a><ul class='methods'><li data-type='method'><a href="module-logbook.html#.deleteAllLogsConfirmed">deleteAllLogsConfirmed</a></li><li data-type='method'><a href="module-logbook.html#.getLogFileSize">getLogFileSize</a></li><li data-type='method'><a href="module-logbook.html#.initLogbook">initLogbook</a></li><li data-type='method'><a href="module-logbook.html#.prependLogEntry">prependLogEntry</a></li><li data-type='method'><a href="module-logbook.html#~convertActionFilterToBackend">convertActionFilterToBackend</a></li><li data-type='method'><a href="module-logbook.html#~exportLogs">exportLogs</a></li><li data-type='method'><a href="module-logbook.html#~formatDetails">formatDetails</a></li><li data-type='method'><a href="module-logbook.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-logbook.html#~getTransactionType">getTransactionType</a></li><li data-type='method'><a href="module-logbook.html#~loadLogs">loadLogs</a></li><li data-type='method'><a href="module-logbook.html#~renderDetailsRow">renderDetailsRow</a></li><li data-type='method'><a href="module-logbook.html#~renderLogTable">renderLogTable</a></li><li data-type='method'><a href="module-logbook.html#~toggleExpanded">toggleExpanded</a></li><li data-type='method'><a href="module-logbook.html#~updateActionFilter">updateActionFilter</a></li></ul></li><li><a href="module-map-icon-bar.html">map-icon-bar</a><ul class='methods'><li data-type='method'><a href="module-map-icon-bar.html#.initializeMapIconBar">initializeMapIconBar</a></li><li data-type='method'><a href="module-map-icon-bar.html#~handleIconAction">handleIconAction</a></li></ul></li><li><a href="module-messenger.html">messenger</a><ul class='methods'><li data-type='method'><a href="module-messenger.html#.closeAllChats">closeAllChats</a></li><li data-type='method'><a href="module-messenger.html#.closeChatSelection">closeChatSelection</a></li><li data-type='method'><a href="module-messenger.html#.openMessenger">openMessenger</a></li><li data-type='method'><a href="module-messenger.html#.openNewChat">openNewChat</a></li><li data-type='method'><a href="module-messenger.html#.showAllChats">showAllChats</a></li><li data-type='method'><a href="module-messenger.html#.updateUnreadBadge">updateUnreadBadge</a></li><li data-type='method'><a href="module-messenger.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-messenger.html#~loadPrivateMessages">loadPrivateMessages</a></li><li data-type='method'><a href="module-messenger.html#~showCounterOfferUI">showCounterOfferUI</a></li><li data-type='method'><a href="module-messenger.html#~stopHijackingPolling">stopHijackingPolling</a></li></ul></li><li><a href="module-public_js_modules_hijacking.html">public/js/modules/hijacking</a><ul class='methods'><li data-type='method'><a href="module-public_js_modules_hijacking.html#.closeHijackingInbox">closeHijackingInbox</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.openHijackingInbox">openHijackingInbox</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.updateHijackedVesselsDisplay">updateHijackedVesselsDisplay</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.updateHijackingBadge">updateHijackingBadge</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~deleteCase">deleteCase</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~openCaseDetails">openCaseDetails</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~refreshHijackingBadge">refreshHijackingBadge</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~renderCaseList">renderCaseList</a></li></ul></li><li><a href="module-server_automation.html">server/automation</a><ul class='methods'><li data-type='method'><a href="module-server_automation.html#~getRandomInterval">getRandomInterval</a></li><li data-type='method'><a href="module-server_automation.html#~initialize">initialize</a></li><li data-type='method'><a href="module-server_automation.html#~loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_automation.html#~parseInterval">parseInterval</a></li><li data-type='method'><a href="module-server_automation.html#~restartAutoRepair">restartAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~runAutoRepair">runAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~scheduleAutoRepair">scheduleAutoRepair</a></li></ul></li><li><a href="module-server_autopilot.html">server/autopilot</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot.html#~analyzeVesselDepartures">analyzeVesselDepartures</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoRebuyAll">autoRebuyAll</a></li><li data-type='method'><a href="module-server_autopilot.html#~checkPriceAlerts">checkPriceAlerts</a></li><li data-type='method'><a href="module-server_autopilot.html#~countActiveCampaignTypes">countActiveCampaignTypes</a></li><li data-type='method'><a href="module-server_autopilot.html#~initializeAutopilotState">initializeAutopilotState</a></li><li data-type='method'><a href="module-server_autopilot.html#~isAutopilotPaused">isAutopilotPaused</a></li><li data-type='method'><a href="module-server_autopilot.html#~mainEventLoop">mainEventLoop</a></li><li data-type='method'><a href="module-server_autopilot.html#~pauseAutopilot">pauseAutopilot</a></li><li data-type='method'><a href="module-server_autopilot.html#~resumeAutopilot">resumeAutopilot</a></li><li data-type='method'><a href="module-server_autopilot.html#~setBroadcastFunction">setBroadcastFunction</a></li><li data-type='method'><a href="module-server_autopilot.html#~startMainEventLoop">startMainEventLoop</a></li><li data-type='method'><a href="module-server_autopilot.html#~tryUpdateAllData">tryUpdateAllData</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateAllData">updateAllData</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateCampaigns">updateCampaigns</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateDrydockCount">updateDrydockCount</a></li><li data-type='method'><a href="module-server_autopilot.html#~updatePrices">updatePrices</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateRepairCount">updateRepairCount</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateUnreadMessages">updateUnreadMessages</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateVesselCount">updateVesselCount</a></li></ul></li><li><a href="module-server_autopilot_pilot_atmosphere_broker.html">server/autopilot/pilot_atmosphere_broker</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_atmosphere_broker.html#~autoRebuyCO2">autoRebuyCO2</a></li></ul></li><li><a href="module-server_autopilot_pilot_barrel_boss.html">server/autopilot/pilot_barrel_boss</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_barrel_boss.html#~autoRebuyFuel">autoRebuyFuel</a></li></ul></li><li><a href="module-server_autopilot_pilot_captain_blackbeard.html">server/autopilot/pilot_captain_blackbeard</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~acceptRansomWithRetry">acceptRansomWithRetry</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~autoNegotiateHijacking">autoNegotiateHijacking</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~getCaseWithRetry">getCaseWithRetry</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~processHijackingCase">processHijackingCase</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~submitOfferWithRetry">submitOfferWithRetry</a></li></ul></li><li><a href="module-server_autopilot_pilot_cargo_marshal.html">server/autopilot/pilot_cargo_marshal</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~autoDepartVessels">autoDepartVessels</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~departVessels">departVessels</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~getTotalCapacity">getTotalCapacity</a></li></ul></li><li><a href="module-server_autopilot_pilot_drydock_master.html">server/autopilot/pilot_drydock_master</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_drydock_master.html#~autoDrydockVessels">autoDrydockVessels</a></li></ul></li><li><a href="module-server_autopilot_pilot_fair_hand.html">server/autopilot/pilot_fair_hand</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_fair_hand.html#~autoCoop">autoCoop</a></li></ul></li><li><a href="module-server_autopilot_pilot_harbormaster.html">server/autopilot/pilot_harbormaster</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_harbormaster.html#~autoAnchorPointPurchase">autoAnchorPointPurchase</a></li><li data-type='method'><a href="module-server_autopilot_pilot_harbormaster.html#~setBroadcastFunction">setBroadcastFunction</a></li></ul></li><li><a href="module-server_autopilot_pilot_reputation_chief.html">server/autopilot/pilot_reputation_chief</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_reputation_chief.html#~autoCampaignRenewal">autoCampaignRenewal</a></li></ul></li><li><a href="module-server_autopilot_pilot_yard_foreman.html">server/autopilot/pilot_yard_foreman</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_yard_foreman.html#~autoRepairVessels">autoRepairVessels</a></li></ul></li><li><a href="module-server_cache.html">server/cache</a><ul class='methods'><li data-type='method'><a href="module-server_cache.html#~clearAllCaches">clearAllCaches</a></li><li data-type='method'><a href="module-server_cache.html#~getAllianceCache">getAllianceCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCampaignCache">getCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCompanyCache">getCompanyCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCoopCache">getCoopCache</a></li><li data-type='method'><a href="module-server_cache.html#~invalidateCampaignCache">invalidateCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~invalidateCoopCache">invalidateCoopCache</a></li><li data-type='method'><a href="module-server_cache.html#~isCacheValid">isCacheValid</a></li><li data-type='method'><a href="module-server_cache.html#~setAllianceCache">setAllianceCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCampaignCache">setCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCompanyCache">setCompanyCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCoopCache">setCoopCache</a></li></ul></li><li><a href="module-server_certificate.html">server/certificate</a><ul class='methods'><li data-type='method'><a href="module-server_certificate.html#~createHttpsServer">createHttpsServer</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCA">generateCA</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCertificate">generateCertificate</a></li><li data-type='method'><a href="module-server_certificate.html#~getNetworkIPs">getNetworkIPs</a></li><li data-type='method'><a href="module-server_certificate.html#~isCertificateInstalled">isCertificateInstalled</a></li><li data-type='method'><a href="module-server_certificate.html#~loadCertificate">loadCertificate</a></li></ul></li><li><a href="module-server_chatbot.html">server/chatbot</a></li><li><a href="module-server_chatbot_commands.html">server/chatbot/commands</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_commands.html#~generateForecastText">generateForecastText</a></li><li data-type='method'><a href="module-server_chatbot_commands.html#~handleForecastCommand">handleForecastCommand</a></li><li data-type='method'><a href="module-server_chatbot_commands.html#~handleHelpCommand">handleHelpCommand</a></li></ul></li><li><a href="module-server_chatbot_executor.html">server/chatbot/executor</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_executor.html#~executeCommand">executeCommand</a></li></ul></li><li><a href="module-server_chatbot_parser.html">server/chatbot/parser</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_parser.html#~findCustomCommand">findCustomCommand</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~isCommandAllowedInChannel">isCommandAllowedInChannel</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~isOnCooldown">isOnCooldown</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~processAllianceMessage">processAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~processPrivateMessage">processPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~resolveCommandName">resolveCommandName</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~updateCooldown">updateCooldown</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~validateCommandArguments">validateCommandArguments</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~validateForecastArguments">validateForecastArguments</a></li></ul></li><li><a href="module-server_chatbot_scheduler.html">server/chatbot/scheduler</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_scheduler.html#~scheduleDailyForecast">scheduleDailyForecast</a></li><li data-type='method'><a href="module-server_chatbot_scheduler.html#~sendDailyForecast">sendDailyForecast</a></li><li data-type='method'><a href="module-server_chatbot_scheduler.html#~setupScheduledTasks">setupScheduledTasks</a></li></ul></li><li><a href="module-server_chatbot_sender.html">server/chatbot/sender</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_sender.html#~sendAllianceMessage">sendAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot_sender.html#~sendErrorMessage">sendErrorMessage</a></li><li data-type='method'><a href="module-server_chatbot_sender.html#~sendPrivateMessage">sendPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot_sender.html#~sendResponse">sendResponse</a></li></ul></li><li><a href="module-server_chatbot_settings.html">server/chatbot/settings</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_settings.html#~getDefaultChatBotObject">getDefaultChatBotObject</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~mapChatBotObjectToFlatSettings">mapChatBotObjectToFlatSettings</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~mapSettingsToChatBotObject">mapSettingsToChatBotObject</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~updateSettings">updateSettings</a></li></ul></li><li><a href="module-server_config.html">server/config</a><ul class='methods'><li data-type='method'><a href="module-server_config.html#~getAppDataDir">getAppDataDir</a></li><li data-type='method'><a href="module-server_config.html#~getLocalAppDataDir">getLocalAppDataDir</a></li><li data-type='method'><a href="module-server_config.html#~getLogDir">getLogDir</a></li><li data-type='method'><a href="module-server_config.html#~getSessionCookie">getSessionCookie</a></li><li data-type='method'><a href="module-server_config.html#~getSettingsDir">getSettingsDir</a></li><li data-type='method'><a href="module-server_config.html#~loadStartupSettings">loadStartupSettings</a></li><li data-type='method'><a href="module-server_config.html#~setSessionCookie">setSessionCookie</a></li></ul></li><li><a href="module-server_gameapi.html">server/gameapi</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi.html#~activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-server_gameapi.html#~bulkRepairVessels">bulkRepairVessels</a></li><li data-type='method'><a href="module-server_gameapi.html#~departVessel">departVessel</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchAutoPrice">fetchAutoPrice</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchBunkerState">fetchBunkerState</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchEventData">fetchEventData</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchPrices">fetchPrices</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchRepairCount">fetchRepairCount</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchUnreadMessages">fetchUnreadMessages</a></li><li data-type='method'><a href="module-server_gameapi.html#~fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-server_gameapi.html#~getAllUserVessels">getAllUserVessels</a></li><li data-type='method'><a href="module-server_gameapi.html#~getAssignedPorts">getAssignedPorts</a></li><li data-type='method'><a href="module-server_gameapi.html#~getGameIndex">getGameIndex</a></li><li data-type='method'><a href="module-server_gameapi.html#~getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-server_gameapi.html#~getVesselHistory">getVesselHistory</a></li><li data-type='method'><a href="module-server_gameapi.html#~getVesselPorts">getVesselPorts</a></li><li data-type='method'><a href="module-server_gameapi.html#~purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-server_gameapi.html#~purchaseFuel">purchaseFuel</a></li></ul></li><li><a href="module-server_middleware_index.html">server/middleware/index</a><ul class='methods'><li data-type='method'><a href="module-server_middleware_index.html#~setupMiddleware">setupMiddleware</a></li></ul></li><li><a href="module-server_routes_alliance.html">server/routes/alliance</a><ul class='methods'><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-members">GET /api/alliance-members</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/chat">GET /api/chat</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/chat/mark-read">POST /api/chat/mark-read</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/company-name">POST /api/company-name</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/send-message">POST /api/send-message</a></li></ul></li><li><a href="module-server_routes_anchor.html">server/routes/anchor</a></li><li><a href="module-server_routes_coop.html">server/routes/coop</a><ul class='methods'><li data-type='method'><a href="module-server_routes_coop.html#.GET/api/coop/data">GET /api/coop/data</a></li><li data-type='method'><a href="module-server_routes_coop.html#.POST/api/coop/send-max">POST /api/coop/send-max</a></li></ul></li><li><a href="module-server_routes_forecast.html">server/routes/forecast</a><ul class='methods'><li data-type='method'><a href="module-server_routes_forecast.html#~convertCESTToTimezone">convertCESTToTimezone</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~generateChatbotText">generateChatbotText</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~generateMetadata">generateMetadata</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getForecastDataPath">getForecastDataPath</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getNextDayData">getNextDayData</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getPreviousDayData">getPreviousDayData</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getServerLocalTimezone">getServerLocalTimezone</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getTimezoneOffsetHours">getTimezoneOffsetHours</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getValidTimezones">getValidTimezones</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~parseNumericOffset">parseNumericOffset</a></li></ul></li><li><a href="module-server_routes_game.html">server/routes/game</a></li><li><a href="module-server_routes_harbor-map.html">server/routes/harbor-map</a><ul class='methods'><li data-type='method'><a href="module-server_routes_harbor-map.html#~escapeCSVFormula">escapeCSVFormula</a></li><li data-type='method'><a href="module-server_routes_harbor-map.html#~formatHistoryAsTXT">formatHistoryAsTXT</a></li><li data-type='method'><a href="module-server_routes_harbor-map.html#~getGameIndexCached">getGameIndexCached</a></li></ul></li><li><a href="module-server_routes_health.html">server/routes/health</a></li><li><a href="module-server_routes_messenger.html">server/routes/messenger</a><ul class='methods'><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/contact/get-contacts">GET /api/contact/get-contacts</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/hijacking/get-cases">GET /api/hijacking/get-cases</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/messenger/get-chats">GET /api/messenger/get-chats</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/delete-chat">POST /api/messenger/delete-chat</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/get-messages">POST /api/messenger/get-messages</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/send-private">POST /api/messenger/send-private</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/user/search">POST /api/user/search</a></li><li data-type='method'><a href="module-server_routes_messenger.html#~migrateHijackHistory">migrateHijackHistory</a></li></ul></li><li><a href="module-server_routes_poi.html">server/routes/poi</a><ul class='methods'><li data-type='method'><a href="module-server_routes_poi.html#~ensureCacheDir">ensureCacheDir</a></li><li data-type='method'><a href="module-server_routes_poi.html#~fetchAllMuseumsFromAPI">fetchAllMuseumsFromAPI</a></li><li data-type='method'><a href="module-server_routes_poi.html#~fetchAllWrecksFromAPI">fetchAllWrecksFromAPI</a></li><li data-type='method'><a href="module-server_routes_poi.html#~filterPOIsByBbox">filterPOIsByBbox</a></li><li data-type='method'><a href="module-server_routes_poi.html#~initializePOICache">initializePOICache</a></li><li data-type='method'><a href="module-server_routes_poi.html#~isCacheValid">isCacheValid</a></li><li data-type='method'><a href="module-server_routes_poi.html#~loadFromCache">loadFromCache</a></li><li data-type='method'><a href="module-server_routes_poi.html#~reduceWreckData">reduceWreckData</a></li><li data-type='method'><a href="module-server_routes_poi.html#~saveToCache">saveToCache</a></li><li data-type='method'><a href="module-server_routes_poi.html#~startAutomaticCacheRefresh">startAutomaticCacheRefresh</a></li></ul></li><li><a href="module-server_routes_settings.html">server/routes/settings</a><ul class='methods'><li data-type='method'><a href="module-server_routes_settings.html#.GET/api/settings">GET /api/settings</a></li><li data-type='method'><a href="module-server_routes_settings.html#.POST/api/settings">POST /api/settings</a></li></ul></li><li><a href="module-server_routes_vessel-image.html">server/routes/vessel-image</a></li><li><a href="module-server_scheduler.html">server/scheduler</a><ul class='methods'><li data-type='method'><a href="module-server_scheduler.html#~initScheduler">initScheduler</a></li><li data-type='method'><a href="module-server_scheduler.html#~isServerReady">isServerReady</a></li></ul></li><li><a href="module-server_settings-schema.html">server/settings-schema</a><ul class='methods'><li data-type='method'><a href="module-server_settings-schema.html#~getDefault">getDefault</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getDefaults">getDefaults</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getRequiredKeys">getRequiredKeys</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getSettingsFilePath">getSettingsFilePath</a></li><li data-type='method'><a href="module-server_settings-schema.html#~initializeSettings">initializeSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~saveSettings">saveSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~validateSettings">validateSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~validateValue">validateValue</a></li></ul></li><li><a href="module-server_state.html">server/state</a><ul class='methods'><li data-type='method'><a href="module-server_state.html#~getAllLocks">getAllLocks</a></li><li data-type='method'><a href="module-server_state.html#~getAutopilotState">getAutopilotState</a></li><li data-type='method'><a href="module-server_state.html#~getBunkerState">getBunkerState</a></li><li data-type='method'><a href="module-server_state.html#~getCampaignStatus">getCampaignStatus</a></li><li data-type='method'><a href="module-server_state.html#~getCoopData">getCoopData</a></li><li data-type='method'><a href="module-server_state.html#~getDrydockCount">getDrydockCount</a></li><li data-type='method'><a href="module-server_state.html#~getEventData">getEventData</a></li><li data-type='method'><a href="module-server_state.html#~getHeaderData">getHeaderData</a></li><li data-type='method'><a href="module-server_state.html#~getLastCO2Alert">getLastCO2Alert</a></li><li data-type='method'><a href="module-server_state.html#~getLastFuelAlert">getLastFuelAlert</a></li><li data-type='method'><a href="module-server_state.html#~getLockStatus">getLockStatus</a></li><li data-type='method'><a href="module-server_state.html#~getPrices">getPrices</a></li><li data-type='method'><a href="module-server_state.html#~getRepairCount">getRepairCount</a></li><li data-type='method'><a href="module-server_state.html#~getSettings">getSettings</a></li><li data-type='method'><a href="module-server_state.html#~getUserState">getUserState</a></li><li data-type='method'><a href="module-server_state.html#~getVesselCounts">getVesselCounts</a></li><li data-type='method'><a href="module-server_state.html#~isAutopilotPaused">isAutopilotPaused</a></li><li data-type='method'><a href="module-server_state.html#~setAutopilotPaused">setAutopilotPaused</a></li><li data-type='method'><a href="module-server_state.html#~setAutopilotState">setAutopilotState</a></li><li data-type='method'><a href="module-server_state.html#~setLastCO2Alert">setLastCO2Alert</a></li><li data-type='method'><a href="module-server_state.html#~setLastFuelAlert">setLastFuelAlert</a></li><li data-type='method'><a href="module-server_state.html#~setLockStatus">setLockStatus</a></li><li data-type='method'><a href="module-server_state.html#~updateBunkerState">updateBunkerState</a></li><li data-type='method'><a href="module-server_state.html#~updateCampaignStatus">updateCampaignStatus</a></li><li data-type='method'><a href="module-server_state.html#~updateCoopData">updateCoopData</a></li><li data-type='method'><a href="module-server_state.html#~updateDrydockCount">updateDrydockCount</a></li><li data-type='method'><a href="module-server_state.html#~updateEventData">updateEventData</a></li><li data-type='method'><a href="module-server_state.html#~updateHeaderData">updateHeaderData</a></li><li data-type='method'><a href="module-server_state.html#~updatePrices">updatePrices</a></li><li data-type='method'><a href="module-server_state.html#~updateRepairCount">updateRepairCount</a></li><li data-type='method'><a href="module-server_state.html#~updateSettings">updateSettings</a></li><li data-type='method'><a href="module-server_state.html#~updateVesselCounts">updateVesselCounts</a></li></ul></li><li><a href="module-server_utils_api.html">server/utils/api</a><ul class='methods'><li data-type='method'><a href="module-server_utils_api.html#~apiCall">apiCall</a></li><li data-type='method'><a href="module-server_utils_api.html#~apiCallWithRetry">apiCallWithRetry</a></li><li data-type='method'><a href="module-server_utils_api.html#~getAllianceId">getAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~getChatFeed">getChatFeed</a></li><li data-type='method'><a href="module-server_utils_api.html#~getCompanyName">getCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserCompanyName">getUserCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserId">getUserId</a></li><li data-type='method'><a href="module-server_utils_api.html#~initializeAlliance">initializeAlliance</a></li><li data-type='method'><a href="module-server_utils_api.html#~sleep">sleep</a></li></ul></li><li><a href="module-server_utils_audit-logger.html">server/utils/audit-logger</a><ul class='methods'><li data-type='method'><a href="module-server_utils_audit-logger.html#~auditLog">auditLog</a></li><li data-type='method'><a href="module-server_utils_audit-logger.html#~formatCurrency">formatCurrency</a></li><li data-type='method'><a href="module-server_utils_audit-logger.html#~formatNumber">formatNumber</a></li></ul></li><li><a href="module-server_utils_encryption.html">server/utils/encryption</a><ul class='methods'><li data-type='method'><a href="module-server_utils_encryption.html#~decryptData">decryptData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~deleteEncryptedData">deleteEncryptedData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~encryptData">encryptData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~getEncryptionInfo">getEncryptionInfo</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~getMachineKey">getMachineKey</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~isEncrypted">isEncrypted</a></li></ul></li><li><a href="module-server_utils_harbor-fee-store.html">server/utils/harbor-fee-store</a><ul class='methods'><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~enrichHistoryWithFees">enrichHistoryWithFees</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~ensureDirectory">ensureDirectory</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~getFilePath">getFilePath</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~getHarborFee">getHarborFee</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~isMigrationCompleted">isMigrationCompleted</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~loadHarborFees">loadHarborFees</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~markMigrationCompleted">markMigrationCompleted</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~saveHarborFee">saveHarborFee</a></li></ul></li><li><a href="module-server_utils_logger.html">server/utils/logger</a><ul class='methods'><li data-type='method'><a href="module-server_utils_logger.html#~debug">debug</a></li><li data-type='method'><a href="module-server_utils_logger.html#~error">error</a></li><li data-type='method'><a href="module-server_utils_logger.html#~info">info</a></li><li data-type='method'><a href="module-server_utils_logger.html#~isDebugMode">isDebugMode</a></li><li data-type='method'><a href="module-server_utils_logger.html#~loadLogLevel">loadLogLevel</a></li><li data-type='method'><a href="module-server_utils_logger.html#~warn">warn</a></li></ul></li><li><a href="module-server_utils_migrate-harbor-fees.html">server/utils/migrate-harbor-fees</a><ul class='methods'><li data-type='method'><a href="module-server_utils_migrate-harbor-fees.html#~migrateAllHarborFees">migrateAllHarborFees</a></li><li data-type='method'><a href="module-server_utils_migrate-harbor-fees.html#~migrateHarborFeesForUser">migrateHarborFeesForUser</a></li><li data-type='method'><a href="module-server_utils_migrate-harbor-fees.html#~resolveVesselNameToId">resolveVesselNameToId</a></li><li data-type='method'><a href="module-server_utils_migrate-harbor-fees.html#~timestampToMySQLDatetime">timestampToMySQLDatetime</a></li></ul></li><li><a href="module-server_utils_read-tracker.html">server/utils/read-tracker</a><ul class='methods'><li data-type='method'><a href="module-server_utils_read-tracker.html#~ensureReadTrackingFile">ensureReadTrackingFile</a></li><li data-type='method'><a href="module-server_utils_read-tracker.html#~getLastReadTimestamp">getLastReadTimestamp</a></li><li data-type='method'><a href="module-server_utils_read-tracker.html#~saveReadTrackingFile">saveReadTrackingFile</a></li><li data-type='method'><a href="module-server_utils_read-tracker.html#~updateLastReadTimestamp">updateLastReadTimestamp</a></li></ul></li><li><a href="module-server_utils_session-manager.html">server/utils/session-manager</a><ul class='methods'><li data-type='method'><a href="module-server_utils_session-manager.html#~deleteSession">deleteSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getAllUserIds">getAllUserIds</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getAvailableSessions">getAvailableSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getSession">getSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getSessionsPath">getSessionsPath</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~hasSession">hasSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~loadAllSessions">loadAllSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~loadSessions">loadSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~migrateToEncrypted">migrateToEncrypted</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~saveSession">saveSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~saveSessions">saveSessions</a></li></ul></li><li><a href="module-server_websocket.html">server/websocket</a><ul class='methods'><li data-type='method'><a href="module-server_websocket.html#~broadcast">broadcast</a></li><li data-type='method'><a href="module-server_websocket.html#~broadcastBunkerUpdate">broadcastBunkerUpdate</a></li><li data-type='method'><a href="module-server_websocket.html#~broadcastHarborMapRefresh">broadcastHarborMapRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~broadcastToUser">broadcastToUser</a></li><li data-type='method'><a href="module-server_websocket.html#~getCachedHijackingCase">getCachedHijackingCase</a></li><li data-type='method'><a href="module-server_websocket.html#~getCachedMessengerChats">getCachedMessengerChats</a></li><li data-type='method'><a href="module-server_websocket.html#~getProcessedMessageIds">getProcessedMessageIds</a></li><li data-type='method'><a href="module-server_websocket.html#~getProcessedMessagesCachePath">getProcessedMessagesCachePath</a></li><li data-type='method'><a href="module-server_websocket.html#~initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-server_websocket.html#~loadProcessedMessageCache">loadProcessedMessageCache</a></li><li data-type='method'><a href="module-server_websocket.html#~performChatRefresh">performChatRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~performHijackingRefresh">performHijackingRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~performMessengerRefresh">performMessengerRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~saveProcessedMessageCache">saveProcessedMessageCache</a></li><li data-type='method'><a href="module-server_websocket.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~startHijackingAutoRefresh">startHijackingAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~startMessengerAutoRefresh">startMessengerAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopChatAutoRefresh">stopChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopHijackingAutoRefresh">stopHijackingAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopMessengerAutoRefresh">stopMessengerAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~triggerImmediateChatRefresh">triggerImmediateChatRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~triggerImmediateHijackingRefresh">triggerImmediateHijackingRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~triggerImmediateMessengerRefresh">triggerImmediateMessengerRefresh</a></li></ul></li><li><a href="module-ui-dialogs.html">ui-dialogs</a><ul class='methods'><li data-type='method'><a href="module-ui-dialogs.html#.buyCampaign">buyCampaign</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeCampaignsOverlay">closeCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeSettings">closeSettings</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showCampaignsOverlay">showCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showConfirmDialog">showConfirmDialog</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showContactList">showContactList</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showSettings">showSettings</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#.escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-utils.html#.formatNumber">formatNumber</a></li><li data-type='method'><a href="module-utils.html#.isMobileDevice">isMobileDevice</a></li><li data-type='method'><a href="module-utils.html#.registerServiceWorker">registerServiceWorker</a></li><li data-type='method'><a href="module-utils.html#.renderStars">renderStars</a></li><li data-type='method'><a href="module-utils.html#.requestNotificationPermission">requestNotificationPermission</a></li><li data-type='method'><a href="module-utils.html#.showNotification">showNotification</a></li><li data-type='method'><a href="module-utils.html#.showSideNotification">showSideNotification</a></li></ul></li><li><a href="module-vessel-management.html">vessel-management</a><ul class='methods'><li data-type='method'><a href="module-vessel-management.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.openRepairAndDrydockDialog">openRepairAndDrydockDialog</a></li><li data-type='method'><a href="module-vessel-management.html#.purchaseSingleVessel">purchaseSingleVessel</a></li><li data-type='method'><a href="module-vessel-management.html#.updateLockStateFromServer">updateLockStateFromServer</a></li><li data-type='method'><a href="module-vessel-management.html#.updateVesselCount">updateVesselCount</a></li><li data-type='method'><a href="module-vessel-management.html#~createVesselCard">createVesselCard</a></li><li data-type='method'><a href="module-vessel-management.html#~displayFilteredVessels">displayFilteredVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~executeDrydock">executeDrydock</a></li><li data-type='method'><a href="module-vessel-management.html#~getAvailableAnchorSlots">getAvailableAnchorSlots</a></li><li data-type='method'><a href="module-vessel-management.html#~getCO2EfficiencyClass">getCO2EfficiencyClass</a></li><li data-type='method'><a href="module-vessel-management.html#~getCapacityDisplay">getCapacityDisplay</a></li><li data-type='method'><a href="module-vessel-management.html#~getFuelEfficiencyClass">getFuelEfficiencyClass</a></li><li data-type='method'><a href="module-vessel-management.html#~loadCartFromStorage">loadCartFromStorage</a></li><li data-type='method'><a href="module-vessel-management.html#~loadMorePendingVessels">loadMorePendingVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~loadMoreVessels">loadMoreVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~populateDynamicFilters">populateDynamicFilters</a></li><li data-type='method'><a href="module-vessel-management.html#~preloadCommonVesselImages">preloadCommonVesselImages</a></li><li data-type='method'><a href="module-vessel-management.html#~preloadVesselImage">preloadVesselImage</a></li><li data-type='method'><a href="module-vessel-management.html#~refreshVesselCardsIfVisible">refreshVesselCardsIfVisible</a></li><li data-type='method'><a href="module-vessel-management.html#~renderDrydockTab">renderDrydockTab</a></li><li data-type='method'><a href="module-vessel-management.html#~renderRepairTab">renderRepairTab</a></li><li data-type='method'><a href="module-vessel-management.html#~saveCartToStorage">saveCartToStorage</a></li><li data-type='method'><a href="module-vessel-management.html#~showRepairAndDrydockDialog">showRepairAndDrydockDialog</a></li><li data-type='method'><a href="module-vessel-management.html#~updateCapacityDropdowns">updateCapacityDropdowns</a></li><li data-type='method'><a href="module-vessel-management.html#~vesselPassesFilters">vesselPassesFilters</a></li></ul></li><li><a href="module-vessel-selling.html">vessel-selling</a><ul class='methods'><li data-type='method'><a href="module-vessel-selling.html#.bulkSellVessels">bulkSellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#.closeSellVesselsOverlay">closeSellVesselsOverlay</a></li><li data-type='method'><a href="module-vessel-selling.html#.openSellVesselsOverlay">openSellVesselsOverlay</a></li><li data-type='method'><a href="module-vessel-selling.html#.refreshVesselsForSale">refreshVesselsForSale</a></li><li data-type='method'><a href="module-vessel-selling.html#.setSellFilter">setSellFilter</a></li><li data-type='method'><a href="module-vessel-selling.html#.showSellCart">showSellCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~clearSellCartCache">clearSellCartCache</a></li><li data-type='method'><a href="module-vessel-selling.html#~displaySellVessels">displaySellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#~getCO2EfficiencyClass">getCO2EfficiencyClass</a></li><li data-type='method'><a href="module-vessel-selling.html#~getCapacityDisplay">getCapacityDisplay</a></li><li data-type='method'><a href="module-vessel-selling.html#~getFuelEfficiencyClass">getFuelEfficiencyClass</a></li><li data-type='method'><a href="module-vessel-selling.html#~groupVesselsByModel">groupVesselsByModel</a></li><li data-type='method'><a href="module-vessel-selling.html#~loadSellCartFromCache">loadSellCartFromCache</a></li><li data-type='method'><a href="module-vessel-selling.html#~loadUserVesselsForSale">loadUserVesselsForSale</a></li><li data-type='method'><a href="module-vessel-selling.html#~removeVesselSelectionFromCart">removeVesselSelectionFromCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~saveSellCartToCache">saveSellCartToCache</a></li><li data-type='method'><a href="module-vessel-selling.html#~sellVessels">sellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateBulkSellButton">updateBulkSellButton</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateSelectButtonState">updateSelectButtonState</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateVesselSelectionInCart">updateVesselSelectionInCart</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#buildNav">buildNav</a></li><li><a href="global.html#deleteAllLogs">deleteAllLogs</a></li><li><a href="global.html#escapeCSVFormula">escapeCSVFormula</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#flushAllToDisk">flushAllToDisk</a></li><li><a href="global.html#formatDetailsAsTXT">formatDetailsAsTXT</a></li><li><a href="global.html#formatFileSize">formatFileSize</a></li><li><a href="global.html#formatLogsAsCSV">formatLogsAsCSV</a></li><li><a href="global.html#formatLogsAsTXT">formatLogsAsTXT</a></li><li><a href="global.html#fs">fs</a></li><li><a href="global.html#getCategoryFromAction">getCategoryFromAction</a></li><li><a href="global.html#getLogEntries">getLogEntries</a></li><li><a href="global.html#getLogFilePath">getLogFilePath</a></li><li><a href="global.html#getLogFileSize">getLogFileSize</a></li><li><a href="global.html#getLogsFromCache">getLogsFromCache</a></li><li><a href="global.html#getSourceFromAction">getSourceFromAction</a></li><li><a href="global.html#getTransactionType">getTransactionType</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#isDepartInProgress">isDepartInProgress</a></li><li><a href="global.html#loadLogsFromDisk">loadLogsFromDisk</a></li><li><a href="global.html#lockBulkBuyButton">lockBulkBuyButton</a></li><li><a href="global.html#lockCo2Button">lockCo2Button</a></li><li><a href="global.html#lockCoopButtons">lockCoopButtons</a></li><li><a href="global.html#lockDepartButton">lockDepartButton</a></li><li><a href="global.html#lockDrydockButton">lockDrydockButton</a></li><li><a href="global.html#lockFuelButton">lockFuelButton</a></li><li><a href="global.html#lockRepairButton">lockRepairButton</a></li><li><a href="global.html#logAutopilotAction">logAutopilotAction</a></li><li><a href="global.html#publish">publish</a></li><li><a href="global.html#searchInObject">searchInObject</a></li><li><a href="global.html#showAnchorTimer">showAnchorTimer</a></li><li><a href="global.html#shutdown">shutdown</a></li><li><a href="global.html#unlockBulkBuyButton">unlockBulkBuyButton</a></li><li><a href="global.html#unlockCo2Button">unlockCo2Button</a></li><li><a href="global.html#unlockCoopButtons">unlockCoopButtons</a></li><li><a href="global.html#unlockDepartButton">unlockDepartButton</a></li><li><a href="global.html#unlockDrydockButton">unlockDrydockButton</a></li><li><a href="global.html#unlockFuelButton">unlockFuelButton</a></li><li><a href="global.html#unlockRepairButton">unlockRepairButton</a></li><li><a href="global.html#writeLogsToDisk">writeLogsToDisk</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">public/js/modules/chat.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Alliance Chat Module - Manages real-time alliance chat functionality with WebSocket support,
 * message rendering, mention autocomplete, and notification handling. This module provides the core
 * communication interface for alliance members to collaborate and coordinate in the Shipping Manager game.
 *
 * Key Features:
 * - Real-time chat updates via WebSocket (server broadcasts every 25 seconds)
 * - User mention system with @username autocomplete (converts to [user_id] format)
 * - Mixed message types: chat messages and system feed events (member joins, route completions)
 * - Smart auto-scroll behavior (maintains position while scrolling up to read history)
 * - Desktop notifications for new messages when window is not focused
 * - Company name caching to reduce API calls
 *
 * Message Flow:
 * 1. Messages loaded from REST API on initial page load
 * 2. WebSocket pushes updates every 25 seconds from server
 * 3. New messages trigger notifications if window not focused
 * 4. Duplicate messages filtered by type+timestamp+content comparison
 *
 * Mention System:
 * - Typing "@" triggers autocomplete with alliance member list
 * - Selecting member inserts [user_id] into message
 * - Server converts [user_id] to @CompanyName on broadcast
 * - Clicking @CompanyName opens private messenger
 *
 * @module chat
 * @requires utils - HTML escaping, feedback, and notification functions
 * @requires api - Backend API calls for chat data and company names
 */

import { escapeHtml, showSideNotification, handleNotifications, showNotification, formatNumber, showChatNotification } from './utils.js';
import { getCompanyNameCached, fetchChat, sendChatMessage, fetchAllianceMembers } from './api.js';
import { updateEventDiscount } from './forecast-calendar.js';
import { updateEventData } from './event-info.js';
import { lockRepairButton, unlockRepairButton, lockBulkBuyButton, unlockBulkBuyButton, lockFuelButton, unlockFuelButton, lockCo2Button, unlockCo2Button, lockDrydockButton, unlockDrydockButton, updateLockStateFromServer } from './vessel-management.js';
import { lockCoopButtons, unlockCoopButtons } from './coop.js';
import { showAnchorTimer } from './anchor-purchase.js';
import { updateCurrentCash, updateCurrentFuel, updateCurrentCO2 } from './bunker-management.js';
import { refreshVesselsForSale } from './vessel-selling.js';
import { updateBadge, updateButtonState, updateButtonTooltip } from './badge-manager.js';

/**
 * Converts UTC timestamp string to local timezone string using browser locale.
 * @param {string} utcString - UTC timestamp string (e.g., "Tue, 28 Oct 2025 17:00:00 GMT")
 * @returns {string} Local timezone formatted string (e.g., "Oct 28, 2025, 18:00:00")
 */
function formatLocalTime(utcString) {
  const date = new Date(utcString);
  return date.toLocaleString(undefined, {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  });
}

/**
 * Array of all chat messages and feed events.
 * Maintained in chronological order. Contains both 'chat' and 'feed' type messages.
 * @type {Array&lt;Object>}
 */
let allMessages = [];

/**
 * Array of alliance members for mention autocomplete.
 * Populated on chat load. Each member has user_id and company_name properties.
 * @type {Array&lt;{user_id: number, company_name: string}>}
 */
let allianceMembers = [];

/**
 * Auto-scroll flag controlling scroll-to-bottom behavior.
 * Set to true when user sends message or is near bottom. Prevents forced scrolling when reading history.
 * @type {boolean}
 */
let autoScroll = true;

/**
 * Parses message text and converts user ID mentions to clickable company name links.
 * Handles the mention system by converting [user_id] patterns to @CompanyName with click handlers.
 *
 * Processing Steps:
 * 1. Escape HTML to prevent XSS attacks
 * 2. Find all [user_id] patterns in the message
 * 3. Fetch company names for all mentioned users (cached API calls)
 * 4. Replace [user_id] with clickable @CompanyName elements
 * 5. Convert newlines to &lt;br> tags
 *
 * Side Effects:
 * - Makes cached API calls to resolve company names
 * - Returns HTML with embedded click handlers
 *
 * @async
 * @param {string} text - Raw message text from API (may contain [user_id] mentions)
 * @returns {Promise&lt;string>} HTML string with mentions converted to clickable links
 *
 * @example
 * // Input: "Hey [123], check out the prices!"
 * // Output: 'Hey &lt;strong class="company-name" data-user-id="123">@CompanyName&lt;/strong>, check out the prices!'
 */
export async function parseMessageWithMentions(text) {
  let htmlMessage = escapeHtml(text);
  const mentionIdRegex = /\[(\d+)\]/g;

  let replacementPromises = [];

  const matches = [...htmlMessage.matchAll(mentionIdRegex)];
  matches.forEach(match => {
    const userId = parseInt(match[1]);
    replacementPromises.push(getCompanyNameCached(userId));
  });

  const resolvedNames = await Promise.all(replacementPromises);
  let i = 0;

  htmlMessage = htmlMessage.replace(mentionIdRegex, (match, userId) => {
    const companyName = resolvedNames[i++];
    return `&lt;strong class="company-name" data-user-id="${userId}" style="cursor:pointer;">@${escapeHtml(companyName)}&lt;/strong>`;
  });

  return htmlMessage.replace(/\n/g, '&lt;br>');
}

/**
 * Loads and displays alliance chat messages with intelligent duplicate filtering and notifications.
 * This is the core function called both on page load and via WebSocket updates every 25 seconds.
 *
 * Update Strategy:
 * - Fetches latest messages from API
 * - Filters out duplicates using type+timestamp+message comparison
 * - Only re-renders if new messages found
 * - Preserves scroll position unless user is at bottom
 * - Triggers desktop notifications for new messages (if window not focused)
 *
 * No Alliance Handling:
 * - Shows friendly message if user not in alliance
 * - Disables input controls
 * - Suggests using private messages instead
 *
 * Side Effects:
 * - Updates allMessages array
 * - Re-renders chat feed DOM
 * - May trigger desktop notifications
 * - Updates scroll position based on user behavior
 * - May disable input controls if no alliance
 *
 * @async
 * @param {HTMLElement} chatFeed - Chat container DOM element to render messages into
 * @returns {Promise&lt;void>}
 *
 * @example
 * // Called on page load and via WebSocket updates
 * const chatFeed = document.getElementById('chatFeed');
 * loadMessages(chatFeed);
 */
export async function loadMessages(chatFeed) {
  const isScrolledToBottom = chatFeed.scrollHeight - chatFeed.scrollTop - chatFeed.clientHeight &lt; 50;

  try {
    const data = await fetchChat();

    if (data.no_alliance) {
      // User not in alliance - show message immediately (no retry needed)
      chatFeed.innerHTML = `
        &lt;div class="empty-message" style="max-width: 500px; margin: 0 auto;">
          &lt;div style="font-size: 48px; margin-bottom: 20px;">&lt;/div>
          &lt;h2 style="color: #60a5fa; margin-bottom: 15px; font-size: 20px;">Ahoy Captain, You're not in an Alliance!&lt;/h2>
          &lt;p style="color: #9ca3af; line-height: 1.6;">
            Join an alliance to see the alliance chat here and communicate with your fellow shipping managers.
          &lt;/p>
          &lt;p style="color: #9ca3af; margin-top: 10px; font-size: 14px;">
            You can still use private messages via the  button above.
          &lt;/p>
        &lt;/div>
      `;
      const messageInput = document.getElementById('messageInput');
      const sendMessageBtn = document.getElementById('sendMessageBtn');
      messageInput.disabled = true;
      messageInput.placeholder = "Join an alliance to chat...";
      sendMessageBtn.disabled = true;
      return;
    }

    const newMessages = data.messages || data;

    const newOnly = newMessages.filter(msg =>
      !allMessages.some(existing =>
        existing.type === msg.type &amp;&amp; existing.timestamp === msg.timestamp &amp;&amp; existing.message === msg.message
      )
    );

    if (newOnly.length > 0 || allMessages.length === 0) {
      allMessages = newMessages;
      await displayMessages(allMessages, chatFeed);

      if (newOnly.length > 0) {
        handleNotifications(newOnly, data.lastReadTimestamp);
      }
    }

    if (isScrolledToBottom || autoScroll) {
      chatFeed.scrollTop = chatFeed.scrollHeight;
      autoScroll = false;
    }

    // Update unread badge using backend's unread count
    updateAllianceChatBadge(data.unreadCount);

  } catch (error) {
    console.error('Error loading messages:', error);
    if (allMessages.length === 0) {
      chatFeed.innerHTML = '&lt;div class="empty-message" style="color:#ef4444;">Could not connect to chat server.&lt;/div>';
    }
  }
}

/**
 * Updates the alliance chat badge with unread message count from backend.
 * Backend controls read tracking, client is just "dumb display".
 *
 * Why Backend Tracking:
 * - localStorage doesn't sync across devices/browsers
 * - Backend provides single source of truth
 * - Prevents duplicate notifications
 * - Read status syncs to all connected clients
 *
 * @param {number} unreadCount - Unread message count calculated by backend
 * @returns {void}
 */
function updateAllianceChatBadge(unreadCount) {
  const overlay = document.getElementById('allianceChatOverlay');

  if (!overlay) return;

  // If chat is open, hide badge (mark-read will be called on close)
  const isChatOpen = !overlay.classList.contains('hidden');
  if (isChatOpen) {
    updateBadge('allianceChatBadge', 0, false, 'RED');
    return;
  }

  // Chat is closed - use backend's unread count
  const displayCount = unreadCount > 99 ? 99 : unreadCount;
  updateBadge('allianceChatBadge', displayCount, unreadCount > 0, 'RED');
}

/**
 * Renders messages to the DOM with appropriate formatting for chat and feed types.
 * Handles asynchronous mention parsing and registers click events for company names.
 *
 * Message Types:
 * - 'chat': User messages with company name, timestamp, and parsed mentions
 * - 'feed': System events (member joins, route completions) with different styling
 *
 * Processing Flow:
 * 1. Check if messages array is empty
 * 2. Map each message to HTML promise (async mention parsing)
 * 3. Await all HTML promises in parallel
 * 4. Render all messages at once (prevents DOM thrashing)
 * 5. Register click events on company names for messenger integration
 *
 * Side Effects:
 * - Replaces entire chatFeed innerHTML
 * - Registers click event listeners on company names
 * - Shows "No messages yet" if array is empty
 *
 * @async
 * @param {Array&lt;Object>} messagesToDisplay - Array of message objects to render
 * @param {string} messagesToDisplay[].type - Message type: 'chat' or 'feed'
 * @param {HTMLElement} chatFeed - Container element to render messages into
 * @returns {Promise&lt;void>}
 */
export async function displayMessages(messagesToDisplay, chatFeed) {
  if (!messagesToDisplay || messagesToDisplay.length === 0) {
    chatFeed.innerHTML = '&lt;div class="empty-message">No messages yet&lt;/div>';
    return;
  }

  const messageHtmlPromises = messagesToDisplay.map(async msg => {
    if (msg.type === 'chat') {
      const userId = parseInt(msg.user_id);
      const parsedMessage = await parseMessageWithMentions(msg.message);

      return `
        &lt;div class="message">
          &lt;div class="message-header">
            &lt;span class="company-name" data-user-id="${userId}" style="cursor:pointer;">${escapeHtml(msg.company)}&lt;/span>
            &lt;span class="timestamp">${formatLocalTime(msg.timestamp)}&lt;/span>
          &lt;/div>
          &lt;div class="message-text">${parsedMessage}&lt;/div>
        &lt;/div>
      `;
    } else if (msg.type === 'feed') {
      return `
        &lt;div class="message feed">
          &lt;div class="message-header">
            &lt;span>SYSTEM: ${msg.feedType}&lt;/span>
            &lt;span class="timestamp">${formatLocalTime(msg.timestamp)}&lt;/span>
          &lt;/div>
          &lt;div class="message-text">${escapeHtml(msg.company)}&lt;/div>
        &lt;/div>
      `;
    }
  });

  const messageHtmls = await Promise.all(messageHtmlPromises);
  chatFeed.innerHTML = messageHtmls.join('');

  registerUsernameClickEvents();
}

/**
 * Sends a chat message to the alliance feed with validation and UI updates.
 * Handles the complete flow from user input to API submission and UI refresh.
 *
 * Validation:
 * - Trims whitespace
 * - Enforces 1-1000 character limit
 * - Prevents empty messages
 *
 * Processing Flow:
 * 1. Validate message content
 * 2. Disable input controls (prevents double-send)
 * 3. Submit to API
 * 4. Clear input and reset UI state
 * 5. Enable auto-scroll for new message
 * 6. Refresh chat after 500ms delay
 * 7. Re-enable controls
 *
 * Side Effects:
 * - Disables/enables message input and send button
 * - Clears message input on success
 * - Resets textarea height to auto
 * - Updates character count display
 * - Sets autoScroll flag to true
 * - Triggers chat reload after 500ms
 * - Shows success/error feedback
 *
 * @async
 * @param {HTMLTextAreaElement} messageInput - Textarea element for message input
 * @param {HTMLElement} charCount - Element showing character count
 * @param {HTMLButtonElement} sendMessageBtn - Send button element
 * @param {HTMLElement} chatFeed - Chat container for reloading messages
 * @returns {Promise&lt;void>}
 */
export async function sendMessage(messageInput, charCount, sendMessageBtn, chatFeed) {
  const message = messageInput.value.trim();
  if (!message || message.length > 1000) {
    showSideNotification('Invalid message length or content.', 'error');
    return;
  }

  sendMessageBtn.disabled = true;
  messageInput.disabled = true;

  try {
    await sendChatMessage(message);

    messageInput.value = '';
    messageInput.style.height = 'auto';
    charCount.textContent = '0 / 1000';
    showSideNotification('Message sent!', 'success');
    autoScroll = true;

    setTimeout(() => loadMessages(chatFeed), 500);
  } catch (error) {
    showSideNotification(`Error: ${error.message}`, 'error');
  } finally {
    sendMessageBtn.disabled = false;
    messageInput.disabled = false;
    handleMessageInput(messageInput, charCount);
  }
}

/**
 * Loads alliance members list for mention autocomplete functionality.
 * Fetches and caches the member list in module-level variable for autocomplete suggestions.
 *
 * @async
 * @returns {Promise&lt;Array&lt;{user_id: number, company_name: string}>>} Array of alliance members
 *
 * @example
 * // Called on chat initialization
 * const members = await loadAllianceMembers();
 * // members = [{ user_id: 123, company_name: "Company A" }, ...]
 */
export async function loadAllianceMembers() {
  allianceMembers = await fetchAllianceMembers();
  return allianceMembers;
}

/**
 * Handles message input changes including auto-resize, character count, and mention autocomplete.
 * Called on every input event in the message textarea.
 *
 * Features:
 * - Auto-resizes textarea up to 240px max height
 * - Updates character count with warning/error states
 * - Triggers mention autocomplete when "@" is typed
 *
 * Character Count States:
 * - Normal: 0-900 characters (default style)
 * - Warning: 901-1000 characters (yellow)
 * - Error: >1000 characters (red)
 *
 * Side Effects:
 * - Adjusts textarea height based on content
 * - Updates character count element text and style
 * - Triggers mention autocomplete overlay
 *
 * @param {HTMLTextAreaElement} messageInput - Message textarea element
 * @param {HTMLElement} charCount - Character count display element
 */
export function handleMessageInput(messageInput, charCount) {
  messageInput.style.height = 'auto';
  messageInput.style.height = Math.min(messageInput.scrollHeight, 240) + 'px';

  const currentLength = messageInput.value.length;
  charCount.textContent = `${currentLength} / 1000`;
  charCount.className = 'char-count';

  if (currentLength > 900) {
    charCount.classList.add(currentLength > 1000 ? 'error' : 'warning');
  }

  handleMentionAutocomplete(messageInput);
}

/**
 * Triggers mention autocomplete when user types @ symbol
 * @param {HTMLTextAreaElement} messageInput - Message textarea element
 */
function handleMentionAutocomplete(messageInput) {
  const text = messageInput.value;
  const match = text.match(/@([^\s\n]*)$/);
  if (match) {
    const query = match[1].toLowerCase();

    const filteredMembers = allianceMembers.filter(member =>
      member.company_name.toLowerCase().includes(query)
    ).slice(0, 10);

    displaySuggestions(filteredMembers, text.lastIndexOf('@'), messageInput);
  } else {
    hideMemberSuggestions();
  }
}

/**
 * Displays filtered alliance member suggestions below message input
 * @param {Array&lt;Object>} members - Filtered alliance members
 * @param {number} atIndex - Index position of @ symbol in text
 * @param {HTMLTextAreaElement} messageInput - Message textarea element
 */
function displaySuggestions(members, atIndex, messageInput) {
  let suggestionBox = document.getElementById('memberSuggestions');
  if (!suggestionBox) {
    suggestionBox = document.createElement('div');
    suggestionBox.id = 'memberSuggestions';
    suggestionBox.classList.add('hidden'); // Start hidden
    const inputWrapper = document.querySelector('.input-wrapper') || messageInput.parentElement;
    inputWrapper.appendChild(suggestionBox);
  }

  if (members.length === 0) {
    hideMemberSuggestions();
    return;
  }

  suggestionBox.innerHTML = members.map(member => `
    &lt;div class="member-suggestion" data-user-id="${member.user_id}" data-company="${escapeHtml(member.company_name)}">
      ${escapeHtml(member.company_name)}
    &lt;/div>
  `).join('');

  suggestionBox.querySelectorAll('.member-suggestion').forEach(item => {
    item.addEventListener('click', () => {
      insertMention(item.dataset.userId, atIndex, messageInput);
      hideMemberSuggestions();
    });
  });

  suggestionBox.classList.remove('hidden');
}

/**
 * Hides mention autocomplete suggestion box
 */
function hideMemberSuggestions() {
  const suggestionBox = document.getElementById('memberSuggestions');
  if (suggestionBox) {
    suggestionBox.classList.add('hidden');
  }
}

/**
 * Inserts selected user mention as [user_id] into message input
 * @param {string} userId - User ID to mention
 * @param {number} atIndex - Index position of @ symbol
 * @param {HTMLTextAreaElement} messageInput - Message textarea element
 */
function insertMention(userId, atIndex, messageInput) {
  const text = messageInput.value;
  const beforeAt = text.substring(0, atIndex);
  const newText = beforeAt + `[${userId}] ` + text.substring(text.length);

  messageInput.value = newText;
  messageInput.focus();
  const charCount = document.getElementById('charCount');
  handleMessageInput(messageInput, charCount);
}

/**
 * Registers click handlers on company names to open private messenger
 */
function registerUsernameClickEvents() {
  document.querySelectorAll('.company-name').forEach(nameElement => {
    const userId = parseInt(nameElement.dataset.userId);
    const companyName = nameElement.textContent.replace(/^@/, '');

    if (userId &amp;&amp; !nameElement.hasAttribute('data-has-click-handler')) {
      nameElement.setAttribute('data-has-click-handler', 'true');
      nameElement.addEventListener('click', () => {
        if (window.openMessengerFromChat) {
          window.openMessengerFromChat(companyName, userId);
        }
      });
    }
  });
}

/**
 * Handles backend auto-repair completion events from WebSocket.
 * Displays notification with vessel wear percentages and threshold info.
 *
 * The backend (server/automation.js) broadcasts 'auto_repair_complete' events
 * after successfully repairing vessels. This handler:
 * - Shows in-app feedback notification
 * - Displays individual vessel wear percentages
 * - Shows maintenance threshold from settings
 * - Sends browser notification if enabled
 * - Triggers UI updates for vessel and cash displays
 *
 * @param {Object} data - Repair completion data from backend
 * @param {number} data.count - Number of vessels repaired
 * @param {number} data.totalCost - Total repair cost
 * @param {Array&lt;Object>} data.repairs - Array of repair details per vessel
 * @param {string} data.repairs[].name - Vessel name
 * @param {number} data.repairs[].wear - Vessel wear percentage
 * @param {number} data.repairs[].cost - Repair cost for this vessel
 * @param {string} data.message - Formatted message for display
 */
function handleBackendAutoRepairComplete(data) {
  const { count, totalCost, repairs } = data;

  // Get current settings for threshold
  const settings = window.getSettings ? window.getSettings() : {};
  const threshold = settings.maintenanceThreshold !== undefined ? settings.maintenanceThreshold : 10;

  // Build detailed feedback message
  let feedbackMsg = ` Yard Foreman: ${count} vessel(s) repaired for $${totalCost.toLocaleString()}`;
  if (repairs &amp;&amp; repairs.length > 0) {
    feedbackMsg += '\n\nRepaired vessels:';
    repairs.forEach(repair => {
      feedbackMsg += `\n ${repair.name}: ${repair.wear}% wear  $${repair.cost.toLocaleString()}`;
    });
    feedbackMsg += `\n\n(Threshold: ${threshold}%)`;
  }

  // Show in-app notification
  showSideNotification(feedbackMsg, 'success');

  // Send browser notification if enabled
  const desktopNotifsEnabled = settings.enableDesktopNotifications !== undefined ? settings.enableDesktopNotifications : true;
  if (desktopNotifsEnabled &amp;&amp; Notification.permission === 'granted') {
    showNotification(' Yard Foreman', {
      body: `

${count} vessel${count > 1 ? 's' : ''} repaired

 Cost: $${totalCost.toLocaleString()}

Threshold: ${threshold}%`,
      icon: '/favicon.ico',
      tag: 'yard-foreman',
      silent: false
    });
  }

  // Trigger UI updates
  if (window.debouncedUpdateRepairCount) {
    window.debouncedUpdateRepairCount(500);
  }
  if (window.debouncedUpdateBunkerStatus) {
    window.debouncedUpdateBunkerStatus(500);
  }
}

// WebSocket connection tracking
let ws = null;
let reconnectAttempts = 0;
const MAX_RECONNECT_DELAY = 30000; // Max 30 seconds between reconnect attempts

/**
 * Initializes WebSocket connection for real-time chat updates.
 * Establishes WSS connection and handles incoming message broadcasts from server.
 *
 * WebSocket Message Types:
 * - 'chat_update': Server broadcasts new messages every 25 seconds
 * - 'message_sent': Immediate update when any user sends a message
 * - 'settings_update': Broadcasts when settings change (triggers global callback)
 * - 'auto_repair_complete': Backend auto-repair completion notification
 *
 * Connection Strategy:
 * - Uses WSS for HTTPS pages, WS for HTTP
 * - Connects to same host as the page
 * - Automatically reconnects on disconnect with exponential backoff
 * - Fails silently if WebSocket not available
 *
 * Reconnect Logic:
 * - First reconnect: immediate
 * - Subsequent reconnects: exponential backoff (1s, 2s, 4s, 8s, ... up to 30s)
 * - Resets reconnect counter on successful connection
 *
 * Side Effects:
 * - Creates WebSocket connection
 * - Registers onmessage, onopen, onclose, onerror event handlers
 * - Triggers loadMessages() on chat updates
 * - Calls global handleSettingsUpdate() callback if available
 * - Calls handleBackendAutoRepairComplete() for repair events
 *
 * @example
 * // Called once on page load
 * initWebSocket();
 * // Server broadcasts every 25 seconds: { type: 'chat_update', data: [...messages] }
 */
export function initWebSocket() {
  try {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${protocol}//${window.location.host}`);
    const chatFeed = document.getElementById('chatFeed');

    ws.onopen = async () => {
      console.log('[WebSocket] Connected');
      reconnectAttempts = 0; // Reset reconnect counter on successful connection

      // Hide connection lost overlay
      const overlay = document.getElementById('connectionLostOverlay');
      if (overlay) {
        overlay.classList.add('hidden');
      }

      // CRITICAL: Check for account switch on reconnect (e.g., server restarted with different account)
      // If browser tab stayed open but server switched accounts, we need to reload the page
      try {
        const settingsResponse = await fetch('/api/settings');
        if (settingsResponse.ok) {
          const settings = await settingsResponse.json();
          const currentUserId = window.USER_STORAGE_PREFIX; // Set during initial page load
          const newUserId = settings.userId;

          // Account changed - reload page to get fresh DOM
          if (currentUserId &amp;&amp; currentUserId !== newUserId) {
            console.log(`[WebSocket Reconnect] Account changed from ${currentUserId} to ${newUserId} - reloading page`);
            // Force hard reload to bypass cache and get fresh data
            window.location.reload(true);
            return;
          }

          // Even if userId is same, check if this is first reconnect after server restart
          // Server might have restarted but with same account - still need to refresh data
          if (reconnectAttempts === 1) {
            console.log('[WebSocket Reconnect] First reconnect after disconnect - checking for server restart');
            // Trigger a settings reload to ensure we have latest campaign data
            if (window.handleSettingsUpdate) {
              const userSettingsResponse = await fetch('/api/user/get-settings');
              if (userSettingsResponse.ok) {
                const userSettings = await userSettingsResponse.json();
                // This will update campaigns, tanker-ops, etc.
                window.handleSettingsUpdate(userSettings);
              }
            }
          }
        }
      } catch (error) {
        console.error('[WebSocket Reconnect] Failed to check account switch:', error);
      }
    };

    ws.onmessage = (event) => {
      const { type, data } = JSON.parse(event.data);
      if (type === 'chat_update' || type === 'message_sent') {
        loadMessages(chatFeed);
        // Reload alliance members for @mention autocomplete (in case new member joined)
        loadAllianceMembers();
      } else if (type === 'settings_update') {
        if (window.handleSettingsUpdate) {
          window.handleSettingsUpdate(data);
        }
      } else if (type === 'auto_repair_complete') {
        handleBackendAutoRepairComplete(data);
      } else if (type === 'price_update') {
        handlePriceUpdate(data);
      } else if (type === 'price_alert') {
        handlePriceAlert(data);
      } else if (type === 'fuel_purchased') {
        handleFuelPurchased(data);
      } else if (type === 'co2_purchased') {
        handleCO2Purchased(data);
      } else if (type === 'autopilot_depart_start') {
        handleAutopilotDepartStart(data);
      } else if (type === 'vessels_depart_batch') {
        handleVesselsDepartBatch(data);
      } else if (type === 'vessels_depart_complete') {
        handleVesselsDepartComplete(data);
      } else if (type === 'vessels_departed') {
        handleVesselsDeparted(data);
      } else if (type === 'vessels_failed') {
        handleVesselsFailed(data);
      } else if (type === 'vessels_repaired') {
        handleVesselsRepaired(data);
      } else if (type === 'vessels_drydocked') {
        handleVesselsDrydocked(data);
      } else if (type === 'campaigns_renewed') {
        handleCampaignsRenewed(data);
      } else if (type === 'auto_coop_complete') {
        handleAutoCoopComplete(data);
      } else if (type === 'auto_coop_no_targets') {
        handleAutoCoopNoTargets(data);
      } else if (type === 'bunker_update') {
        handleBunkerUpdate(data);
      } else if (type === 'vessel_count_update') {
        handleVesselCountUpdate(data);
      } else if (type === 'harbor_map_refresh_required') {
        handleHarborMapRefreshRequired(data);
      } else if (type === 'repair_count_update') {
        handleRepairCountUpdate(data);
      } else if (type === 'drydock_count_update') {
        handleDrydockCountUpdate(data);
      } else if (type === 'campaign_status_update') {
        handleCampaignStatusUpdate(data);
      } else if (type === 'unread_messages_update') {
        handleUnreadMessagesUpdate(data);
      } else if (type === 'messenger_update') {
        // Update messenger badge from 10-second polling
        handleMessengerUpdate(data);
      } else if (type === 'autopilot_status') {
        // Call global function to update pause/play button
        if (window.onAutopilotStatusUpdate) {
          window.onAutopilotStatusUpdate(data);
        }
      } else if (type === 'hijacking_update') {
        handleHijackingUpdate(data);
      } else if (type === 'notification') {
        // Generic notification from backend (e.g., errors, warnings, info)
        handleGenericNotification(data);
      } else if (type === 'user_action_notification') {
        handleUserActionNotification(data);
      } else if (type === 'coop_update') {
        handleCoopUpdate(data);
      } else if (type === 'company_type_update') {
        handleCompanyTypeUpdate(data);
      } else if (type === 'header_data_update') {
        handleHeaderDataUpdate(data);
      } else if (type === 'event_data_update') {
        handleEventDataUpdate(data);
      } else if (type === 'logbook_update') {
        // Logbook entry update (new autopilot action logged)
        if (window.handleLogbookUpdate) {
          window.handleLogbookUpdate(data);
        }
      } else if (type === 'all_data_updated') {
        // Show summary line with all current values (only in summary mode)
        if (AUTOPILOT_LOG_LEVEL === 'summary' || AUTOPILOT_LOG_LEVEL === 'detailed') {
          const c = updateDataCache;
          const stockTrend = c.stock.trend === 'up' ? '' : c.stock.trend === 'down' ? '' : '';
          const cashStr = (c.bunker.cash / 1000000).toFixed(1);
          console.log(`[Autopilot] Update: Ready=${c.vessels.ready}, Anchor=${c.vessels.anchor}, Pending=${c.vessels.pending}, Repair=${c.repair}, Campaigns=${c.campaigns}, Messages=${c.messages}, Fuel=${Math.floor(c.bunker.fuel)}t, CO2=${Math.floor(c.bunker.co2)}t, Cash=$${cashStr}M, Points=${c.bunker.points}, Stock=${c.stock.value.toFixed(2)}${stockTrend}, COOP=${c.coop.available}/${c.coop.cap}`);
        }
      } else if (type === 'repair_start') {
        lockRepairButton();
      } else if (type === 'repair_complete') {
        unlockRepairButton();
      } else if (type === 'bulk_buy_start') {
        lockBulkBuyButton();
      } else if (type === 'bulk_buy_complete') {
        unlockBulkBuyButton();
      } else if (type === 'coop_send_start') {
        lockCoopButtons();
      } else if (type === 'coop_send_complete') {
        unlockCoopButtons();
      } else if (type === 'anchor_purchase_timer') {
        showAnchorTimer(data.anchor_next_build, data.pending_amount);
      } else if (type === 'fuel_purchase_start') {
        lockFuelButton();
      } else if (type === 'fuel_purchase_complete') {
        unlockFuelButton();
      } else if (type === 'co2_purchase_start') {
        lockCo2Button();
      } else if (type === 'co2_purchase_complete') {
        unlockCo2Button();
      } else if (type === 'drydock_start') {
        lockDrydockButton();
      } else if (type === 'drydock_complete') {
        unlockDrydockButton();
      } else if (type === 'lock_status') {
        // Server-controlled lock state update (single source of truth)
        // Updates client's READ-ONLY lock state from server
        updateLockStateFromServer(data);
      }
    };

    ws.onclose = () => {
      console.log('[WebSocket] Disconnected');
      attemptReconnect();
    };

    ws.onerror = (error) => {
      console.error('[WebSocket] Error:', error);
      ws.close(); // Trigger onclose which will attempt reconnect
    };

  } catch (e) {
    console.error('[WebSocket] Failed to initialize:', e);
    attemptReconnect();
  }
}

/**
 * Attempts to reconnect WebSocket with exponential backoff.
 * Delay increases exponentially: 0ms, 1s, 2s, 4s, 8s, 16s, 30s (max)
 * Shows connection lost overlay after 3 failed attempts.
 */
function attemptReconnect() {
  reconnectAttempts++;

  // Show connection lost overlay after 3 failed attempts
  if (reconnectAttempts >= 3) {
    const overlay = document.getElementById('connectionLostOverlay');
    if (overlay) {
      overlay.classList.remove('hidden');
    }
  }

  // Calculate delay with exponential backoff (capped at MAX_RECONNECT_DELAY)
  const delay = Math.min(
    reconnectAttempts === 1 ? 0 : Math.pow(2, reconnectAttempts - 2) * 1000,
    MAX_RECONNECT_DELAY
  );

  console.log(`[WebSocket] Reconnecting in ${delay / 1000}s (attempt ${reconnectAttempts})`);

  setTimeout(() => {
    console.log('[WebSocket] Attempting reconnect...');
    initWebSocket();
  }, delay);
}

/**
 * Sets up scroll event listener to manage auto-scroll behavior intelligently.
 * Detects when user is near the bottom of chat to enable automatic scrolling for new messages.
 *
 * Auto-Scroll Logic:
 * - Enabled when user is within 50px of bottom
 * - Disabled when user scrolls up to read history
 * - Prevents forced scrolling while user is browsing old messages
 *
 * This provides a good UX where new messages automatically scroll into view when user
 * is already at the bottom, but doesn't interrupt reading when scrolled up.
 *
 * Side Effects:
 * - Registers scroll event listener on chat feed
 * - Updates module-level autoScroll flag
 *
 * @param {HTMLElement} chatFeed - Chat container element to monitor
 *
 * @example
 * // Called once on page load
 * const chatFeed = document.getElementById('chatFeed');
 * setChatScrollListener(chatFeed);
 */
export function setChatScrollListener(chatFeed) {
  chatFeed.addEventListener('scroll', () => {
    autoScroll = chatFeed.scrollHeight - chatFeed.scrollTop - chatFeed.clientHeight &lt; 50;
  });
}

// ============================================================================
// Backend Autopilot Event Handlers
// ============================================================================

/**
 * Log level for autopilot events
 * 'off' = No autopilot logs (production mode)
 * 'summary' = Only show summary line when all data updated
 * 'detailed' = Show individual events (price changes, actions, etc.)
 */
const AUTOPILOT_LOG_LEVEL = 'off'; // Change to 'summary' or 'detailed' for debug logs

/**
 * Cache for collecting update data to display in summary
 */
const updateDataCache = {
  vessels: { ready: 0, anchor: 0, pending: 0 },
  repair: 0,
  campaigns: 0,
  messages: 0,
  bunker: { fuel: 0, co2: 0, cash: 0, points: 0 },
  prices: { fuel: 0, co2: 0 },
  coop: { available: 0, cap: 0 },
  stock: { value: 0, trend: '' },
  anchor: { available: 0, max: 0 }
};

// Export to window for access from other modules (e.g., anchor purchase dialog)
window.updateDataCache = updateDataCache;

/**
 * Handles price updates from backend autopilot.
 * Prices are displayed in bunker management module.
 * Note: Bunker state (fuel/CO2/cash) comes separately via bunker_update event.
 */
function handlePriceUpdate(data) {
  const { fuel, co2, eventDiscount, regularFuel, regularCO2 } = data;
  updateDataCache.prices = { fuel, co2, eventDiscount, regularFuel, regularCO2 };

  if (AUTOPILOT_LOG_LEVEL === 'detailed') {
    if (eventDiscount) {
      console.log(`[Autopilot] EVENT: ${eventDiscount.percentage}% off ${eventDiscount.type} - Fuel=$${fuel}/t (was $${regularFuel}/t), CO2=$${co2}/t (was $${regularCO2}/t)`);
    } else {
      console.log(`[Autopilot] Price update: Fuel=$${fuel}/t, CO2=$${co2}/t`);
    }
  }

  // Update bunker module price displays
  const fuelPrice = document.getElementById('fuelPrice');
  if (fuelPrice) {
    fuelPrice.textContent = `$${fuel}/t`;
  }

  const co2Price = document.getElementById('co2Price');
  if (co2Price) {
    co2Price.textContent = `$${co2}/t`;
  }

  // Update header price displays with color classes
  const fuelPriceDisplay = document.getElementById('fuelPriceDisplay');
  // Only update if we have a valid price (> 0), otherwise keep last known value
  if (fuelPriceDisplay &amp;&amp; fuel !== undefined &amp;&amp; fuel > 0) {
    // Build price text with optional discount badge
    let priceText = `$${fuel}/t`;
    if (eventDiscount &amp;&amp; eventDiscount.type === 'fuel') {
      priceText += ` &lt;span class="discount-badge">-${eventDiscount.percentage}%&lt;/span>`;
    }
    fuelPriceDisplay.innerHTML = priceText;

    // Apply forecast color classes
    fuelPriceDisplay.className = ''; // Clear existing classes

    // Get settings if available
    const settings = window.getSettings ? window.getSettings() : null;

    // Check if below alert threshold (pulse animation)
    if (settings &amp;&amp; settings.fuelThreshold &amp;&amp; fuel &lt; settings.fuelThreshold) {
      fuelPriceDisplay.className = 'price-pulse-alert';
    } else {
      // Apply standard color based on price ranges
      if (fuel >= 800) {
        fuelPriceDisplay.className = 'fuel-red';
      } else if (fuel >= 600) {
        fuelPriceDisplay.className = 'fuel-orange';
      } else if (fuel >= 400) {
        fuelPriceDisplay.className = 'fuel-blue';
      } else if (fuel >= 1) {
        fuelPriceDisplay.className = 'fuel-green';
      }
    }
  }

  const co2PriceDisplay = document.getElementById('co2PriceDisplay');
  // Only update if we have a VALID price from API (not 0, not undefined, not null)
  // If invalid, keep the last known cached value - DO NOT show fake values
  if (co2PriceDisplay &amp;&amp; co2 !== undefined &amp;&amp; co2 !== null &amp;&amp; co2 !== 0) {
    // Build price text with optional discount badge
    let priceText = `$${co2}/t`;
    if (eventDiscount &amp;&amp; eventDiscount.type === 'co2') {
      priceText += ` &lt;span class="discount-badge">-${eventDiscount.percentage}%&lt;/span>`;
    }
    co2PriceDisplay.innerHTML = priceText;

    // Apply forecast color classes
    co2PriceDisplay.className = ''; // Clear existing classes

    // Get settings if available
    const settings = window.getSettings ? window.getSettings() : null;

    // Special styling for negative prices (you get paid!)
    // Note: co2 can never be 0 here due to outer check, only negative
    if (co2 &lt; 0) {
      co2PriceDisplay.className = 'co2-negative';
    } else if (settings &amp;&amp; settings.co2Threshold &amp;&amp; co2 &lt; settings.co2Threshold) {
      // Check if below alert threshold (pulse animation)
      co2PriceDisplay.className = 'price-pulse-alert';
    } else {
      // Apply standard color based on price ranges
      if (co2 >= 20) {
        co2PriceDisplay.className = 'co2-red';
      } else if (co2 >= 15) {
        co2PriceDisplay.className = 'co2-orange';
      } else if (co2 >= 10) {
        co2PriceDisplay.className = 'co2-blue';
      } else if (co2 >= 1) {
        co2PriceDisplay.className = 'co2-green';
      }
    }
  }

  // Update forecast with event discount and full event data
  if (eventDiscount) {
    updateEventDiscount(eventDiscount, cachedEventData);
  } else {
    updateEventDiscount(null, null);
  }

  // Cache prices AND event discount for next page load - only if valid
  if (window.saveBadgeCache &amp;&amp; fuel > 0 &amp;&amp; co2 > 0) {
    window.saveBadgeCache({
      prices: {
        fuelPrice: fuel,
        co2Price: co2,
        eventDiscount: eventDiscount,
        regularFuel: regularFuel,
        regularCO2: regularCO2
      }
    });
  }
}

/**
 * Handles price alerts from backend autopilot.
 * Shows center alert with spin animation and desktop notification.
 */
async function handlePriceAlert(data) {
  const { type, price, threshold } = data;
  const emoji = type === 'fuel' ? '' : '';
  const label = type === 'fuel' ? 'Fuel' : 'CO2';

  console.log(`[Autopilot] Price alert: ${label} = $${price}/t (threshold: $${threshold}/t)`);

  // Show center alert (existing price alert mechanism)
  if (window.showPriceAlert) {
    window.showPriceAlert({ type, price, threshold });
  }

  // Show desktop notification
  const settings = window.getSettings ? window.getSettings() : {};
  console.log('[Autopilot] Desktop notification check:', {
    hasSettings: !!window.getSettings,
    enableDesktopNotifications: settings.enableDesktopNotifications,
    notificationPermission: Notification.permission,
    willShow: settings.enableDesktopNotifications &amp;&amp; Notification.permission === 'granted'
  });

  if (settings.enableDesktopNotifications &amp;&amp; Notification.permission === 'granted') {
    await showNotification(`${emoji} ${label} Price Alert`, {
      body: `

Price dropped to $${price}/t

Threshold: $${threshold}/t`,
      icon: '/favicon.ico',
      tag: `price-alert-${type}`,
      silent: false
    });
  }

  // Show side notification
  showSideNotification(`${emoji} &lt;strong>${label} Price Alert!&lt;/strong>&lt;br>&lt;br>New price now $${price}/t`, 'success', null, true);
}

/**
 * Handles fuel purchased event from backend autopilot.
 * Shows notification and updates bunker display.
 */
async function handleFuelPurchased(data) {
  const { amount, price, newTotal, cost } = data;

  console.log(`[Autopilot] Fuel purchased: ${amount}t @ $${price}/t = $${Math.round(cost).toLocaleString()} (new total: ${newTotal.toFixed(1)}t)`);

  const settings = window.getSettings ? window.getSettings() : {};

  // In-app alert
  if (settings.autoPilotNotifications &amp;&amp; settings.notifyBarrelBossInApp) {
    showSideNotification(`
      &lt;div style="margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid rgba(255,255,255,0.3);">
        &lt;strong style="font-size: 1.1em;"> Barrel Boss&lt;/strong>
      &lt;/div>
      &lt;div style="font-family: monospace; font-size: 13px;">
        &lt;div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
          &lt;span>Amount:&lt;/span>
          &lt;span>&lt;strong>${amount.toFixed(0)}t&lt;/strong>&lt;/span>
        &lt;/div>
        &lt;div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
          &lt;span>Price per ton:&lt;/span>
          &lt;span>$${price.toLocaleString()}/t&lt;/span>
        &lt;/div>
        &lt;div style="height: 1px; background: rgba(255,255,255,0.2); margin: 10px 0;">&lt;/div>
        &lt;div style="display: flex; justify-content: space-between; font-size: 15px;">
          &lt;span>&lt;strong>Total Cost:&lt;/strong>&lt;/span>
          &lt;span style="color: #ef4444;">&lt;strong>$${Math.round(cost).toLocaleString()}&lt;/strong>&lt;/span>
        &lt;/div>
      &lt;/div>
    `, 'success');
  }

  // Desktop notification
  if (settings.autoPilotNotifications &amp;&amp; settings.notifyBarrelBossDesktop &amp;&amp; Notification.permission === 'granted') {
    await showNotification(' Barrel Boss', {
      body: `

${formatNumber(amount)}t @ $${price}/t

 Total: $${Math.round(cost).toLocaleString()}`,
      icon: '/favicon.ico',
      tag: 'barrel-boss',
      silent: false
    });
  }

  // Note: Bunker update comes automatically via bunker_update event from backend
}

/**
 * Handles CO2 purchased event from backend autopilot.
 * Shows notification and updates bunker display.
 */
async function handleCO2Purchased(data) {
  const { amount, price, newTotal, cost } = data;

  console.log(`[Autopilot] CO2 purchased: ${amount}t @ $${price}/t = $${Math.round(cost).toLocaleString()} (new total: ${newTotal.toFixed(1)}t)`);

  const settings = window.getSettings ? window.getSettings() : {};

  // In-app alert
  if (settings.autoPilotNotifications &amp;&amp; settings.notifyAtmosphereBrokerInApp) {
    showSideNotification(`
      &lt;div style="margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid rgba(255,255,255,0.3);">
        &lt;strong style="font-size: 1.1em;"> Atmosphere Broker&lt;/strong>
      &lt;/div>
      &lt;div style="font-family: monospace; font-size: 13px;">
        &lt;div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
          &lt;span>Amount:&lt;/span>
          &lt;span>&lt;strong>${amount.toFixed(0)}t&lt;/strong>&lt;/span>
        &lt;/div>
        &lt;div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
          &lt;span>Price per ton:&lt;/span>
          &lt;span>$${price.toLocaleString()}/t&lt;/span>
        &lt;/div>
        &lt;div style="height: 1px; background: rgba(255,255,255,0.2); margin: 10px 0;">&lt;/div>
        &lt;div style="display: flex; justify-content: space-between; font-size: 15px;">
          &lt;span>&lt;strong>Total Cost:&lt;/strong>&lt;/span>
          &lt;span style="color: #ef4444;">&lt;strong>$${Math.round(cost).toLocaleString()}&lt;/strong>&lt;/span>
        &lt;/div>
      &lt;/div>
    `, 'success');
  }

  // Desktop notification
  if (settings.autoPilotNotifications &amp;&amp; settings.notifyAtmosphereBrokerDesktop &amp;&amp; Notification.permission === 'granted') {
    await showNotification(' Atmosphere Broker', {
      body: `

${formatNumber(amount)}t @ $${price}/t

 Total: $${Math.round(cost).toLocaleString()}`,
      icon: '/favicon.ico',
      tag: 'atmosphere-broker',
      silent: false
    });
  }

  // Note: Bunker update comes automatically via bunker_update event from backend
}

/**
 * Handles batch departure updates (does NOT unlock button).
 * Shows notifications for each 20-vessel batch during multi-batch departures.
 */
async function handleVesselsDepartBatch(data) {
  const { succeeded } = data;

  console.log(`[Autopilot] Batch update: ${succeeded.count} departed in this batch`);

  // Note: NO notification for batch updates to avoid spam
  // Bunker state is updated via separate 'bunker_update' event from backend
  // Only the final 'vessels_depart_complete' event shows notification
}

/**
 * Handles combined vessels depart complete event from backend autopilot.
 * Shows a single notification with both succeeded and failed vessels.
 * Unlocks the depart button after all batches complete.
 */
async function handleVesselsDepartComplete(data) {
  const { succeeded, failed, bunker } = data;

  console.log(`[Autopilot] Depart complete: ${succeeded.count} succeeded, ${failed.count} failed`);

  // Log vessel details
  if (succeeded.vessels &amp;&amp; succeeded.vessels.length > 0) {
    succeeded.vessels.forEach(v => {
      console.log(`[Vessel Depart] ${v.name}: income=$${v.income}, harborFee=$${v.harborFee}`);
      const profitability = v.income - v.harborFee;
      if (profitability &lt; 0) {
        console.warn(`[HIGH HARBOR FEE] ${v.name}: Harbor fee exceeds income by $${Math.abs(profitability)}`);
      }
    });
  }

  // Build header based on outcome
  let headerIcon = '';
  let headerText = '';

  if (succeeded.count > 0 &amp;&amp; failed.count === 0) {
    // All succeeded
    headerIcon = '';
    headerText = ` Cargo Marshal`;
  } else if (succeeded.count === 0 &amp;&amp; failed.count > 0) {
    // All failed
    headerIcon = '';
    headerText = ` Cargo Marshal&lt;br>&lt;u>${failed.count} vessel${failed.count > 1 ? 's' : ''} could not depart&lt;/u>`;
  } else {
    // Mixed results
    headerIcon = '';
    headerText = ` Cargo Marshal&lt;br>&lt;u>${succeeded.count} departed, ${failed.count} failed&lt;/u>`;
  }

  // Build success section
  let successSection = '';
  if (succeeded.count > 0) {
    const settings = window.getSettings ? window.getSettings() : {};
    const harborFeeThreshold = settings.harborFeeWarningThreshold;
    const totalHarborFees = succeeded.vessels.reduce((sum, v) => sum + (v.harborFee || 0), 0);

    // Check for high harbor fee vessels (only if threshold is set)
    const highFeeCount = harborFeeThreshold ? succeeded.vessels.filter(v => {
      const feePercentage = (v.harborFee / v.income) * 100;
      return feePercentage > harborFeeThreshold;
    }).length : 0;

    const vesselList = succeeded.vessels.map(v => {
      const feePercentage = Math.round((v.harborFee / v.income) * 100);
      const isHighFee = harborFeeThreshold &amp;&amp; feePercentage > harborFeeThreshold;
      const warningIcon = isHighFee ? '' : '';

      return `&lt;div style="font-size: 0.8em; opacity: 0.85; padding: 4px 6px; border-bottom: 1px solid rgba(255,255,255,0.08);">
        &lt;div>${warningIcon} &lt;strong>${v.name}&lt;/strong> |  $${formatNumber(v.income)}&lt;/div>
        &lt;div style="font-size: 0.9em; color: #9ca3af; margin-top: 2px;">
          Utilization: ${formatNumber(v.cargoLoaded)}/${formatNumber(v.capacity)} TEU (${(v.utilization * 100).toFixed(0)}%)
        &lt;/div>
        &lt;div style="font-size: 0.9em; color: ${isHighFee ? '#f59e0b' : '#9ca3af'}; margin-top: 2px;">
          ${isHighFee ? ' ' : ''}Harbor fee: ${feePercentage}% ($${formatNumber(v.harborFee)})
        &lt;/div>
      &lt;/div>`;
    }).join('');

    const harborFeeLabel = highFeeCount > 0 ? ' Harbor Fees (total):' : 'Harbor Fees (total):';
    const vesselDepartedLabel = highFeeCount > 0
      ? ` ${succeeded.count} vessel${succeeded.count > 1 ? 's' : ''} departed (${highFeeCount} )`
      : ` ${succeeded.count} vessel${succeeded.count > 1 ? 's' : ''} departed`;

    successSection = `
      &lt;div class="notification-summary-box">
        &lt;div style="color: #4ade80; font-weight: bold; margin-bottom: 8px;">${vesselDepartedLabel}&lt;/div>
        &lt;div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
          &lt;span style="color: #9ca3af;">Net Profit:&lt;/span>
          &lt;span style="color: #4ade80; font-weight: bold;">$${formatNumber(succeeded.totalIncome)}&lt;/span>
        &lt;/div>
        &lt;div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
          &lt;span style="color: ${highFeeCount > 0 ? '#f59e0b' : '#9ca3af'};">${harborFeeLabel}&lt;/span>
          &lt;span style="color: #9ca3af;">$${formatNumber(totalHarborFees)}&lt;/span>
        &lt;/div>
        &lt;div style="margin-top: 4px;">&lt;/div>
        &lt;div style="display: flex; justify-content: space-between; font-size: 0.9em; color: #9ca3af;">
          &lt;span>Used  Fuel:&lt;/span>
          &lt;span>${formatNumber(succeeded.totalFuelUsed)}t&lt;/span>
        &lt;/div>
        &lt;div style="display: flex; justify-content: space-between; font-size: 0.9em; color: #9ca3af; margin-top: 2px;">
          &lt;span>Used  CO2:&lt;/span>
          &lt;span>${formatNumber(succeeded.totalCO2Used)}t&lt;/span>
        &lt;/div>
      &lt;/div>
      &lt;div style="margin: 12px 0; border-top: 1px solid rgba(255,255,255,0.2);">&lt;/div>
      &lt;div class="notification-vessel-list">
        ${vesselList}
      &lt;/div>`;
  }

  // Build failure section
  let failureSection = '';
  if (failed.count > 0) {
    const failedList = failed.vessels.map(v => {
      const cleanName = v.name.replace(/^(MV|MS|MT|SS)\s+/i, '');
      return `&lt;div style="font-size: 0.85em; opacity: 0.85; padding: 4px 6px; border-bottom: 1px solid rgba(255,255,255,0.08);">
         &lt;strong>${cleanName}&lt;/strong> &lt;span style="color: #ef4444;">${v.reason}&lt;/span>
      &lt;/div>`;
    }).join('');

    const bunkerInfo = bunker ? `
      &lt;div style="margin: 8px 0; padding: 8px; background: rgba(0,0,0,0.15); border-radius: 4px; font-size: 0.85em;">
        &lt;div style="color: #9ca3af; margin-bottom: 4px;">Current bunker:&lt;/div>
        &lt;div style="display: flex; justify-content: space-between;">
          &lt;span style="color: #9ca3af;"> Fuel:&lt;/span>
          &lt;span style="color: #fff;">${formatNumber(Math.floor(bunker.fuel))} t&lt;/span>
        &lt;/div>
        &lt;div style="display: flex; justify-content: space-between;">
          &lt;span style="color: #9ca3af;"> CO2:&lt;/span>
          &lt;span style="color: #fff;">${formatNumber(Math.floor(bunker.co2))} t&lt;/span>
        &lt;/div>
      &lt;/div>` : '';

    failureSection = `
      &lt;div class="notification-summary-box" style="background: rgba(239,68,68,0.1); border-left: 3px solid #ef4444;">
        &lt;div style="color: #ef4444; font-weight: bold; margin-bottom: 8px;"> ${failed.count} vessel${failed.count > 1 ? 's' : ''} could not depart&lt;/div>
        ${bunkerInfo}
        &lt;div style="margin-top: 8px;">
          ${failedList}
        &lt;/div>
      &lt;/div>`;
  }

  const message = `
    &lt;div style="margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid rgba(255,255,255,0.3);">
      &lt;strong style="font-size: 1.1em;">${headerIcon} ${headerText}&lt;/strong>
    &lt;/div>
    ${successSection}
    ${failureSection}`;

  // Determine notification type based on outcome
  const notificationType = succeeded.count > 0 ? 'success' : 'warning';

  // In-app notification
  const settings = window.getSettings ? window.getSettings() : {};
  if (settings.autoPilotNotifications &amp;&amp; settings.notifyCargoMarshalInApp) {
    showSideNotification(message, notificationType, 15000);
  }

  // Desktop notification - moved to after harbor fee calculation to merge both notifications
  // (See below after harbor fee section)

  // Separate Harbor Fee Warning Notification (only if threshold is set)
  if (succeeded.count > 0 &amp;&amp; settings.harborFeeWarningThreshold) {
    const harborFeeThreshold = settings.harborFeeWarningThreshold;
    const highFeeVessels = succeeded.vessels.filter(v => {
      const grossIncome = v.income + v.harborFee;
      const feePercentage = (v.harborFee / grossIncome) * 100;
      return feePercentage > harborFeeThreshold;
    });

    if (highFeeVessels.length > 0) {
      const totalHarborFees = succeeded.vessels.reduce((sum, v) => sum + (v.harborFee || 0), 0);
      const highFeeList = highFeeVessels.map(v => {
        const grossIncome = v.income + v.harborFee;
        const feePercentage = Math.round((v.harborFee / grossIncome) * 100);
        return `&lt;div style="font-size: 0.8em; opacity: 0.85; padding: 4px 6px; border-bottom: 1px solid rgba(255,255,255,0.08);">
          &lt;div> &lt;strong>${v.name}&lt;/strong> |  $${formatNumber(v.income)}&lt;/div>
          &lt;div style="font-size: 0.9em; color: #9ca3af; margin-top: 2px;">
            Utilization: ${formatNumber(v.cargoLoaded)}/${formatNumber(v.capacity)} TEU (${(v.utilization * 100).toFixed(0)}%)
          &lt;/div>
          &lt;div style="font-size: 0.9em; color: #f59e0b; margin-top: 2px;">
             Harbor fee: ${feePercentage}% ($${formatNumber(v.harborFee)})
          &lt;/div>
        &lt;/div>`;
      }).join('');

      const warningMessage = `
        &lt;div style="margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid rgba(255,255,255,0.3);">
          &lt;strong style="font-size: 1.1em;"> Cargo Marshal&lt;/strong>
        &lt;/div>
        &lt;div class="notification-summary-box">
          &lt;div style="color: #f59e0b; font-weight: bold; margin-bottom: 8px;"> ${highFeeVessels.length} vessel${highFeeVessels.length > 1 ? 's' : ''} with high Harbor fee&lt;/div>
          &lt;div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
            &lt;span style="color: #f59e0b;"> Harbor Fees (total):&lt;/span>
            &lt;span style="color: #9ca3af;">$${formatNumber(totalHarborFees)}&lt;/span>
          &lt;/div>
        &lt;/div>
        &lt;div style="margin: 12px 0; border-top: 1px solid rgba(255,255,255,0.2);">&lt;/div>
        &lt;div class="notification-vessel-list">
          ${highFeeList}
        &lt;/div>`;

      showSideNotification(warningMessage, 'warning', 12000);
    }
  }

  // Combined Desktop notification (includes harbor fee warning if applicable)
  if (settings.autoPilotNotifications &amp;&amp; settings.notifyCargoMarshalDesktop &amp;&amp; Notification.permission === 'granted') {
    let desktopBody = '';

    // Calculate harbor fee info (if threshold is set)
    let highFeeCount = 0;
    let totalHarborFees = 0;
    if (succeeded.count > 0 &amp;&amp; settings.harborFeeWarningThreshold) {
      const harborFeeThreshold = settings.harborFeeWarningThreshold;
      const highFeeVessels = succeeded.vessels.filter(v => {
        const grossIncome = v.income + v.harborFee;
        const feePercentage = (v.harborFee / grossIncome) * 100;
        return feePercentage > harborFeeThreshold;
      });
      highFeeCount = highFeeVessels.length;
      totalHarborFees = succeeded.vessels.reduce((sum, v) => sum + (v.harborFee || 0), 0);
    }

    // Build notification body based on results
    if (succeeded.count > 0 &amp;&amp; failed.count === 0) {
      // Success case
      const vesselCountStr = highFeeCount > 0
        ? `${succeeded.count} vessel${succeeded.count > 1 ? 's' : ''} departed (${highFeeCount} )`
        : `${succeeded.count} vessel${succeeded.count > 1 ? 's' : ''} departed`;

      desktopBody = `

${vesselCountStr}

 Net Profit: $${formatNumber(succeeded.totalIncome)}`;

      if (highFeeCount > 0) {
        desktopBody += `
 Harbor Fees: $${formatNumber(totalHarborFees)}`;
      }

      desktopBody += `

Fuel: ${Math.round(succeeded.totalFuelUsed)}t | CO2: ${Math.round(succeeded.totalCO2Used)}t`;

    } else if (succeeded.count === 0 &amp;&amp; failed.count > 0) {
      // All failed
      desktopBody = `

${failed.count} vessel${failed.count > 1 ? 's' : ''} could not depart

Check logs for details`;

    } else {
      // Mixed results
      const vesselCountStr = highFeeCount > 0
        ? `${succeeded.count} departed (${highFeeCount} ), ${failed.count} failed`
        : `${succeeded.count} departed, ${failed.count} failed`;

      desktopBody = `

${vesselCountStr}

 Net Profit: $${formatNumber(succeeded.totalIncome)}`;

      if (highFeeCount > 0) {
        desktopBody += `
 Harbor Fees: $${formatNumber(totalHarborFees)}`;
      }

      desktopBody += `

Fuel: ${Math.round(succeeded.totalFuelUsed)}t | CO2: ${Math.round(succeeded.totalCO2Used)}t`;
    }

    await showNotification(' Cargo Marshal', {
      body: desktopBody,
      icon: '/favicon.ico',
      tag: 'cargo-marshal',
      silent: false
    });
  }

  // Unlock depart button after departure process completes
  // Note: Backend sends events in correct order:
  //   1. bunker_update (updates fuel/co2/cash display)
  //   2. vessel_count_update (updates badge with correct counts)
  //   3. vessels_depart_complete (triggers this unlock)
  // This ensures UI is fully updated BEFORE button becomes clickable again
  if (window.unlockDepartButton) {
    window.unlockDepartButton();
  }
}

/**
 * Handles autopilot departure start event.
 * Locks the depart button to prevent manual interference during autopilot operation.
 */
async function handleAutopilotDepartStart(data) {
  console.log(`[Autopilot] Starting departure for ${data.vesselCount} vessels`);

  // Lock depart button immediately
  if (window.lockDepartButton) {
    window.lockDepartButton();
  }
}

/**
 * Handles vessels departed event from backend autopilot.
 * Shows detailed notification with vessel list, revenue and consumption totals.
 */
async function handleVesselsDeparted(data) {
  const { count, vessels, totalIncome, totalFuelUsed, totalCO2Used } = data;

  console.log(`[Autopilot] Vessels departed: ${count} vessels - Income: $${totalIncome.toLocaleString()}`);

  // Create compact vessel list
  const vesselList = vessels.map(v =>
    `&lt;div style="font-size: 0.8em; opacity: 0.85; padding: 4px 6px; border-bottom: 1px solid rgba(255,255,255,0.08);">
      &lt;div> &lt;strong>${v.name}&lt;/strong>&lt;/div>
      &lt;div style="font-size: 0.9em; color: #9ca3af; margin-top: 2px;">
        ${formatNumber(v.cargoLoaded)}/${formatNumber(v.capacity)} TEU (${(v.utilization * 100).toFixed(0)}%) |  $${formatNumber(v.income)}
      &lt;/div>
    &lt;/div>`
  ).join('');

  const message = `
    &lt;div style="margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid rgba(255,255,255,0.3);">
      &lt;strong style="font-size: 1.1em;"> Cargo Marshal: ${count} vessel${count > 1 ? 's' : ''}&lt;/strong>
    &lt;/div>
    &lt;div class="notification-summary-box">
      &lt;div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
        &lt;span style="color: #9ca3af;">Total Income:&lt;/span>
        &lt;span style="color: #4ade80; font-weight: bold;">$${formatNumber(totalIncome)}&lt;/span>
      &lt;/div>
      &lt;div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.9em; color: #9ca3af;">
        &lt;div style="font-size: 0.85em; margin-bottom: 4px; opacity: 0.8;">Consumption:&lt;/div>
        &lt;div>Used  Fuel: ${formatNumber(totalFuelUsed)}t&lt;/div>
        &lt;div style="margin-top: 2px;">Used  CO2: ${formatNumber(totalCO2Used)}t&lt;/div>
      &lt;/div>
    &lt;/div>
    &lt;div class="notification-vessel-list">
      ${vesselList}
    &lt;/div>`;

  // In-app notification
  const settings = window.getSettings ? window.getSettings() : {};
  if (settings.autoPilotNotifications &amp;&amp; settings.notifyCargoMarshalInApp) {
    showSideNotification(message, 'success', 15000);
  }

  // Force immediate vessel count update (bypasses anti-flicker logic)
  if (window.updateVesselCount) {
    await window.updateVesselCount();
  }

  // Refresh vessel selling overlay if open
  await refreshVesselsForSale();
}

/**
 * Handles vessels failed event from backend autopilot.
 * Shows warning notification with failed vessel list.
 */
async function handleVesselsFailed(data) {
  const { count, vessels, bunker } = data;

  console.log(`[Autopilot] Vessels failed: ${count} vessels`);

  // Build bunker info box in same style as success notification
  let bunkerInfoBox = '';
  if (bunker) {
    const fuelDisplay = bunker.fuel !== undefined ? formatNumber(Math.floor(bunker.fuel)) : 'N/A';
    const co2Display = bunker.co2 !== undefined ? formatNumber(Math.floor(bunker.co2)) : 'N/A';
    bunkerInfoBox = `
      &lt;div class="notification-summary-box">
        &lt;div style="font-size: 0.85em; margin-bottom: 6px; opacity: 0.8; color: #9ca3af;">Current bunker:&lt;/div>
        &lt;div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
          &lt;span style="color: #9ca3af;"> Fuel:&lt;/span>
          &lt;span style="color: #fff; font-weight: bold;">${fuelDisplay} t&lt;/span>
        &lt;/div>
        &lt;div style="display: flex; justify-content: space-between;">
          &lt;span style="color: #9ca3af;"> CO2:&lt;/span>
          &lt;span style="color: #fff; font-weight: bold;">${co2Display} t&lt;/span>
        &lt;/div>
      &lt;/div>`;
  }

  // Create formatted vessel list - one line per vessel
  const failedList = vessels.map(v => {
    // Remove vessel type prefixes (MV, MS, etc.)
    const cleanName = v.name.replace(/^(MV|MS|MT|SS)\s+/i, '');
    return `&lt;div style="font-size: 0.85em; opacity: 0.85; padding: 4px 6px; border-bottom: 1px solid rgba(255,255,255,0.08);">
       &lt;strong>${cleanName}&lt;/strong> &lt;span style="color: #ef4444;">${v.reason}&lt;/span>
    &lt;/div>`;
  }).join('');

  const message = `
    &lt;div style="margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid rgba(255,255,255,0.3);">
      &lt;strong style="font-size: 1.1em;"> Cargo Marshal: ${count} vessel${count > 1 ? 's' : ''} not departed&lt;/strong>
    &lt;/div>
    ${bunkerInfoBox}
    &lt;div style="margin-top: 8px;">
      &lt;strong> Failed to depart:&lt;/strong>
      &lt;div class="notification-vessel-list" style="margin-top: 6px;">
        ${failedList}
      &lt;/div>
    &lt;/div>
  `;

  const settings = window.getSettings ? window.getSettings() : {};

  // In-app alert
  if (settings.autoPilotNotifications &amp;&amp; settings.notifyCargoMarshalInApp) {
    showSideNotification(message, 'warning', null, true);
  }
}

/**
 * Handles vessels repaired event from backend autopilot.
 * Shows success notification with repair details and vessel list.
 */
async function handleVesselsRepaired(data) {
  const { count, totalCost, vessels } = data;

  console.log(`[Autopilot] Vessels repaired: ${count} vessels - Cost: $${totalCost.toLocaleString()}`);

  // Build vessel list similar to depart notification
  let contentHTML = '';
  if (vessels &amp;&amp; vessels.length > 0) {
    const vesselList = vessels.map(v =>
      `&lt;div style="font-size: 0.8em; opacity: 0.85; padding: 4px 6px; border-bottom: 1px solid rgba(255,255,255,0.08);">
        &lt;div> &lt;strong>${v.name}&lt;/strong>&lt;/div>
        &lt;div style="font-size: 0.9em; color: #9ca3af; margin-top: 2px;">
          Wear: ${Number(v.wear).toFixed(1)}% | Cost: $${formatNumber(v.cost)}
        &lt;/div>
      &lt;/div>`
    ).join('');

    contentHTML = `
      &lt;div class="notification-summary-box">
        &lt;div style="color: #4ade80; font-weight: bold; margin-bottom: 10px;"> ${count} vessel${count > 1 ? 's' : ''} repaired&lt;/div>
        &lt;div style="height: 1px; background: rgba(255,255,255,0.2); margin: 10px 0;">&lt;/div>
        &lt;div style="display: flex; justify-content: space-between; font-size: 1.1em;">
          &lt;span style="color: #fff; font-weight: bold;">Total Cost:&lt;/span>
          &lt;span style="color: #ef4444; font-weight: bold;">$${formatNumber(totalCost)}&lt;/span>
        &lt;/div>
      &lt;/div>
      &lt;div class="notification-vessel-list">
        ${vesselList}
      &lt;/div>
    `;
  }

  const message = `
    &lt;div style="margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid rgba(255,255,255,0.3);">
      &lt;strong style="font-size: 1.1em;"> Yard Foreman&lt;/strong>
    &lt;/div>
    ${contentHTML}
  `;

  // In-app notification
  const settings = window.getSettings ? window.getSettings() : {};
  if (settings.autoPilotNotifications &amp;&amp; settings.notifyYardForemanInApp) {
    showSideNotification(message, 'success', null, false);
  }

  // Desktop notification
  if (settings.autoPilotNotifications &amp;&amp; settings.notifyYardForemanDesktop &amp;&amp; Notification.permission === 'granted') {
    await showNotification(' Yard Foreman', {
      body: `

${count} vessel${count > 1 ? 's' : ''} repaired

 Total Cost: $${formatNumber(totalCost)}`,
      icon: '/favicon.ico',
      tag: 'yard-foreman',
      silent: false
    });
  }

  // Force immediate repair count update
  if (window.updateRepairCount) {
    window.updateRepairCount(window.getSettings ? window.getSettings() : {});
  }
}

/**
 * Handles vessels drydocked event from backend autopilot.
 * Shows success notification with drydocked vessel list.
 */
async function handleVesselsDrydocked(data) {
  const { count, maintenanceType, speed, vessels, totalCost } = data;

  console.log(`[Autopilot] Vessels sent to drydock: ${count} vessels - Type: ${maintenanceType}, Speed: ${speed}, Cost: $${totalCost}`);

  // Build vessel list
  let contentHTML = '';
  if (vessels &amp;&amp; vessels.length > 0) {
    const vesselList = vessels.map(v =>
      `&lt;div style="font-size: 0.8em; opacity: 0.85; padding: 4px 6px; border-bottom: 1px solid rgba(255,255,255,0.08);">
        &lt;div>&lt;strong>${v.name}&lt;/strong>&lt;/div>
        &lt;div style="font-size: 0.9em; color: #9ca3af; margin-top: 2px;">
          Hours: ${v.hours_until_check}h | Route: ${v.route_destination}${v.cost ? ` | Cost: $${formatNumber(v.cost)}` : ''}
        &lt;/div>
      &lt;/div>`
    ).join('');

    const typeLabel = maintenanceType === 'major' ? 'Major (100%)' : 'Minor (60%)';
    const speedLabel = speed === 'maximum' ? 'Maximum' : 'Minimum';

    contentHTML = `
      &lt;div class="notification-summary-box">
        &lt;div style="color: #f59e0b; font-weight: bold; margin-bottom: 10px;">${count} vessel${count > 1 ? 's' : ''} sent to drydock&lt;/div>
        &lt;div style="height: 1px; background: rgba(255,255,255,0.2); margin: 10px 0;">&lt;/div>
        &lt;div style="display: flex; justify-content: space-between; font-size: 1.1em; margin-bottom: 4px;">
          &lt;span style="color: #fff; font-weight: bold;">Total Cost:&lt;/span>
          &lt;span style="color: #ef4444; font-weight: bold;">$${formatNumber(totalCost || 0)}&lt;/span>
        &lt;/div>
        &lt;div style="height: 1px; background: rgba(255,255,255,0.2); margin: 10px 0;">&lt;/div>
        &lt;div style="display: flex; justify-content: space-between; font-size: 1em; margin-bottom: 4px;">
          &lt;span style="color: #9ca3af;">Type:&lt;/span>
          &lt;span style="color: #fff; font-weight: bold;">${typeLabel}&lt;/span>
        &lt;/div>
        &lt;div style="display: flex; justify-content: space-between; font-size: 1em;">
          &lt;span style="color: #9ca3af;">Speed:&lt;/span>
          &lt;span style="color: #fff; font-weight: bold;">${speedLabel}&lt;/span>
        &lt;/div>
      &lt;/div>
      &lt;div class="notification-vessel-list">
        ${vesselList}
      &lt;/div>
    `;
  }

  const message = `
    &lt;div style="margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid rgba(255,255,255,0.3);">
      &lt;strong style="font-size: 1.1em;">Drydock Master&lt;/strong>
    &lt;/div>
    ${contentHTML}
  `;

  // In-app notification
  const settings = window.getSettings ? window.getSettings() : {};
  if (settings.autoPilotNotifications &amp;&amp; settings.notifyDrydockMasterInApp) {
    showSideNotification(message, 'success', null, false);
  }

  // Desktop notification
  if (settings.autoPilotNotifications &amp;&amp; settings.notifyDrydockMasterDesktop &amp;&amp; Notification.permission === 'granted') {
    const typeLabel = maintenanceType === 'major' ? 'Major' : 'Minor';
    await showNotification(' Drydock Master', {
      body: `

${count} vessel${count > 1 ? 's' : ''} sent

Type: ${typeLabel}

 Total Cost: $${formatNumber(totalCost || 0)}`,
      icon: '/favicon.ico',
      tag: 'drydock-master',
      silent: false
    });
  }

  // Force immediate drydock count update
  if (window.debouncedUpdateRepairCount) {
    setTimeout(() => window.debouncedUpdateRepairCount(800), 1000);
  }
}

/**
 * Handles campaigns renewed event from backend autopilot.
 * Shows success notification with renewed campaign types.
 */
async function handleCampaignsRenewed(data) {
  const { campaigns } = data;

  console.log(`[Autopilot] Campaigns renewed:`, campaigns);

  // Create list of renewed campaigns
  const campaignList = campaigns.map(c =>
    `&lt;div style="padding: 4px 6px; border-bottom: 1px solid rgba(255,255,255,0.08);"> ${c.type}: &lt;strong>${c.name}&lt;/strong> - &lt;span style="color: #ff6b6b;">-$${formatNumber(c.price)}&lt;/span>&lt;/div>`
  ).join('');

  const message = `
    &lt;div style="margin-bottom: 8px;">
      &lt;strong> Reputation Chief&lt;/strong>
      &lt;br>&lt;br>
      &lt;strong>${campaigns.length} Campaign${campaigns.length > 1 ? 's' : ''} renewed&lt;/strong>
    &lt;/div>
    &lt;div class="notification-vessel-list">
      ${campaignList}
    &lt;/div>
  `;

  // In-app notification
  const settings = window.getSettings ? window.getSettings() : {};
  if (settings.autoPilotNotifications &amp;&amp; settings.notifyReputationChiefInApp) {
    showSideNotification(message, 'success', 10000);
  }

  // Desktop notification
  if (settings.autoPilotNotifications &amp;&amp; settings.notifyReputationChiefDesktop &amp;&amp; Notification.permission === 'granted') {
    const totalCost = campaigns.reduce((sum, c) => sum + c.price, 0);
    await showNotification(' Reputation Chief', {
      body: `

${campaigns.length} campaign${campaigns.length > 1 ? 's' : ''} renewed

 Total Cost: $${formatNumber(totalCost)}`,
      icon: '/favicon.ico',
      tag: 'reputation-chief',
      silent: false
    });
  }
}

/**
 * Handles auto-COOP distribution completion.
 * Shows summary of sent vessels and updates COOP badge.
 */
async function handleAutoCoopComplete(data) {
  const { totalRequested, totalSent, results } = data;

  console.log(`[Auto-COOP] Distribution complete:`, data);

  // Build result list
  const successResults = results.filter(r => !r.error);
  const failedResults = results.filter(r => r.error);

  let resultsList = '';
  if (successResults.length > 0) {
    resultsList += successResults.map(r => {
      const status = r.partial ? '' : '';
      return `&lt;div style="padding: 4px 6px; border-bottom: 1px solid rgba(255,255,255,0.08);">${status} ${r.company_name}: &lt;strong>${r.departed}&lt;/strong> of ${r.requested} vessels&lt;/div>`;
    }).join('');
  }

  if (failedResults.length > 0) {
    resultsList += failedResults.map(r =>
      `&lt;div style="padding: 4px 6px; border-bottom: 1px solid rgba(255,255,255,0.08); color: #ef4444;"> ${r.company_name}: Failed&lt;/div>`
    ).join('');
  }

  const message = `
    &lt;div style="margin-bottom: 8px;">
      &lt;strong> The Fair Hand: ${totalSent} vessel${totalSent > 1 ? 's' : ''} distributed to ${successResults.length} member${successResults.length > 1 ? 's' : ''}&lt;/strong>
    &lt;/div>
    &lt;div class="notification-vessel-list">
      ${resultsList}
    &lt;/div>
  `;

  // In-app notification
  const settings = window.getSettings ? window.getSettings() : {};
  if (settings.autoPilotNotifications &amp;&amp; settings.notifyFairHandInApp) {
    showSideNotification(message, totalSent === totalRequested ? 'success' : 'warning', 12000);
  }

  // Desktop notification
  if (settings.autoPilotNotifications &amp;&amp; settings.notifyFairHandDesktop &amp;&amp; Notification.permission === 'granted') {
    await showNotification(' Fair Hand', {
      body: `

${totalSent} vessel${totalSent > 1 ? 's' : ''} distributed

Sent to ${successResults.length} member${successResults.length > 1 ? 's' : ''}`,
      icon: '/favicon.ico',
      tag: 'fair-hand',
      silent: false
    });
  }

  // Update COOP badge
  if (window.updateCoopBadge) {
    await window.updateCoopBadge();
  }
}

/**
 * Handles auto-COOP when no eligible targets found.
 * Notifies user that COOP vessels are available but can't be sent.
 */
async function handleAutoCoopNoTargets(data) {
  const { available, reason } = data;

  console.log(`[Auto-COOP] No eligible targets:`, data);

  const message = `
    &lt;div style="margin-bottom: 8px;">
      &lt;strong> The Fair Hand: ${available} vessel${available > 1 ? 's' : ''} available&lt;/strong>
    &lt;/div>
    &lt;div style="color: #fbbf24;"> ${reason}&lt;/div>
  `;

  const settings = window.getSettings ? window.getSettings() : {};

  // In-app alert
  if (settings.autoPilotNotifications &amp;&amp; settings.notifyFairHandInApp) {
    showSideNotification(message, 'warning', 8000);
  }
}

/**
 * Handles bunker state updates from backend autopilot.
 * Updates all bunker displays (fuel, CO2, cash) without API calls.
 */
function handleBunkerUpdate(data) {
  const { fuel, co2, cash, points, maxFuel, maxCO2 } = data;
  updateDataCache.bunker = { fuel, co2, cash, points };
  if (AUTOPILOT_LOG_LEVEL === 'detailed') {
    console.log(`[Autopilot] Bunker update: Fuel=${Math.floor(fuel)}t, CO2=${Math.floor(co2)}t, Cash=$${Math.floor(cash).toLocaleString()}, Points=${points}`);
  }

  // Update capacity values in bunker-management module
  if (window.setCapacityFromBunkerUpdate) {
    window.setCapacityFromBunkerUpdate(maxFuel, maxCO2);
  }

  // Synchronize module-level variables in bunker-management.js
  // This fixes the bug where purchase dialogs use stale cash/fuel/CO2 values
  updateCurrentFuel(fuel);
  updateCurrentCO2(co2);
  updateCurrentCash(cash);

  // Update fuel display with color coding (background fill bar only, text stays white)
  const fuelDisplay = document.getElementById('fuelDisplay');
  const fuelFill = document.getElementById('fuelFill');
  const fuelBtn = document.getElementById('fuelBtn');
  // CRITICAL: Only update if we have valid maxFuel (> 0) from API
  // DO NOT show "0 t / 0 t" on initial connect - keep empty until real data arrives
  if (fuelDisplay &amp;&amp; maxFuel > 0) {
    fuelDisplay.innerHTML = `${formatNumber(Math.floor(fuel))} &lt;b>t&lt;/b> &lt;b>/&lt;/b> ${formatNumber(Math.floor(maxFuel))} &lt;b>t&lt;/b>`;

    // Update fill bar and button styling with CSS classes
    if (fuelFill &amp;&amp; fuelBtn) {
      const fuelPercent = Math.min(100, Math.max(0, (fuel / maxFuel) * 100));
      fuelFill.style.width = `${fuelPercent}%`;

      // Determine fill level class based on tank percentage
      let fillClass = '';
      if (fuel &lt;= 0) {
        fillClass = 'fuel-btn-empty';
        fuelFill.style.width = '0%';
        fuelFill.style.background = 'transparent';
      } else if (fuelPercent &lt;= 20) {
        fillClass = 'fuel-btn-low';
        fuelFill.style.background = 'linear-gradient(to right, rgba(239, 68, 68, 0.25), rgba(239, 68, 68, 0.4))';
      } else if (fuelPercent &lt;= 70) {
        fillClass = 'fuel-btn-medium';
        fuelFill.style.background = 'linear-gradient(to right, rgba(96, 165, 250, 0.3), rgba(96, 165, 250, 0.5))';
      } else if (fuelPercent &lt;= 85) {
        fillClass = 'fuel-btn-high';
        fuelFill.style.background = 'linear-gradient(to right, rgba(251, 191, 36, 0.3), rgba(251, 191, 36, 0.5))';
      } else {
        fillClass = 'fuel-btn-full';
        fuelFill.style.background = 'linear-gradient(to right, rgba(74, 222, 128, 0.3), rgba(74, 222, 128, 0.5))';
      }

      // Update fill-level class (controls background/border color and animation)
      // These classes: fuel-btn-empty (red pulse), fuel-btn-low (red), fuel-btn-medium (blue), fuel-btn-high (yellow), fuel-btn-full (green)
      fuelBtn.classList.remove('fuel-btn-empty', 'fuel-btn-low', 'fuel-btn-medium', 'fuel-btn-high', 'fuel-btn-full');
      if (fillClass) fuelBtn.classList.add(fillClass);

      // Update price-color class (controls TEXT color based on market price)
      // These classes are SEPARATE from fill-level - both can coexist
      // Price classes: fuel-red, fuel-orange, fuel-blue, fuel-green (text color only)
      const fuelPrice = window.updateDataCache?.prices?.fuelPrice || window.updateDataCache?.prices?.fuel;
      if (fuelPrice !== undefined &amp;&amp; fuelPrice > 0) {
        let priceClass = '';
        if (fuelPrice >= 800) {
          priceClass = 'fuel-red';
        } else if (fuelPrice >= 600) {
          priceClass = 'fuel-orange';
        } else if (fuelPrice >= 400) {
          priceClass = 'fuel-blue';
        } else if (fuelPrice >= 1) {
          priceClass = 'fuel-green';
        }

        // Remove ONLY price-color classes (do NOT remove fill-level classes!)
        fuelBtn.classList.remove('fuel-red', 'fuel-orange', 'fuel-blue', 'fuel-green');
        if (priceClass) fuelBtn.classList.add(priceClass);
      }
    }
  }

  // Update CO2 display with color coding (background fill bar only, text stays white)
  const co2Display = document.getElementById('co2Display');
  const co2Fill = document.getElementById('co2Fill');
  const co2Btn = document.getElementById('co2Btn');
  // CRITICAL: Only update if we have valid maxCO2 (> 0) from API
  // DO NOT show "0 t / 0 t" on initial connect - keep empty until real data arrives
  if (co2Display &amp;&amp; maxCO2 > 0) {
    const co2Value = co2 &lt; 0 ? `-${formatNumber(Math.floor(Math.abs(co2)))}` : formatNumber(Math.floor(co2));
    co2Display.innerHTML = `${co2Value} &lt;b>t&lt;/b> &lt;b>/&lt;/b> ${formatNumber(Math.floor(maxCO2))} &lt;b>t&lt;/b>`;

    // Update fill bar and button styling with CSS classes
    if (co2Fill &amp;&amp; co2Btn) {
      const co2Percent = Math.min(100, Math.max(0, (co2 / maxCO2) * 100));
      co2Fill.style.width = `${co2Percent}%`;

      if (AUTOPILOT_LOG_LEVEL === 'detailed') {
        console.log('[DEBUG] handleBunkerUpdate - CO2 value:', co2, 'maxCO2:', maxCO2, 'co2Percent:', co2Percent, 'co2 &lt;= 0:', (co2 &lt;= 0));
      }

      // Determine fill level class based on tank percentage
      let fillClass = '';
      if (co2 &lt;= 0) {
        if (AUTOPILOT_LOG_LEVEL === 'detailed') {
          console.log('[DEBUG] CO2 &lt;= 0 detected! Value:', co2, '- Setting co2-btn-empty class');
        }
        fillClass = 'co2-btn-empty';
        co2Fill.style.width = '0%';
        co2Fill.style.background = 'transparent';
      } else if (co2Percent &lt;= 20) {
        fillClass = 'co2-btn-low';
        co2Fill.style.background = 'linear-gradient(to right, rgba(239, 68, 68, 0.25), rgba(239, 68, 68, 0.4))';
      } else if (co2Percent &lt;= 70) {
        fillClass = 'co2-btn-medium';
        co2Fill.style.background = 'linear-gradient(to right, rgba(96, 165, 250, 0.3), rgba(96, 165, 250, 0.5))';
      } else if (co2Percent &lt;= 85) {
        fillClass = 'co2-btn-high';
        co2Fill.style.background = 'linear-gradient(to right, rgba(251, 191, 36, 0.3), rgba(251, 191, 36, 0.5))';
      } else {
        if (AUTOPILOT_LOG_LEVEL === 'detailed') {
          console.log('[DEBUG] CO2 > 85% - Setting co2-btn-full class. Value:', co2, 'Percent:', co2Percent);
        }
        fillClass = 'co2-btn-full';
        co2Fill.style.background = 'linear-gradient(to right, rgba(74, 222, 128, 0.3), rgba(74, 222, 128, 0.5))';
      }

      // Update fill-level class (controls background/border color and animation)
      // These classes: co2-btn-empty (red pulse), co2-btn-low (red), co2-btn-medium (blue), co2-btn-high (yellow), co2-btn-full (green)
      co2Btn.classList.remove('co2-btn-empty', 'co2-btn-low', 'co2-btn-medium', 'co2-btn-high', 'co2-btn-full');
      if (fillClass) co2Btn.classList.add(fillClass);

      // Update price-color class (controls TEXT color based on market price)
      // These classes are SEPARATE from fill-level - both can coexist
      // Price classes: co2-negative, co2-red, co2-orange, co2-blue, co2-green (text color only)
      const co2Price = window.updateDataCache?.prices?.co2Price || window.updateDataCache?.prices?.co2;
      if (co2Price !== undefined &amp;&amp; co2Price !== null) {
        let priceClass = '';
        if (co2Price &lt;= 0) {
          priceClass = 'co2-negative';
        } else if (co2Price >= 20) {
          priceClass = 'co2-red';
        } else if (co2Price >= 15) {
          priceClass = 'co2-orange';
        } else if (co2Price >= 10) {
          priceClass = 'co2-blue';
        } else if (co2Price >= 1) {
          priceClass = 'co2-green';
        }

        // Remove ONLY price-color classes (do NOT remove fill-level classes!)
        co2Btn.classList.remove('co2-negative', 'co2-red', 'co2-orange', 'co2-blue', 'co2-green');
        if (priceClass) co2Btn.classList.add(priceClass);
      }
    }
  }

  // Update cash display - only if we have valid bunker data (maxFuel or maxCO2 > 0)
  const cashDisplay = document.getElementById('cashDisplay');
  if (cashDisplay &amp;&amp; (maxFuel > 0 || maxCO2 > 0)) {
    cashDisplay.innerHTML = `$${formatNumber(Math.floor(cash))}`;
  }

  // Update points display (diamonds)
  const pointsDisplay = document.getElementById('pointsDisplay');
  if (pointsDisplay &amp;&amp; points !== undefined) {
    pointsDisplay.textContent = formatNumber(points);
  }

  // Cache bunker values for next page load
  if (window.saveBadgeCache) {
    window.saveBadgeCache({ bunker: { fuel, co2, cash, points, maxFuel, maxCO2 } });
  }
}

/**
 * Handles vessel count updates from backend autopilot.
 * Updates badges AND button states/tooltips.
 */
function handleVesselCountUpdate(data) {
  const { readyToDepart, atAnchor, pending } = data;
  updateDataCache.vessels = { ready: readyToDepart, anchor: atAnchor, pending };
  if (AUTOPILOT_LOG_LEVEL === 'detailed') {
    console.log(`[Autopilot] Vessel count update: Ready=${readyToDepart}, Anchor=${atAnchor}, Pending=${pending}`);
  }

  // Update ready to depart badge using badge-manager
  updateBadge('vesselCount', readyToDepart, readyToDepart > 0, 'BLUE');

  // Update at anchor badge using badge-manager
  updateBadge('anchorCount', atAnchor, atAnchor > 0, 'RED');

  // Update pending vessels badge using badge-manager
  updateBadge('pendingVesselsBadge', pending, pending > 0, 'ORANGE');

  // Update tooltips
  const anchorTooltip = atAnchor > 0
    ? `${atAnchor} vessel${atAnchor === 1 ? '' : 's'} at anchor - Click to purchase anchor points`
    : 'Purchase anchor points';
  updateButtonTooltip('anchor', anchorTooltip);
  updateButtonTooltip('buyVessels', pending > 0 ? `Vessels in delivery: ${pending}` : 'Buy vessels');

  // Update depart button state and tooltip AFTER badges are updated
  const departDisabled = readyToDepart === 0;
  updateButtonState('departAll', departDisabled);
  const departTooltip = readyToDepart > 0
    ? `Depart all ${readyToDepart} vessel${readyToDepart === 1 ? '' : 's'} from harbor`
    : 'No vessels ready to depart';
  updateButtonTooltip('departAll', departTooltip);

  // Harbor Map refresh is now handled by harbor_map_refresh_required event

  // Update pending button visibility
  const pendingBtn = document.getElementById('filterPendingBtn');
  const pendingCountSpan = document.getElementById('pendingCount');
  if (pendingBtn &amp;&amp; pendingCountSpan) {
    pendingCountSpan.textContent = pending;
    if (pending > 0) {
      pendingBtn.classList.remove('hidden');
    } else {
      pendingBtn.classList.add('hidden');
    }
  }

  // Cache values for next page load
  if (window.saveBadgeCache) {
    window.saveBadgeCache({ vessels: { readyToDepart, atAnchor, pending } });
  }

  // Event-driven auto-depart: Trigger when vessels arrive in harbor
  // This is more efficient than polling - we react immediately when vessels become ready
  if (readyToDepart > 0 &amp;&amp; window.settings?.autoDepartAll) {
    if (AUTOPILOT_LOG_LEVEL === 'detailed') {
      console.log(`[Auto-Depart] Event-driven trigger: ${readyToDepart} vessel(s) ready`);
    }
    // Notify backend to execute auto-depart
    fetch('/api/autopilot/trigger-depart', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    }).catch(err => console.error('[Auto-Depart] Failed to trigger:', err));
  }
}

/**
 * Handles Harbor Map refresh requests from backend.
 * Only refreshes when actual vessel/port changes occur (with rate limiting).
 */
function handleHarborMapRefreshRequired(data) {
  const { reason } = data;
  if (AUTOPILOT_LOG_LEVEL === 'detailed') {
    console.log(`[Harbor Map] Refresh requested (reason: ${reason})`);
  }

  // Trigger Harbor Map refresh if open (has built-in 30s cooldown)
  if (window.harborMap &amp;&amp; window.harborMap.refreshIfOpen) {
    window.harborMap.refreshIfOpen();
  }
}

/**
 * Handles repair count updates from backend.
 * Updates the "Repair" badge without API calls.
 */
function handleRepairCountUpdate(data) {
  const { count } = data;
  updateDataCache.repair = count;
  if (AUTOPILOT_LOG_LEVEL === 'detailed') {
    console.log(`[Autopilot] Repair count update: ${count} vessel${count === 1 ? '' : 's'} need repair`);
  }

  // Update repair badge using badge-manager
  updateBadge('repairCount', count, count > 0, 'RED');

  // Update repair button state (check both repair and drydock counts)
  const drydockBadge = document.querySelector('.map-icon-item[data-action="repairAll"] .map-icon-badge-bottom-left');
  const drydockCount = drydockBadge ? (parseInt(drydockBadge.textContent) || 0) : 0;

  const hasWork = count > 0 || drydockCount > 0;
  updateButtonState('repairAll', !hasWork);

  if (count > 0 &amp;&amp; drydockCount > 0) {
    updateButtonTooltip('repairAll', `Repair ${count} vessel${count === 1 ? '' : 's'} or drydock ${drydockCount} vessel${drydockCount === 1 ? '' : 's'}`);
  } else if (count > 0) {
    updateButtonTooltip('repairAll', `Repair ${count} vessel${count === 1 ? '' : 's'}`);
  } else if (drydockCount > 0) {
    updateButtonTooltip('repairAll', `Drydock ${drydockCount} vessel${drydockCount === 1 ? '' : 's'}`);
  } else {
    updateButtonTooltip('repairAll', 'No vessels need repair or drydock');
  }

  // Cache value for next page load
  if (window.saveBadgeCache) {
    window.saveBadgeCache({ repair: { count } });
  }
}

/**
 * Handles drydock count updates from backend.
 * Updates the "Drydock" badge without API calls.
 */
function handleDrydockCountUpdate(data) {
  const { count } = data;
  updateDataCache.drydock = count;
  if (AUTOPILOT_LOG_LEVEL === 'detailed') {
    console.log(`[Autopilot] Drydock count update: ${count} vessel${count === 1 ? '' : 's'} need drydock`);
  }

  // Update drydock badge using badge-manager
  updateBadge('drydockCount', count, count > 0, 'ORANGE');

  // Update repair button state (check both repair and drydock counts)
  const repairBadge = document.querySelector('.map-icon-item[data-action="repairAll"] .map-icon-badge');
  const repairCount = repairBadge ? (parseInt(repairBadge.textContent) || 0) : 0;

  const hasWork = repairCount > 0 || count > 0;
  updateButtonState('repairAll', !hasWork);

  if (repairCount > 0 &amp;&amp; count > 0) {
    updateButtonTooltip('repairAll', `Repair ${repairCount} vessel${repairCount === 1 ? '' : 's'} or drydock ${count} vessel${count === 1 ? '' : 's'}`);
  } else if (repairCount > 0) {
    updateButtonTooltip('repairAll', `Repair ${repairCount} vessel${repairCount === 1 ? '' : 's'} with high wear`);
  } else if (count > 0) {
    updateButtonTooltip('repairAll', `Drydock ${count} vessel${count === 1 ? '' : 's'}`);
  } else {
    updateButtonTooltip('repairAll', 'No vessels need repair or drydock');
  }

  // Cache value for next page load
  if (window.saveBadgeCache) {
    window.saveBadgeCache({ drydock: { count } });
  }
}

/**
 * Handles campaign status updates from backend.
 * Updates the "Campaigns" badge without API calls.
 */
// Track last campaign count for change detection
let lastCampaignsCount = null;

function handleCampaignStatusUpdate(data) {
  const { activeCount } = data;
  updateDataCache.campaigns = activeCount;
  if (AUTOPILOT_LOG_LEVEL === 'detailed') {
    console.log(`[Autopilot] Campaign update: ${activeCount} active campaign${activeCount === 1 ? '' : 's'}`);
  }

  // Update campaigns badge using badge-manager (only show if &lt; 3 campaigns)
  updateBadge('campaignsCount', activeCount, activeCount &lt; 3, 'RED');

  // Update header display
  const campaignsHeaderDisplay = document.getElementById('campaignsHeaderDisplay');
  if (campaignsHeaderDisplay) {
    campaignsHeaderDisplay.textContent = activeCount;
    // Green if >= 3, red if &lt; 3
    if (activeCount >= 3) {
      campaignsHeaderDisplay.classList.add('text-success');
      campaignsHeaderDisplay.classList.remove('text-danger');
    } else {
      campaignsHeaderDisplay.classList.add('text-danger');
      campaignsHeaderDisplay.classList.remove('text-success');
    }
  }

  // Update button tooltip with campaign status
  const campaignsBtn = document.getElementById('campaignsBtn');
  if (campaignsBtn) {
    const requiredTypes = ['reputation', 'awareness', 'green'];
    const activeTypes = new Set((data.active || []).map(c => c.option_name));
    const statusList = requiredTypes.map(type => {
      const isActive = activeTypes.has(type);
      const icon = isActive ? '' : '';
      const name = type.charAt(0).toUpperCase() + type.slice(1);
      return `${icon} ${name}`;
    }).join('\n');
    campaignsBtn.title = `Marketing Campaigns (${activeCount}/3 active)\n${statusList}`;
  }

  // Show notifications on initial load or count changes
  if (lastCampaignsCount === null) {
    // Initial notification (only if &lt; 3 campaigns)
    if (activeCount !== 3) {
      showSideNotification(` &lt;strong>Marketing Campaigns&lt;/strong>&lt;br>&lt;br>Only ${activeCount}/3 campaigns are active!`, 'warning', null, true);

      if (Notification.permission === 'granted') {
        showNotification(' Marketing Campaigns Alert', {
          body: `

Only ${activeCount}/3 campaigns active`,
          icon: '/favicon.ico',
          tag: 'campaigns-alert',
          silent: false
        });
      }
    }
  } else if (lastCampaignsCount !== activeCount) {
    // Count changed - show appropriate notification
    if (activeCount === 3) {
      showSideNotification(' All 3 marketing campaigns are now active!', 'success');
    } else {
      showSideNotification(` &lt;strong>Marketing Campaigns&lt;/strong>&lt;br>&lt;br>${activeCount}/3 campaigns active`, 'warning', null, true);

      if (Notification.permission === 'granted') {
        showNotification(' Marketing Campaigns Alert', {
          body: `

Only ${activeCount}/3 campaigns active`,
          icon: '/favicon.ico',
          tag: 'campaigns-alert',
          silent: false
        });
      }
    }
  }

  lastCampaignsCount = activeCount;

  // Cache value for next page load
  if (window.saveBadgeCache) {
    window.saveBadgeCache({ campaigns: activeCount });
  }
}

/**
 * Handles unread messages count updates from backend.
 * Updates the "Messages" badge without API calls.
 */
function handleUnreadMessagesUpdate(data) {
  const { count } = data;
  updateDataCache.messages = count;
  if (AUTOPILOT_LOG_LEVEL === 'detailed') {
    console.log(`[Autopilot] Messages update: ${count} unread message${count === 1 ? '' : 's'}`);
  }

  // Update badge using badge-manager
  updateBadge('unreadBadge', count, count > 0, 'RED');

  // Cache value for next page load
  if (window.saveBadgeCache) {
    window.saveBadgeCache({ messages: count });
  }
}

/**
 * Handles messenger updates from 10-second polling
 * This replaces all other messenger polling mechanisms
 */
function handleMessengerUpdate(data) {
  const { messages } = data; // Unread message count
  updateDataCache.messages = messages;

  // Only log in detailed mode or if there are unread messages
  if (AUTOPILOT_LOG_LEVEL === 'detailed' || messages > 0) {
    console.log(`[Messenger] 10-sec poll: ${messages} unread message${messages === 1 ? '' : 's'}`);
  }

  // Get previous count for notification comparison
  const messageBadge = document.querySelector('.map-icon-item[data-action="messenger"] .map-icon-badge');
  const previousCount = messageBadge ? (parseInt(messageBadge.textContent) || 0) : 0;

  // Update badge using badge-manager
  updateBadge('unreadBadge', messages, messages > 0, 'RED');

  // Show notification if count increased
  if (messages > previousCount) {
    const settings = window.getSettings ? window.getSettings() : {};
    if (settings.enableInboxNotifications !== false &amp;&amp; document.hidden) {
      showChatNotification(
        ' New Message',
        `You have ${messages - previousCount} new message${messages - previousCount === 1 ? '' : 's'}`
      );
    }
  }

  // Cache value for next page load
  if (window.saveBadgeCache) {
    window.saveBadgeCache({ messages: messages });
  }
}

/**
 * Handles generic notifications from backend (errors, warnings, info).
 */
function handleGenericNotification(data) {
  const { type, message } = data;
  console.log(`[Notification] ${type}:`, message);

  // Check if this is an "insufficient resource" notification (should not be an alert)
  const isInsufficientResource = message.includes('insufficient') ||
                                  message.includes('not enough') ||
                                  message.includes('Cannot depart');

  // Show side notification (no "Got it" button for insufficient resource messages)
  showSideNotification(message, type, null, !isInsufficientResource);
}

/**
 * Handles user action notifications from backend (manual purchases, actions, etc.)
 * These are broadcasted to ALL connected clients so everyone sees when someone makes a purchase.
 */
function handleUserActionNotification(data) {
  const { type, message } = data;
  showSideNotification(message, type, 5000, false);
}

/**
 * Handles COOP targets update from backend.
 * Updates the COOP badge and header display.
 */
function handleCoopUpdate(data) {
  const { available, cap, coop_boost } = data;
  updateDataCache.coop = { available, cap, coop_boost };
  if (AUTOPILOT_LOG_LEVEL === 'detailed') {
    console.log(`[Autopilot] COOP update: ${available}/${coop_boost || cap} available`);
  }

  // Update badge using badge-manager (red if available > 0, green if all slots used)
  const color = available === 0 ? 'GREEN' : 'RED';
  updateBadge('coopBadge', available, available > 0, color);

  // Update header display using centralized function
  if (window.updateCoopDisplay) {
    window.updateCoopDisplay(cap, available);
  }

  // Cache for next page load
  if (window.saveBadgeCache) {
    window.saveBadgeCache({ coop: { available, cap, coop_boost } });
  }
}

/**
 * Handles company_type updates from backend.
 * Updates global variable for vessel purchase restrictions.
 * Refreshes vessel catalog to show/hide locked banners.
 */
function handleCompanyTypeUpdate(data) {
  const { company_type } = data;
  window.USER_COMPANY_TYPE = company_type;
  if (AUTOPILOT_LOG_LEVEL === 'detailed') {
    console.log(`[Autopilot] Company type update:`, company_type);
  }

  // Show/hide tanker filter button in sell vessels dialog
  const sellTankerBtn = document.getElementById('sellFilterTankerBtn');
  if (sellTankerBtn &amp;&amp; company_type &amp;&amp; company_type.includes('tanker')) {
    sellTankerBtn.classList.remove('hidden');
  }

  // Refresh vessel cards if catalog is open
  if (window.refreshVesselCardsIfVisible) {
    window.refreshVesselCardsIfVisible();
  }
}

/**
 * Handles stock price and anchor capacity updates from backend.
 * Updates header displays for stock value/trend and anchor slots.
 */
function handleHeaderDataUpdate(data) {
  const { stock, anchor } = data;
  if (stock) updateDataCache.stock = stock;
  if (anchor) updateDataCache.anchor = anchor;
  if (AUTOPILOT_LOG_LEVEL === 'detailed') {
    const stockMsg = stock ? `Stock=${stock.value.toFixed(2)} (${stock.trend})` : 'Stock=N/A';
    const anchorMsg = anchor ? `Anchor=${anchor.available}/${anchor.max}` : 'Anchor=N/A';
    console.log(`[Autopilot] Header data update: ${stockMsg}, ${anchorMsg}`);
  }

  // Update stock display
  if (stock) {
    const stockDisplay = document.getElementById('stockDisplay');
    const stockTrendElement = document.getElementById('stockTrend');

    if (stockDisplay &amp;&amp; stockTrendElement) {
      const stockContainer = stockDisplay.parentElement;

      if (stock.ipo === 1) {
        stockContainer.classList.remove('hidden');
        stockDisplay.textContent = `$${stock.value.toFixed(2)}`;

        if (stock.trend === 'up') {
          stockTrendElement.textContent = '';
          stockTrendElement.classList.add('text-success');
          stockTrendElement.classList.remove('text-danger', 'text-neutral');
          stockDisplay.classList.add('text-success');
          stockDisplay.classList.remove('text-danger', 'text-neutral');
        } else if (stock.trend === 'down') {
          stockTrendElement.textContent = '';
          stockTrendElement.classList.add('text-danger');
          stockTrendElement.classList.remove('text-success', 'text-neutral');
          stockDisplay.classList.add('text-danger');
          stockDisplay.classList.remove('text-success', 'text-neutral');
        } else {
          stockTrendElement.textContent = '-';
          stockTrendElement.classList.add('text-neutral');
          stockTrendElement.classList.remove('text-success', 'text-danger');
          stockDisplay.classList.add('text-neutral');
          stockDisplay.classList.remove('text-success', 'text-danger');
        }
      } else {
        stockContainer.classList.add('hidden');
      }
    }
  }

  // Update anchor capacity display
  if (anchor) {
    const anchorSlotsDisplay = document.getElementById('anchorSlotsDisplay');
    if (anchorSlotsDisplay) {
      // Show container (anchor is NOT alliance-dependent)
      const anchorContainer = anchorSlotsDisplay.parentElement;
      if (anchorContainer) {
        anchorContainer.classList.remove('hidden');
      }

      // Format: Total 114  Free 1  Pending 0
      const total = anchor.max;
      const free = anchor.available;
      const pending = anchor.pending || 0;  // From settings.lastAnchorPointPurchase

      // Build display string with labels
      // Total: RED if free > 0 (slots available = bad), GREEN if free = 0 (all slots used = good)
      const totalColor = free > 0 ? '#ef4444' : '#4ade80';
      let html = `Total &lt;span style="color: ${totalColor};">${total}&lt;/span>`;

      // Free slots - only show if > 0, in red
      if (free > 0) {
        html += `  Free &lt;span style="color: #ef4444;">${free}&lt;/span>`;
      }

      // Pending - only show if > 0, in orange
      if (pending > 0) {
        html += `  Pending &lt;span style="color: #fbbf24;">${pending}&lt;/span>`;
      }

      anchorSlotsDisplay.innerHTML = html;
    }

    // Refresh vessel purchase buttons if anchor slots changed
    if (window.refreshVesselCardsIfVisible) {
      window.refreshVesselCardsIfVisible();
    }
  }

  // Cache for next page load
  if (window.saveBadgeCache) {
    window.saveBadgeCache({
      stock: stock,
      anchor: anchor
    });
  }
}


/**
 * Handle hijacking negotiation updates from auto-negotiate autopilot.
 * Shows live notifications as the bot negotiates with pirates.
 *
 * @param {Object} data - Hijacking update data
 * @param {string} data.action - Type of update (offer_submitted, pirate_counter_offer, accepting_price, hijacking_resolved)
 * @param {number} data.case_id - Hijacking case ID
 */
async function handleHijackingUpdate(data) {
  // Check if this is a badge/header update (from 30-second polling)
  if (data.openCases !== undefined || data.hijackedCount !== undefined) {
    if (window.DEBUG_MODE) {
      console.log('[Hijacking] Badge/Header update received:', data);
    }

    // Update hijacking inbox badge
    if (window.updateHijackingBadge) {
      window.updateHijackingBadge(data);
      if (window.DEBUG_MODE) {
        console.log('[Hijacking] Badge updated');
      }
    } else {
      console.error('[Hijacking] updateHijackingBadge not found!');
    }

    // Update hijacked vessels header display
    if (window.updateHijackedVesselsDisplay) {
      window.updateHijackedVesselsDisplay(data);
      if (window.DEBUG_MODE) {
        console.log('[Hijacking] Header display updated');
      }
    } else {
      console.error('[Hijacking] updateHijackedVesselsDisplay not found!');
    }

    // Save to badge cache for next page load
    if (window.saveBadgeCache) {
      window.saveBadgeCache({
        hijacking: {
          openCases: data.openCases,
          totalCases: data.totalCases,
          hijackedCount: data.hijackedCount
        }
      });
    }
    return;
  }

  // Handle auto-negotiate progress updates (data.data.action exists)
  const { action, case_id, round, your_offer, pirate_demand, pirate_counter, final_price, threshold, final_amount, vessel_name } = data.data || {};

  // Only show live progress notifications, not side notifications
  if (action === 'offer_submitted') {
    const message = ` &lt;strong>Captain Blackbeard #${case_id}&lt;/strong> Round ${round}&lt;br>` +
                    `Bot offering: &lt;strong>$${your_offer?.toLocaleString()}&lt;/strong>&lt;br>` +
                    `Pirate demand: $${pirate_demand?.toLocaleString()}`;
    showAutoPilotNotification(message, 'info', 5000);
  } else if (action === 'pirate_counter_offer') {
    const reduction = pirate_demand - pirate_counter;
    const percentReduction = ((reduction / pirate_demand) * 100).toFixed(1);
    const message = ` &lt;strong>Captain Blackbeard #${case_id}&lt;/strong> Round ${round}&lt;br>` +
                    `Pirates counter: &lt;strong>$${pirate_counter?.toLocaleString()}&lt;/strong>&lt;br>` +
                    `&lt;span style="color: #10b981;"> Reduced by $${reduction?.toLocaleString()} (${percentReduction}%)&lt;/span>`;
    showAutoPilotNotification(message, 'success', 5000);
  } else if (action === 'accepting_price') {
    const message = ` &lt;strong>Captain Blackbeard #${case_id}&lt;/strong>&lt;br>` +
                    ` Price below $${threshold?.toLocaleString()} threshold&lt;br>` +
                    `Accepting final price: &lt;strong>$${final_price?.toLocaleString()}&lt;/strong>`;
    showAutoPilotNotification(message, 'success', 5000);
  } else if (action === 'hijacking_resolved') {
    // Show Captain Blackbeard success message as side notification
    const settings = window.getSettings ? window.getSettings() : {};
    const blackbeardMessage = `Ahoy, Landlubber Chick!\n\nRelax, darling. I secured that old tub ${vessel_name || 'your vessel'} for a paltry $${final_amount?.toLocaleString()} Doubloons by applying a touch of 'creative problem-solving.' You owe me one!\n\n Captain\nBlackbeard`;

    // In-app notification
    if (settings.autoPilotNotifications &amp;&amp; settings.notifyCaptainBlackbeardInApp &amp;&amp; window.showSideNotification) {
      window.showSideNotification(blackbeardMessage, 'success', 12000);
    }

    // Desktop notification
    if (settings.autoPilotNotifications &amp;&amp; settings.notifyCaptainBlackbeardDesktop &amp;&amp; Notification.permission === 'granted') {
      await showNotification(` Captain Blackbeard - Case ${case_id} Resolved`, {
        body: `${vessel_name || 'Vessel'} secured for $${final_amount?.toLocaleString()}`,
        icon: '/favicon.ico',
        tag: 'captain-blackbeard',
        silent: false
      });
    }

    // Refresh messenger to show Captain Blackbeard signature
    if (window.refreshMessengerChatList) {
      window.refreshMessengerChatList();
    }
  } else if (action === 'negotiation_failed') {
    // Show Captain Blackbeard error message as side notification
    const settings = window.getSettings ? window.getSettings() : {};
    const blackbeardErrorMessage = `Ahoy, Landlubber Chick!\n\nI was nothing less than a completely innocent bystander. But do have a look at Case ${case_id}. Something strange happened!\n\n Captain\nBlackbeard`;

    // In-app notification
    if (settings.autoPilotNotifications &amp;&amp; settings.notifyCaptainBlackbeardInApp &amp;&amp; window.showSideNotification) {
      window.showSideNotification(blackbeardErrorMessage, 'error', 12000);
    }

    // Desktop notification
    if (settings.autoPilotNotifications &amp;&amp; settings.notifyCaptainBlackbeardDesktop &amp;&amp; Notification.permission === 'granted') {
      await showNotification(` Captain Blackbeard - Case ${case_id} Failed`, {
        body: `Negotiation failed - check case for details`,
        icon: '/favicon.ico',
        tag: 'captain-blackbeard',
        silent: false
      });
    }
  } else if (action === 'insufficient_funds') {
    // Show Captain Blackbeard insufficient funds message as side notification
    const settings = window.getSettings ? window.getSettings() : {};
    const { required, available } = data.data;
    const blackbeardMoneyMessage = `Ahoy, Landlubber Chick!\n\nI negotiated Case ${case_id} down to $${required?.toLocaleString()}, but your coffers only hold $${available?.toLocaleString()}. Fill them purses, then I'll finish the job!\n\nVessel: ${vessel_name}\n\n Captain\nBlackbeard`;

    // In-app notification
    if (settings.autoPilotNotifications &amp;&amp; settings.notifyCaptainBlackbeardInApp &amp;&amp; window.showSideNotification) {
      window.showSideNotification(blackbeardMoneyMessage, 'warning', 15000);
    }

    // Desktop notification
    if (settings.autoPilotNotifications &amp;&amp; settings.notifyCaptainBlackbeardDesktop &amp;&amp; Notification.permission === 'granted') {
      await showNotification(` Captain Blackbeard - Insufficient Funds`, {
        body: `Case ${case_id}: Need $${required?.toLocaleString()}, have $${available?.toLocaleString()}`,
        icon: '/favicon.ico',
        tag: 'captain-blackbeard',
        silent: false
      });
    }
  }
}

/**
 * Handles event data update from backend
 */
// Store full event data globally for forecast calendar
let cachedEventData = null;

function handleEventDataUpdate(eventData) {
  if (AUTOPILOT_LOG_LEVEL === 'detailed') {
    console.log('[Event] Event data update received:', eventData);
  }

  // Store full event data
  cachedEventData = eventData;

  // Update event info module
  updateEventData(eventData);

  // Update forecast calendar with full event data
  if (eventData &amp;&amp; eventData.discount_type &amp;&amp; eventData.discount_percentage) {
    const eventDiscount = {
      type: eventData.discount_type,
      percentage: eventData.discount_percentage
    };
    updateEventDiscount(eventDiscount, eventData);
  } else {
    updateEventDiscount(null, null);
  }

  // Cache event data for next page load
  if (window.saveBadgeCache) {
    window.saveBadgeCache({
      eventData: eventData
    });
  }
}

/**
 * Marks alliance chat as read by sending the latest message timestamp to backend.
 * This updates the user's last read timestamp, which is used to calculate unread counts
 * and prevent notification spam.
 *
 * Why This Function:
 * - Called when user closes alliance chat overlay
 * - Updates backend read tracking (syncs across devices)
 * - Prevents old messages from showing as unread again
 * - Backend becomes single source of truth for read status
 *
 * Side Effects:
 * - Makes POST request to /api/chat/mark-read
 * - Updates backend read-tracking.json file
 * - Future GET /api/chat calls will use this timestamp
 *
 * @async
 * @returns {Promise&lt;void>}
 *
 * @example
 * // Called when user closes chat overlay
 * await markAllianceChatAsRead();
 */
export async function markAllianceChatAsRead() {
  try {
    // Get the latest message timestamp from allMessages
    if (allMessages.length === 0) {
      return; // No messages to mark as read
    }

    // Find the latest timestamp (messages may have timestampMs from backend)
    const latestTimestamp = Math.max(...allMessages.map(msg => {
      if (msg.timestampMs) {
        return msg.timestampMs;
      } else if (msg.timestamp) {
        return new Date(msg.timestamp).getTime();
      }
      return 0;
    }));

    if (latestTimestamp === 0) {
      return; // No valid timestamps
    }

    // Send mark-read request to backend
    const response = await fetch(window.apiUrl('/api/chat/mark-read'), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ timestamp: latestTimestamp })
    });

    if (!response.ok) {
      // Only log real errors, not temporary server issues
      if (response.status !== 500) {
        console.error('[Chat] Failed to mark messages as read:', response.statusText);
      }
    }
  } catch (error) {
    console.error('[Chat] Error marking messages as read:', error);
  }
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation Version: 0.0.7 - ShippingManager CoPilot
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
