<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>public/js/modules/alliance-tabs.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Dark theme matching app style - carefully scoped to not break layout */
        html, body {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
            overflow-x: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Custom scrollbar styling for all browsers */
        * {
            scrollbar-width: thin !important;
            scrollbar-color: #404040 #1a1a1a !important;
        }

        /* Webkit browsers (Chrome, Safari, Edge) */
        *::-webkit-scrollbar {
            width: 6px !important;
            height: 6px !important;
        }

        *::-webkit-scrollbar-track {
            background: #1a1a1a !important;
        }

        *::-webkit-scrollbar-thumb {
            background-color: #404040 !important;
            border-radius: 3px !important;
        }

        *::-webkit-scrollbar-thumb:hover {
            background-color: #505050 !important;
        }

        /* Navigation sidebar - remove padding and white borders */
        nav {
            background-color: #242424 !important;
            border-right: 1px solid #404040 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow-x: hidden !important;
        }
        nav h2, nav h3 {
            color: #e0e0e0 !important;
            border-bottom: 1px solid #404040 !important;
            padding: 10px 15px !important;
            margin: 0 !important;
            background-color: #242424 !important;
            font-size: 14px !important;
            font-weight: 600 !important;
        }
        nav h3 {
            font-size: 13px !important;
        }
        nav ul {
            padding: 0 !important;
            margin: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li {
            list-style: none !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li a {
            color: #c9d1d9 !important;
            display: block !important;
            padding: 8px 15px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            background-color: #242424 !important;
            margin: 0 !important;
            border: none !important;
            font-size: 14px !important;
        }
        nav ul li a:hover {
            color: #60a5fa !important;
            background-color: rgba(96, 165, 250, 0.1) !important;
        }
        /* Module links (direct children of nav > ul > li) */
        nav > ul > li > a {
            color: #60a5fa !important;
            font-weight: 600 !important;
            padding: 10px 15px !important;
            font-size: 14px !important;
            border-left: 3px solid #60a5fa !important;
            padding-left: 12px !important;
        }
        nav > ul > li > a:hover {
            background-color: rgba(96, 165, 250, 0.15) !important;
        }
        /* Sub-items (methods/functions) indented */
        nav ul.methods {
            padding-left: 15px !important;
        }
        nav ul.methods li a {
            color: #9ca3af !important;
            font-size: 13px !important;
            padding: 6px 15px !important;
            font-weight: 400 !important;
        }
        nav ul.methods li a:hover {
            color: #c9d1d9 !important;
        }
        nav > h2:first-child {
            font-size: 16px !important;
            font-weight: 700 !important;
            padding: 12px 15px !important;
        }

        /* Main content area - dark background */
        #main {
            background-color: #1a1a1a !important;
            padding: 20px !important;
        }

        /* Article and sections - ensure dark background */
        article, section, .container-overview, .description {
            background-color: #1a1a1a !important;
        }

        /* Images - style demo images */
        img {
            max-width: 100% !important;
            height: auto !important;
            border: 1px solid #404040 !important;
            border-radius: 8px !important;
            margin: 20px 0 !important;
        }

        /* Links */
        a {
            color: #60a5fa !important;
            text-decoration: none !important;
        }
        a:hover {
            color: #93c5fd !important;
            text-decoration: underline !important;
        }

        /* Headings */
        h1, h2, h3, h4, h5, h6 {
            color: #e0e0e0 !important;
            border-bottom-color: #404040 !important;
            background-color: transparent !important;
        }
        h4.name {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
        }

        /* Code blocks */
        pre {
            background-color: #0d1117 !important;
            border: 1px solid #404040 !important;
        }
        pre code {
            background-color: transparent !important;
        }
        code {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
        }

        /* Tables */
        table {
            border-color: #404040 !important;
            background-color: #1a1a1a !important;
        }
        table thead tr {
            background-color: #242424 !important;
        }
        table tbody tr {
            background-color: #1a1a1a !important;
        }
        table tbody tr:nth-child(even) {
            background-color: #1f1f1f !important;
        }
        table td, table th {
            border-color: #404040 !important;
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }
        .params .name, .props .name {
            color: #10b981 !important;
            font-family: 'Courier New', monospace !important;
        }

        /* Descriptions and details */
        .description, .details, dt, dd, p, ul, ol, dl {
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }

        /* Types */
        .type-signature {
            color: #a78bfa !important;
        }

        /* Source links */
        .details .details-item-container {
            border-left-color: #404040 !important;
        }

        /* Breadcrumbs */
        .page-title {
            color: #e0e0e0 !important;
        }

        /* Search */
        #nav-search {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
            color: #e0e0e0 !important;
        }

        /* Mobile nav trigger */
        .navicon-button {
            background-color: #2a2a2a !important;
        }

        /* Footer */
        footer {
            background-color: #1a1a1a !important;
            color: #9ca3af !important;
            border-top: 1px solid #404040 !important;
            text-align: center !important;
            padding: 20px !important;
        }

        /* Remove horizontal scrollbar and white borders */
        * {
            box-sizing: border-box !important;
        }
    </style>
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">README</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-build-guide.html">Build Guide</a></li><li><a href="tutorial-installation-guide.html">Installation Guide</a></li></ul><h3>Classes</h3><ul><li><a href="module-core_debounced-api.DebouncedAPIManager.html">DebouncedAPIManager</a><ul class='methods'><li data-type='method'><a href="module-core_debounced-api.DebouncedAPIManager.html#call">call</a></li><li data-type='method'><a href="module-core_debounced-api.DebouncedAPIManager.html#cancelAll">cancelAll</a></li><li data-type='method'><a href="module-core_debounced-api.DebouncedAPIManager.html#get">get</a></li><li data-type='method'><a href="module-core_debounced-api.DebouncedAPIManager.html#register">register</a></li></ul></li><li><a href="module-server_chatbot-ChatBot.html">ChatBot</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot-ChatBot.html#initialize">initialize</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#processAllianceMessage">processAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#processPrivateMessage">processPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#setupScheduledTasks">setupScheduledTasks</a></li><li data-type='method'><a href="module-server_chatbot-ChatBot.html#updateSettings">updateSettings</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-alliance-tabs.html">alliance-tabs</a><ul class='methods'><li data-type='method'><a href="module-alliance-tabs.html#.clearAllianceTabCache">clearAllianceTabCache</a></li><li data-type='method'><a href="module-alliance-tabs.html#.closeAllianceCoopOverlay">closeAllianceCoopOverlay</a></li><li data-type='method'><a href="module-alliance-tabs.html#.getCurrentTab">getCurrentTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#.hideAllAllianceUI">hideAllAllianceUI</a></li><li data-type='method'><a href="module-alliance-tabs.html#.initAllianceTabs">initAllianceTabs</a></li><li data-type='method'><a href="module-alliance-tabs.html#.refreshCurrentTab">refreshCurrentTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#.showAllAllianceUI">showAllAllianceUI</a></li><li data-type='method'><a href="module-alliance-tabs.html#.showAllianceCoopOverlay">showAllianceCoopOverlay</a></li><li data-type='method'><a href="module-alliance-tabs.html#.switchTab">switchTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#.updateCoopTabBadge">updateCoopTabBadge</a></li><li data-type='method'><a href="module-alliance-tabs.html#~acceptUserToAlliance">acceptUserToAlliance</a></li><li data-type='method'><a href="module-alliance-tabs.html#~appendSearchResults">appendSearchResults</a></li><li data-type='method'><a href="module-alliance-tabs.html#~attachAllianceClickHandlers">attachAllianceClickHandlers</a></li><li data-type='method'><a href="module-alliance-tabs.html#~attachSearchEventListeners">attachSearchEventListeners</a></li><li data-type='method'><a href="module-alliance-tabs.html#~createAllianceRow">createAllianceRow</a></li><li data-type='method'><a href="module-alliance-tabs.html#~declineUserFromAlliance">declineUserFromAlliance</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchAllianceInfo">fetchAllianceInfo</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchAllianceInfoById">fetchAllianceInfoById</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchAllianceMembers">fetchAllianceMembers</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchAllianceMembersById">fetchAllianceMembersById</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchAllianceSettings">fetchAllianceSettings</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchHighScores">fetchHighScores</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchLeagueInfo">fetchLeagueInfo</a></li><li data-type='method'><a href="module-alliance-tabs.html#~fetchQueuePool">fetchQueuePool</a></li><li data-type='method'><a href="module-alliance-tabs.html#~generateAllianceInfoHTML">generateAllianceInfoHTML</a></li><li data-type='method'><a href="module-alliance-tabs.html#~handleJoinAllianceClick">handleJoinAllianceClick</a></li><li data-type='method'><a href="module-alliance-tabs.html#~leaveAlliance">leaveAlliance</a></li><li data-type='method'><a href="module-alliance-tabs.html#~loadTabContent">loadTabContent</a></li><li data-type='method'><a href="module-alliance-tabs.html#~loadWelcomeMessage">loadWelcomeMessage</a></li><li data-type='method'><a href="module-alliance-tabs.html#~normalizeColor">normalizeColor</a></li><li data-type='method'><a href="module-alliance-tabs.html#~performSearch">performSearch</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderAllianzTab">renderAllianzTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderCoopTab">renderCoopTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderHighScoreTab">renderHighScoreTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderLigaTab">renderLigaTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderManagementTab">renderManagementTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderMemberCard">renderMemberCard</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderSearchResults">renderSearchResults</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderSearchTab">renderSearchTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~renderSettingsTab">renderSettingsTab</a></li><li data-type='method'><a href="module-alliance-tabs.html#~saveWelcomeMessage">saveWelcomeMessage</a></li><li data-type='method'><a href="module-alliance-tabs.html#~sendWelcomeMessageToUser">sendWelcomeMessageToUser</a></li><li data-type='method'><a href="module-alliance-tabs.html#~showAllianceDetailsModal">showAllianceDetailsModal</a></li><li data-type='method'><a href="module-alliance-tabs.html#~showDonateDialog">showDonateDialog</a></li><li data-type='method'><a href="module-alliance-tabs.html#~showTextInputDialog">showTextInputDialog</a></li><li data-type='method'><a href="module-alliance-tabs.html#~updateAllianceSettings">updateAllianceSettings</a></li><li data-type='method'><a href="module-alliance-tabs.html#~updateManagementTabVisibility">updateManagementTabVisibility</a></li><li data-type='method'><a href="module-alliance-tabs.html#~updateTabVisibilityForAllianceMembers">updateTabVisibilityForAllianceMembers</a></li><li data-type='method'><a href="module-alliance-tabs.html#~updateTabVisibilityForNonMembers">updateTabVisibilityForNonMembers</a></li><li data-type='method'><a href="module-alliance-tabs.html#~updateUserRole">updateUserRole</a></li><li data-type='method'><a href="module-alliance-tabs.html#~updateWelcomeMessageCharCount">updateWelcomeMessageCharCount</a></li></ul></li><li><a href="module-api.html">api</a><ul class='methods'><li data-type='method'><a href="module-api.html#.activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-api.html#.deleteAllLogs">deleteAllLogs</a></li><li data-type='method'><a href="module-api.html#.deleteChat">deleteChat</a></li><li data-type='method'><a href="module-api.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-api.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-api.html#.departVessels">departVessels</a></li><li data-type='method'><a href="module-api.html#.doWearMaintenanceBulk">doWearMaintenanceBulk</a></li><li data-type='method'><a href="module-api.html#.downloadLogbookExport">downloadLogbookExport</a></li><li data-type='method'><a href="module-api.html#.fetchAcquirableVessels">fetchAcquirableVessels</a></li><li data-type='method'><a href="module-api.html#.fetchAllianceMembers">fetchAllianceMembers</a></li><li data-type='method'><a href="module-api.html#.fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-api.html#.fetchBunkerPrices">fetchBunkerPrices</a></li><li data-type='method'><a href="module-api.html#.fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-api.html#.fetchChat">fetchChat</a></li><li data-type='method'><a href="module-api.html#.fetchContacts">fetchContacts</a></li><li data-type='method'><a href="module-api.html#.fetchLogbookEntries">fetchLogbookEntries</a></li><li data-type='method'><a href="module-api.html#.fetchLogbookFileSize">fetchLogbookFileSize</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerChats">fetchMessengerChats</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerMessages">fetchMessengerMessages</a></li><li data-type='method'><a href="module-api.html#.fetchUserCompany">fetchUserCompany</a></li><li data-type='method'><a href="module-api.html#.fetchUserSettings">fetchUserSettings</a></li><li data-type='method'><a href="module-api.html#.fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-api.html#.getCompanyNameCached">getCompanyNameCached</a></li><li data-type='method'><a href="module-api.html#.getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-api.html#.markChatAsRead">markChatAsRead</a></li><li data-type='method'><a href="module-api.html#.purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-api.html#.purchaseFuel">purchaseFuel</a></li><li data-type='method'><a href="module-api.html#.purchaseVessel">purchaseVessel</a></li><li data-type='method'><a href="module-api.html#.searchUsers">searchUsers</a></li><li data-type='method'><a href="module-api.html#.sendChatMessage">sendChatMessage</a></li><li data-type='method'><a href="module-api.html#.sendPrivateMessage">sendPrivateMessage</a></li></ul></li><li><a href="module-app.html">app</a></li><li><a href="module-automation.html">automation</a><ul class='methods'><li data-type='method'><a href="module-automation.html#.initAutomation">initAutomation</a></li><li data-type='method'><a href="module-automation.html#.runAutomationChecks">runAutomationChecks</a></li><li data-type='method'><a href="module-automation.html#.triggerAutoRebuyChecks">triggerAutoRebuyChecks</a></li><li data-type='method'><a href="module-automation.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-automation.html#~checkAutoCampaignRenewal">checkAutoCampaignRenewal</a></li><li data-type='method'><a href="module-automation.html#~checkAutoDepartAll">checkAutoDepartAll</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyCO2">checkAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyFuel">checkAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~getTotalCapacity">getTotalCapacity</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyCO2">performAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyFuel">performAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~updateAutoDepartLabel">updateAutoDepartLabel</a></li></ul></li><li><a href="module-badge-manager.html">badge-manager</a><ul class='methods'><li data-type='method'><a href="module-badge-manager.html#.getBadgeCount">getBadgeCount</a></li><li data-type='method'><a href="module-badge-manager.html#.hideBadge">hideBadge</a></li><li data-type='method'><a href="module-badge-manager.html#.showBadge">showBadge</a></li><li data-type='method'><a href="module-badge-manager.html#.updateBadge">updateBadge</a></li><li data-type='method'><a href="module-badge-manager.html#.updateButtonState">updateButtonState</a></li><li data-type='method'><a href="module-badge-manager.html#.updateButtonTooltip">updateButtonTooltip</a></li><li data-type='method'><a href="module-badge-manager.html#.updateButtonVisibility">updateButtonVisibility</a></li></ul></li><li><a href="module-bunker-management.html">bunker-management</a><ul class='methods'><li data-type='method'><a href="module-bunker-management.html#.buyMaxCO2">buyMaxCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.buyMaxFuel">buyMaxFuel</a></li><li data-type='method'><a href="module-bunker-management.html#.getCurrentBunkerState">getCurrentBunkerState</a></li><li data-type='method'><a href="module-bunker-management.html#.setCapacityFromBunkerUpdate">setCapacityFromBunkerUpdate</a></li><li data-type='method'><a href="module-bunker-management.html#.updateBunkerStatus">updateBunkerStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCO2">updateCurrentCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCash">updateCurrentCash</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentFuel">updateCurrentFuel</a></li></ul></li><li><a href="module-chat.html">chat</a><ul class='methods'><li data-type='method'><a href="module-chat.html#.displayMessages">displayMessages</a></li><li data-type='method'><a href="module-chat.html#.handleMessageInput">handleMessageInput</a></li><li data-type='method'><a href="module-chat.html#.initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-chat.html#.loadAllianceMembers">loadAllianceMembers</a></li><li data-type='method'><a href="module-chat.html#.loadMessages">loadMessages</a></li><li data-type='method'><a href="module-chat.html#.markAllianceChatAsRead">markAllianceChatAsRead</a></li><li data-type='method'><a href="module-chat.html#.parseMessageWithMentions">parseMessageWithMentions</a></li><li data-type='method'><a href="module-chat.html#.sendMessage">sendMessage</a></li><li data-type='method'><a href="module-chat.html#.setChatScrollListener">setChatScrollListener</a></li><li data-type='method'><a href="module-chat.html#~attemptReconnect">attemptReconnect</a></li><li data-type='method'><a href="module-chat.html#~displaySuggestions">displaySuggestions</a></li><li data-type='method'><a href="module-chat.html#~formatLocalTime">formatLocalTime</a></li><li data-type='method'><a href="module-chat.html#~handleAllianceChanged">handleAllianceChanged</a></li><li data-type='method'><a href="module-chat.html#~handleAllianceIndexReady">handleAllianceIndexReady</a></li><li data-type='method'><a href="module-chat.html#~handleAutoCoopComplete">handleAutoCoopComplete</a></li><li data-type='method'><a href="module-chat.html#~handleAutoCoopNoTargets">handleAutoCoopNoTargets</a></li><li data-type='method'><a href="module-chat.html#~handleAutopilotDepartStart">handleAutopilotDepartStart</a></li><li data-type='method'><a href="module-chat.html#~handleBackendAutoRepairComplete">handleBackendAutoRepairComplete</a></li><li data-type='method'><a href="module-chat.html#~handleBunkerUpdate">handleBunkerUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleCO2Purchased">handleCO2Purchased</a></li><li data-type='method'><a href="module-chat.html#~handleCampaignsRenewed">handleCampaignsRenewed</a></li><li data-type='method'><a href="module-chat.html#~handleCompanyTypeUpdate">handleCompanyTypeUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleCoopUpdate">handleCoopUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleDrydockCountUpdate">handleDrydockCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleFuelPurchased">handleFuelPurchased</a></li><li data-type='method'><a href="module-chat.html#~handleGenericNotification">handleGenericNotification</a></li><li data-type='method'><a href="module-chat.html#~handleHarborMapRefreshRequired">handleHarborMapRefreshRequired</a></li><li data-type='method'><a href="module-chat.html#~handleHeaderDataUpdate">handleHeaderDataUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleHijackingUpdate">handleHijackingUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleMentionAutocomplete">handleMentionAutocomplete</a></li><li data-type='method'><a href="module-chat.html#~handleMessengerUpdate">handleMessengerUpdate</a></li><li data-type='method'><a href="module-chat.html#~handlePriceAlert">handlePriceAlert</a></li><li data-type='method'><a href="module-chat.html#~handlePriceUpdate">handlePriceUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleRepairCountUpdate">handleRepairCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleStaffTrainingPointsUpdate">handleStaffTrainingPointsUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleStaffUpdate">handleStaffUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleUnreadMessagesUpdate">handleUnreadMessagesUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleUserActionNotification">handleUserActionNotification</a></li><li data-type='method'><a href="module-chat.html#~handleVesselCountUpdate">handleVesselCountUpdate</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDepartBatch">handleVesselsDepartBatch</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDepartComplete">handleVesselsDepartComplete</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDeparted">handleVesselsDeparted</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsDrydocked">handleVesselsDrydocked</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsFailed">handleVesselsFailed</a></li><li data-type='method'><a href="module-chat.html#~handleVesselsRepaired">handleVesselsRepaired</a></li><li data-type='method'><a href="module-chat.html#~hideMemberSuggestions">hideMemberSuggestions</a></li><li data-type='method'><a href="module-chat.html#~insertMention">insertMention</a></li><li data-type='method'><a href="module-chat.html#~registerUsernameClickEvents">registerUsernameClickEvents</a></li><li data-type='method'><a href="module-chat.html#~updateAllianceChatBadge">updateAllianceChatBadge</a></li></ul></li><li><a href="module-company-profile.html">company-profile</a><ul class='methods'><li data-type='method'><a href="module-company-profile.html#.closeCompanyProfile">closeCompanyProfile</a></li><li data-type='method'><a href="module-company-profile.html#.initCompanyProfile">initCompanyProfile</a></li><li data-type='method'><a href="module-company-profile.html#.openCompanyProfile">openCompanyProfile</a></li><li data-type='method'><a href="module-company-profile.html#.openPlayerProfile">openPlayerProfile</a></li><li data-type='method'><a href="module-company-profile.html#~adjustSalary">adjustSalary</a></li><li data-type='method'><a href="module-company-profile.html#~attachAllianceClickListener">attachAllianceClickListener</a></li><li data-type='method'><a href="module-company-profile.html#~attachSalaryButtonListeners">attachSalaryButtonListeners</a></li><li data-type='method'><a href="module-company-profile.html#~buildAchievementsSection">buildAchievementsSection</a></li><li data-type='method'><a href="module-company-profile.html#~buildSection">buildSection</a></li><li data-type='method'><a href="module-company-profile.html#~buildStaffSection">buildStaffSection</a></li><li data-type='method'><a href="module-company-profile.html#~formatLabel">formatLabel</a></li><li data-type='method'><a href="module-company-profile.html#~formatMoraleLabel">formatMoraleLabel</a></li><li data-type='method'><a href="module-company-profile.html#~formatPerkName">formatPerkName</a></li><li data-type='method'><a href="module-company-profile.html#~formatValue">formatValue</a></li><li data-type='method'><a href="module-company-profile.html#~generateMoraleSmiley">generateMoraleSmiley</a></li><li data-type='method'><a href="module-company-profile.html#~loadCompanyProfile">loadCompanyProfile</a></li><li data-type='method'><a href="module-company-profile.html#~loadStaffData">loadStaffData</a></li><li data-type='method'><a href="module-company-profile.html#~renderCompanyProfile">renderCompanyProfile</a></li><li data-type='method'><a href="module-company-profile.html#~renderSearchResults">renderSearchResults</a></li><li data-type='method'><a href="module-company-profile.html#~searchPlayers">searchPlayers</a></li><li data-type='method'><a href="module-company-profile.html#~toggleAchievementsList">toggleAchievementsList</a></li><li data-type='method'><a href="module-company-profile.html#~toggleStaffDetails">toggleStaffDetails</a></li><li data-type='method'><a href="module-company-profile.html#~trainPerk">trainPerk</a></li></ul></li><li><a href="module-coop.html">coop</a><ul class='methods'><li data-type='method'><a href="module-coop.html#.closeCoopOverlay">closeCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.fetchCoopData">fetchCoopData</a></li><li data-type='method'><a href="module-coop.html#.sendCoopMax">sendCoopMax</a></li><li data-type='method'><a href="module-coop.html#.showCoopOverlay">showCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.updateCoopBadge">updateCoopBadge</a></li><li data-type='method'><a href="module-coop.html#~renderMemberCard">renderMemberCard</a></li></ul></li><li><a href="module-core_app-initializer.html">core/app-initializer</a><ul class='methods'><li data-type='method'><a href="module-core_app-initializer.html#.initializeApp">initializeApp</a></li><li data-type='method'><a href="module-core_app-initializer.html#~createAllianceChatHandler">createAllianceChatHandler</a></li><li data-type='method'><a href="module-core_app-initializer.html#~createBuyVesselsHandler">createBuyVesselsHandler</a></li><li data-type='method'><a href="module-core_app-initializer.html#~createDebouncedFunctions">createDebouncedFunctions</a></li><li data-type='method'><a href="module-core_app-initializer.html#~createForecastHandler">createForecastHandler</a></li><li data-type='method'><a href="module-core_app-initializer.html#~createTestBrowserNotification">createTestBrowserNotification</a></li><li data-type='method'><a href="module-core_app-initializer.html#~exposeGlobalFunctions">exposeGlobalFunctions</a></li><li data-type='method'><a href="module-core_app-initializer.html#~formatNumberWithSeparator">formatNumberWithSeparator</a></li><li data-type='method'><a href="module-core_app-initializer.html#~initializeSettingsUI">initializeSettingsUI</a></li><li data-type='method'><a href="module-core_app-initializer.html#~loadInitialData">loadInitialData</a></li><li data-type='method'><a href="module-core_app-initializer.html#~loadUserSettings">loadUserSettings</a></li><li data-type='method'><a href="module-core_app-initializer.html#~registerAllEventListeners">registerAllEventListeners</a></li><li data-type='method'><a href="module-core_app-initializer.html#~setCheckboxState">setCheckboxState</a></li><li data-type='method'><a href="module-core_app-initializer.html#~setCheckboxValue">setCheckboxValue</a></li><li data-type='method'><a href="module-core_app-initializer.html#~setFormattedInputValue">setFormattedInputValue</a></li><li data-type='method'><a href="module-core_app-initializer.html#~setInputValue">setInputValue</a></li><li data-type='method'><a href="module-core_app-initializer.html#~toggleElementVisibility">toggleElementVisibility</a></li></ul></li><li><a href="module-core_auto-refresh.html">core/auto-refresh</a><ul class='methods'><li data-type='method'><a href="module-core_auto-refresh.html#.getActiveIntervals">getActiveIntervals</a></li><li data-type='method'><a href="module-core_auto-refresh.html#.initNotificationButtonUpdater">initNotificationButtonUpdater</a></li><li data-type='method'><a href="module-core_auto-refresh.html#.initVersionChecker">initVersionChecker</a></li><li data-type='method'><a href="module-core_auto-refresh.html#.initVisibilityHandler">initVisibilityHandler</a></li><li data-type='method'><a href="module-core_auto-refresh.html#.preloadAllImages">preloadAllImages</a></li><li data-type='method'><a href="module-core_auto-refresh.html#.stopAllIntervals">stopAllIntervals</a></li><li data-type='method'><a href="module-core_auto-refresh.html#.stopInterval">stopInterval</a></li></ul></li><li><a href="module-core_badge-cache.html">core/badge-cache</a><ul class='methods'><li data-type='method'><a href="module-core_badge-cache.html#.loadCache">loadCache</a></li><li data-type='method'><a href="module-core_badge-cache.html#.saveBadgeCache">saveBadgeCache</a></li><li data-type='method'><a href="module-core_badge-cache.html#.updateCoopDisplay">updateCoopDisplay</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadBunkerStatus">loadBunkerStatus</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadCampaignsBadge">loadCampaignsBadge</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadCoopData">loadCoopData</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadHijackingBadge">loadHijackingBadge</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadPrices">loadPrices</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadRepairBadges">loadRepairBadges</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadStockAndAnchor">loadStockAndAnchor</a></li><li data-type='method'><a href="module-core_badge-cache.html#~loadVesselBadges">loadVesselBadges</a></li></ul></li><li><a href="module-core_debounced-api.html">core/debounced-api</a><ul class='methods'><li data-type='method'><a href="module-core_debounced-api.html#.cancelAllDebouncedFunctions">cancelAllDebouncedFunctions</a></li><li data-type='method'><a href="module-core_debounced-api.html#.cancelDebouncedFunction">cancelDebouncedFunction</a></li><li data-type='method'><a href="module-core_debounced-api.html#.createDebouncedFunction">createDebouncedFunction</a></li><li data-type='method'><a href="module-core_debounced-api.html#.isDebouncePending">isDebouncePending</a></li></ul></li><li><a href="module-core_event-registry.html">core/event-registry</a><ul class='methods'><li data-type='method'><a href="module-core_event-registry.html#.registerAutoDepartSettingsListeners">registerAutoDepartSettingsListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerAutoPilotFeatureListeners">registerAutoPilotFeatureListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerAutoPilotListeners">registerAutoPilotListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerAutoRebuyCO2Listeners">registerAutoRebuyCO2Listeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerAutoRebuyFuelListeners">registerAutoRebuyFuelListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerBunkerListeners">registerBunkerListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerChatBotSettingsListeners">registerChatBotSettingsListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerChatEventListeners">registerChatEventListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerCustomCommandsListeners">registerCustomCommandsListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerDialogEventListeners">registerDialogEventListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerMessengerEventListeners">registerMessengerEventListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerNotificationPermissionListener">registerNotificationPermissionListener</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerNumberFormatting">registerNumberFormatting</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerSectionToggle">registerSectionToggle</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerSettingsThresholdListeners">registerSettingsThresholdListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#.registerVesselCatalogEventListeners">registerVesselCatalogEventListeners</a></li><li data-type='method'><a href="module-core_event-registry.html#~createCustomCommandElement">createCustomCommandElement</a></li><li data-type='method'><a href="module-core_event-registry.html#~formatNumberWithSeparator">formatNumberWithSeparator</a></li></ul></li><li><a href="module-core_global-exports.html">core/global-exports</a><ul class='methods'><li data-type='method'><a href="module-core_global-exports.html#.exportApiUrl">exportApiUrl</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportAutopilotFunctions">exportAutopilotFunctions</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportCacheKeys">exportCacheKeys</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportDebouncedFunctions">exportDebouncedFunctions</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportDebugMode">exportDebugMode</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportGlobals">exportGlobals</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportLogbookHandler">exportLogbookHandler</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportOverlayFunctions">exportOverlayFunctions</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportSettingsHandler">exportSettingsHandler</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportStorageFunctions">exportStorageFunctions</a></li><li data-type='method'><a href="module-core_global-exports.html#.exportVersionFunctions">exportVersionFunctions</a></li></ul></li><li><a href="module-core_settings-sync.html">core/settings-sync</a><ul class='methods'><li data-type='method'><a href="module-core_settings-sync.html#.handleSettingsUpdate">handleSettingsUpdate</a></li><li data-type='method'><a href="module-core_settings-sync.html#.toggleAutoPilotAgentCheckboxes">toggleAutoPilotAgentCheckboxes</a></li><li data-type='method'><a href="module-core_settings-sync.html#~formatNumberWithSeparator">formatNumberWithSeparator</a></li><li data-type='method'><a href="module-core_settings-sync.html#~updateAutoPilotToggles">updateAutoPilotToggles</a></li><li data-type='method'><a href="module-core_settings-sync.html#~updateAutoRebuyCO2UI">updateAutoRebuyCO2UI</a></li><li data-type='method'><a href="module-core_settings-sync.html#~updateAutoRebuyFuelUI">updateAutoRebuyFuelUI</a></li><li data-type='method'><a href="module-core_settings-sync.html#~updateChatBotSettings">updateChatBotSettings</a></li><li data-type='method'><a href="module-core_settings-sync.html#~updateNotificationSettings">updateNotificationSettings</a></li><li data-type='method'><a href="module-core_settings-sync.html#~updateThresholdInputs">updateThresholdInputs</a></li></ul></li><li><a href="module-core_storage-manager.html">core/storage-manager</a><ul class='methods'><li data-type='method'><a href="module-core_storage-manager.html#.clearUserStorage">clearUserStorage</a></li><li data-type='method'><a href="module-core_storage-manager.html#.getStorage">getStorage</a></li><li data-type='method'><a href="module-core_storage-manager.html#.getUserStorageKey">getUserStorageKey</a></li><li data-type='method'><a href="module-core_storage-manager.html#.getUserStoragePrefix">getUserStoragePrefix</a></li><li data-type='method'><a href="module-core_storage-manager.html#.removeStorage">removeStorage</a></li><li data-type='method'><a href="module-core_storage-manager.html#.setStorage">setStorage</a></li><li data-type='method'><a href="module-core_storage-manager.html#.setUserStoragePrefix">setUserStoragePrefix</a></li></ul></li><li><a href="module-core_websocket-client.html">core/websocket-client</a><ul class='methods'><li data-type='method'><a href="module-core_websocket-client.html#.getWebSocketState">getWebSocketState</a></li><li data-type='method'><a href="module-core_websocket-client.html#.incrementReconnectCounter">incrementReconnectCounter</a></li><li data-type='method'><a href="module-core_websocket-client.html#.initAutopilotControls">initAutopilotControls</a></li><li data-type='method'><a href="module-core_websocket-client.html#.loadAutopilotState">loadAutopilotState</a></li><li data-type='method'><a href="module-core_websocket-client.html#.resetReconnectCounter">resetReconnectCounter</a></li><li data-type='method'><a href="module-core_websocket-client.html#.triggerPriceAlertCheck">triggerPriceAlertCheck</a></li><li data-type='method'><a href="module-core_websocket-client.html#.updateWebSocketState">updateWebSocketState</a></li></ul></li><li><a href="module-depart-manager.html">depart-manager</a><ul class='methods'><li data-type='method'><a href="module-depart-manager.html#.closeDepartManager">closeDepartManager</a></li><li data-type='method'><a href="module-depart-manager.html#.initializeDepartManager">initializeDepartManager</a></li><li data-type='method'><a href="module-depart-manager.html#.openDepartManager">openDepartManager</a></li><li data-type='method'><a href="module-depart-manager.html#.toggleDepartManager">toggleDepartManager</a></li><li data-type='method'><a href="module-depart-manager.html#~departSelectedVessels">departSelectedVessels</a></li><li data-type='method'><a href="module-depart-manager.html#~drag">drag</a></li><li data-type='method'><a href="module-depart-manager.html#~loadDepartableVessels">loadDepartableVessels</a></li><li data-type='method'><a href="module-depart-manager.html#~locateVesselOnMap">locateVesselOnMap</a></li><li data-type='method'><a href="module-depart-manager.html#~selectAllVessels">selectAllVessels</a></li><li data-type='method'><a href="module-depart-manager.html#~selectRouteInMapFilter">selectRouteInMapFilter</a></li><li data-type='method'><a href="module-depart-manager.html#~startDrag">startDrag</a></li><li data-type='method'><a href="module-depart-manager.html#~stopDrag">stopDrag</a></li><li data-type='method'><a href="module-depart-manager.html#~unselectAllVessels">unselectAllVessels</a></li><li data-type='method'><a href="module-depart-manager.html#~updateDepartButtonCount">updateDepartButtonCount</a></li></ul></li><li><a href="module-desktop-notification-templates.html">desktop-notification-templates</a><ul class='methods'><li data-type='method'><a href="module-desktop-notification-templates.html#.createDesktopNotification">createDesktopNotification</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.getDefaultEmoji">getDefaultEmoji</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.getNotificationTypes">getNotificationTypes</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.isValidNotificationType">isValidNotificationType</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyAlert">notifyAlert</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyError">notifyError</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifySuccess">notifySuccess</a></li><li data-type='method'><a href="module-desktop-notification-templates.html#.notifyWarning">notifyWarning</a></li></ul></li><li><a href="module-event-info.html">event-info</a><ul class='methods'><li data-type='method'><a href="module-event-info.html#.initEventInfo">initEventInfo</a></li><li data-type='method'><a href="module-event-info.html#.openEventModal">openEventModal</a></li><li data-type='method'><a href="module-event-info.html#.updateEventData">updateEventData</a></li><li data-type='method'><a href="module-event-info.html#~startEventTimer">startEventTimer</a></li></ul></li><li><a href="module-forecast-calendar.html">forecast-calendar</a><ul class='methods'><li data-type='method'><a href="module-forecast-calendar.html#.initForecastCalendar">initForecastCalendar</a></li><li data-type='method'><a href="module-forecast-calendar.html#.updateEventDiscount">updateEventDiscount</a></li><li data-type='method'><a href="module-forecast-calendar.html#~createTableHTML">createTableHTML</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getBrowserTimezone">getBrowserTimezone</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getCo2Class">getCo2Class</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getCurrentVisibleDay">getCurrentVisibleDay</a></li><li data-type='method'><a href="module-forecast-calendar.html#~getFuelClass">getFuelClass</a></li><li data-type='method'><a href="module-forecast-calendar.html#~isEventActiveAtTime">isEventActiveAtTime</a></li><li data-type='method'><a href="module-forecast-calendar.html#~isEventActiveOnDay">isEventActiveOnDay</a></li><li data-type='method'><a href="module-forecast-calendar.html#~loadForecastData">loadForecastData</a></li><li data-type='method'><a href="module-forecast-calendar.html#~preloadMonth">preloadMonth</a></li><li data-type='method'><a href="module-forecast-calendar.html#~renderBook">renderBook</a></li><li data-type='method'><a href="module-forecast-calendar.html#~updateEventBadge">updateEventBadge</a></li></ul></li><li><a href="module-harbor-map-aggregator.html">harbor-map-aggregator</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-aggregator.html#~aggregateReachablePorts">aggregateReachablePorts</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~aggregateVesselData">aggregateVesselData</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~categorizeVesselsByPort">categorizeVesselsByPort</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~extractPortsFromGameIndex">extractPortsFromGameIndex</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~extractVesselsFromGameIndex">extractVesselsFromGameIndex</a></li><li data-type='method'><a href="module-harbor-map-aggregator.html#~filterAssignedPorts">filterAssignedPorts</a></li></ul></li><li><a href="module-harbor-map-calculator.html">harbor-map-calculator</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateCargoUtilization">calculateCargoUtilization</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateDemandLevel">calculateDemandLevel</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateETA">calculateETA</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~calculateVesselPosition">calculateVesselPosition</a></li><li data-type='method'><a href="module-harbor-map-calculator.html#~formatCargoCapacity">formatCargoCapacity</a></li></ul></li><li><a href="module-harbor-map-init.html">harbor-map-init</a><ul class='methods'><li data-type='method'><a href="module-harbor-map-init.html#.closeHarborMap">closeHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.initHarborMap">initHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.openHarborMap">openHarborMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.preloadHarborMapData">preloadHarborMapData</a></li><li data-type='method'><a href="module-harbor-map-init.html#.refreshHarborMapIfOpen">refreshHarborMapIfOpen</a></li><li data-type='method'><a href="module-harbor-map-init.html#.reloadMap">reloadMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#.startHarborMapAutoUpdate">startHarborMapAutoUpdate</a></li><li data-type='method'><a href="module-harbor-map-init.html#.stopHarborMapAutoUpdate">stopHarborMapAutoUpdate</a></li><li data-type='method'><a href="module-harbor-map-init.html#~departVesselWrapper">departVesselWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~getVesselByIdWrapper">getVesselByIdWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~selectVesselFromMap">selectVesselFromMap</a></li><li data-type='method'><a href="module-harbor-map-init.html#~sellVesselFromPanelWrapper">sellVesselFromPanelWrapper</a></li><li data-type='method'><a href="module-harbor-map-init.html#~updateVesselMarkerWrapper">updateVesselMarkerWrapper</a></li></ul></li><li><a href="module-harbor-map_api-client.html">harbor-map/api-client</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_api-client.html#.clearHarborMapCache">clearHarborMapCache</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.exportVesselHistory">exportVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchHarborMapOverview">fetchHarborMapOverview</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchPortDetails">fetchPortDetails</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchVesselHistory">fetchVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.fetchVesselReachablePorts">fetchVesselReachablePorts</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.getCachedOverview">getCachedOverview</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.invalidateOverviewCache">invalidateOverviewCache</a></li><li data-type='method'><a href="module-harbor-map_api-client.html#.prefetchHarborMapData">prefetchHarborMapData</a></li></ul></li><li><a href="module-harbor-map_filters.html">harbor-map/filters</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_filters.html#.filterPorts">filterPorts</a></li><li data-type='method'><a href="module-harbor-map_filters.html#.filterVessels">filterVessels</a></li><li data-type='method'><a href="module-harbor-map_filters.html#.getPortFilterOptions">getPortFilterOptions</a></li><li data-type='method'><a href="module-harbor-map_filters.html#.getVesselFilterOptions">getVesselFilterOptions</a></li><li data-type='method'><a href="module-harbor-map_filters.html#~calculateVesselUtilization">calculateVesselUtilization</a></li></ul></li><li><a href="module-harbor-map_map-controller.html">harbor-map/map-controller</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_map-controller.html#.clearRoute">clearRoute</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.closeAllPanels">closeAllPanels</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.deselectAll">deselectAll</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.drawRoute">drawRoute</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getCurrentPorts">getCurrentPorts</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getMap">getMap</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getSelectedPortCode">getSelectedPortCode</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.getVesselById">getVesselById</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.initMap">initMap</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.loadOverview">loadOverview</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.renderPorts">renderPorts</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.renderVessels">renderVessels</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.selectPort">selectPort</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.selectVessel">selectVessel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.setPortFilter">setPortFilter</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.setRouteFilter">setRouteFilter</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.setVesselFilter">setVesselFilter</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.updateVesselMarker">updateVesselMarker</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#.updateWeatherDataSetting">updateWeatherDataSetting</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~addCustomControls">addCustomControls</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~applyFiltersAndRender">applyFiltersAndRender</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~applyMapTheme">applyMapTheme</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~calculateHeading">calculateHeading</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~categorizeVesselsByPortClientSide">categorizeVesselsByPortClientSide</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~changeTileLayer">changeTileLayer</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~createVesselIcon">createVesselIcon</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~getVesselType">getVesselType</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~hideRouteVesselsPanel">hideRouteVesselsPanel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~showRouteVesselsPanel">showRouteVesselsPanel</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~showWeatherInfo">showWeatherInfo</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~toggleWeatherLayer">toggleWeatherLayer</a></li><li data-type='method'><a href="module-harbor-map_map-controller.html#~updateRouteDropdown">updateRouteDropdown</a></li></ul></li><li><a href="module-harbor-map_panel-drag.html">harbor-map/panel-drag</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_panel-drag.html#.initializePanelDrag">initializePanelDrag</a></li></ul></li><li><a href="module-harbor-map_port-panel.html">harbor-map/port-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_port-panel.html#.closePortPanel">closePortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.hidePortPanel">hidePortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.selectVesselFromPort">selectVesselFromPort</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#.showPortPanel">showPortPanel</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#~loadPortWeather">loadPortWeather</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#~renderDemandSection">renderDemandSection</a></li><li data-type='method'><a href="module-harbor-map_port-panel.html#~renderVesselList">renderVesselList</a></li></ul></li><li><a href="module-harbor-map_route-vessels-panel.html">harbor-map/route-vessels-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.closeRoutePanel">closeRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.hideRoutePanel">hideRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.selectRouteVessel">selectRouteVessel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#.showRoutePanel">showRoutePanel</a></li><li data-type='method'><a href="module-harbor-map_route-vessels-panel.html#~storeVessels">storeVessels</a></li></ul></li><li><a href="module-harbor-map_vessel-panel.html">harbor-map/vessel-panel</a><ul class='methods'><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.closeVesselPanel">closeVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.exportHistoryFormat">exportHistoryFormat</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.hideVesselPanel">hideVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.sellVesselFromPanel">sellVesselFromPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.showVesselPanel">showVesselPanel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.startRenameVessel">startRenameVessel</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#.toggleExportMenu">toggleExportMenu</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~cancelVesselRename">cancelVesselRename</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~closeExportMenuOnClickOutside">closeExportMenuOnClickOutside</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~getCountryFlag">getCountryFlag</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~getPortCountryCode">getPortCountryCode</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~loadVesselHistory">loadVesselHistory</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~loadVesselWeather">loadVesselWeather</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~openRepairDialog">openRepairDialog</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~processDepartureQueue">processDepartureQueue</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~renderHistoryPage">renderHistoryPage</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~saveVesselRename">saveVesselRename</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~setupInfiniteScroll">setupInfiniteScroll</a></li><li data-type='method'><a href="module-harbor-map_vessel-panel.html#~toggleParkVessel">toggleParkVessel</a></li></ul></li><li><a href="module-logbook.html">logbook</a><ul class='methods'><li data-type='method'><a href="module-logbook.html#.deleteAllLogsConfirmed">deleteAllLogsConfirmed</a></li><li data-type='method'><a href="module-logbook.html#.getLogFileSize">getLogFileSize</a></li><li data-type='method'><a href="module-logbook.html#.initLogbook">initLogbook</a></li><li data-type='method'><a href="module-logbook.html#.prependLogEntry">prependLogEntry</a></li><li data-type='method'><a href="module-logbook.html#~convertActionFilterToBackend">convertActionFilterToBackend</a></li><li data-type='method'><a href="module-logbook.html#~exportLogs">exportLogs</a></li><li data-type='method'><a href="module-logbook.html#~formatDetails">formatDetails</a></li><li data-type='method'><a href="module-logbook.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-logbook.html#~getTransactionType">getTransactionType</a></li><li data-type='method'><a href="module-logbook.html#~loadLogs">loadLogs</a></li><li data-type='method'><a href="module-logbook.html#~renderLogTable">renderLogTable</a></li><li data-type='method'><a href="module-logbook.html#~updateActionFilter">updateActionFilter</a></li></ul></li><li><a href="module-map-icon-bar.html">map-icon-bar</a><ul class='methods'><li data-type='method'><a href="module-map-icon-bar.html#.initializeMapIconBar">initializeMapIconBar</a></li><li data-type='method'><a href="module-map-icon-bar.html#~handleIconAction">handleIconAction</a></li></ul></li><li><a href="module-messenger.html">messenger</a><ul class='methods'><li data-type='method'><a href="module-messenger.html#.closeAllChats">closeAllChats</a></li><li data-type='method'><a href="module-messenger.html#.closeChatSelection">closeChatSelection</a></li><li data-type='method'><a href="module-messenger.html#.openMessenger">openMessenger</a></li><li data-type='method'><a href="module-messenger.html#.openNewChat">openNewChat</a></li><li data-type='method'><a href="module-messenger.html#.showAllChats">showAllChats</a></li><li data-type='method'><a href="module-messenger.html#.updateUnreadBadge">updateUnreadBadge</a></li><li data-type='method'><a href="module-messenger.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-messenger.html#~loadPrivateMessages">loadPrivateMessages</a></li><li data-type='method'><a href="module-messenger.html#~stopHijackingPolling">stopHijackingPolling</a></li></ul></li><li><a href="module-public_js_modules_hijacking.html">public/js/modules/hijacking</a><ul class='methods'><li data-type='method'><a href="module-public_js_modules_hijacking.html#.closeHijackingInbox">closeHijackingInbox</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.openHijackingInbox">openHijackingInbox</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.updateHijackedVesselsDisplay">updateHijackedVesselsDisplay</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#.updateHijackingBadge">updateHijackingBadge</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~deleteCase">deleteCase</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~openCaseDetails">openCaseDetails</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~refreshHijackingBadge">refreshHijackingBadge</a></li><li data-type='method'><a href="module-public_js_modules_hijacking.html#~renderCaseList">renderCaseList</a></li></ul></li><li><a href="module-server_automation.html">server/automation</a><ul class='methods'><li data-type='method'><a href="module-server_automation.html#~getRandomInterval">getRandomInterval</a></li><li data-type='method'><a href="module-server_automation.html#~initialize">initialize</a></li><li data-type='method'><a href="module-server_automation.html#~loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_automation.html#~parseInterval">parseInterval</a></li><li data-type='method'><a href="module-server_automation.html#~restartAutoRepair">restartAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~runAutoRepair">runAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~scheduleAutoRepair">scheduleAutoRepair</a></li></ul></li><li><a href="module-server_autopilot.html">server/autopilot</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot.html#~analyzeVesselDepartures">analyzeVesselDepartures</a></li><li data-type='method'><a href="module-server_autopilot.html#~autoRebuyAll">autoRebuyAll</a></li><li data-type='method'><a href="module-server_autopilot.html#~checkPriceAlerts">checkPriceAlerts</a></li><li data-type='method'><a href="module-server_autopilot.html#~countActiveCampaignTypes">countActiveCampaignTypes</a></li><li data-type='method'><a href="module-server_autopilot.html#~initializeAutopilotState">initializeAutopilotState</a></li><li data-type='method'><a href="module-server_autopilot.html#~isAutopilotPaused">isAutopilotPaused</a></li><li data-type='method'><a href="module-server_autopilot.html#~mainEventLoop">mainEventLoop</a></li><li data-type='method'><a href="module-server_autopilot.html#~pauseAutopilot">pauseAutopilot</a></li><li data-type='method'><a href="module-server_autopilot.html#~resumeAutopilot">resumeAutopilot</a></li><li data-type='method'><a href="module-server_autopilot.html#~setBroadcastFunction">setBroadcastFunction</a></li><li data-type='method'><a href="module-server_autopilot.html#~startMainEventLoop">startMainEventLoop</a></li><li data-type='method'><a href="module-server_autopilot.html#~tryUpdateAllData">tryUpdateAllData</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateAllData">updateAllData</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateCampaigns">updateCampaigns</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateDrydockCount">updateDrydockCount</a></li><li data-type='method'><a href="module-server_autopilot.html#~updatePrices">updatePrices</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateRepairCount">updateRepairCount</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateUnreadMessages">updateUnreadMessages</a></li><li data-type='method'><a href="module-server_autopilot.html#~updateVesselCount">updateVesselCount</a></li></ul></li><li><a href="module-server_autopilot_pilot_atmosphere_broker.html">server/autopilot/pilot_atmosphere_broker</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_atmosphere_broker.html#~autoRebuyCO2">autoRebuyCO2</a></li></ul></li><li><a href="module-server_autopilot_pilot_barrel_boss.html">server/autopilot/pilot_barrel_boss</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_barrel_boss.html#~autoRebuyFuel">autoRebuyFuel</a></li></ul></li><li><a href="module-server_autopilot_pilot_captain_blackbeard.html">server/autopilot/pilot_captain_blackbeard</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~acceptRansomWithRetry">acceptRansomWithRetry</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~autoNegotiateHijacking">autoNegotiateHijacking</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~getCaseWithRetry">getCaseWithRetry</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~processHijackingCase">processHijackingCase</a></li><li data-type='method'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~submitOfferWithRetry">submitOfferWithRetry</a></li></ul></li><li><a href="module-server_autopilot_pilot_cargo_marshal.html">server/autopilot/pilot_cargo_marshal</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~autoDepartVessels">autoDepartVessels</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~departVessels">departVessels</a></li><li data-type='method'><a href="module-server_autopilot_pilot_cargo_marshal.html#~getTotalCapacity">getTotalCapacity</a></li></ul></li><li><a href="module-server_autopilot_pilot_drydock_master.html">server/autopilot/pilot_drydock_master</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_drydock_master.html#~autoDrydockVessels">autoDrydockVessels</a></li></ul></li><li><a href="module-server_autopilot_pilot_fair_hand.html">server/autopilot/pilot_fair_hand</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_fair_hand.html#~autoCoop">autoCoop</a></li></ul></li><li><a href="module-server_autopilot_pilot_harbormaster.html">server/autopilot/pilot_harbormaster</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_harbormaster.html#~autoAnchorPointPurchase">autoAnchorPointPurchase</a></li><li data-type='method'><a href="module-server_autopilot_pilot_harbormaster.html#~setBroadcastFunction">setBroadcastFunction</a></li></ul></li><li><a href="module-server_autopilot_pilot_reputation_chief.html">server/autopilot/pilot_reputation_chief</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_reputation_chief.html#~autoCampaignRenewal">autoCampaignRenewal</a></li></ul></li><li><a href="module-server_autopilot_pilot_yard_foreman.html">server/autopilot/pilot_yard_foreman</a><ul class='methods'><li data-type='method'><a href="module-server_autopilot_pilot_yard_foreman.html#~autoRepairVessels">autoRepairVessels</a></li></ul></li><li><a href="module-server_cache.html">server/cache</a><ul class='methods'><li data-type='method'><a href="module-server_cache.html#~clearAllCaches">clearAllCaches</a></li><li data-type='method'><a href="module-server_cache.html#~getAllianceCache">getAllianceCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCampaignCache">getCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCompanyCache">getCompanyCache</a></li><li data-type='method'><a href="module-server_cache.html#~getCoopCache">getCoopCache</a></li><li data-type='method'><a href="module-server_cache.html#~invalidateCampaignCache">invalidateCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~invalidateCoopCache">invalidateCoopCache</a></li><li data-type='method'><a href="module-server_cache.html#~isCacheValid">isCacheValid</a></li><li data-type='method'><a href="module-server_cache.html#~setAllianceCache">setAllianceCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCampaignCache">setCampaignCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCompanyCache">setCompanyCache</a></li><li data-type='method'><a href="module-server_cache.html#~setCoopCache">setCoopCache</a></li></ul></li><li><a href="module-server_certificate.html">server/certificate</a><ul class='methods'><li data-type='method'><a href="module-server_certificate.html#~createHttpsServer">createHttpsServer</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCA">generateCA</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCertificate">generateCertificate</a></li><li data-type='method'><a href="module-server_certificate.html#~getNetworkIPs">getNetworkIPs</a></li><li data-type='method'><a href="module-server_certificate.html#~isCertificateInstalled">isCertificateInstalled</a></li><li data-type='method'><a href="module-server_certificate.html#~loadCertificate">loadCertificate</a></li></ul></li><li><a href="module-server_chatbot.html">server/chatbot</a></li><li><a href="module-server_chatbot_commands.html">server/chatbot/commands</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_commands.html#~generateForecastText">generateForecastText</a></li><li data-type='method'><a href="module-server_chatbot_commands.html#~handleForecastCommand">handleForecastCommand</a></li><li data-type='method'><a href="module-server_chatbot_commands.html#~handleHelpCommand">handleHelpCommand</a></li><li data-type='method'><a href="module-server_chatbot_commands.html#~handleWelcomeCommand">handleWelcomeCommand</a></li></ul></li><li><a href="module-server_chatbot_executor.html">server/chatbot/executor</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_executor.html#~executeCommand">executeCommand</a></li></ul></li><li><a href="module-server_chatbot_parser.html">server/chatbot/parser</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_parser.html#~findCustomCommand">findCustomCommand</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~hasManagementRole">hasManagementRole</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~isCommandAllowedInChannel">isCommandAllowedInChannel</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~isOnCooldown">isOnCooldown</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~processAllianceMessage">processAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~processPrivateMessage">processPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~resolveCommandName">resolveCommandName</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~updateCooldown">updateCooldown</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~validateCommandArguments">validateCommandArguments</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~validateForecastArguments">validateForecastArguments</a></li><li data-type='method'><a href="module-server_chatbot_parser.html#~validateWelcomeArguments">validateWelcomeArguments</a></li></ul></li><li><a href="module-server_chatbot_scheduler.html">server/chatbot/scheduler</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_scheduler.html#~scheduleDailyForecast">scheduleDailyForecast</a></li><li data-type='method'><a href="module-server_chatbot_scheduler.html#~sendDailyForecast">sendDailyForecast</a></li><li data-type='method'><a href="module-server_chatbot_scheduler.html#~setupScheduledTasks">setupScheduledTasks</a></li></ul></li><li><a href="module-server_chatbot_sender.html">server/chatbot/sender</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_sender.html#~sendAllianceMessage">sendAllianceMessage</a></li><li data-type='method'><a href="module-server_chatbot_sender.html#~sendErrorMessage">sendErrorMessage</a></li><li data-type='method'><a href="module-server_chatbot_sender.html#~sendPrivateMessage">sendPrivateMessage</a></li><li data-type='method'><a href="module-server_chatbot_sender.html#~sendResponse">sendResponse</a></li></ul></li><li><a href="module-server_chatbot_settings.html">server/chatbot/settings</a><ul class='methods'><li data-type='method'><a href="module-server_chatbot_settings.html#~getDefaultChatBotObject">getDefaultChatBotObject</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~hasManagementRole">hasManagementRole</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~mapChatBotObjectToFlatSettings">mapChatBotObjectToFlatSettings</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~mapSettingsToChatBotObject">mapSettingsToChatBotObject</a></li><li data-type='method'><a href="module-server_chatbot_settings.html#~updateSettings">updateSettings</a></li></ul></li><li><a href="module-server_config.html">server/config</a><ul class='methods'><li data-type='method'><a href="module-server_config.html#~getAppDataDir">getAppDataDir</a></li><li data-type='method'><a href="module-server_config.html#~getAppPlatformCookie">getAppPlatformCookie</a></li><li data-type='method'><a href="module-server_config.html#~getAppVersionCookie">getAppVersionCookie</a></li><li data-type='method'><a href="module-server_config.html#~getLocalAppDataDir">getLocalAppDataDir</a></li><li data-type='method'><a href="module-server_config.html#~getLogDir">getLogDir</a></li><li data-type='method'><a href="module-server_config.html#~getSessionCookie">getSessionCookie</a></li><li data-type='method'><a href="module-server_config.html#~getSettingsDir">getSettingsDir</a></li><li data-type='method'><a href="module-server_config.html#~loadStartupSettings">loadStartupSettings</a></li><li data-type='method'><a href="module-server_config.html#~setSessionCookie">setSessionCookie</a></li></ul></li><li><a href="module-server_gameapi.html">server/gameapi</a></li><li><a href="module-server_gameapi_bunker.html">server/gameapi/bunker</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi_bunker.html#~fetchBunkerState">fetchBunkerState</a></li><li data-type='method'><a href="module-server_gameapi_bunker.html#~fetchPrices">fetchPrices</a></li><li data-type='method'><a href="module-server_gameapi_bunker.html#~purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-server_gameapi_bunker.html#~purchaseFuel">purchaseFuel</a></li></ul></li><li><a href="module-server_gameapi_campaign.html">server/gameapi/campaign</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi_campaign.html#~activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-server_gameapi_campaign.html#~fetchCampaigns">fetchCampaigns</a></li></ul></li><li><a href="module-server_gameapi_maintenance.html">server/gameapi/maintenance</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi_maintenance.html#~bulkRepairVessels">bulkRepairVessels</a></li><li data-type='method'><a href="module-server_gameapi_maintenance.html#~fetchRepairCount">fetchRepairCount</a></li><li data-type='method'><a href="module-server_gameapi_maintenance.html#~getMaintenanceCost">getMaintenanceCost</a></li></ul></li><li><a href="module-server_gameapi_port.html">server/gameapi/port</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi_port.html#~fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-server_gameapi_port.html#~fetchAutoPrice">fetchAutoPrice</a></li><li data-type='method'><a href="module-server_gameapi_port.html#~getAssignedPorts">getAssignedPorts</a></li><li data-type='method'><a href="module-server_gameapi_port.html#~getRoutesByPorts">getRoutesByPorts</a></li><li data-type='method'><a href="module-server_gameapi_port.html#~getVesselPorts">getVesselPorts</a></li></ul></li><li><a href="module-server_gameapi_util.html">server/gameapi/util</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi_util.html#~fetchEventData">fetchEventData</a></li><li data-type='method'><a href="module-server_gameapi_util.html#~fetchUnreadMessages">fetchUnreadMessages</a></li><li data-type='method'><a href="module-server_gameapi_util.html#~getGameIndex">getGameIndex</a></li></ul></li><li><a href="module-server_gameapi_vessel.html">server/gameapi/vessel</a><ul class='methods'><li data-type='method'><a href="module-server_gameapi_vessel.html#~departVessel">departVessel</a></li><li data-type='method'><a href="module-server_gameapi_vessel.html#~fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-server_gameapi_vessel.html#~getAllUserVessels">getAllUserVessels</a></li><li data-type='method'><a href="module-server_gameapi_vessel.html#~getVesselHistory">getVesselHistory</a></li></ul></li><li><a href="module-server_middleware_index.html">server/middleware/index</a><ul class='methods'><li data-type='method'><a href="module-server_middleware_index.html#~setupMiddleware">setupMiddleware</a></li></ul></li><li><a href="module-server_routes_alliance.html">server/routes/alliance</a><ul class='methods'><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-high-scores">GET /api/alliance-high-scores</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-info">GET /api/alliance-info</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-info/:id">GET /api/alliance-info/:id</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-members">GET /api/alliance-members</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-members/:id">GET /api/alliance-members/:id</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-settings">GET /api/alliance-settings</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/chat">GET /api/chat</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/league-info">GET /api/league-info</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/alliance-accept-user">POST /api/alliance-accept-user</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/alliance-decline-user">POST /api/alliance-decline-user</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/alliance-leave">POST /api/alliance-leave</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/alliance-queue-pool">POST /api/alliance-queue-pool</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/alliance-update-user-role">POST /api/alliance-update-user-role</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/chat/mark-read">POST /api/chat/mark-read</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/company-name">POST /api/company-name</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/send-message">POST /api/send-message</a></li></ul></li><li><a href="module-server_routes_alliance-logo.html">server/routes/alliance-logo</a></li><li><a href="module-server_routes_alliances.html">server/routes/alliances</a></li><li><a href="module-server_routes_anchor.html">server/routes/anchor</a></li><li><a href="module-server_routes_coop.html">server/routes/coop</a><ul class='methods'><li data-type='method'><a href="module-server_routes_coop.html#.GET/api/coop/data">GET /api/coop/data</a></li><li data-type='method'><a href="module-server_routes_coop.html#.POST/api/coop/send-max">POST /api/coop/send-max</a></li></ul></li><li><a href="module-server_routes_forecast.html">server/routes/forecast</a><ul class='methods'><li data-type='method'><a href="module-server_routes_forecast.html#~convertCESTToTimezone">convertCESTToTimezone</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~generateChatbotText">generateChatbotText</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~generateMetadata">generateMetadata</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getForecastDataPath">getForecastDataPath</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getNextDayData">getNextDayData</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getPreviousDayData">getPreviousDayData</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getServerLocalTimezone">getServerLocalTimezone</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getTimezoneOffsetHours">getTimezoneOffsetHours</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~getValidTimezones">getValidTimezones</a></li><li data-type='method'><a href="module-server_routes_forecast.html#~parseNumericOffset">parseNumericOffset</a></li></ul></li><li><a href="module-server_routes_game.html">server/routes/game</a></li><li><a href="module-server_routes_game_autopilot.html">server/routes/game/autopilot</a></li><li><a href="module-server_routes_game_bunker.html">server/routes/game/bunker</a></li><li><a href="module-server_routes_game_depart.html">server/routes/game/depart</a></li><li><a href="module-server_routes_game_maintenance.html">server/routes/game/maintenance</a></li><li><a href="module-server_routes_game_marketing.html">server/routes/game/marketing</a></li><li><a href="module-server_routes_game_user.html">server/routes/game/user</a><ul class='methods'><li data-type='method'><a href="module-server_routes_game_user.html#~compareVersions">compareVersions</a></li></ul></li><li><a href="module-server_routes_game_vessel.html">server/routes/game/vessel</a></li><li><a href="module-server_routes_harbor-map.html">server/routes/harbor-map</a><ul class='methods'><li data-type='method'><a href="module-server_routes_harbor-map.html#~escapeCSVFormula">escapeCSVFormula</a></li><li data-type='method'><a href="module-server_routes_harbor-map.html#~formatHistoryAsTXT">formatHistoryAsTXT</a></li><li data-type='method'><a href="module-server_routes_harbor-map.html#~getGameIndexCached">getGameIndexCached</a></li></ul></li><li><a href="module-server_routes_health.html">server/routes/health</a></li><li><a href="module-server_routes_messenger.html">server/routes/messenger</a><ul class='methods'><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/contact/get-contacts">GET /api/contact/get-contacts</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/hijacking/get-cases">GET /api/hijacking/get-cases</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/messenger/get-chats">GET /api/messenger/get-chats</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/delete-chat">POST /api/messenger/delete-chat</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/get-messages">POST /api/messenger/get-messages</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/send-private">POST /api/messenger/send-private</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/user/search">POST /api/user/search</a></li><li data-type='method'><a href="module-server_routes_messenger.html#~ensureHijackHistoryDir">ensureHijackHistoryDir</a></li></ul></li><li><a href="module-server_routes_poi.html">server/routes/poi</a><ul class='methods'><li data-type='method'><a href="module-server_routes_poi.html#~ensureCacheDir">ensureCacheDir</a></li><li data-type='method'><a href="module-server_routes_poi.html#~fetchAllMuseumsFromAPI">fetchAllMuseumsFromAPI</a></li><li data-type='method'><a href="module-server_routes_poi.html#~fetchAllWrecksFromAPI">fetchAllWrecksFromAPI</a></li><li data-type='method'><a href="module-server_routes_poi.html#~filterPOIsByBbox">filterPOIsByBbox</a></li><li data-type='method'><a href="module-server_routes_poi.html#~initializePOICache">initializePOICache</a></li><li data-type='method'><a href="module-server_routes_poi.html#~isCacheValid">isCacheValid</a></li><li data-type='method'><a href="module-server_routes_poi.html#~loadFromCache">loadFromCache</a></li><li data-type='method'><a href="module-server_routes_poi.html#~reduceWreckData">reduceWreckData</a></li><li data-type='method'><a href="module-server_routes_poi.html#~saveToCache">saveToCache</a></li><li data-type='method'><a href="module-server_routes_poi.html#~startAutomaticCacheRefresh">startAutomaticCacheRefresh</a></li></ul></li><li><a href="module-server_routes_settings.html">server/routes/settings</a><ul class='methods'><li data-type='method'><a href="module-server_routes_settings.html#.GET/api/settings">GET /api/settings</a></li><li data-type='method'><a href="module-server_routes_settings.html#.POST/api/settings">POST /api/settings</a></li></ul></li><li><a href="module-server_routes_staff.html">server/routes/staff</a></li><li><a href="module-server_routes_vessel-image.html">server/routes/vessel-image</a></li><li><a href="module-server_scheduler.html">server/scheduler</a><ul class='methods'><li data-type='method'><a href="module-server_scheduler.html#~initScheduler">initScheduler</a></li><li data-type='method'><a href="module-server_scheduler.html#~isServerReady">isServerReady</a></li></ul></li><li><a href="module-server_services_alliance-indexer.html">server/services/alliance-indexer</a></li><li><a href="module-server_settings-schema.html">server/settings-schema</a><ul class='methods'><li data-type='method'><a href="module-server_settings-schema.html#~getDefault">getDefault</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getDefaults">getDefaults</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getRequiredKeys">getRequiredKeys</a></li><li data-type='method'><a href="module-server_settings-schema.html#~getSettingsFilePath">getSettingsFilePath</a></li><li data-type='method'><a href="module-server_settings-schema.html#~initializeSettings">initializeSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~saveSettings">saveSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~validateSettings">validateSettings</a></li><li data-type='method'><a href="module-server_settings-schema.html#~validateValue">validateValue</a></li></ul></li><li><a href="module-server_state.html">server/state</a><ul class='methods'><li data-type='method'><a href="module-server_state.html#~getAllLocks">getAllLocks</a></li><li data-type='method'><a href="module-server_state.html#~getAutopilotState">getAutopilotState</a></li><li data-type='method'><a href="module-server_state.html#~getBunkerState">getBunkerState</a></li><li data-type='method'><a href="module-server_state.html#~getCampaignStatus">getCampaignStatus</a></li><li data-type='method'><a href="module-server_state.html#~getCoopData">getCoopData</a></li><li data-type='method'><a href="module-server_state.html#~getDrydockCount">getDrydockCount</a></li><li data-type='method'><a href="module-server_state.html#~getEventData">getEventData</a></li><li data-type='method'><a href="module-server_state.html#~getHeaderData">getHeaderData</a></li><li data-type='method'><a href="module-server_state.html#~getLastCO2Alert">getLastCO2Alert</a></li><li data-type='method'><a href="module-server_state.html#~getLastFuelAlert">getLastFuelAlert</a></li><li data-type='method'><a href="module-server_state.html#~getLockStatus">getLockStatus</a></li><li data-type='method'><a href="module-server_state.html#~getPrices">getPrices</a></li><li data-type='method'><a href="module-server_state.html#~getRepairCount">getRepairCount</a></li><li data-type='method'><a href="module-server_state.html#~getSettings">getSettings</a></li><li data-type='method'><a href="module-server_state.html#~getUserState">getUserState</a></li><li data-type='method'><a href="module-server_state.html#~getVesselCounts">getVesselCounts</a></li><li data-type='method'><a href="module-server_state.html#~isAutopilotPaused">isAutopilotPaused</a></li><li data-type='method'><a href="module-server_state.html#~setAutopilotPaused">setAutopilotPaused</a></li><li data-type='method'><a href="module-server_state.html#~setAutopilotState">setAutopilotState</a></li><li data-type='method'><a href="module-server_state.html#~setLastCO2Alert">setLastCO2Alert</a></li><li data-type='method'><a href="module-server_state.html#~setLastFuelAlert">setLastFuelAlert</a></li><li data-type='method'><a href="module-server_state.html#~setLockStatus">setLockStatus</a></li><li data-type='method'><a href="module-server_state.html#~updateBunkerState">updateBunkerState</a></li><li data-type='method'><a href="module-server_state.html#~updateCampaignStatus">updateCampaignStatus</a></li><li data-type='method'><a href="module-server_state.html#~updateCoopData">updateCoopData</a></li><li data-type='method'><a href="module-server_state.html#~updateDrydockCount">updateDrydockCount</a></li><li data-type='method'><a href="module-server_state.html#~updateEventData">updateEventData</a></li><li data-type='method'><a href="module-server_state.html#~updateHeaderData">updateHeaderData</a></li><li data-type='method'><a href="module-server_state.html#~updatePrices">updatePrices</a></li><li data-type='method'><a href="module-server_state.html#~updateRepairCount">updateRepairCount</a></li><li data-type='method'><a href="module-server_state.html#~updateSettings">updateSettings</a></li><li data-type='method'><a href="module-server_state.html#~updateVesselCounts">updateVesselCounts</a></li></ul></li><li><a href="module-server_utils_api.html">server/utils/api</a><ul class='methods'><li data-type='method'><a href="module-server_utils_api.html#~apiCall">apiCall</a></li><li data-type='method'><a href="module-server_utils_api.html#~apiCallWithRetry">apiCallWithRetry</a></li><li data-type='method'><a href="module-server_utils_api.html#~checkAndUpdateAllianceId">checkAndUpdateAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~getAllianceId">getAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~getAllianceName">getAllianceName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getChatFeed">getChatFeed</a></li><li data-type='method'><a href="module-server_utils_api.html#~getCompanyName">getCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserCompanyName">getUserCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserId">getUserId</a></li><li data-type='method'><a href="module-server_utils_api.html#~initializeAlliance">initializeAlliance</a></li><li data-type='method'><a href="module-server_utils_api.html#~setAllianceId">setAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~sleep">sleep</a></li></ul></li><li><a href="module-server_utils_audit-logger.html">server/utils/audit-logger</a><ul class='methods'><li data-type='method'><a href="module-server_utils_audit-logger.html#~auditLog">auditLog</a></li><li data-type='method'><a href="module-server_utils_audit-logger.html#~formatCurrency">formatCurrency</a></li><li data-type='method'><a href="module-server_utils_audit-logger.html#~formatNumber">formatNumber</a></li></ul></li><li><a href="module-server_utils_contribution-store.html">server/utils/contribution-store</a><ul class='methods'><li data-type='method'><a href="module-server_utils_contribution-store.html#~enrichHistoryWithContributions">enrichHistoryWithContributions</a></li><li data-type='method'><a href="module-server_utils_contribution-store.html#~ensureDirectory">ensureDirectory</a></li><li data-type='method'><a href="module-server_utils_contribution-store.html#~getContributionGain">getContributionGain</a></li><li data-type='method'><a href="module-server_utils_contribution-store.html#~getFilePath">getFilePath</a></li><li data-type='method'><a href="module-server_utils_contribution-store.html#~loadContributionGains">loadContributionGains</a></li><li data-type='method'><a href="module-server_utils_contribution-store.html#~saveContributionGain">saveContributionGain</a></li></ul></li><li><a href="module-server_utils_encryption.html">server/utils/encryption</a><ul class='methods'><li data-type='method'><a href="module-server_utils_encryption.html#~decryptData">decryptData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~deleteEncryptedData">deleteEncryptedData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~encryptData">encryptData</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~getEncryptionInfo">getEncryptionInfo</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~getMachineKey">getMachineKey</a></li><li data-type='method'><a href="module-server_utils_encryption.html#~isEncrypted">isEncrypted</a></li></ul></li><li><a href="module-server_utils_harbor-fee-store.html">server/utils/harbor-fee-store</a><ul class='methods'><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~enrichHistoryWithFees">enrichHistoryWithFees</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~ensureDirectory">ensureDirectory</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~getFilePath">getFilePath</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~getHarborFee">getHarborFee</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~isMigrationCompleted">isMigrationCompleted</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~loadHarborFees">loadHarborFees</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~markMigrationCompleted">markMigrationCompleted</a></li><li data-type='method'><a href="module-server_utils_harbor-fee-store.html#~saveHarborFee">saveHarborFee</a></li></ul></li><li><a href="module-server_utils_logger.html">server/utils/logger</a><ul class='methods'><li data-type='method'><a href="module-server_utils_logger.html#~debug">debug</a></li><li data-type='method'><a href="module-server_utils_logger.html#~error">error</a></li><li data-type='method'><a href="module-server_utils_logger.html#~info">info</a></li><li data-type='method'><a href="module-server_utils_logger.html#~isDebugMode">isDebugMode</a></li><li data-type='method'><a href="module-server_utils_logger.html#~loadLogLevel">loadLogLevel</a></li><li data-type='method'><a href="module-server_utils_logger.html#~warn">warn</a></li></ul></li><li><a href="module-server_utils_migrate-harbor-fees.html">server/utils/migrate-harbor-fees</a><ul class='methods'><li data-type='method'><a href="module-server_utils_migrate-harbor-fees.html#~migrateAllHarborFees">migrateAllHarborFees</a></li><li data-type='method'><a href="module-server_utils_migrate-harbor-fees.html#~migrateHarborFeesForUser">migrateHarborFeesForUser</a></li><li data-type='method'><a href="module-server_utils_migrate-harbor-fees.html#~resolveVesselNameToId">resolveVesselNameToId</a></li><li data-type='method'><a href="module-server_utils_migrate-harbor-fees.html#~timestampToMySQLDatetime">timestampToMySQLDatetime</a></li></ul></li><li><a href="module-server_utils_read-tracker.html">server/utils/read-tracker</a><ul class='methods'><li data-type='method'><a href="module-server_utils_read-tracker.html#~ensureReadTrackingFile">ensureReadTrackingFile</a></li><li data-type='method'><a href="module-server_utils_read-tracker.html#~getLastReadTimestamp">getLastReadTimestamp</a></li><li data-type='method'><a href="module-server_utils_read-tracker.html#~saveReadTrackingFile">saveReadTrackingFile</a></li><li data-type='method'><a href="module-server_utils_read-tracker.html#~updateLastReadTimestamp">updateLastReadTimestamp</a></li></ul></li><li><a href="module-server_utils_session-manager.html">server/utils/session-manager</a><ul class='methods'><li data-type='method'><a href="module-server_utils_session-manager.html#~deleteSession">deleteSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getAllUserIds">getAllUserIds</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getAvailableSessions">getAvailableSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getSession">getSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~getSessionsPath">getSessionsPath</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~hasSession">hasSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~loadAllSessions">loadAllSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~loadSessions">loadSessions</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~migrateToEncrypted">migrateToEncrypted</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~saveSession">saveSession</a></li><li data-type='method'><a href="module-server_utils_session-manager.html#~saveSessions">saveSessions</a></li></ul></li><li><a href="module-server_websocket.html">server/websocket</a><ul class='methods'><li data-type='method'><a href="module-server_websocket.html#~initWebSocket">initWebSocket</a></li></ul></li><li><a href="module-server_websocket_broadcaster.html">server/websocket/broadcaster</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_broadcaster.html#~broadcast">broadcast</a></li><li data-type='method'><a href="module-server_websocket_broadcaster.html#~broadcastBunkerUpdate">broadcastBunkerUpdate</a></li><li data-type='method'><a href="module-server_websocket_broadcaster.html#~broadcastHarborMapRefresh">broadcastHarborMapRefresh</a></li><li data-type='method'><a href="module-server_websocket_broadcaster.html#~broadcastToUser">broadcastToUser</a></li><li data-type='method'><a href="module-server_websocket_broadcaster.html#~getWebSocketServer">getWebSocketServer</a></li><li data-type='method'><a href="module-server_websocket_broadcaster.html#~setWebSocketServer">setWebSocketServer</a></li></ul></li><li><a href="module-server_websocket_chat-refresh.html">server/websocket/chat-refresh</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_chat-refresh.html#~performChatRefresh">performChatRefresh</a></li><li data-type='method'><a href="module-server_websocket_chat-refresh.html#~setMessengerRefreshFn">setMessengerRefreshFn</a></li><li data-type='method'><a href="module-server_websocket_chat-refresh.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket_chat-refresh.html#~stopChatAutoRefresh">stopChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket_chat-refresh.html#~triggerImmediateChatRefresh">triggerImmediateChatRefresh</a></li></ul></li><li><a href="module-server_websocket_hijacking-cache.html">server/websocket/hijacking-cache</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_hijacking-cache.html#~getCachedHijackingCase">getCachedHijackingCase</a></li><li data-type='method'><a href="module-server_websocket_hijacking-cache.html#~invalidateHijackingCase">invalidateHijackingCase</a></li></ul></li><li><a href="module-server_websocket_hijacking-refresh.html">server/websocket/hijacking-refresh</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_hijacking-refresh.html#~performHijackingRefresh">performHijackingRefresh</a></li><li data-type='method'><a href="module-server_websocket_hijacking-refresh.html#~startHijackingAutoRefresh">startHijackingAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket_hijacking-refresh.html#~stopHijackingAutoRefresh">stopHijackingAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket_hijacking-refresh.html#~triggerImmediateHijackingRefresh">triggerImmediateHijackingRefresh</a></li></ul></li><li><a href="module-server_websocket_message-cache.html">server/websocket/message-cache</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_message-cache.html#~getProcessedMessageIds">getProcessedMessageIds</a></li><li data-type='method'><a href="module-server_websocket_message-cache.html#~getProcessedMessagesCachePath">getProcessedMessagesCachePath</a></li><li data-type='method'><a href="module-server_websocket_message-cache.html#~loadProcessedMessageCache">loadProcessedMessageCache</a></li><li data-type='method'><a href="module-server_websocket_message-cache.html#~saveProcessedMessageCache">saveProcessedMessageCache</a></li></ul></li><li><a href="module-server_websocket_messenger-cache.html">server/websocket/messenger-cache</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_messenger-cache.html#~getCachedMessengerChats">getCachedMessengerChats</a></li></ul></li><li><a href="module-server_websocket_messenger-refresh.html">server/websocket/messenger-refresh</a><ul class='methods'><li data-type='method'><a href="module-server_websocket_messenger-refresh.html#~performMessengerRefresh">performMessengerRefresh</a></li><li data-type='method'><a href="module-server_websocket_messenger-refresh.html#~startMessengerAutoRefresh">startMessengerAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket_messenger-refresh.html#~stopMessengerAutoRefresh">stopMessengerAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket_messenger-refresh.html#~triggerImmediateMessengerRefresh">triggerImmediateMessengerRefresh</a></li></ul></li><li><a href="module-ui-dialogs.html">ui-dialogs</a><ul class='methods'><li data-type='method'><a href="module-ui-dialogs.html#.buyCampaign">buyCampaign</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeCampaignsOverlay">closeCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeSettings">closeSettings</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showCampaignsOverlay">showCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showConfirmDialog">showConfirmDialog</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showContactList">showContactList</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showSettings">showSettings</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#.escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-utils.html#.formatNumber">formatNumber</a></li><li data-type='method'><a href="module-utils.html#.getCO2PriceClass">getCO2PriceClass</a></li><li data-type='method'><a href="module-utils.html#.getFuelPriceClass">getFuelPriceClass</a></li><li data-type='method'><a href="module-utils.html#.isMobileDevice">isMobileDevice</a></li><li data-type='method'><a href="module-utils.html#.registerServiceWorker">registerServiceWorker</a></li><li data-type='method'><a href="module-utils.html#.renderStars">renderStars</a></li><li data-type='method'><a href="module-utils.html#.requestNotificationPermission">requestNotificationPermission</a></li><li data-type='method'><a href="module-utils.html#.showNotification">showNotification</a></li><li data-type='method'><a href="module-utils.html#.showSideNotification">showSideNotification</a></li></ul></li><li><a href="module-vessel-management.html">vessel-management</a><ul class='methods'><li data-type='method'><a href="module-vessel-management.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.openRepairAndDrydockDialog">openRepairAndDrydockDialog</a></li><li data-type='method'><a href="module-vessel-management.html#.purchaseSingleVessel">purchaseSingleVessel</a></li><li data-type='method'><a href="module-vessel-management.html#.updateLockStateFromServer">updateLockStateFromServer</a></li><li data-type='method'><a href="module-vessel-management.html#.updateVesselCount">updateVesselCount</a></li><li data-type='method'><a href="module-vessel-management.html#~createVesselCard">createVesselCard</a></li><li data-type='method'><a href="module-vessel-management.html#~displayFilteredVessels">displayFilteredVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~executeDrydock">executeDrydock</a></li><li data-type='method'><a href="module-vessel-management.html#~getAvailableAnchorSlots">getAvailableAnchorSlots</a></li><li data-type='method'><a href="module-vessel-management.html#~getCO2EfficiencyClass">getCO2EfficiencyClass</a></li><li data-type='method'><a href="module-vessel-management.html#~getCapacityDisplay">getCapacityDisplay</a></li><li data-type='method'><a href="module-vessel-management.html#~getFuelEfficiencyClass">getFuelEfficiencyClass</a></li><li data-type='method'><a href="module-vessel-management.html#~loadCartFromStorage">loadCartFromStorage</a></li><li data-type='method'><a href="module-vessel-management.html#~loadMorePendingVessels">loadMorePendingVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~loadMoreVessels">loadMoreVessels</a></li><li data-type='method'><a href="module-vessel-management.html#~populateDynamicFilters">populateDynamicFilters</a></li><li data-type='method'><a href="module-vessel-management.html#~refreshVesselCardsIfVisible">refreshVesselCardsIfVisible</a></li><li data-type='method'><a href="module-vessel-management.html#~renderDrydockTab">renderDrydockTab</a></li><li data-type='method'><a href="module-vessel-management.html#~renderRepairTab">renderRepairTab</a></li><li data-type='method'><a href="module-vessel-management.html#~saveCartToStorage">saveCartToStorage</a></li><li data-type='method'><a href="module-vessel-management.html#~showRepairAndDrydockDialog">showRepairAndDrydockDialog</a></li><li data-type='method'><a href="module-vessel-management.html#~updateCapacityDropdowns">updateCapacityDropdowns</a></li><li data-type='method'><a href="module-vessel-management.html#~vesselPassesFilters">vesselPassesFilters</a></li></ul></li><li><a href="module-vessel-selling.html">vessel-selling</a><ul class='methods'><li data-type='method'><a href="module-vessel-selling.html#.bulkSellVessels">bulkSellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#.closeSellVesselsOverlay">closeSellVesselsOverlay</a></li><li data-type='method'><a href="module-vessel-selling.html#.openSellVesselsOverlay">openSellVesselsOverlay</a></li><li data-type='method'><a href="module-vessel-selling.html#.refreshVesselsForSale">refreshVesselsForSale</a></li><li data-type='method'><a href="module-vessel-selling.html#.setSellFilter">setSellFilter</a></li><li data-type='method'><a href="module-vessel-selling.html#.showSellCart">showSellCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~clearSellCartCache">clearSellCartCache</a></li><li data-type='method'><a href="module-vessel-selling.html#~displaySellVessels">displaySellVessels</a></li><li data-type='method'><a href="module-vessel-selling.html#~fetchAllSellPrices">fetchAllSellPrices</a></li><li data-type='method'><a href="module-vessel-selling.html#~getCO2EfficiencyClass">getCO2EfficiencyClass</a></li><li data-type='method'><a href="module-vessel-selling.html#~getCapacityDisplay">getCapacityDisplay</a></li><li data-type='method'><a href="module-vessel-selling.html#~getFuelEfficiencyClass">getFuelEfficiencyClass</a></li><li data-type='method'><a href="module-vessel-selling.html#~groupVesselsByModel">groupVesselsByModel</a></li><li data-type='method'><a href="module-vessel-selling.html#~loadSellCartFromCache">loadSellCartFromCache</a></li><li data-type='method'><a href="module-vessel-selling.html#~loadUserVesselsForSale">loadUserVesselsForSale</a></li><li data-type='method'><a href="module-vessel-selling.html#~removeVesselSelectionFromCart">removeVesselSelectionFromCart</a></li><li data-type='method'><a href="module-vessel-selling.html#~saveSellCartToCache">saveSellCartToCache</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateBulkSellButton">updateBulkSellButton</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateSelectButtonState">updateSelectButtonState</a></li><li data-type='method'><a href="module-vessel-selling.html#~updateVesselSelectionInCart">updateVesselSelectionInCart</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#buildNav">buildNav</a></li><li><a href="global.html#deleteAllLogs">deleteAllLogs</a></li><li><a href="global.html#escapeCSVFormula">escapeCSVFormula</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#flushAllToDisk">flushAllToDisk</a></li><li><a href="global.html#formatDetailsAsTXT">formatDetailsAsTXT</a></li><li><a href="global.html#formatFileSize">formatFileSize</a></li><li><a href="global.html#formatLogsAsCSV">formatLogsAsCSV</a></li><li><a href="global.html#formatLogsAsTXT">formatLogsAsTXT</a></li><li><a href="global.html#fs">fs</a></li><li><a href="global.html#getCategoryFromAction">getCategoryFromAction</a></li><li><a href="global.html#getLogEntries">getLogEntries</a></li><li><a href="global.html#getLogFilePath">getLogFilePath</a></li><li><a href="global.html#getLogFileSize">getLogFileSize</a></li><li><a href="global.html#getLogsFromCache">getLogsFromCache</a></li><li><a href="global.html#getSourceFromAction">getSourceFromAction</a></li><li><a href="global.html#getTransactionType">getTransactionType</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#isDepartInProgress">isDepartInProgress</a></li><li><a href="global.html#loadLogsFromDisk">loadLogsFromDisk</a></li><li><a href="global.html#lockBulkBuyButton">lockBulkBuyButton</a></li><li><a href="global.html#lockCo2Button">lockCo2Button</a></li><li><a href="global.html#lockCoopButtons">lockCoopButtons</a></li><li><a href="global.html#lockDepartButton">lockDepartButton</a></li><li><a href="global.html#lockDrydockButton">lockDrydockButton</a></li><li><a href="global.html#lockFuelButton">lockFuelButton</a></li><li><a href="global.html#lockRepairButton">lockRepairButton</a></li><li><a href="global.html#logAutopilotAction">logAutopilotAction</a></li><li><a href="global.html#publish">publish</a></li><li><a href="global.html#searchInObject">searchInObject</a></li><li><a href="global.html#showAnchorTimer">showAnchorTimer</a></li><li><a href="global.html#shutdown">shutdown</a></li><li><a href="global.html#unlockBulkBuyButton">unlockBulkBuyButton</a></li><li><a href="global.html#unlockCo2Button">unlockCo2Button</a></li><li><a href="global.html#unlockCoopButtons">unlockCoopButtons</a></li><li><a href="global.html#unlockDepartButton">unlockDepartButton</a></li><li><a href="global.html#unlockDrydockButton">unlockDrydockButton</a></li><li><a href="global.html#unlockFuelButton">unlockFuelButton</a></li><li><a href="global.html#unlockRepairButton">unlockRepairButton</a></li><li><a href="global.html#writeLogsToDisk">writeLogsToDisk</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">public/js/modules/alliance-tabs.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Alliance Cooperation Tabs Management
 *
 * Handles the 6-tab interface for Alliance Cooperation:
 * - Allianz: Alliance info and statistics
 * - Coop: Current coop functionality (member send buttons)
 * - Liga: User's league and group standings
 * - HighScore: Alliance leaderboard
 * - Management: Queue pool and member role management
 * - Settings: Alliance coop settings
 *
 * @module alliance-tabs
 * @requires utils - Formatting and feedback functions
 * @requires badge-manager - Badge updates
 */

import { formatNumber, escapeHtml, showSideNotification, loadSettings } from './utils.js';
import { fetchCoopData, lockCoopButtons, unlockCoopButtons } from './coop.js';
import { showConfirmDialog } from './ui-dialogs.js';
import { openPlayerProfile } from './company-profile.js';

// Tab state management
let currentTab = 'allianz';
let tabDataCache = {
  allianz: null,
  liga: null,
  highscore: null,
  search: null,
  management: null,
  settings: null
};
let isTabLoading = false;
let isTabsInitialized = false;
let managementTabRefreshInterval = null;

// Search tab state
let searchState = {
  results: [],
  offset: 0,
  total: 0,
  query: '',
  filters: { sortBy: 'name_asc' },
  isLoading: false,
  hasMore: true
};

// Lazy loading for alliance search
let allianceLazyLoadObserver = null;
const ALLIANCE_INITIAL_LOAD = 10;
const ALLIANCE_LAZY_BATCH = 10;

/**
 * Fetches alliance info from the backend API
 * @returns {Promise&lt;Object>} Alliance data
 */
async function fetchAllianceInfo() {
  const response = await fetch(window.apiUrl('/api/alliance-info'));
  if (!response.ok) throw new Error('Failed to fetch alliance info');
  return await response.json();
}

/**
 * Fetches alliance info by ID from the backend API
 * @param {number} allianceId - The alliance ID to fetch
 * @returns {Promise&lt;Object>} Alliance data
 */
async function fetchAllianceInfoById(allianceId) {
  const response = await fetch(window.apiUrl(`/api/alliance-info/${allianceId}`));
  if (!response.ok) throw new Error('Failed to fetch alliance info');
  return await response.json();
}

/**
 * Fetches alliance members by ID from the backend API
 * @param {number} allianceId - The alliance ID to fetch members for
 * @returns {Promise&lt;Array>} Members array
 */
async function fetchAllianceMembersById(allianceId) {
  const response = await fetch(window.apiUrl(`/api/alliance-members/${allianceId}`));
  if (!response.ok) throw new Error('Failed to fetch alliance members');
  return await response.json();
}

/**
 * Fetches league info from the backend API
 * @returns {Promise&lt;Object>} League data
 */
async function fetchLeagueInfo() {
  const response = await fetch(window.apiUrl('/api/league-info'));
  if (!response.ok) throw new Error('Failed to fetch league info');
  return await response.json();
}

/**
 * Fetches high scores from the backend API
 * @param {Object} params - Query parameters
 * @returns {Promise&lt;Object>} High scores data
 */
async function fetchHighScores(params = {}) {
  const queryString = new URLSearchParams(params).toString();
  const url = queryString
    ? window.apiUrl(`/api/alliance-high-scores?${queryString}`)
    : window.apiUrl('/api/alliance-high-scores');
  const response = await fetch(url);
  if (!response.ok) throw new Error('Failed to fetch high scores');
  return await response.json();
}

/**
 * Fetches queue pool data from the backend API
 * @param {Object} filters - Filter parameters
 * @returns {Promise&lt;Object>} Queue pool data
 */
async function fetchQueuePool(filters = {}, retries = 2) {
  for (let attempt = 0; attempt &lt;= retries; attempt++) {
    try {
      const response = await fetch(window.apiUrl('/api/alliance-queue-pool'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(filters)
      });
      if (!response.ok) {
        if (attempt &lt; retries) {
          await new Promise(resolve => setTimeout(resolve, 500));
          continue;
        }
        throw new Error('Failed to fetch queue pool');
      }
      return await response.json();
    } catch (error) {
      if (attempt &lt; retries) {
        await new Promise(resolve => setTimeout(resolve, 500));
        continue;
      }
      throw error;
    }
  }
}

/**
 * Accepts a user's application to join the alliance
 * @param {number} userId - The user ID to accept
 * @returns {Promise&lt;Object>} Response from the API
 */
async function acceptUserToAlliance(userId) {
  const response = await fetch(window.apiUrl('/api/alliance-accept-user'), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user_id: userId })
  });
  const data = await response.json();
  if (!response.ok) {
    throw new Error(data.error || 'Failed to accept user');
  }
  return data;
}

/**
 * Declines a user's application to join the alliance
 * @param {number} userId - The user ID to decline
 * @returns {Promise&lt;Object>} Response from the API
 */
async function declineUserFromAlliance(userId) {
  const response = await fetch(window.apiUrl('/api/alliance-decline-user'), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user_id: userId })
  });
  const data = await response.json();
  if (!response.ok) {
    throw new Error(data.error || 'Failed to decline user');
  }
  return data;
}

/**
 * Fetches alliance settings from the backend API
 * @returns {Promise&lt;Object>} Alliance settings data
 */
async function fetchAllianceSettings() {
  const response = await fetch(window.apiUrl('/api/alliance-settings'));
  if (!response.ok) throw new Error('Failed to fetch alliance settings');
  return await response.json();
}

/**
 * Fetches alliance members from the backend API
 * @returns {Promise&lt;Array>} Array of alliance members
 */
async function fetchAllianceMembers() {
  const response = await fetch(window.apiUrl('/api/alliance-members'));
  if (!response.ok) throw new Error('Failed to fetch alliance members');
  return await response.json();
}

/**
 * Updates a member's role in the alliance
 * @param {number} userId - User ID to update
 * @param {string} role - New role
 * @returns {Promise&lt;Object>} Update result
 */
async function updateUserRole(userId, role) {
  const response = await fetch(window.apiUrl('/api/alliance-update-user-role'), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user_id: userId, role })
  });
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'Failed to update user role');
  }
  return await response.json();
}

/**
 * Updates alliance coop settings
 * @param {Object} settings - Settings to update
 * @returns {Promise&lt;Object>} Update result
 */
async function updateAllianceSettings(settings) {
  const response = await fetch(window.apiUrl('/api/coop/update-settings'), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(settings)
  });
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'Failed to update settings');
  }
  return await response.json();
}

/**
 * Leaves the current alliance
 * @returns {Promise&lt;Object>} Leave result
 */
async function leaveAlliance() {
  const response = await fetch(window.apiUrl('/api/alliance-leave'), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  });
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'Failed to leave alliance');
  }
  return await response.json();
}

/**
 * Shows all alliance-specific UI elements when user joins/has alliance
 */
export async function showAllAllianceUI() {
  // Show alliance chat icon
  const allianceChatIcon = document.querySelector('[data-action="allianceChat"]');
  if (allianceChatIcon) {
    allianceChatIcon.style.display = '';
  }

  // Show coop button
  const coopBtn = document.querySelector('[data-action="coop"]');
  if (coopBtn) {
    coopBtn.style.display = '';
  }

  // Hide pool button (user is now in alliance)
  const poolBtn = document.getElementById('anyAlliancePoolBtn');
  if (poolBtn) {
    poolBtn.style.display = 'none';
  }

  // Update button visibility
  if (window.updateButtonVisibility) {
    window.updateButtonVisibility('allianceChat', true);
    window.updateButtonVisibility('coop', true);
  }

  // Load and display coop data
  try {
    const response = await fetch(window.apiUrl('/api/coop-vessels'));
    if (response.ok) {
      const coopData = await response.json();
      if (coopData.success &amp;&amp; coopData.data) {
        const available = coopData.data.available || 0;
        const cap = coopData.data.cap || 0;

        // Update coop display in header
        if (window.updateCoopDisplay) {
          window.updateCoopDisplay(cap, available);
        }

        // Update coop badge
        const color = available === 0 ? 'GREEN' : 'RED';
        if (window.updateBadge) {
          window.updateBadge('coopBadge', available, available > 0, color);
        }

        // Update coop tab badge
        if (window.updateCoopTabBadge) {
          window.updateCoopTabBadge(available);
        }

        // Save to cache
        if (window.saveBadgeCache) {
          window.saveBadgeCache({ coop: { available, cap } });
        }
      }
    }
  } catch (error) {
    console.error('[Alliance UI] Failed to load coop data:', error);
  }

  // Use existing function to show alliance tabs
  await updateTabVisibilityForAllianceMembers();

  // Set Allianz as active tab
  const allianceTabs = document.querySelectorAll('.alliance-coop-tabs .tab-button');
  allianceTabs.forEach(tab => {
    if (tab.getAttribute('data-tab') === 'allianz') {
      tab.classList.add('tab-active');
    } else {
      tab.classList.remove('tab-active');
    }
  });
}

/**
 * Immediately hides all alliance-specific UI elements after leaving
 */
export async function hideAllAllianceUI() {
  // Update settings to reflect no alliance
  if (window.settings) {
    window.settings.allianceId = null;
  }

  // IMMEDIATELY clear badge cache to prevent stale data on reload
  if (window.saveBadgeCache) {
    window.saveBadgeCache({
      coop: null,
      alliance_chat_unread: 0
    });
  }

  // Hide and clear alliance chat
  const allianceChatIcon = document.querySelector('[data-action="allianceChat"]');
  if (allianceChatIcon) {
    allianceChatIcon.style.display = 'none';
  }

  // Hide alliance chat overlay and clear messages
  const allianceChatOverlay = document.getElementById('allianceChatOverlay');
  if (allianceChatOverlay) {
    allianceChatOverlay.classList.add('hidden');
  }

  const chatFeed = document.getElementById('chatFeed');
  if (chatFeed) {
    chatFeed.innerHTML = '&lt;p style="text-align: center; color: var(--color-text-tertiary); padding: 20px;">Not in an alliance&lt;/p>';
  }

  // Update button visibility (hide chat, keep coop visible for search access)
  if (window.updateButtonVisibility) {
    window.updateButtonVisibility('allianceChat', false);
  }

  // Clear coop badge on map icon
  if (window.updateBadge) {
    window.updateBadge('coopBadge', 0, false, 'GREEN');
    window.updateBadge('allianceChatBadge', 0, false, 'RED');
  }

  // Clear coop tab badge
  if (window.updateCoopTabBadge) {
    window.updateCoopTabBadge(0);
  }

  // Clear coop header display
  if (window.updateCoopDisplay) {
    window.updateCoopDisplay(0, 0);
  }

  // Use existing function to hide all alliance tabs except Search
  await updateTabVisibilityForNonMembers();

  // Ensure Search tab is active
  const searchTab = document.querySelector('.tab-button[data-tab="search"]');
  if (searchTab) {
    searchTab.classList.add('tab-active');
  }

  // Clear all tab content areas except search
  const tabContents = document.querySelectorAll('.alliance-tab-content');
  tabContents.forEach(content => {
    if (content.id !== 'searchContent') {
      content.classList.remove('active');
      content.innerHTML = '';
    }
  });

  // Clear tab data cache
  tabDataCache = {
    allianz: null,
    liga: null,
    highscore: null,
    search: null,
    management: null,
    settings: null
  };

  // Reset search state to force fresh search when user opens search tab
  searchState.initialized = false;
  searchState.results = [];
  searchState.offset = 0;
  searchState.query = '';
  searchState.filters = { sortBy: 'name_asc', hasOpenSlots: false };
  searchState.hasMore = true;
}

/**
 * Default welcome message for new members
 */
const DEFAULT_WELCOME_MESSAGE = 'Welcome to our Alliance!\nJoin the Ally Chat and say Hello :)';
const DEFAULT_WELCOME_SUBJECT = 'Welcome to [allianceName]';

/**
 * Loads welcome message from user settings and initializes the textarea
 */
async function loadWelcomeMessage() {
  const subjectInput = document.getElementById('welcomeSubjectInput');
  const textarea = document.getElementById('welcomeMessageInput');
  const charCount = document.getElementById('welcomeMessageCharCount');
  const saveBtn = document.getElementById('saveWelcomeMessageBtn');

  if (!textarea || !charCount || !saveBtn) return;

  // Load from user settings
  try {
    const response = await fetch(window.apiUrl('/api/settings'));
    if (response.ok) {
      const settings = await response.json();
      if (subjectInput) {
        subjectInput.value = settings.allianceWelcomeSubject || DEFAULT_WELCOME_SUBJECT;
      }
      textarea.value = settings.allianceWelcomeMessage || DEFAULT_WELCOME_MESSAGE;
    } else {
      if (subjectInput) {
        subjectInput.value = DEFAULT_WELCOME_SUBJECT;
      }
      textarea.value = DEFAULT_WELCOME_MESSAGE;
    }
  } catch (error) {
    console.error('[Alliance Tabs] Error loading welcome message:', error);
    if (subjectInput) {
      subjectInput.value = DEFAULT_WELCOME_SUBJECT;
    }
    textarea.value = DEFAULT_WELCOME_MESSAGE;
  }

  // Update character count
  updateWelcomeMessageCharCount();

  // Add event listeners
  textarea.addEventListener('input', updateWelcomeMessageCharCount);
  saveBtn.addEventListener('click', saveWelcomeMessage);
}

/**
 * Updates the character count display for welcome message
 */
function updateWelcomeMessageCharCount() {
  const textarea = document.getElementById('welcomeMessageInput');
  const charCount = document.getElementById('welcomeMessageCharCount');

  if (!textarea || !charCount) return;

  const currentLength = textarea.value.length;
  charCount.textContent = `${currentLength} / 900`;
  charCount.className = 'char-count';

  if (currentLength > 800) {
    charCount.classList.add(currentLength > 900 ? 'error' : 'warning');
  }
}

/**
 * Saves welcome message to user settings
 */
async function saveWelcomeMessage() {
  const subjectInput = document.getElementById('welcomeSubjectInput');
  const textarea = document.getElementById('welcomeMessageInput');
  const saveBtn = document.getElementById('saveWelcomeMessageBtn');

  if (!textarea || !saveBtn) return;

  const subject = subjectInput ? subjectInput.value : DEFAULT_WELCOME_SUBJECT;
  const message = textarea.value;

  if (subject.length > 100) {
    showSideNotification('Subject is too long (max 100 characters)', 'error');
    return;
  }

  if (message.length > 900) {
    showSideNotification('Welcome message is too long (max 900 characters)', 'error');
    return;
  }

  saveBtn.disabled = true;
  saveBtn.textContent = 'Saving...';

  try {
    // Get current settings
    const getResponse = await fetch(window.apiUrl('/api/settings'));
    if (!getResponse.ok) throw new Error('Failed to load current settings');
    const currentSettings = await getResponse.json();

    // Update with new welcome subject and message
    currentSettings.allianceWelcomeSubject = subject;
    currentSettings.allianceWelcomeMessage = message;

    // Save settings
    const saveResponse = await fetch(window.apiUrl('/api/settings'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(currentSettings)
    });

    if (!saveResponse.ok) throw new Error('Failed to save settings');

    showSideNotification('Welcome message saved successfully', 'success');
  } catch (error) {
    console.error('[Alliance Tabs] Error saving welcome message:', error);
    showSideNotification('Failed to save welcome message', 'error');
  } finally {
    saveBtn.disabled = false;
    saveBtn.textContent = 'Save Welcome Message';
  }
}

/**
 * Sends welcome message to a user via chatbot command
 * @param {number} userId - User ID to send message to
 * @param {string} companyName - Company name of the user (for notification)
 * @returns {Promise&lt;void>} Throws error on failure
 */
async function sendWelcomeMessageToUser(userId, companyName) {
  const response = await fetch(window.apiUrl('/api/alliance-send-welcome'), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      user_id: userId
    })
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'Failed to send welcome message');
  }

  // Update unread badge to reflect sent message
  if (window.debouncedUpdateUnreadBadge) {
    window.debouncedUpdateUnreadBadge();
  }

  // Show notification
  showSideNotification(`Welcome message sent to ${escapeHtml(companyName)}`, 'success');
}

/**
 * Initializes tab switching functionality
 * ONLY runs once to prevent duplicate event listeners
 */
export function initAllianceTabs() {
  if (isTabsInitialized) {
    return;
  }
  isTabsInitialized = true;

  const tabButtons = document.querySelectorAll('.alliance-coop-tabs .tab-button');

  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const tabName = button.getAttribute('data-tab');
      switchTab(tabName);
    });
  });

  // Pool button - use event delegation to prevent duplicates
  document.addEventListener('click', async (e) => {
    // Handle Pool button (toggles between join and leave)
    const poolBtn = e.target.closest('#anyAlliancePoolBtn');
    if (poolBtn) {
      e.preventDefault();
      e.stopPropagation();

      const isInPool = poolBtn.classList.contains('pool-leave-btn');

      try {
        if (isInPool) {
          // Leave pool
          const response = await fetch(window.apiUrl('/api/alliance-leave-pool-any'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to leave pool');
          }

          showSideNotification('Left alliance pool', 'success');
        } else {
          // Join pool
          const response = await fetch(window.apiUrl('/api/alliance-join-pool-any'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to join pool');
          }

          showSideNotification('Joined alliance pool', 'success');
        }

        // Force re-render to update button state
        searchState.initialized = false;
        await switchTab('search');
      } catch (error) {
        showSideNotification(`Failed: ${error.message}`, 'error');
      }
      return;
    }
  }, { once: false });
}

/**
 * Switches to a specific tab
 * @param {string} tabName - Name of the tab to switch to
 */
export async function switchTab(tabName) {
  if (!tabName) return;
  if (isTabLoading) return; // Prevent race conditions

  currentTab = tabName;

  // Stop management tab auto-refresh if switching away from management
  if (tabName !== 'management' &amp;&amp; managementTabRefreshInterval) {
    clearInterval(managementTabRefreshInterval);
    managementTabRefreshInterval = null;
  }

  // Update tab buttons
  const tabButtons = document.querySelectorAll('.alliance-coop-tabs .tab-button');
  tabButtons.forEach(button => {
    if (button.getAttribute('data-tab') === tabName) {
      button.classList.add('tab-active');
    } else {
      button.classList.remove('tab-active');
    }
  });

  // Update tab content visibility
  const tabContents = document.querySelectorAll('#coopOverlay .tab-content');
  tabContents.forEach(content => {
    const contentId = content.id.replace('TabContent', '').toLowerCase();
    if (contentId === tabName) {
      content.classList.add('tab-active');
    } else {
      content.classList.remove('tab-active');
    }
  });

  // Load content for the selected tab
  isTabLoading = true;
  try {
    await loadTabContent(tabName);
  } finally {
    isTabLoading = false;
  }

  // Start management tab auto-refresh if switching to management
  if (tabName === 'management' &amp;&amp; !managementTabRefreshInterval) {
    managementTabRefreshInterval = setInterval(async () => {
      if (currentTab === 'management') {
        try {
          await renderManagementTab();
        } catch (error) {
          console.error('[Alliance Tabs] Management tab refresh error:', error);
        }
      }
    }, 10000);
  }
}

/**
 * Loads content for a specific tab
 * @param {string} tabName - Name of the tab
 */
async function loadTabContent(tabName) {
  try {
    switch (tabName) {
      case 'allianz':
        await renderAllianzTab();
        break;
      case 'coop':
        await renderCoopTab();
        break;
      case 'liga':
        await renderLigaTab();
        break;
      case 'highscore':
        await renderHighScoreTab();
        break;
      case 'search':
        await renderSearchTab();
        break;
      case 'management':
        await renderManagementTab();
        break;
      case 'settings':
        await renderSettingsTab();
        break;
    }
  } catch (error) {
    console.error(`[Alliance Tabs] Error loading ${tabName} tab:`, error);
    const contentDiv = document.getElementById(`${tabName}Content`);
    if (contentDiv) {
      contentDiv.innerHTML = `&lt;p class="alliance-tab-error">Failed to load ${tabName} data. Please try again.&lt;/p>`;
    }
  }
}

/**
 * Normalize color hex code (remove alpha channel if present, add # prefix)
 * @param {string} color - Color string (with or without #, may include alpha)
 * @returns {string} Normalized color (#RRGGBB format)
 */
function normalizeColor(color) {
  if (!color) return '#FFFFFF';

  let hex = color.startsWith('#') ? color.substring(1) : color;

  if (hex.length === 8) {
    hex = hex.substring(0, 6);
  }

  return `#${hex}`;
}

/**
 * Generate alliance info HTML (shared between tab and modal)
 * @param {Object} data - Alliance data
 * @param {boolean} showJoinButton - Whether to show join button
 * @param {number} allianceId - Alliance ID for join button
 * @returns {string} HTML string
 */
function generateAllianceInfoHTML(data, showJoinButton = false, allianceId = null) {
  const seasonEndDate = new Date(data.season_end_time * 1000).toLocaleDateString();
  const foundedDate = new Date(data.time_founded * 1000).toLocaleDateString();

  const primaryColor = normalizeColor(data.image_colors.primary);
  const secondaryColors = data.image_colors.secondary || ['FFFFFF', 'FFFFFF'];
  const gradientColor1 = normalizeColor(secondaryColors[0]);
  const gradientColor2 = normalizeColor(secondaryColors[1] || secondaryColors[0]);
  const gradientBg = `linear-gradient(${gradientColor1} 0%, ${gradientColor2} 100%)`;

  const logoSvgUrl = data.image ? window.apiUrl(`/api/alliance-logo/${data.image}?color=${encodeURIComponent(primaryColor)}`) : '';
  const logoInitials = data.name.substring(0, 2).toUpperCase();

  const joinButtonHtml = showJoinButton ? `&lt;button class="vessel-buy-btn join-alliance-btn" data-alliance-id="${allianceId}">Join Alliance&lt;/button>` : '';

  return `
    &lt;div class="alliance-info-header">
      &lt;div class="alliance-logo-container">
        &lt;div class="alliance-logo-wrapper large" style="background: ${gradientBg};">
          &lt;img src="${logoSvgUrl}" alt="${escapeHtml(data.name)}" class="alliance-logo-svg" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          &lt;span class="alliance-logo-text" style="color: ${primaryColor}; display: none;">${logoInitials}&lt;/span>
        &lt;/div>
      &lt;/div>
      &lt;div class="alliance-header-info">
        &lt;div style="display: flex; align-items: center; gap: var(--spacing-12);">
          &lt;h3 class="alliance-name">${escapeHtml(data.name)}&lt;/h3>
          ${joinButtonHtml}
        &lt;/div>
        &lt;div class="alliance-meta">
          &lt;span>Members: ${data.members}&lt;/span>
          &lt;span>Language: ${data.language}&lt;/span>
          &lt;span>Founded: ${foundedDate}&lt;/span>
          ${allianceId ? `&lt;span>ID: ${allianceId}&lt;/span>` : ''}
        &lt;/div>
      &lt;/div>
    &lt;/div>

    &lt;div class="alliance-description">
      ${escapeHtml(data.description || 'No description available.')}
    &lt;/div>

    &lt;div class="alliance-stats-grid">
      &lt;div class="alliance-stat-card">
        &lt;h4>League Info&lt;/h4>
        &lt;div class="stat-row">
          &lt;span>League Level:&lt;/span>
          &lt;span class="stat-value">${data.league_level}&lt;/span>
        &lt;/div>
        &lt;div class="stat-row">
          &lt;span>Group Position:&lt;/span>
          &lt;span class="stat-value">#${data.group_position}&lt;/span>
        &lt;/div>
        &lt;div class="stat-row">
          &lt;span>Promotion:&lt;/span>
          &lt;span class="stat-value ${data.promotion ? 'stat-success' : ''}">${data.promotion ? 'Yes' : 'No'}&lt;/span>
        &lt;/div>
        &lt;div class="stat-row">
          &lt;span>Season Ends:&lt;/span>
          &lt;span class="stat-value">${seasonEndDate}&lt;/span>
        &lt;/div>
        &lt;div class="stat-row">
          &lt;span>Coop Status:&lt;/span>
          &lt;span class="stat-value">${data.coop.used}/${data.coop.needed}&lt;/span>
        &lt;/div>
      &lt;/div>

      &lt;div class="alliance-stat-card">
        &lt;h4>Benefits (Level ${data.benefit_level})&lt;/h4>
        &lt;div class="stat-row">
          &lt;span>Reputation Boost:&lt;/span>
          &lt;span class="stat-value stat-boost">+${data.benefit.rep_boost}%&lt;/span>
        &lt;/div>
        &lt;div class="stat-row">
          &lt;span>Demand Boost:&lt;/span>
          &lt;span class="stat-value stat-boost">+${data.benefit.demand_boost}%&lt;/span>
        &lt;/div>
        &lt;div class="stat-row">
          &lt;span>Coop Boost:&lt;/span>
          &lt;span class="stat-value stat-boost">+${data.benefit.coop_boost}&lt;/span>
        &lt;/div>
        &lt;div class="stat-row">
          &lt;span>Points Spent:&lt;/span>
          &lt;span class="stat-value">${formatNumber(data.benefit.points_spend)}&lt;/span>
        &lt;/div>
        &lt;div class="stat-row">
          &lt;span>Departures:&lt;/span>
          &lt;span class="stat-value">${formatNumber(data.benefit.departures)}&lt;/span>
        &lt;/div>
      &lt;/div>

      &lt;div class="alliance-stat-card">
        &lt;h4>Season Stats&lt;/h4>
        &lt;div class="stat-row">
          &lt;span>Departures (24h):&lt;/span>
          &lt;span class="stat-value">${formatNumber(data.stats.departures_24h)}&lt;/span>
        &lt;/div>
        &lt;div class="stat-row">
          &lt;span>Contribution (24h):&lt;/span>
          &lt;span class="stat-value">${formatNumber(data.stats.contribution_score_24h)}&lt;/span>
        &lt;/div>
        &lt;div class="stat-row">
          &lt;span>Coops (24h):&lt;/span>
          &lt;span class="stat-value">${formatNumber(data.stats.coops_24h)}&lt;/span>
        &lt;/div>
        &lt;div class="stat-row">
          &lt;span>Season Departures:&lt;/span>
          &lt;span class="stat-value">${formatNumber(data.stats.season_departures)}&lt;/span>
        &lt;/div>
        &lt;div class="stat-row">
          &lt;span>Season Contribution:&lt;/span>
          &lt;span class="stat-value">${formatNumber(data.stats.season_contribution_score)}&lt;/span>
        &lt;/div>
        &lt;div class="stat-row">
          &lt;span>Season Coops:&lt;/span>
          &lt;span class="stat-value">${formatNumber(data.stats.season_coops)}&lt;/span>
        &lt;/div>
      &lt;/div>

      &lt;div class="alliance-stat-card">
        &lt;h4>Historical Stats&lt;/h4>
        &lt;div class="stat-row">
          &lt;span>Total Departures:&lt;/span>
          &lt;span class="stat-value">${formatNumber(data.stats.total_departures)}&lt;/span>
        &lt;/div>
        &lt;div class="stat-row">
          &lt;span>Total Contribution:&lt;/span>
          &lt;span class="stat-value">${formatNumber(data.stats.total_contribution_score)}&lt;/span>
        &lt;/div>
        &lt;div class="stat-row">
          &lt;span>Total Coops:&lt;/span>
          &lt;span class="stat-value">${formatNumber(data.stats.total_coops)}&lt;/span>
        &lt;/div>
        &lt;div class="stat-row">
          &lt;span>Total Share Value:&lt;/span>
          &lt;span class="stat-value">$${formatNumber(data.total_share_value)}&lt;/span>
        &lt;/div>
      &lt;/div>
    &lt;/div>
  `;
}

/**
 * Renders the Allianz tab content
 */
async function renderAllianzTab() {
  const content = document.getElementById('allianzContent');
  if (!content) return;

  content.innerHTML = '&lt;p class="alliance-tab-loading">Loading alliance info...&lt;/p>';

  const [data, membersResponse] = await Promise.all([
    fetchAllianceInfo(),
    fetchAllianceMembers()
  ]);

  if (data.no_alliance) {
    content.innerHTML = '&lt;p class="alliance-tab-error">You are not in an alliance.&lt;/p>';
    return;
  }

  const membersData = membersResponse.members || membersResponse;
  const lastSeasonTopContributors = membersResponse.last_season_top_contributors || [];

  tabDataCache.allianz = data;

  let html = generateAllianceInfoHTML(data);

  const roleGroups = {
    ceo: { title: 'CEO', emoji: '', members: [] },
    coo: { title: 'COO', emoji: '', members: [] },
    management: { title: 'Management', emoji: '', members: [] },
    member: { title: 'Members', emoji: '', members: [] }
  };

  membersData.forEach(member => {
    const role = member.role || 'member';
    if (roleGroups[role]) {
      roleGroups[role].members.push(member);
    } else {
      roleGroups.member.members.push(member);
    }
  });

  if (lastSeasonTopContributors.length > 0) {
    html += `
      &lt;div class="top-contributors-section">
        &lt;h3>Top Contributors - Last Season&lt;/h3>
        &lt;table class="top-contributors-table">
          &lt;thead>
            &lt;tr>
              &lt;th>#&lt;/th>
              &lt;th>Member&lt;/th>
              &lt;th>Contribution&lt;/th>
              &lt;th>Reward&lt;/th>
            &lt;/tr>
          &lt;/thead>
          &lt;tbody>
    `;

    lastSeasonTopContributors.forEach((contributor, index) => {
      const member = membersData.find(m => m.user_id === contributor.user_id);
      const memberName = member ? escapeHtml(member.company_name) : 'Unknown';
      const rank = index + 1;
      const medal = rank === 1 ? '' : rank === 2 ? '' : '';
      const reward = contributor.point_reward;

      html += `
        &lt;tr>
          &lt;td class="rank-cell">${rank}&lt;/td>
          &lt;td class="member-cell">&lt;span class="clickable alliance-member-name" data-user-id="${contributor.user_id}">${memberName}&lt;/span>&lt;/td>
          &lt;td class="contribution-cell">${formatNumber(contributor.contribution_score_sum)}&lt;/td>
          &lt;td class="reward-cell">${medal} ${reward} Diamanten&lt;/td>
        &lt;/tr>
      `;
    });

    html += `
          &lt;/tbody>
        &lt;/table>
      &lt;/div>
    `;
  }

  html += `
    &lt;div class="members-section-header">
      &lt;h3>Alliance Members (${membersData.length})&lt;/h3>
      &lt;select class="member-sort-dropdown" id="memberSortDropdown">
        &lt;option value="contribution-24h-desc">24h Contribution &lt;/option>
        &lt;option value="contribution-24h-asc">24h Contribution &lt;/option>
        &lt;option value="departures-24h-desc">24h Departures &lt;/option>
        &lt;option value="departures-24h-asc">24h Departures &lt;/option>
        &lt;option value="contribution-season-desc">Season Contribution &lt;/option>
        &lt;option value="contribution-season-asc">Season Contribution &lt;/option>
        &lt;option value="departures-season-desc">Season Departures &lt;/option>
        &lt;option value="departures-season-asc">Season Departures &lt;/option>
        &lt;option value="contribution-lifetime-desc">Lifetime Contribution &lt;/option>
        &lt;option value="contribution-lifetime-asc">Lifetime Contribution &lt;/option>
        &lt;option value="departures-lifetime-desc">Lifetime Departures &lt;/option>
        &lt;option value="departures-lifetime-asc">Lifetime Departures &lt;/option>
        &lt;option value="joined-desc">Joined &lt;/option>
        &lt;option value="joined-asc">Joined &lt;/option>
        &lt;option value="lastlogin-desc">Last Login &lt;/option>
        &lt;option value="lastlogin-asc">Last Login &lt;/option>
      &lt;/select>
    &lt;/div>
    &lt;div class="members-grid" id="membersGrid">&lt;/div>
  `;

  content.innerHTML = html;

  // Add click listeners for top contributors
  content.querySelectorAll('.top-contributors-table .alliance-member-name.clickable').forEach(nameEl => {
    nameEl.addEventListener('click', async () => {
      const userId = parseInt(nameEl.getAttribute('data-user-id'));
      await openPlayerProfile(userId, true);
    });
  });

  function renderMembers(sortBy = 'contribution-24h', sortOrder = 'desc') {
    const allMembers = [];
    const groupOrder = ['ceo', 'coo', 'management', 'member'];
    groupOrder.forEach(roleKey => {
      const group = roleGroups[roleKey];
      group.members.forEach(m => {
        allMembers.push({ ...m, roleGroup: group });
      });
    });

    allMembers.sort((a, b) => {
      let aVal, bVal;

      const aStats = a.stats || { last_24h: { contribution: 0, departures: 0 }, last_season: { contribution: 0, departures: 0 }, lifetime: { contribution: 0, departures: 0 } };
      const bStats = b.stats || { last_24h: { contribution: 0, departures: 0 }, last_season: { contribution: 0, departures: 0 }, lifetime: { contribution: 0, departures: 0 } };

      if (sortBy === 'contribution-24h') {
        aVal = aStats.last_24h.contribution || 0;
        bVal = bStats.last_24h.contribution || 0;
      } else if (sortBy === 'departures-24h') {
        aVal = aStats.last_24h.departures || 0;
        bVal = bStats.last_24h.departures || 0;
      } else if (sortBy === 'contribution-season') {
        aVal = aStats.last_season.contribution || 0;
        bVal = bStats.last_season.contribution || 0;
      } else if (sortBy === 'departures-season') {
        aVal = aStats.last_season.departures || 0;
        bVal = bStats.last_season.departures || 0;
      } else if (sortBy === 'contribution-lifetime') {
        aVal = aStats.lifetime.contribution || 0;
        bVal = bStats.lifetime.contribution || 0;
      } else if (sortBy === 'departures-lifetime') {
        aVal = aStats.lifetime.departures || 0;
        bVal = bStats.lifetime.departures || 0;
      } else if (sortBy === 'joined') {
        aVal = a.time_joined || 0;
        bVal = b.time_joined || 0;
      } else if (sortBy === 'lastlogin') {
        aVal = a.time_last_login || 0;
        bVal = b.time_last_login || 0;
      }

      if (sortOrder === 'desc') {
        return bVal - aVal;
      } else {
        return aVal - bVal;
      }
    });

    let membersHtml = '';
    allMembers.forEach(m => {
      const joinedDate = m.time_joined ? new Date(m.time_joined * 1000).toLocaleDateString() : '-';
      const lastLoginDate = m.time_last_login ? new Date(m.time_last_login * 1000).toLocaleDateString() : '-';

      let badges = '';
      if (m.tanker_ops) badges += '&lt;span title="Tanker Operations">&lt;/span> ';
      if (m.is_rookie) badges += '&lt;span title="Rookie">&lt;/span> ';
      if (m.difficulty === 'realism') badges += '&lt;span title="Realism Mode">&lt;/span>';
      else if (m.difficulty === 'easy') badges += '&lt;span title="Easy Mode">&lt;/span>';

      let shareValueHtml = '';
      if (m.share_value !== undefined &amp;&amp; m.share_value !== null) {
        const trendArrow = m.stock_trend === 'up' ? '' : m.stock_trend === 'down' ? '' : '';
        shareValueHtml = `
          &lt;div class="stat-row">
            &lt;span>Share Value:&lt;/span>
            &lt;span class="stat-value">$${formatNumber(m.share_value)} ${trendArrow}&lt;/span>
          &lt;/div>`;
      }

      const stats = m.stats || {
        last_24h: { contribution: 0, departures: 0 },
        last_season: { contribution: 0, departures: 0 },
        lifetime: { contribution: 0, departures: 0 }
      };

      membersHtml += `
        &lt;div class="alliance-stat-card member-card">
          &lt;h4>
            &lt;span title="${m.roleGroup.title}">${m.roleGroup.emoji}&lt;/span> &lt;span class="clickable alliance-member-name" data-user-id="${m.user_id}">${escapeHtml(m.company_name)}&lt;/span>
            &lt;span class="member-badges">${badges}&lt;/span>
          &lt;/h4>
          ${shareValueHtml}
          &lt;div class="stat-row">
            &lt;span>24h Contribution:&lt;/span>
            &lt;span class="stat-value">${formatNumber(stats.last_24h.contribution)}&lt;/span>
          &lt;/div>
          &lt;div class="stat-row">
            &lt;span>24h Departures:&lt;/span>
            &lt;span class="stat-value">${formatNumber(stats.last_24h.departures)}&lt;/span>
          &lt;/div>
          &lt;div class="stat-row">
            &lt;span>Season Contribution:&lt;/span>
            &lt;span class="stat-value">${formatNumber(stats.last_season.contribution)}&lt;/span>
          &lt;/div>
          &lt;div class="stat-row">
            &lt;span>Season Departures:&lt;/span>
            &lt;span class="stat-value">${formatNumber(stats.last_season.departures)}&lt;/span>
          &lt;/div>
          &lt;div class="stat-row">
            &lt;span>Lifetime Contribution:&lt;/span>
            &lt;span class="stat-value">${formatNumber(stats.lifetime.contribution)}&lt;/span>
          &lt;/div>
          &lt;div class="stat-row">
            &lt;span>Lifetime Departures:&lt;/span>
            &lt;span class="stat-value">${formatNumber(stats.lifetime.departures)}&lt;/span>
          &lt;/div>
          &lt;div class="stat-row">
            &lt;span>Joined:&lt;/span>
            &lt;span class="stat-value">${joinedDate}&lt;/span>
          &lt;/div>
          &lt;div class="stat-row">
            &lt;span>Last Login:&lt;/span>
            &lt;span class="stat-value">${lastLoginDate}&lt;/span>
          &lt;/div>
          &lt;button class="member-donate-btn" data-user-id="${m.user_id}" data-user-name="${escapeHtml(m.company_name)}"> Donate&lt;/button>
        &lt;/div>
      `;
    });

    document.getElementById('membersGrid').innerHTML = membersHtml;

    // Add click listeners for member names
    document.querySelectorAll('#membersGrid .alliance-member-name.clickable').forEach(nameEl => {
      nameEl.addEventListener('click', async () => {
        const userId = parseInt(nameEl.getAttribute('data-user-id'));
        await openPlayerProfile(userId, true);
      });
    });

    // Add click listeners for donate buttons
    document.querySelectorAll('#membersGrid .member-donate-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const userId = parseInt(btn.getAttribute('data-user-id'));
        const userName = btn.getAttribute('data-user-name');
        await showDonateDialog(userId, userName, membersData.length);
      });
    });
  }

  renderMembers();

  document.getElementById('memberSortDropdown').addEventListener('change', (e) => {
    const value = e.target.value;
    const lastDashIndex = value.lastIndexOf('-');
    const sortBy = value.substring(0, lastDashIndex);
    const sortOrder = value.substring(lastDashIndex + 1);
    renderMembers(sortBy, sortOrder);
  });
}

/**
 * Renders the Coop tab content (uses existing coop.js functionality)
 */
async function renderCoopTab() {
  const content = document.getElementById('coopContent');
  if (!content) return;

  content.innerHTML = '&lt;p class="alliance-tab-loading">Loading coop data...&lt;/p>';

  const data = await fetchCoopData();
  const coop = data.data?.coop;
  const members = data.data?.members_coop || [];

  if (!coop) {
    content.innerHTML = '&lt;p class="alliance-tab-error">Failed to load coop data&lt;/p>';
    return;
  }

  // Get own user ID from API response
  const myUserId = data.user?.id;

  // Update coop tab badge with REAL data from API
  if (window.updateCoopTabBadge) {
    window.updateCoopTabBadge(coop.available);
  }

  // Separate members into categories
  const activeMembers = [];
  const disabledMembers = [];
  const outOfOrderMembers = [];
  let myUser = null;

  members.forEach(member => {
    if (member.user_id === myUserId) {
      myUser = member;
      return;
    }

    if (!member.enabled) {
      disabledMembers.push(member);
    } else {
      const hasBlockingRestrictions = member.restrictions.some(r => {
        if (r.blocking === true || r.type === 'low_fuel' || r.type === 'time_restriction' || r.type === 'no_vessels') {
          return true;
        }

        if (r.type === 'time_setting' &amp;&amp; r.startHourUTC !== undefined &amp;&amp; r.endHourUTC !== undefined) {
          const now = new Date();
          const currentHourUTC = now.getUTCHours();

          let isWithinWindow = false;
          if (r.startHourUTC &lt;= r.endHourUTC) {
            isWithinWindow = currentHourUTC >= r.startHourUTC &amp;&amp; currentHourUTC &lt; r.endHourUTC;
          } else {
            isWithinWindow = currentHourUTC >= r.startHourUTC || currentHourUTC &lt; r.endHourUTC;
          }

          return !isWithinWindow;
        }

        return false;
      });

      if (hasBlockingRestrictions) {
        outOfOrderMembers.push(member);
      } else {
        activeMembers.push(member);
      }
    }
  });

  let html = `
    &lt;div class="coop-stats-box">
      &lt;h3 class="coop-stats-title">Your Co-Op Stats&lt;/h3>
      &lt;table class="coop-stats-table">
        &lt;tr>
          &lt;td class="coop-stat-label">Co-Op total:&lt;/td>
          &lt;td class="coop-stat-value coop-stat-max">${coop.coop_boost || coop.cap}&lt;/td>
          &lt;td class="coop-stat-label">Co-Op available:&lt;/td>
          &lt;td class="coop-stat-value coop-stat-available">${coop.available}&lt;/td>
        &lt;/tr>
        &lt;tr>
          &lt;td class="coop-stat-label">Sent this season:&lt;/td>
          &lt;td class="coop-stat-value coop-stat-sent">${coop.sent_this_season || 0}&lt;/td>
          &lt;td class="coop-stat-label">Received this season:&lt;/td>
          &lt;td class="coop-stat-value coop-stat-received">${coop.received_this_season || 0}&lt;/td>
        &lt;/tr>
        &lt;tr>
          &lt;td class="coop-stat-label">Sent historical:&lt;/td>
          &lt;td class="coop-stat-value coop-stat-sent-hist">${coop.sent_historical || 0}&lt;/td>
          &lt;td class="coop-stat-label">Received historical:&lt;/td>
          &lt;td class="coop-stat-value coop-stat-received-hist">${coop.received_historical || 0}&lt;/td>
        &lt;/tr>
      &lt;/table>
    &lt;/div>
  `;

  // Render active members
  if (activeMembers.length > 0) {
    html += `&lt;h3 class="coop-section-header coop-section-active">Active (${activeMembers.length})&lt;/h3>`;
    activeMembers.sort((a, b) => b.total_vessels - a.total_vessels);

    activeMembers.forEach(member => {
      const hasBlockingRestriction = member.restrictions.some(r =>
        r.blocking === true || r.type === 'no_vessels'
      );
      const shouldDisableButton = coop.available === 0 || hasBlockingRestriction;
      const buttonText = coop.available === 0 ? 'No Coop Tickets&lt;br>available' : 'Send max';

      html += renderMemberCard(member, true, shouldDisableButton, buttonText);
    });
  }

  // Render out of order members
  if (outOfOrderMembers.length > 0) {
    html += `&lt;h3 class="coop-section-header coop-section-warning">Out of Order (${outOfOrderMembers.length})&lt;/h3>`;
    outOfOrderMembers.sort((a, b) => b.total_vessels - a.total_vessels);

    outOfOrderMembers.forEach(member => {
      html += renderMemberCard(member, true, true);
    });
  }

  // Render disabled members
  if (disabledMembers.length > 0) {
    html += `&lt;h3 class="coop-section-header coop-section-disabled">COOP Disabled (${disabledMembers.length})&lt;/h3>`;
    disabledMembers.sort((a, b) => b.total_vessels - a.total_vessels);

    disabledMembers.forEach(member => {
      html += renderMemberCard(member, true, true);
    });
  }

  // Render own user at the bottom
  if (myUser) {
    html += `&lt;h3 class="coop-section-header coop-section-you">You&lt;/h3>`;
    html += renderMemberCard(myUser, false, false);
  }

  if (activeMembers.length === 0 &amp;&amp; outOfOrderMembers.length === 0 &amp;&amp; disabledMembers.length === 0) {
    html += '&lt;p class="coop-empty-message">No members available for coop&lt;/p>';
  }

  content.innerHTML = html;

  // Attach click handlers to member names
  content.querySelectorAll('.coop-member-name.clickable').forEach(nameEl => {
    nameEl.addEventListener('click', async () => {
      const userId = parseInt(nameEl.getAttribute('data-user-id'));
      await openPlayerProfile(userId, true);
    });
  });
}

/**
 * Renders a single member card for the coop tab
 * @param {Object} member - Member data
 * @param {boolean} showButton - Whether to show the send button
 * @param {boolean} disabled - Whether the button should be disabled
 * @param {string} buttonText - Optional custom button text
 * @returns {string} HTML string for member card
 */
function renderMemberCard(member, showButton = true, disabled = false, buttonText = 'Send max') {
  const fuelFormatted = formatNumber(member.fuel);

  let borderClass = 'coop-card-neutral';
  if (disabled) {
    borderClass = 'coop-card-disabled';
  }

  let restrictionsHtml = '';
  if (member.restrictions &amp;&amp; member.restrictions.length > 0) {
    restrictionsHtml = '&lt;div class="coop-restrictions">';
    member.restrictions.forEach(r => {
      let message = r.message;

      if ((r.type === 'time_setting' || r.type === 'time_restriction') &amp;&amp; r.startHourUTC !== undefined) {
        const now = new Date();
        const startUTC = new Date(now);
        startUTC.setUTCHours(r.startHourUTC, 0, 0, 0);
        const endUTC = new Date(now);
        endUTC.setUTCHours(r.endHourUTC === 0 ? 24 : r.endHourUTC, 0, 0, 0);

        const startLocal = String(startUTC.getHours()).padStart(2, '0') + ':00';
        const endLocal = String(endUTC.getHours()).padStart(2, '0') + ':00';

        message = `Only accepts ${startLocal}-${endLocal}`;
      }

      if (message) {
        restrictionsHtml += `&lt;span class="coop-restriction-warning">${escapeHtml(message)}&lt;/span>`;
      }
    });
    restrictionsHtml += '&lt;/div>';
  }

  let buttonHtml = '';
  if (showButton) {
    if (!disabled) {
      buttonHtml = `&lt;button onclick="window.sendCoopMax(${member.user_id})" class="coop-send-btn" data-permanently-disabled="false">${buttonText}&lt;/button>`;
    } else {
      buttonHtml = `&lt;button disabled class="coop-send-btn" data-permanently-disabled="true">${buttonText}&lt;/button>`;
    }
  }

  return `
    &lt;div class="coop-member-card ${borderClass}">
      &lt;div class="coop-card-content">
        &lt;div class="coop-card-info">
          &lt;div class="coop-member-name clickable" data-user-id="${member.user_id}">${escapeHtml(member.company_name)}&lt;/div>
          &lt;div class="coop-member-stats">
            &lt;div>${member.total_vessels} vessels&lt;/div>
            &lt;div>${fuelFormatted}t fuel&lt;/div>
          &lt;/div>
          ${restrictionsHtml}
        &lt;/div>
        ${buttonHtml}
      &lt;/div>
    &lt;/div>
  `;
}

/**
 * Renders the Liga tab content
 */
async function renderLigaTab() {
  const content = document.getElementById('ligaContent');
  if (!content) return;

  content.innerHTML = '&lt;p class="alliance-tab-loading">Loading league info...&lt;/p>';

  const data = await fetchLeagueInfo();
  tabDataCache.liga = data;

  const league = data.league;
  const userAllianceId = data.user_alliance_id || window.settings?.allianceId;

  const seasonEndDate = new Date(league.time_season_end * 1000);
  const seasonEndStr = seasonEndDate.toLocaleDateString('de-DE', { day: '2-digit', month: 'short', year: 'numeric' });

  let html = `
    &lt;div class="league-container">
      &lt;div class="league-header">
        &lt;h3>League ${league.level} - Group ${league.group}&lt;/h3>
        &lt;div class="league-season-info">
          &lt;span>Season ends: ${seasonEndStr}&lt;/span>
        &lt;/div>
      &lt;/div>

      &lt;div class="league-standings">
  `;

  const sortedAlliances = [...league.alliances].sort((a, b) => a.group_position - b.group_position);

  sortedAlliances.forEach((alliance) => {
    const isUserAlliance = alliance.id === userAllianceId;
    const positionClass = alliance.group_position &lt;= 3 ? `league-top-${alliance.group_position}` : '';
    const userClass = isUserAlliance ? 'league-user-alliance' : '';

    const medal = alliance.group_position === 1 ? '' : alliance.group_position === 2 ? '' : alliance.group_position === 3 ? '' : '';

    const promotionBadge = alliance.promotion ? '&lt;span class="league-promotion-badge"> Promotion&lt;/span>' : '';
    const topTierBadge = alliance.top_tier_reward ? '&lt;span class="league-top-tier-badge"> Top Tier&lt;/span>' : '';
    const handicapBadge = alliance.league_handicap > 0 ? `&lt;span class="league-handicap-badge">Handicap ${alliance.league_handicap}&lt;/span>` : '';

    const foundedDate = new Date(alliance.time_founded * 1000);
    const foundedStr = foundedDate.toLocaleDateString('de-DE', { day: '2-digit', month: 'short', year: 'numeric' });

    const languageFlag = alliance.language ? alliance.language.substring(3, 5).toUpperCase() : '';

    const primaryColor = normalizeColor(alliance.image_colors.primary);
    const secondaryColors = alliance.image_colors.secondary || ['FFFFFF', 'FFFFFF'];
    const gradientColor1 = normalizeColor(secondaryColors[0]);
    const gradientColor2 = normalizeColor(secondaryColors[1] || secondaryColors[0]);
    const gradient = `linear-gradient(${gradientColor1} 0%, ${gradientColor2} 100%)`;

    const logoInitials = alliance.name.substring(0, 2).toUpperCase();

    html += `
      &lt;div class="league-alliance-row ${positionClass} ${userClass}">
        &lt;div class="league-position">
          &lt;span class="league-rank">${medal} #${alliance.group_position}&lt;/span>
        &lt;/div>
        &lt;div class="league-alliance-logo">
          &lt;div class="alliance-logo-wrapper" style="background: ${gradient};">
            &lt;img src="/api/alliance-logo/${alliance.image}?color=${encodeURIComponent(primaryColor)}" alt="${escapeHtml(alliance.name)}" class="alliance-logo-svg" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            &lt;span class="alliance-logo-text" style="color: ${primaryColor}; display: none;">${logoInitials}&lt;/span>
          &lt;/div>
        &lt;/div>
        &lt;div class="league-alliance-info">
          &lt;div class="league-alliance-name clickable" data-alliance-id="${alliance.id}">
            ${escapeHtml(alliance.name)}
            ${languageFlag ? `&lt;span class="league-language-flag">${languageFlag}&lt;/span>` : ''}
            ${isUserAlliance ? '&lt;span class="league-you-badge">YOU&lt;/span>' : ''}
            ${promotionBadge}
            ${topTierBadge}
            ${handicapBadge}
          &lt;/div>
          &lt;div class="league-alliance-meta">
            &lt;span>Level ${alliance.benefit_level}&lt;/span>
            &lt;span>${alliance.members} members&lt;/span>
            &lt;span>${formatNumber(alliance.total_share_value)} share value&lt;/span>
            &lt;span>League ${alliance.league_level}&lt;/span>
            &lt;span>Founded ${foundedStr}&lt;/span>
          &lt;/div>
        &lt;/div>
        &lt;div class="league-stats">
          &lt;div class="league-stat-item">
            &lt;span class="league-stat-label">Season&lt;/span>
            &lt;span class="league-stat-value">${formatNumber(alliance.stats.season_contribution_score)}&lt;/span>
          &lt;/div>
          &lt;div class="league-stat-item">
            &lt;span class="league-stat-label">24h&lt;/span>
            &lt;span class="league-stat-value">${formatNumber(alliance.stats.contribution_score_24h)}&lt;/span>
          &lt;/div>
        &lt;/div>
      &lt;/div>
    `;
  });

  html += `
      &lt;/div>
    &lt;/div>
  `;

  content.innerHTML = html;

  const allianceNames = content.querySelectorAll('.league-alliance-name.clickable');
  allianceNames.forEach(nameEl => {
    nameEl.addEventListener('click', async () => {
      const allianceId = parseInt(nameEl.getAttribute('data-alliance-id'));
      await showAllianceDetailsModal(allianceId);
    });
  });
}

/**
 * Renders the HighScore tab content
 */
async function renderHighScoreTab() {
  const content = document.getElementById('highscoreContent');
  if (!content) return;

  content.innerHTML = '&lt;p class="alliance-tab-loading">Loading high scores...&lt;/p>';

  const data = await fetchHighScores();
  tabDataCache.highscore = data;

  const alliances = data.highscores?.alliances || data.alliances || [];
  const userAllianceId = window.settings?.allianceId;

  let html = `
    &lt;div class="league-container">
      &lt;div class="league-header">
        &lt;h3>Alliance Leaderboard&lt;/h3>
      &lt;/div>
      &lt;div class="league-standings">
  `;

  if (alliances.length > 0) {
    alliances.forEach((alliance, index) => {
      const position = index + 1;
      const positionClass = position &lt;= 3 ? `league-top-${position}` : '';
      const isUserAlliance = alliance.id === userAllianceId;
      const userClass = isUserAlliance ? 'league-user-alliance' : '';

      const medal = position === 1 ? '' : position === 2 ? '' : position === 3 ? '' : '';

      const primaryColor = normalizeColor(alliance.image_colors.primary);
      const secondaryColors = alliance.image_colors.secondary || ['FFFFFF', 'FFFFFF'];
      const gradientColor1 = normalizeColor(secondaryColors[0]);
      const gradientColor2 = normalizeColor(secondaryColors[1] || secondaryColors[0]);
      const gradient = `linear-gradient(${gradientColor1} 0%, ${gradientColor2} 100%)`;

      const logoInitials = alliance.name.substring(0, 2).toUpperCase();
      const languageFlag = alliance.language ? alliance.language.substring(3, 5).toUpperCase() : '';

      const foundedDate = new Date(alliance.time_founded * 1000);
      const foundedStr = foundedDate.toLocaleDateString('de-DE', { day: '2-digit', month: 'short', year: 'numeric' });

      html += `
        &lt;div class="league-alliance-row ${positionClass} ${userClass}">
          &lt;div class="league-position">
            &lt;span class="league-rank">${medal} #${position}&lt;/span>
          &lt;/div>
          &lt;div class="league-alliance-logo">
            &lt;div class="alliance-logo-wrapper" style="background: ${gradient};">
              &lt;img src="/api/alliance-logo/${alliance.image}?color=${encodeURIComponent(primaryColor)}" alt="${escapeHtml(alliance.name)}" class="alliance-logo-svg" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
              &lt;span class="alliance-logo-text" style="color: ${primaryColor}; display: none;">${logoInitials}&lt;/span>
            &lt;/div>
          &lt;/div>
          &lt;div class="league-alliance-info">
            &lt;div class="league-alliance-name clickable" data-alliance-id="${alliance.id}">
              ${escapeHtml(alliance.name)}
              ${languageFlag ? `&lt;span class="league-language-flag">${languageFlag}&lt;/span>` : ''}
              ${isUserAlliance ? '&lt;span class="league-you-badge">YOU&lt;/span>' : ''}
            &lt;/div>
            &lt;div class="league-alliance-meta">
              &lt;span>Level ${alliance.benefit_level}&lt;/span>
              &lt;span>${alliance.members} members&lt;/span>
              &lt;span>League ${alliance.league_level}&lt;/span>
              &lt;span>Founded ${foundedStr}&lt;/span>
            &lt;/div>
          &lt;/div>
          &lt;div class="league-stats">
            &lt;div class="league-stat-item">
              &lt;span class="league-stat-label">Contribution&lt;/span>
              &lt;span class="league-stat-value">${formatNumber(alliance.stats.contribution)}&lt;/span>
            &lt;/div>
          &lt;/div>
        &lt;/div>
      `;
    });
  } else {
    html += '&lt;p class="league-empty">No alliance data available.&lt;/p>';
  }

  html += `
      &lt;/div>
    &lt;/div>
  `;

  content.innerHTML = html;

  const allianceNames = content.querySelectorAll('.league-alliance-name.clickable');
  allianceNames.forEach(nameEl => {
    nameEl.addEventListener('click', async () => {
      const allianceId = parseInt(nameEl.getAttribute('data-alliance-id'));
      await showAllianceDetailsModal(allianceId);
    });
  });
}

/**
 * Shows a modal with alliance details
 * @param {number} allianceId - The alliance ID to show details for
 */
async function showAllianceDetailsModal(allianceId) {
  // Create modal overlay if it doesn't exist
  let modal = document.getElementById('allianceDetailsModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'allianceDetailsModal';
    modal.className = 'overlay';
    document.body.appendChild(modal);
  }

  // Show loading state with standard window structure
  modal.innerHTML = `
    &lt;div class="messenger-window">
      &lt;div class="messenger-header">
        &lt;h2> Alliance Information&lt;/h2>
        &lt;button class="close-btn alliance-details-close-btn">&lt;span>&lt;/span>&lt;/button>
      &lt;/div>
      &lt;div class="alliance-details-content">
        &lt;p class="alliance-tab-loading">Loading alliance details...&lt;/p>
      &lt;/div>
    &lt;/div>
  `;
  modal.classList.remove('hidden');

  // Add close button listener
  modal.querySelector('.alliance-details-close-btn').addEventListener('click', () => {
    modal.classList.add('hidden');
  });

  // Close on outside click
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.add('hidden');
    }
  });

  try {
    const [data, membersResponse] = await Promise.all([
      fetchAllianceInfoById(allianceId),
      fetchAllianceMembersById(allianceId)
    ]);

    const members = membersResponse.members || membersResponse;
    const lastSeasonTopContributors = membersResponse.last_season_top_contributors || [];

    // Group members by role
    const roleGroups = {
      ceo: { title: 'CEO', emoji: '', members: [] },
      coo: { title: 'COO', emoji: '', members: [] },
      management: { title: 'Management', emoji: '', members: [] },
      member: { title: 'Members', emoji: '', members: [] }
    };

    members.forEach(member => {
      const role = member.role || 'member';
      if (roleGroups[role]) {
        roleGroups[role].members.push(member);
      } else {
        roleGroups.member.members.push(member);
      }
    });

    // Check if user has alliance and if this alliance is open for joining
    const userAllianceInfo = await fetchAllianceInfo();
    const userHasAlliance = !userAllianceInfo.no_alliance;
    const isOpenAlliance = data.members &lt; 50;
    const showJoinButton = !userHasAlliance &amp;&amp; isOpenAlliance;

    // Build top contributors section HTML
    let topContributorsHtml = '';
    if (lastSeasonTopContributors.length > 0) {
      topContributorsHtml = `
        &lt;div class="top-contributors-section">
          &lt;h3>Top Contributors - Last Season&lt;/h3>
          &lt;table class="top-contributors-table">
            &lt;thead>
              &lt;tr>
                &lt;th>#&lt;/th>
                &lt;th>Member&lt;/th>
                &lt;th>Contribution&lt;/th>
                &lt;th>Reward&lt;/th>
              &lt;/tr>
            &lt;/thead>
            &lt;tbody>
      `;

      lastSeasonTopContributors.forEach((contributor, index) => {
        const member = members.find(m => m.user_id === contributor.user_id);
        const memberName = member ? escapeHtml(member.company_name) : 'Unknown';
        const rank = index + 1;
        const medal = rank === 1 ? '' : rank === 2 ? '' : '';
        const reward = contributor.point_reward;

        topContributorsHtml += `
          &lt;tr>
            &lt;td class="rank-cell">${rank}&lt;/td>
            &lt;td class="member-cell">&lt;span class="clickable alliance-member-name" data-user-id="${contributor.user_id}">${memberName}&lt;/span>&lt;/td>
            &lt;td class="contribution-cell">${formatNumber(contributor.contribution_score_sum)}&lt;/td>
            &lt;td class="reward-cell">${medal} ${reward} &lt;/td>
          &lt;/tr>
        `;
      });

      topContributorsHtml += `
            &lt;/tbody>
          &lt;/table>
        &lt;/div>
      `;
    }

    // Update content area with alliance data (using shared HTML generator)
    const contentArea = modal.querySelector('.alliance-details-content');
    contentArea.innerHTML = `
        ${generateAllianceInfoHTML(data, showJoinButton, allianceId)}

        ${topContributorsHtml}

        &lt;div class="members-section-header">
          &lt;h3>Members (${members.length})&lt;/h3>
          &lt;select class="member-sort-dropdown" id="externalAllianceMemberSortDropdown">
            &lt;option value="contribution-24h-desc">24h Contribution &lt;/option>
            &lt;option value="contribution-24h-asc">24h Contribution &lt;/option>
            &lt;option value="departures-24h-desc">24h Departures &lt;/option>
            &lt;option value="departures-24h-asc">24h Departures &lt;/option>
            &lt;option value="contribution-season-desc">Season Contribution &lt;/option>
            &lt;option value="contribution-season-asc">Season Contribution &lt;/option>
            &lt;option value="departures-season-desc">Season Departures &lt;/option>
            &lt;option value="departures-season-asc">Season Departures &lt;/option>
            &lt;option value="contribution-lifetime-desc">Lifetime Contribution &lt;/option>
            &lt;option value="contribution-lifetime-asc">Lifetime Contribution &lt;/option>
            &lt;option value="departures-lifetime-desc">Lifetime Departures &lt;/option>
            &lt;option value="departures-lifetime-asc">Lifetime Departures &lt;/option>
            &lt;option value="joined-desc">Joined &lt;/option>
            &lt;option value="joined-asc">Joined &lt;/option>
            &lt;option value="lastlogin-desc">Last Login &lt;/option>
            &lt;option value="lastlogin-asc">Last Login &lt;/option>
          &lt;/select>
        &lt;/div>

        &lt;div class="alliance-stats-grid" id="externalAllianceMembersGrid">&lt;/div>
    `;

    function renderExternalAllianceMembers(sortBy = 'contribution-24h', sortOrder = 'desc') {
      const allMembers = [];
      const groupOrder = ['ceo', 'coo', 'management', 'member'];
      groupOrder.forEach(roleKey => {
        const group = roleGroups[roleKey];
        group.members.forEach(m => {
          allMembers.push({ ...m, roleGroup: group });
        });
      });

      allMembers.sort((a, b) => {
        let aVal, bVal;

        const aStats = a.stats || { last_24h: { contribution: 0, departures: 0 }, last_season: { contribution: 0, departures: 0 }, lifetime: { contribution: 0, departures: 0 } };
        const bStats = b.stats || { last_24h: { contribution: 0, departures: 0 }, last_season: { contribution: 0, departures: 0 }, lifetime: { contribution: 0, departures: 0 } };

        if (sortBy === 'contribution-24h') {
          aVal = aStats.last_24h.contribution || 0;
          bVal = bStats.last_24h.contribution || 0;
        } else if (sortBy === 'departures-24h') {
          aVal = aStats.last_24h.departures || 0;
          bVal = bStats.last_24h.departures || 0;
        } else if (sortBy === 'contribution-season') {
          aVal = aStats.last_season.contribution || 0;
          bVal = bStats.last_season.contribution || 0;
        } else if (sortBy === 'departures-season') {
          aVal = aStats.last_season.departures || 0;
          bVal = bStats.last_season.departures || 0;
        } else if (sortBy === 'contribution-lifetime') {
          aVal = aStats.lifetime.contribution || 0;
          bVal = bStats.lifetime.contribution || 0;
        } else if (sortBy === 'departures-lifetime') {
          aVal = aStats.lifetime.departures || 0;
          bVal = bStats.lifetime.departures || 0;
        } else if (sortBy === 'joined') {
          aVal = a.time_joined || 0;
          bVal = b.time_joined || 0;
        } else if (sortBy === 'lastlogin') {
          aVal = a.time_last_login || 0;
          bVal = b.time_last_login || 0;
        }

        if (sortOrder === 'desc') {
          return bVal - aVal;
        } else {
          return aVal - bVal;
        }
      });

      let membersHtml = '';
      allMembers.forEach(m => {
        const joinedDate = m.time_joined ? new Date(m.time_joined * 1000).toLocaleDateString() : '-';
        const lastLoginDate = m.time_last_login ? new Date(m.time_last_login * 1000).toLocaleDateString() : '-';
        const shareValue = m.share_value !== undefined ? `$${formatNumber(m.share_value)}` : '-';

        const stats = m.stats || {
          last_24h: { contribution: 0, departures: 0 },
          last_season: { contribution: 0, departures: 0 },
          lifetime: { contribution: 0, departures: 0 }
        };

        let badges = '';
        if (m.tanker_ops) badges += ' ';
        if (m.is_rookie) badges += ' ';
        if (m.difficulty === 'realism') badges += '';
        else if (m.difficulty === 'easy') badges += '';

        membersHtml += `
          &lt;div class="alliance-stat-card member-card">
            &lt;h4 class="clickable alliance-member-name" data-user-id="${m.user_id}">${m.roleGroup.emoji} ${escapeHtml(m.company_name)}&lt;/h4>
            &lt;div class="stat-row">
              &lt;span>Role:&lt;/span>
              &lt;span class="stat-value">${m.roleGroup.title} ${badges}&lt;/span>
            &lt;/div>
            &lt;div class="stat-row">
              &lt;span>Share Value:&lt;/span>
              &lt;span class="stat-value">${shareValue}&lt;/span>
            &lt;/div>
            &lt;div class="stat-row">
              &lt;span>24h Contribution:&lt;/span>
              &lt;span class="stat-value">${formatNumber(stats.last_24h.contribution)}&lt;/span>
            &lt;/div>
            &lt;div class="stat-row">
              &lt;span>24h Departures:&lt;/span>
              &lt;span class="stat-value">${formatNumber(stats.last_24h.departures)}&lt;/span>
            &lt;/div>
            &lt;div class="stat-row">
              &lt;span>Season Contribution:&lt;/span>
              &lt;span class="stat-value">${formatNumber(stats.last_season.contribution)}&lt;/span>
            &lt;/div>
            &lt;div class="stat-row">
              &lt;span>Season Departures:&lt;/span>
              &lt;span class="stat-value">${formatNumber(stats.last_season.departures)}&lt;/span>
            &lt;/div>
            &lt;div class="stat-row">
              &lt;span>Lifetime Contribution:&lt;/span>
              &lt;span class="stat-value">${formatNumber(stats.lifetime.contribution)}&lt;/span>
            &lt;/div>
            &lt;div class="stat-row">
              &lt;span>Lifetime Departures:&lt;/span>
              &lt;span class="stat-value">${formatNumber(stats.lifetime.departures)}&lt;/span>
            &lt;/div>
            &lt;div class="stat-row">
              &lt;span>Joined:&lt;/span>
              &lt;span class="stat-value">${joinedDate}&lt;/span>
            &lt;/div>
            &lt;div class="stat-row">
              &lt;span>Last Login:&lt;/span>
              &lt;span class="stat-value">${lastLoginDate}&lt;/span>
            &lt;/div>
          &lt;/div>
        `;
      });

      document.getElementById('externalAllianceMembersGrid').innerHTML = membersHtml;

      contentArea.querySelectorAll('.alliance-member-name.clickable').forEach(nameEl => {
        nameEl.addEventListener('click', async () => {
          const userId = parseInt(nameEl.getAttribute('data-user-id'));
          await openPlayerProfile(userId, true);
        });
      });
    }

    renderExternalAllianceMembers();

    document.getElementById('externalAllianceMemberSortDropdown').addEventListener('change', (e) => {
      const value = e.target.value;
      const lastDashIndex = value.lastIndexOf('-');
      const sortBy = value.substring(0, lastDashIndex);
      const sortOrder = value.substring(lastDashIndex + 1);
      renderExternalAllianceMembers(sortBy, sortOrder);
    });

    // Add click listeners for top contributors table
    contentArea.querySelectorAll('.top-contributors-table .alliance-member-name.clickable').forEach(nameEl => {
      nameEl.addEventListener('click', async () => {
        const userId = parseInt(nameEl.getAttribute('data-user-id'));
        await openPlayerProfile(userId, true);
      });
    });

    // Add join button listener if button was added
    if (showJoinButton) {
      const joinBtn = modal.querySelector('.join-alliance-btn');
      if (joinBtn) {
        joinBtn.addEventListener('click', async () => {
          await handleJoinAllianceClick(allianceId, data.name);
        });
      }
    }
  } catch (error) {
    const contentArea = modal.querySelector('.alliance-details-content');
    if (contentArea) {
      contentArea.innerHTML = `&lt;p class="alliance-tab-error">Failed to load alliance details: ${error.message}&lt;/p>`;
    }
  }
}

/**
 * Renders the Management tab content
 */
async function renderManagementTab() {
  const content = document.getElementById('managementContent');
  if (!content) return;

  content.innerHTML = '&lt;p class="alliance-tab-loading">Loading management data...&lt;/p>';

  const [directPoolData, anyPoolData, membersResponse] = await Promise.all([
    fetchQueuePool({ pool_type: 'direct' }),
    fetchQueuePool({ pool_type: 'any' }),
    fetchAllianceMembers()
  ]);

  // Combine both pool types
  const poolData = {
    direct: directPoolData.direct,
    any: anyPoolData.any,
    no_alliance: directPoolData.no_alliance
  };

  // Extract members and current user info
  const membersData = membersResponse.members || membersResponse;
  const currentUserId = membersResponse.current_user_id;
  const currentUserRole = membersData.find(m => m.user_id === currentUserId)?.role || 'member';

  tabDataCache.management = { pool: poolData, members: membersData, currentUserId, currentUserRole };

  let html = `
    &lt;div class="management-container">
      &lt;div class="management-section">
        &lt;h3 class="management-section-title">Applications Queue&lt;/h3>
        &lt;div class="queue-pool-filters">
          &lt;select id="poolTypeFilter" class="management-filter">
            &lt;option value="direct">Direct&lt;/option>
            &lt;option value="any">Any&lt;/option>
          &lt;/select>
          &lt;select id="shareValueFilter" class="management-filter">
            &lt;option value="any">Any Share Value&lt;/option>
            &lt;option value="low">Low&lt;/option>
            &lt;option value="medium">Medium&lt;/option>
            &lt;option value="high">High&lt;/option>
          &lt;/select>
          &lt;select id="fleetSizeFilter" class="management-filter">
            &lt;option value="any">Any Fleet Size&lt;/option>
            &lt;option value="small">Small&lt;/option>
            &lt;option value="medium">Medium&lt;/option>
            &lt;option value="large">Large&lt;/option>
          &lt;/select>
          &lt;select id="experienceFilter" class="management-filter">
            &lt;option value="all">All&lt;/option>
            &lt;option value="rookies_only">Rookies Only&lt;/option>
          &lt;/select>
        &lt;/div>
        &lt;div id="queuePoolContent" class="queue-pool-content">
  `;

  if (poolData.no_alliance) {
    html += '&lt;p class="management-error">You are not in an alliance.&lt;/p>';
  } else {
    // Get items from either direct or any pool
    const poolItems = poolData.direct ? poolData.direct : poolData.any;
    if (poolItems &amp;&amp; poolItems.length > 0) {
      poolItems.forEach(item => {
        const requestDate = new Date(item.time_requested * 1000).toLocaleString();
        const shareValueText = item.share_value > 0 ? ` - $${formatNumber(item.share_value)}` : '';
        const rookieStatus = item.user.is_rookie ? 'Yes' : 'No';

        html += `
          &lt;div class="queue-pool-item">
            &lt;div class="application-header">
              &lt;span class="application-company">${escapeHtml(item.user.company_name)}&lt;/span>
              &lt;span class="application-id">(${item.user.id})&lt;/span>
              ${shareValueText ? `&lt;span class="application-share">${shareValueText}&lt;/span>` : ''}
              &lt;span class="application-time">${requestDate}&lt;/span>
            &lt;/div>
            &lt;div class="application-stats">
              &lt;span>Experience: ${item.experience}&lt;/span>
              &lt;span>Is Rookie: ${rookieStatus}&lt;/span>
            &lt;/div>
            &lt;div class="application-stats">
              &lt;span>Fleet size: ${item.fleet_size}&lt;/span>
              &lt;span>Departures 24h: ${item.user.departures_24h}&lt;/span>
            &lt;/div>
            &lt;div class="application-text">
              &lt;strong>User application:&lt;/strong>
              &lt;p>${escapeHtml(item.application_text)}&lt;/p>
            &lt;/div>
            &lt;div class="application-actions">
              &lt;button class="application-decline-btn" data-user-id="${item.user.id}">Decline&lt;/button>
              &lt;button class="application-accept-btn" data-user-id="${item.user.id}">Accept&lt;/button>
            &lt;/div>
          &lt;/div>
        `;
      });
    } else {
      html += '&lt;p class="queue-pool-empty">No applications in queue.&lt;/p>';
    }
  }

  html += `
        &lt;/div>
      &lt;/div>

      &lt;div class="management-section">
        &lt;h3 class="management-section-title management-section-collapsible" id="memberManagementToggle">
          &lt;span>Member Management&lt;/span>
          &lt;span class="toggle-icon">&lt;/span>
        &lt;/h3>
        &lt;div id="memberManagementContent" class="member-management-content collapsed">
  `;

  if (membersData &amp;&amp; membersData.length > 0) {
    // Group members by role
    const roleGroups = {
      ceo: { title: 'CEO', emoji: '', members: [] },
      coo: { title: 'COO', emoji: '', members: [] },
      management: { title: 'Management', emoji: '', members: [] },
      member: { title: 'Members', emoji: '', members: [] }
    };

    // Sort members into groups
    membersData.forEach(member => {
      const role = member.role || 'member';
      if (roleGroups[role]) {
        roleGroups[role].members.push(member);
      } else {
        roleGroups.member.members.push(member);
      }
    });

    // Helper function to render a member card
    const renderMemberCard = (member, group) => {
      // Additional emojis
      let additionalEmojis = '';
      if (member.tanker_ops) additionalEmojis += ' ';
      if (member.is_rookie) additionalEmojis += ' ';
      if (member.difficulty === 'realism') additionalEmojis += ' ';
      else if (member.difficulty === 'easy') additionalEmojis += ' ';

      // Format dates
      const joinedDate = new Date(member.time_joined * 1000).toLocaleDateString();
      const lastActiveDate = new Date(member.time_last_login * 1000).toLocaleDateString();

      // Format stock value
      const stockValue = member.share_value > 0 ? `$${formatNumber(member.share_value)}` : 'N/A';

      // Determine if role can be changed
      // ONLY CEO and COO can change roles
      // CEO can change all roles
      // COO can change all roles EXCEPT CEO
      let canChangeRole = false;
      if (currentUserRole === 'ceo') {
        canChangeRole = true;
      } else if (currentUserRole === 'coo' &amp;&amp; member.role !== 'ceo') {
        canChangeRole = true;
      }

      let roleActionsHtml = '';
      if (canChangeRole) {
        // Build role options based on current user's permissions
        let roleOptions = `
          &lt;option value="member" ${member.role === 'member' ? 'selected' : ''}>Member&lt;/option>
          &lt;option value="management" ${member.role === 'management' ? 'selected' : ''}>Management&lt;/option>
        `;
        // Only CEO can assign COO or Interim CEO
        if (currentUserRole === 'ceo') {
          roleOptions += `
            &lt;option value="interimceo" ${member.role === 'interimceo' ? 'selected' : ''}>Interim CEO&lt;/option>
            &lt;option value="coo" ${member.role === 'coo' ? 'selected' : ''}>COO&lt;/option>
          `;
        }

        roleActionsHtml = `
          &lt;select class="member-role-select" data-user-id="${member.user_id}">
            ${roleOptions}
          &lt;/select>
          &lt;button class="member-role-save-btn" data-user-id="${member.user_id}" title="Save Role" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'">&lt;span>&lt;/span>&lt;/button>
        `;
      }

      return `
        &lt;div class="alliance-stat-card member-card">
          &lt;h4>
            &lt;span title="${group.title}">${group.emoji}&lt;/span> &lt;span class="clickable alliance-member-name" data-user-id="${member.user_id}">${escapeHtml(member.company_name)}&lt;/span>
            &lt;span class="member-badges">${additionalEmojis}&lt;/span>
          &lt;/h4>
          &lt;div class="stat-row stat-row-muted">
            &lt;span>ID: ${member.user_id}&lt;/span>
          &lt;/div>
          &lt;div class="stat-row">
            &lt;span>Stock:&lt;/span>
            &lt;span class="stat-value">${stockValue}&lt;/span>
          &lt;/div>
          &lt;div class="stat-row">
            &lt;span>Joined:&lt;/span>
            &lt;span class="stat-value">${joinedDate}&lt;/span>
          &lt;/div>
          &lt;div class="stat-row">
            &lt;span>Last Active:&lt;/span>
            &lt;span class="stat-value">${lastActiveDate}&lt;/span>
          &lt;/div>
          &lt;div class="stat-row">
            &lt;span>Contribution:&lt;/span>
            &lt;span class="stat-value">${member.contribution !== undefined ? formatNumber(member.contribution) : 'N/A'}&lt;/span>
          &lt;/div>
          &lt;div class="stat-row">
            &lt;span>Departures:&lt;/span>
            &lt;span class="stat-value">${member.departures !== undefined ? formatNumber(member.departures) : 'N/A'}&lt;/span>
          &lt;/div>
          ${roleActionsHtml ? `
            &lt;div class="member-card-action">
              ${roleActionsHtml}
            &lt;/div>
          ` : ''}
        &lt;/div>
      `;
    };

    // Render CEO and COO together in one row
    if (roleGroups.ceo.members.length > 0 || roleGroups.coo.members.length > 0) {
      html += `&lt;h4 class="member-group-title"> CEO &amp;  COO&lt;/h4>`;
      html += `&lt;div class="members-grid">`;

      // Render CEO members
      roleGroups.ceo.members.forEach(member => {
        html += renderMemberCard(member, roleGroups.ceo);
      });

      // Render COO members
      roleGroups.coo.members.forEach(member => {
        html += renderMemberCard(member, roleGroups.coo);
      });

      html += `&lt;/div>`;
    }

    // Render Management
    if (roleGroups.management.members.length > 0) {
      html += `&lt;h4 class="member-group-title"> Management&lt;/h4>`;
      html += `&lt;div class="members-grid">`;
      roleGroups.management.members.forEach(member => {
        html += renderMemberCard(member, roleGroups.management);
      });
      html += `&lt;/div>`;
    }

    // Render Members
    if (roleGroups.member.members.length > 0) {
      html += `&lt;h4 class="member-group-title"> Members&lt;/h4>`;
      html += `&lt;div class="members-grid">`;
      roleGroups.member.members.forEach(member => {
        html += renderMemberCard(member, roleGroups.member);
      });
      html += `&lt;/div>`;
    }
  } else {
    html += '&lt;p class="member-management-empty">No members found.&lt;/p>';
  }

  html += `
        &lt;/div>
      &lt;/div>

      &lt;div class="management-section">
        &lt;h3 class="management-section-title">Welcome Message&lt;/h3>
        &lt;p class="management-section-description">This message will be sent to new members when accepting their application.&lt;/p>
        &lt;p class="management-section-description">Use &lt;code>[allianceName]&lt;/code> as variable in subject and message body.&lt;/p>
        &lt;div class="welcome-message-container">
          &lt;div class="welcome-subject-row">
            &lt;label for="welcomeSubjectInput">Subject:&lt;/label>
            &lt;input type="text" id="welcomeSubjectInput"
                   class="welcome-subject-input"
                   maxlength="100"
                   placeholder="Welcome to [allianceName]">
          &lt;/div>
          &lt;textarea id="welcomeMessageInput"
                    class="welcome-message-textarea"
                    maxlength="900"
                    placeholder="Enter your welcome message here..."
                    rows="5">&lt;/textarea>
          &lt;div class="welcome-message-footer">
            &lt;span id="welcomeMessageCharCount" class="char-count">0 / 900&lt;/span>
            &lt;button id="saveWelcomeMessageBtn" class="alliance-settings-save-btn">Save Welcome Message&lt;/button>
          &lt;/div>
        &lt;/div>
      &lt;/div>
    &lt;/div>
  `;

  content.innerHTML = html;

  // Load saved welcome message from user settings
  await loadWelcomeMessage();

  // Add event listeners for live filter updates
  const filterSelects = [
    document.getElementById('poolTypeFilter'),
    document.getElementById('shareValueFilter'),
    document.getElementById('fleetSizeFilter'),
    document.getElementById('experienceFilter')
  ];

  const applyFilters = async () => {
    const filters = {
      pool_type: document.getElementById('poolTypeFilter').value,
      filter_share_value: document.getElementById('shareValueFilter').value,
      filter_fleet_size: document.getElementById('fleetSizeFilter').value,
      filter_experience: document.getElementById('experienceFilter').value,
      page: 1
    };

    const queuePoolContent = document.getElementById('queuePoolContent');
    queuePoolContent.innerHTML = '&lt;p class="alliance-tab-loading">Loading...&lt;/p>';

    try {
      const newPoolData = await fetchQueuePool(filters);
      let poolHtml = '';

      // Get items from either direct or any pool based on selected filter
      let poolItems = newPoolData.direct ? newPoolData.direct : newPoolData.any;

      // Filter by rookie status
      if (filters.filter_experience === 'rookies_only' &amp;&amp; poolItems) {
        poolItems = poolItems.filter(item => item.user.is_rookie === true);
      }

      // Filter by share value
      if (filters.filter_share_value !== 'any' &amp;&amp; poolItems) {
        poolItems = poolItems.filter(item => {
          const shareValue = item.share_value;
          if (filters.filter_share_value === 'low') return shareValue > 0 &amp;&amp; shareValue &lt; 100000;
          if (filters.filter_share_value === 'medium') return shareValue >= 100000 &amp;&amp; shareValue &lt; 500000;
          if (filters.filter_share_value === 'high') return shareValue >= 500000;
          return true;
        });
      }

      // Filter by fleet size
      if (filters.filter_fleet_size !== 'any' &amp;&amp; poolItems) {
        poolItems = poolItems.filter(item => {
          const fleetSize = item.fleet_size;
          if (filters.filter_fleet_size === 'small') return fleetSize &lt; 10;
          if (filters.filter_fleet_size === 'medium') return fleetSize >= 10 &amp;&amp; fleetSize &lt; 50;
          if (filters.filter_fleet_size === 'large') return fleetSize >= 50;
          return true;
        });
      }

      if (poolItems &amp;&amp; poolItems.length > 0) {
        poolItems.forEach(item => {
          const requestDate = new Date(item.time_requested * 1000).toLocaleString();
          const shareValueText = item.share_value > 0 ? ` - $${formatNumber(item.share_value)}` : '';
          const rookieStatus = item.user.is_rookie ? 'Yes' : 'No';

          poolHtml += `
            &lt;div class="queue-pool-item">
              &lt;div class="application-header">
                &lt;span class="application-company">${escapeHtml(item.user.company_name)}&lt;/span>
                &lt;span class="application-id">(${item.user.id})&lt;/span>
                ${shareValueText ? `&lt;span class="application-share">${shareValueText}&lt;/span>` : ''}
                &lt;span class="application-time">${requestDate}&lt;/span>
              &lt;/div>
              &lt;div class="application-stats">
                &lt;span>Experience: ${item.experience}&lt;/span>
                &lt;span>Is Rookie: ${rookieStatus}&lt;/span>
              &lt;/div>
              &lt;div class="application-stats">
                &lt;span>Fleet size: ${item.fleet_size}&lt;/span>
                &lt;span>Departures 24h: ${item.user.departures_24h}&lt;/span>
              &lt;/div>
              &lt;div class="application-text">
                &lt;strong>User application:&lt;/strong>
                &lt;p>${escapeHtml(item.application_text)}&lt;/p>
              &lt;/div>
              &lt;div class="application-actions">
                &lt;button class="application-decline-btn" data-user-id="${item.user.id}">Decline&lt;/button>
                &lt;button class="application-accept-btn" data-user-id="${item.user.id}">Accept&lt;/button>
              &lt;/div>
            &lt;/div>
          `;
        });
      } else {
        poolHtml = '&lt;p class="queue-pool-empty">No applications in queue.&lt;/p>';
      }

      queuePoolContent.innerHTML = poolHtml;
    } catch {
      queuePoolContent.innerHTML = '&lt;p class="management-error">Failed to load queue pool.&lt;/p>';
    }
  };

  filterSelects.forEach(select => {
    if (select) {
      select.addEventListener('change', applyFilters);
    }
  });

  // Add accept button listeners
  const acceptBtns = document.querySelectorAll('.application-accept-btn');
  acceptBtns.forEach(btn => {
    btn.addEventListener('click', async () => {
      const userId = parseInt(btn.getAttribute('data-user-id'));
      const companyName = btn.closest('.queue-pool-item').querySelector('.application-company').textContent;

      btn.disabled = true;
      btn.textContent = 'Accepting...';

      try {
        await acceptUserToAlliance(userId);
        showSideNotification(`Successfully accepted ${companyName} to the alliance`, 'success');

        // Send welcome message to the new member
        await sendWelcomeMessageToUser(userId, companyName);

        // Remove the application from the UI
        btn.closest('.queue-pool-item').remove();

        // Check if there are no more applications
        const remainingItems = document.querySelectorAll('.queue-pool-item');
        if (remainingItems.length === 0) {
          document.getElementById('queuePoolContent').innerHTML = '&lt;p class="queue-pool-empty">No applications in queue.&lt;/p>';
        }
      } catch (error) {
        showSideNotification(`Failed to accept user: ${error.message}`, 'error');
        btn.disabled = false;
        btn.textContent = 'Accept';
      }
    });
  });

  // Add decline button listeners
  const declineBtns = document.querySelectorAll('.application-decline-btn');
  declineBtns.forEach(btn => {
    btn.addEventListener('click', async () => {
      const userId = parseInt(btn.getAttribute('data-user-id'));
      const companyName = btn.closest('.queue-pool-item').querySelector('.application-company').textContent;

      btn.disabled = true;
      btn.textContent = 'Declining...';

      try {
        await declineUserFromAlliance(userId);
        showSideNotification(`Declined application from ${companyName}`, 'info');
        // Remove the application from the UI
        btn.closest('.queue-pool-item').remove();

        // Check if there are no more applications
        const remainingItems = document.querySelectorAll('.queue-pool-item');
        if (remainingItems.length === 0) {
          document.getElementById('queuePoolContent').innerHTML = '&lt;p class="queue-pool-empty">No applications in queue.&lt;/p>';
        }
      } catch (error) {
        showSideNotification(`Failed to decline user: ${error.message}`, 'error');
        btn.disabled = false;
        btn.textContent = 'Decline';
      }
    });
  });

  // Add role save button listeners
  const roleSaveBtns = document.querySelectorAll('.member-role-save-btn');
  roleSaveBtns.forEach(btn => {
    btn.addEventListener('click', async () => {
      const userId = parseInt(btn.getAttribute('data-user-id'));
      const selectElement = document.querySelector(`.member-role-select[data-user-id="${userId}"]`);
      const newRole = selectElement.value;

      btn.disabled = true;
      try {
        await updateUserRole(userId, newRole);
        showSideNotification(`Role updated successfully`, 'success');
      } catch (error) {
        showSideNotification(`Failed to update role: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
      }
    });
  });

  // Add click handlers for clickable member names in member cards
  const clickableMembers = document.querySelectorAll('#memberManagementContent .alliance-member-name.clickable');
  clickableMembers.forEach(memberSpan => {
    memberSpan.addEventListener('click', async () => {
      const userId = parseInt(memberSpan.getAttribute('data-user-id'));
      if (userId) {
        await openPlayerProfile(userId, true);
      }
    });
  });

  // Add toggle for Member Management section
  const memberManagementToggle = document.getElementById('memberManagementToggle');
  const memberManagementContent = document.getElementById('memberManagementContent');
  if (memberManagementToggle &amp;&amp; memberManagementContent) {
    memberManagementToggle.addEventListener('click', () => {
      memberManagementContent.classList.toggle('collapsed');
      const toggleIcon = memberManagementToggle.querySelector('.toggle-icon');
      if (toggleIcon) {
        toggleIcon.textContent = memberManagementContent.classList.contains('collapsed') ? '' : '';
      }
    });
  }
}

/**
 * Renders the Settings tab content
 */
async function renderSettingsTab() {
  const content = document.getElementById('allianceSettingsContent');
  if (!content) return;

  content.innerHTML = '&lt;p class="alliance-tab-loading">Loading settings...&lt;/p>';

  const [data, membersResponse] = await Promise.all([
    fetchAllianceSettings(),
    fetchAllianceMembers()
  ]);

  tabDataCache.settings = data;

  if (data.no_alliance) {
    content.innerHTML = '&lt;p class="alliance-tab-error">You are not in an alliance.&lt;/p>';
    return;
  }

  const membersData = membersResponse.members || membersResponse;
  const currentUserId = membersResponse.current_user_id;
  const currentUserRole = membersData.find(m => m.user_id === currentUserId)?.role || 'member';
  const isCeo = currentUserRole === 'ceo';

  const timeRangeStart = data.restrictions?.time_restriction_arr?.[0] || 0;
  const timeRangeEnd = data.restrictions?.time_restriction_arr?.[1] || 24;
  const capacityMin = data.restrictions?.selected_vessel_capacity || 0;
  const timeRangeEnabled = data.restrictions?.time_range_enabled || false;

  const leaveButtonText = isCeo ? 'Close Alliance' : 'Leave Alliance';
  const leaveButtonTitle = isCeo ? 'Close this alliance for all members' : 'Leave this alliance';

  content.innerHTML = `
    &lt;div class="alliance-settings-container">
      &lt;h3 class="alliance-settings-title">Your Alliance Cooperation Settings&lt;/h3>

      &lt;div class="alliance-settings-group">
        &lt;div class="alliance-settings-item">
          &lt;label class="alliance-settings-label">
            &lt;input type="checkbox" id="coopEnabledToggle" ${data.coop_enabled ? 'checked' : ''}>
            &lt;span>Enable Cooperation &lt;span class="alliance-settings-inline-help">(Allow alliance members to send you coop vessels)&lt;/span>&lt;/span>
          &lt;/label>
        &lt;/div>
        &lt;h4>Restrictions&lt;/h4>

        &lt;div class="alliance-settings-item">
          &lt;label class="alliance-settings-label">
            &lt;span>Minimum Vessel Capacity:&lt;/span>
            &lt;input type="number" id="capacityMinInput" value="${capacityMin}" min="0" class="alliance-settings-input">
          &lt;/label>
          &lt;p class="alliance-settings-help">Only accept coops from members with at least this vessel capacity (0 = no restriction).&lt;/p>
        &lt;/div>

        &lt;div class="alliance-settings-item">
          &lt;label class="alliance-settings-label">
            &lt;input type="checkbox" id="timeRangeEnabledToggle" ${timeRangeEnabled ? 'checked' : ''}>
            &lt;span>Enable Time Restriction&lt;/span>
          &lt;/label>
        &lt;/div>

        &lt;div class="alliance-settings-item">
          &lt;label class="alliance-settings-label">
            &lt;span>Acceptance Time Range (UTC):&lt;/span>
          &lt;/label>
          &lt;div class="time-range-inputs">
            &lt;input type="number" id="timeRangeStart" value="${timeRangeStart}" min="0" max="23" class="alliance-settings-input-small">
            &lt;span>to&lt;/span>
            &lt;input type="number" id="timeRangeEnd" value="${timeRangeEnd}" min="1" max="24" class="alliance-settings-input-small">
          &lt;/div>
          &lt;p class="alliance-settings-help">Only accept coops during this time window (UTC hours).&lt;/p>
        &lt;/div>
      &lt;/div>

      &lt;div class="alliance-settings-footer">
        &lt;button id="leaveAllianceBtn" class="alliance-leave-btn" title="${leaveButtonTitle}" data-is-ceo="${isCeo}">${leaveButtonText}&lt;/button>
        &lt;div class="alliance-settings-save-area">
          &lt;button id="saveAllianceSettingsBtn" class="alliance-settings-save-btn">Save Settings&lt;/button>
          &lt;p class="alliance-settings-note">
            Note: These settings are fetched from the game API. Saving changes will update your in-game settings.
          &lt;/p>
        &lt;/div>
      &lt;/div>
    &lt;/div>
  `;

  // Add event listener for save button
  const saveBtn = document.getElementById('saveAllianceSettingsBtn');
  if (saveBtn) {
    saveBtn.addEventListener('click', async () => {
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const coopEnabled = document.getElementById('coopEnabledToggle').checked;
        const capacityMin = parseInt(document.getElementById('capacityMinInput').value, 10);
        const timeRangeEnabled = document.getElementById('timeRangeEnabledToggle').checked;
        const hhmmFrom = parseInt(document.getElementById('timeRangeStart').value, 10);
        const hhmmTo = parseInt(document.getElementById('timeRangeEnd').value, 10);

        const settings = {
          coop_enabled: coopEnabled,
          capacity_min: capacityMin,
          hhmm_from: hhmmFrom,
          hhmm_to: hhmmTo,
          time_range_enabled: timeRangeEnabled
        };

        await updateAllianceSettings(settings);
        showSideNotification('Settings saved successfully!', 'success');

        // Clear cache and reload tab
        tabDataCache.settings = null;
        await renderSettingsTab();
      } catch (error) {
        console.error('[Alliance Settings] Save failed:', error);
        showSideNotification(`Failed to save settings: ${error.message}`, 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Settings';
      }
    });
  }

  // Add event listener for leave/close alliance button
  const leaveBtn = document.getElementById('leaveAllianceBtn');
  if (leaveBtn) {
    leaveBtn.addEventListener('click', async () => {
      const isCeoAction = leaveBtn.getAttribute('data-is-ceo') === 'true';

      const confirmConfig = isCeoAction ? {
        title: 'Close Alliance',
        message: '&lt;p>Are you sure you want to close this alliance?&lt;/p>&lt;p>&lt;strong>This will disband the alliance for all members. This action cannot be undone.&lt;/strong>&lt;/p>',
        confirmText: 'Close Alliance',
        cancelText: 'Cancel',
        narrow: true
      } : {
        title: 'Leave Alliance',
        message: '&lt;p>Are you sure you want to leave this alliance?&lt;/p>&lt;p>&lt;strong>This action cannot be undone.&lt;/strong>&lt;/p>',
        confirmText: 'Leave',
        cancelText: 'Cancel',
        narrow: true
      };

      const confirmed = await showConfirmDialog(confirmConfig);
      if (!confirmed) return;

      leaveBtn.disabled = true;
      leaveBtn.textContent = isCeoAction ? 'Closing...' : 'Leaving...';

      try {
        await leaveAlliance();

        // Immediately hide all alliance UI elements
        await hideAllAllianceUI();

        // Reload settings from server to ensure sync
        const updatedSettings = await loadSettings();
        if (window.settings) {
          window.settings = updatedSettings;
        }

        const successMessage = isCeoAction ? 'Alliance has been closed.' : 'You have left the alliance.';
        showSideNotification(successMessage, 'success');

        // Switch to search tab to show alliance search interface
        currentTab = 'search';
        await renderSearchTab();

      } catch (error) {
        console.error('[Alliance] Leave/Close failed:', error);
        const errorMessage = isCeoAction ? 'Failed to close alliance' : 'Failed to leave alliance';
        showSideNotification(`${errorMessage}: ${error.message}`, 'error');
        leaveBtn.disabled = false;
        leaveBtn.textContent = isCeoAction ? 'Close Alliance' : 'Leave Alliance';
      }
    });
  }
}

/**
 * Shows the alliance cooperation overlay with tabs
 */
export async function showAllianceCoopOverlay() {
  const overlay = document.getElementById('coopOverlay');
  if (!overlay) {
    console.error('[Alliance Tabs] Overlay element not found');
    return;
  }

  // Show overlay IMMEDIATELY
  overlay.classList.remove('hidden');

  // Show loading state in all tab contents
  const tabContents = overlay.querySelectorAll('.alliance-tab-content');
  tabContents.forEach(content => {
    content.innerHTML = '&lt;div class="alliance-loading">&lt;p>Loading...&lt;/p>&lt;/div>';
  });

  // Initialize tab switching if not already done
  initAllianceTabs();

  // Check if user has alliance (async operation)
  try {
    const allianceInfo = await fetchAllianceInfo();
    const hasAlliance = !allianceInfo.no_alliance;

    if (hasAlliance) {
      // User has alliance - show all relevant tabs and check role
      await updateManagementTabVisibility();
      await updateTabVisibilityForAllianceMembers();
      await switchTab('allianz');
    } else {
      // User has NO alliance - only show Search and Settings tabs
      await updateTabVisibilityForNonMembers();
      await switchTab('search');
    }
  } catch (error) {
    console.error('[Alliance Tabs] Error fetching alliance info:', error);
    // On error, assume no alliance and show only Search and Settings
    await updateTabVisibilityForNonMembers();
    await switchTab('search');
  }
}

/**
 * Updates tab visibility for alliance members
 * Shows: Allianz, Coop, Liga, HighScore, Settings, (Management if role allows)
 */
async function updateTabVisibilityForAllianceMembers() {
  const tabs = document.querySelectorAll('.alliance-coop-tabs .tab-button');
  tabs.forEach(tab => {
    const tabName = tab.getAttribute('data-tab');
    if (tabName !== 'management') {
      tab.style.display = '';
    }
  });
}

/**
 * Updates tab visibility for non-alliance users
 * Shows ONLY: Search
 */
async function updateTabVisibilityForNonMembers() {
  const tabs = document.querySelectorAll('.alliance-coop-tabs .tab-button');
  tabs.forEach(tab => {
    const tabName = tab.getAttribute('data-tab');
    if (tabName === 'search') {
      tab.style.display = '';
    } else {
      tab.style.display = 'none';
    }
  });
}

/**
 * Updates the visibility of the Management tab based on user's alliance role
 * Only CEO, COO, and Management members can see the Management tab
 */
async function updateManagementTabVisibility() {
  const managementTabButton = document.querySelector('.tab-button[data-tab="management"]');
  if (!managementTabButton) return;

  try {
    const membersResponse = await fetchAllianceMembers();
    const membersData = membersResponse.members || membersResponse;
    const currentUserId = membersResponse.current_user_id;
    const currentUserRole = membersData.find(m => m.user_id === currentUserId)?.role || 'member';

    // Only show Management tab and Welcome Command Settings for CEO, COO, Management, and Interim CEO roles
    const allowedRoles = ['ceo', 'coo', 'management', 'interimceo'];
    const isAllowed = allowedRoles.includes(currentUserRole);

    // Show/hide Management tab
    if (isAllowed) {
      managementTabButton.style.display = '';
    } else {
      managementTabButton.style.display = 'none';
    }

    // Show/hide Welcome Command Settings box in settings
    const welcomeCommandBox = document.getElementById('welcomeCommandSettingsBox');
    if (welcomeCommandBox) {
      if (isAllowed) {
        welcomeCommandBox.style.display = '';
      } else {
        welcomeCommandBox.style.display = 'none';
      }
    }
  } catch (error) {
    console.error('[Alliance Tabs] Error checking user role:', error);
    // Hide management tab and welcome command settings on error (fail secure)
    managementTabButton.style.display = 'none';
    const welcomeCommandBox = document.getElementById('welcomeCommandSettingsBox');
    if (welcomeCommandBox) {
      welcomeCommandBox.style.display = 'none';
    }
  }
}

/**
 * Closes the alliance cooperation overlay
 */
export function closeAllianceCoopOverlay() {
  const overlay = document.getElementById('coopOverlay');
  if (overlay) {
    overlay.classList.add('hidden');
  }
}

/**
 * Refreshes the current tab content
 */
export async function refreshCurrentTab() {
  await loadTabContent(currentTab);
}

/**
 * Gets the current active tab name
 * @returns {string} Current tab name
 */
export function getCurrentTab() {
  return currentTab;
}

/**
 * Clears the alliance tab cache to force fresh data on next tab switch
 */
export function clearAllianceTabCache() {
  tabDataCache = {
    allianz: null,
    liga: null,
    highscore: null,
    search: null,
    management: null,
    settings: null,
    coop: null
  };
}

/**
 * Updates the coop badge in the tab button
 * @param {number} count - Number of available coop slots
 */
export function updateCoopTabBadge(count) {
  const badge = document.getElementById('coopTabBadge');
  if (badge) {
    badge.textContent = count;
    if (count > 0) {
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }
  }
}

/**
 * Renders the Search tab content
 */
async function renderSearchTab() {
  const content = document.getElementById('searchContent');
  if (!content) return;

  // Initialize on first load
  if (!searchState.initialized) {
    searchState.initialized = true;
    searchState.offset = 0;
    searchState.results = [];
    searchState.query = '';
    searchState.filters = { sortBy: 'name_asc', hasOpenSlots: false };
    searchState.hasMore = true;
  }

  // Check indexer status
  const statusResponse = await fetch(window.apiUrl('/api/alliances/status'));
  const status = await statusResponse.json();

  // Fetch available languages
  let availableLanguages = null;
  if (status.data.isReady) {
    try {
      const languagesResponse = await fetch(window.apiUrl('/api/alliances/languages'));

      if (!languagesResponse.ok) {
        console.error('[Search] Languages API failed:', languagesResponse.status, languagesResponse.statusText);
        throw new Error(`API returned ${languagesResponse.status}`);
      }

      const languagesData = await languagesResponse.json();

      if (!languagesData.success) {
        console.error('[Search] Languages API returned error:', languagesData);
        throw new Error('API returned success: false');
      }

      if (!Array.isArray(languagesData.data.languages)) {
        console.error('[Search] Languages API returned invalid data:', languagesData);
        throw new Error('API did not return array');
      }

      availableLanguages = languagesData.data.languages;
      console.log('[Search] Loaded languages:', availableLanguages);
    } catch (error) {
      console.error('[Search] Failed to load languages:', error);
      availableLanguages = null;
    }
  }

  // Check if user has alliance
  const allianceInfo = await fetchAllianceInfo();
  const userHasAlliance = !allianceInfo.no_alliance;

  // Fetch pending applications (always check, API returns empty if user has alliance)
  let directApplications = [];
  let anyPoolApplication = null;
  try {
    const applicationsResponse = await fetch(window.apiUrl('/api/alliance-get-applications'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    if (applicationsResponse.ok) {
      const applicationsData = await applicationsResponse.json();
      console.log('[Search] Applications API response:', applicationsData);

      // Extract direct applications
      directApplications = applicationsData.data?.pool_state?.direct || [];

      // Extract "any alliance" pool application (if exists)
      anyPoolApplication = applicationsData.data?.pool_state?.any || null;

      console.log('[Search] Direct applications:', directApplications);
      console.log('[Search] Any pool application:', anyPoolApplication);
    } else {
      console.error('[Search] Applications API failed with status:', applicationsResponse.status);
    }
  } catch (error) {
    console.error('[Search] Failed to load pending applications:', error);
  }

  // Update pool button state (only when on search tab to prevent other tabs from affecting tab bar)
  const poolBtn = document.getElementById('anyAlliancePoolBtn');
  const inAnyPool = anyPoolApplication !== null;

  if (poolBtn) {
    if (!userHasAlliance &amp;&amp; !inAnyPool) {
      // User not in alliance and not in pool - show "Apply" button (green)
      poolBtn.style.display = '';
      poolBtn.textContent = 'Apply for Any Alliance';
      poolBtn.classList.remove('pool-leave-btn');
      poolBtn.classList.add('pool-join-btn');
    } else if (!userHasAlliance &amp;&amp; inAnyPool) {
      // User in pool - show "Cancel" button (red)
      poolBtn.style.display = '';
      poolBtn.textContent = 'Cancel';
      poolBtn.classList.remove('pool-join-btn');
      poolBtn.classList.add('pool-leave-btn');
    } else {
      // User has alliance - hide button
      poolBtn.style.display = 'none';
    }
  }

  // Build UI
  let html = `
    &lt;div class="alliance-search-container">
      ${!status.data.isReady ? `
        &lt;div class="alliance-search-overlay">
          &lt;div class="alliance-search-overlay-content">
            &lt;div class="alliance-search-spinner">&lt;/div>
            &lt;div class="alliance-search-overlay-text">
              &lt;h2>Indexing alliances...&lt;/h2>
              &lt;p>Please wait. This may take a moment.&lt;/p>
            &lt;/div>
          &lt;/div>
        &lt;/div>
      ` : ''}


      &lt;!-- Search Header -->
      &lt;div class="alliance-search-header">
        &lt;input
          type="text"
          id="allianceSearchInput"
          class="alliance-search-input"
          placeholder="Search alliances by name or description..."
          value="${escapeHtml(searchState.query)}"
        />
        &lt;button id="allianceSearchBtn" class="alliance-search-btn">Search&lt;/button>
        &lt;button id="allianceSearchClearBtn" class="alliance-search-clear-btn">Clear&lt;/button>
      &lt;/div>

      &lt;!-- Filter Options -->
      &lt;div class="alliance-search-filters">
        &lt;select id="allianceFilterLanguage" class="alliance-filter-select" ${availableLanguages === null ? 'disabled' : ''}>
          ${availableLanguages === null ?
            `&lt;option value="">Language filter unavailable&lt;/option>` :
            `&lt;option value="">All Languages&lt;/option>
            ${availableLanguages.map(lang =>
              `&lt;option value="${lang}" ${searchState.filters.language === lang ? 'selected' : ''}>${lang.toUpperCase()}&lt;/option>`
            ).join('')}`
          }
        &lt;/select>

        &lt;select id="allianceFilterSort" class="alliance-filter-select">
          &lt;option value="name_asc" ${searchState.filters.sortBy === 'name_asc' ? 'selected' : ''}>Name (A-Z)&lt;/option>
          &lt;option value="name_desc" ${searchState.filters.sortBy === 'name_desc' ? 'selected' : ''}>Name (Z-A)&lt;/option>
          &lt;option value="members_desc" ${searchState.filters.sortBy === 'members_desc' ? 'selected' : ''}>Members (High to Low)&lt;/option>
          &lt;option value="members_asc" ${searchState.filters.sortBy === 'members_asc' ? 'selected' : ''}>Members (Low to High)&lt;/option>
          &lt;option value="contribution_desc" ${searchState.filters.sortBy === 'contribution_desc' ? 'selected' : ''}>Contribution (High to Low)&lt;/option>
          &lt;option value="contribution_asc" ${searchState.filters.sortBy === 'contribution_asc' ? 'selected' : ''}>Contribution (Low to High)&lt;/option>
          &lt;option value="departures_desc" ${searchState.filters.sortBy === 'departures_desc' ? 'selected' : ''}>Departures (High to Low)&lt;/option>
          &lt;option value="departures_asc" ${searchState.filters.sortBy === 'departures_asc' ? 'selected' : ''}>Departures (Low to High)&lt;/option>
          &lt;option value="share_value_desc" ${searchState.filters.sortBy === 'share_value_desc' ? 'selected' : ''}>Share Value (High to Low)&lt;/option>
          &lt;option value="share_value_asc" ${searchState.filters.sortBy === 'share_value_asc' ? 'selected' : ''}>Share Value (Low to High)&lt;/option>
          &lt;option value="founded_desc" ${searchState.filters.sortBy === 'founded_desc' ? 'selected' : ''}>Newest First&lt;/option>
          &lt;option value="founded_asc" ${searchState.filters.sortBy === 'founded_asc' ? 'selected' : ''}>Oldest First&lt;/option>
        &lt;/select>

        &lt;select id="allianceFilterOpenSlots" class="alliance-filter-select">
          &lt;option value="all" ${!searchState.filters.hasOpenSlots ? 'selected' : ''}>All Alliances&lt;/option>
          &lt;option value="open" ${searchState.filters.hasOpenSlots ? 'selected' : ''}>Only Open&lt;/option>
        &lt;/select>
      &lt;/div>

      &lt;!-- Pending Applications Section (only for non-alliance users) -->
      ${directApplications.length > 0 || inAnyPool ? `
        &lt;div class="pending-applications-section">
          &lt;div class="pending-applications-header">
            &lt;h3>Your Pending Applications&lt;/h3>
            ${directApplications.length > 0 ? `
              &lt;button id="cancelAllApplicationsBtn" class="cancel-all-btn">Cancel All Applications&lt;/button>
            ` : ''}
          &lt;/div>

          ${inAnyPool ? `
            &lt;div class="pending-application-item pool-item">
              &lt;div class="application-info">
                &lt;strong>Queued for ANY alliance&lt;/strong>
                &lt;p>You are in the general pool. Alliances can invite you.&lt;/p>
                ${anyPoolApplication?.time_requested ? `&lt;p>Joined pool: ${new Date(anyPoolApplication.time_requested * 1000).toLocaleString()}&lt;/p>` : ''}
              &lt;/div>
              &lt;button class="cancel-application-btn" data-pool="true">Cancel Queue&lt;/button>
            &lt;/div>
          ` : ''}

          ${directApplications.map(app => {
            const appDate = app.time_requested ? new Date(app.time_requested * 1000).toLocaleDateString() : '-';
            const applicationText = Array.isArray(app.application_text) ? app.application_text[0] : app.application_text;
            return `
              &lt;div class="pending-application-item">
                &lt;div class="application-info">
                  &lt;strong>${escapeHtml(app.name || app.alliance_name || 'Unknown Alliance')}&lt;/strong>
                  &lt;p>Applied: ${appDate}&lt;/p>
                  ${applicationText ? `&lt;p class="application-text">"${escapeHtml(applicationText)}"&lt;/p>` : ''}
                &lt;/div>
                &lt;button class="cancel-application-btn" data-alliance-id="${app.alliance_id || app.id}">Cancel&lt;/button>
              &lt;/div>
            `;
          }).join('')}
        &lt;/div>
      ` : ''}

      &lt;!-- Results Container -->
      &lt;div id="allianceSearchResults" class="alliance-search-results">
        ${searchState.results.length === 0 &amp;&amp; searchState.initialized ?
          `&lt;p class="alliance-search-no-results">Enter a search term or browse all alliances.&lt;/p>` :
          ''
        }
      &lt;/div>

      &lt;!-- Loading Indicator -->
      &lt;div id="allianceSearchLoading" class="alliance-search-loading" style="display: none;">
        Loading more...
      &lt;/div>
    &lt;/div>
  `;

  content.innerHTML = html;

  // Attach event listeners
  attachSearchEventListeners();

  // Load initial results if not loaded yet
  if (status.data.isReady &amp;&amp; searchState.results.length === 0) {
    await performSearch(true);
  } else if (searchState.results.length > 0) {
    renderSearchResults();
  }
}

/**
 * Attach event listeners for search tab
 */
function attachSearchEventListeners() {
  const searchBtn = document.getElementById('allianceSearchBtn');
  const clearBtn = document.getElementById('allianceSearchClearBtn');
  const searchInput = document.getElementById('allianceSearchInput');
  const languageFilter = document.getElementById('allianceFilterLanguage');
  const sortFilter = document.getElementById('allianceFilterSort');
  const openSlotsFilter = document.getElementById('allianceFilterOpenSlots');

  // Search button
  if (searchBtn) {
    searchBtn.addEventListener('click', async () => {
      searchState.query = searchInput.value.trim();
      searchState.offset = 0;
      searchState.results = [];
      await performSearch(true);
    });
  }

  // Clear button
  if (clearBtn) {
    clearBtn.addEventListener('click', async () => {
      searchInput.value = '';
      searchState.query = '';
      searchState.offset = 0;
      searchState.results = [];
      searchState.filters = { sortBy: 'name_asc', hasOpenSlots: false };
      if (languageFilter) languageFilter.value = '';
      if (sortFilter) sortFilter.value = 'name_asc';
      if (openSlotsFilter) openSlotsFilter.value = 'all';
      await performSearch(true);
    });
  }

  // Enter key on search input
  if (searchInput) {
    searchInput.addEventListener('keypress', async (e) => {
      if (e.key === 'Enter') {
        searchState.query = searchInput.value.trim();
        searchState.offset = 0;
        searchState.results = [];
        await performSearch(true);
      }
    });
  }

  // Filter changes
  if (languageFilter) {
    languageFilter.addEventListener('change', async () => {
      searchState.filters.language = languageFilter.value || undefined;
      searchState.offset = 0;
      searchState.results = [];
      await performSearch(true);
    });
  }

  if (sortFilter) {
    sortFilter.addEventListener('change', async () => {
      searchState.filters.sortBy = sortFilter.value;
      searchState.offset = 0;
      searchState.results = [];
      await performSearch(true);
    });
  }

  if (openSlotsFilter) {
    openSlotsFilter.addEventListener('change', async () => {
      searchState.filters.hasOpenSlots = openSlotsFilter.value === 'open';
      console.log('[Search Filter] Open Slots changed:', searchState.filters.hasOpenSlots, 'filters:', searchState.filters);
      searchState.offset = 0;
      searchState.results = [];
      await performSearch(true);
    });
  }


  // Cancel All Applications button
  const cancelAllBtn = document.getElementById('cancelAllApplicationsBtn');
  if (cancelAllBtn) {
    cancelAllBtn.addEventListener('click', async () => {
      const confirmed = await showConfirmDialog({
        title: 'Cancel All Applications',
        message: '&lt;p>Are you sure you want to cancel all your pending alliance applications?&lt;/p>',
        confirmText: 'Cancel All',
        cancelText: 'Keep Applications',
        narrow: true
      });

      if (!confirmed) return;

      try {
        const response = await fetch(window.apiUrl('/api/alliance-cancel-all-applications'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to cancel applications');
        }

        showSideNotification('All applications cancelled', 'success');

        // Force re-render to immediately clear all applications
        searchState.initialized = false;
        await renderSearchTab();
      } catch (error) {
        showSideNotification(`Failed to cancel applications: ${error.message}`, 'error');
      }
    });
  }

  // Individual Cancel Application buttons
  const cancelBtns = document.querySelectorAll('.cancel-application-btn');
  cancelBtns.forEach(btn => {
    btn.addEventListener('click', async () => {
      const isPool = btn.getAttribute('data-pool') === 'true';
      const allianceId = btn.getAttribute('data-alliance-id');

      const confirmed = await showConfirmDialog({
        title: isPool ? 'Cancel Queue' : 'Cancel Application',
        message: isPool
          ? '&lt;p>Are you sure you want to leave the general alliance pool?&lt;/p>'
          : '&lt;p>Are you sure you want to cancel this application?&lt;/p>',
        confirmText: 'Cancel',
        cancelText: 'Keep',
        narrow: true
      });

      if (!confirmed) return;

      try {
        let response;
        if (isPool) {
          response = await fetch(window.apiUrl('/api/alliance-leave-pool-any'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
        } else {
          response = await fetch(window.apiUrl('/api/alliance-cancel-application'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ alliance_id: parseInt(allianceId) })
          });
        }

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to cancel');
        }

        showSideNotification(isPool ? 'Left general pool' : 'Application cancelled', 'success');

        // Force re-render to immediately remove cancelled application from list
        searchState.initialized = false;
        await renderSearchTab();
      } catch (error) {
        showSideNotification(`Failed to cancel: ${error.message}`, 'error');
      }
    });
  });
}

/**
 * Perform alliance search
 * @param {boolean} reset - Whether to reset results
 */
async function performSearch(reset) {
  if (searchState.isLoading) return;

  searchState.isLoading = true;

  const loadingIndicator = document.getElementById('allianceSearchLoading');
  if (loadingIndicator) {
    loadingIndicator.style.display = 'block';
  }

  try {
    const limit = reset ? ALLIANCE_INITIAL_LOAD : ALLIANCE_LAZY_BATCH;

    const response = await fetch(window.apiUrl('/api/alliances/search'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query: searchState.query,
        filters: searchState.filters,
        offset: reset ? 0 : searchState.offset,
        limit: limit
      })
    });

    if (!response.ok) throw new Error('Search failed');

    const data = await response.json();

    console.log('[Search] API Response:', {
      query: searchState.query,
      filters: searchState.filters,
      total: data.data.total,
      resultsCount: data.data.results.length,
      ready: data.data.ready,
      isReset: reset
    });

    if (data.data.results.length > 0) {
      console.log('[Search] Sample alliance:', data.data.results[0]);
    }

    if (reset) {
      searchState.results = data.data.results;
      searchState.offset = data.data.results.length;
      searchState.total = data.data.total;
      searchState.hasMore = searchState.offset &lt; data.data.total;
      renderSearchResults();
    } else {
      // Lazy load - append results
      if (data.data.results.length === 0) {
        // No more results to load
        searchState.hasMore = false;
        const sentinel = document.getElementById('allianceLazyLoadSentinel');
        if (sentinel) {
          sentinel.remove();
        }
        if (allianceLazyLoadObserver) {
          allianceLazyLoadObserver.disconnect();
        }
        console.log('[Alliance Lazy Load] No more results, stopped loading');
        return;
      }

      searchState.results.push(...data.data.results);
      searchState.offset += data.data.results.length;
      searchState.hasMore = searchState.offset &lt; data.data.total;
      appendSearchResults(data.data.results);
    }
  } catch (error) {
    console.error('[Search] Error:', error);
    const resultsContainer = document.getElementById('allianceSearchResults');
    if (resultsContainer &amp;&amp; reset) {
      resultsContainer.innerHTML = '&lt;p class="alliance-search-error">Search failed. Please try again.&lt;/p>';
    }
  } finally {
    searchState.isLoading = false;
    if (loadingIndicator) {
      loadingIndicator.style.display = 'none';
    }
  }
}

/**
 * Render search results
 */
function renderSearchResults() {
  const resultsContainer = document.getElementById('allianceSearchResults');
  if (!resultsContainer) return;

  if (searchState.results.length === 0) {
    resultsContainer.innerHTML = '&lt;p class="alliance-search-no-results">No alliances found.&lt;/p>';
    return;
  }

  let html = '&lt;div class="league-standings">';

  searchState.results.forEach((alliance) => {
    html += createAllianceRow(alliance);
  });

  html += '&lt;/div>';

  // Add sentinel element for lazy loading
  if (searchState.hasMore) {
    html += '&lt;div id="allianceLazyLoadSentinel" style="height: 1px;">&lt;/div>';
  }

  resultsContainer.innerHTML = html;

  // Attach click handlers to alliance names
  attachAllianceClickHandlers();

  // Set up IntersectionObserver for lazy loading
  if (searchState.hasMore) {
    if (allianceLazyLoadObserver) {
      allianceLazyLoadObserver.disconnect();
    }

    const sentinel = document.getElementById('allianceLazyLoadSentinel');
    if (sentinel) {
      allianceLazyLoadObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting &amp;&amp; !searchState.isLoading &amp;&amp; searchState.hasMore) {
            console.log('[Alliance Lazy Load] Sentinel visible, loading more...');
            performSearch(false);
          }
        });
      }, {
        rootMargin: '200px'
      });

      allianceLazyLoadObserver.observe(sentinel);
    }
  }
}

/**
 * Append search results for lazy loading
 * @param {Array} newAlliances - New alliances to append
 */
function appendSearchResults(newAlliances) {
  const resultsContainer = document.getElementById('allianceSearchResults');
  if (!resultsContainer) return;

  const standingsContainer = resultsContainer.querySelector('.league-standings');
  if (!standingsContainer) return;

  newAlliances.forEach((alliance) => {
    const rowHtml = createAllianceRow(alliance);
    standingsContainer.insertAdjacentHTML('beforeend', rowHtml);
  });

  // Attach click handlers to new alliance names
  attachAllianceClickHandlers();

  // Update or remove sentinel
  let sentinel = document.getElementById('allianceLazyLoadSentinel');

  if (searchState.hasMore) {
    if (!sentinel) {
      resultsContainer.insertAdjacentHTML('beforeend', '&lt;div id="allianceLazyLoadSentinel" style="height: 1px;">&lt;/div>');
      sentinel = document.getElementById('allianceLazyLoadSentinel');
    }

    // Re-observe sentinel
    if (allianceLazyLoadObserver &amp;&amp; sentinel) {
      allianceLazyLoadObserver.disconnect();
      allianceLazyLoadObserver.observe(sentinel);
    }
  } else {
    // No more results, remove sentinel
    if (sentinel) {
      sentinel.remove();
    }
    if (allianceLazyLoadObserver) {
      allianceLazyLoadObserver.disconnect();
    }
  }
}

/**
 * Create HTML for a single alliance row
 * @param {Object} alliance - Alliance data
 * @returns {string} HTML string
 */
function createAllianceRow(alliance) {
  const primaryColor = normalizeColor(alliance.image_colors.primary);
  const secondaryColors = alliance.image_colors.secondary || ['FFFFFF', 'FFFFFF'];
  const gradientColor1 = normalizeColor(secondaryColors[0]);
  const gradientColor2 = normalizeColor(secondaryColors[1] || secondaryColors[0]);
  const gradient = `linear-gradient(${gradientColor1} 0%, ${gradientColor2} 100%)`;

  const logoInitials = alliance.name.substring(0, 2).toUpperCase();

  const languageFlag = alliance.language ? alliance.language.split('-')[0].toUpperCase() : '';

  return `
    &lt;div class="league-alliance-row">
      &lt;div class="league-alliance-logo">
        &lt;div class="alliance-logo-wrapper" style="background: ${gradient};">
          &lt;img src="/api/alliance-logo/${alliance.image}?color=${encodeURIComponent(primaryColor)}" alt="${escapeHtml(alliance.name)}" class="alliance-logo-svg" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          &lt;span class="alliance-logo-text" style="color: ${primaryColor}; display: none;">${logoInitials}&lt;/span>
        &lt;/div>
      &lt;/div>
      &lt;div class="league-alliance-info">
        &lt;div class="league-alliance-name clickable" data-alliance-id="${alliance.id}">
          ${escapeHtml(alliance.name)}
          ${languageFlag ? `&lt;span class="league-language-flag">${languageFlag}&lt;/span>` : ''}
        &lt;/div>
        &lt;div class="league-alliance-meta">
          &lt;span>Lvl ${alliance.benefit_level || 0}&lt;/span>
          &lt;span>${alliance.members}/50&lt;/span>
          &lt;span>$${formatNumber(alliance.total_share_value || 0)}&lt;/span>
          &lt;span>Contribution ${formatNumber(alliance.stats?.contribution_score_24h || 0)}&lt;/span>
          &lt;span>Departures ${formatNumber(alliance.stats?.departures_24h || 0)}&lt;/span>
        &lt;/div>
      &lt;/div>
    &lt;/div>
  `;
}

/**
 * Attach click handlers to all alliance names in search results
 */
function attachAllianceClickHandlers() {
  const resultsContainer = document.getElementById('allianceSearchResults');
  if (!resultsContainer) return;

  resultsContainer.querySelectorAll('.league-alliance-name.clickable').forEach(nameEl => {
    // Remove old listener by cloning
    const newNameEl = nameEl.cloneNode(true);
    nameEl.replaceWith(newNameEl);

    // Add new listener
    newNameEl.addEventListener('click', async () => {
      const allianceId = parseInt(newNameEl.getAttribute('data-alliance-id'));
      await showAllianceDetailsModal(allianceId);
    });
  });
}

/**
 * Handles join alliance button click
 * Shows motivational speech dialog, then queue-for-any dialog, then applies
 * @param {number} allianceId - The alliance ID to join
 * @param {string} allianceName - The alliance name
 */
async function handleJoinAllianceClick(allianceId, allianceName) {
  try {
    // Step 1: Ask about motivational speech
    const wantsMotivation = await showConfirmDialog({
      title: 'Join Alliance',
      message: `&lt;p>Do you want to add a motivational speech to your application before sending it to &lt;strong>${escapeHtml(allianceName)}&lt;/strong>?&lt;/p>`,
      confirmText: 'YES',
      cancelText: 'NO',
      narrow: true
    });

    let applicationText = '';

    if (wantsMotivation) {
      // Show text input dialog
      applicationText = await showTextInputDialog({
        title: 'Motivational Speech',
        message: 'Enter your motivational speech (max 1000 characters):',
        placeholder: 'Tell them why you want to join...',
        maxLength: 1000,
        confirmText: 'Continue',
        cancelText: 'Cancel'
      });

      // User cancelled
      if (applicationText === null) {
        return;
      }
    }

    // Step 2: Ask about queue for any alliance
    const wantsQueue = await showConfirmDialog({
      title: 'Backup Queue',
      message: '&lt;p>Do you want to queue up for joining another alliance if not accepted into this alliance within 48 hours?&lt;/p>',
      confirmText: 'YES',
      cancelText: 'NO',
      narrow: true
    });

    // If YES to queue, join the pool
    if (wantsQueue) {
      try {
        const queueResponse = await fetch(window.apiUrl('/api/alliance-join-pool-any'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!queueResponse.ok) {
          console.error('[Alliance Join] Failed to join pool for any alliance');
        }
      } catch (error) {
        console.error('[Alliance Join] Error joining pool:', error);
      }
    }

    // Step 3: Apply to join the alliance
    const applyResponse = await fetch(window.apiUrl('/api/alliance-apply-join'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        alliance_id: allianceId,
        application_text: applicationText
      })
    });

    if (!applyResponse.ok) {
      const error = await applyResponse.json();
      throw new Error(error.error || 'Failed to apply to alliance');
    }

    showSideNotification(`Application sent to ${escapeHtml(allianceName)}!`, 'success');

    // Close the alliance details modal
    const modal = document.getElementById('allianceDetailsModal');
    if (modal) {
      modal.classList.add('hidden');
    }

    // Refresh search tab to show pending applications
    await renderSearchTab();

  } catch (error) {
    showSideNotification(`Failed to join alliance: ${error.message}`, 'error');
  }
}

/**
 * Shows a text input dialog
 * @param {Object} options - Dialog options
 * @returns {Promise&lt;string|null>} The entered text or null if cancelled
 */
async function showTextInputDialog(options) {
  return new Promise((resolve) => {
    const {
      title,
      message,
      placeholder = '',
      maxLength = 1000,
      confirmText = 'OK',
      cancelText = 'Cancel'
    } = options;

    // Create dialog
    const dialog = document.createElement('div');
    dialog.className = 'overlay';
    dialog.innerHTML = `
      &lt;div class="confirm-dialog" style="max-width: 500px;">
        &lt;h3>${escapeHtml(title)}&lt;/h3>
        &lt;div class="confirm-message">${message}&lt;/div>
        &lt;textarea
          id="textInputDialogTextarea"
          placeholder="${escapeHtml(placeholder)}"
          maxlength="${maxLength}"
          style="width: 100%; min-height: 120px; padding: var(--spacing-8); border: 1px solid var(--color-border); border-radius: var(--radius-4); font-family: inherit; resize: vertical; margin: var(--spacing-12) 0;"
        >&lt;/textarea>
        &lt;div style="color: var(--color-text-muted); font-size: var(--font-size-12); text-align: right; margin-bottom: var(--spacing-12);">
          &lt;span id="textInputCharCount">0&lt;/span> / ${maxLength} characters
        &lt;/div>
        &lt;div class="confirm-buttons">
          &lt;button class="confirm-cancel-btn">${escapeHtml(cancelText)}&lt;/button>
          &lt;button class="confirm-ok-btn">${escapeHtml(confirmText)}&lt;/button>
        &lt;/div>
      &lt;/div>
    `;

    document.body.appendChild(dialog);

    const textarea = dialog.querySelector('#textInputDialogTextarea');
    const charCount = dialog.querySelector('#textInputCharCount');

    // Update character count
    textarea.addEventListener('input', () => {
      charCount.textContent = textarea.value.length;
    });

    // Focus textarea
    setTimeout(() => textarea.focus(), 100);

    const cleanup = () => {
      document.body.removeChild(dialog);
    };

    dialog.querySelector('.confirm-ok-btn').addEventListener('click', () => {
      const value = textarea.value.trim();
      cleanup();
      resolve(value);
    });

    dialog.querySelector('.confirm-cancel-btn').addEventListener('click', () => {
      cleanup();
      resolve(null);
    });

    // Close on outside click
    dialog.addEventListener('click', (e) => {
      if (e.target === dialog) {
        cleanup();
        resolve(null);
      }
    });
  });
}

/**
 * Shows donation dialog for donating diamonds to alliance members
 * @param {number} userId - Target user ID
 * @param {string} userName - Target user name
 * @param {number} totalMembers - Total alliance member count
 */
async function showDonateDialog(userId, userName, totalMembers) {
  const pointsDisplay = document.getElementById('pointsDisplay');
  const maxPoints = parseInt(pointsDisplay?.textContent || '0');

  if (maxPoints === 0) {
    showSideNotification('You have no diamonds to donate', 'error');
    return;
  }

  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  overlay.innerHTML = `
    &lt;div class="messenger-window" style="max-width: 500px;">
      &lt;div class="messenger-header">
        &lt;h2> Donate Diamonds&lt;/h2>
        &lt;button class="close-btn donate-close-btn">&lt;span>&lt;/span>&lt;/button>
      &lt;/div>
      &lt;div class="messenger-feed" style="padding: var(--spacing-20);">
        &lt;div style="margin-bottom: var(--spacing-16);">
          &lt;label style="display: block; margin-bottom: var(--spacing-8); color: var(--color-text-secondary);">
            Recipient
          &lt;/label>
          &lt;input type="text" value="${userName}" readonly style="width: 100%; padding: var(--spacing-8); background: var(--gray-700); border: 1px solid var(--color-border); border-radius: var(--radius-6); color: var(--color-text-primary);">
        &lt;/div>

        &lt;div style="margin-bottom: var(--spacing-16);">
          &lt;label style="display: block; margin-bottom: var(--spacing-8); color: var(--color-text-secondary);">
            Amount (max: ${maxPoints})
          &lt;/label>
          &lt;input type="number" id="donateAmount" min="1" max="${maxPoints}" value="1" style="width: 100%; padding: var(--spacing-8); background: var(--gray-700); border: 1px solid var(--color-border); border-radius: var(--radius-6); color: var(--color-text-primary);">
        &lt;/div>

        &lt;div style="margin-bottom: var(--spacing-16);">
          &lt;label style="display: block; margin-bottom: var(--spacing-8); color: var(--color-text-secondary);">
            Include an optional message along with the donation (optional)
          &lt;/label>
          &lt;textarea id="donateMessage" maxlength="140" placeholder="Type donation message" style="width: 100%; padding: var(--spacing-8); background: var(--gray-700); border: 1px solid var(--color-border); border-radius: var(--radius-6); color: var(--color-text-primary); min-height: 60px; resize: vertical;">&lt;/textarea>
          &lt;div style="text-align: right; font-size: var(--font-size-11); color: var(--color-text-tertiary); margin-top: var(--spacing-4);">
            &lt;span id="messageCharCount">0&lt;/span>/140
          &lt;/div>
        &lt;/div>

        &lt;div style="margin-bottom: var(--spacing-20);">
          &lt;label style="display: flex; align-items: center; gap: var(--spacing-8); cursor: pointer;">
            &lt;input type="checkbox" id="donateToAll">
            &lt;span style="color: var(--color-text-secondary); white-space: nowrap;">Send donation to every alliance member (${totalMembers})&lt;/span>
          &lt;/label>
        &lt;/div>

        &lt;div style="display: flex; gap: var(--spacing-12);">
          &lt;button class="vessel-filter-btn donate-cancel-btn" style="flex: 1; background: var(--gray-700); border-color: var(--color-border); color: var(--color-text-secondary);">Cancel&lt;/button>
          &lt;button class="vessel-buy-btn donate-send-btn" style="flex: 1;">Send Donation&lt;/button>
        &lt;/div>
      &lt;/div>
    &lt;/div>
  `;

  document.body.appendChild(overlay);
  overlay.classList.remove('hidden');

  const amountInput = overlay.querySelector('#donateAmount');
  const messageTextarea = overlay.querySelector('#donateMessage');
  const charCount = overlay.querySelector('#messageCharCount');
  const toAllCheckbox = overlay.querySelector('#donateToAll');
  const closeBtn = overlay.querySelector('.donate-close-btn');
  const cancelBtn = overlay.querySelector('.donate-cancel-btn');
  const sendBtn = overlay.querySelector('.donate-send-btn');

  // Character counter
  messageTextarea.addEventListener('input', () => {
    charCount.textContent = messageTextarea.value.length;
  });

  // Update recipient when checkbox changes
  const recipientInput = overlay.querySelector('input[readonly]');
  toAllCheckbox.addEventListener('change', () => {
    if (toAllCheckbox.checked) {
      recipientInput.value = `All Alliance Members (${totalMembers})`;
    } else {
      recipientInput.value = userName;
    }
  });

  // Close handlers
  const closeDialog = () => {
    overlay.classList.add('hidden');
    setTimeout(() => overlay.remove(), 300);
  };

  closeBtn.addEventListener('click', closeDialog);
  cancelBtn.addEventListener('click', closeDialog);
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) closeDialog();
  });

  // Send button handler
  sendBtn.addEventListener('click', async () => {
    const amount = parseInt(amountInput.value);
    const message = messageTextarea.value.trim();
    const sendToAll = toAllCheckbox.checked;

    if (isNaN(amount) || amount &lt; 1 || amount > maxPoints) {
      showSideNotification(`Please enter a valid amount (1-${maxPoints})`, 'error');
      return;
    }

    const totalCost = sendToAll ? amount * totalMembers : amount;
    if (totalCost > maxPoints) {
      showSideNotification(`Not enough diamonds. Total cost: ${totalCost}, Available: ${maxPoints}`, 'error');
      return;
    }

    // Confirmation dialog
    const recipientText = sendToAll ? `${totalMembers} alliance members (${totalCost} diamonds total)` : `${userName} (${amount} diamonds)`;
    const confirmed = await showConfirmDialog({
      title: 'Confirm Donation',
      message: `&lt;p>Are you sure you want to donate to &lt;strong>${recipientText}&lt;/strong>?&lt;/p>${message ? `&lt;p style="margin-top: var(--spacing-12); font-style: italic;">"${escapeHtml(message)}"&lt;/p>` : ''}`,
      confirmText: 'Send',
      cancelText: 'Cancel'
    });

    if (!confirmed) return;

    // Send donation
    try {
      const response = await fetch(window.apiUrl('/api/coop/donate-points'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_id: sendToAll ? null : userId,
          points: amount,
          message: message || undefined,
          all_members: sendToAll
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to send donation');
      }

      showSideNotification(`Successfully donated ${totalCost} diamonds!`, 'success');
      closeDialog();

      // Update points display
      const newPoints = maxPoints - totalCost;
      if (pointsDisplay) {
        pointsDisplay.textContent = newPoints;
      }
    } catch (error) {
      showSideNotification(`Failed to send donation: ${error.message}`, 'error');
    }
  });
}

// Export functions for external use
export { lockCoopButtons, unlockCoopButtons };
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation Version: 0.0.7 - ShippingManager CoPilot
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
